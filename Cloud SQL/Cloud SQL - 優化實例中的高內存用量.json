{"title": "Cloud SQL - \u512a\u5316\u5be6\u4f8b\u4e2d\u7684\u9ad8\u5167\u5b58\u7528\u91cf", "url": "https://cloud.google.com/sql/docs/postgres/optimize-high-memory-usage?hl=zh-cn", "abstract": "# Cloud SQL - \u512a\u5316\u5be6\u4f8b\u4e2d\u7684\u9ad8\u5167\u5b58\u7528\u91cf\n**    \u9810\u89bd     ** \u6b64\u529f\u80fd\u9808\u9075\u5b88 [\u670d\u52d9\u5c08\u7528\u689d\u6b3e](https://cloud.google.com/terms/service-terms?hl=zh-cn#1) \u7684\u201c\u901a\u7528\u670d\u52d9\u689d\u6b3e\u201d\u90e8\u5206\u4e2d\u7684\u201c\u975e\u6b63\u5f0f\u7248\u7522\u54c1\u689d\u6b3e\u201d\u3002 \u975e\u6b63\u5f0f\u7248\u529f\u80fd\u201c\u6309\u539f\u6a23\u201d\u63d0\u4f9b\uff0c\u53ef\u80fd\u53ea\u80fd\u7372\u5f97\u6709\u9650\u7684\u652f\u6301\u3002 \u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u767c\u4f48\u968e\u6bb5\u8aaa\u660e](https://cloud.google.com/products?hl=zh-cn#product-launch-stages) \u3002\n\u672c\u6587\u6a94\u4ecb\u7d39\u77ad\u5982\u4f55\u8b58\u5225 Cloud SQL \u5be6\u4f8b\u7684\u9ad8\u5167\u5b58\u7528\u91cf\uff0c\u4e26\u63d0\u4f9b\u4e86\u6709\u95dc\u5982\u4f55\u89e3\u6c7a\u5167\u5b58\u76f8\u95dc\u554f\u984c\u7684\u5efa\u8b70\u3002\n\u5982\u9700\u77ad\u89e3\u5982\u4f55\u7232 Cloud SQL \u5be6\u4f8b\u914d\u7f6e\u5167\u5b58\u7528\u91cf\uff0c\u8acb\u53c3\u95b1 [\u7ba1\u7406\u5167\u5b58\u7528\u91cf\u7684\u6700\u4f73\u5be6\u8e10](https://cloud.google.com/sql/docs/postgres/manage-memory-usage-best-practices?hl=zh-cn) \u3002\n", "content": "## \u8b58\u5225\u9ad8\u5167\u5b58\u7528\u91cf\n### \u4f7f\u7528 Metrics Explorer \u78ba\u5b9a\u5167\u5b58\u7528\u91cf\n\u60a8\u53ef\u4ee5\u4f7f\u7528 [Metrics Explorer](https://cloud.google.com/monitoring/charts/metrics-explorer?hl=zh-cn) \u4e2d\u7684 [database/memory/components.usage](https://cloud.google.com/sql/docs/postgres/admin-api/metrics?hl=zh-cn) \u6307\u6a19\u67e5\u770b\u5be6\u4f8b\u7684\u5167\u5b58\u7528\u91cf\u3002\n**\u6ce8\u610f** \uff1a\u5982\u679c `database/memory/components.cache` \u548c `database/memory/components.free` \u4e2d\u7684\u5167\u5b58\u7e3d\u8a08\u4e0d\u8db3 10%\uff0c\u5247\u767c\u751f OOM \u4e8b\u4ef6\u7684\u98a8\u96aa\u8f03\u9ad8\u3002\u5982\u9700\u76e3\u63a7\u5167\u5b58\u7528\u91cf\u4e26\u9632\u6b62 OOM \u4e8b\u4ef6\uff0c\u6211\u5011\u5efa\u8b70\u60a8\u8a2d\u7f6e [\u63d0\u9192\u653f\u7b56](https://cloud.google.com/monitoring/alerts?hl=zh-cn) \uff0c\u4e26\u5728 `database/memory/components.usage` \u4e2d\u5c07\u6307\u6a19\u95be\u503c\u689d\u4ef6\u8a2d\u7f6e\u7232 90%\u3002\n### \u4f7f\u7528 Query Insights \u4f86\u5206\u6790\u6b63\u5728\u6d88\u8017\u5927\u91cf\u8cc7\u6e90\u7684\u67e5\u8a62\u7684\u8aaa\u660e\u8a08\u5283\n[Query Insights](https://cloud.google.com/sql/docs/postgres/using-query-insights?hl=zh-cn) \u53ef\u5e6b\u52a9\u60a8\u6aa2\u6e2c\u3001\u8a3a\u65b7\u548c\u907f\u514d Cloud SQL \u6578\u64da\u5eab\u7684\u67e5\u8a62\u6027\u80fd\u554f\u984c\u3002Query Insights \u7232\u60a8\u63d0\u4f9b\u4e86\u9577\u6642\u9593\u904b\u884c\u7684\u67e5\u8a62\u53ca\u5176 [\u8aaa\u660e\u8a08\u5283\uff08PostgreSQL \u6587\u6a94\uff09](https://www.postgresql.org/docs/current/sql-explain.html) \u7684\u5217\u8868\u3002\u67e5\u770b\u8aaa\u660e\u8a08\u5283\u4e26\u78ba\u5b9a\u5177\u6709\u9ad8\u5167\u5b58\u7528\u91cf\u6383\u63cf\u65b9\u6cd5\u7684\u67e5\u8a62\u90e8\u5206\u3002\u7121\u8ad6\u67e5\u8a62\u904b\u884c\u6642\u9593\u5982\u4f55\uff0cQuery Insights \u90fd\u6703\u7232\u60a8\u63d0\u4f9b\u6240\u6709\u67e5\u8a62\u7684\u8aaa\u660e\u8a08\u5283\u3002\u8b58\u5225\u9700\u8981\u66f4\u591a\u6642\u9593\u7684\u8907\u96dc\u67e5\u8a62\uff0c\u4ee5\u4fbf\u4e86\u89e3\u54ea\u4e9b\u67e5\u8a62\u9577\u6642\u9593\u963b\u6b62\u4e86\u5167\u5b58\u3002\n\u4f7f\u7528\u9ad8\u5167\u5b58\u7684\u5e38\u898b PostgreSQL \u6383\u63cf\u65b9\u6cd5\u5305\u62ec\uff1a\n- \u4f4d\u5716\u5806\u6383\u63cf\n- \u5feb\u901f\u6392\u5e8f\n- \u54c8\u5e0c\u806f\u63a5\u6216\u54c8\u5e0c## \u9ad8\u5167\u5b58\u7528\u91cf - \u5efa\u8b70\n\u4ee5\u4e0b\u5efa\u8b70\u53ef\u4ee5\u89e3\u6c7a\u8207\u5167\u5b58\u76f8\u95dc\u7684\u5e38\u898b\u554f\u984c\u3002 \u5982\u679c\u5be6\u4f8b\u7e7c\u7e8c\u4f7f\u7528\u5927\u91cf\u5167\u5b58\uff0c\u5247\u5f88\u6709\u53ef\u80fd\u6700\u7d42\u9047\u5230 `out of memory` \u554f\u984c\u3002\u5982\u679c PostgreSQL \u6216\u5176\u4ed6\u9032\u7a0b\u7684\u5167\u5b58\u9700\u6c42\u5c0e\u81f4\u7cfb\u7d71\u5167\u5b58\u4e0d\u8db3\uff0c\u60a8\u5c07\u5728 PostgreSQL \u65e5\u8a8c\u4e2d\u770b\u5230 `Out of Memory` \u5167\u6838\u6d88\u606f\uff0c\u4e26\u4e14 PostgreSQL \u5be6\u4f8b\u6700\u7d42\u6703\u505c\u6b62\u3002\u4f8b\u5982\uff1a\n`Out of Memory: Killed process 12345 (postgres)`\n\u60a8\u770b\u5230 OOM \u554f\u984c\u7684\u6700\u5e38\u898b\u60c5\u6cc1\u662f\uff0c `work_mem` \u503c\u8f03\u9ad8\uff0c\u6d3b\u8e8d\u9023\u63a5\u6578\u91cf\u8f03\u591a\u3002\u56e0\u6b64\uff0c\u5982\u679c\u60a8\u983b\u7e41\u6536\u5230 OOM \u6216\u907f\u514d Cloud SQL for PostgreSQL \u5be6\u4f8b\u4e2d\u51fa\u73fe OOM\uff0c\u5247\u61c9\u8003\u616e\u4ee5\u4e0b\u5efa\u8b70\uff1a\n- \u8a2d\u7f6e `work_mem`\u4f7f\u7528\u5feb\u901f\u6392\u5e8f\u7684\u67e5\u8a62\u6bd4\u4f7f\u7528\u5916\u90e8\u5408\u4f75\u6392\u5e8f\u7684\u67e5\u8a62\u66f4\u5feb\u3002\u4f46\u662f\uff0c\u524d\u8005\u53ef\u80fd\u6703\u5c0e\u81f4\u5167\u5b58\u8017\u76e1\u3002\u8981\u89e3\u6c7a\u6b64\u554f\u984c\uff0c\u8acb\u8a2d\u7f6e\u5408\u7406\u7684 `work_mem` \u503c\uff0c\u4f7f\u5176\u5747\u8861\u5167\u5b58\u548c\u78c1\u76e4\u4e2d\u51fa\u73fe\u7684\u6392\u5e8f\u64cd\u4f5c\u3002\u60a8\u9084\u53ef\u4ee5\u8003\u616e\u5728\u6703\u8a71\u7d1a\u5225\u8a2d\u7f6e `work_mem` \uff0c\u800c\u4e0d\u662f\u7232\u6574\u500b\u5be6\u4f8b\u8a2d\u7f6e\u3002\n- \u76e3\u63a7\u6d3b\u8e8d\u6703\u8a71\u6bcf\u500b\u9023\u63a5\u90fd\u6703\u4f7f\u7528\u4e00\u5b9a\u91cf\u7684\u5167\u5b58\u3002\u4f7f\u7528\u4ee5\u4e0b\u67e5\u8a62\u53ef\u4ee5\u6aa2\u67e5\u6d3b\u8e8d\u9023\u63a5\u6578\uff1a```\n\u00a0 SELECT\u00a0 \u00a0 state,\u00a0 \u00a0 usename,\u00a0 \u00a0 count(1)\u00a0 FROM\u00a0 \u00a0 pg_stat_activity\u00a0 WHERE\u00a0 \u00a0 pid <> pg_backend_pid()\u00a0 GROUP BY\u00a0 \u00a0 state,\u00a0 \u00a0 usename\u00a0 ORDER BY\u00a0 \u00a0 1;\n```\u5982\u679c\u60a8\u64c1\u6709\u5927\u91cf\u6d3b\u8e8d\u6703\u8a71\uff0c\u8acb\u5206\u6790\u5927\u91cf\u6d3b\u8e8d\u6703\u8a71\u7684\u6839\u672c\u539f\u56e0\uff1b\u4f8b\u5982\uff0c\u4e8b\u52d9\u9396\u5b9a\u3002\n- \u8a2d\u7f6e `shared_buffers`\u5982\u679c `shared_buffers` \u8a2d\u7f6e\u7232\u66f4\u9ad8\u7684\u503c\uff0c\u8acb\u8003\u616e\u6e1b\u5c0f `shared_buffers` \u503c\uff0c\u4ee5\u5c07\u5167\u5b58\u7528\u65bc\u5176\u4ed6\u64cd\u4f5c\uff08\u4f8b\u5982 `work_mem` \uff09\u6216\u5efa\u7acb\u65b0\u9023\u63a5\u3002 **\u7de9\u5b58\u547d\u4e2d\u7387** PostgreSQL \u901a\u5e38\u5617\u8a66\u5c07\u60a8\u6700\u5e38\u8a2a\u554f\u7684\u6578\u64da\u4fdd\u7559\u5728\u7de9\u5b58\u4e2d\u3002\u7576\u5ba2\u6236\u7aef\u8acb\u6c42\u6578\u64da\u6642\uff0c\u5982\u679c\u6578\u64da\u5df2\u7de9\u5b58\u5728\u5171\u4eab\u7de9\u885d\u5340\u4e2d\uff0c\u5247\u76f4\u63a5\u63d0\u4f9b\u7d66\u5ba2\u6236\u7aef\u3002\u9019\u7a31\u7232\u7de9\u5b58\u547d\u4e2d \u3002 \u5982\u679c\u6578\u64da\u4e0d\u5728\u5171\u4eab\u7de9\u885d\u5340\u4e2d\uff0c\u5247\u6578\u64da\u6703\u5148\u5f9e\u78c1\u76e4\u63d0\u53d6\u5230\u5171\u4eab\u7de9\u885d\u5340\uff0c\u7136\u5f8c\u518d\u63d0\u4f9b\u7d66\u5ba2\u6236\u7aef\u3002\u9019\u7a2e\u60c5\u6cc1\u5c31\u7a31\u7232\u7de9\u5b58\u672a\u547d\u4e2d \u3002\u7de9\u5b58\u547d\u4e2d\u7387\u7528\u65bc\u8861\u91cf\u7de9\u5b58\u5df2\u7d93\u8655\u7406\u7684\u5167\u5bb9\u8acb\u6c42\u6578\u91cf\uff08\u8207\u6536\u5230\u7684\u8acb\u6c42\u6578\u91cf\u76f8\u6bd4\uff09\u3002\u904b\u884c\u4ee5\u4e0b\u67e5\u8a62\u4ee5\u6aa2\u67e5 PostgreSQL \u5be6\u4f8b\u4e2d\u8868\u8acb\u6c42\u7684\u7de9\u5b58\u547d\u4e2d\u7387\uff1a```\nSELECT\u00a0 sum(heap_blks_read) as heap_read,\u00a0 sum(heap_blks_hit) \u00a0as heap_hit,\u00a0 sum(heap_blks_hit) / (sum(heap_blks_hit) + sum(heap_blks_read)) as ratioFROM\u00a0 pg_statio_user_tables;\n```\u904b\u884c\u4ee5\u4e0b\u67e5\u8a62\u4ee5\u6aa2\u67e5 PostgreSQL \u5be6\u4f8b\u4e2d\u7d22\u5f15\u8acb\u6c42\u7684\u7de9\u5b58\u547d\u4e2d\u7387\uff1a```\n\u00a0 SELECT\u00a0 \u00a0 sum(idx_blks_read) as idx_read,\u00a0 \u00a0 sum(idx_blks_hit) \u00a0as idx_hit,\u00a0 \u00a0 (sum(idx_blks_hit) - sum(idx_blks_read)) / sum(idx_blks_hit) as ratio\u00a0 FROM\u00a0 \u00a0 pg_statio_user_indexes;\n```\u901a\u5e38\uff0c95% \u5230 99% \u7684\u7de9\u5b58\u547d\u4e2d\u7387\u662f\u6bd4\u8f03\u7406\u60f3\u7684\u503c\u3002\n- \u5553\u7528\u5927\u578b\u9801\u9762 Cloud SQL for PostgreSQL \u9ed8\u8a8d\u5553\u7528 `huge_pages` \uff0c\u4ee5\u66f4\u597d\u5730\u7ba1\u7406\u5167\u5b58\u3002\u6211\u5011\u5efa\u8b70\u60a8\u5c07\u5176\u5553\u7528\u3002 \u5982\u9700\u8a73\u7d30\u77ad\u89e3 `huge_pages` \uff0c\u8acb\u53c3\u95b1 [PostreSQL \u6587\u6a94](https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-HUGE-PAGES) \u3002\n- \u8a2d\u7f6e `max_locks_per_transaction``max_locks_per_transaction` \u503c\u8868\u793a\u53ef\u540c\u6642\u9396\u5b9a\u7684\u6578\u64da\u5eab\u5c0d\u8c61\u7684\u6578\u91cf\u3002\u5728\u5927\u591a\u6578\u60c5\u6cc1\u4e0b\uff0c\u9ed8\u8a8d\u503c 64 \u5c31\u8db3\u5920\u4e86\u3002\u4f46\u662f\uff0c\u5982\u679c\u60a8\u8655\u7406\u7684\u662f\u5927\u578b\u6578\u64da\u96c6\uff0c\u5247\u6700\u7d42\u53ef\u80fd\u6703\u51fa\u73fe OOM\u3002\u8acb\u8003\u616e\u5c07 `max_locks_per_transaction` \u7684\u503c\u589e\u52a0\u5230\u8db3\u5920\u9ad8\u4ee5\u907f\u514d OOM\u3002 **\u6ce8\u610f** \uff1a\u5c0d\u8c61\u7d1a\u9396\u5b9a\u767c\u751f\u5728\u6b63\u5728\u9032\u884c\u7684\u4e8b\u52d9\u7684\u5167\u5b58\u4e2d\uff0c\u5c07 `max_prepared_transactions` \u503c\u589e\u52a0\u5f97\u4e0d\u5408\u7406\u6703\u5c0e\u81f4\u6578\u64da\u5eab\u5be6\u4f8b\u8acb\u6c42\u66f4\u591a\u5171\u4eab\u5167\u5b58\u3002`max_locks_per_transaction` \u503c\u61c9\u7232 `max_locks_per_transaction` * ( `max_connections` + `max_prepared_transactions` ) \u5c0d\u8c61\u3002\u9019\u610f\u5473\u7740\uff0c\u5982\u679c\u6709 30 \u842c\u500b\u5c0d\u8c61\uff0c\u4e26\u4e14 `max_connections` \u7684\u503c\u7232 200\uff0c\u5247 `max_locks_per_transaction` \u61c9\u7232 1500\u3002\n- \u8a2d\u7f6e `max_pred_locks_per_transaction`\u5982\u679c\u60a8\u7684\u5ba2\u6236\u7aef\u5728\u55ae\u500b\u53ef\u5e8f\u5217\u5316\u4e8b\u52d9\u4e2d\u63a5\u89f8\u591a\u500b\u4e0d\u540c\u7684\u8868\uff0c\u5247\u4e8b\u52d9\u53ef\u80fd\u6703\u5931\u6557\u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u8acb\u8003\u616e\u5c07 `max_pred_locks_per_transaction` \u589e\u52a0\u5230\u5408\u7406\u7684\u9ad8\u503c\u3002\u8207 `max_locks_per_transaction` \u985e\u4f3c\uff0c `max_pred_locks_per_transaction` \u4e5f\u4f7f\u7528\u5171\u4eab\u5167\u5b58\uff0c\u56e0\u6b64\u8acb\u52ff\u8a2d\u7f6e\u4e0d\u5408\u7406\u7684\u9ad8\u503c\u3002\n- \u5982\u679c\u5167\u5b58\u4f7f\u7528\u7387\u4ecd\u7136\u5f88\u9ad8\uff0c\u4e26\u4e14\u60a8\u8a8d\u7232\u9019\u4e9b\u67e5\u8a62\u662f\u5408\u6cd5\u6d41\u91cf\uff0c\u8acb\u8003\u616e\u589e\u52a0\u5be6\u4f8b\u4e2d\u7684\u5167\u5b58\u8cc7\u6e90\u6578\u91cf\uff0c\u4ee5\u907f\u514d\u6578\u64da\u5eab\u5d29\u6f70\u6216\u505c\u6a5f\u3002", "guide": "Cloud SQL"}