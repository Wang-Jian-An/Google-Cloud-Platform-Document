{"title": "Cloud SQL - \u7a81\u7834\u4e8b\u52d9 ID (TXID) \u5c01\u88dd\u4fdd\u8b77", "url": "https://cloud.google.com/sql/docs/postgres/txid-wraparound?hl=zh-cn", "abstract": "# Cloud SQL - \u7a81\u7834\u4e8b\u52d9 ID (TXID) \u5c01\u88dd\u4fdd\u8b77\n\u672c\u9801\u9762\u4ecb\u7d39\u4e86\u5728\u6578\u64da\u5eab\u904b\u884c PostgreSQL \u4e2d\u7684\u4e8b\u52d9 ID \u74b0\u7e5e\u4fdd\u8b77\u6642\u53ef\u57f7\u884c\u7684\u64cd\u4f5c\u3002\u8a72\u4fdd\u8b77\u63aa\u65bd\u986f\u793a\u7232 `ERROR` \u6d88\u606f\uff0c\u5982\u4e0b\u6240\u793a\uff1a\n```\ndatabase is not accepting commands to avoid wraparound data loss in databasedbname.Stop the postmaster and vacuum that database in single-user mode.You might also need to commit or roll back old prepared transactions, or dropstale replication slots.\n```\n\u6216\u8005\uff0c\u7cfb\u7d71\u53ef\u80fd\u6703\u986f\u793a\u5982\u4e0b `WARNING` \u6d88\u606f\uff1a\n```\ndatabase dbname must be vacuumed within 10985967 transactions.To avoid a database shutdown, execute a database-wide VACUUM in that database.\n```\n**\u91cd\u8981\u63d0\u793a** \uff1a\u932f\u8aa4\u6d88\u606f\u201cStop the postmaster and vacuum that database in single-user mode.\u201d\uff08\u505c\u6b62 Postmaster \u4e26\u5728\u55ae\u7528\u6236\u6a21\u5f0f\u4e0b\u6e05\u7a7a\u8a72\u6578\u64da\u5eab\u3002\uff09\u662f PostgreSQL v.8.3 \u4e4b\u524d\u7684\u904e\u6642\u932f\u8aa4\uff0c\u4ee5\u524d\u78ba\u5be6\u5b58\u5728\u6b64\u932f\u8aa4\u3002\u5728\u5927\u591a\u6578\u60c5\u6cc1\u4e0b\uff0c\u60a8\u7121\u9700\u5207\u63db\u5230\u55ae\u7528\u6236\u6a21\u5f0f\u3002\u60a8\u53ef\u4ee5\u904b\u884c\u6240\u9700\u7684 `VACUUM` \u547d\u4ee4\uff0c\u4e26\u5c0d `VACUUM` \u57f7\u884c\u8abf\u7bc0\uff0c\u4ee5\u5feb\u901f\u904b\u884c\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u60a8\u7121\u6cd5\u904b\u884c\u4efb\u4f55\u6578\u64da\u64cd\u7e31\u8a9e\u8a00 (DML)\uff0c\u4f46\u4ecd\u7136\u53ef\u4ee5\u904b\u884c `VACUUM` \u3002\n#", "content": "## Flag `cloudsql.enable_maintenance_mode`\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u4e00\u65e6\u6578\u64da\u5eab\u8655\u65bc\u201c\u74b0\u7e5e\u201d\u72c0\u614b\uff0c\u60a8\u5c31\u7121\u6cd5\u904b\u884c\u4efb\u4f55 DDL \u6216 DML\uff0c\u4f46 Cloud SQL for PostgreSQL \u63d0\u4f9b\u4e86\u7dca\u6025\u7dad\u8b77\u6a21\u5f0f\uff0c\u5b83\u53ef\u63d0\u4f9b 50 \u842c\u500b\u984d\u5916\u7684\u4e8b\u52d9 ID\uff0c\u4ee5\u4fbf\u5728\u55ae\u7528\u6236\u6a21\u5f0f\u4e0b\u7121\u9700\u91cd\u5553\u670d\u52d9\u5668\u5373\u53ef\u64fa\u812b\u9019\u7a2e\u60c5\u6cc1\u3002\u5982\u9700\u6fc0\u6d3b\u7dad\u8b77\u6a21\u5f0f\uff0c\u8acb\u5728\u4f7f\u7528\u4efb\u4f55\u9700\u8981\u4e8b\u52d9 ID \u7684\u547d\u4ee4\u4e4b\u524d\uff0c\u5728\u6578\u64da\u5eab\u6703\u8a71\u4e2d\u5c07 `cloudsql.enable_maintenance_mode` \u8a2d\u7f6e\u7232 `on` \u3002```\nSET cloudsql.enable_maintenance_mode = 'on';\n[ your SQL, DML or DDL commands here ]\n```\u6b64\u64cd\u4f5c\u9700\u8981\u5728\u57f7\u884c\u7dad\u8b77\u7684\u6703\u8a71\u4e2d\u5b8c\u6210\uff0c\u7136\u5f8c\u518d\u57f7\u884c\u4efb\u4f55\u9700\u8981\u4e8b\u52d9 ID \u7684\u64cd\u4f5c\u3002\n## \u6b65\u9a5f\u6982\u8ff0\n- \u627e\u51fa\u54ea\u4e9b\u6578\u64da\u5eab\u548c\u54ea\u4e9b\u8868\u5c0e\u81f4\u74b0\u7e5e\u3002\n- \u6aa2\u67e5\u662f\u5426\u5b58\u5728\u4efb\u4f55\u963b\u6b62 (AUTO) VACUUM \u7684\u5167\u5bb9\uff08\u4f8b\u5982\u5361\u4f4f\u7684\u4e8b\u52d9 ID\uff09\u3002\n- \u6e2c\u91cf AUTOVACUUM \u7684\u901f\u5ea6\u3002\u5982\u679c\u904b\u884c\u7de9\u6162\uff0c\u5247\u53ef\u4ee5\u9078\u64c7\u5617\u8a66\u52a0\u901f\u3002\n- \u5982\u679c\u9700\u8981\uff0c\u624b\u52d5\u904b\u884c\u66f4\u591a VACUUM \u547d\u4ee4\u3002\n- \u8abf\u67e5\u5176\u4ed6\u53ef\u52a0\u5feb\u6e05\u7a7a\u901f\u5ea6\u7684\u65b9\u6cd5\u3002\u6709\u6642\uff0c\u6700\u5feb\u7684\u65b9\u6cd5\u5c31\u662f\u522a\u9664\u8868\u6216\u4e00\u4e9b\u7d22\u5f15\u3002\n\u8a31\u591a\u95dc\u65bc\u6a19\u8a8c\u503c\u7684\u5efa\u8b70\u662f\u6545\u610f\u4e0d\u7cbe\u78ba\u7684\uff0c\u56e0\u7232\u5b83\u5011\u53d6\u6c7a\u65bc\u8a31\u591a\u6578\u64da\u5eab\u53c3\u6578\u3002\u8acb\u95b1\u8b80\u672c\u9801\u672b\u5c3e\u93c8\u63a5\u7684\u6587\u6a94\uff0c\u4ee5\u66f4\u6df1\u5165\u5730\u77ad\u89e3\u6b64\u4e3b\u984c\u3002\n## \u627e\u5230\u5c0e\u81f4\u74b0\u7e5e\u7684\u6578\u64da\u5eab\u548c\u8868\n### \u67e5\u627e\u6578\u64da\u5eab\n\u7232\u4e86\u627e\u51fa\u54ea\u4e9b\u6578\u64da\u5eab\u5305\u542b\u5c0e\u81f4\u74b0\u7e5e\u7684\u8868\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u67e5\u8a62\uff1a\n```\nSELECT datname,\u00a0 \u00a0 \u00a0 \u00a0age(datfrozenxid),\u00a0 \u00a0 \u00a0 \u00a02^31-1000000-age(datfrozenxid) as remaining\u00a0 FROM pg_database\u00a0ORDER BY 3\n```\n`remaining` \u503c\u63a5\u8fd1 0 \u7684\u6578\u64da\u5eab\u662f\u5c0e\u81f4\u554f\u984c\u7684\u6578\u64da\u5eab\u3002\n### \u67e5\u627e\u8868\n\u9023\u63a5\u5230\u8a72\u6578\u64da\u5eab\u4e26\u904b\u884c\u4ee5\u4e0b\u67e5\u8a62\uff1a\n```\nSELECT c.relnamespace::regnamespace as schema_name,\u00a0 \u00a0 \u00a0 \u00a0c.relname as table_name,\u00a0 \u00a0 \u00a0 \u00a0greatest(age(c.relfrozenxid),age(t.relfrozenxid)) as age,\u00a0 \u00a0 \u00a0 \u00a02^31-1000000-greatest(age(c.relfrozenxid),age(t.relfrozenxid)) as remaining\u00a0 FROM pg_class c\u00a0 LEFT JOIN pg_class t ON c.reltoastrelid = t.oid\u00a0WHERE c.relkind IN ('r', 'm')\u00a0ORDER BY 4;\n```\n\u6b64\u67e5\u8a62\u6703\u8fd4\u56de\u5c0e\u81f4\u554f\u984c\u7684\u4e00\u500b\u6216\u591a\u500b\u8868\u3002\n### \u5c0d\u65bc\u81e8\u6642\u8868\n\u5982\u679c `schema_name` \u4ee5 `pg_temp_` \u958b\u982d\uff0c\u5247\u89e3\u6c7a\u6b64\u554f\u984c\u7684\u552f\u4e00\u65b9\u6cd5\u662f\u522a\u9664\u8868\uff0c\u56e0\u7232 PostgreSQL \u4e0d\u5141\u8a31\u60a8\u5728\u5176\u4ed6\u6703\u8a71\u4e2d\u5275\u5efa\u7684 VACUUM \u81e8\u6642\u8868\u3002\u6709\u6642\uff0c\u5982\u679c\u8a72\u6703\u8a71\u8655\u65bc\u6253\u958b\u548c\u53ef\u8a2a\u554f\u72c0\u614b\uff0c\u60a8\u53ef\u4ee5\u5728\u8a72\u6703\u8a71\u4e2d\u6e05\u7a7a\u8a72\u8868\uff0c\u4f46\u901a\u5e38\u60c5\u6cc1\u4e26\u975e\u5982\u6b64\u3002\u4f7f\u7528\u4ee5\u4e0b SQL \u8a9e\u53e5\u4f86\u522a\u9664\u81e8\u6642\u8868\uff1a\n```\nSET cloudsql.enable_maintenance_mode = 'on'; /* get extra transaction ids */DROP TABLE pg_temp_<N>.<tablename>;\n```\n\u5982\u679c\u9019\u662f\u552f\u4e00\u7684\u963b\u6b62\u56e0\u7d20\uff0c\u5247\u5927\u7d04\u4e00\u5206\u9418\u5f8c\uff0c\u81ea\u52d5\u6e05\u7a7a\u6703\u9078\u53d6\u6b64\u66f4\u6539\uff0c\u4e26\u4f7f\u5f97 `datfrozenxid` \u5728 `pg_database` \u4e2d\u5411\u524d\u79fb\u52d5\u3002\u9019\u53ef\u4ee5\u89e3\u6c7a\u74b0\u7e5e\u4fdd\u8b77\u53ea\u8b80\u72c0\u614b\u3002\n### \u666e\u901a\u8868\n\u5c0d\u65bc\u666e\u901a\uff08\u975e\u81e8\u6642\uff09\u8868\uff0c\u7e7c\u7e8c\u57f7\u884c\u4e0b\u9762\u7684\u5f8c\u7e8c\u6b65\u9a5f\uff0c\u67e5\u770b\u662f\u5426\u6709\u4efb\u4f55\u5167\u5bb9\u963b\u6b62\u4e86\u6e05\u7406\u64cd\u4f5c\u3001VACUUM \u904b\u884c\u901f\u5ea6\u662f\u5426\u8db3\u5920\u5feb\u4ee5\u53ca\u6700\u91cd\u8981\u7684\u8868\u662f\u5426\u88ab\u6e05\u7a7a\u3002\n## \u6aa2\u67e5\u5361 ID \u662f\u5426\u5361\u4f4f\n\u7cfb\u7d71\u53ef\u80fd\u8017\u76e1\u4e8b\u52d9 ID \u7684\u4e00\u500b\u53ef\u80fd\u539f\u56e0\u662f\uff0cPostgreSQL \u7121\u6cd5 \uff08\u5373\u5c0d\u6240\u6709\u4e8b\u52d9\u90fd\u6a19\u8a18\u7232\u53ef\u898b\uff09\u5728\u6700\u65e9\u7684\u4e8b\u52d9\u4e4b\u5f8c\u5275\u5efa\u7684\u4efb\u4f55\u4e8b\u52d9 ID \u7576\u524d\u6b63\u5728\u904b\u884c\u7684\u4e8b\u52d9\u3002\u9019\u662f\u56e0\u7232\u5b58\u5728\u591a\u7248\u672c\u4f75\u767c\u63a7\u5236 (MVCC) \u898f\u5247\u3002\u5728\u6975\u7aef\u60c5\u6cc1\u4e0b\uff0c\u6b64\u985e\u4e8b\u52d9\u53ef\u80fd\u6703\u8b8a\u5f97\u975e\u5e38\u820a\uff0c\u4ee5\u81f4\u65bc VACUUM \u5728\u7e3d\u9ad4 20 \u5104\u500b\u4e8b\u52d9 ID \u5c01\u88dd\u7684\u9650\u5236\u4e0b\u7121\u6cd5\u6e05\u7406\u9019\u4e9b\u820a\u4e8b\u52d9\uff0c\u4e26\u4e14\u6703\u5c0e\u81f4\u6574\u500b\u7cfb\u7d71\u505c\u6b62\u63a5\u53d7\u65b0\u7684 DML\u3002\u60a8\u901a\u5e38\u6703\u5728\u65e5\u8a8c\u6587\u4ef6\u4e2d\u770b\u5230\u8b66\u544a\uff0c\u4e0a\u9762\u986f\u793a `WARNING: oldest xmin is far in the past` \u3002\n\u53ea\u6709\u5728\u88dc\u6551\u4e8b\u52d9 ID \u53ef\u4ee5\u88dc\u6551\u5f8c\uff0c\u624d\u61c9\u79fb\u81f3\u512a\u5316\u968e\u6bb5\u3002\n\u4ee5\u4e0b\u662f\u53ef\u80fd\u5c0e\u81f4\u4e8b\u52d9 ID \u5361\u4f4f\u7684\u56db\u500b\u6f5b\u5728\u539f\u56e0\uff0c\u4ee5\u53ca\u6709\u95dc\u5982\u4f55\u7de9\u89e3\u5404\u500b ID \u7684\u4fe1\u606f\uff1a\n- **\u9577\u6642\u9593\u904b\u884c\u7684\u4e8b\u52d9** \uff1a\u8b58\u5225\u9019\u4e9b\u4e8b\u52d9\uff0c\u7136\u5f8c\u53d6\u6d88\u6216\u7d42\u6b62\u5f8c\u7aef\uff0c\u4ee5\u53d6\u6d88\u6e05\u7a7a\u3002\n- **\u5b64\u7acb\u7684\u6e96\u5099\u4e8b\u52d9** \uff1a\u56de\u6efe\u9019\u4e9b\u4e8b\u52d9\u3002\n- **\u5df2\u653e\u68c4\u7684\u8907\u88fd\u69fd** \uff1a\u6368\u68c4\u653e\u68c4\u7684\u69fd\u3002\n- **\u5c0d\u526f\u672c\u57f7\u884c\u9577\u6642\u9593\u904b\u884c\u7684\u4e8b\u52d9\uff08\u4f7f\u7528 hot_standby_feedback = on\uff09** \uff1a\u8b58\u5225\u9019\u4e9b\u4e8b\u52d9\uff0c\u7136\u5f8c\u53d6\u6d88\u6216\u7d42\u6b62\u5f8c\u7aef\uff0c\u4ee5\u89e3\u9664\u5c0d\u6e05\u7a7a\u7684\u5c01\u9396\u3002\n\u5c0d\u65bc\u9019\u4e9b\u5834\u666f\uff0c\u4ee5\u4e0b\u67e5\u8a62\u6703\u8fd4\u56de\u6700\u65e9\u7684\u4e8b\u52d9\u7684\u5b58\u5728\u6642\u9593\u4ee5\u53ca\u672a\u5b8c\u6210\u7684\u4e8b\u52d9\u6578\u91cf\uff1a\n```\n\u00a0WITH q AS (SELECT\u00a0 (SELECT max(age(backend_xmin))\u00a0 \u00a0 \u00a0 FROM pg_stat_activity \u00a0WHERE state != 'idle' ) \u00a0 \u00a0 \u00a0 AS oldest_running_xact_age,\u00a0 (SELECT max(age(transaction)) FROM pg_prepared_xacts) \u00a0 \u00a0AS oldest_prepared_xact_age,\u00a0 (SELECT max(greatest(age(catalog_xmin),age(xmin))) FROM pg_replication_slots) \u00a0 \u00a0 \u00a0 \u00a0AS oldest_replication_slot_age,\u00a0 (SELECT max(age(backend_xmin)) FROM pg_stat_replication) AS oldest_replica_xact_age)SELECT *,\u00a0 \u00a0 \u00a0 \u00a02^31 - oldest_running_xact_age AS oldest_running_xact_left,\u00a0 \u00a0 \u00a0 \u00a02^31 - oldest_prepared_xact_age AS oldest_prepared_xact_left,\u00a0 \u00a0 \u00a0 \u00a02^31 - oldest_replication_slot_age AS oldest_replication_slot_left,\u00a0 \u00a0 \u00a0 \u00a02^31 - oldest_replica_xact_age AS oldest_replica_xact_leftFROM q;\n```\n\u6b64\u67e5\u8a62\u53ef\u80fd\u6703\u8fd4\u56de\u5728\u63a5\u8fd1\u6216\u5c0f\u65bc 100 \u842c\u6642\u5831\u544a\u7684\u4efb\u4f55 \u503c\u3002\u6b64\u503c\u662f PostgreSQL \u505c\u6b62\u63a5\u53d7\u65b0\u5beb\u5165\u547d\u4ee4\u6642\u7684\u74b0\u7e5e\u4fdd\u8b77\u9650\u5236\u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u8acb\u53c3\u95b1 [\u79fb\u9664 VACUUM \u6514\u622a\u5668](#how-to-remove) \u6216 [\u8abf\u6574 VACUUM](#tuning-vacuum-short) \u3002\n\u4f8b\u5982\uff0c\u4e0a\u8ff0\u67e5\u8a62\u53ef\u80fd\u6703\u8fd4\u56de\uff1a\n```\n\u250c\u2500[ RECORD 1 ]\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\u2502 oldest_running_xact_age \u00a0 \u00a0 \u00a0\u2502 2146483655 \u2502\u2502 oldest_prepared_xact_age \u00a0 \u00a0 \u2502 2146483655 \u2502\u2502 oldest_replication_slot_age \u00a0\u2502 \u00a4 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502\u2502 oldest_replica_xact_age \u00a0 \u00a0 \u00a0\u2502 \u00a4 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502\u2502 oldest_running_xact_left \u00a0 \u00a0 \u2502 999993 \u00a0 \u00a0 \u2502\u2502 oldest_prepared_xact_left \u00a0 \u00a0\u2502 999993 \u00a0 \u00a0 \u2502\u2502 oldest_replication_slot_left \u2502 \u00a4 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502\u2502 oldest_replica_xact_left \u00a0 \u00a0 \u2502 \u00a4 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\u5176\u4e2d `oldest_running_xact_left` \u548c `oldest_prepared_xact_left` \u5728 100 \u842c\u500b\u74b0\u7e5e\u4fdd\u8b77\u7bc4\u570d\u5167\u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u60a8\u5fc5\u9808\u9996\u5148\u79fb\u9664 VACUUM \u7684\u969c\u7919\uff0c\u7136\u5f8c\u624d\u80fd\u7e7c\u7e8c\u3002\n## \u79fb\u9664 VACUUM \u969c\u7919\n### \u9577\u6642\u9593\u904b\u884c\u7684\u4e8b\u52d9\n\u5728\u4e0a\u9762\u7684\u67e5\u8a62\u4e2d\uff0c\u5982\u679c `oldest_running_xact` \u7b49\u65bc `oldest_prepared_xact` \uff0c\u7136\u5f8c\u8f49\u5230 [\u5b64\u7acb\u7684\u6e96\u5099\u4e8b\u52d9](#orphaned-prepare) \u90e8\u5206\uff0c\u56e0\u7232 \u503c\u9084\u5305\u62ec\u6e96\u5099\u7684\u4e8b\u52d9\u3002\n\u60a8\u53ef\u80fd\u9700\u8981\u5148\u4ee5 `postgres` \u7528\u6236\u8eab\u4efd\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\nGRANT pg_signal_backend TO postgres;\n```\n\u5982\u679c\u9055\u898f\u4e8b\u52d9\u5c6c\u65bc\u4efb\u4f55\u7cfb\u7d71\u7528\u6236\uff08\u4ee5 `cloudsql...` \u958b\u982d\u7684\u7528\u6236\uff09\uff0c\u60a8\u5c07\u7121\u6cd5\u76f4\u63a5\u53d6\u6d88\u8a72\u4e8b\u52d9\u3002\u60a8\u5fc5\u9808\u91cd\u5553\u6578\u64da\u5eab\u624d\u80fd\u5c07\u5176\u53d6\u6d88\u3002\n\u8981\u78ba\u5b9a\u9577\u6642\u9593\u904b\u884c\u7684\u67e5\u8a62\uff0c\u7136\u5f8c\u53d6\u6d88\u6216\u7d42\u6b62\u67e5\u8a62\u4ee5\u6e05\u7a7a\u8a72\u67e5\u8a62\uff0c\u8acb\u5148\u9078\u64c7\u5e7e\u500b\u6700\u65e9\u7684\u67e5\u8a62\u3002 `LIMIT 10` \u884c\u53ef\u5e6b\u52a9\u5728\u5c4f\u5e55\u4e0a\u8abf\u6574\u7d50\u679c\u3002\u60a8\u53ef\u80fd\u9700\u8981\u5728\u89e3\u6c7a\u6700\u65e9\u904b\u884c\u7684\u67e5\u8a62\u5f8c\u91cd\u5fa9\u6b64\u64cd\u4f5c\u3002\n```\nSELECT pid,\u00a0 \u00a0 \u00a0 \u00a0age(backend_xid) AS age_in_xids,\u00a0 \u00a0 \u00a0 \u00a0now() - xact_start AS xact_age,\u00a0 \u00a0 \u00a0 \u00a0now() - query_start AS query_age,\u00a0 \u00a0 \u00a0 \u00a0state,\u00a0 \u00a0 \u00a0 \u00a0query\u00a0FROM pg_stat_activity\u00a0WHERE state != 'idle'\u00a0ORDER BY 2 DESC\u00a0LIMIT 10;\n```\n\u5982\u679c `age_in_xids` \u8fd4\u56de\u7232 `NULL` NULL\uff0c\u5247\u8868\u793a\u4e8b\u52d9\u5c1a\u672a\u5206\u914d\u6c38\u4e45\u4e8b\u52d9 ID\uff0c\u60a8\u53ef\u653e\u5fc3\u5730\u5ffd\u7565\u8a72\u4e8b\u52d9\u3002\n\u53d6\u6d88 `xids_left_to_wraparound` \u63a5\u8fd1 1M \u7684\u67e5\u8a62\u3002\n\u5982\u679c `state` \u7232 `active` \uff0c\u5247\u53ef\u4ee5\u4f7f\u7528 `SELECT pg_cancel_backend(` `` `);` \u53d6\u6d88\u67e5\u8a62\u3002\u5426\u5247\uff0c\u60a8\u9700\u8981\u4f7f\u7528 `SELECT pg_terminate_backend(` `` `);` \u7d42\u6b62\u6574\u500b\u9023\u63a5\uff0c\u5176\u4e2d \u662f\u4e0a\u4e00\u500b\u67e5\u8a62\u7684 `pid` \u3002\n### \u5b64\u7acb\u7684\u6e96\u5099\u4e8b\u52d9\n**\u6ce8\u610f** \uff1a\u5982\u9700\u63d0\u4ea4\u6e96\u5099\u597d\u7684\u4e8b\u52d9\uff0c\u60a8\u5fc5\u9808\u4ee5\u6700\u521d\u57f7\u884c\u4e8b\u52d9\u7684\u540c\u4e00\u7528\u6236\u8eab\u4efd\u9032\u884c\u9023\u63a5\u3002\u8acb\u53c3\u95b1\u4e0b\u8868\u4e2d\u7684\u5b57\u6bb5 `owner` \u3002 \u662f `pg_stat_progress_vacuum` \u8996\u5716\u4e2d\u7684\u6578\u64da\u5eab\u540d\u7a31\u3002\n\u5217\u51fa\u6240\u6709\u6e96\u5099\u597d\u7684\u4e8b\u52d9\uff1a\n```\nDB_NAME=> SELECT age(transaction),* FROM pg_prepared_xacts ;\u250c\u2500[ RECORD 1 ]\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\u2502 age \u00a0 \u00a0 \u00a0 \u00a0 \u2502 2146483656 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502\u2502 transaction \u2502 2455493932 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502\u2502 gid \u00a0 \u00a0 \u00a0 \u00a0 \u2502 trx_id_pin \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502\u2502 prepared \u00a0 \u00a0\u2502 2021-03-03 16:54:07.923158+00 \u2502\u2502 owner \u00a0 \u00a0 \u00a0 \u2502 postgres \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502\u2502 database \u00a0 \u00a0\u2502 DB_NAME \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u2502\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\u4f7f\u7528\u6700\u5f8c\u4e00\u500b\u67e5\u8a62\uff08\u672c\u4f8b\u4e2d\u7232 `trx_id_pin` \uff09\u4e2d\u7684 `gid` \u4f5c\u7232\u4e8b\u52d9 ID\uff0c\u56de\u6efe\u6700\u65e9\u7684\u5b64\u7acb\u7684\u6e96\u5099\u4e8b\u52d9\uff1a\n```\nROLLBACK PREPARED trx_id_pin;\n```\n\u6216\u8005\uff0c\u8acb\u63d0\u4ea4\uff1a\n```\nCOMMIT PREPARED trx_id_pin;\n```\n\u5982\u9700\u77ad\u89e3\u5b8c\u6574\u8aaa\u660e\uff0c\u8acb\u53c3\u95b1 [SQL ROLLBACK PREPARED](https://www.postgresql.org/docs/13/sql-rollback-prepared.html) \u6587\u6a94\u3002\n### \u5df2\u653e\u68c4\u7684\u8907\u88fd\u69fd\n\u5982\u679c\u8907\u88fd\u69fd\u662f\u56e0\u7232\u73fe\u6709\u526f\u672c\u5df2\u505c\u6b62\u3001\u66ab\u505c\u6216\u4eca\u5f8c\u5c0e\u81f4\u67d0\u4e9b\u554f\u984c\u800c\u653e\u68c4\uff0c\u60a8\u53ef\u4ee5\u5f9e \u6216 Google Cloud Console `gcloud` \u522a\u9664\u526f\u672c\u3002\n\u9996\u5148\uff0c\u6309\u7167 [\u7ba1\u7406\u8b80\u53d6\u526f\u672c](https://cloud.google.com/sql/docs/postgres/replication/manage-replicas?hl=zh-cn) \u4e2d\u7684\u8aaa\u660e\u6aa2\u67e5\u526f\u672c\u662f\u5426\u672a\u505c\u7528\u3002\u5982\u679c\u526f\u672c\u5df2\u505c\u7528\uff0c\u8acb\u518d\u6b21\u5553\u7528\u3002\u5982\u679c\u5ef6\u9072\u4ecd\u7136\u5f88\u9ad8\uff0c\u5247\u522a\u9664\u526f\u672c\u3002\n\u8907\u88fd\u69fd\u6703\u986f\u793a\u5728 `pg_replication_slots` \u7cfb\u7d71\u8996\u5716\u4e2d\u3002\n\u4ee5\u4e0b\u67e5\u8a62\u6703\u7372\u53d6\u76f8\u95dc\u4fe1\u606f\uff1a\n```\nSELECT *, age(xmin) AS age FROM pg_replication_slots;\u250c\u2500[ RECORD 1 ]\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\u2502 slot_name \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u2502 cloudsql_1_355b114b_9ff4_4bc3_ac88_6a80199bd738 \u2502\u2502 plugin \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502 \u00a4 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u2502\u2502 slot_type \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u2502 physical \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502\u2502 datoid \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502 \u00a4 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u2502\u2502 database \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502 \u00a4 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u2502\u2502 active \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502 t \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u2502\u2502 active_pid \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502 1126 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502\u2502 xmin \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502 2453745071 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502\u2502 catalog_xmin \u00a0 \u00a0 \u00a0 \u00a0\u2502 \u00a4 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u2502\u2502 restart_lsn \u00a0 \u00a0 \u00a0 \u00a0 \u2502 C0/BEF7C2D0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u2502\u2502 confirmed_flush_lsn \u2502 \u00a4 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u2502\u2502 age \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u2502 59 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\u5728\u6b64\u793a\u4f8b\u4e2d\uff0c `pg_replication_slots` \u503c\u904b\u884c\u72c0\u6cc1\u826f\u597d\uff08\u5e74\u9f61 == 59\uff09\u3002\u5982\u679c\u5b58\u5728\u6642\u9593\u63a5\u8fd1 20 \u5104\uff0c\u5247\u60a8\u9700\u8981\u522a\u9664\u69fd\u3002\u5728\u67e5\u8a62\u8fd4\u56de\u591a\u689d\u8a18\u9304\u7684\u60c5\u6cc1\u4e0b\uff0c\u7121\u6cd5\u8f15\u9b06\u78ba\u5b9a\u6bcf\u500b\u78ba\u5207\u7684\u526f\u672c\u3002\u56e0\u6b64\uff0c\u8acb\u6aa2\u67e5\u9019\u4e9b\u526f\u672c\uff0c\u4ee5\u9632\u4efb\u4f55\u526f\u672c\u4e0a\u6709\u9577\u6642\u9593\u904b\u884c\u7684\u4e8b\u52d9\u3002\n### \u526f\u672c\u4e0a\u7684\u9577\u6642\u9593\u904b\u884c\u7684\u4e8b\u52d9\n\u6aa2\u67e5 `hot_standby_feedback` \u8a2d\u7f6e\u7232 `on` \u7684\u6700\u65e9\u904b\u884c\u4e8b\u52d9\u7684\u526f\u672c\uff0c\u4e26\u5728\u526f\u672c\u4e0a\u5c07\u5176\u505c\u7528\u3002\n`pg_stat_replication` \u8996\u5716\u4e2d\u7684 `backend_xmin` \u5217\u986f\u793a\u4e86\u526f\u672c\u6240\u9700\u7684\u6700\u65e9 `TXID` \u3002\n\u5982\u9700\u5c07\u5176\u5411\u524d\u79fb\u52d5\uff0c\u8acb\u505c\u6b62\u5c07\u5176\u4fdd\u7559\u5728\u526f\u672c\u4e0a\u7684\u67e5\u8a62\u3002 \u8981\u4e86\u89e3\u54ea\u500b\u67e5\u8a62\u6b63\u5728\u4fdd\u7559\u5b83\uff0c\u8acb\u4f7f\u7528 [\u9577\u6642\u9593\u904b\u884c\u7684\u4e8b\u52d9](#long-running-transaction) \u4e2d\u7684\u67e5\u8a62\uff0c\u4f46\u9019\u6b21\u5728\u526f\u672c\u4e0a\u904b\u884c\u8a72\u67e5\u8a62\u3002\n\u53e6\u4e00\u7a2e\u65b9\u6cd5\u662f\u91cd\u5553\u526f\u672c\u3002\n## \u914d\u7f6e VACUUM\n\u8a2d\u7f6e\u4ee5\u4e0b\u5169\u500b\u6a19\u8a8c\uff1a\n- autovacuum_vacuum_cost_delay = 0\n- autovacuum_work_mem = 1048576\n\u7b2c\u4e00\u500b\u8acb\u6c42\u6703\u505c\u7528 PostgreSQL \u5c0d\u6e05\u7a7a\u904b\u884c\u7684\u4efb\u4f55\u78c1\u76e4\u9650\u5236\uff0c\u4ee5\u4fbf VACUUM \u5168\u901f\u904b\u884c\uff08\u9ed8\u8a8d\u60c5\u6cc1\u4e0b autovacuum \u53d7\u5230\u9650\u5236\uff0c\u56e0\u6b64\u5b83\u4e0d\u6703\u5728\u6700\u7de9\u6162\u7684\u670d\u52d9\u5668\u4e0a\u8017\u76e1\u6240\u6709\u78c1\u76e4 IO\uff09\u3002\n\u7b2c\u4e8c\u500b\u6a19\u8a8c `autovacuum_work_mem` \u6703\u6e1b\u5c11\u7d22\u5f15\u6e05\u7406\u7684\u6b21\u6578\u3002\u5982\u679c\u53ef\u80fd\u7684\u8a71\uff0c\u5176\u5bb9\u91cf\u61c9\u8db3\u5920\u5927\uff0c\u4ee5\u4fbf\u80fd\u5920\u5b58\u5132 VACUUM \u5c07\u8981\u6e05\u7406\u7684\u8868\u4e2d\u7684\u7a7a\u9592\u884c\u7684\u6240\u6709 ID\u3002\u8a2d\u7f6e\u6b64\u503c\u6642\uff0c\u8acb\u8003\u616e\u9019\u662f\u6bcf\u500b\u904b\u884c VACUUM \u53ef\u4ee5\u5206\u914d\u7684\u672c\u5730\u5167\u5b58\u4e0a\u9650\u3002\u8acb\u78ba\u4fdd\u60a8\u6c92\u6709\u8d85\u51fa\u53ef\u7528\u9650\u5236\uff0c\u4f46\u6709\u4e00\u4e9b\u5269\u9918\u914d\u984d\u3002\u5982\u679c\u60a8\u5c07\u6578\u64da\u5eab\u4fdd\u6301\u5728\u53ea\u8b80\u6a21\u5f0f\u904b\u884c\uff0c\u5247\u9084\u8981\u8003\u616e\u7528\u65bc\u53ea\u8b80\u67e5\u8a62\u7684\u672c\u5730\u5167\u5b58\u3002\n\u5728\u5927\u591a\u6578\u7cfb\u7d71\u4e0a\uff0c\u8acb\u4f7f\u7528\u6700\u5927\u503c\uff081 GB \u6216 1048576 kB\uff0c\u5982\u793a\u4f8b\u4e2d\u6240\u793a\uff09\u3002\u9019\u500b\u5927\u5c0f\u9069\u5408\u591a\u9054\u5927\u7d04 1.78 \u5104\u500b\u7a7a\u9592\u5143\u7d44\u3002\u5982\u679c\u6709\u66f4\u591a\u5143\u7d44\uff0c\u5247\u6703\u5c0e\u81f4\u591a\u6b21\u7d22\u5f15\u6383\u63cf\u3002\n[\u5728 PostgreSQL \u4e2d\u512a\u5316\u548c\u76e3\u63a7 VACUUM \u64cd\u4f5c](https://cloud.google.com/solutions/optimizing-monitoring-troubleshooting-vacuum-operations-postgresql?hl=zh-cn) \u4e2d\u8a73\u7d30\u4ecb\u7d39\u4e86\u9019\u4e9b\u6a19\u8a8c\u548c\u5176\u4ed6\u6a19\u8a8c\u3002\n\u8a2d\u7f6e\u9019\u4e9b\u6a19\u8a8c\u5f8c\uff0c\u91cd\u5553\u6578\u64da\u5eab\uff0c\u4f7f\u81ea\u52d5\u6e05\u7a7a\u4ee5\u65b0\u503c\u958b\u982d\u3002\n\u60a8\u53ef\u4ee5\u4f7f\u7528 `pg_stat_progress_vacuum` \u8996\u5716\u76e3\u63a7 autovacuum \u5553\u52d5\u7684 VACUUM \u7684\u9032\u5ea6\u3002\u6b64\u8996\u5716\u986f\u793a\u4e86\u5728\u6240\u6709\u6578\u64da\u5eab\u4e2d\u904b\u884c\u7684 VACUUM\uff0c\u4ee5\u53ca\u5c0d\u65bc\u5176\u4ed6\u6578\u64da\u5eab\u4e2d\u7121\u6cd5\u4f7f\u7528\u8868\u5217 `relid` \u67e5\u627e\u8868\u540d\u7a31\uff08\u95dc\u4fc2\uff09\u3002\n\u5982\u8981\u78ba\u5b9a\u63a5\u4e0b\u4f86\u9700\u8981\u6e05\u7a7a\u7684\u6578\u64da\u5eab\u548c\u8868\uff0c\u8acb\u4f7f\u7528 [PostgreSQL \u4e2d\u7684\u512a\u5316\u3001\u76e3\u63a7\u548c VACUUM \u64cd\u4f5c\u554f\u984c\u6392\u67e5](https://cloud.google.com/solutions/optimizing-monitoring-troubleshooting-vacuum-operations-postgresql?hl=zh-cn) \u67e5\u8a62\u3002\u5982\u679c\u670d\u52d9\u5668\u865b\u64ec\u6a5f\u529f\u80fd\u8db3\u5920\u5f37\u5927\uff0c\u4e26\u4e14\u5177\u6709\u6bd4 autovacuum \u5553\u52d5\u7684\u4e26\u884c VACUUM \u9032\u7a0b\u66f4\u591a\u7684\u5e36\u5bec\uff0c\u5247\u53ef\u4ee5\u5553\u52d5\u4e00\u4e9b\u624b\u52d5\u6e05\u7a7a\u3002\n## \u6aa2\u67e5 VACUUM \u901f\u5ea6\n\u672c\u90e8\u5206\u4ecb\u7d39\u77ad\u5982\u4f55\u6aa2\u67e5\u6e05\u7a7a\u901f\u5ea6\uff0c\u4ee5\u53ca\u5982\u4f55\u6839\u64da\u9700\u8981\u52a0\u5feb\u901f\u5ea6\u3002\n### \u6aa2\u67e5\u904b\u884c\u6e05\u7a7a\n\u904b\u884c [ \u7684\u6240\u6709\u5f8c\u7aef\u90fd\u986f\u793a\u5728\u7cfb\u7d71\u8996\u5716 ](https://www.postgresql.org/docs/11/progress-reporting.html) pg_stat_progress_vacuum \u4e2d\u3002\n\u5982\u679c\u7576\u524d\u968e\u6bb5\u7232 `scanning heap` \uff0c\u5247\u53ef\u4ee5\u901a\u904e\u89c0\u5bdf `heap_blks_scanned` \u5217\u4e2d\u7684\u8b8a\u5316\u4f86\u76e3\u63a7\u9032\u5ea6\u3002\u907a\u61be\u7684\u662f\uff0c\u5f88\u96e3\u78ba\u5b9a\u5176\u4ed6\u968e\u6bb5\u7684\u6383\u63cf\u901f\u5ea6\u3002\n### \u4f30\u7b97 VACUUM \u6383\u63cf\u901f\u5ea6\n\u8981\u4f30\u7b97\u6383\u63cf\u901f\u5ea6\uff0c\u60a8\u9700\u8981\u5148\u5b58\u5132\u57fa\u503c\uff0c\u7136\u5f8c\u8a08\u7b97\u4e00\u6bb5\u6642\u9593\u5167\u7684\u8b8a\u5316\u4ee5\u4f30\u7b97\u5b8c\u6210\u6642\u9593\u3002\u9996\u5148\uff0c\u60a8\u9700\u8981\u4f7f\u7528\u4ee5\u4e0b\u5feb\u7167\u67e5\u8a62\u5c07 `heap_blks_scanned` \u7684\u5feb\u7167\u8207\u6642\u9593\u6233\u4e00\u4f75\u4fdd\u5b58\uff1a\n```\nSELECT set_config('save.ts', clock_timestamp()::text, false),\u00a0 \u00a0 \u00a0 \u00a0set_config('save.heap_blks_scanned', heap_blks_scanned::text, false)FROM pg_stat_progress_vacuumWHERE datname = 'DB_NAME';\n```\n\u7531\u65bc\u6211\u5011\u7121\u6cd5\u5c0d\u5df2\u5c01\u88dd\u7684\u8868\u4e2d\u4fdd\u5b58\u4efb\u4f55\u5167\u5bb9\uff0c\u56e0\u6b64\u8acb\u4f7f\u7528 `set_config(flag, value)` \u8a2d\u7f6e\u5169\u500b\u7528\u6236\u5b9a\u7fa9\u7684\u6a19\u8a8c\uff1a `save.ts` \u548c `save.heap_blks_scanned` - \u5f9e\u7576\u524d\u503c\u5230 `pg_stat_progress_vacuum` \u3002\n\u5728\u4e0b\u4e00\u500b\u67e5\u8a62\u4e2d\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u9019\u5169\u500b\u6a19\u8a8c\u4f5c\u7232\u6bd4\u8f03\u57fa\u6e96\u4f86\u78ba\u5b9a\u901f\u5ea6\u4e26\u4f30\u7b97\u5b8c\u6210\u6642\u9593\u3002\n\u6ce8\u610f\uff1a `WHERE datname =` `` \u4e00\u6b21\u50c5\u8abf\u67e5\u4e00\u500b\u6578\u64da\u5eab\u3002\u5982\u679c\u6b64\u6578\u64da\u5eab\u4e2d\u50c5\u904b\u884c\u4e00\u500b\u81ea\u52d5\u6e05\u7a7a\uff0c\u4e26\u4e14\u6bcf\u500b\u6578\u64da\u5eab\u5177\u6709\u591a\u500b\u884c\uff0c\u5247\u6b64\u6578\u5b57\u5c31\u8db3\u5920\u4e86\u3002\u9700\u8981\u5c07\u984d\u5916\u7684\u904e\u6ffe\u689d\u4ef6 `('AND relid= \u2026'')` \u6dfb\u52a0\u5230 WHERE \u4ee5\u6307\u793a\u55ae\u500b\u81ea\u52d5\u6e05\u7a7a\u884c\u3002\u5c0d\u65bc\u4e0b\u4e00\u500b\u67e5\u8a62\u4e5f\u662f\u5982\u6b64\u3002\n\u4fdd\u5b58\u57fa\u503c\u5f8c\uff0c\u53ef\u4ee5\u904b\u884c\u4ee5\u4e0b\u67e5\u8a62\uff1a\n```\nwith q as (\u00a0 \u00a0 SELECT datname,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0phase,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0heap_blks_total,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0heap_blks_scanned,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0clock_timestamp() - current_setting('save.ts')::timestamp AS ts_delta,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0heap_blks_scanned - current_setting('save.heap_blks_scanned')::bigint AS scanned_delta\u00a0 \u00a0 \u00a0FROM pg_stat_progress_vacuum\u00a0 \u00a0 \u00a0WHERE datname = DB_NAME), q2 AS (SELECT *,\u00a0 \u00a0 \u00a0 \u00a0scanned_delta / extract('epoch' FROM ts_delta) AS pages_per_second\u00a0 FROM q)SELECT *,\u00a0 \u00a0 \u00a0 \u00a0(heap_blks_total - heap_blks_scanned) / pages_per_second AS remaining_time\u00a0 FROM q2;\n```\n```\n\u250c\u2500[ RECORD 1 ]\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\u2502 datname \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u2502 DB_NAME \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502\u2502 phase \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u2502 scanning heap \u00a0 \u00a0\u2502\u2502 heap_blks_total \u00a0 \u2502 9497174 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502\u2502 heap_blks_scanned \u2502 18016 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502\u2502 ts_delta \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502 00:00:40.30126 \u00a0 \u2502\u2502 as_scanned_delta \u00a0\u2502 11642 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502\u2502 pages_per_second \u00a0\u2502 288.87434288655 \u00a0\u2502\u2502 remaining_time \u00a0 \u00a0\u2502 32814.1222418038 \u2502\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\u6b64\u67e5\u8a62\u5c07\u7576\u524d\u503c\u8207\u4fdd\u5b58\u7684\u57fa\u503c\u9032\u884c\u6bd4\u8f03\uff0c\u4e26\u8a08\u7b97 `pages_per_second` \u548c `remaining_time` \uff0c\u9019\u4f7f\u6211\u5011\u80fd\u5920\u78ba\u5b9a VACUUM \u662f\u5426\u8db3\u5920\u5feb\u5730\u904b\u884c\uff0c\u6216\u8005\u6211\u5011\u5e0c\u671b\u52a0\u901f\u5b83\u3002 `remaining_time` \u503c\u50c5\u9069\u7528\u65bc `scanning heap` \u968e\u6bb5\u3002\u5176\u4ed6\u968e\u6bb5\u4e5f\u9700\u8981\u6642\u9593\uff0c\u6709\u6642\u751a\u81f3\u66f4\u591a\u3002\u60a8\u53ef\u4ee5 [\u8a73\u7d30\u77ad\u89e3\u6e05\u7a7a](https://www.postgresql.org/docs/13/sql-vacuum.html) \u4e26\u67e5\u770b\u4e92\u806f\u7db2\u4e0a\u7684\u535a\u6587\uff0c\u8a0e\u8ad6\u4e00\u4e9b\u6e05\u7a7a\u7684\u8907\u96dc\u65b9\u9762\u3002\n## \u52a0\u901f\u6e05\u7a7a\n\u52a0\u5feb `autovacuum_vacuum_cost_delay=0` \u6383\u63cf\u901f\u5ea6\u7684\u6700\u5feb\u6377\u65b9\u6cd5\u662f\u8a2d\u7f6e \u3002\u9019\u53ef\u4ee5\u901a\u904e Google Cloud Console \u5b8c\u6210\u3002\n\u907a\u61be\u7684\u662f\uff0c\u5df2\u5728\u904b\u884c\u7684 VACUUM \u4e0d\u6703\u7372\u53d6\u6b64\u503c\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u91cd\u5553\u6578\u64da\u5eab\u3002\n\u91cd\u5553\u5f8c\uff0c\u60a8\u53ef\u80fd\u6703\u770b\u5230\u985e\u4f3c\u5982\u4e0b\u6240\u793a\u7684\u7d50\u679c\uff1a\n```\n\u250c\u2500[ RECORD 1 ]\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\u2502 datname \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u2502 DB_NAME \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502\u2502 phase \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u2502 scanning heap \u00a0 \u00a0\u2502\u2502 heap_blks_total \u00a0 \u2502 9497174 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502\u2502 heap_blks_scanned \u2502 222382 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u2502\u2502 ts_delta \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\u2502 00:00:21.422615 \u00a0\u2502\u2502 as_scanned_delta \u00a0\u2502 138235 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u2502\u2502 pages_per_second \u00a0\u2502 6452.76031894332 \u2502\u2502 remaining_time \u00a0 \u00a0\u2502 1437.33713040171 \u2502\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u901f\u5ea6\u5f9e\u6bcf\u79d2\u5c0f\u65bc 300 \u9801\u589e\u52a0\u5230\u6bcf\u79d2\u7d04 6500 \u9801\uff0c\u5806\u6383\u63cf\u968e\u6bb5\u7684\u9810\u8a08\u5269\u9918\u6642\u9593\u5f9e 9 \u5c0f\u6642\u6e1b\u5c11\u5230 23 \u5206\u9418\u3002\n\u5176\u4ed6\u968e\u6bb5\u7684\u6383\u63cf\u901f\u5ea6\u4e0d\u5bb9\u6613\u6e2c\u91cf\uff0c\u4f46\u5b83\u5011\u61c9\u8a72\u5177\u6709\u985e\u4f3c\u7684\u52a0\u901f\u3002\n\u6b64\u5916\uff0c\u8acb\u8003\u616e\u5118\u53ef\u80fd\u589e\u52a0 `autovacuum_work_mem` \u4ee5\u907f\u514d\u591a\u6b21\u50b3\u905e\u7d22\u5f15\u3002\u6bcf\u7576\u5167\u5b58\u4e2d\u586b\u5145\u6b7b\u5143\u7d44\u6307\u91dd\u6642\uff0c\u5c31\u6703\u767c\u751f\u7d22\u5f15\u50b3\u905e\u3002\n\u5982\u679c\u672a\u4f7f\u7528\u6578\u64da\u5eab\uff0c\u8acb\u5c07 `autovacuum_work_mem` \u8a2d\u7f6e\u7232\u5728\u5141\u8a31\u6240\u9700\u6578\u91cf\u7684 `shared_buffers` \u5f8c\u5177\u6709\u7d04 80% \u7684\u5167\u5b58\u53ef\u7528\u3002\u9019\u662f\u6bcf\u500b\u81ea\u52d5\u6e05\u7a7a\u5553\u52d5\u7684 VACUUM \u9032\u7a0b\u7684\u4e0a\u9650\u3002\u5982\u679c\u60a8\u60f3\u7e7c\u7e8c\u904b\u884c\u53ea\u8b80\u5de5\u4f5c\u8ca0\u8f09\uff0c\u8acb\u6e1b\u5c11\u5167\u5b58\u3002\n## \u63d0\u9ad8\u901f\u5ea6\u7684\u5176\u4ed6\u65b9\u6cd5\n### \u907f\u514d\u6e05\u7a7a\u7d22\u5f15\n\u5c0d\u65bc\u5927\u578b\u8868\uff0cVACUUM \u6703\u82b1\u8cbb\u5927\u91cf\u6642\u9593\u4f86\u6e05\u7406\u7d22\u5f15\u3002\nPostgreSQL 14 \u5177\u6709\u7279\u6b8a\u512a\u5316\u529f\u80fd\uff0c\u53ef\u5728\u7cfb\u7d71\u51fa\u73fe\u74b0\u7e5e\u98a8\u96aa\u6642\u907f\u514d\u6e05\u7406\u7d22\u5f15\u3002\n\u5728 PostgreSQL 12 \u548c 13 \u4e2d\uff0c\u60a8\u53ef\u4ee5\u624b\u52d5\u904b\u884c\u4ee5\u4e0b\u8a9e\u53e5\uff1a\n```\nVACUUM (INDEX_CLEANUP OFF, TRUNCATE OFF) <tablename>;\n```\n\u5728\u7248\u672c 11 \u53ca\u66f4\u65e9\u7248\u672c\u4e2d\uff0c\u60a8\u53ef\u4ee5\u5728\u904b\u884c\u6e05\u7a7a\u4e4b\u524d `DROP` \u7d22\u5f15\uff0c\u4ee5\u5f8c\u91cd\u65b0\u5275\u5efa\u5b83\u3002\n\u7576\u5df2\u7d93\u5728\u91dd\u5c0d\u8868\u904b\u884c\u81ea\u52d5\u6e05\u7a7a\u6642\uff0c\u5982\u679c\u522a\u9664\u7d22\u5f15\uff0c\u5247\u9700\u8981\u53d6\u6d88\u6b63\u5728\u904b\u884c\u7684\u6e05\u7a7a\u64cd\u4f5c\uff0c\u7136\u5f8c\u7acb\u5373\u57f7\u884c\u522a\u9664\u7d22\u5f15\u547d\u4ee4\uff0c\u4e4b\u5f8c\u81ea\u52d5\u6e05\u7a7a\u7e94\u6703\u518d\u6b21\u5c0d\u8a72\u8868\u57f7\u884c\u6e05\u7a7a\u64cd\u4f5c\u3002\n\u9996\u5148\uff0c\u904b\u884c\u4ee5\u4e0b\u8a9e\u53e5\u4ee5\u627e\u51fa\u9700\u8981\u7d42\u6b62\u7684 autovacuum \u9032\u7a0b\u7684 PID\uff1a\n```\nSELECT pid, query\u00a0 FROM pg_stat_activity\u00a0WHERE state != 'idle'\u00a0 \u00a0AND query ilike '%vacuum%';\n```\n\u7136\u5f8c\uff0c\u904b\u884c\u4ee5\u4e0b\u8a9e\u53e5\u4ee5\u7d42\u6b62\u6b63\u5728\u904b\u884c\u7684 vacuum\uff0c\u4e26\u522a\u9664\u4e00\u500b\u6216\u591a\u500b\u7d22\u5f15\uff1a\n```\nSET cloudsql.enable_maintenance_mode = 'on'; /* get extra transaction ids */SELECT pg_terminate_backend(<pid>);DROP INDEX <index1>;DROP INDEX <index2>; ...\n```\n### \u4e1f\u68c4\u5f15\u8d77\u885d\u7a81\u7684\u8868\n\u5728\u6975\u5c11\u6578\u60c5\u6cc1\u4e0b\uff0c\u60a8\u53ef\u4ee5\u4e1f\u68c4\u8868\u3002\u4f8b\u5982\uff0c\u5982\u679c\u8868\u53ef\u4ee5\u8f15\u9b06\u5f9e\u5099\u4efd\u6216\u5176\u4ed6\u6578\u64da\u5eab\u7b49\u5176\u4ed6\u4f86\u6e90\u6062\u5fa9\u3002\n\u60a8\u4ecd\u9700\u4f7f\u7528 `cloudsql.enable_maintenance_mode = 'on'` \uff0c\u4e26\u4e14\u9084\u53ef\u80fd\u7d42\u6b62\u91dd\u5c0d\u8a72\u8868\u7684 VACUUM\uff0c\u5982\u4e0a\u4e00\u90e8\u5206\u6240\u793a\u3002\n### VACUUM FULL\n\u5728\u6975\u5c11\u6578\u60c5\u6cc1\u4e0b\uff0c\u7576\u8868\u53ea\u6709\u4e00\u5c0f\u90e8\u5206\u5be6\u6642\u5143\u7d44\u6642\uff0c\u904b\u884c `VACUUM FULL FREEZE` \u901a\u5e38\u901f\u5ea6\u8f03\u5feb\u3002\u9019\u53ef\u4ee5\u5f9e `pg_stat_user_tables` \u8996\u5716\u9032\u884c\u6aa2\u67e5\uff08\u9664\u975e\u51fa\u73fe\u4e86\u5d29\u6f70\uff0c\u5c0e\u81f4\u64e6\u9664\u4e86\u7d71\u8a08\u4fe1\u606f\uff09\u3002\n`VACUUM FULL` \u547d\u4ee4\u5c07\u5be6\u6642\u5143\u7d44\u8907\u88fd\u5230\u65b0\u6587\u4ef6\uff0c\u56e0\u6b64\u5fc5\u9808\u6709\u8db3\u5920\u7684\u7a7a\u9593\u53ef\u4f9b\u65b0\u7a7a\u9593\u53ca\u5176\u7d22\u5f15\u4f7f\u7528\u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u8a73\u7d30\u77ad\u89e3 [\u5c01\u88dd\u5f0f](https://www.postgresql.org/docs/current/routine-vacuuming.html#VACUUM-FOR-WRAPAROUND) \u6e05\u7a7a\u3002\n- \u8a73\u7d30\u77ad\u89e3 [\u4f8b\u7a0b\u6e05\u7a7a](https://www.postgresql.org/docs/current/routine-vacuuming.html) \u3002\n- \u8a73\u7d30\u77ad\u89e3 [\u81ea\u52d5\u6e05\u7a7a](https://www.postgresql.org/docs/current/runtime-config-autovacuum.html) \n- \u8a73\u7d30\u77ad\u89e3 [\u5728 PostgreSQL \u4e2d\u512a\u5316\u3001\u76e3\u63a7\u548c\u6392\u67e5](https://cloud.google.com/solutions/optimizing-monitoring-troubleshooting-vacuum-operations-postgresql?hl=zh-cn) \u6e05\u7a7a\u64cd\u4f5c", "guide": "Cloud SQL"}