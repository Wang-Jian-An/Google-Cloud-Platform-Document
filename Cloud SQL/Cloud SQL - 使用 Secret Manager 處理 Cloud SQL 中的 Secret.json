{"title": "Cloud SQL - \u4f7f\u7528 Secret Manager \u8655\u7406 Cloud SQL \u4e2d\u7684 Secret", "url": "https://cloud.google.com/sql/docs/postgres/use-secret-manager?hl=zh-cn", "abstract": "# Cloud SQL - \u4f7f\u7528 Secret Manager \u8655\u7406 Cloud SQL \u4e2d\u7684 Secret\n", "content": "## \u6982\u89bd\n\u6b63\u78ba\u7ba1\u7406\u654f\u611f\u4fe1\u606f\u662f\u5275\u5efa\u5b89\u5168\u958b\u767c\u5de5\u4f5c\u6d41\u7684\u91cd\u8981\u74b0\u7bc0\u3002\u5c0d\u65bc Cloud SQL\uff0c\u6211\u5011\u5efa\u8b70\u60a8\u5c07\u654f\u611f\u4fe1\u606f\u5b58\u5132\u5728\u60a8\u5728 [Secret Manager](https://cloud.google.com/secret-manager?hl=zh-cn) \u4e2d\u5275\u5efa\u7684 Secret \u4e2d\u3002Secret \u53ef\u5b58\u5132 API \u5bc6\u9470\u3001\u5bc6\u78bc\u3001\u654f\u611f\u4fe1\u606f\u6216\u60a8\u7528\u4f86\u8a2a\u554f\u6a5f\u5bc6\u7cfb\u7d71\u7684\u6191\u64da\u3002\n\u85c9\u52a9 Secret Manager\uff0c\u60a8\u53ef\u4ee5\u65b9\u4fbf\u5730\u63d0\u5347\u5b89\u5168\u6027\u3002\u60a8\u9084\u53ef\u4ee5\u5c0d Secret \u9032\u884c\u7248\u672c\u63a7\u5236\uff0c\u4e26\u5728\u60a8\u7684\u5718\u968a\u4e2d\u5171\u4eab Secret\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u8207\u60a8\u7684\u5718\u968a\u5171\u4eab Secret\uff0c\u8acb\u53c3\u95b1 [\u8a2a\u554f\u6b0a\u9650\u63a7\u5236 (IAM)](https://cloud.google.com/secret-manager/docs/access-control?hl=zh-cn) \u3002\n\u672c\u9801\u9762\u4ecb\u7d39\u4e86 4 \u500b\u4f7f\u7528 Secret Manager \u4f86\u7ba1\u7406\u7528\u65bc Cloud SQL \u7684 Secret \u7684\u4f7f\u7528\u5834\u666f\uff1a\n- \u5b58\u5132 [\u7528\u6236\u540d\u548c\u5bc6\u78bc](#usernames-and-passwords) \n- \u9023\u63a5\u5230 [Cloud SQL \u5be6\u4f8b](#cloud-sql-instances) \n- \u7ba1\u7406 [SSL/TLS \u8b49\u66f8](#ssl-tls-certificates) \n- \u5354\u8abf [\u707d\u96e3\u6062\u5fa9\u5834\u666f](#disaster-recovery) ## \u6e96\u5099\u5de5\u4f5c\n\u5728\u958b\u59cb\u4f7f\u7528 Secret Manager \u8655\u7406 Cloud SQL \u4e2d\u7684 Secret \u4e4b\u524d\uff0c\u8acb\u5148\u9032\u884c\u4ee5\u4e0b\u6e96\u5099\u5de5\u4f5c\uff1a\n- \u719f\u6089 [Cloud SQL](https://cloud.google.com/sql/docs?hl=zh-cn) \u548c [Secret Manager](https://cloud.google.com/secret-manager/docs?hl=zh-cn) \u3002\n- \u901a\u904e\u4e86\u89e3\u5982\u4f55 [\u5f9e\u60a8\u7684\u672c\u5730\u8a08\u7b97\u6a5f\u9023\u63a5\u5230\u60a8\u7684\u7b2c\u4e00\u500b Cloud SQL \u5be6\u4f8b](https://cloud.google.com/sql/docs/postgres/connect-instance-local-computer?hl=zh-cn) \uff0c\u958b\u59cb\u4e0a\u624b\u4f7f\u7528 Cloud SQL\u3002## \u7528\u6236\u540d\u548c\u5bc6\u78bc\n\u60a8\u53ef\u4ee5\u4f7f\u7528 Secret Manager \u5c07 Cloud SQL \u7528\u6236\u8cec\u865f\u7684\u7528\u6236\u540d\u548c\u5bc6\u78bc\u5b58\u5132\u5728 Secret \u4e2d\uff0c\u9019\u662f\u4e00\u7a2e\u7528\u4f86\u7ba1\u7406\u6b64\u985e\u654f\u611f\u4fe1\u606f\u7684\u5b89\u5168\u53ef\u9760\u7684\u65b9\u6cd5\u3002\n\u9996\u5148\uff0c\u60a8\u5fc5\u9808\u5728 Cloud SQL \u4e2d\u5275\u5efa\u4e00\u500b\u7528\u6236\u3002\u5728\u5275\u5efa\u6b64\u7528\u6236\u6642\uff0c\u60a8\u5fc5\u9808\u63d0\u4f9b\u7528\u6236\u540d\u548c\u5bc6\u78bc\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u5728 Cloud SQL \u4e2d\u5275\u5efa\u7528\u6236\uff0c\u8acb\u53c3\u95b1 [\u5275\u5efa\u548c\u7ba1\u7406\u7528\u6236](https://cloud.google.com/sql/docs/postgres/create-manage-users?hl=zh-cn) \u3002\n\u5275\u5efa\u7528\u6236\u5f8c\uff0c\u5728 Secret Manager \u4e2d\u5275\u5efa Secret \u4f86\u5b58\u5132\u7528\u6236\u540d\u548c\u5bc6\u78bc\u3002\u9019\u6a23\u53ef\u4ee5\u78ba\u4fdd\u9019\u4e9b\u654f\u611f\u4fe1\u606f\u4e0d\u6703\u4e1f\u5931\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u5728 Secret Manager \u4e2d\u5275\u5efa\u548c\u8a2a\u554f Secret\uff0c\u8acb\u53c3\u95b1 [\u5275\u5efa\u548c\u8a2a\u554f Secret](https://cloud.google.com/secret-manager/docs/creating-and-accessing-secrets?hl=zh-cn) \u3002\n## Cloud SQL \u5be6\u4f8b\n\u5728\u9023\u63a5\u5230 Cloud SQL \u5be6\u4f8b\u6642\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 Secret Manager \u4f86\u7ba1\u7406 Secret\uff0c\u4ee5\u5275\u5efa\u5b89\u5168\u7684\u958b\u767c\u5de5\u4f5c\u6d41\u3002\n\u9996\u5148\uff0c\u5f9e\u60a8\u7684\u672c\u5730\u8a08\u7b97\u6a5f\u9023\u63a5\u5230\u60a8\u7684 Cloud SQL \u5be6\u4f8b\u3002\u5728\u5be6\u4f8b\u904b\u884c\u5f8c\uff0c\u4f7f\u7528\u74b0\u5883\u8b8a\u91cf\u9023\u63a5\u5230\u8a72\u5be6\u4f8b\u3002\u8207\u8b8a\u91cf\u95dc\u806f\u7684\u67d0\u4e9b\u503c\u6703\u66f4\u7232\u654f\u611f\uff0c\u4f8b\u5982\u5be6\u4f8b\u9023\u63a5\u7684\u540d\u7a31\u3002\u60a8\u53ef\u4ee5\u5728 Secret Manager \u4e2d\u7232\u6bcf\u500b\u654f\u611f\u503c\u5275\u5efa\u4e00\u500b Secret\uff0c\u4ee5\u4fbf\u5b58\u5132\u548c\u7ba1\u7406\u6b64\u985e\u654f\u611f\u4fe1\u606f\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u4f7f\u7528\u74b0\u5883\u8b8a\u91cf\u9023\u63a5\u5230 Cloud SQL \u5be6\u4f8b\uff0c\u8acb\u53c3\u95b1 [\u914d\u7f6e\u548c\u904b\u884c\u793a\u4f8b\u61c9\u7528](https://cloud.google.com/sql/docs/mysql/connect-instance-local-computer?hl=zh-cn#configure_and_run_sample_app) \u3002\n\u60a8\u53ef\u4ee5\u76f4\u63a5\u5f9e Secret Manager \u6aa2\u7d22\u5b58\u5132\u5728 Secret \u4e2d\u7684\u5be6\u4f8b\u9023\u63a5\u540d\u7a31\u3002\u8a72\u5de5\u4f5c\u6d41\u975e\u5e38\u9748\u6d3b\uff0c\u53ef\u4ee5\u5e6b\u52a9\u60a8\u7684\u5718\u968a\u5728\u591a\u500b\u61c9\u7528\u4e4b\u9593\u5171\u4eab\u9019\u4e9b\u654f\u611f\u4fe1\u606f\uff0c\u540c\u6642\u53c8\u80fd\u5920\u5f9e\u4e00\u500b\u4f4d\u7f6e\u96c6\u4e2d\u7ba1\u7406\u9019\u4e9b\u4fe1\u606f\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u5f9e Secret Manager \u6aa2\u7d22 Secret\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528 Secret Manager \u5275\u5efa Secret](https://cloud.google.com/secret-manager/docs/create-secret?hl=zh-cn#create_and_access_a_secret_version) \u3002\n\u61c9\u7528\u9700\u8981 Secret \u4e2d\u5b58\u5132\u7684\u4fe1\u606f\u624d\u80fd\u5553\u52d5\u3002\u9019\u4e9b\u4fe1\u606f\u5305\u62ec\u8207\u7528\u4f86\u9023\u63a5\u5230\u61c9\u7528\u7684\u74b0\u5883\u8b8a\u91cf\u76f8\u95dc\u806f\u7684\u503c\u3002\u60a8\u7684\u61c9\u7528\u6703\u5728\u5553\u52d5\u6642\u8a2a\u554f Secret\uff0c\u7136\u5f8c\u4f7f\u7528 Secret \u4f86\u914d\u7f6e\u8207 Cloud SQL \u7684\u9023\u63a5\u3002\u5982\u679c Secret Manager \u4e2d\u66f4\u65b0\u4e86\u4efb\u4f55\u76f8\u95dc\u7684 Secret\uff0c\u5247\u60a8\u53ef\u80fd\u5fc5\u9808\u91cd\u5553\u61c9\u7528\u3002\n## SSL/TLS \u8b49\u66f8\n\u5982\u679c\u60a8\u4f7f\u7528\u516c\u5171\u6216\u5c08\u7528 IP \u5730\u5740\u4f86\u9023\u63a5\u5230 Cloud SQL \u5be6\u4f8b\uff0c\u5247\u61c9\u4f7f\u7528\u50b3\u8f38\u5c64\u5b89\u5168\u5354\u8b70 (TLS) \u8b49\u66f8\u4f86\u4fdd\u8b77\u6578\u64da\u5728\u50b3\u8f38\u904e\u7a0b\u4e2d\u7684\u5b89\u5168\u3002\u6bcf\u500b TLS \u8b49\u66f8\u90fd\u5305\u542b\u4e00\u500b\u516c\u9470\u8b49\u66f8\u548c\u4e00\u500b\u79c1\u9470\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u914d\u7f6e TLS \u8b49\u66f8\uff0c\u8acb\u53c3\u95b1 [\u914d\u7f6e SSL/TLS \u8b49\u66f8](https://cloud.google.com/sql/docs/postgres/configure-ssl-instance?hl=zh-cn) \u3002\n\u60a8\u53ef\u4ee5\u5c07 TLS \u8b49\u66f8\u3001\u516c\u9470\u8b49\u66f8\u548c\u79c1\u9470\u90fd\u4fdd\u5b58\u5728 Secret \u4e2d\uff0c\u4ee5\u78ba\u4fdd\u5b83\u5011\u5b89\u5168\u7121\u865e\uff0c\u4e26\u4e14\u9084\u80fd\u5920\u8207\u60a8\u7684\u5718\u968a\u5171\u4eab\u9019\u4e9b\u4fe1\u606f\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u5275\u5efa\u548c\u8a2a\u554f Secret\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528 Secret Manager \u5275\u5efa Secret](https://cloud.google.com/secret-manager/docs/create-secret?hl=zh-cn) \u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u5171\u4eab Secret\uff0c\u8acb\u53c3\u95b1 [\u8a2a\u554f\u6b0a\u9650\u63a7\u5236 (IAM)](https://cloud.google.com/secret-manager/docs/access-control?hl=zh-cn) \u3002\n## \u707d\u96e3\u6062\u5fa9\u5834\u666f\n\u5982\u679c Cloud SQL \u4e2d\u7684\u4e3b\u8981\u5be6\u4f8b\u767c\u751f\u6545\u969c\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u5c07\u4e00\u500b\u8b80\u53d6\u526f\u672c\u63d0\u5347\u7232\u4e3b\u8981\u5be6\u4f8b\u3002\u5728\u8b80\u53d6\u526f\u672c\u6210\u7232\u4e3b\u8981\u5be6\u4f8b\u5f8c\uff0c\u60a8\u5fc5\u9808\u66f4\u65b0\u5be6\u4f8b\u9023\u63a5\u540d\u7a31\u624d\u80fd\u53cd\u6620\u6b64\u63d0\u5347\u3002\u5982\u679c\u5be6\u4f8b\u9023\u63a5\u540d\u7a31\u5b58\u5132\u5728 Secret \u4e2d\uff0c\u5247\u60a8\u5fc5\u9808\u7528\u65b0\u7684\u4e3b\u8981\u5be6\u4f8b\u7684\u540d\u7a31\u66f4\u65b0 Secret\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u4fee\u6539 Secret](https://cloud.google.com/secret-manager/docs/edit-secrets?hl=zh-cn) \u3002\n\u5982\u9700\u4f7f\u7528 Secret Manager \u9032\u884c\u6545\u969c\u5207\u63db\uff0c\u4e00\u7a2e\u65b9\u6cd5\u662f\u5c07\u4e3b\u8981\u5be6\u4f8b\u7684\u540d\u7a31\u5b58\u5132\u5728 Secret \u4e2d\uff0c\u7136\u5f8c\u5c07 Cloud SQL \u9023\u63a5\u5668\u914d\u7f6e\u7232\u6bcf\u7576 Secret \u66f4\u65b0\u6642\u4fbf\u76f8\u61c9\u5730\u9032\u884c\u66f4\u65b0\u3002\n\u60a8\u53ef\u4ee5\u5c07\u4ee5\u4e0b bash \u5c01\u88dd\u5bb9\u5668\u8173\u672c\u8207 Cloud SQL Auth \u4ee3\u7406\u7d50\u5408\u4f7f\u7528\uff0c\u4ee5\u4fbf\u7cfb\u7d71\u80fd\u5920\u5728\u5be6\u4f8b\u9023\u63a5\u540d\u7a31\u7684\u503c\u66f4\u65b0\u6642\u6aa2\u6e2c\u5230\u9019\u4e00\u884c\u7232\uff0c\u7136\u5f8c\u4f7f\u7528\u65b0\u503c\u91cd\u5553\u4ee3\u7406\uff1a\n[  examples/disaster-recovery/failover.sh ](https://github.com/GoogleCloudPlatform/cloud-sql-proxy/blob/2de4d0ac9f0a51277119e2033d66b4e2fd3af39f/examples/disaster-recovery/failover.sh) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/cloud-sql-proxy/blob/2de4d0ac9f0a51277119e2033d66b4e2fd3af39f/examples/disaster-recovery/failover.sh)\n```\n#!/bin/bashSECRET_ID=\"my-secret-id\" # TODO(developer): replace this valueREFRESH_INTERVAL=5PORT=5432 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0# TODO(developer): change this port as needed# Get the latest version of the secret and start the proxyINSTANCE=$(gcloud secrets versions access \"latest\" --secret=\"$SECRET_ID\")cloud_sql_proxy -instances=\"$INSTANCE\"=tcp:\"$PORT\" &PID=$!# Every 5s, get the latest version of the secret. If it's changed, restart the# proxy with the new value.while true; do\u00a0 \u00a0 sleep $REFRESH_INTERVAL\u00a0 \u00a0 NEW=$(gcloud secrets versions access \"latest\" --secret=\"$SECRET_ID\")\u00a0 \u00a0 if [ \"$INSTANCE\" != \"$NEW\" ]; then\u00a0 \u00a0 \u00a0 \u00a0 INSTANCE=$NEW\u00a0 \u00a0 \u00a0 \u00a0 kill $PID\u00a0 \u00a0 \u00a0 \u00a0 wait $PID\u00a0 \u00a0 \u00a0 \u00a0 cloud_sql_proxy -instances=\"$INSTANCE\"=tcp:\"$PORT\" &\u00a0 \u00a0 \u00a0 \u00a0 PID=$!\u00a0 \u00a0 fidone\n```\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u5275\u5efa\u548c\u8a2a\u554f\u7528\u4f86\u5b58\u5132\u4e3b\u8981\u5be6\u4f8b\u526f\u672c\u7684\u5be6\u4f8b\u9023\u63a5\u540d\u7a31\u7684 Secret\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528 Secret Manager \u5275\u5efa Secret](https://cloud.google.com/secret-manager/docs/create-secret?hl=zh-cn) \u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u4f7f\u7528 Cloud SQL Auth \u4ee3\u7406\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528 Cloud SQL Auth \u4ee3\u7406\u9023\u63a5\u5230 Cloud SQL](https://cloud.google.com/sql/docs/postgres/connect-instance-auth-proxy?hl=zh-cn) \u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u60a8\u53ef\u4ee5\u5c07 Secret Manager \u8207\u5176\u4ed6 Google Cloud \u7522\u54c1\uff08\u5982 Cloud Run\uff09\u96c6\u6210\u3002- \u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u4fdd\u8b77\u5bb9\u5668\u74b0\u5883\u4e2d\u7684 Secret\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528 Secret](https://cloud.google.com/run/docs/configuring/secrets?hl=zh-cn) \u3002\n- \u5982\u9700\u67e5\u770b\u8207 Secret Manager \u96c6\u6210\u7684\u5176\u4ed6 Google Cloud \u7522\u54c1\u7684\u5217\u8868\uff0c\u8acb\u53c3\u95b1 [\u5c07 Secret Manager \u8207\u5176\u4ed6\u7522\u54c1\u642d\u914d\u4f7f\u7528](https://cloud.google.com/secret-manager/docs/using-other-products?hl=zh-cn) \u3002- \u5982\u9700\u77ad\u89e3\u5982\u4f55\u5c07 Secret Manager \u8207\u958b\u767c\u74b0\u5883\u96c6\u6210\uff0c\u8acb\u53c3\u95b1 [\u6240\u6709 Secret Manager \u4ee3\u78bc\u793a\u4f8b](https://cloud.google.com/secret-manager/docs/samples?hl=zh-cn) \u9801\u9762\u4e2d\u63d0\u4f9b\u7684\u5404\u7a2e\u793a\u4f8b\u3002", "guide": "Cloud SQL"}