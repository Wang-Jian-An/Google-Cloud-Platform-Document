{"title": "Cloud SQL - \u5553\u7528\u8b8a\u66f4\u6578\u64da\u6355\u7372 (CDC)", "url": "https://cloud.google.com/sql/docs/sqlserver/replication/enable-cdc?hl=zh-cn", "abstract": "# Cloud SQL - \u5553\u7528\u8b8a\u66f4\u6578\u64da\u6355\u7372 (CDC)\n\u672c\u9801\u9762\u4ecb\u7d39\u5982\u4f55\u5728 Cloud SQL for SQL Server \u4e2d\u5553\u7528 [\u8b8a\u66f4\u6578\u64da\u6355\u7372 (CDC)](https://learn.microsoft.com/en-us/sql/relational-databases/track-changes/about-change-data-capture-sql-server?view=sql-server-ver16) \u3002\u5be6\u4f8b\u7684\u6578\u64da\u5eab\u53ef\u4ee5\u4f7f\u7528\u6b64\u529f\u80fd\u3002\n\u85c9\u52a9 CDC\uff0c\u60a8\u53ef\u4ee5\u6355\u7372\u591a\u7a2e\u985e\u578b\u7684\u66f4\u6539\u3002\u5982\u9700\u77ad\u89e3\u5982\u4f55\u5553\u7528\u548c\u505c\u7528 CDC\uff0c\u8acb\u53c3\u95b1 [Microsoft \u6587\u6a94](https://learn.microsoft.com/en-us/sql/relational-databases/track-changes/enable-and-disable-change-data-capture-sql-server?view=sql-server-ver16) \u3002\n[\u9023\u63a5](https://cloud.google.com/sql/docs/sqlserver/connect-overview?hl=zh-cn) \u5be6\u4f8b\u5f8c\uff0c `sqlserver` [\u7528\u6236](https://cloud.google.com/sql/docs/sqlserver/users?hl=zh-cn) \u53ef\u4ee5\u57f7\u884c\u5f88\u591a [CDC \u64cd\u4f5c](https://docs.microsoft.com/en-us/sql/relational-databases/track-changes/enable-and-disable-change-data-capture-sql-server?view=sql-server-ver16) \u3002\n\u53e6\u8acb\u53c3\u95b1 [\u8655\u7406\u8b8a\u66f4\u6578\u64da](https://docs.microsoft.com/en-us/sql/relational-databases/track-changes/work-with-change-data-sql-server?view=sql-server-ver16) \u3002\n", "content": "## \u6e96\u5099\u5de5\u4f5c\n\u5728\u5c0d\u5be6\u4f8b\u5be6\u73fe CDC \u4e4b\u524d\uff0c\u8acb\u67e5\u770b\u672c\u9801\u9762\u4e0a\u7684\u6240\u6709\u4fe1\u606f\u3002\n### \u78ba\u8a8d\u529f\u80fd\u7684\u53ef\u7528\u6027\nCDC \u9069\u7528\u65bc\u4ee5\u4e0b Cloud SQL for SQL Server \u6578\u64da\u5eab\u7248\u672c\uff1a\n- SQL Server 2022 Standard\n- SQL Server 2022 Enterprise\n- SQL Server 2019 Standard\n- SQL Server 2019 Enterprise\n- SQL Server 2017 Standard\n- SQL Server 2017 Enterprise## \u5553\u7528 CDC \u548c\u5553\u52d5 CDC \u6355\u7372\u4f5c\u696d\n\u60a8\u7684\u6578\u64da\u5eab\u5305\u542b\u4ee5\u4e0b\u5b58\u5132\u904e\u7a0b\uff0c\u4f9b `sqlserver` \u7528\u6236\u4f7f\u7528\uff1a\n- `msdb.dbo.gcloudsql_cdc_enable_db`\n- `msdb.dbo.gcloudsql_cdc_disable_db`\n### \u958b\u5553 CDC\n\u8981\u7232\u6578\u64da\u5eab\u958b\u5553\u6b64\u529f\u80fd\uff0c\u8acb\u57f7\u884c\u5fc5\u8981\u7684\u5b58\u5132\u904e\u7a0b\u4e26\u50b3\u905e\u6578\u64da\u5eab\u540d\u7a31\u3002\u4f8b\u5982\uff1a\n```\nEXEC msdb.dbo.gcloudsql_cdc_enable_db 'DATABASE_NAME'\n```\n### \u95dc\u9589 CDC\n\u8981\u7232\u6578\u64da\u5eab\u95dc\u9589\u6b64\u529f\u80fd\uff0c\u8acb\u904b\u884c\u5982\u4e0b\u547d\u4ee4\uff1a\n```\nEXEC msdb.dbo.gcloudsql_cdc_disable_db 'DATABASE_NAME'\n```\n### \u958b\u59cb CDC \u6355\u7372\u4f5c\u696d\n\u5553\u7528 CDC \u5f8c\uff0c\u7cfb\u7d71\u6703\u5275\u5efa\u7528\u65bc\u6355\u7372\u548c\u6e05\u7406\u7684\u4f5c\u696d\u3002\u9019\u4e9b\u4f5c\u696d\u5c0d SQL Server Management Studio (SSMS) \u4e2d\u7684 `sqlserver` \u7528\u6236\u4e0d\u53ef\u898b\u3002\u4f46\u662f\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u5167\u7f6e\u7684\u5b58\u5132\u7a0b\u5e8f\u4fee\u6539\u4f5c\u696d\u3002\u6b64\u5916\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u4ee5\u4e0b\u5b58\u5132\u904e\u7a0b\u67e5\u770b\u4f5c\u696d\uff1a\n- ` [sys.sp_cdc_help_jobs](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sys-sp-cdc-help-jobs-transact-sql?view=sql-server-ver16) `\n\u5982\u9700\u5553\u52d5\u6e05\u7406\u4f5c\u696d\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\nEXEC sys.sp_cdc_start_job @job_type = N'cleanup'\n```\n\u5982\u9700\u66f4\u6539\u4f5c\u696d\u53c3\u6578\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u985e\u4f3c\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\uff0c\u4f8b\u5982\uff1a\n```\nEXEC sys.sp_cdc_change_job \u00a0@job_type = N'capture',\u00a0 \u00a0 \u00a0 \u00a0 @maxtrans = 20,\u00a0 \u00a0 \u00a0 \u00a0 @pollinginterval = NULL,\u00a0 \u00a0 \u00a0 \u00a0 @maxscans = NULL,\u00a0 \u00a0 \u00a0 \u00a0 @continuous = NULL\n```\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u5553\u52d5\u548c\u66f4\u6539\u4f5c\u696d\uff0c\u8acb\u53c3\u95b1\u4ee5\u4e0b\u5167\u5bb9\uff1a\n- ` [sys.sp_cdc_start_job](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sys-sp-cdc-start-job-transact-sql?view=sql-server-ver16) `\n- ` [sys.sp_cdc_change_job](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sys-sp-cdc-change-job-transact-sql?view=sql-server-ver16) `\n\u53e6\u8acb\u53c3\u95b1 ` [sys.sp_cdc_add_job](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sys-sp-cdc-add-job-transact-sql?view=sql-server-ver16) ` \uff1a\n## \u7232\u8868\u5553\u7528 CDC\n\u7232\u6578\u64da\u5eab [\u5553\u7528 CDC](#turning-cdc-on) \u5f8c\uff0c\u4efb\u4f55\u5177\u6709 dbo\uff08\u6578\u64da\u5eab\u6240\u6709\u8005\uff09\u8a2a\u554f\u6b0a\u9650\u7684\u7528\u6236\u90fd\u53ef\u4ee5\u7232\u6578\u64da\u5eab\u4e2d\u7684\u8868\u8a2d\u7f6e\u8ddf\u8e64\u3002\n\u5982\u9700\u77ad\u89e3\u6a19\u6e96 CDC \u547d\u4ee4\u548c\u9078\u9805\uff0c\u8acb\u53c3\u95b1 [\u5553\u7528\u548c\u505c\u7528\u66f4\u6539\u6578\u64da\u6355\u7372](https://docs.microsoft.com/en-us/sql/relational-databases/track-changes/enable-and-disable-change-data-capture-sql-server?view=sql-server-ver16) \u3002\n### \u8ddf\u8e64\u8868\u683c\u4e2d\u7684\u66f4\u6539\n\u5982\u9700\u8ddf\u8e64\u8868\uff0c\u8acb\u4f7f\u7528 `sys.sp_cdc_enable_table` \u5b58\u5132\u904e\u7a0b\u3002\n\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u6307\u5b9a\u985e\u4f3c\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\uff1a\n```\nEXEC sys.sp_cdc_enable_table\u00a0 @source_schema = N'dbo',\u00a0 @source_name = N'customer',\u00a0 @role_name = N'CDC'\n```\n### \u6aa2\u67e5\u8868\u683c\u662f\u5426\u5df2\u5553\u7528 CDC\n\u5982\u9700\u6aa2\u67e5\u8868\u662f\u5426\u5553\u7528\u4e86 CDC\uff0c\u8acb\u4f7f\u7528 `sys.sp_cdc_help_change_data_capture` \u5b58\u5132\u904e\u7a0b\u3002\n\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u6307\u5b9a\u985e\u4f3c\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\uff1a\n```\nEXECUTE sys.sp_cdc_help_change_data_capture\u00a0 @source_schema = N'dbo',\u00a0 @source_name = N'customer'\n```\n### \u901a\u904e CDC \u66f4\u6539\u8868\u67e5\u8a62\u66f4\u6539\n\u5982\u9700\u67e5\u770b\u9336\u4e0a\u7684 CDC \u66f4\u6539\uff0c\u8acb\u91dd\u5c0d\u8a72\u8868\u5553\u7528 CDC \u6642\uff0c\u8a72\u8868\u81ea\u52d5\u5275\u5efa\u7684 `SELECT` \u67e5\u8a62\u3002\n\u8868\u7684\u540d\u7a31\u5982\u4e0b\uff1a\n```\n<schema>_<table_name>_CT\n```\n\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u6307\u5b9a\u985e\u4f3c\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\uff1a\n```\nSELECT * FROM cdc.dbo_customer_CT\n```\n### \u5728\u5177\u6709\u6307\u5b9a\u6355\u7372\u5be6\u4f8b\u7684\u8868\u4e0a\u5553\u7528 CDC\n\u5982\u9700\u4f7f\u7528\u201c\u6355\u7372\u5be6\u4f8b\u201d\u8ddf\u8e64\u8868\uff0c\u8acb\u4f7f\u7528 `sys.sp_cdc_enable_table` \u5b58\u5132\u904e\u7a0b\u3002\n\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u6307\u5b9a\u985e\u4f3c\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\uff1a\n```\nEXEC sys.sp_cdc_enable_table\u00a0 \u00a0 @source_schema = N'dbo',\u00a0 \u00a0 @source_name = N'customer',\u00a0 \u00a0 @role_name = N'CDC',\u00a0 \u00a0 @capture_instance = N'customer_cdc',\u00a0 \u00a0 @supports_net_changes = 1\n```\n### \u67e5\u8a62\u6355\u7372\u5be6\u4f8b\u4e2d\u7684\u6240\u6709\u66f4\u6539\n\u5982\u9700\u67e5\u770b\u201c\u6355\u7372\u5be6\u4f8b\u201d\u4e2d\u67d0\u4e00\u8868\u7684 CDC \u66f4\u6539\uff0c\u8acb\u4f7f\u7528 `cdc.fn_cdc_get_all_changes_<capture_instance>` \u5b58\u5132\u904e\u7a0b\u3002\n\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u6307\u5b9a\u985e\u4f3c\u4ee5\u4e0b\u7684 SQL \u8a9e\u53e5\uff1a\n```\nDECLARE @from_lsn binary(10), @to_lsn binary(10)SET @from_lsn = sys.fn_cdc_get_min_lsn(N'customer_cdc')SET @to_lsn = sys.fn_cdc_get_max_lsn()SELECT * FROM cdc.fn_cdc_get_all_changes_customer_cdc(@from_lsn, @to_lsn, N'all');\n```\n## \u7232\u9336\u505c\u7528 CDC\n\u5982\u9700\u7232\u9336\u505c\u7528 CDC \u8ddf\u8e64\uff0c\u8acb\u4f7f\u7528 `sys.sp_cdc_disable_table` \u5b58\u5132\u904e\u7a0b\u3002\u6307\u5b9a\u6355\u7372\u5be6\u4f8b\u4ee5\u5c07\u5176\u505c\u7528\u3002\u6216\u8005\uff0c\u5c07\u62cd\u651d\u5be6\u4f8b\u6307\u5b9a\u7232 `'all'` \u3002\n\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u6307\u5b9a\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\u4f86\u7232\u9336\u505c\u7528 CDC\uff1a\n```\nEXEC sys.sp_cdc_disable_table\u00a0 @source_schema = N'dbo',\u00a0 @source_name = N'customer',\u00a0 @capture_instance = N'all'\n```\n## \u522a\u9664\u5553\u7528\u4e86 CDC \u7684\u6578\u64da\u5eab\n\u5982\u679c\u7232\u6578\u64da\u5eab\u5553\u7528\u4e86 CDC \u4e26\u5617\u8a66\u522a\u9664\u5b83\uff0c\u5247\u53ef\u80fd\u6703\u9047\u5230\u932f\u8aa4\u3002\u5982\u679c\u767c\u751f\u9019\u7a2e\u60c5\u6cc1\uff0c\u8acb\u7232\u6578\u64da\u5eab\u505c\u7528 CDC\uff0c\u7136\u5f8c\u518d\u522a\u9664\u6578\u64da\u5eab\u3002\n\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u6307\u5b9a\u8207\u4ee5\u4e0b\u5167\u5bb9\u985e\u4f3c\u7684\u547d\u4ee4\u4f86\u505c\u7528\u548c\u522a\u9664\u6578\u64da\u5eab\uff1a\n```\nEXEC msdb.dbo.gcloudsql_cdc_disable_db 'DATABASE_NAME'DROP DATABASE 'DATABASE_NAME'\n```\n\u5982\u679c\u7531\u65bc\u6578\u64da\u5eab\u5177\u6709\u6253\u958b\u7684\u9023\u63a5\u800c\u7121\u6cd5\u522a\u9664\u6578\u64da\u5eab\uff0c\u8acb\u4f7f\u7528\u4ee5\u4e0b\u67e5\u8a62\u67e5\u770b\u9019\u4e9b\u9023\u63a5\uff1a\n```\nselect db_name(dbid),* from sys.sysprocesses where db_name(dbid)= 'DATABASE_NAME'\n```\n\u95dc\u9589\u6240\u6709\u6253\u958b\u7684\u9023\u63a5\u3002\u505c\u7528\u6578\u64da\u5eab\u7684 CDC\uff0c\u7136\u5f8c\u522a\u9664\u6578\u64da\u5eab\u3002\n## \u5c0e\u5165\u652f\u6301 CDC \u7684\u6578\u64da\u5eab\n\u5c0e\u5165\u652f\u6301 CDC \u7684\u6578\u64da\u5eab\u6642\uff0cCloud SQL for SQL Server \u6703\u4fdd\u6301 [KEEP_CDC](https://docs.microsoft.com/en-us/sql/t-sql/statements/restore-statements-arguments-transact-sql?view=sql-server-ver15#change_data_capture_with_option) \u6a19\u8a8c\u7684\u5553\u7528\u72c0\u614b\uff0c\u4e26\u4f7f\u7528\u9ed8\u8a8d\u53c3\u6578\u81ea\u52d5\u5275\u5efa\u6355\u7372\u548c\u6e05\u7406\u4f5c\u696d\u3002", "guide": "Cloud SQL"}