{"title": "Cloud SQL - \u67e5\u627e\u4e26\u4fee\u5fa9\u4e0d\u4e00\u81f4\u7684 B \u6a39\u7d22\u5f15", "url": "https://cloud.google.com/sql/docs/postgres/find-fix-inconsistent-indexes?hl=zh-cn", "abstract": "# Cloud SQL - \u67e5\u627e\u4e26\u4fee\u5fa9\u4e0d\u4e00\u81f4\u7684 B \u6a39\u7d22\u5f15\n\u6578\u64da\u5eab\u7d22\u5f15\u4e2d\u51fa\u73fe\u4e0d\u4e00\u81f4\u7684\u539f\u56e0\u6709\u5f88\u591a\uff0c\u5305\u62ec\u8edf\u4ef6\u7f3a\u9677\u3001\u786c\u4ef6\u554f\u984c\u6216\u5e95\u5c64\u884c\u7232\u8b8a\u5316\uff08\u4f8b\u5982\u6392\u5217\u9806\u5e8f\u66f4\u6539\uff09\u3002\nPostgreSQL \u793e\u5340\u69cb\u5efa\u4e86\u8b58\u5225\u548c\u89e3\u6c7a\u6b64\u985e\u554f\u984c\u7684\u5de5\u5177\uff0c\u5176\u4e2d\u5305\u62ec PostgreSQL \u793e\u5340\u63a8\u85a6\u7684 [amcheck](https://www.postgresql.org/docs/current/amcheck.html) \u7b49\u5de5\u5177\uff0c\u7528\u65bc\u8b58\u5225\u4e00\u81f4\u6027\u554f\u984c\uff0c\u5305\u62ec\u65e9\u671f\u7248\u672c\u7684 [PostgreSQL 14](https://www.migops.com/blog/important-postgresql-14-update-to-avoid-silent-corruption-of-indexes/#:%7E:text=The%20cause%20of%20the%20silent,in%20a%20silently%20corrupted%20state.) \u51fa\u73fe\u7684\u554f\u984c\u3002\n\u6211\u5011\u7de8\u5beb\u4e86\u6b64 playbook\uff0c\u4ee5\u4f9b\u9047\u5230\u6b64\u985e\u554f\u984c\u7684 Cloud SQL for PostgreSQL \u7528\u6236\u53c3\u8003\u3002\u6211\u5011\u5e0c\u671b\u672c\u9801\u9762\u63d0\u4f9b\u7684\u4fe1\u606f\u4e5f\u6709\u52a9\u65bc\u5176\u4ed6 PostgreSQL \u7528\u6236\u8b58\u5225\u548c\u4fee\u5fa9\u4e0d\u4e00\u81f4\u7684 B \u6a39\u7d22\u5f15\u3002\u6211\u5011\u7684\u76ee\u6a19\u662f\u4e0d\u65b7\u6539\u9032\u672c\u6587\u6a94\uff0c\u4f7f\u5176\u4f5c\u7232\u66f4\u5ee3\u6cdb\u958b\u6e90\u793e\u5340\u7684\u8cc7\u6e90\u3002\u5982\u679c\u60a8\u6709\u4efb\u4f55\u53cd\u994b\uff0c\u8acb\u4f7f\u7528\u672c\u9801\u9762\u9802\u90e8\u548c\u5e95\u90e8\u7684\u201c\u767c\u9001\u53cd\u994b\u201d\u6309\u9215\u3002\n\u89e3\u6c7a\u7d22\u5f15\u4e0d\u4e00\u81f4\u7684\u554f\u984c\u6d89\u53ca\u4ee5\u4e0b\u6b65\u9a5f\uff1a\n- [\u6e96\u5099\u5de5\u4f5c](#before) \u3002\u5728\u958b\u59cb\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u4e4b\u524d\uff0c\u60a8\u61c9\u8a72\u5099\u4efd\u6578\u64da\u5eab\u3001\u8a2d\u7f6e\u6b63\u78ba\u7684\u6b0a\u9650\u3001\u9a57\u8b49 `psql` \u5ba2\u6236\u7aef\u7248\u672c\uff0c\u4e26\u4e0b\u8f09 `amcheck` \u64f4\u5c55\u7a0b\u5e8f\u3002\n- [\u6aa2\u67e5\u662f\u5426\u5b58\u5728\u4e0d\u4e00\u81f4\u7684 B \u6a39\u7d22\u5f15](#check-index) \u3002\u5982\u9700\u78ba\u5b9a\u9700\u8981\u4fee\u5fa9\u4e0d\u4e00\u81f4\u554f\u984c\u7684\u7d22\u5f15\uff0c\u60a8\u9700\u8981\u78ba\u5b9a\u5177\u6709\u4e0d\u4e00\u81f4\u554f\u984c\u7684\u6240\u6709 B \u6a39\u7d22\u5f15\uff0c\u4e26\u78ba\u5b9a\u6240\u6709\u552f\u4e00\u9375\u548c\u4e3b\u9375\u9055\u898f\u884c\u7232\u3002\n- [\u89e3\u6c7a\u7d22\u5f15\u7684\u4e0d\u4e00\u81f4\u554f\u984c](#fix-indexes) \u3002\u5c07\u7d22\u5f15\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u53ef\u4fee\u5fa9\u5176\u6240\u6709\u4e0d\u4e00\u81f4\u554f\u984c\u3002\u60a8\u53ef\u80fd\u9700\u8981\u8abf\u6574\u5be6\u4f8b\u7684\u5167\u5b58\u8a2d\u7f6e\u4ee5\u63d0\u9ad8\u6027\u80fd\u3002\n- [\u76e3\u63a7\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u64cd\u4f5c](#monitor) \u3002\u6211\u5011\u5efa\u8b70\u60a8\u76e3\u63a7\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u64cd\u4f5c\u7684\u9032\u5ea6\uff0c\u4ee5\u78ba\u4fdd\u64cd\u4f5c\u6b63\u5728\u9032\u884c\u4e14\u4e0d\u6703\u88ab\u963b\u6b62\u3002\n- [\u9a57\u8b49\u7d22\u5f15\u4e00\u81f4](#verify) \u3002\u6210\u529f\u5c07\u7d22\u5f15\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u5f8c\uff0c\u5efa\u8b70\u60a8\u9a57\u8b49\u7d22\u5f15\u4e0d\u5305\u542b\u4efb\u4f55\u4e0d\u4e00\u81f4\u3002", "content": "## \u6e96\u5099\u5de5\u4f5c\n### \u5099\u4efd\u6578\u64da\u5eab\n\u7232\u4e86\u78ba\u4fdd\u5728\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u671f\u9593\u4e0d\u4e1f\u5931\u4efb\u4f55\u6578\u64da\uff0c\u6211\u5011\u5efa\u8b70\u60a8\u5099\u4efd\u6578\u64da\u5eab\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5275\u5efa\u6309\u9700\u5099\u4efd](https://cloud.google.com/sql/docs/mysql/backup-recovery/backing-up?hl=zh-cn#on-demand) \u3002\n**\u6ce8\u610f** \uff1a\u5728\u5df2\u7d93\u5b58\u5728\u7d22\u5f15\u4e0d\u4e00\u81f4\u7684\u6578\u64da\u5eab\u4e0a\u9032\u884c\u7684\u5099\u4efd\u5728\u6062\u5fa9\u6642\u4ecd\u6703\u51fa\u73fe\u4e0d\u4e00\u81f4\u73fe\u8c61\u3002\n### \u8a2d\u7f6e cloudsqlsuperuser \u6b0a\u9650\n\u7232\u5b8c\u6210\u672c\u9801\u9762\u4e2d\u7684\u6b65\u9a5f\uff0c\u60a8\u5fc5\u9808\u64c1\u6709 `cloudsqlsuperuser` \u6b0a\u9650\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [session_replication_role](https://cloud.google.com/sql/docs/postgres/flags?hl=zh-cn) \u3002\n### \u78ba\u4fdd psql \u5ba2\u6236\u7aef\u7248\u672c\u7232 9.6 \u6216\u66f4\u9ad8\u7248\u672c\n\u5982\u9700\u5b8c\u6210\u672c\u9801\u9762\u4e2d\u7684\u6b65\u9a5f\uff0c\u60a8\u5fc5\u9808\u78ba\u4fdd `psql` \u5ba2\u6236\u7aef\u7248\u672c\u7232 9.6 \u6216\u66f4\u9ad8\u7248\u672c\u3002\u904b\u884c `psql --version` \u547d\u4ee4\u4ee5\u9a57\u8b49\u7576\u524d\u7684 `psql` \u5ba2\u6236\u7aef\u7248\u672c\u3002\n### \u5b89\u88dd Amcheck \u64f4\u5c55\u7a0b\u5e8f\n\u5982\u9700\u6aa2\u67e5\u7d22\u5f15\u4e0d\u4e00\u81f4\uff0c\u60a8\u5fc5\u9808\u5553\u7528 `amcheck` \u64f4\u5c55\u7a0b\u5e8f\u3002\n**\u6ce8\u610f** \uff1a\u5728\u5b89\u88dd`amcheck_next`\u4e4b\u524d\uff0c\u60a8\u5fc5\u9808\u78ba\u4fdd\u5df2\u5b89\u88dd POSTGRES_9_6_24.R20220710.01_12\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u5b89\u88dd\u65b0\u7684\u76ee\u6a19\u7dad\u8b77\u7248\u672c\uff0c\u8acb\u53c3\u95b1 [\u81ea\u52a9\u7dad\u8b77](https://cloud.google.com/sql/docs/postgres/self-service-maintenance?hl=zh-cn) \u3002\n\u5982\u9700\u7232 PostgreSQL 9.6 \u5b89\u88dd `amcheck` \uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u8a9e\u53e5\uff1a\n```\n\u00a0 CREATE EXTENSION amcheck_next;\u00a0 \n```\n\u5982\u679c\u60a8\u6536\u5230\u201c\u7121\u6cd5\u6253\u958b\u64f4\u5c55\u7a0b\u5e8f\u63a7\u5236\u6587\u4ef6...\u201d\u932f\u8aa4\uff0c\u8acb\u78ba\u8a8d\u60a8\u904b\u884c\u7684\u662f\u6b63\u78ba\u7684\u76ee\u6a19\u7dad\u8b77\u7248\u672c (POSTGRES_9_6_24.R20220710.01_12)\u3002\u5982\u9700\u7232 PostgreSQL 10 \u53ca\u66f4\u9ad8\u7248\u672c\u5b89\u88dd `amcheck` \uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u8a9e\u53e5\uff1a\n```\n\u00a0 CREATE EXTENSION amcheck;\u00a0 \n```\n## \u6aa2\u67e5\u662f\u5426\u5b58\u5728\u4e0d\u4e00\u81f4\u7684 B \u6a39\u7d22\u5f15\n\u4ee5\u4e0b\u90e8\u5206\u4ecb\u7d39\u77ad\u5982\u4f55\u901a\u904e\u6aa2\u67e5\u7d22\u5f15\u4e0d\u4e00\u81f4\u4ee5\u53ca\u552f\u4e00\u548c\u4e3b\u9375\u9055\u898f\u4f86\u6aa2\u67e5\u662f\u5426\u5b58\u5728\u4e0d\u4e00\u81f4\u7684 B \u6a39\u7d22\u5f15\u3002\n### \u6aa2\u67e5\u662f\u5426\u5b58\u5728\u4e0d\u4e00\u81f4\u7684\u73fe\u8c61\n\u904b\u884c\u4ee5\u4e0b\u8a9e\u53e5\u4ee5\u6aa2\u67e5\u6bcf\u500b\u6578\u64da\u5eab\u7684\u6240\u6709 B \u6a39\u7d22\u5f15\u4e2d\u7684\u4e0d\u4e00\u81f4\uff1a\n```\n\u00a0 DO $$\u00a0 DECLARE\u00a0 \u00a0 r RECORD;\u00a0 \u00a0 version varchar(100);\u00a0 BEGIN\u00a0 \u00a0 RAISE NOTICE 'Started amcheck on database: %', current_database();\u00a0 \u00a0 SHOW server_version into version;\u00a0 \u00a0 SELECT split_part(version, '.', 1) into version;\u00a0 \u00a0 FOR r IN\u00a0 \u00a0 \u00a0 SELECT c.oid, c.oid::regclass relname, i.indisunique\u00a0 \u00a0 \u00a0 \u00a0 FROM pg_index i\u00a0 \u00a0 \u00a0 \u00a0 JOIN pg_opclass op ON i.indclass[0] = op.oid\u00a0 \u00a0 \u00a0 \u00a0 JOIN pg_am am ON op.opcmethod = am.oid\u00a0 \u00a0 \u00a0 \u00a0 JOIN pg_class c ON i.indexrelid = c.oid\u00a0 \u00a0 \u00a0 \u00a0 JOIN pg_namespace n ON c.relnamespace = n.oid\u00a0 \u00a0 \u00a0 WHERE am.amname = 'btree'\u00a0 \u00a0 \u00a0 \u00a0 AND c.relpersistence != 't'\u00a0 \u00a0 \u00a0 \u00a0 AND c.relkind = 'i'\u00a0 \u00a0 \u00a0 \u00a0 AND i.indisready AND i.indisvalid LOOP\u00a0 \u00a0 \u00a0 BEGIN\u00a0 \u00a0 \u00a0 \u00a0 RAISE NOTICE 'Checking index %:', r.relname;\u00a0 \u00a0 \u00a0 \u00a0 IF version = '10' THEN\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 PERFORM bt_index_check(index => r.oid);\u00a0 \u00a0 \u00a0 \u00a0 ELSE\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 PERFORM bt_index_check(index => r.oid, heapallindexed => r.indisunique);\u00a0 \u00a0 \u00a0 \u00a0 END IF;\u00a0 \u00a0 \u00a0 EXCEPTION\u00a0 \u00a0 \u00a0 \u00a0 WHEN undefined_function THEN\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 RAISE EXCEPTION 'Failed to find the amcheck extension';\u00a0 \u00a0 \u00a0 \u00a0 WHEN OTHERS THEN\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 RAISE LOG 'Failed to check index %: %', r.relname, sqlerrm;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 RAISE WARNING 'Failed to check index %: %', r.relname, sqlerrm;\u00a0 \u00a0 \u00a0 END;\u00a0 \u00a0 END LOOP;\u00a0 \u00a0 RAISE NOTICE 'Finished amcheck on database: %', current_database();\u00a0 END $$;\u00a0 \n```\n\u60a8\u61c9\u8a72\u6703\u6536\u5230\u985e\u4f3c\u5982\u4e0b\u6240\u793a\u7684\u8f38\u51fa\uff1a\n```\n\u00a0 NOTICE: \u00a0Checking index t_pkey:\u00a0 NOTICE: \u00a0Checking index t_i_key:\u00a0 WARNING: \u00a0Failed to check index t_i_key: item order invariant violated for index \"t_i_key\"\u00a0 NOTICE: \u00a0Checking index t_j_key:\u00a0 WARNING: \u00a0Failed to check index t_j_key: item order invariant violated for index \"t_j_key\"\u00a0 NOTICE: \u00a0Checking index ij:\u00a0 WARNING: \u00a0Failed to check index ij: item order invariant violated for index \"ij\"\u00a0 \n```\n**\u8b66\u544a** \uff1a\u5982\u679c\u60a8\u7684\u8f38\u51fa\u4e0d\u5305\u542b\u8b66\u544a\u901a\u77e5\uff0c\u5247\u53ef\u80fd\u5b58\u5728\u552f\u4e00\u9055\u898f\u884c\u7232\u6216\u5bc6\u9470\u9055\u898f\u3002\u5982\u9700\u6aa2\u67e5\u662f\u5426\u5b58\u5728\u9055\u898f\u884c\u7232\uff0c\u8acb\u57f7\u884c\u201c\u8b58\u5225\u4e26\u4fee\u5fa9\u552f\u4e00\u548c\u4e3b\u9375\u9055\u898f\u201d\u4e2d\u7684\u6b65\u9a5f\u3002\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u67e5\u770b PostgreSQL \u65e5\u8a8c\uff0c\u8acb\u53c3\u95b1 [\u67e5\u770b\u5be6\u4f8b\u65e5\u8a8c](https://cloud.google.com/sql/docs/postgres/logging?hl=zh-cn) \u3002\n### \u8b58\u5225\u4e26\u7cfe\u6b63\u552f\u4e00\u548c\u4e3b\u9375\u9055\u898f\u884c\u7232\n\u672c\u90e8\u5206\u4ecb\u7d39\u5982\u4f55\u6aa2\u67e5\u7d22\u5f15\u662f\u5426\u5b58\u5728\u552f\u4e00\u548c\u4e3b\u9375\u9055\u898f\uff0c\u4ee5\u53ca\u5982\u4f55\u4fee\u5fa9\u5b83\u5011\uff08\u5982\u679c\u5b58\u5728\u9055\u898f\uff09\u3002\n\u5728\u5c07\u7d22\u5f15\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u4e4b\u524d\uff0c\u5fc5\u9808\u5148 [\u4fee\u5fa9](#unique-key) \u552f\u4e00\u9375\u9055\u898f\u884c\u7232\u3002\u5982\u9700\u6aa2\u67e5\u6240\u6709\u552f\u4e00\u9375\u9055\u898f\u884c\u7232\uff0c\u8acb\u5728\u6bcf\u500b\u6578\u64da\u5eab\u4e2d\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\n\u00a0 WITH q AS (\u00a0 \u00a0 \u00a0 /* this gets info for all UNIQUE indexes */\u00a0 \u00a0 \u00a0 SELECT indexrelid::regclass as idxname,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 indrelid::regclass as tblname,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 indcollation,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 pg_get_indexdef(indexrelid),\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 format('(%s)',(select string_agg(quote_ident(attname), ', ')\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 from pg_attribute a\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 join unnest(indkey) ia(nr) on ia.nr = a.attnum\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 where attrelid = indrelid)) as idxfields,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 COALESCE(substring(pg_get_indexdef(indexrelid) FROM '[)] (WHERE .*)$'), '') as whereclause\u00a0 \u00a0 \u00a0 \u00a0 FROM pg_index\u00a0 \u00a0 \u00a0 WHERE indisunique\u00a0 \u00a0 \u00a0 /* next line excludes indexes not affected by collation changes */\u00a0 \u00a0 \u00a0 \u00a0 AND trim(replace(indcollation::text, '0', '')) != ''\u00a0 )\u00a0 SELECT\u00a0 /* the format constructs the query to execute for each index */\u00a0 format(\u00a0 $sql$\u00a0 DO $$ BEGIN RAISE NOTICE 'checking index=%3$I \u00a0 \u00a0on \u00a0 table=%1$I \u00a0 \u00a0 \u00a0key_columns=%2$I '; END;$$;\u00a0 SELECT this,\u00a0 \u00a0 \u00a0 \u00a0 prev,\u00a0 \u00a0 \u00a0 \u00a0 /* we detect both reversed ordering or just not unique */\u00a0 \u00a0 \u00a0 \u00a0 (CASE WHEN this = prev THEN 'DUPLICATE' ELSE 'BACKWARDS' END) as violation_type\u00a0 \u00a0 FROM (SELECT %2$s AS this,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 lag(%2$s) OVER (ORDER BY %2$s) AS prev\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 FROM %1$s %4$s\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ) s\u00a0 WHERE this <= prev and this IS NOT NULL and prev IS NOT NULL; /* change to just '<' if looking for reverse order in index */\u00a0 $sql$, tblname, idxfields, idxname, whereclause\u00a0 )\u00a0 \u00a0 FROM q\u00a0 -- LIMIT 20 /* may use limit for testing */\u00a0 -- the next line tells psql to executes this query and then execute each returned line separately\u00a0 \\gexec\u00a0 \n```\n\u6b64\u8173\u672c\u7684\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a\n```\n\u00a0 NOTICE: \u00a0checking index=users_email_key on table=users key_columns=\"(email)\"\u00a0 NOTICE: \u00a0checking index=games_title_key on table=games \u00a0key_columns=\"(title)\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 this \u00a0 \u00a0 \u00a0 \u00a0| \u00a0 \u00a0 \u00a0 \u00a0prev \u00a0 \u00a0 \u00a0 \u00a0| violation_type\u00a0 --------------------+--------------------+----------------\u00a0 Game #16 $soccer 2 \u00a0| Game #16 $soccer 2 | DUPLICATE\u00a0 Game #18 $soccer 2 \u00a0| Game #18 $soccer 2 | DUPLICATE\u00a0 Game #2 $soccer 2 \u00a0 | Game #2 $soccer 2 \u00a0| DUPLICATE\u00a0 Game #5 $soccer 2 \u00a0 | Game #5 $soccer 2 \u00a0| DUPLICATE\u00a0 \n```\n\u5728\u6b64\u8f38\u51fa\u4e2d\uff0c\u8868\u6a19\u982d `NOTICE` \u986f\u793a\u5176\u4e0b\u65b9\u986f\u793a\u7684\u503c\u7684\u7d22\u5f15\u3001\u5217\u548c\u8868\u3002\u5982\u679c\u8f38\u51fa\u5305\u542b\u986f\u793a `DUPLICATE` \u6216 `BACKWARDS` \u7684\u884c\uff0c\u5247\u8868\u793a\u7d22\u5f15\u4e2d\u5b58\u5728\u640d\u58de\u73fe\u8c61\uff0c\u53ef\u80fd\u9700\u8981\u4fee\u5fa9\u3002\u5177\u6709 `BACKWARDS` \u7684\u884c\u8868\u793a\u53ef\u80fd\u96b1\u85cf\u7684\u91cd\u8907\u503c\u3002\u5982\u679c\u60a8\u5728\u8868\u4e2d\u770b\u5230\u4efb\u4e00\u689d\u76ee\uff0c\u8acb\u53c3\u95b1 [\u7cfe\u6b63\u91cd\u8907\u7684\u9375\u9055\u898f\u884c\u7232](#unique-key) \u3002\n\u5982\u679c\u60a8\u5df2\u78ba\u5b9a\u91cd\u8907\u7684\u552f\u4e00\u7d22\u5f15\uff0c\u6216\u8005\u7531\u65bc\u91cd\u8907\u9375\u9055\u898f\u932f\u8aa4\u5c0e\u81f4\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u64cd\u4f5c\u5931\u6557\uff0c\u8acb\u5b8c\u6210\u4ee5\u4e0b\u6b65\u9a5f\u4ee5\u67e5\u627e\u4e26\u79fb\u9664\u91cd\u8907\u7684\u9375\u3002\n**\u6ce8\u610f** \uff1a\u60a8\u9700\u8981\u5c0d\u5b58\u5728\u9375\u9055\u898f\u7684\u6bcf\u500b\u7d22\u5f15\u91cd\u8907\u57f7\u884c\u4ee5\u4e0b\u6b65\u9a5f\u3002\n- \u5f9e `NOTICE` \u8868\u6a19\u982d\u4e2d\u63d0\u53d6 `key_columns` \uff0c\u5982\u524d\u9762\u7684\u793a\u4f8b\u8f38\u51fa\u6240\u793a\u3002\u5728\u4ee5\u4e0b\u793a\u4f8b\u4e2d\uff0c\u9375\u5217\u7232 `email` \u3002\n```\n\u00a0 NOTICE: \u00a0checking index=users_email_key on table=users key_columns=\"(email)\"\n```\n\u5728\u7b2c 3 \u6b65\u7684\u67e5\u8a62\u7684 \u4e2d\u4f7f\u7528\u9019\u4e9b\u503c\u3002\n- \u67e5\u627e\u8868\u7684\u67b6\u69cb\u3002\u4f7f\u7528 `psql` \u9023\u63a5\u5230\u60a8\u7684\u6578\u64da\u5eab\u4e26\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\n\\dt TABLE_NAME\n```\n`schema`\n\u5217\u4e2d\u7684\u503c\u662f\u60a8\u5728\u7b2c 3 \u6b65\u7684\u67e5\u8a62\u4e2d\u7528\u65bc\n\u7684\u503c\u3002\n\u4f8b\u5982\uff0c\u5c0d\u65bc\u4ee5\u4e0b\u67e5\u8a62\uff1a\n```\n\u00a0\\dt games\u00a0\n```\n\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a\n```\n\u00a0List of relations\u00a0Schema \u00a0| Name \u00a0| Type \u00a0| Owner\u00a0--------+-------+-------+----------\u00a0public \u00a0| games | table | postgres\u00a0(1 row)\u00a0\n```\n- \u904b\u884c\u4ee5\u4e0b\u8a9e\u53e5\u4ee5\u5f37\u5236\u57f7\u884c\u5168\u8868\u6383\u63cf\u4e26\u7372\u53d6\u91cd\u8907\u9375\u3002\n```\nSET enable_indexscan = off;SET enable_bitmapscan = off;SET enable_indexonlyscan = off;SELECT KEY_COLUMNS, count(*)\u00a0 FROM SCHEMA_NAME.TABLE_NAMEGROUP BY KEY_COLUMNSHAVING count(*) > 1;\n```\n **\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u7684\u6578\u64da\u5eab\u8f03\u5927\uff0c\u5247\u6b64\u8a9e\u53e5\u53ef\u80fd\u9700\u8981\u5f88\u9577\u6642\u9593\u624d\u80fd\u5b8c\u6210\u3002\u5728\u4e0a\u8ff0\u8a9e\u53e5\u4e2d\uff0c \u662f\u60a8\u6b63\u5728\u6aa2\u67e5\u7684\u8868\u4e2d\u7684\u552f\u4e00\u7d22\u5f15\u6216\u4e3b\u9375\u6240\u6db5\u84cb\u7684\u4e00\u500b\u6216\u591a\u500b\u5217\u3002\u9019\u4e9b\u5217\u662f\u5728\u60a8\u6aa2\u67e5\u552f\u4e00\u9375\u9055\u898f\u884c\u7232\u6642\u8b58\u5225\u7684\u3002\u8a72\u8a9e\u53e5\u6703\u8fd4\u56de\u91cd\u8907\u9375\u4ee5\u53ca\u6bcf\u500b\u9375\u7684\u91cd\u8907\u8a08\u6578\u3002\u4f8b\u5982\uff0c\u5c0d\u65bc\u4ee5\u4e0b\u67e5\u8a62\uff1a```\n\u00a0 SELECT name,count(*)\u00a0 \u00a0 FROM public.TEST_NAMES\u00a0 GROUP BY name\u00a0 HAVING count(*) > 1;\u00a0 \n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\n\u00a0 name \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0| count\u00a0 --------------------+-------\u00a0 Johnny \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0| \u00a0 \u00a0 2\u00a0 Peter \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 | \u00a0 \u00a0 2\u00a0 (2 rows)\u00a0 \n```\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u8acb\u7e7c\u7e8c\u4e0b\u4e00\u6b65\u4ee5\u79fb\u9664\u91cd\u8907\u9375\u3002\u5982\u679c \u4e2d\u7684\u4efb\u4f55\u5217\u662f null\uff0c\u5247\u53ef\u4ee5\u5ffd\u7565\u5b83\u5011\uff0c\u56e0\u7232\u552f\u4e00\u9650\u5236\u689d\u4ef6\u4e0d\u9069\u7528\u65bc NULL \u5217\u3002\u5982\u679c\u672a\u767c\u73fe\u91cd\u8907\u7684\u9375\uff0c\u5247\u53ef\u4ee5\u524d\u5f80 [\u4fee\u5fa9\u4e0d\u4e00\u81f4\u7684\u7d22\u5f15](#fix-indexes) \u3002\n- \u53ef\u9078\uff0c\u4f46\u5efa\u8b70\u57f7\u884c\uff1a\u7232\u5305\u542b\u91cd\u8907\u9375\u7684\u8a18\u9304\u5275\u5efa\u5099\u4efd\u3002\u904b\u884c\u4ee5\u4e0b\u8a9e\u53e5\u4ee5\u5275\u5efa\u5099\u4efd\u8a18\u9304\uff1a\n```\n\u00a0 CREATE TABLE SCHEMA_NAME.TABLE_NAME_bak\u00a0 AS SELECT * FROM SCHEMA_NAME.TABLE_NAME\u00a0 WHERE (KEY_COLUMNS)\u00a0 IN ((KEY_VALUES));\u00a0 \n```\n\u5728\u6b64\u8a9e\u53e5\u4e2d\uff0c \u662f\u5f9e\u4e0a\u4e00\u6b65\u7684\u7d50\u679c\u4e2d\u8907\u88fd\u7684\u503c\u5217\u8868\u3002\u4f8b\u5982\uff1a\n```\n\u00a0 CREATE TABLE public.TEST_NAMES_bak\u00a0 AS SELECT * FROM public.TEST_NAMES\u00a0 WHERE (name) IN (('Johnny'),('Peter'))\u00a0 \n```\n\u5c0d\u65bc\u5927\u91cf\u884c\uff0c\u4f7f\u7528\u7b2c 2 \u6b65\u4e2d\u7684 `SELECT` \u8a9e\u53e5\uff08\u4e0d\u5305\u542b `count` \u53c3\u6578\uff09\u66ff\u63db `IN` \u8a9e\u53e5\u4e2d\u7684 ( ) \u53c3\u6578\u6703\u66f4\u7232\u7c21\u55ae\u3002\u4f8b\u5982\uff1a\n```\n\u00a0 CREATE TABLE SCHEMA_NAME.TABLE_NAME_bak\u00a0 AS SELECT * FROM SCHEMA_NAME.TABLE_NAME\u00a0 WHERE (KEY_COLUMNS)\u00a0 IN ( SELECT (KEY_COLUMNS)\u00a0 FROM SCHEMA_NAME.TABLE_NAME\u00a0 GROUP BY (KEY_COLUMNS)\u00a0 HAVING count(*) > 1);\u00a0 \n```\n- \u7232\u7528\u6236\u6dfb\u52a0\u8907\u88fd\u89d2\u8272\u4ee5\u505c\u7528\u89f8\u767c\u5668\uff1a\n```\n\u00a0 ALTER USER CURRENT_USER with REPLICATION;\u00a0 SET session_replication_role = replica;\u00a0 \n```\n- \u904b\u884c\u4ee5\u4e0b\u8a9e\u53e5\u4ee5\u522a\u9664\u91cd\u8907\u7684\u9375\uff1a\n```\n\u00a0 BEGIN;\u00a0 DELETE FROM \u00a0SCHEMA_NAME.TABLE_NAME a\u00a0 \u00a0 \u00a0 USING \u00a0(\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 SELECT \u00a0 min(ctid) AS ctid,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 KEY_COLUMNS\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 FROM \u00a0 \u00a0 SCHEMA_NAME.TABLE_NAME\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 GROUP BY KEY_COLUMNS\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 HAVING count(*) > 1 ) b\u00a0 \u00a0 \u00a0 WHERE a.KEY_COLUMNS = b.KEY_COLUMNS\u00a0 \u00a0 \u00a0 AND \u00a0 a.ctid <> b.ctid;\u00a0 \n```\n\u4f8b\u5982\uff0c\u5c0d\u65bc\u591a\u5217 \uff1a\n```\n\u00a0 DELETE FROM public.test_random a\u00a0 \u00a0 \u00a0 USING (\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0SELECT min(ctid) AS ctid,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0day, rnum\u00a0 \u00a0 \u00a0 FROM public.test_random\u00a0 \u00a0 \u00a0 GROUP BY day, rnum\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0HAVING count(*) > 1 ) b\u00a0 \u00a0 \u00a0 WHERE a.day=b.day and a.rnum = b.rnum\u00a0 \u00a0 \u00a0 AND a.ctid <> b.ctid;\u00a0 \n```\n\u5176\u4e2d\uff0c\n\u548c\n\u662f\n\u3002\n\u5c0d\u65bc\u6bcf\u4e00\u7d44\u91cd\u8907\u884c\uff0c\u904b\u884c\u6b64\u8a9e\u53e5\u6703\u4fdd\u7559\u4e00\u884c\u4e26\u522a\u9664\u5176\u4ed6\u884c\u3002\u5982\u679c\u8981\u63a7\u5236\u522a\u9664\u54ea\u500b\u884c\u7248\u672c\uff0c\u8acb\u5728 delete \u8a9e\u53e5\u4e2d\u904b\u884c\u4ee5\u4e0b\u904e\u6ffe\u689d\u4ef6\uff1a\n```\n\u00a0 DELETE FROM \u00a0SCHEMA_NAME.TABLE_NAME\u00a0 WHERE ( KEY_COLUMNS, ctid) = (KEY_VALUES, CTID_VALUE);\u00a0 \n```\n **\u8b66\u544a** \uff1a\u63d0\u4ea4\u6b64\u4e8b\u52d9\u6703\u66f4\u6539\u6578\u64da\u5eab\u4e26\u79fb\u9664\u91cd\u8907\u7684\u9375\u3002\u8acb\u52ff\u522a\u9664\u4ecd\u7136\u9700\u8981\u7684\u4efb\u4f55\u6578\u64da\u3002\u901a\u904e\u5099\u4efd\u6062\u5fa9\u53ef\u80fd\u6703\u6062\u5fa9\u4e0d\u4e00\u81f4\u7684\u7d22\u5f15\u3002\n- \u5b8c\u6210\u4ee5\u4e0b\u6b65\u9a5f\uff0c\u6aa2\u67e5 `DELETE` \u547d\u4ee4\u662f\u5426\u8fd4\u56de\u9810\u671f\u7684\u884c\u6578\uff0c\u4e26\u4e14\u6c92\u6709\u4efb\u4f55\u932f\u8aa4\uff1a- \u904b\u884c\u4ee5\u4e0b\u8a9e\u53e5\u4ee5\u78ba\u5b9a\u8868\u4e2d\u5df2\u66f4\u6539\u7684\u884c\uff1a\n```\n\u00a0 SELECT schemaname, relname, n_tup_del, n_tup_upd\u00a0 \u00a0 FROM pg_stat_xact_all_tables\u00a0 WHERE n_tup_del+n_tup_upd > 0;\u00a0 \n```\n- \u5982\u679c\u6240\u6709\u884c\u90fd\u6b63\u78ba\uff0c\u8acb\u63d0\u4ea4 `DELETE` \u4e8b\u52d9\uff1a\n```\n\u00a0 END;\u00a0 \n```\n- \u5982\u679c\u5b58\u5728\u932f\u8aa4\uff0c\u8acb\u56de\u6efe\u66f4\u6539\u4ee5\u4fee\u5fa9\u932f\u8aa4\uff1a\n```\n\u00a0 ROLLBACK;\u00a0 \n```\n- \u522a\u9664\u91cd\u8907\u7684\u9375\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5c07\u7d22\u5f15\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u3002## \u4fee\u5fa9\u4e0d\u4e00\u81f4\u7684\u7d22\u5f15\n\u4ee5\u4e0b\u90e8\u5206\u4ecb\u7d39\u77ad\u5982\u4f55\u4fee\u5fa9\u5be6\u4f8b\u4e2d\u767c\u73fe\u7684\u7d22\u5f15\u4e0d\u4e00\u81f4\u554f\u984c\u3002\n**\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u7684\u7d22\u5f15\u5b58\u5728\u552f\u4e00\u9375\u548c\u4e3b\u9375\u9055\u898f\uff0c\u5247\u5fc5\u9808\u5728\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u4e4b\u524d\u4fee\u5fa9\u9019\u4e9b\u554f\u984c\u3002\n\u6839\u64da\u6578\u64da\u5eab\u7684\u914d\u7f6e\u65b9\u5f0f\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u5c0d\u524d\u9762\u6b65\u9a5f\u4e2d\u78ba\u5b9a\u7684\u6bcf\u500b\u7d22\u5f15\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- [\u6e96\u5099\u5c07\u7d22\u5f15\u91cd\u65b0\u7de8\u5165\u7d22\u5f15](#prepare) \u3002\n- [\u5c07\u7d22\u5f15\u91cd\u65b0\u7de8\u5165\u7d22\u5f15](#rebuild) \u3002\n- \u5982\u679c\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u64cd\u4f5c\u7531\u65bc\u5916\u9375\u9055\u898f\u800c\u5931\u6557\uff0c\u5247\u60a8\u5fc5\u9808 [\u67e5\u627e\u4e26\u7cfe\u6b63\u9019\u4e9b\u9055\u898f\u884c\u7232](#check-fk) \u3002\n- \u518d\u6b21\u904b\u884c\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u64cd\u4f5c\u3002\n### \u6e96\u5099\u5c07\u7d22\u5f15\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\n\u8207\u8f03\u5c0f\u7684\u6578\u64da\u5eab\u76f8\u6bd4\uff0c\u5c07\u8f03\u5927\u7684\u6578\u64da\u5eab\u7de8\u5165\u7d22\u5f15\u9700\u8981\u66f4\u591a\u6642\u9593\u3002\u8981\u63d0\u9ad8\u8f03\u5927\u6578\u64da\u5eab\u7684\u7d22\u5f15\u548c\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u64cd\u4f5c\u7684\u901f\u5ea6\uff0c\u60a8\u53ef\u4ee5\u7232\u9019\u4e9b\u64cd\u4f5c\u5206\u914d\u66f4\u591a\u5167\u5b58\u548c CPU\u3002\u9019\u662f\u898f\u5283\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u64cd\u4f5c\u7684\u4e00\u500b\u91cd\u8981\u6b65\u9a5f\u3002\u77ad\u89e3\u7d22\u5f15\u5927\u5c0f\u5f8c\uff0c\u60a8\u53ef\u4ee5 [\u8a2d\u7f6e\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u64cd\u4f5c\u4f7f\u7528\u7684\u5167\u5b58\u5927\u5c0f](#memory) \u4e26 [\u8a2d\u7f6e\u4e26\u884c\u5de5\u4f5c\u5668\u7684\u6578\u91cf](#workers) \u3002\n\u904b\u884c\u4ee5\u4e0b\u8a9e\u53e5\uff0c\u67e5\u627e\u8981\u4fee\u5fa9\u7684\u7d22\u5f15\u7684\u5927\u5c0f\uff08\u4ee5\u5343\u5b57\u7bc0\u7232\u55ae\u4f4d\uff09\uff1a\n```\n\u00a0 SELECT i.relname \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0AS index_name,\u00a0 \u00a0 \u00a0 \u00a0 pg_size_pretty(pg_relation_size(x.indexrelid)) AS index_size\u00a0 FROM \u00a0 pg_index x\u00a0 \u00a0 \u00a0 \u00a0 JOIN pg_class i\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ON i.oid = x.indexrelid\u00a0 WHERE \u00a0i.relname = 'INDEX_NAME';\u00a0 \n```\n\u6b64\u8a9e\u53e5\u7684\u8f38\u51fa\u985e\u4f3c\u4ee5\u4e0b\u5167\u5bb9\uff1a\n```\n\u00a0 index_name \u00a0| index_size\u00a0 ------------+------------\u00a0 my_index \u00a0 \u00a0| 16 kB\u00a0 (1 row)\u00a0 \n```\n\u6839\u64da\u4e0a\u4e00\u90e8\u5206\u78ba\u5b9a\u7684\u7d22\u5f15\u5927\u5c0f\uff0c\u8acb\u52d9\u5fc5\u7232 [maintenance_work_mem](https://cloud.google.com/sql/docs/postgres/flags?hl=zh-cn#postgres-m) \u8a2d\u7f6e\u9069\u7576\u7684\u503c\u3002\u6b64\u53c3\u6578\u6307\u5b9a\u7528\u65bc\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u64cd\u4f5c\u7684\u5167\u5b58\u91cf\u3002\u4f8b\u5982\uff0c\u5982\u679c\u7d22\u5f15\u5927\u5c0f\u8d85\u904e 15 GB\uff0c\u6211\u5011\u5efa\u8b70\u60a8\u8abf\u6574\u7dad\u8b77\u5167\u5b58\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u8a2d\u7f6e\u6578\u64da\u5eab\u6a19\u8a8c](https://cloud.google.com/sql/docs/postgres/flags?hl=zh-cn#set_a_database_flag) \u3002\n**\u6ce8\u610f** \uff1a\u7cfb\u7d71\u6703\u7232\u6bcf\u500b\u6703\u8a71\u8a2d\u7f6e `maintenance_work_mem` \u7684\u503c\u3002 \u66f4\u6539\u503c\u5f8c\uff0c\u60a8\u7121\u9700\u91cd\u5553\u5be6\u4f8b\u3002\u4f46\u662f\uff0c\u5982\u679c\u60a8\u5728\u65b0\u6703\u8a71\u4e2d\u518d\u6b21\u9023\u63a5\u5230\u6578\u64da\u5eab\uff0c\u5247\u7cfb\u7d71\u4e0d\u6703\u4fdd\u5b58\u5148\u524d\u8a2d\u7f6e\u7684\u503c\u3002\n\u8207\u8f03\u5c0f\u7684\u6578\u64da\u5eab\u76f8\u6bd4\uff0c\u5c07\u8f03\u5927\u7684\u6578\u64da\u5eab\u7de8\u5165\u7d22\u5f15\u9700\u8981\u66f4\u591a\u6642\u9593\u3002\u7232\u63d0\u9ad8\u7d22\u5f15\u548c\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u64cd\u4f5c\u7684\u901f\u5ea6\uff0c\u5c0d\u65bc\u5728\u6b64\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u64cd\u4f5c\u671f\u9593\u5177\u6709 4 GB \u6216\u66f4\u591a\u5167\u5b58\u7684\u5be6\u4f8b\uff0c\u6211\u5011\u5efa\u8b70\u5c07 `maintenance_work_mem` \u8a2d\u7f6e\u7232\u81f3\u5c11 2% \u7684\u5be6\u4f8b\u5167\u5b58\u3002\n\u60a8\u53ef\u4ee5\u4f7f\u7528 PostgreSQL 11 \u6216\u66f4\u9ad8\u7248\u672c\u5728\u6578\u64da\u5eab\u4e2d\u8a2d\u7f6e [max_parallel_maintenance_workers](https://cloud.google.com/sql/docs/postgres/flags?hl=zh-cn#postgres-m) \u53c3\u6578\uff0c\u4ee5\u589e\u52a0\u7528\u65bc\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u7684\u4e26\u884c\u5de5\u4f5c\u5668\u7684\u6578\u91cf\u3002\u6b64\u53c3\u6578\u7684\u9ed8\u8a8d\u503c\u7232 2\uff0c\u4f46\u53ef\u4ee5\u8a2d\u7f6e\u7232\u66f4\u5927\u7684\u503c\uff0c\u4ee5\u589e\u52a0\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u7684\u5de5\u4f5c\u5668\u7684\u6578\u91cf\u3002\u5c0d\u65bc\u5177\u6709 8 \u500b\u6216\u66f4\u591a vCPU \u6838\u5fc3\u7684\u5be6\u4f8b\uff0c\u6211\u5011\u5efa\u8b70\u5c07 `max_parallel_maintenance_workers` \u6a19\u8a8c\u503c\u8a2d\u7f6e\u7232 4\u3002\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u8a2d\u7f6e\u6578\u64da\u5eab\u6a19\u8a8c](https://cloud.google.com/sql/docs/postgres/flags?hl=zh-cn#set_a_database_flag) \u3002\n### \u5c07\u7d22\u5f15\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\n\u60a8\u53ef\u4ee5\u4f7f\u7528 `pg_repack` \u5be6\u7528\u7a0b\u5e8f\u5c07\u7d22\u5f15\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\uff0c\u800c\u4e0d\u6703\u963b\u6b62\u751f\u7522\u5de5\u4f5c\u8ca0\u8f09\u3002\u6b64\u5be6\u7528\u7a0b\u5e8f\u53ef\u4ee5\u81ea\u52d5\u57f7\u884c\u4e26\u7c21\u5316\u4f75\u767c\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u904e\u7a0b\uff0c\u8b93\u60a8\u53ef\u4ee5\u5728\u4e0d\u505c\u6a5f\u7684\u60c5\u6cc1\u4e0b\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\uff0c\u5c24\u5176\u662f\u5c0d\u65bc\u6c92\u6709 `REINDEX CONCURRENTLY` \u64cd\u4f5c\u7684 PostgreSQL \u7248\u672c 11 \u53ca\u66f4\u65e9\u7248\u672c\u3002\u5c0d\u65bc\u6b64\u904e\u7a0b\uff0c\u8acb\u4f7f\u7528 `pg_repack` 1.4.7 \u7248\u3002\n\u5b8c\u6210\u4ee5\u4e0b\u6b65\u9a5f\uff0c\u4ee5\u4f7f\u7528 `pg_repack` \u5c07\u7d22\u5f15\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\uff1a\n- \u5f9e [pg_repack \u9801\u9762](https://reorg.github.io) \u4e0b\u8f09\u3001\u7de8\u8b6f\u548c\u5b89\u88dd `pg_repack` \u5be6\u7528\u7a0b\u5e8f\u3002\n\u7232\u65b9\u4fbf\u8d77\u898b\uff0c\u6211\u5011\u5efa\u8b70 Debian Linux \u7528\u6236\u4e0b\u8f09\u4e26\u5b89\u88dd [\u9069\u7528\u65bc Linux x86_64 \u5e73\u81fa\u7684\u9810\u69cb\u5efa\u53ef\u57f7\u884c\u4e8c\u9032\u5236\u6587\u4ef6](https://storage.googleapis.com/cloud-sql-pg-repack/ver_1.4.7/pg_repack) \u3002\n\u6b64\u4e8c\u9032\u5236\u6587\u4ef6\u7684 sha256 \u6821\u9a57\u548c\u54c8\u5e0c\u5982\u4e0b\uff1a\n`ecfee54364a625d9365d86cb27940b458bfdb0d6ff63bb88063039256fbde96f`\n\u5982\u9700\u9a57\u8b49\u60a8\u7684 Linux \u7248\u672c\u662f\u5426\u7232 Debian GNU/Linux 11\uff0c\u8acb\u904b\u884c `hostnamectl` \u547d\u4ee4\u3002 **\u6ce8\u610f** \uff1a\u5c0d\u65bc\u6b64\u904e\u7a0b\uff0c\u60a8\u61c9\u8a72\u5728 Linux \u6216 Unix \u4e0a\u7684\u7d42\u7aef\u4e2d\u4f7f\u7528\u6b63\u5e38\u904b\u884c\u7684 GNU \u5de5\u5177\u93c8\u904b\u884c\u8a72\u547d\u4ee4\u3002\n\u5f9e [pg_repack](https://reorg.github.io/pg_repack/) \u9801\u9762\u4e0b\u8f09\u3001\u7de8\u8b6f\u4e26\u5b89\u88dd `pg_repack` \u5be6\u7528\u7a0b\u5e8f\u3002\n- \u5275\u5efa `pg_repack` \u64f4\u5c55\u7a0b\u5e8f\uff1a\n```\n\u00a0 CREATE EXTENSION pg_repack;\u00a0 \n```\n- \u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u4f75\u767c\u5730\u5c07\u7d22\u5f15\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\uff1a\n```\n\u00a0 pg_repack -h HOSTIP -p 5432 -U USERNAME -d \"DATABASE_NAME\" -i \"INDEX_NAME\" --no-superuser-check --no-kill-backend --wait-timeout=3600\u00a0 \n```\n **\u6ce8\u610f** \uff1a `pg_repack` \u4e0d\u5141\u8a31\u60a8\u5c07\u5177\u9ad4\u5316\u8996\u5716\u4e0a\u7684\u7d22\u5f15\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u3002\u6b64\u547d\u4ee4\u7684\u8f38\u51fa\u985e\u4f3c\u5982\u4e0b\u5167\u5bb9\uff1a\n```\n\u00a0 INFO: repacking index \"public.t_i_key\"\u00a0 \n```\n\u5982\u679c\u904b\u884c `pg_repack` \u6642\u767c\u751f\u4efb\u4f55\u932f\u8aa4\uff0c\u60a8\u53ef\u4ee5\u66f4\u6b63\u932f\u8aa4\uff0c\u7136\u5f8c\u91cd\u8a66\u3002\u4fee\u5fa9\u5b8c\u6240\u6709\u552f\u4e00\u9375\u7d22\u5f15\u548c\u4e3b\u9375\u7d22\u5f15\u5f8c\uff0c\u60a8\u61c9 [\u6aa2\u67e5\u662f\u5426\u5b58\u5728\u5916\u9375\u9055\u898f\u884c\u7232](#check-fk) \uff0c\u4e26\u4fee\u5fa9\u767c\u73fe\u7684\u4efb\u4f55\u9055\u898f\u884c\u7232\u3002\n### \u67e5\u627e\u4e26\u7cfe\u6b63\u5916\u9375\u9055\u898f\u884c\u7232\n\u5982\u9700\u77ad\u89e3\u5982\u4f55\u67e5\u627e\u4e26\u7cfe\u6b63\u5916\u9375\u9055\u898f\u884c\u7232\uff0c\u8acb\u53c3\u95b1 [\u67e5\u627e\u4e26\u7cfe\u6b63\u5916\u9375\u9055\u898f\u884c\u7232](https://cloud.google.com/sql/docs/postgres/fix-foreign-keys?hl=zh-cn) \u3002\n## \u76e3\u63a7\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u64cd\u4f5c\n\u6709\u6642\uff0c\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u64cd\u4f5c\u53ef\u80fd\u6703\u88ab\u5176\u4ed6\u6703\u8a71\u963b\u6b62\u3002\u6211\u5011\u5efa\u8b70\u60a8\u6bcf 4 \u5c0f\u6642\u6aa2\u67e5\u4e00\u6b21\u6b64\u6587\u4ef6\u3002\u5982\u679c\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u64cd\u4f5c\u88ab\u963b\u6b62\uff0c\u60a8\u53ef\u4ee5\u53d6\u6d88\u963b\u6b62\u6703\u8a71\uff0c\u4ee5\u4fbf\u91cd\u65b0\u7de8\u5165\u7d22\u5f15\u64cd\u4f5c\u53ef\u4ee5\u5b8c\u6210\u3002\n\u5b8c\u6210\u4ee5\u4e0b\u6b65\u9a5f\u4ee5\u8b58\u5225\u963b\u6b62\u548c\u7b49\u5f85\u6703\u8a71\uff0c\u7136\u5f8c\u5728 INDEX \u64cd\u4f5c\u4e2d\u53d6\u6d88\u9019\u4e9b\u6703\u8a71\uff1a\n- \u5982\u9700\u8b58\u5225\u963b\u6b62\u6703\u8a71\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u67e5\u8a62\uff1a\n```\n\u00a0 SELECT pid,\u00a0 \u00a0 \u00a0 \u00a0 usename,\u00a0 \u00a0 \u00a0 \u00a0 pg_blocking_pids(pid) AS blocked_by,\u00a0 \u00a0 \u00a0 \u00a0 query \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 AS blocked_query\u00a0 FROM \u00a0 pg_stat_activity\u00a0 WHERE \u00a0cardinality(pg_blocking_pids(pid)) > 0;\u00a0 \n```\n- \u5982\u9700\u53d6\u6d88\u6703\u8a71\uff0c\u8acb\u4f7f\u7528\u4e0a\u4e00\u67e5\u8a62\u4e2d\u963b\u6b62\u6703\u8a71\u7684 PID \u904b\u884c\u4ee5\u4e0b\u67e5\u8a62\uff1a\n```\n\u00a0 SELECT pg_cancel_backend(PID);\u00a0 \n```\n## \u9a57\u8b49\u7d22\u5f15\u662f\u5426\u4e00\u81f4\n\u60a8\u5fc5\u9808\u7e7c\u7e8c\u6aa2\u67e5\u6bcf\u500b\u4e0d\u4e00\u81f4\u7684\u7d22\u5f15\u7684\u4e0d\u4e00\u81f4\u554f\u984c\u3002\u4fee\u5fa9\u5be6\u4f8b\u7684\u6240\u6709\u4e0d\u4e00\u81f4\u7d22\u5f15\u548c\u9375\u9055\u898f\u884c\u7232\u5f8c\uff0c\u60a8\u53ef\u4ee5\u6309\u7167\u4e4b\u524d\u90e8\u5206\u4e2d\u7684\u6b65\u9a5f\u6aa2\u67e5\u662f\u5426\u4e0d\u5b58\u5728\u4efb\u4f55\u554f\u984c\uff1a\n- [\u6aa2\u67e5\u7d22\u5f15\u7684\u4e0d\u4e00\u81f4\u554f\u984c](#check-index) \n- [\u6aa2\u67e5\u552f\u4e00\u9375\u9055\u898f](#check-uk)", "guide": "Cloud SQL"}