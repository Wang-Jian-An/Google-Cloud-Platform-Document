{"title": "Cloud SQL - \u67e5\u627e\u4e26\u7cfe\u6b63\u5916\u9375\u9055\u898f\u884c\u7232", "url": "https://cloud.google.com/sql/docs/postgres/fix-foreign-keys?hl=zh-cn", "abstract": "# Cloud SQL - \u67e5\u627e\u4e26\u7cfe\u6b63\u5916\u9375\u9055\u898f\u884c\u7232\n\u5982\u9700\u6aa2\u67e5\u7f3a\u5c11\u76f8\u61c9\u4e3b\u9375\u7684\u5916\u9375\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\n\u00a0 WITH q AS (\u00a0 \u00a0 \u00a0 SELECT conrelid::regclass AS fk_table,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 confrelid::regclass AS pk_table,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 format('(%s)',(select string_agg(format('fk.%I', attname), ', ')\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 FROM pg_attribute a\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 JOIN unnest(conkey) ia(nr) ON ia.nr = a.attnum\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 WHERE attrelid = conrelid)) AS fk_fields,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 format('(%s)',(select string_agg(format('pk.%I', attname), ', ')\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 FROM pg_attribute a\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 JOIN unnest(confkey) ia(nr) ON ia.nr = a.attnum\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 WHERE attrelid = confrelid)) AS pk_fields,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 pg_get_constraintdef(oid)\u00a0 \u00a0 \u00a0 \u00a0 FROM pg_constraint\u00a0 \u00a0 \u00a0 WHERE contype='f'\u00a0 )\u00a0 SELECT format(\u00a0 $sql$\u00a0 DO $$ BEGIN RAISE NOTICE 'checking Foreign Key %3$s%1$s ==> %4$s%2$s'; END;$$;\u00a0 SELECT %1$s, %2$s\u00a0 \u00a0 FROM %3$s AS fk\u00a0 \u00a0 LEFT JOIN %4$s AS pk ON %1$s = %2$s\u00a0 \u00a0 WHERE %2$s IS NULL\u00a0 \u00a0 \u00a0 AND \u00a0%1$s IS NOT NULL \u00a0/* any NULL on FK side bypasses FK constraint by design */\u00a0 /* use limit for testing, or detecting that \"there is a problem in this table */\u00a0 -- \u00a0LIMIT 10\u00a0 $sql$, fk_fields, pk_fields, fk_table, pk_table\u00a0 )\u00a0 \u00a0 FROM q\u00a0 \\gexec\u00a0 \n```\n\u8a72\u8173\u672c\u7684\u8f38\u51fa\u5c07\u5982\u4e0b\u6240\u793a\u3002\u5982\u679c\u6c92\u6709\u8f38\u51fa\uff0c\u5247\u8868\u793a\u6c92\u6709\u9055\u898f\u884c\u7232\uff0c\u4e26\u4e14\u60a8\u5df2\u6210\u529f\u91cd\u65b0\u69cb\u5efa\u7d22\u5f15\u3002\n```\n\u00a0 id | pk_id\u00a0 ----+-------\u00a0 \u00a0 \u00a0 | \u00a0 \u00a0 4\u00a0 (1 row)\u00a0 \n```\n\u5728\u4e0a\u8ff0\u8f38\u51fa\u4e2d\uff0c\u7b2c\u4e00\u5217\u986f\u793a\u4e3b\u9375\u5217\uff08\u5728\u6b64\u793a\u4f8b\u4e2d\u662f\u540d\u7232 `id` \u7684\u5217\uff09\u3002\u7b2c\u4e8c\u5217\u662f\u5916\u9375\u7684\u5f15\u7528\u5217\u3002\u9019\u610f\u5473\u7740\u5b58\u5728 `pk_id=4` \u884c\uff0c\u5176\u7236\u4e3b\u9375\u4e0d\u5b58\u5728\u3002\u60a8\u53ef\u4ee5\u78ba\u5b9a\u9019\u4e9b\u9375\u662f\u5426\u6709\u6548\uff0c\u5982\u679c\u7121\u6548\uff0c\u5247\u53ef\u4ee5\u522a\u9664", "content": "\u3002", "guide": "Cloud SQL"}