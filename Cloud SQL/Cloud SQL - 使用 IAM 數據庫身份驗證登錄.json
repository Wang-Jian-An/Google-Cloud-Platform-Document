{"title": "Cloud SQL - \u4f7f\u7528 IAM \u6578\u64da\u5eab\u8eab\u4efd\u9a57\u8b49\u767b\u9304", "url": "https://cloud.google.com/sql/docs/postgres/iam-logins?hl=zh-cn", "abstract": "# Cloud SQL - \u4f7f\u7528 IAM \u6578\u64da\u5eab\u8eab\u4efd\u9a57\u8b49\u767b\u9304\n\u672c\u9801\u9762\u4ecb\u7d39\u4e86\u7528\u6236\u548c\u670d\u52d9\u8cec\u865f\u5982\u4f55\u4f7f\u7528 Cloud SQL IAM \u6578\u64da\u5eab\u8eab\u4efd\u9a57\u8b49\u767b\u9304 Cloud SQL \u6578\u64da\u5eab\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [IAM \u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/sql/docs/postgres/iam-authentication?hl=zh-cn) \u3002\n", "content": "## \u6e96\u5099\u5de5\u4f5c\n- \u5c07\u5be6\u4f8b\u914d\u7f6e\u7232\u4f7f\u7528 IAM \u6578\u64da\u5eab\u8eab\u4efd\u9a57\u8b49\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u914d\u7f6e\u65b0\u5be6\u4f8b\u4ee5\u4f7f\u7528 IAM \u6578\u64da\u5eab\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/sql/docs/postgres/create-edit-iam-instances?hl=zh-cn#configure-iam-db-instance) \u3002\n- \u5c07 IAM \u7528\u6236\u6dfb\u52a0\u5230\u6578\u64da\u5eab\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5c07 IAM \u7528\u6236\u6216\u670d\u52d9\u8cec\u865f\u6dfb\u52a0\u5230\u6578\u64da\u5eab](https://cloud.google.com/sql/docs/postgres/add-manage-iam-users?hl=zh-cn#creating-a-database-user) \u3002\n- \u5c07 [roles/cloudsql.instanceUser](https://cloud.google.com/sql/docs/postgres/iam-roles?hl=zh-cn) IAM \u89d2\u8272\u6dfb\u52a0\u5230\u60a8\u7684 IAM \u7528\u6236\u3002\u9019\u662f\u4e00\u500b\u9810\u5b9a\u7fa9\u89d2\u8272\uff0c\u5176\u4e2d\u5305\u542b\u5fc5\u8981\u7684 Cloud SQL IAM`cloudsql.instances.login`\u6b0a\u9650\u3002\u60a8\u9700\u8981\u6b64\u6b0a\u9650\u624d\u80fd\u4f7f\u7528 IAM \u6578\u64da\u5eab\u8eab\u4efd\u9a57\u8b49\u767b\u9304\u6578\u64da\u5eab\u5be6\u4f8b\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u89d2\u8272\u548c\u6b0a\u9650](https://cloud.google.com/sql/docs/postgres/roles-and-permissions?hl=zh-cn#introduction) \u3002\n- \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u5c07 IAM \u7528\u6236\u6dfb\u52a0\u5230\u6578\u64da\u5eab\u6642\uff0c\u65b0\u6578\u64da\u5eab\u7528\u6236\u7121\u6b0a\u8a2a\u554f\u4efb\u4f55\u6578\u64da\u5eab\u3002\u60a8\u9700\u8981\u4f7f\u7528`GRANT`\u547d\u4ee4\u5411 IAM \u6578\u64da\u5eab\u7528\u6236\u6388\u4e88\u4efb\u4f55\u5fc5\u8981\u7684\u6b0a\u9650\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5411 IAM \u7528\u6236\u6388\u4e88\u6578\u64da\u5eab\u6b0a\u9650](https://cloud.google.com/sql/docs/postgres/add-manage-iam-users?hl=zh-cn#grant-db-privileges) \u3002## \u4f7f\u7528\u81ea\u52d5 IAM \u6578\u64da\u5eab\u8eab\u4efd\u9a57\u8b49\u767b\u9304\n\u60a8\u53ef\u4ee5\u5c07 Cloud SQL \u9023\u63a5\u5668\u914d\u7f6e\u7232\u4ee3\u8868\u7528\u6236\u6216\u61c9\u7528\u81ea\u52d5\u8655\u7406\u5411 Cloud SQL \u5be6\u4f8b\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u64cd\u4f5c\u3002\u9023\u63a5\u5668\u5305\u62ec Cloud SQL Auth \u4ee3\u7406\u3001Go \u9023\u63a5\u5668\u3001Java \u9023\u63a5\u5668\u548c Python \u9023\u63a5\u5668\uff0c\u6240\u6709\u9019\u4e9b\u9023\u63a5\u5668\u5747\u652f\u6301\u81ea\u52d5 IAM \u6578\u64da\u5eab\u8eab\u4efd\u9a57\u8b49\u3002\u5c07 Cloud SQL \u9023\u63a5\u5668\u8207\u81ea\u52d5 IAM \u6578\u64da\u5eab\u8eab\u4efd\u9a57\u8b49\u642d\u914d\u4f7f\u7528\u6642\uff0c\u7528\u65bc\u5553\u52d5\u9023\u63a5\u5668\u7684 IAM \u8cec\u865f\u5fc5\u9808\u662f\u5c0d\u6578\u64da\u5eab\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u540c\u4e00\u8cec\u865f\u3002\n**\u6ce8\u610f\uff1a** \u96d6\u7136 Cloud SQL Auth \u4ee3\u7406\u53ef\u4ee5\u76e3\u807d\u4efb\u4f55\u7aef\u53e3\uff0c\u4f46\u5b83\u53ea\u6703\u5728\u7aef\u53e3 3307 \u4e0a\u5275\u5efa\u5230 Cloud SQL \u5be6\u4f8b\u7684\u50b3\u51fa\u6216\u51fa\u7ad9\u6d41\u91cf\u9023\u63a5\u3002\u7531\u65bc Cloud SQL Auth \u4ee3\u7406\u901a\u904e `sqladmin.googleapis.com` \u57df\u540d\u8abf\u7528 API\uff0c\u800c\u8a72\u57df\u540d\u6c92\u6709\u56fa\u5b9a IP \u5730\u5740\uff0c\u56e0\u6b64\u5fc5\u9808\u5728\u7aef\u53e3 443 \u4e0a\u5141\u8a31\u6240\u6709\u51fa\u7ad9\u6d41\u91cf TCP \u9023\u63a5\u3002\u5982\u679c\u60a8\u7684\u5ba2\u6236\u7aef\u6a5f\u5668\u5177\u6709\u51fa\u7ad9\u9632\u706b\u7246\u653f\u7b56\uff0c\u8acb\u78ba\u4fdd\u5b83\u5141\u8a31\u8207 Cloud SQL \u5be6\u4f8b IP \u5730\u5740\u4e0a\u7684\u7aef\u53e3 3307 \u7684\u50b3\u51fa\u9023\u63a5\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7528\u65bc\u5c0d Cloud SQL Auth \u4ee3\u7406\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u9078\u9805](https://cloud.google.com/sql/docs/postgres/connect-auth-proxy?hl=zh-cn#authentication-options) \u3002\n\u5982\u9700\u4f7f\u7528\u81ea\u52d5 IAM \u6578\u64da\u5eab\u8eab\u4efd\u9a57\u8b49\u767b\u9304\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n**\u91cd\u8981\u63d0\u793a** \uff1a\u5982\u679c\u60a8\u4f7f\u7528 `cloud_sql_proxy` \u4e8c\u9032\u5236\u6587\u4ef6\u6216 `--enable_iam_login` \u6a19\u8a8c\u4f86\u5553\u52d5 Cloud SQL Auth \u4ee3\u7406\uff0c\u5247\u60a8\u4f7f\u7528\u7684\u662f Cloud SQL Auth \u4ee3\u7406 v1\u3002\u9077\u79fb\u5230 v2\u3001 `cloud-sql-proxy` \uff0c\u4e26\u4f7f\u7528 `--auto-iam-authn` \u6a19\u8a8c\u9032\u884c IAM \u6578\u64da\u5eab\u8eab\u4efd\u9a57\u8b49\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u9077\u79fb\u5230 v2\uff0c\u8acb\u53c3\u95b1 [\u5f9e v1 \u9077\u79fb\u5230 v2](https://github.com/GoogleCloudPlatform/cloud-sql-proxy/blob/main/migration-guide.md) \u3002- \u5411 Google Cloud \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 **User** \u4f7f\u7528\u61c9\u7528\u9ed8\u8a8d\u6191\u64da (ADC) \u5411 Google Cloud \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u4f7f\u7528 [gcloud auth application-default login](https://cloud.google.com/sdk/gcloud/reference/auth/application-default/login?hl=zh-cn) \u547d\u4ee4\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u8a2d\u7f6e\u61c9\u7528\u9ed8\u8a8d\u6191\u64da](https://cloud.google.com/docs/authentication/provide-credentials-adc?hl=zh-cn) \u3002 **\u670d\u52d9\u8cec\u865f** \u5982\u9700\u4f7f\u7528\u670d\u52d9\u8cec\u865f\u901a\u904e ADC \u5411 Google Cloud \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u670d\u52d9\u8cec\u865f\u6a21\u64ec\u6216\u4f7f\u7528\u670d\u52d9\u8cec\u865f\u5bc6\u9470\u3002\u5982\u9700\u4f7f\u7528\u670d\u52d9\u8cec\u865f\u6a21\u64ec\uff0c\u8acb\u66ff\u63db \u4e26\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud auth application-default login --impersonate-service-account SERVICE_ACCOUNT_EMAIL_ADDRESS\n```\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u8a2d\u7f6e\u61c9\u7528\u9ed8\u8a8d\u6191\u64da](https://cloud.google.com/docs/authentication/provide-credentials-adc?hl=zh-cn) \u3002\n- \u4f7f\u7528 `--auto-iam-authn` \u6a19\u8a8c\u5553\u52d5 Cloud SQL Auth \u4ee3\u7406\u3002\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- \uff1a\u7528\u65bc\u6a19\u8b58 Cloud SQL \u5be6\u4f8b\u7684\u9023\u63a5\u5b57\u7b26\u4e32\u3002\u5982\u679c\u60a8\u4e0d\u4f7f\u7528\u9ed8\u8a8d PostgreSQL \u7aef\u53e3\uff0c\u8acb\u6307\u5b9a\u7aef\u53e3\u865f\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u627e\u5230\u4e26\u69cb\u5efa\u6b64\u5b57\u7b26\u4e32\uff0c\u8acb\u53c3\u95b1 [\u7528\u65bc\u5c0d Cloud SQL Auth \u4ee3\u7406\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u9078\u9805](https://cloud.google.com/sql/docs/postgres/connect-auth-proxy?hl=zh-cn#authentication-options) \u3002\n```\n./cloud-sql-proxy --auto-iam-authn INSTANCE_CONNECTION_NAME\n```\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u5553\u52d5\u4ee3\u7406\uff0c\u8acb\u53c3\u95b1 [\u5553\u52d5 Cloud SQL Auth \u4ee3\u7406](https://cloud.google.com/sql/docs/postgres/connect-auth-proxy?hl=zh-cn#start-proxy) \u3002 **\u8b66\u544a** \uff1a\u5982\u679c\u60a8\u5c07 Cloud SQL Auth \u4ee3\u7406\u4f5c\u7232\u670d\u52d9\u904b\u884c\uff0c\u8acb\u6ce8\u610f\u5b83\u6703\u4ee3\u8868\u60a8\u7684\u61c9\u7528\u8acb\u6c42\u8a2a\u554f\u4ee4\u724c\u3002\u56e0\u6b64\uff0c\u8acb\u78ba\u4fdd\u53ea\u6709\u53d7\u4fe1\u4efb\u7684\u7528\u6236\u624d\u80fd\u8a2a\u554f Cloud SQL Auth \u4ee3\u7406\u6b63\u5728\u5075\u807d\u7684\u5730\u5740\u548c\u7aef\u53e3\u6216 Unix \u5957\u63a5\u5b57\u3002\n- \u7576\u60a8\u6e96\u5099\u597d\u4f7f\u7528 Cloud SQL Auth \u4ee3\u7406\u9023\u63a5\u5230\u5be6\u4f8b\u6642\uff0c\u8acb\u4f7f\u7528 `psql` \u5ba2\u6236\u7aef\u767b\u9304\u3002\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- \uff1aCloud SQL Auth \u4ee3\u7406\u4f7f\u7528\u7684 IP \u5730\u5740\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cCloud SQL Auth \u4ee3\u7406\u4f7f\u7528`127.0.0.1`\u7684 localhost \u5730\u5740\uff0c\u4f46\u60a8\u53ef\u4ee5\u5728\u5553\u52d5 Cloud SQL Auth \u4ee3\u7406\u6642\u5206\u914d\u5176\u4ed6 IP \u5730\u5740\u3002\n- \uff1a\u5c0d\u65bc IAM\uff0c\u7528\u6236\u540d\u662f\u7528\u6236\u7684\u5b8c\u6574\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\u3002\u5c0d\u65bc\u670d\u52d9\u8cec\u865f\uff0c\u9019\u662f\u670d\u52d9\u8cec\u865f\u7684\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\uff08\u4e0d\u5e36`.gserviceaccount.com`\u57df\u540d\u5f8c\u7db4\uff09\u3002\n- \uff1a\u53ef\u9078\u3002\u5982\u679c\u60a8\u5728\u5be6\u4f8b\u9023\u63a5\u5b57\u7b26\u4e32\u4e2d\u6307\u5b9a\u4e86\u5176\u4ed6\u7aef\u53e3\uff0c\u8acb\u6307\u5b9a\u8a72\u7aef\u53e3\u865f\u3002\n- \uff1a\u8981\u9023\u63a5\u7684\u6578\u64da\u5eab\u540d\u7a31\u3002\n\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\npsql -h HOSTNAME \\\u00a0-U USERNAME \\\u00a0--port PORT_NUMBER \\\u00a0--dbname=DATABASE_NAME\u00a0\n```\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u9023\u63a5\u5230 Cloud SQL Auth \u4ee3\u7406\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528 psql \u5ba2\u6236\u7aef\u9023\u63a5](https://cloud.google.com/sql/docs/postgres/connect-auth-proxy?hl=zh-cn#connect-to-proxy) \u3002 [  cloudsql/postgres/database-sql/connect_connector_iam_authn.go ](https://github.com/GoogleCloudPlatform/golang-samples/blob/HEAD/cloudsql/postgres/database-sql/connect_connector_iam_authn.go) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/golang-samples/blob/HEAD/cloudsql/postgres/database-sql/connect_connector_iam_authn.go) \n```\nimport (\u00a0 \u00a0 \u00a0 \u00a0 \"context\"\u00a0 \u00a0 \u00a0 \u00a0 \"database/sql\"\u00a0 \u00a0 \u00a0 \u00a0 \"fmt\"\u00a0 \u00a0 \u00a0 \u00a0 \"log\"\u00a0 \u00a0 \u00a0 \u00a0 \"net\"\u00a0 \u00a0 \u00a0 \u00a0 \"os\"\u00a0 \u00a0 \u00a0 \u00a0 \"cloud.google.com/go/cloudsqlconn\"\u00a0 \u00a0 \u00a0 \u00a0 \"github.com/jackc/pgx/v5\"\u00a0 \u00a0 \u00a0 \u00a0 \"github.com/jackc/pgx/v5/stdlib\")func connectWithConnectorIAMAuthN() (*sql.DB, error) {\u00a0 \u00a0 \u00a0 \u00a0 mustGetenv := func(k string) string {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 v := os.Getenv(k)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 if v == \"\" {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 log.Fatalf(\"Warning: %s environment variable not set.\", k)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 return v\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 // Note: Saving credentials in environment variables is convenient, but not\u00a0 \u00a0 \u00a0 \u00a0 // secure - consider a more secure solution such as\u00a0 \u00a0 \u00a0 \u00a0 // Cloud Secret Manager (https://cloud.google.com/secret-manager) to help\u00a0 \u00a0 \u00a0 \u00a0 // keep secrets safe.\u00a0 \u00a0 \u00a0 \u00a0 var (\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 dbUser \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 = mustGetenv(\"DB_IAM_USER\") \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0// e.g. 'service-account-name@project-id.iam'\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 dbName \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 = mustGetenv(\"DB_NAME\") \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0// e.g. 'my-database'\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 instanceConnectionName = mustGetenv(\"INSTANCE_CONNECTION_NAME\") // e.g. 'project:region:instance'\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 usePrivate \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 = os.Getenv(\"PRIVATE_IP\")\u00a0 \u00a0 \u00a0 \u00a0 )\u00a0 \u00a0 \u00a0 \u00a0 d, err := cloudsqlconn.NewDialer(context.Background(), cloudsqlconn.WithIAMAuthN())\u00a0 \u00a0 \u00a0 \u00a0 if err != nil {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 return nil, fmt.Errorf(\"cloudsqlconn.NewDialer: %w\", err)\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 var opts []cloudsqlconn.DialOption\u00a0 \u00a0 \u00a0 \u00a0 if usePrivate != \"\" {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 opts = append(opts, cloudsqlconn.WithPrivateIP())\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 dsn := fmt.Sprintf(\"user=%s database=%s\", dbUser, dbName)\u00a0 \u00a0 \u00a0 \u00a0 config, err := pgx.ParseConfig(dsn)\u00a0 \u00a0 \u00a0 \u00a0 if err != nil {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 return nil, err\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 config.DialFunc = func(ctx context.Context, network, instance string) (net.Conn, error) {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 return d.Dial(ctx, instanceConnectionName, opts...)\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 dbURI := stdlib.RegisterConnConfig(config)\u00a0 \u00a0 \u00a0 \u00a0 dbPool, err := sql.Open(\"pgx\", dbURI)\u00a0 \u00a0 \u00a0 \u00a0 if err != nil {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 return nil, fmt.Errorf(\"sql.Open: %w\", err)\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 return dbPool, nil}\n``` [  cloud-sql/postgres/servlet/src/main/java/com/example/cloudsql/ConnectorIamAuthnConnectionPoolFactory.java ](https://github.com/GoogleCloudPlatform/java-docs-samples/blob/HEAD/cloud-sql/postgres/servlet/src/main/java/com/example/cloudsql/ConnectorIamAuthnConnectionPoolFactory.java) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/java-docs-samples/blob/HEAD/cloud-sql/postgres/servlet/src/main/java/com/example/cloudsql/ConnectorIamAuthnConnectionPoolFactory.java) \n```\nimport com.zaxxer.hikari.HikariConfig;import com.zaxxer.hikari.HikariDataSource;import javax.sql.DataSource;public class ConnectorIamAuthnConnectionPoolFactory extends ConnectionPoolFactory {\u00a0 // Note: Saving credentials in environment variables is convenient, but not\u00a0 // secure - consider a more secure solution such as\u00a0 // Cloud Secret Manager (https://cloud.google.com/secret-manager) to help\u00a0 // keep secrets safe.\u00a0 private static final String INSTANCE_CONNECTION_NAME =\u00a0 \u00a0 \u00a0 System.getenv(\"INSTANCE_CONNECTION_NAME\");\u00a0 private static final String DB_IAM_USER = System.getenv(\"DB_IAM_USER\");\u00a0 private static final String DB_NAME = System.getenv(\"DB_NAME\");\u00a0 public static DataSource createConnectionPool() {\u00a0 \u00a0 // The configuration object specifies behaviors for the connection pool.\u00a0 \u00a0 HikariConfig config = new HikariConfig();\u00a0 \u00a0 // The following URL is equivalent to setting the config options below:\u00a0 \u00a0 // jdbc:postgresql:///<DB_NAME>?cloudSqlInstance=<INSTANCE_CONNECTION_NAME>&\u00a0 \u00a0 // socketFactory=com.google.cloud.sql.postgres.SocketFactory&user=<DB_IAM_USER>&\u00a0 \u00a0 // password=password\u00a0 \u00a0 // See the link below for more info on building a JDBC URL for the Cloud SQL JDBC Socket Factory\u00a0 \u00a0 // https://github.com/GoogleCloudPlatform/cloud-sql-jdbc-socket-factory#creating-the-jdbc-url\u00a0 \u00a0 // Configure which instance and what database to connect with.\u00a0 \u00a0 config.setJdbcUrl(String.format(\"jdbc:postgresql:///%s\", DB_NAME));\u00a0 \u00a0 config.addDataSourceProperty(\"socketFactory\", \"com.google.cloud.sql.postgres.SocketFactory\");\u00a0 \u00a0 config.addDataSourceProperty(\"cloudSqlInstance\", INSTANCE_CONNECTION_NAME);\u00a0 \u00a0 // If connecting using automatic database authentication, follow the instructions for\u00a0 \u00a0 // connecting using the connector, but set the DB_IAM_USER value to an IAM user or\u00a0 \u00a0 // service account that has been given access to the database.\u00a0 \u00a0 // See https://cloud.google.com/sql/docs/postgres/iam-logins for more details.\u00a0 \u00a0 config.addDataSourceProperty(\"enableIamAuth\", \"true\");\u00a0 \u00a0 config.addDataSourceProperty(\"user\", DB_IAM_USER);\u00a0 \u00a0 // Password must be set to a nonempty value to bypass driver validation errors.\u00a0 \u00a0 config.addDataSourceProperty(\"password\", \"password\");\u00a0 \u00a0 // Explicitly set sslmode to disable to prevent driver from hanging.\u00a0 \u00a0 // The Java Connector will handle SSL so it is unneccesary to enable it at the driver level.\u00a0 \u00a0 config.addDataSourceProperty(\"sslmode\", \"disable\");\u00a0 \u00a0 // ... Specify additional connection properties here.\u00a0 \u00a0 // ...\u00a0 \u00a0 // Initialize the connection pool using the configuration object.\u00a0 \u00a0 return new HikariDataSource(config);\u00a0 }}\n``` [  r2dbc/postgres/src/test/java/com/google/cloud/sql/core/R2dbcPostgresIamAuthIntegrationTests.java ](https://github.com/GoogleCloudPlatform/cloud-sql-jdbc-socket-factory/blob/HEAD/r2dbc/postgres/src/test/java/com/google/cloud/sql/core/R2dbcPostgresIamAuthIntegrationTests.java) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/cloud-sql-jdbc-socket-factory/blob/HEAD/r2dbc/postgres/src/test/java/com/google/cloud/sql/core/R2dbcPostgresIamAuthIntegrationTests.java) \n```\nprivate static final String CONNECTION_NAME = System.getenv(\"POSTGRES_IAM_CONNECTION_NAME\");private static final String DB_NAME = System.getenv(\"POSTGRES_DB\");private static final String DB_USER = System.getenv(\"POSTGRES_IAM_USER\");\u00a0 // Set up ConnectionFactoryOptions\u00a0 ConnectionFactoryOptions options =\u00a0 \u00a0 \u00a0 ConnectionFactoryOptions.builder()\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .option(DRIVER, \"gcp\")\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .option(PROTOCOL, \"postgresql\")\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 // Password must be set to a nonempty value to bypass driver validation errors\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .option(PASSWORD, \"password\")\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .option(USER, DB_USER)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .option(DATABASE, DB_NAME)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .option(HOST, CONNECTION_NAME)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .option(ENABLE_IAM_AUTH, true)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .build();\u00a0 // Initialize connection pool\u00a0 ConnectionFactory connectionFactory = ConnectionFactories.get(options);\u00a0 ConnectionPoolConfiguration configuration =\u00a0 \u00a0 \u00a0 ConnectionPoolConfiguration.builder(connectionFactory).build();\u00a0 this.connectionPool = new ConnectionPool(configuration);\n``` [  cloud-sql/postgres/sqlalchemy/connect_connector_auto_iam_authn.py ](https://github.com/GoogleCloudPlatform/python-docs-samples/blob/HEAD/cloud-sql/postgres/sqlalchemy/connect_connector_auto_iam_authn.py) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/python-docs-samples/blob/HEAD/cloud-sql/postgres/sqlalchemy/connect_connector_auto_iam_authn.py) \n```\nimport osfrom google.cloud.sql.connector import Connector, IPTypesimport pg8000import sqlalchemydef connect_with_connector_auto_iam_authn() -> sqlalchemy.engine.base.Engine:\u00a0 \u00a0 \"\"\"\u00a0 \u00a0 Initializes a connection pool for a Cloud SQL instance of Postgres.\u00a0 \u00a0 Uses the Cloud SQL Python Connector with Automatic IAM Database Authentication.\u00a0 \u00a0 \"\"\"\u00a0 \u00a0 # Note: Saving credentials in environment variables is convenient, but not\u00a0 \u00a0 # secure - consider a more secure solution such as\u00a0 \u00a0 # Cloud Secret Manager (https://cloud.google.com/secret-manager) to help\u00a0 \u00a0 # keep secrets safe.\u00a0 \u00a0 instance_connection_name = os.environ[\u00a0 \u00a0 \u00a0 \u00a0 \"INSTANCE_CONNECTION_NAME\"\u00a0 \u00a0 ] \u00a0# e.g. 'project:region:instance'\u00a0 \u00a0 db_iam_user = os.environ[\"DB_IAM_USER\"] \u00a0# e.g. 'sa-name@project-id.iam'\u00a0 \u00a0 db_name = os.environ[\"DB_NAME\"] \u00a0# e.g. 'my-database'\u00a0 \u00a0 ip_type = IPTypes.PRIVATE if os.environ.get(\"PRIVATE_IP\") else IPTypes.PUBLIC\u00a0 \u00a0 # initialize Cloud SQL Python Connector object\u00a0 \u00a0 connector = Connector()\u00a0 \u00a0 def getconn() -> pg8000.dbapi.Connection:\u00a0 \u00a0 \u00a0 \u00a0 conn: pg8000.dbapi.Connection = connector.connect(\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 instance_connection_name,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"pg8000\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 user=db_iam_user,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 db=db_name,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 enable_iam_auth=True,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ip_type=ip_type,\u00a0 \u00a0 \u00a0 \u00a0 )\u00a0 \u00a0 \u00a0 \u00a0 return conn\u00a0 \u00a0 # The Cloud SQL Python Connector can be used with SQLAlchemy\u00a0 \u00a0 # using the 'creator' argument to 'create_engine'\u00a0 \u00a0 pool = sqlalchemy.create_engine(\u00a0 \u00a0 \u00a0 \u00a0 \"postgresql+pg8000://\",\u00a0 \u00a0 \u00a0 \u00a0 creator=getconn,\u00a0 \u00a0 \u00a0 \u00a0 # ...\u00a0 \u00a0 )\u00a0 \u00a0 return pool\n```\n\u5982\u9700\u6253\u958b Cloud SQL Python \u9023\u63a5\u5668\u7684\u4ea4\u4e92\u5f0f\u793a\u4f8b\uff0c\u8acb\u9ede\u64ca [\u6b64\u8655](https://colab.research.google.com/github/GoogleCloudPlatform/cloud-sql-python-connector/blob/main/samples/notebooks/postgres_python_connector.ipynb?hl=zh-cn#scrollTo=GCsS4f5UCYUa) \u3002\n## \u4f7f\u7528\u624b\u52d5 IAM \u6578\u64da\u5eab\u8eab\u4efd\u9a57\u8b49\u767b\u9304\n**\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u6253\u7b97\u4f7f\u7528 Cloud SQL Auth \u4ee3\u7406\u3001Go \u9023\u63a5\u5668\u3001Java \u9023\u63a5\u5668\u6216 Python \u9023\u63a5\u5668\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528\u81ea\u52d5 IAM \u6578\u64da\u5eab\u8eab\u4efd\u9a57\u8b49\u767b\u9304](https://cloud.google.com/sql/docs/postgres/iam-logins?hl=zh-cn#log-in-with-automatic) \u3002\n\u7528\u6236\u6216\u61c9\u7528\u53ef\u4ee5\u9019\u6a23\u5411\u6578\u64da\u5eab\u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff1a\u4f7f\u7528 IAM\uff0c\u5411 Google Cloud \u624b\u52d5\u8acb\u6c42\u8a2a\u554f\u4ee4\u724c\u4e26\u5c07\u5176\u63d0\u4f9b\u7d66\u6578\u64da\u5eab\u3002\u4f7f\u7528 [gcloud CLI](https://cloud.google.com/sdk/gcloud?hl=zh-cn) \uff0c\u60a8\u53ef\u4ee5\u660e\u78ba\u8acb\u6c42\u4e00\u500b\u5177\u6709 Cloud SQL Admin API \u7bc4\u570d\u7684 [OAuth 2.0](https://developers.google.com/identity/protocols/oauth2?hl=zh-cn) \u4ee4\u724c\uff0c\u7528\u65bc\u767b\u9304\u6578\u64da\u5eab\u3002\u7576\u60a8\u4f7f\u7528\u624b\u52d5 IAM \u6578\u64da\u5eab\u8eab\u4efd\u9a57\u8b49\u4ee5\u6578\u64da\u5eab\u7528\u6236\u8eab\u4efd\u767b\u9304\u6642\uff0c\u5c07\u60a8\u7684\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\u7528\u4f5c\u7528\u6236\u540d\uff0c\u4e26\u5c07\u8a2a\u554f\u4ee4\u724c\u7528\u4f5c\u5bc6\u78bc\u3002\u60a8\u53ef\u4ee5\u5c07\u6b64\u65b9\u6cd5\u8207\u6578\u64da\u5eab\u7684\u76f4\u63a5\u9023\u63a5\u6216 Cloud SQL \u9023\u63a5\u5668\u642d\u914d\u4f7f\u7528\u3002\n\u5728\u6b64\u904e\u7a0b\u4e2d\uff0c\u60a8\u5c07\u5411 Google Cloud \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u6c42\u8a2a\u554f\u4ee4\u724c\uff0c\u7136\u5f8c\u901a\u904e\u5c07\u8a72\u4ee4\u724c\u4f5c\u7232 IAM \u6578\u64da\u5eab\u7528\u6236\u7684\u5bc6\u78bc\u50b3\u5165\u4f86\u9023\u63a5\u5230\u6578\u64da\u5eab\u3002\u8acb\u6309\u7167\u4ee5\u4e0b\u6b65\u9a5f\u5728\u4e0d\u4f7f\u7528 [Cloud SQL Auth \u4ee3\u7406](https://cloud.google.com/sql/docs/sql-proxy?hl=zh-cn) \u7684\u60c5\u6cc1\u4e0b\u9032\u884c\u9023\u63a5\u3002\n\u5c0d\u65bc\u9019\u4e9b\u6b65\u9a5f\uff0c\u60a8\u5fc5\u9808\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n\u5982\u679c\u60a8\u8981\u9023\u63a5\u5230\u5177\u6709\u516c\u5171 IP \u7684\u5be6\u4f8b\uff0c\u8acb\u6388\u4e88\u5c0d\u5be6\u4f8b\u7684\u5916\u90e8\u8a2a\u554f\u6b0a\u9650\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u6388\u6b0a\u60a8\u6a5f\u5668\u7684 IP \u5730\u5740\u7528\u65bc\u516c\u5171 IP \u5730\u5740](https://cloud.google.com/sql/docs/postgres/authorize-networks?hl=zh-cn#console) \u3002\n\u5982\u679c\u8981\u9023\u63a5\u5230\u5177\u6709\u5c08\u7528 IP \u7684\u5be6\u4f8b\uff0c\u8acb\u5728 Virtual Private Cloud (VPC) \u7db2\u7d61\u4e2d\u904b\u884c\u8a72\u547d\u4ee4\u3002\n\u4f7f\u7528 [gcloud sql generate-login-token](https://cloud.google.com/sdk/gcloud/reference/sql/generate-login-token?hl=zh-cn) \u547d\u4ee4\u751f\u6210\u8eab\u4efd\u9a57\u8b49\u4ee4\u724c\u3002\n\u5982\u9700\u4f7f\u7528\u624b\u52d5 IAM \u6578\u64da\u5eab\u8eab\u4efd\u9a57\u8b49\u767b\u9304\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u5411 Google Cloud \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 **User** \u4f7f\u7528 [gcloud auth login](https://cloud.google.com/sdk/gcloud/reference/auth/login?hl=zh-cn) \u5411 IAM \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528\u7528\u6236\u8cec\u865f\u9032\u884c\u6388\u6b0a](https://cloud.google.com/sdk/docs/authorizing?hl=zh-cn#user-account) \u3002 **\u670d\u52d9\u8cec\u865f** \u4f7f\u7528 [gcloud auth activate-service-account](https://cloud.google.com/sdk/gcloud/reference/auth/activate-service-account?hl=zh-cn) \u5411 IAM \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528\u670d\u52d9\u8cec\u865f\u9032\u884c\u6388\u6b0a](https://cloud.google.com/sdk/docs/authorizing?hl=zh-cn#service-account) \u3002\n- \u8acb\u6c42\u8a2a\u554f\u4ee4\u724c\u4e26\u4f7f\u7528\u5ba2\u6236\u7aef\u767b\u9304\u3002 **\u8b66\u544a** \uff1a\u60a8\u53ef\u4ee5\u4f7f\u7528 OAuth 2.0 \u4ee4\u724c\u4ee3\u8868\u60a8\u767c\u51fa\u7d93\u904e\u8eab\u4efd\u9a57\u8b49\u7684\u8acb\u6c42\u3002\u8acb\u52d9\u5fc5\u78ba\u4fdd\u5176\u5b89\u5168\u6027\uff0c\u4e26\u6ce8\u610f\u5b58\u5132\u4f4d\u7f6e\u3002\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- \uff1a\u5be6\u4f8b\u7684 IP \u5730\u5740\uff0c\u5373\u516c\u5171 IP \u5730\u5740\u6216\u5c08\u7528 IP \u5730\u5740\u3002\n- \uff1a\u5c0d\u65bc IAM\uff0c\u7528\u6236\u540d\u662f\u7528\u6236\u7684\u5b8c\u6574\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\u3002\u5c0d\u65bc\u670d\u52d9\u8cec\u865f\uff0c\u9019\u662f\u670d\u52d9\u8cec\u865f\u7684\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\uff08\u4e0d\u5e36`.gserviceaccount.com`\u57df\u540d\u5f8c\u7db4\uff09\u3002\n- \uff1a\u8981\u9023\u63a5\u7684\u6578\u64da\u5eab\u540d\u7a31\u3002\n```\n\u00a0PGPASSWORD=`gcloud sql generate-login-token` \\\u00a0psql \"sslmode=require \\\u00a0hostaddr=HOSTNAME \\\u00a0user=USERNAME \\\u00a0dbname=DATABASE_NAME\" \\\u00a0--no-password\u00a0\n```\u5982\u679c Cloud SQL \u5be6\u4f8b\u4e0a\u7684 [ssl_mode](https://cloud.google.com/sql/docs/postgres/configure-ssl-instance?hl=zh-cn#enforcing-ssl) \u914d\u7f6e\u7232 `TRUSTED_CLIENT_CERTIFICATE_REQUIRED` \uff0c\u6211\u5011\u5efa\u8b70\u60a8 [\u4f7f\u7528\u81ea\u52d5 IAM \u6578\u64da\u5eab\u8eab\u4efd\u9a57\u8b49\u767b\u9304](#log-in-with-automatic) \uff0c\u4ee5\u5f37\u5236\u57f7\u884c\u5ba2\u6236\u7aef\u8eab\u4efd\u9a57\u8b49\u3002 **\u6ce8\u610f** \uff1a\u4e0d\u80fd\u76f4\u63a5\u5c07 OAuth 2.0 \u4ee4\u724c\u8f38\u5165\u6216\u7c98\u8cbc\u5230\u5bc6\u78bc\u5b57\u6bb5\u4e2d\uff0c\u56e0\u7232\u8a72\u4ee4\u724c\u9577\u5ea6\u8d85\u904e\u5bc6\u78bc\u5b57\u6bb5\u7684\u6700\u5927\u5927\u5c0f\u3002\u4f7f\u7528\u74b0\u5883\u8b8a\u91cf\u5c07\u8eab\u4efd\u9a57\u8b49\u4ee4\u724c\u50b3\u905e\u7d66\u547d\u4ee4\u3002\u63d0\u4f9b\u7684\u547d\u4ee4\u9069\u7528\u65bc Unix/Linux \u74b0\u5883\u3002\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f Microsoft Windows\uff0c\u8acb\u66ff\u63db\u7232 Windows \u74b0\u5883\u8b8a\u91cf\u8a2d\u7f6e\u3002## \u5f8c\u7e8c\u6b65\u9a5f\n- \u8a73\u7d30\u77ad\u89e3 [IAM \u6578\u64da\u5eab\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/sql/docs/postgres/iam-authentication?hl=zh-cn) \u3002\n- \u77ad\u89e3\u5982\u4f55 [\u5728\u5be9\u8988\u65e5\u8a8c\u4e2d\u5553\u7528\u548c\u67e5\u770b\u767b\u9304\u4fe1\u606f](https://cloud.google.com/sql/docs/postgres/add-manage-iam-users?hl=zh-cn#viewing-login-audit-logs) \u3002\n- \u77ad\u89e3\u5982\u4f55 [\u5275\u5efa\u4f7f\u7528 Cloud SQL IAM \u6578\u64da\u5eab\u8eab\u4efd\u9a57\u8b49\u7684\u7528\u6236\u548c\u670d\u52d9\u8cec\u865f](https://cloud.google.com/sql/docs/postgres/add-manage-iam-users?hl=zh-cn#creating-a-database-user) \u3002\n- \u77ad\u89e3\u5982\u4f55 [\u7ba1\u7406\u7528\u6236\u548c\u670d\u52d9\u8cec\u865f\u4ee5\u4f7f\u7528 IAM \u6578\u64da\u5eab\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/sql/docs/postgres/add-manage-iam-users?hl=zh-cn) \u3002", "guide": "Cloud SQL"}