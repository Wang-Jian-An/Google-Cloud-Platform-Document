{"title": "Cloud SQL - Find and fix foreign key violations", "url": "https://cloud.google.com/sql/docs/postgres/fix-foreign-keys", "abstract": "# Cloud SQL - Find and fix foreign key violations\nTo check for a foreign key where the corresponding primary key is missing, run the following command:\n```\n\u00a0 WITH q AS (\u00a0 \u00a0 \u00a0 SELECT conrelid::regclass AS fk_table, \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 confrelid::regclass AS pk_table, \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 format('(%s)',(select string_agg(format('fk.%I', attname), ', ') \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 FROM pg_attribute a \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 JOIN unnest(conkey) ia(nr) ON ia.nr = a.attnum\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 WHERE attrelid = conrelid)) AS fk_fields, \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 format('(%s)',(select string_agg(format('pk.%I', attname), ', ') \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 FROM pg_attribute a \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 JOIN unnest(confkey) ia(nr) ON ia.nr = a.attnum\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 WHERE attrelid = confrelid)) AS pk_fields, \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 pg_get_constraintdef(oid)\u00a0 \u00a0 \u00a0 \u00a0 FROM pg_constraint\u00a0 \u00a0 \u00a0 WHERE contype='f'\u00a0 )\u00a0 SELECT format(\u00a0 $sql$\u00a0 DO $$ BEGIN RAISE NOTICE 'checking Foreign Key %3$s%1$s ==> %4$s%2$s'; END;$$;\u00a0 SELECT %1$s, %2$s \u00a0 \u00a0 FROM %3$s AS fk\u00a0 \u00a0 LEFT JOIN %4$s AS pk ON %1$s = %2$s \u00a0 \u00a0 WHERE %2$s IS NULL\u00a0 \u00a0 \u00a0 AND \u00a0%1$s IS NOT NULL \u00a0/* any NULL on FK side bypasses FK constraint by design */\u00a0 /* use limit for testing, or detecting that \"there is a problem in this table */\u00a0 -- \u00a0LIMIT 10\u00a0 $sql$, fk_fields, pk_fields, fk_table, pk_table\u00a0 )\u00a0 \u00a0 FROM q\u00a0 \\gexec\u00a0 \n```\nThe output of the script will be similar to the following. If there is no output, there are no violations and you have successfully rebuilt your index.\n```\n\u00a0 id | pk_id \u00a0 ----+-------\u00a0 \u00a0 \u00a0 | \u00a0 \u00a0 4\u00a0 (1 row)\u00a0 \n```\nIn the above output, the first column shows the primary key columns, in this example, a column named `id` . The second column is the referencing column for the foreign key. This means there is a row, `pk_id=4` , for which a parent primary key doesn't exist. You can decide if these keys are valid and if they are not, you can delete them", "content": ".", "guide": "Cloud SQL"}