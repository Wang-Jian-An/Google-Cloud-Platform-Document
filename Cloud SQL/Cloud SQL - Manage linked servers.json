{"title": "Cloud SQL - Manage linked servers", "url": "https://cloud.google.com/sql/docs/sqlserver/manage-linked-servers", "abstract": "# Cloud SQL - Manage linked servers\nThis page provides information about how to manage linked servers on your Cloud SQL instance, including enrolling an instance, adding a linked server, and querying a linked server.\n", "content": "## Enroll your instance to allow linked servers\nTo add the `cloudsql enable linked servers` flag to your instance, use the following command:\n```\ngcloud sql instances patch INSTANCE_NAME --database-flags=\"cloudsql enable linked servers\"=on\n```\nReplace `` with the name of the instance that you want to use for linking servers.\nFor more information, see [configure databaseflags](https://cloud.google.com/sql/docs/sqlserver/flags#config) .\n## Add a linked server\nTo add a linked server, run the Transact-SQL `sp_addlinkedserver` command:\n```\nEXEC master.dbo.sp_addlinkedserver\u00a0 \u00a0 @server = N'LINKED_SERVER_NAME',\u00a0 \u00a0 @srvproduct=N'',\u00a0 \u00a0 @provider=N'SQLNCLI',\u00a0 \u00a0 @datasrc=N'TARGET_SERVER_ID'\n```\nReplace the following:\n- with the name of the linked server to create.\n- with the network name, DNS name, or IP address for the linked server. For the instance name, use the format`servername\\instancename`. If your instance uses a non-standard port, add the port number. For example,`servername\\instancename, 8080`.\nTo add user mapping for a user who is currently logged in, run the following command:\n```\nEXEC master.dbo.sp_addlinkedsrvlogin\u00a0 \u00a0 @rmtsrvname=N'LINKED_SERVER_NAME',\u00a0 \u00a0 @useself=N'True'\n```\nReplace with the name of the linked server.\nTo create or update the default remote login and password, and apply it to all local logins, run the following command:\n```\nEXEC master.dbo.sp_addlinkedsrvlogin\u00a0 \u00a0 @rmtsrvname=N'LINKED_SERVER_NAME',\u00a0 \u00a0 @useself=N'False',\u00a0 \u00a0 @locallogin=N'LOGIN',\u00a0 \u00a0 @rmtuser=N'USER_ID',\u00a0 \u00a0 @rmtpassword='PASSWORD';\n```\nReplace the following:\n- with the name of the linked server.\n- with the login for the local server.`locallogin`is sysname, with a default of NULL. NULL specifies that this entry applies to all local logins that connect to`rmtsrvname`. If not NULL,`locallogin`is either a SQL Server login or a Windows login. If you use a Windows login, it must have access to the SQL Server either directly, or through its membership in a Windows group that has access.\n- with the user logging in.\n- with the user password.## Add a linked server with an encrypted connection\nTo add a linked server using an encrypted connection, run the Transact-SQL `sp_addlinkedserver` command:\n```\nEXEC master.dbo.sp_addlinkedserver\u00a0 \u00a0 @server = N'LINKED_SERVER_NAME',\u00a0 \u00a0 @srvproduct=N'',\u00a0 \u00a0 @provider=N'SQLNCLI',\u00a0 \u00a0 @datasrc=N'TARGET_SERVER_ID,\u00a0 \u00a0 @provstr=N'Encrypt=yes;'\n```\nReplace the following:\n- with the name of the linked server to create.\n- with the name of the target server, or the IP address and port number for the target server.\nIf the name of the server is different from the name in the certificate, you need to indicate that the SQL Server can trust the server certificate. To update the provider string, run the following command:\n```\nEXEC master.dbo.sp_addlinkedserver\u00a0 \u00a0 @server = N'LINKED_SERVER_NAME',\u00a0 \u00a0 @srvproduct=N'',\u00a0 \u00a0 @provider=N'SQLNCLI',\u00a0 \u00a0 @datasrc=N'TARGET_SERVER_ID,\u00a0 \u00a0 @provstr=N'Encrypt=yes;TrustServerCertificate=yes;'\n```\nReplace the following:\n- with the name of the linked server to create.\n- with the name of the target server, or the IP address and port number for the target server.## Linked server queries\nCloud SQL supports the use of four-part names to query linked servers (server name, database name, schema name, and object name), in addition to the following commands:\n- [OPENQUERY](https://learn.microsoft.com/en-us/sql/t-sql/functions/openquery-transact-sql?view=sql-server-ver16) executes a query on a specified server.\n- [EXECUTE](https://learn.microsoft.com/en-us/sql/t-sql/language-elements/execute-transact-sql?view=sql-server-ver16) allows you to run dynamic SQL against a linked server.\n**Note:** Cloud SQL doesn't support OPENROWSET as a way to query a linked server.\nFor more information, see [Compare query remote executionoptions](https://learn.microsoft.com/en-us/sql/relational-databases/linked-servers/linked-servers-openquery-openrowset-exec-at?view=sql-server-ver16) .\n## Enable remote procedure calls on a linked server\nRemote procedure calls (RPC) let you run stored procedures on linked servers. To add RPC, you run the Transact-SQL [sp_serveroption](https://learn.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-serveroption-transact-sql?view=sql-server-ver16) command with an RPC argument. There are two RPC arguments:\n- `rpc`enables RPC from the specified server.\n- `rpc out`enables RPC to the specified server.\nUse the following `sp_serveroption` command with the `rpc` argument to enable RPC from :\n```\nEXEC sp_serveroption\u00a0 \u00a0 @server='LINKED_SERVER_NAME',\u00a0 \u00a0 @optname='rpc',\u00a0 \u00a0 @optvalue='TRUE'\n```\nReplace with the name of the linked server.\nUse the following `sp_serveroption` command with the `rpc out` argument to enable RPC:\n```\nEXEC sp_serveroption\u00a0 \u00a0 @server='LINKED_SERVER_NAME',\u00a0 \u00a0 @optname='rpc out',\u00a0 \u00a0 @optvalue='TRUE'\n```\nReplace with the name of the linked server.\n## Remove the user mapping for a linked server\nTo remove a user mapping that you previously added, run the following command:\n```\nEXEC master.dbo.sp_droplinkedsrvlogin\u00a0 \u00a0 @rmtsrvname=N'LINKED_SERVER_NAME',\u00a0 \u00a0 @locallogin=N'LOGIN';\n```\nReplace the following:\n- with the name of the linked server to drop.\n- with the login for the local server.`locallogin`is sysname, with a default of NULL. NULL specifies that this entry applies to all local logins that connect to`rmtsrvname`. If not NULL,`locallogin`is either a SQL Server login or a Windows login. If you use a Windows login, it must have access to the SQL Server either directly, or through its membership in a Windows group that has access.## Remove an enrolled instance from allowing linked servers\nTo remove linked servers, do the following:\n- Drop existing linked servers with the Transact-SQL [sp_dropserver](https://learn.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-dropserver-transact-sql?view=sql-server-ver16) stored procedure.\n- Remove the `cloudsql enable linked servers` flag to remove an enrolled instance.```\ngcloud sql instances patch INSTANCE_NAME --database-flags=\"cloudsql enable linked servers\"=off\n```Replace `` with the name of the instance where you want to remove linked servers.Alternatively, you can run the following command to clear all database flags:```\ngcloud sql instances patch INSTANCE_NAME --clear-database-flags\n```Replace `` with the name of the instance where you want to remove linked servers.## Troubleshoot\n| Error message                        | Troubleshooting                                                                                                                                                          |\n|:------------------------------------------------------------------------------------------------------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| Msg 7411, Level 16, State 1, Line 25 Server 'LINKED_SERVER_NAME' is not configured for DATA ACCESS.  | The DataAccess option is disabled. Run the following command to enable data access: EXEC sp_serveroption @server='LINKED_SERVER_NAME', @optname='data access', @optvalue='TRUE' Replace LINKED_SERVER_NAME with the name of the linked server.                                                                                                 |\n| Access to the remote server is denied because no login-mapping exists. (Microsoft SQL Server, Error: 7416) | If you have this issue while establishing an encrypted connection, you need to try another way to provide the user ID when you access the linked server. To do this, run the following command: EXEC master.dbo.sp_addlinkedserver @server = N'LINKED_SERVER_NAME', @srvproduct= N'', @provider= N'SQLNCLI', @datasrc= N'TARGET_SERVER_ID', @provstr= N'Encrypt=yes;TrustServerCertificate=yes;User ID=USER_ID' Replace the following: LINKED_SERVER_NAME with the name of the linked server. TARGET_SERVER_ID with the name of the target server, or the IP address and port number for the target server. USER_ID with the user logging in. |\n## What's next\n- Learn about [using linked servers](/sql/docs/sqlserver/linked-servers) .", "guide": "Cloud SQL"}