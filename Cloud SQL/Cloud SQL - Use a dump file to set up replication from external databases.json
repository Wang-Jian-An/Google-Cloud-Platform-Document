{"title": "Cloud SQL - Use a dump file to set up replication from external databases", "url": "https://cloud.google.com/sql/docs/mysql/replication/dump-file-replication-from-external", "abstract": "# Cloud SQL - Use a dump file to set up replication from external databases\nThis page describes the process for setting up replication when you have a dump file that you created from your external server.\nYou must complete all the steps on this page. When finished, you can administer and monitor the source representation instance the same way as you would any other Cloud SQL instance.\n", "content": "## Before you begin\nBefore you start, you should have [configured the external server](/sql/docs/mysql/replication/configure-replication-from-external#setting_up_the_external_server_for_replication) , created the [source representation instance](/sql/docs/mysql/replication/configure-replication-from-external#setup-source-instance) , and set up the [Cloud SQL replica](/sql/docs/mysql/replication/configure-replication-from-external#setup-replica-instance) .\n## Update permissions for the replication user\nThe replication user on the external server is configured to accept connections from any host ( `%` ). You should update this user account so that it can only be used with the Cloud SQL replica. Open a terminal on the external server and enter these commands:\n```\n\u00a0 \u00a0 UPDATE mysql.user\u00a0 \u00a0 \u00a0 SET Host='NEW_HOST'\u00a0 \u00a0 \u00a0 WHERE Host='OLD_HOST'\u00a0 \u00a0 \u00a0 AND User='USERNAME';\u00a0 \u00a0 \u00a0 GRANT REPLICATION SLAVE, EXECUTE\u00a0 \u00a0 \u00a0 ON *.* TO 'GCP_USERNAME'@'HOST';\u00a0 \u00a0 FLUSH PRIVILEGES;\n```\n```\n\u00a0 \u00a0 UPDATE mysql.user\u00a0 \u00a0 \u00a0 SET Host='192.0.2.0'\u00a0 \u00a0 \u00a0 WHERE Host='%'\u00a0 \u00a0 \u00a0 AND User='replicationUser';\u00a0 \u00a0 \u00a0 GRANT REPLICATION SLAVE, EXECUTE\u00a0 \u00a0 \u00a0 ON *.* TO 'gcp_user'@'gmail.com';\u00a0 \u00a0 FLUSH PRIVILEGES;\n```\n| Property  | Description             |\n|:-------------|:---------------------------------------------------------------|\n| NEW_HOST  | Specify the outgoing IP of the Cloud SQL replica.    |\n| OLD_HOST  | The current value assigned to Host that you want to change. |\n| USERNAME  | The replication user account on the external server.   |\n| GCP_USERNAME | The username for the Google Cloud Platform (GCP) user account. |\n| HOST   | The hostname for the Google Cloud Platform (GCP) user account. |\n## Verify your replication settings\nAfter your setup is complete, ensure that the Cloud SQL replica can replicate from the external server.\nFirst, ensure that your external sync settings are correct. To do this, use the commands below to verify:\n- Connectivity between the Cloud SQL replica and external server\n- Replication user privileges\n- Version compatibility\n- The Cloud SQL replica is not already replicating\n- Binlogs are enabled on the external server\n- A global transaction identifier (GTID) is enabled\nOpen a terminal and enter these commands to verify external sync settings are correct:\n```\ngcloud auth loginACCESS_TOKEN=\"$(gcloud auth print-access-token)\"curl --header \"Authorization: Bearer ${ACCESS_TOKEN}\" \\\u00a0 \u00a0 \u00a0--header 'Content-Type: application/json' \\\u00a0 \u00a0 \u00a0--data '{\u00a0 \u00a0 \u00a0 \u00a0 \u00a0\"syncMode\": \"SYNC_MODE\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0\"skipVerification\": \"SKIP_VERIFICATION\"\u00a0 \u00a0 \u00a0 \u00a0}' \\\u00a0 \u00a0 \u00a0-X POST \\\u00a0 \u00a0 \u00a0https://sqladmin.googleapis.com/sql/v1beta4/projects/PROJECT_ID/instances/REPLICA_INSTANCE/verifyExternalSyncSettings\n```\n```\ngcloud auth loginACCESS_TOKEN=\"$(gcloud auth print-access-token)\"curl --header \"Authorization: Bearer ${ACCESS_TOKEN}\" \\\u00a0 \u00a0 \u00a0--header 'Content-Type: application/json' \\\u00a0 \u00a0 \u00a0--data '{\u00a0 \u00a0 \u00a0 \u00a0 \u00a0\"syncMode\": \"online\",\u00a0 \u00a0 \u00a0 \u00a0}' \\\u00a0 \u00a0 \u00a0-X POST \\\u00a0 \u00a0 \u00a0https://sqladmin.googleapis.com/sql/v1beta4/projects/myproject/instances/myreplica/verifyExternalSyncSettings\n```\n| Property   | Description                                                 |\n|:------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| SYNC_MODE   | verifyExternalSyncSettings verifies that you can keep the Cloud SQL replica and external server in sync after replication is set up. Sync modes include EXTERNAL_SYNC_MODE_UNSPECIFIED, ONLINE, and OFFLINE. |\n| SKIP_VERIFICATION | Whether or not to skip the built-in verification step before syncing your data. Only recommended if you have already verified your replication settings.              |\n| PROJECT_ID  | The ID of your project in Google Cloud.                                          |\n| REPLICA_INSTANCE | The ID of your Cloud SQL replica.                                           |\n## Export your database to a Cloud Storage bucket\nYou can populate a Cloud SQL replica with a `mysqldump` file located in a Cloud Storage bucket. These conditions apply:\n- You must use the`mysqldump`utility bundled with MySQL.\n- While`mysqldump`is running, do not perform any [DDL operations](https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_ddl) on the external server. Doing so could cause inconsistencies in the export file.\nTo export your database to a Cloud Storage bucket, follow these steps:\n- In Google Cloud, [create a Cloud Storage bucket](/storage/docs/creating-buckets) .\n- Open a terminal using a client that connects to the external database server and run the following command.\n```\n\u00a0 \u00a0 mysqldump \\\u00a0 \u00a0 \u00a0 \u00a0 --host=EXTERNAL_HOST \\\u00a0 \u00a0 \u00a0 \u00a0 --port=EXTERNAL_PORT \\\u00a0 \u00a0 \u00a0 \u00a0 --user=USERNAME\\\u00a0 \u00a0 \u00a0 \u00a0 --password=PASSWORD \\\u00a0 \u00a0 \u00a0 \u00a0 --databases=DATABASE_LIST \u00a0\\\u00a0 \u00a0 \u00a0 \u00a0 --hex-blob \\\u00a0 \u00a0 \u00a0 \u00a0 SOURCE_DATA \u00a0\\\u00a0 \u00a0 \u00a0 \u00a0 --no-autocommit \\\u00a0 \u00a0 \u00a0 \u00a0 --default-character-set=utf8mb4 \\\u00a0 \u00a0 \u00a0 \u00a0 --single-transaction \\\u00a0 \u00a0 \u00a0 \u00a0 --set-gtid-purged=on \\\u00a0 \u00a0 \u00a0 \u00a0 ADD_DROP_TABLE \\\u00a0 \u00a0 \u00a0 \u00a0 ROUTINES \\\u00a0 \u00a0 \u00a0 \u00a0 COMPRESS \\\u00a0 \u00a0 \u00a0 \u00a0 GZIP \\\u00a0 \u00a0 \u00a0 \u00a0 | gsutil cp - gs://BUCKET/DUMP_FILENAME\n```\n```\n\u00a0 \u00a0 mysqldump \\\u00a0 \u00a0 \u00a0 \u00a0 --host=192.0.2.1 \\\u00a0 \u00a0 \u00a0 \u00a0 --port=3306 \\\u00a0 \u00a0 \u00a0 \u00a0 --user=replicationUser \\\u00a0 \u00a0 \u00a0 \u00a0 --password \\\u00a0 \u00a0 \u00a0 \u00a0 --databases guestbook journal \\\u00a0 \u00a0 \u00a0 \u00a0 --hex-blob \\\u00a0 \u00a0 \u00a0 \u00a0 --master-data=1 \\\u00a0 \u00a0 \u00a0 \u00a0 --no-autocommit \\\u00a0 \u00a0 \u00a0 \u00a0 --default-character-set=utf8mb4 \\\u00a0 \u00a0 \u00a0 \u00a0 --single-transaction \\\u00a0 \u00a0 \u00a0 \u00a0 --compress \\\u00a0 \u00a0 \u00a0 \u00a0 | gzip \\\u00a0 \u00a0 \u00a0 \u00a0 | gsutil cp - gs://replica-bucket/external-database.sql.gz\n```\n| Property  | Description                                                   |\n|:---------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| EXTERNAL_HOST | The IPv4 or DNS address for the external server.                                          |\n| EXTERNAL_PORT | The port for the external server. If the external server is hosted on Cloud SQL, this is 3306.                              |\n| USERNAME  | The name of the replication user account or user account on the external server that has database read permissions.                         |\n| PASSWORD  | Replication user password.                                               |\n| DATABASE_LIST | Space-separated list of all databases on the external server, except for the system databases (sys, mysql, performance_schema, and information_schema). Use the SHOW DATABASES MySQL command to list your databases. |\n| SOURCE_DATA | If you're using an earlier version of MySQL than 8.0.26, then use --master-data as the value for this parameter. For versions of MySQL that are 8.0.26 or higher, set the value of this parameter to --source-data. |\n| ADD_DROP_TABLE | If you want to add a DROP TABLE statement before each CREATE TABLE statement, include --add-drop-table.                            |\n| ROUTINES  | If you want to show stored routines, such as procedures and functions, in the output for dumped databases, include --routines.                      |\n| COMPRESS  | If you want to compress all information sent between the Cloud SQL replica and the external server, use --compress.                         |\n| GZIP   | If you want to compress the dump file even more, use | gzip. If your database contains data that does not compress well, such as binary incompressible data or JPG images, don't use this.       |\n| BUCKET   | The name of the bucket you created in Step 1 to contain the dump file.                                    |\n| DUMP_FILENAME | A file with this name is created in your bucket. This file contains the contents of the database on your external server.                       |\n## Update the source representation instance with the file path of the Cloud Storage bucket\nThe source representation instance is a Cloud SQL instance that represents the source database server to the Cloud SQL replica. It's visible in the Google Cloud console and appears the same as a regular Cloud SQL instance, but it contains no data, requires no configuration or maintenance, and doesn't affect billing.\nThe `source.json` file contains information about the source representation instance.\n```\n{\u00a0 \"name\": \"PRIMARY_INSTANCE_NAME\",\u00a0 \"region\": \"REGION_NAME\",\u00a0 \"databaseVersion\": \"DB_NAME_AND_VERSION\",\u00a0 \"onPremisesConfiguration\": {\u00a0 \u00a0 \"hostPort\": \"IP_ADDRESS_AND_PORT\",\u00a0 \u00a0 \"username\": \"USERNAME\",\u00a0 \u00a0 \"password\": \"PASSWORD\"\u00a0 }\u00a0 \"dumpFilePath\" :\"DUMP_FILE_PATH\"}\n```\n```\n{\u00a0 \"name\": \"cloudsql-source-instance\",\u00a0 \"region\": \"us-central1\",\u00a0 \"databaseVersion\": \"MYSQL_5_7\",\u00a0 \"onPremisesConfiguration\": {\u00a0 \u00a0 \"hostPort\": \"192.0.2.0:3306\",\u00a0 \u00a0 \"username\": \"replicationUser\",\u00a0 \u00a0 \"password\": \"486#@%*@\"\u00a0 }\u00a0 \"dumpFilePath\" :\"gs://replica-bucket/source-database.sql.gz\"}\n```\n| Property    | Description                       |\n|:----------------------|:-------------------------------------------------------------------------------------------------------|\n| PRIMARY_INSTANCE_NAME | The name of the Cloud SQL instance that's associated with the source representation instance.   |\n| REGION_NAME   | The name of the region that's assigned to the source representation instance.       |\n| DB_NAME_AND_VERSION | The name and version number of the database that's associated with the source representation instance. |\n| IP_ADDRESS_AND_PORT | The IP address and port number reserved for the source representation instance.      |\n| USERNAME    | The username of the source representation instance.             |\n| PASSWORD    | The password of the source representation instance.             |\n| DUMP_FILE_PATH  | The path of the dump file that contains the contents of the database on your external server.   |\nFor a list of the full set of parameters that you can use with the `source.json` file, see [REST Resource: instances](/sql/docs/mysql/admin-api/rest/v1beta4/instances) .The `onPremisesConfiguration` parameter contains information that Cloud SQL needs to connect to the on-premises source. For more information about the  values of this parameter, see [OnPremisesConfiguration](/sql/docs/mysql/admin-api/rest/v1beta4/instances#OnPremisesConfiguration) .\nAfter you set up the Cloud SQL replica, you need to update your source representation instance with the file path of the Cloud Storage bucket.\n```\n\u00a0 \u00a0 gcloud auth login\u00a0 \u00a0 ACCESS_TOKEN=\"$(gcloud auth print-access-token)\"\u00a0 \u00a0 curl --header \"Authorization: Bearer ${ACCESS_TOKEN}\" \\\u00a0 \u00a0 \u00a0 \u00a0 \u00a0--header 'Content-Type: application/json' \\\u00a0 \u00a0 \u00a0 \u00a0 \u00a0--data @JSON_PATH \\\u00a0 \u00a0 \u00a0 \u00a0 \u00a0-X PATCH \\\u00a0 \u00a0 \u00a0 \u00a0 \u00a0https://sqladmin.googleapis.com/sql/v1beta4/projects/PROJECT-ID/instances/SOURCE_REPRESENTATION_INSTANCE\n```\n```\n\u00a0 \u00a0 gcloud auth login\u00a0 \u00a0 ACCESS_TOKEN=\"$(gcloud auth print-access-token)\"\u00a0 \u00a0 curl --header \"Authorization: Bearer ${ACCESS_TOKEN}\" \\\u00a0 \u00a0 \u00a0 \u00a0 \u00a0--header 'Content-Type: application/json' \\\u00a0 \u00a0 \u00a0 \u00a0 \u00a0--data @./source.json \\\u00a0 \u00a0 \u00a0 \u00a0 \u00a0-X PATCH \\\u00a0 \u00a0 \u00a0 \u00a0 \u00a0https://sqladmin.googleapis.com/sql/v1beta4/projects/MyProject/instances/cloudsql-source-instance\n```\n| Property      | Description                               |\n|:-------------------------------|:---------------------------------------------------------------------------------------------------------------------------------------|\n| JSON_PATH      | The path of the JSON file that's stored in the Cloud Storage bucket. This file contains data about the source representation instance. |\n| PROJECT_ID      | The ID of your project in Google Cloud.                        |\n| SOURCE_REPRESENTATION_INSTANCE | The name of the source representation instance.                      |\n## Start replication on the external server\nAfter you have verified that you can replicate from the external server, you are ready to perform the replication.\nDuring the initial import process, do not perform any [DDL operations](https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_ddl) on the external server. Doing so could cause inconsistencies during the import. After the import process completes, the replica uses the binary logs on the external server to catch up to the current state of the external server.\nOpen a terminal, log in using `gcloud` , then enter the `curl` command to replicate from the external server.\n```\n\u00a0 gcloud auth login\u00a0 ACCESS_TOKEN=\"$(gcloud auth print-access-token)\"\u00a0 curl --header \"Authorization: Bearer ${ACCESS_TOKEN}\" \\\u00a0 \u00a0 \u00a0 \u00a0--header 'Content-Type: application/json' \\\u00a0 \u00a0 \u00a0 \u00a0--data '{\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\"syncMode\": \"SYNC_MODE\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\"skipVerification\": \"SKIP_VERIFICATION\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0}' \\\u00a0 \u00a0 \u00a0 \u00a0-X POST \\\u00a0 \u00a0 \u00a0 \u00a0https://sqladmin.googleapis.com/sql/v1beta4/projects/PROJECT_ID/instances/REPLICA_INSTANCE/startExternalSync\n```\n```\n\u00a0 \u00a0 gcloud auth login\u00a0 \u00a0 ACCESS_TOKEN=\"$(gcloud auth print-access-token)\"\u00a0 \u00a0 curl --header \"Authorization: Bearer ${ACCESS_TOKEN}\" \\\u00a0 \u00a0 \u00a0 \u00a0 \u00a0--header 'Content-Type: application/json' \\\u00a0 \u00a0 \u00a0 \u00a0 \u00a0--data '{\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\"syncMode\": \"online\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\"skipVerification\": false\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0}' \\\u00a0 \u00a0 \u00a0 \u00a0 \u00a0-X POST \\\u00a0 \u00a0 \u00a0 \u00a0 \u00a0https://sqladmin.googleapis.com/sql/v1beta4/projects/MyProject/instances/replica-instance/startExternalSync\n```\n| Property   | Description                                    |\n|:------------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------|\n| SYNC_MODE   | Verifies that you can keep the Cloud SQL replica and external server in sync after replication is set up.            |\n| SKIP_VERIFICATION | Whether or not to skip the built-in verification step before syncing your data. Only recommended if you have already verified your replication settings. |\n| PROJECT_ID  | The ID of your project in Google Cloud.                             |\n| REPLICA_INSTANCE | The ID of your Cloud SQL replica.                              |\n### Clean up your storage\nIf you replicated from a file in a bucket, you can remove this file and bucket. See the Cloud Storage documentation for [Deleting Objects](/storage/docs/deleting-objects) and [Deleting Buckets](/storage/docs/deleting-buckets) .\n## Proceed with replication\nOnce you start replication from the external server, you need to monitor replication and then complete your migration. To learn more, see [Monitoring replication](/sql/docs/mysql/replication/configure-replication-from-external#monitoring_replication) .\n## Troubleshoot\n| Issue                      | Troubleshooting                                                                                                                     |\n|:---------------------------------------------------------------------------------------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| Lost connection to MySQL server during query when dumping table.        | The source may have become unavailable, or the dump contained packets too large. Make sure the external primary is available to connect. You can also modify the values of the net_read_timeout and net_write_timeout flags on the source instance to stop the error. For more information on the allowable values for these flags, see Configure database flags. To learn more about using mysqldump flags for managed import migration, see Allowed and default initial sync flags |\n| The initial data migration was successful, but no data is being replicated.     | One possible root cause could be your source database has defined replication flags which result in some or all database changes not being replicated over. Make sure the replication flags such as binlog-do-db, binlog-ignore-db, replicate-do-db or replicate-ignore-db are not set in a conflicting way. Run the command show master status on the primary instance to see the current settings.                      |\n| The initial data migration was successful but data replication stops working after a while. | Things to try: Check the replication metrics for your replica instance in the Cloud Monitoring section of the Google Cloud console. The errors from the MySQL IO thread or SQL thread can be found in Cloud Logging in the mysql.err log files. The error can also be found when connecting to the replica instance. Run the command SHOW SLAVE STATUS, and check for the following fields in the output: Slave_IO_Running Slave_SQL_Running Last_IO_Error Last_SQL_Error    |\n| mysqld check failed: data disk is full.              | The data disk of the replica instance is full. Increase the disk size of the replica instance. You can either manually increase the disk size or enable auto storage increase.                                                                            |\n### Review your replication logs\nWhen you [verify your replication settings](#verify-replication) , logs are produced.\nYou can view these logs by following these steps:\n- Go to the Logs Viewer in the Google Cloud console. [Go to the Logs Viewer](https://console.cloud.google.com/logs?resource=cloudsql_database) \n- Select the Cloud SQL replica from the **Instance** dropdown.\n- Select the`replication-setup.log`log file.\nIf the Cloud SQL replica is unable to connect to the external server, confirm the following:\n- Any firewall on the external server is configured to allow connections   from the Cloud SQL replica's [outgoing IP address](#outgoing-ip) .\n- Your SSL/TLS configuration is correct.\n- Your replication user, host, and password are correct.## What's next\n- Learn about [updating an instance](/sql/docs/mysql/edit-instance) .\n- Learn about [managing replicas](/sql/docs/mysql/replication/manage-replicas) .\n- Learn about [monitoring instances](/sql/docs/mysql/monitor-instance) .\n- Learn about [promoting your Cloud SQL replica](/sql/docs/mysql/replication/manage-replicas#promote-replica) to [promote the replica to a standalone instance and stop replicating from theexternal server](/sql/docs/mysql/migrate-data#migrating-to-sql) .", "guide": "Cloud SQL"}