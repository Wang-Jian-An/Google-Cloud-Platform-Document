{"title": "Cloud SQL - \u914d\u7f6e\u5916\u90e8\u526f\u672c", "url": "https://cloud.google.com/sql/docs/postgres/replication/configure-external-replica?hl=zh-cn", "abstract": "# Cloud SQL - \u914d\u7f6e\u5916\u90e8\u526f\u672c\n[pglogical \u64f4\u5c55\u7a0b\u5e8f](https://cloud.google.com/sql/docs/postgres/replication/configure-logical-replication?hl=zh-cn)\n`logical decoding`\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5916\u90e8\u526f\u672c\u914d\u7f6e\uff0c\u8acb\u53c3\u95b1 [\u95dc\u65bc\u5916\u90e8\u8907\u88fd](https://cloud.google.com/sql/docs/postgres/replication?hl=zh-cn#external-read-replicas) \u3002\n", "content": "## \u8a2d\u7f6e\u5916\u90e8\u526f\u672c\u914d\u7f6e\n### \u6e96\u5099\u5de5\u4f5c\n\u5728\u958b\u59cb\u6b64\u4efb\u52d9\u4e4b\u524d\uff0c\u60a8\u5fc5\u9808\u6709\u4e00\u500b Cloud SQL \u5be6\u4f8b\u548c\u4e00\u500b\u7b26\u5408 [\u5916\u90e8\u526f\u672c\u8981\u6c42](https://cloud.google.com/sql/docs/postgres/replication?hl=zh-cn#external-read-replicas) \u7684\u5916\u90e8 PostgreSQL \u5be6\u4f8b\u3002\n### \u914d\u7f6e\u4e3b\u5be6\u4f8b\n- \u8f49\u5230 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 [\u201cCloud SQL \u5be6\u4f8b\u201d\u9801\u9762](https://console.cloud.google.com/sql/instances?hl=zh-cn) \u3002\n- \u7232\u5916\u90e8\u526f\u672c\u7684 IP \u5730\u5740\u5553\u7528\u5c0d\u4e3b\u5be6\u4f8b\u7684\u8a2a\u554f\u6b0a\u9650\u3002\u5982\u9700\u77ad\u89e3\u5982\u4f55\u5553\u7528 IP \u8a2a\u554f\u6b0a\u9650\uff0c\u8acb\u53c3\u95b1 [\u7232 IP \u9023\u63a5\u914d\u7f6e\u8a2a\u554f\u6b0a\u9650](https://cloud.google.com/sql/docs/postgres/configure-ip?hl=zh-cn) \u3002\n- \u8a18\u9304\u4e3b\u5be6\u4f8b\u7684\u516c\u5171 IP \u5730\u5740\u548c\u516c\u5171\u50b3\u51fa IP \u5730\u5740\u4ee5\u5099\u5f8c\u7528\u3002\u60a8\u53ef\u4ee5\u5728\u5be6\u4f8b\u7684 **\u6982\u89bd** \u9801\u9762\u4e0a\u627e\u5230\u9019\u4e9b\u503c\u3002\n- \u9ede\u64ca\u53f3\u4e0a\u89d2\u7684 Cloud Shell \u5716\u6a19 ()\u3002\n- \u5728 Cloud Shell \u63d0\u793a\u7b26\u8655\uff0c\u4f7f\u7528\u5167\u7f6e\u7684 PostgreSQL \u5ba2\u6236\u7aef\u9023\u63a5\u5230\u60a8\u7684\u4e3b\u5be6\u4f8b\uff1a```\ngcloud sql connect PRIMARY_INSTANCE_NAME \\--user=postgres\u00a0 \u00a0\n```\n- \u8f38\u5165\u60a8\u7684\u6839\u5bc6\u78bc\u3002 \u60a8\u96a8\u5f8c\u61c9\u8a72\u6703\u770b\u5230 postgres \u63d0\u793a\u7b26\u3002\n- \u4f7f\u7528`REPLICATION`\u7279\u6027\u5275\u5efa PostgreSQL \u7528\u6236\u3002```\nCREATE USER REPLICATION_USER WITH REPLICATION IN ROLE cloudsqlsuperuser LOGIN PASSWORD 'REPLICATION_USER_PASSWORD';\u00a0 \u00a0\n```\n- \u5b89\u88dd\u4e26\u914d\u7f6e pglogical \u64f4\u5c55\u7a0b\u5e8f\uff1a\u4fee\u6539 Cloud SQL \u5be6\u4f8b\u4ee5\u6dfb\u52a0\u548c\u8a2d\u7f6e\u4ee5\u4e0b\u6a19\u8a8c\uff1a- `cloudsql.enable_pglogical`\n- `cloudsql.logical_decoding`\n- `max_replication_slots`\n- `max_worker_processes`\n- `max_wal_senders`\n- \u5982\u9700\u8a73\u7d30\u77ad\u89e3\u9019\u4e9b\u6a19\u8a8c\uff0c\u8acb\u53c3\u95b1 [PostgreSQL \u8cc7\u6e90](https://cloud.google.com/sql/docs/postgres/replication/configure-logical-replication?hl=zh-cn#postgresql-resources) \u9801\u9762\u3002\n\u91cd\u5553\u6578\u64da\u5eab\uff0c\u7136\u5f8c\u767b\u9304\u4e26\u66f4\u6539\u7232 Replication_user\uff0c\u7136\u5f8c\u5275\u5efa `pglogical` \u64f4\u5c55\u7a0b\u5e8f\uff1a```\nCREATE EXTENSION pglogical;\u00a0 \u00a0\n```\n- \u5275\u5efa pglogical \u7bc0\u9ede\uff1apglogical _node_ \u8868\u793a\u7269\u7406 PostgreSQL \u5be6\u4f8b\uff0c\u4e26\u5b58\u5132\u8a72\u5be6\u4f8b\u7684\u9023\u63a5\u8a73\u7d30\u4fe1\u606f\u3002```\nSELECT pglogical.create_node(\u00a0 node_name := 'provider',\u00a0 dsn := 'host=PRIMARY_PUBLIC_IP_ADDRESS port=5432 dbname=DATABASE_NAME user=REPLICATION_USER password=REPLICATION_USER_PASSWORD'\u00a0 \u00a0);\u00a0 \u00a0\n```\n- \u5982\u679c\u8981\u958b\u59cb\u4f7f\u7528\u65b0\u6578\u64da\u5eab\uff0c\u8acb\u5728\u4e3b\u5be6\u4f8b\u548c\u526f\u672c\u5be6\u4f8b\u4e0a\u5275\u5efa\u76f8\u540c\u7684\u6578\u64da\u5eab\u548c\u8868\u3002\u4f8b\u5982\uff1a```\nCREATE DATABASE test;\\connect test;CREATE TABLE replica_test (id SERIAL PRIMARY KEY, data text);INSERT INTO replica_test (data) VALUES ('apple'), ('banana'), ('cherry');CREATE EXTENSION pglogical;\n```\n- \u5982\u679c\u4e3b\u5be6\u4f8b\u4e0a\u5df2\u6709\u6578\u64da\u5eab\uff0c\u60a8\u5fc5\u9808\u5728\u526f\u672c\u4e0a\u5275\u5efa\u8a72\u6578\u64da\u5eab\u3002\u7232\u6b64\uff0c\u8acb\u5c07\u4e3b\u5be6\u4f8b\u4e2d\u7684\u6578\u64da\u5eab\u5c0e\u51fa\u5230\u4e00\u500b Cloud Storage \u5b58\u5132\u6876\uff0c\u4e26\u5c07\u5176\u5c0e\u5165\u526f\u672c\u3002\u8a73\u7d30\u77ad\u89e3\u5982\u4f55 [\u5c07 Cloud SQL \u4e2d\u7684\u6578\u64da\u5c0e\u51fa\u5230 Cloud Storage \u4e2d\u7684 SQL \u8f49\u5132\u6587\u4ef6](https://cloud.google.com/sql/docs/postgres/import-export/exporting?hl=zh-cn#cloud-sql) \u3002\n- \u7232\u4e86\u652f\u6301\u5c07\u4e0d\u540c\u7684\u6578\u64da\u96c6\u8907\u88fd\u5230\u4e0d\u540c\u7684\u76ee\u6a19\u4f4d\u7f6e\uff0cpglogical \u63d0\u4f9b\u4e86\u8907\u88fd\u96c6\u7684\u6982\u5ff5\u3002\u4f8b\u5982\uff0c\u5982\u9700\u5c07\u8868\u6dfb\u52a0\u5230\u9ed8\u8a8d\u8907\u88fd\u96c6\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a```\nSELECT pglogical.replication_set_add_table('default', 'replica_test', true);\u00a0 \u00a0\n```\n### \u914d\u7f6e\u5916\u90e8\u526f\u672c\n- \u5275\u5efa\u4e00\u500b\u7279\u6b8a\u7528\u6236\u4ee5\u7528\u65bc\u5be6\u73fe\u8907\u88fd\u529f\u80fd\u4e26\u6388\u4e88\u8907\u88fd\u6b0a\u9650\uff1a```\nCREATE USER REPLICATION_USER WITH REPLICATION SUPERUSER LOGIN PASSWORD 'REPLICATION_USER_PASSWORD';\u00a0 \u00a0\n```\n- \u5982\u679c\u8981\u958b\u59cb\u4f7f\u7528\u65b0\u6578\u64da\u5eab\uff0c\u8acb\u4f7f\u7528\u5728\u4e3b\u5be6\u4f8b\u548c\u526f\u672c\u5be6\u4f8b\u4e0a\u5275\u5efa\u76f8\u540c\u7684\u6578\u64da\u5eab\u548c\u8868\u3002\u4f8b\u5982\uff1a```\nCREATE DATABASE test;\\connect test;CREATE TABLE replica_test (id SERIAL PRIMARY KEY, data text);INSERT INTO replica_test (data) VALUES ('apple'), ('banana'), ('cherry');\u00a0 \n```\n- \u5982\u679c\u60a8\u8981\u4f7f\u7528\u5f9e\u4e3b\u5be6\u4f8b\u5c0e\u51fa\u7684\u6587\u4ef6\u4f5c\u7232\u5916\u90e8\u526f\u672c\u5be6\u4f8b\u7684\u7a2e\u5b50\uff0c\u8acb\u5f9e Cloud Storage \u4e0b\u8f09\u5c0e\u51fa\u7684\u6587\u4ef6\u3002\u5982\u679c\u5916\u90e8\u526f\u672c\u4f4d\u65bc Compute Engine \u5be6\u4f8b\u4e0a\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528`gsutil`\u547d\u4ee4\u4e0b\u8f09\u6587\u4ef6\uff1a```\ngsutil cp gs://BUCKET_NAME/DUMP_FILE_NAME .\u00a0 \u00a0 \n```\n- \u5c07\u6587\u4ef6\u5c0e\u5165\u60a8\u7684\u6578\u64da\u5eab\u3002```\npsql --user=postgres --password < DUMP_FILE_NAME.\n```\n- \u6839\u64da\u60a8\u7684\u64cd\u4f5c\u7cfb\u7d71\u5b89\u88dd`pglogical`\u3002\u4f8b\u5982\uff0c\u5728\u904b\u884c PostgreSQL \u7248\u672c 13 \u7684 Debian \u7cfb\u7d71\u4e0a\uff0c`sudo apt-get install postgresql-13-pglogical`\u3002\n- \u4ee5 Replication_user \u8eab\u4efd\u767b\u9304\u6578\u64da\u5eab\u4e26\u8a2d\u7f6e\u4ee5\u4e0b\u53c3\u6578\uff1a```\nALTER SYSTEM SET shared_preload_libraries = 'pglogical';ALTER SYSTEM SET max_replication_slots = #; (where # is the same as you set on the primary).ALTER SYSTEM SET max_worker_processes = #; (where # is the same as you set on the primary).# Logout of the database and restart it. For example,# sudo /etc/init.d/postgresql restart# Log back in the database as the replication_user.# Since the pglogical extension is created local to each database, you need to# execute CREATE EXTENSION pglogical in each database you create, so if you# haven't already done that:CREATE EXTENSION pglogical;\u00a0 \u00a0For more information about these flags, see the PostgreSQL resources page.\u00a0 \n```\n- \u5275\u5efa pglogical \u7bc0\u9ede\uff1a```\nSELECT pglogical.create_node(\u00a0 node_name := 'subscriber',\u00a0 dsn := 'host=REPLICA_PUBLIC_IP_ADDRESS port=5432 dbname=DATABASE_NAME user=REPLICATION_USER password=REPLICATION_USER_PASSWORD'\u00a0 );\u00a0 \n```\n- \u5275\u5efa pglogical \u8a02\u95b1\uff1a```\nSELECT pglogical.create_subscription(\u00a0 \u00a0 subscription_name := 'SUBSCRIPTION_NAME',\u00a0 \u00a0 provider_dsn := 'host=PRIMARY_PUBLIC_IP_ADDRESS port=5432 dbname=DATABASE_NAME user=REPLICATION_USER password=REPLICATION_USER_PASSWORD');\u00a0 \n```\n- \u67e5\u770b\u8a02\u95b1\u7684\u72c0\u614b\uff1a```\nSELECT * FROM pglogical.show_subscription_status('SUBSCRIPTION_NAME');\u00a0 \u00a0\n```\n- \u5982\u679c\u72c0\u614b\u986f\u793a\u7232`replicating`\uff0c\u5247\u8868\u793a\u8a2d\u7f6e\u6210\u529f\u3002\n- \u5c07\u4e00\u4e9b\u6578\u64da\u63d2\u5165\u4e3b\u5be6\u4f8b\u4e26\u6aa2\u67e5\u526f\u672c\uff0c\u4ee5\u78ba\u4fdd\u6578\u64da\u4e5f\u51fa\u73fe\u5728\u4e3b\u5be6\u4f8b\u4e2d\u3002## \u554f\u984c\u6392\u67e5\n[\u6392\u67e5 pglogical \u554f\u984c](https://cloud.google.com/sql/docs/postgres/replication/configure-logical-replication?hl=zh-cn#troubleshooting-pglogical)\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u77ad\u89e3\u5982\u4f55 [\u7ba1\u7406\u526f\u672c](https://cloud.google.com/sql/docs/postgres/replication/manage-replicas?hl=zh-cn) \u3002\n- \u77ad\u89e3 [\u5916\u90e8\u526f\u672c\u914d\u7f6e\u7684\u8981\u6c42\u548c\u6700\u4f73\u505a\u6cd5](https://cloud.google.com/sql/docs/postgres/replication?hl=zh-cn#external-read-replicas) \u3002\n- \u8a73\u7d30\u77ad\u89e3 [PostgreSQL \u8907\u88fd](https://www.postgresql.org/docs/current/static/logical-replication.html) \u3002\n- \u8a73\u7d30\u77ad\u89e3 [\u8907\u88fd\u9078\u9805](https://dev.mysql.com/doc/refman/5.7/en/replication-options.html) \u3002\n- \u8a73\u7d30\u77ad\u89e3 [\u6aa2\u67e5\u8907\u88fd\u72c0\u614b](https://dev.mysql.com/doc/refman/5.7/en/replication-administration-status.html) \u3002\n- \u8a73\u7d30\u77ad\u89e3 [\u5f9e\u5916\u90e8\u670d\u52d9\u5668\u8907\u88fd](https://cloud.google.com/sql/docs/postgres/replication/replication-from-external?hl=zh-cn) \u3002", "guide": "Cloud SQL"}