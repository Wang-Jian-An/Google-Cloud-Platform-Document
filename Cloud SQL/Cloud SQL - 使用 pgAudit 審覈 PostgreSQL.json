{"title": "Cloud SQL - \u4f7f\u7528 pgAudit \u5be9\u8988 PostgreSQL", "url": "https://cloud.google.com/sql/docs/postgres/pg-audit?hl=zh-cn", "abstract": "# Cloud SQL - \u4f7f\u7528 pgAudit \u5be9\u8988 PostgreSQL\n\u6b64\u9801\u9762\u4ecb\u7d39\u77ad\u5982\u4f55\u4f7f\u7528 [pgAudit](https://www.pgaudit.org/) \u64f4\u5c55\u7a0b\u5e8f\u9032\u884c\u6578\u64da\u5eab\u5be9\u8988\uff1b\u8a72\u64f4\u5c55\u7a0b\u5e8f\u53ef\u5e6b\u52a9\u60a8\u914d\u7f6e\u8a31\u591a\u65e5\u8a8c\uff0c\u9075\u5b88\u653f\u5e9c\u3001\u8ca1\u52d9\u548c ISO \u8a8d\u8b49\u901a\u5e38\u9700\u8981\u9019\u4e9b\u65e5\u8a8c\u3002\n**\u91cd\u8981\u63d0\u793a** \uff1a\u5be9\u8988\u65e5\u8a8c\u6703\u66ab\u6642\u5beb\u5165\u5176\u5be6\u4f8b\u7684\u78c1\u76e4\u4e2d\uff0c\u4f54\u7528\u78c1\u76e4\u7a7a\u9593\u3002\u5982\u672c\u6587\u6240\u8ff0\uff0c\u5728\u5c07\u65e5\u8a8c\u767c\u9001\u5230 Cloud Logging \u4e4b\u524d\uff0c\u78c1\u76e4\u7a7a\u9593\u6703\u53d7\u5230\u5f71\u97ff\u3002\u56e0\u6b64\uff0c\u5728\u4f7f\u7528\u6b64\u529f\u80fd\u4e4b\u524d\uff0c\u8acb\u5148\u67e5\u770b [\u201c\u9650\u5236\u201d\u90e8\u5206](#limitations) \u3002\n\u5982\u9700\u5927\u81f4\u77ad\u89e3 Cloud SQL \u4e2d\u7684 PostgreSQL \u64f4\u5c55\u7a0b\u5e8f\uff0c\u8acb\u53c3\u95b1 [PostgreSQL \u64f4\u5c55\u7a0b\u5e8f](https://cloud.google.com/sql/docs/postgres/extensions?hl=zh-cn) \u3002\n", "content": "## \u6982\u89bd\nCloud SQL for PostgreSQL \u4e2d\u7684\u6578\u64da\u5eab\u5be9\u8988\u53ef\u901a\u904e\u958b\u6e90 pgAudit \u64f4\u5c55\u7a0b\u5e8f\u9032\u884c\u3002\n\u4f7f\u7528\u6b64\u64f4\u5c55\u7a0b\u5e8f\uff0c\u60a8\u53ef\u4ee5\u6709\u9078\u64c7\u5730\u8a18\u9304\u548c\u8ddf\u8e64\u91dd\u5c0d\u7d66\u5b9a\u6578\u64da\u5eab\u5be6\u4f8b\u57f7\u884c\u7684 SQL \u64cd\u4f5c\u3002\u6b64\u64f4\u5c55\u7a0b\u5e8f\u53ef\u7232\u60a8\u63d0\u4f9b\u76e3\u63a7\u548c\u8a18\u9304\u9078\u5b9a\u90e8\u5206\u64cd\u4f5c\u7684\u5be9\u8988\u529f\u80fd\u3002\npgAudit \u64f4\u5c55\u7a0b\u5e8f\u9069\u7528\u65bc\u5df2\u57f7\u884c\u7684 SQL \u547d\u4ee4\u548c\u67e5\u8a62\u3002\u76f8\u6bd4\u4e4b\u4e0b\uff0c [Cloud Audit Logs](https://cloud.google.com/logging/docs/audit?hl=zh-cn) \u61c9\u8a72\u7528\u65bc\u5be9\u8988\u91dd\u5c0d Cloud SQL \u5be6\u4f8b\u5b8c\u6210\u7684\u7ba1\u7406\u548c\u7dad\u8b77\u64cd\u4f5c\u3002\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3 Cloud SQL \u4e2d\u7684\u5be9\u8988\u65e5\u8a8c\uff0c\u8acb\u53c3\u95b1 [\u5be9\u8988\u65e5\u8a8c](https://cloud.google.com/sql/docs/postgres/audit-logging?hl=zh-cn#overview) \u9801\u9762\u3002\n## \u5728 Cloud SQL \u4e2d\u8a2d\u7f6e\u6578\u64da\u5eab\u5be9\u8988\n**\u6ce8\u610f** \uff1a\u5553\u7528 pgAudit \u64f4\u5c55\u7a0b\u5e8f\u6642\uff0c\u5982\u679c\u670d\u52d9\u4e2d\u65b7\uff0c\u5247\u6578\u64da\u5b58\u5132\u8981\u6c42\u6703\u589e\u52a0\u3002\u7232\u78ba\u4fdd\u5728\u767c\u751f\u610f\u5916\u5b58\u5132\u554f\u984c\u6642 pgAudit \u65e5\u8a8c\u8a18\u9304\u7684\u8010\u7528\u6027\uff0c\u6211\u5011\u5efa\u8b70\u60a8\u5728\u4f7f\u7528 pgAudit \u6642 [\u5553\u7528\u5b58\u5132\u7a7a\u9593\u81ea\u52d5\u64f4\u5bb9](https://cloud.google.com/sql/docs/postgres/instance-settings?hl=zh-cn#automatic-storage-increase-2ndgen) \u3002\n\u4f7f\u7528 pgAudit \u64f4\u5c55\u7a0b\u5e8f\u9032\u884c\u5be9\u8988\u65e5\u8a8c\u8a18\u9304\u7684\u6b65\u9a5f\u5305\u62ec\uff1a\n- \u5728 Cloud SQL \u4e2d\u5553\u7528`cloudsql.enable_pgaudit`\u6a19\u8a8c\u3002\n- \u904b\u884c\u547d\u4ee4\u4ee5\u5275\u5efa pgAudit \u64f4\u5c55\u7a0b\u5e8f\u3002\n- \u8a2d\u7f6e`pgaudit.log`\u6a19\u8a8c\u7684\u503c\u3002\n**\u91cd\u8981\u63d0\u793a\uff1a** Cloud SQL \u4e0d\u652f\u6301\u4f7f\u7528 Terraform \u5275\u5efa pgAudit \u64f4\u5c55\u7a0b\u5e8f\u3002\u8acb\u4f7f\u7528 [psql \u5ba2\u6236\u7aef](#running-create-extension) \u5275\u5efa\u6b64\u64f4\u5c55\u7a0b\u5e8f\u3002`pgaudit.log` \u6a19\u8a8c\u7684\u9ed8\u8a8d\u503c\u7232 `none` \u3002 \u5982\u9700\u4f7f\u7528 pgAudit \u64f4\u5c55\u7a0b\u5e8f\uff0c\u60a8\u5fc5\u9808 [\u8a2d\u7f6e\u6b64\u6a19\u8a8c\u7684\u503c](#set-pgaudit-flag-values) \u3002\n\u8a2d\u7f6e\u6578\u64da\u5eab\u5be9\u8988\u5f8c\uff0c\u60a8\u53ef\u4ee5\u67e5\u770b\u65e5\u8a8c\uff0c\u4e26\u5728\u5fc5\u8981\u6642\u505c\u7528\u65e5\u8a8c\u8a18\u9304\u3002\n### \u8a2d\u7f6e\u5be9\u8988\n\u672c\u90e8\u5206\u4ecb\u7d39\u4e86\u8a2d\u7f6e\u6578\u64da\u5eab\u5be9\u8988\u64cd\u4f5c\u7684\u57fa\u790e\u77e5\u8b58\u3002\n\u5728 Cloud SQL \u4e2d\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u6578\u64da\u5eab\u6a19\u8a8c\u57f7\u884c\u8a31\u591a\u64cd\u4f5c\uff0c\u5305\u62ec\u8abf\u6574 PostgreSQL \u53c3\u6578\u548c\u914d\u7f6e\u5be6\u4f8b\u3002 `cloudsql.enable_pgaudit` \u6a19\u8a8c\u7528\u65bc\u7232\u7d66\u5b9a\u6578\u64da\u5eab\u5be6\u4f8b\u5553\u7528\u5be9\u8988\u3002\u60a8\u53ef\u4ee5\u901a\u904e Google Cloud \u63a7\u5236\u6aaf\u6216 `gcloud` \u547d\u4ee4\u66f4\u6539 `cloudsql.enable_pgaudit` \u6a19\u8a8c\u7684\u503c\u3002\n**\u6ce8\u610f** \uff1a\u66f4\u6539 `cloudsql.enable_pgaudit` \u6a19\u8a8c\u7684\u503c\u6703 [\u91cd\u5553](https://cloud.google.com/sql/docs/postgres/start-stop-restart-instance?hl=zh-cn#restart) \u5be6\u4f8b\u3002\n\u6309\u7167 [\u6a19\u8a8c\u7684\u6a19\u6e96\u8aaa\u660e](https://cloud.google.com/sql/docs/postgres/flags?hl=zh-cn) \u5553\u7528 `cloudsql.enable_pgaudit` \u6a19\u8a8c\uff0c\u4e26\u5c07\u503c\u8a2d\u7f6e\u7232 `on` \u3002\u4f8b\u5982\uff0c\u8981\u4f7f\u7528 `gcloud` \u547d\u4ee4\uff0c\u8acb\u6307\u5b9a\u4ee5\u4e0b\u5167\u5bb9\uff0c\u4e26\u5c07 `[INSTANCE_NAME]` \u66ff\u63db\u7232\u60a8\u7684\u5be6\u4f8b\u540d\u7a31\uff1a\n```\ngcloud sql instances patch [INSTANCE_NAME] --database-flags cloudsql.enable_pgaudit=on\n```\n`cloudsql.enable_pgaudit` \u6a19\u8a8c\u8207\u5176\u4ed6 [\u652f\u6301\u7684\u6a19\u8a8c](https://cloud.google.com/sql/docs/postgres/flags?hl=zh-cn#list-flags-postgres) \u4e00\u8d77\u5217\u51fa\uff0c\u4e26\u4e14\u7279\u5b9a\u65bc Cloud SQL\u3002\n\u5553\u7528\u6578\u64da\u5eab\u6a19\u8a8c\u5f8c\uff0c\u4f7f\u7528\u517c\u5bb9\u7684 psql \u5ba2\u6236\u7aef\u904b\u884c `CREATE EXTENSION` \u547d\u4ee4\u3002\u4ee5\u4e0b\u547d\u4ee4\u6703\u7232 Cloud SQL \u5be6\u4f8b\u4e2d\u7684\u6240\u6709\u6578\u64da\u5eab\u5275\u5efa pgAudit \u64f4\u5c55\u7a0b\u5e8f\uff1a\n```\nCREATE EXTENSION pgaudit;\n```\n\u6309\u7167 [\u6a19\u8a8c\u7684\u6a19\u6e96\u8aaa\u660e](https://cloud.google.com/sql/docs/postgres/flags?hl=zh-cn) \u8a2d\u7f6e `pgaudit.log` \u6a19\u8a8c\u7684\u503c\u3002\n\u4f8b\u5982\uff0c\u5982\u9700\u7232\u91dd\u5c0d\u5be6\u4f8b\u7684\u6240\u6709\u6578\u64da\u5eab\u64cd\u4f5c\u5553\u7528\u5be9\u8988\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b `gcloud` \u547d\u4ee4\uff1a\n```\n\u00a0 gcloud sql instances patch [INSTANCE_NAME] --database-flags \\\u00a0 cloudsql.enable_pgaudit=on,pgaudit.log=all\n```\n\u8981\u7232\u6578\u64da\u5eab\u914d\u7f6e\u5be9\u8988\u8a2d\u7f6e\uff0c\u8acb\u6309\u7167 [\u81ea\u5b9a\u7fa9\u6578\u64da\u5eab\u5be9\u8988\u65e5\u8a8c\u8a18\u9304](#customizing-database-audit-logging) \u90e8\u5206\u4e2d\u7684\u6b65\u9a5f\u64cd\u4f5c\u3002\n### \u67e5\u770b\u6578\u64da\u5eab\u5be9\u8988\u65e5\u8a8c\n\u5982\u9700\u67e5\u770b\u5be9\u8988\u65e5\u8a8c\uff0c\u8acb\u7232\u9805\u76ee [\u5553\u7528](https://cloud.google.com/logging/docs/audit/configure-data-access?hl=zh-cn) \u6578\u64da\u8a2a\u554f\u5be9\u8988\u65e5\u8a8c\u3002\u91dd\u5c0d\u7d66\u5b9a\u5be6\u4f8b\u751f\u6210\u7684 pgAudit \u65e5\u8a8c\u5c07\u4f5c\u7232 [\u6578\u64da\u8a2a\u554f\u5be9\u8988\u65e5\u8a8c](https://cloud.google.com/logging/docs/audit?hl=zh-cn#data-access) \u767c\u9001\u5230 Cloud Logging\u3002\u7528\u6236\u53ef\u4ee5\u901a\u904e [\u65e5\u8a8c\u700f\u89bd\u5668](https://cloud.google.com/logging/docs/view/logs-explorer-interface?hl=zh-cn) \u61c9\u7528\u67e5\u770b\u751f\u6210\u7684 pgAudit \u65e5\u8a8c\u3002\n\u5728 [\u65e5\u8a8c\u700f\u89bd\u5668](https://cloud.google.com/logging/docs/view/logs-explorer-interface?hl=zh-cn) \u61c9\u7528\u4e2d\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u9078\u64c7 **cloudaudit.googleapis.com/data_access** \u65e5\u8a8c\u904e\u6ffe\u5668\u4f86\u67e5\u770b pgAudit \u65e5\u8a8c\u3002\n\u6216\u8005\uff0c\u60a8\u4e5f\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u67e5\u8a62\u986f\u793a\u7d66\u5b9a Cloud SQL \u9805\u76ee\u7684\u6240\u6709 pgAudit \u65e5\u8a8c\uff1a\n```\nresource.type=\"cloudsql_database\"logName=\"projects/<your-project-name>/logs/cloudaudit.googleapis.com%2Fdata_access\"protoPayload.request.@type=\"type.googleapis.com/google.cloud.sql.audit.v1.PgAuditEntry\"\n```\n[\u6578\u64da\u8a2a\u554f\u5be9\u8988\u65e5\u8a8c](https://cloud.google.com/logging/docs/audit?hl=zh-cn#data-access) \u4e2d\u7684\u6bcf\u500b pgAudit \u65e5\u8a8c\u689d\u76ee\u90fd\u6709\u4e00\u4e9b\u5b57\u6bb5\uff0c\u4ee3\u8868\u91dd\u5c0d\u67e5\u8a62\u6536\u96c6\u7684\u4fe1\u606f\u3002\n\u793a\u4f8b\u5982\u4e0b\uff1a\n```\n{\n protoPayload: {\n @type: \"type.googleapis.com/google.cloud.audit.AuditLog\"\n methodName: \"cloudsql.instances.query\"\n request: {\n  @type: \"type.googleapis.com/google.cloud.sql.audit.v1.PgAuditEntry\"\n  auditClass: \"READ\"\n  auditType: \"SESSION\"\n  chunkCount: \"1\"\n  chunkIndex: \"1\"\n  command: \"SELECT\"\n  database: \"finance\"\n  databaseSessionId: 2209692\n  parameter: \"[not logged]\"\n  statement: \"SELECT * FROM revenue\"\n  statementId: 2\n  substatementId: 1\n  user: \"alice\"\n }\n }\n}\n```\n\u4e0b\u9762\u4ecb\u7d39\u4e86\u6578\u64da\u8a2a\u554f\u5be9\u8988\u65e5\u8a8c\u4e2d\u7684\u5b57\u6bb5\uff1a\n- **auditClass** \u3002\u6240\u8a18\u9304\u7684\u8a9e\u53e5\u7684\u985e\u578b\u3002\u53ef\u80fd\u7684\u503c\u5305\u62ec`READ`\u3001`WRITE`\u3001`FUNCTION`\u3001`ROLE`\u3001`DDL`\u3001`MISC`\u3001`MISC_SET`\u3002\n- **auditType** \u3002`SESSION`\u6216`OBJECT`\u3002\n- **chunkCount** \u3002\u5c0d`parameter`\u548c`statement`\u5b57\u6bb5\u4e2d\u63d0\u4f9b\u7684\u6578\u64da\u53ef\u80fd\u767c\u751f \u3002`chunkCount`\u5b57\u6bb5\u8868\u793a\u5340\u584a\u7684\u7e3d\u6578\u3002\u53e6\u8acb\u53c3\u95b1`chunkIndex`\u5b57\u6bb5\u7684\u8aaa\u660e\u3002\n- **chunkIndex** \u3002\u5728`parameter`\u548c`statement`\u5b57\u6bb5\u4e2d\uff08\u5728\u7576\u524d`request`\u5bb9\u5668\u4e2d\uff09\u6307\u5b9a\u6578\u64da\u584a\u7684\u7d22\u5f15\u7de8\u865f\u3002\u521d\u59cb\u7de8\u865f\u7232`1`\u3002\u53e6\u8acb\u53c3\u95b1`chunkCount`\u5b57\u6bb5\u7684\u8aaa\u660e\u3002\n- **command** \u3002\u4f8b\u5982`ALTER TABLE`\u6216`SELECT`\u3002\n- **parameter** \u3002`chunkIndex`\u5b57\u6bb5\u53ef\u4ee5\u78ba\u5b9a\u6b64\u5b57\u6bb5\u7684\u5167\u5bb9\uff1b\u8acb\u53c3\u95b1`chunkIndex`\u5b57\u6bb5\u7684\u8aaa\u660e\u3002\u5982\u679c\u8a2d\u7f6e\u4e86`pgaudit.log_parameter`\u7684\u503c\uff0c\u5247`parameter`\u5b57\u6bb5\u53ef\u4ee5\u5305\u542b\u8a9e\u53e5\u53c3\u6578\u4f5c\u7232 CSV \u5f15\u7528\u6578\u64da\u3002\u5982\u679c\u6c92\u6709\u53c3\u6578\uff0c\u5247\u6b64\u5b57\u6bb5\u5305\u542b`[none]`\u3002\u5426\u5247\uff0c\u6b64\u5b57\u6bb5\u5305\u542b`[not logged]`\u3002\n- **statement** \u3002\u5728\u5f8c\u7aef\u57f7\u884c\u7684\u8a9e\u53e5\u3002`chunkIndex`\u5b57\u6bb5\u53ef\u4ee5\u78ba\u5b9a`statement`\u5b57\u6bb5\u7684\u5167\u5bb9\uff1b\u8acb\u53c3\u95b1`chunkIndex`\u5b57\u6bb5\u7684\u8aaa\u660e\u3002\n- **statementId** \u3002\u6b64\u6703\u8a71\u7684\u552f\u4e00\u8a9e\u53e5 ID\u3002\u6bcf\u500b\u8a9e\u53e5 ID \u4ee3\u8868\u4e00\u500b\u5f8c\u7aef\u8abf\u7528\u3002\u5373\u4f7f\u672a\u8a18\u9304\u67d0\u4e9b\u8a9e\u53e5\uff0c\u8a9e\u53e5 ID \u4e5f\u662f\u6709\u5e8f\u7684\u3002\n- **substatementId** \u3002\u4e3b\u8a9e\u53e5\u4e2d\u7684\u6bcf\u500b\u5b50\u8a9e\u53e5\u7684\u9806\u5e8f ID\u3002\n[pgAudit \u6587\u6a94](https://github.com/pgaudit/pgaudit/blob/master/README.md#format) \u4e2d\u4ecb\u7d39\u4e86\u5176\u4e2d\u4e00\u4e9b\u5b57\u6bb5\u3002\n### \u505c\u7528\u5be9\u8988\n\u8981\u505c\u7528\u6578\u64da\u5eab\u5be9\u8988\uff0c\u8acb\u5c07 `cloudsql.enable_pgaudit` \u6a19\u8a8c\u7684\u503c\u8a2d\u7f6e\u7232 `off` \u3002\u60a8\u53ef\u4ee5\u901a\u904e Google Cloud \u63a7\u5236\u6aaf\u6216 `gcloud` \u547d\u4ee4\u66f4\u6539\u6b64\u503c\u3002\u6309\u7167 [\u6a19\u8a8c\u7684\u6a19\u6e96\u8aaa\u660e](https://cloud.google.com/sql/docs/postgres/flags?hl=zh-cn) \u505c\u7528 `cloudsql.enable_pgaudit` \u6a19\u8a8c\u3002\n**\u6ce8\u610f** \uff1a\u66f4\u6539 `cloudsql.enable_pgaudit` \u6a19\u8a8c\u7684\u503c\u6703\u5c0e\u81f4 [\u91cd\u5553](https://cloud.google.com/sql/docs/postgres/start-stop-restart-instance?hl=zh-cn#restart) \u5be6\u4f8b\u3002\n\u6b64\u5916\uff0c\u4f7f\u7528\u517c\u5bb9\u7684 psql \u5ba2\u6236\u7aef\u904b\u884c `DROP EXTENSION` \u547d\u4ee4\u4ee5\u79fb\u9664\u64f4\u5c55\u7a0b\u5e8f\u72c0\u614b\uff1a\n```\nDROP EXTENSION pgaudit;\n```\n## \u5728 Cloud SQL \u4e2d\u81ea\u5b9a\u7fa9\u6578\u64da\u5eab\u5be9\u8988\u65e5\u8a8c\u8a18\u9304\n\u672c\u90e8\u5206\u4ecb\u7d39\u81ea\u5b9a\u7fa9\u6578\u64da\u5eab\u5be6\u4f8b\u7684\u5be9\u8988\u884c\u7232\u7684\u65b9\u6cd5\u3002\n**\u91cd\u8981\u63d0\u793a** \uff1a\u5728\u57f7\u884c\u672c\u90e8\u5206\u4e2d\u7684\u6b65\u9a5f\u4e4b\u524d\uff0c\u8acb\u78ba\u4fdd\u60a8\u5df2\u6309\u7167 [\u8a2d\u7f6e\u6578\u64da\u5eab\u5be9\u8988](#setting-up-database-auditing) \u7684\u6b65\u9a5f\u64cd\u4f5c\uff0c\u5305\u62ec [\u904b\u884c\u547d\u4ee4\u4ee5\u5275\u5efa pgAudit \u64f4\u5c55\u7a0b\u5e8f](#running-create-extension) \u3002\n\u5982\u9700\u77ad\u89e3\u6b64\u64f4\u5c55\u7a0b\u5e8f\u7684\u5176\u4ed6\u529f\u80fd\uff0c\u8acb\u53c3\u95b1 [pgAudit \u6587\u6a94](https://github.com/pgaudit/pgaudit/blob/master/README.md/) \u3002\n### \u8d85\u7d1a\u7528\u6236\u6b0a\u9650\u7684\u8981\u6c42\n\u5728 Cloud SQL \u4e2d\uff0c\u53ea\u80fd\u7531\u5c6c\u65bc `cloudsqlsuperuser` \u89d2\u8272\u7684\u7528\u6236\u5275\u5efa\u64f4\u5c55\u7a0b\u5e8f\u3002\u5275\u5efa\u65b0\u7684 PostgreSQL \u5be6\u4f8b\u6642\uff0c\u7cfb\u7d71\u6703\u7232\u60a8\u5275\u5efa\u9ed8\u8a8d PostgreSQL \u7528\u6236\uff08\u4f46\u60a8\u5fc5\u9808\u8a2d\u7f6e\u8a72\u7528\u6236\u7684\u5bc6\u78bc\uff09\u3002\u9ed8\u8a8d PostgreSQL \u7528\u6236\u5c6c\u65bc `cloudsqlsuperuser` \u89d2\u8272\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [PostgreSQL \u7528\u6236](https://cloud.google.com/sql/docs/postgres/users?hl=zh-cn) \u3002\n### \u7232\u5be6\u4f8b\u4e0a\u7684\u6240\u6709\u6578\u64da\u5eab\u64cd\u4f5c\u914d\u7f6e\u5be9\u8988\n\u5982\u9700\u7232\u5be6\u4f8b\u4e2d\u7684\u6240\u6709\u6578\u64da\u5eab\u914d\u7f6e\u5be9\u8988\uff0c\u60a8\u5fc5\u9808\u5728\u7cfb\u7d71\u7d1a\u5c64\u61c9\u7528 pgAudit \u8a2d\u7f6e\u3002\u7cfb\u7d71\u7d1a\u5be9\u8988\u53c3\u6578\u53ea\u80fd\u901a\u904e Google Cloud \u63a7\u5236\u6aaf\u6216 `gcloud` \u547d\u4ee4\u8a2d\u7f6e\u7232\u6578\u64da\u5eab\u6a19\u8a8c\u3002\u4f8b\u5982\uff0c\u5982\u9700\u7232\u5be6\u4f8b\u4e0a\u7684\u6240\u6709\u6578\u64da\u5eab\u64cd\u4f5c\u5553\u7528\u5be9\u8988\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b `gcloud` \u547d\u4ee4\uff1a\n```\n\u00a0 gcloud sql instances patch [INSTANCE_NAME] --database-flags \\\u00a0 cloudsql.enable_pgaudit=on,pgaudit.log=all\n```\n### \u5c0d\u6240\u6709\u5be6\u4f8b\u6578\u64da\u5eab\u914d\u7f6e\u7279\u5b9a\u64cd\u4f5c\n\u5982\u9700\u5be9\u8988\u6240\u6709\u5be6\u4f8b\u6578\u64da\u5eab\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 Google Cloud \u63a7\u5236\u6aaf\u6216 `gcloud` \u547d\u4ee4\u3002\u4f8b\u5982\uff0c\u5982\u9700\u50c5\u91dd\u5c0d\u5be6\u4f8b\u4e0a\u7684\u8b80\u53d6\u548c\u5beb\u5165\u64cd\u4f5c\u5553\u7528\u5be9\u8988\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b `gcloud` \u547d\u4ee4\u3002\u4ee5\u4e0b\u793a\u4f8b\u4f7f\u7528 [\u57fa\u65bc\u5217\u8868\u7684\u8a9e\u6cd5](https://cloud.google.com/sdk/gcloud/reference/topic/escaping?hl=zh-cn) \u6307\u5b9a\u591a\u500b\u503c\uff1a\n```\n\u00a0 gcloud sql instances patch [INSTANCE_NAME] \\\u00a0 --database-flags ^:^cloudsql.enable_pgaudit=on:pgaudit.log=read,write\n```\n\u8a72\u547d\u4ee4\u6703\u8986\u84cb\u73fe\u6709\u6578\u64da\u5eab\u6a19\u8a8c\u3002\n**\u6ce8\u610f** \uff1a\u8981\u5728\u4fdd\u7559\u73fe\u6709\u6a19\u8a8c\u7684\u540c\u6642\u6dfb\u52a0\u65b0\u6a19\u8a8c\uff0c\u8acb\u6307\u5b9a\u6240\u6709\u6a19\u8a8c\u7684\u503c\u3002\u672a\u6307\u5b9a\u7684\u4efb\u4f55\u6a19\u8a8c\u90fd\u6703\u8a2d\u7f6e\u7232\u9ed8\u8a8d\u503c\u3002\u5982\u9700\u77ad\u89e3\u5982\u4f55\u8a2d\u7f6e\u6a19\u8a8c\uff0c\u5305\u62ec\u901a\u904e Google Cloud \u63a7\u5236\u6aaf\uff0c\u8acb\u53c3\u95b1 [\u8a2d\u7f6e\u6578\u64da\u5eab\u6a19\u8a8c](https://cloud.google.com/sql/docs/postgres/flags?hl=zh-cn#setting_a_database_flag) \u3002\n### \u7232\u7279\u5b9a\u6578\u64da\u5eab\u914d\u7f6e\u5be9\u8988\n\u5982\u9700\u7232\u7279\u5b9a\u6578\u64da\u5eab\u914d\u7f6e\u5be9\u8988\uff0c\u8acb\u5728\u6578\u64da\u5eab\u7d1a\u5c64\u8a2d\u7f6e pgAudit \u53c3\u6578\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b SQL \u547d\u4ee4\u7232\u6578\u64da\u5eab `finance` \u5553\u7528\u8b80\u53d6/\u5beb\u5165\u5be9\u8988\uff1a\n```\nfinance=> ALTER DATABASE finance SET pgaudit.log = 'read,write';\n```\n### \u7232\u95dc\u4fc2\u914d\u7f6e\u5be9\u8988\n\u95dc\u4fc2\u7684\u5be9\u8988\u6bd4\u7279\u5b9a\u6578\u64da\u5eab\u7684\u5be9\u8988\u7bc4\u570d\u5c0f\u4e00\u4e9b\u3002\n\u5be9\u8988\u95dc\u4fc2\u6642\uff0c\u7cfb\u7d71\u6703\u5c07\u4e00\u500b\u552f\u4e00\u7684\u5be9\u8988\u54e1\u89d2\u8272\u5206\u914d\u7d66 `pgaudit.role` \u53c3\u6578\u3002\u7cfb\u7d71\u6703\u8a18\u9304\u6388\u4e88\u6b64\u89d2\u8272\u7684\u4efb\u4f55\u5c0d\u8c61\u6216\u95dc\u4fc2\u3002\n\u4f8b\u5982\uff0c\u5982\u9700\u7232 `employee` \u6578\u64da\u5eab\u4e2d `salary` \u95dc\u4fc2\u7684\u6240\u6709 `SELECT` \u67e5\u8a62\u914d\u7f6e\u5be9\u8988\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\nemployee=> CREATE ROLE auditor WITH NOLOGIN;employee=> ALTER DATABASE employee SET pgaudit.role = 'auditor';employee=> GRANT SELECT ON salary TO auditor;\n```\n\u60a8\u9084\u53ef\u4ee5\u5be9\u8988\u7d66\u5b9a\u95dc\u4fc2\u7684\u4e00\u90e8\u5206\u5217\u3002\n\u4f8b\u5982\uff0c\u4ee5\u4e0b\u547d\u4ee4\u5c07\u5be9\u8988\u65e5\u8a8c\u8a18\u9304\u914d\u7f6e\u7232\u50c5\u7576\u8a2a\u554f `salary` \u95dc\u4fc2\u4e2d\u7684\u5217 `income` \u548c `tax_status` \u6642\u767c\u751f\uff1a\n```\nemployee=> GRANT SELECT(income, tax_status) ON salary TO auditor;\n```\n### \u7232\u6578\u64da\u5eab\u7528\u6236\u914d\u7f6e\u5be9\u8988\n\u60a8\u53ef\u4ee5\u901a\u904e\u5728\u5404\u500b `ROLE` \u7d1a\u5c64\u8a2d\u7f6e `pgaudit.log` \u53c3\u6578\u4f86\u7232\u7279\u5b9a\u7528\u6236\u5553\u7528\u5be9\u8988\u3002\n\u4f8b\u5982\uff0c\u4ee5\u4e0b SQL \u547d\u4ee4\u6703\u5c0d\u7528\u6236 `Alice` \u57f7\u884c\u7684\u6240\u6709\u6578\u64da\u5eab\u64cd\u4f5c\u8a2d\u7f6e\u5be9\u8988\uff1a\n```\nfinance=> ALTER ROLE alice SET pgaudit.log = 'all';\n```\n## Cloud SQL \u4e2d\u7684\u5be9\u8988\u7ba1\u7406\u63d0\u793a\n\u81ea\u5b9a\u7fa9\u5be9\u8988\u884c\u7232\u6642\uff0c\u8acb\u6ce8\u610f\u4ee5\u4e0b\u4e8b\u9805\uff1a\n- \u95dc\u9589\u6578\u64da\u5eab\u6a19\u8a8c`cloudsql.enable_pgaudit`\u6642\uff0c\u5be9\u8988\u65e5\u8a8c\u8a18\u9304\u6703\u7acb\u5373\u505c\u6b62\u3002\u4e0d\u904e\uff0c\u9664\u975e\u660e\u78ba\u79fb\u9664\uff0c\u5426\u5247\u5df2\u61c9\u7528\u7684 pgAudit \u8a2d\u7f6e\uff08\u4f8b\u5982`pgaudit.log`\u53c3\u6578\u8a2d\u7f6e\uff09\u6703\u4fdd\u7559\u4e0b\u4f86\u3002\n- \u6bcf\u7576`cloudsql.enable_pgaudit`\u7684\u6578\u64da\u5eab\u6a19\u8a8c\u503c\u767c\u751f\u66f4\u6539\u6642\uff0c\u7cfb\u7d71\u90fd\u6703\u91cd\u5553\u6578\u64da\u5eab\u5be6\u4f8b\u3002\n- \u901a\u904e\u986f\u5f0f`CREATE ROLE`\u547d\u4ee4\u5275\u5efa\u7684\u6578\u64da\u5eab\u7528\u6236\u7121\u6b0a\u4fee\u6539\u5be9\u8988\u8a2d\u7f6e\u3002\u53ea\u6709\u901a\u904e Google Cloud \u63a7\u5236\u6aaf\u548c`gcloud`\u547d\u4ee4\u5275\u5efa\u7684\u6578\u64da\u5eab\u7528\u6236\u624d\u80fd\u4fee\u6539\u5be9\u8988\u8a2d\u7f6e\u3002\n- \u5553\u7528\u6703\u8a71\u5be9\u8988\u65e5\u8a8c\u8a18\u9304\u548c\u5c0d\u8c61\u5be9\u8988\u65e5\u8a8c\u8a18\u9304\u6642\uff0c\u8207\u9019\u5169\u8005\u76f8\u95dc\u7684\u8a9e\u53e5\u90fd\u6703\u6dfb\u52a0\u5230\u65e5\u8a8c\u4e2d\u3002\u6703\u8a71\u65e5\u8a8c\u8a18\u9304\u548c\u5c0d\u8c61\u65e5\u8a8c\u8a18\u9304\u4e0d\u6703\u76f8\u4e92\u53d6\u6d88\u6216\u4fee\u6539\u3002## Cloud SQL for PostgreSQL \u4e2d\u7684 pgAudit \u64f4\u5c55\u7a0b\u5e8f\u7684\u9650\u5236\n\u5be9\u8988\u65e5\u8a8c\u66ab\u6642\u5beb\u5165\u5176\u5be6\u4f8b\u7684\u78c1\u76e4\uff0c\u4f54\u7528\u65e5\u8a8c\u7a7a\u9593\u5f8c\u518d\u5c07\u65e5\u8a8c\u767c\u9001\u5230 Cloud Logging\u3002\u56e0\u6b64\uff0c\u5728\u4f7f\u7528\u6b64\u529f\u80fd\u4e4b\u524d\uff0c\u8acb\u67e5\u770b\u4ee5\u4e0b\u6240\u6709\u4fe1\u606f\uff1a\n- \u65e5\u8a8c\u63d0\u53d6\u901f\u7387\u7232 4 MB/\u79d2\u3002\u7576\u65e5\u5fd7\u751f\u6210\u7684\u8ca0\u8f09\u8d85\u904e\u63d0\u53d6\u901f\u7387\u6642\uff0c\u53ef\u80fd\u6703\u767c\u751f\u4ee5\u4e0b\u60c5\u6cc1\uff1a\n- \u78c1\u76e4\u4f7f\u7528\u53ef\u80fd\u6703\u767c\u751f\u4e0d\u5fc5\u8981\u7684\u589e\u9577\u3002\n- \u78c1\u76e4\u7a7a\u9593\u53ef\u80fd\u6703\u7528\u76e1\u3002\n- \u5982\u679c\u60a8\u5df2\u5553\u7528\u6b64\u529f\u80fd\uff0c\u4e26\u4e14\u904b\u884c\u8a31\u591a\u7b26\u5408\u5be9\u8988\u689d\u4ef6\u7684\u67e5\u8a62\uff0c\u5247\u78c1\u76e4\u4f7f\u7528\u901f\u5ea6\u53ef\u80fd\u6703\u8b8a\u5f97\u904e\u5feb\u3002\n- \u4f7f\u7528\u6b64\u529f\u80fd\u4e4b\u524d\uff0c\u8acb\u8a08\u5283\u5982\u4f55\uff1a\n- [\u5553\u7528\u5b58\u5132\u7a7a\u9593\u81ea\u52d5\u64f4\u5bb9\u529f\u80fd](https://cloud.google.com/sql/docs/postgres/instance-settings?hl=zh-cn#automatic-storage-increase-2ndgen) \u3002\n- \u76e3\u63a7\u6574\u9ad4\u78c1\u76e4\u4f7f\u7528\u7387\uff1b\u7121\u6cd5\u5c0d\u65e5\u8a8c\u4e16\u4ee3\u7684\u8ca0\u8f09\u9032\u884c\u55ae\u7368\u76e3\u63a7\u3002\u5728 [Metrics Explorer](https://console.cloud.google.com/monitoring/metrics-explorer?hl=zh-cn) \u4e2d\u4f7f\u7528 **cloudsql.googleapis.com/database/disk/utilization** \u6307\u6a19\u3002\n- \u5982\u6709\u5fc5\u8981\uff0c\u901a\u904e\u904b\u884c\u8f03\u5c11\u7684\u67e5\u8a62\u6216\u6e1b\u5c11\u5be9\u8988\u65e5\u8a8c\u4f86\u6e1b\u5c11\u78c1\u76e4\u4f7f\u7528\u91cf\u3002\n- \u5982\u679c\u53ef\u7528\u78c1\u76e4\u7a7a\u9593\u8017\u76e1\uff0c\u5247\u67d0\u4e9b\u67e5\u8a62\u7684\u5be9\u8988\u65e5\u8a8c\u53ef\u80fd\u6703\u4e1f\u5931\u3002", "guide": "Cloud SQL"}