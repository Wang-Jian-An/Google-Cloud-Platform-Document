{"title": "Cloud SQL - Enable change data capture (CDC)", "url": "https://cloud.google.com/sql/docs/sqlserver/replication/enable-cdc", "abstract": "# Cloud SQL - Enable change data capture (CDC)\nThis page describes how to enable [change data capture (CDC)](https://learn.microsoft.com/en-us/sql/relational-databases/track-changes/about-change-data-capture-sql-server?view=sql-server-ver16) in Cloud SQL for SQL Server. This feature is available for the databases of your instances.\nCDC enables you to capture many types of changes. For information about enabling and disabling CDC, see the [Microsoft documentation](https://learn.microsoft.com/en-us/sql/relational-databases/track-changes/enable-and-disable-change-data-capture-sql-server?view=sql-server-ver16) .\nAfter you [connect](/sql/docs/sqlserver/connect-overview) to an instance, the `sqlserver` [user](/sql/docs/sqlserver/users) can do many [CDC operations](https://docs.microsoft.com/en-us/sql/relational-databases/track-changes/enable-and-disable-change-data-capture-sql-server?view=sql-server-ver16) .\nAlso see [Work with Change Data](https://docs.microsoft.com/en-us/sql/relational-databases/track-changes/work-with-change-data-sql-server?view=sql-server-ver16) .\n", "content": "## Before you begin\nBefore you implement CDC on an instance, review all of the information on this page.\n### Confirm feature availability\nCDC is available for the following Cloud SQL for SQL Server database versions:\n- SQL Server 2022 Standard\n- SQL Server 2022 Enterprise\n- SQL Server 2019 Standard\n- SQL Server 2019 Enterprise\n- SQL Server 2017 Standard\n- SQL Server 2017 Enterprise## Enabling CDC and starting CDC capture jobs\nYour database has the following stored procedures, for use by the `sqlserver` user:\n- `msdb.dbo.gcloudsql_cdc_enable_db`\n- `msdb.dbo.gcloudsql_cdc_disable_db`\n### Turn CDC on\nTo turn this feature on for a database, execute the necessary stored procedure and pass in the database name. For example:\n```\nEXEC msdb.dbo.gcloudsql_cdc_enable_db 'DATABASE_NAME'\n```\n### Turn CDC off\nTo turn this feature off for a database, run a command such as the following:\n```\nEXEC msdb.dbo.gcloudsql_cdc_disable_db 'DATABASE_NAME'\n```\n### Start CDC capture jobs\nAfter CDC is enabled, jobs are created for capture and cleanup. The jobs are invisible to the `sqlserver` user in SQL Server Management Studio (SSMS). However, you can modify the jobs using built-in stored procedures. Additionally, the jobs are viewable via the following stored procedure:\n- ` [sys.sp_cdc_help_jobs](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sys-sp-cdc-help-jobs-transact-sql?view=sql-server-ver16) `\nTo start a cleanup job, you could use the following command:\n```\nEXEC sys.sp_cdc_start_job @job_type = N'cleanup'\n```\nTo change the job parameters, you could use a command similar to the following, for example:\n```\nEXEC sys.sp_cdc_change_job \u00a0@job_type = N'capture',\u00a0 \u00a0 \u00a0 \u00a0 @maxtrans = 20,\u00a0 \u00a0 \u00a0 \u00a0 @pollinginterval = NULL,\u00a0 \u00a0 \u00a0 \u00a0 @maxscans = NULL,\u00a0 \u00a0 \u00a0 \u00a0 @continuous = NULL\n```\nFor more information about starting and changing jobs, see the following:\n- ` [sys.sp_cdc_start_job](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sys-sp-cdc-start-job-transact-sql?view=sql-server-ver16) `\n- ` [sys.sp_cdc_change_job](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sys-sp-cdc-change-job-transact-sql?view=sql-server-ver16) `\nAlso see ` [sys.sp_cdc_add_job](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sys-sp-cdc-add-job-transact-sql?view=sql-server-ver16) ` .\n## Enabling CDC for a table\nAfter you [turn on CDC](#turning-cdc-on) for a database, any user with dbo (database owner) access can set up tracking for tables in the database.\nFor information about the standard CDC commands and options, see [Enable and Disable Change Data Capture](https://docs.microsoft.com/en-us/sql/relational-databases/track-changes/enable-and-disable-change-data-capture-sql-server?view=sql-server-ver16) .\n### Track changes in a table\nTo track a table, use the `sys.sp_cdc_enable_table` stored procedure.\nFor example, you could specify a command similar to the following:\n```\nEXEC sys.sp_cdc_enable_table\u00a0 @source_schema = N'dbo',\u00a0 @source_name = N'customer',\u00a0 @role_name = N'CDC'\n```\n### Check if CDC is enabled on a table\nTo check if CDC is enabled on a table, use the `sys.sp_cdc_help_change_data_capture` stored procedure.\nFor example, you could specify a command similar to the following:\n```\nEXECUTE sys.sp_cdc_help_change_data_capture\u00a0 @source_schema = N'dbo',\u00a0 @source_name = N'customer'\n```\n### Query changes via a CDC change table\nTo view CDC changes made on a table, use a `SELECT` query on the table that automatically is created when CDC is enabled on that table.\nThe table is named as follows:\n```\n<schema>_<table_name>_CT\n```\nFor example, you could specify a command similar to the following:\n```\nSELECT * FROM cdc.dbo_customer_CT\n```\n### Enable CDC on a table with a capture instance specified\nTo track a table with a \"capture instance\", use the `sys.sp_cdc_enable_table` stored procedure.\nFor example, you could specify a command similar to the following:\n```\nEXEC sys.sp_cdc_enable_table\u00a0 \u00a0 @source_schema = N'dbo',\u00a0 \u00a0 @source_name = N'customer',\u00a0 \u00a0 @role_name = N'CDC',\u00a0 \u00a0 @capture_instance = N'customer_cdc',\u00a0 \u00a0 @supports_net_changes = 1\n```\n### Query all changes within a capture instance\nTo view CDC changes made on a table within a \"capture instance\", use the `cdc.fn_cdc_get_all_changes_<capture_instance>` stored procedure.\nFor example, you could specify a SQL statement similar to the following:\n```\nDECLARE @from_lsn binary(10), @to_lsn binary(10)SET @from_lsn = sys.fn_cdc_get_min_lsn(N'customer_cdc')SET @to_lsn = sys.fn_cdc_get_max_lsn()SELECT * FROM cdc.fn_cdc_get_all_changes_customer_cdc(@from_lsn, @to_lsn, N'all');\n```\n## Disabling CDC for a table\nTo disable CDC tracking for a table, use the `sys.sp_cdc_disable_table` stored procedure. Specify a capture instance to disable it. Alternatively, specify a capture instance as `'all'` .\nFor example, you could specify a command similar to the following to disable CDC for the table:\n```\nEXEC sys.sp_cdc_disable_table\u00a0 @source_schema = N'dbo',\u00a0 @source_name = N'customer',\u00a0 @capture_instance = N'all'\n```\n## Deleting a CDC-enabled database\nIf CDC is enabled for a database and you try to delete it, then you may encounter errors. If this occurs, disable CDC for the database, and then delete the database.\nFor example, you can specify a command similar to the following to disable and delete a database:\n```\nEXEC msdb.dbo.gcloudsql_cdc_disable_db 'DATABASE_NAME'DROP DATABASE 'DATABASE_NAME'\n```\nIf you can't delete the database because it has open connections, then use the following query to see those connections:\n```\nselect db_name(dbid),* from sys.sysprocesses where db_name(dbid)= 'DATABASE_NAME'\n```\nClose all open connections. Disable CDC for the database, and then delete the database.\n## Importing a CDC-enabled database\nWhen importing a CDC-enabled database, Cloud SQL for SQL Server keeps the [KEEP_CDC](https://docs.microsoft.com/en-us/sql/t-sql/statements/restore-statements-arguments-transact-sql?view=sql-server-ver15#change_data_capture_with_option) flag enabled and automatically creates capture and cleanup jobs with default parameters.", "guide": "Cloud SQL"}