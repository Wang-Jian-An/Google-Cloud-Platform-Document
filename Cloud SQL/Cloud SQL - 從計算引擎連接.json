{"title": "Cloud SQL - \u5f9e\u8a08\u7b97\u5f15\u64ce\u9023\u63a5", "url": "https://cloud.google.com/sql/docs/postgres/connect-compute-engine?hl=zh-cn", "abstract": "# Cloud SQL - \u5f9e\u8a08\u7b97\u5f15\u64ce\u9023\u63a5\n\u672c\u9801\u9762\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528\u5b89\u88dd\u5728 Compute Engine \u5be6\u4f8b\u4e0a\u7684 psql \u5ba2\u6236\u7aef\u9023\u63a5\u5230 Cloud SQL\u3002\n\u60a8\u53ef\u4ee5\u4f7f\u7528\u5c08\u7528 IP\u3001\u516c\u5171 IP\u3001Cloud SQL Auth \u4ee3\u7406\u6216 Cloud SQL Auth \u4ee3\u7406 Docker \u6620\u50cf\u3002\n**\u5982\u9700\u77ad\u89e3\u904b\u884c\u9023\u63a5\u5230 Cloud SQL \u7684 Compute Engine \u793a\u4f8b Web \u61c9\u7528\u7684\u5206\u6b65\u8aaa\u660e** \uff0c\u8acb\u53c3\u95b1 [\u5f9e Compute Engine \u9023\u63a5\u5feb\u901f\u5165\u9580](https://cloud.google.com/sql/docs/postgres/connect-instance-compute-engine?hl=zh-cn) \u3002\n", "content": "## \u6e96\u5099\u5de5\u4f5c\n\u6b64\u4efb\u52d9\u4e0d\u5305\u62ec\u6709\u95dc\u8a2d\u7f6e Compute Engine \u5be6\u4f8b\u7684\u8aaa\u660e\u3002\u5982\u679c\u60a8\u5728\u5275\u5efa\u548c\u914d\u7f6e Compute Engine \u5be6\u4f8b\u65b9\u9762\u9700\u8981\u5e6b\u52a9\uff0c\u8acb\u53c3\u95b1 [Compute Engine \u6587\u6a94](https://cloud.google.com/compute/docs/instances/create-start-instance?hl=zh-cn) \u3002\n\u78ba\u4fdd\u60a8\u7684 Compute Engine \u865b\u64ec\u6a5f\u5177\u6709\u6b63\u78ba\u7684`scope`\uff0c\u4ee5\u4fbf\u4f7f\u7528 Cloud SQL Admin API \u9032\u884c\u9023\u63a5\u3002 [\u5c07\u670d\u52d9\u8cec\u865f\u914d\u7f6e](https://cloud.google.com/compute/docs/access/create-enable-service-accounts-for-instances?hl=zh-cn#changeserviceaccountandscopes) \u7232\u4ee5\u4e0b\u4efb\u4e00\u8a2a\u554f\u6b0a\u9650\u7bc4\u570d\uff1a- https://www.googleapis.com/auth/sqlservice.admin\n- https://www.googleapis.com/auth/cloud-platform\n\u8981\u4f7f\u7528\u5c08\u7528 IP \u5f9e\u67d0\u500b Compute Engine \u5be6\u4f8b\u9023\u63a5\u5230 Cloud SQL\uff0c\u60a8\u5fc5\u9808\u7232\u60a8\u7684\u74b0\u5883\u8a2d\u7f6e\u5c08\u7528\u670d\u52d9\u8a2a\u554f\u901a\u9053\uff0c\u4e26\u4e14\u5fc5\u9808\u5c07 Cloud SQL \u5be6\u4f8b\u914d\u7f6e\u7232\u4f7f\u7528\u5c08\u7528 IP\u3002\u60a8\u7684 Compute Engine \u5be6\u4f8b\u5fc5\u9808\u8207 Cloud SQL \u5be6\u4f8b\u4f4d\u65bc\u540c\u4e00\u5340\u57df\u4e2d\uff0c\u4e26\u4e14\u5fc5\u9808\u4f4d\u65bc\u7232\u5c08\u7528\u9023\u63a5\u914d\u7f6e\u7684\u7db2\u7d61\u4e0a\u3002 [\u77ad\u89e3\u8a73\u60c5](https://cloud.google.com/sql/docs/postgres/configure-private-ip?hl=zh-cn) \u3002### 1.\u5c07\u60a8\u7684\u5be6\u4f8b\u914d\u7f6e\u7232\u4f7f\u7528\u5c08\u7528 IP\u6309\u7167 [\u914d\u7f6e\u5c08\u7528 IP \u9023\u63a5](https://cloud.google.com/sql/docs/postgres/configure-private-ip?hl=zh-cn) \u4e2d\u7684\u8aaa\u660e\u9032\u884c\u64cd\u4f5c\u3002\n### 2.\u6253\u958b\u9023\u63a5\u5230 Compute Engine \u5be6\u4f8b\u7684 Cloud Shell \u7d42\u7aef\u3002\u6839\u64da\u5be6\u4f8b\u7684\u64cd\u4f5c\u7cfb\u7d71\uff0c\u4f7f\u7528\u76f8\u61c9\u7684\u8aaa\u660e\uff1a- \u5c0d\u65bc Linux\uff0c\u8acb\u53c3\u95b1 [\u9023\u63a5\u5230 Linux \u865b\u64ec\u6a5f](https://cloud.google.com/compute/docs/instances/connecting-to-instance?hl=zh-cn) \u3002\n- \u5c0d\u65bc Windows\uff0c\u8acb\u53c3\u95b1 [\u9023\u63a5\u5230 Windows \u865b\u64ec\u6a5f](https://cloud.google.com/compute/docs/instances/connecting-to-windows?hl=zh-cn) \u3002\u5982\u679c\u60a8\u7684 Compute Engine \u5be6\u4f8b\u6b63\u5728\u904b\u884c RHEL \u6216 CentOS \u516c\u958b\u6620\u50cf\uff0c\u5247 SELinux \u53ef\u80fd\u6703\u963b\u6b62\u4ee3\u7406\u9023\u63a5\u3002\u5982\u679c\u767c\u751f\u9019\u7a2e\u60c5\u6cc1\uff0c\u5fc5\u9808\u914d\u7f6e SELinux \u529f\u80fd\u4ee5\u5141\u8a31\u9023\u63a5\u3002\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u7528\u65bc RHEL \u7684 SELinux\uff0c\u8acb\u53c3\u95b1 [RHEL \u6587\u6a94](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/selinux_users_and_administrators_guide/index) \u3002  \u5982\u9700\u8a73\u7d30\u77ad\u89e3\u7528\u65bc CentOS \u7684 SELinux\uff0c\u8acb\u53c3\u95b1 [CentOS \u6587\u6a94](https://wiki.centos.org/HowTos/SELinux) \u3002\n### 3.\u5982\u679c\u5c1a\u672a\u5b89\u88dd psql \u5ba2\u6236\u7aef\uff0c\u8acb\u5c07\u5176\u5b89\u88dd\u5230 Compute Engine \u5be6\u4f8b\u4e0a\u3002\u901a\u904e\u8edf\u4ef6\u5305\u7ba1\u7406\u5668\u5b89\u88dd psql \u5ba2\u6236\u7aef\uff1a\n```\nsudo apt-get updatesudo apt-get install postgresql-client\n```\u901a\u904e\u8edf\u4ef6\u5305\u7ba1\u7406\u5668\u5b89\u88dd psql \u5ba2\u6236\u7aef\uff1a\n```\nsudo yum install postgresql\n```\u901a\u904e\u8edf\u4ef6\u5305\u7ba1\u7406\u5668\u5b89\u88dd psql \u5ba2\u6236\u7aef\uff1a\n```\nsudo zypper install postgresql\n```\n- \u5f9e [PostgreSQL \u4e0b\u8f09\u9801\u9762](https://www.postgresql.org/download/) \u4e0b\u8f09\u9069\u7528\u65bc\u60a8\u7684\u5e73\u81fa\u7684 PostgreSQL \u6838\u5fc3\u767c\u884c\u7248\u3002\u6838\u5fc3\u767c\u884c\u7248\u5305\u542b psql \u5ba2\u6236\u7aef\u3002\n- \u6309\u7167\u4e0b\u8f09\u9801\u9762\u4e0a\u7684\u8aaa\u660e\u5b89\u88dd PostgreSQL \u6578\u64da\u5eab\u3002\n### 4.\u9023\u63a5 psql \u5ba2\u6236\u7aef\u3002```\npsql -h CLOUD_SQL_PRIVATE_IP_ADDRESS -U USERNAME\n```\n\u60a8\u53ef\u4ee5\u5728 [Cloud SQL \u5be6\u4f8b\u9801\u9762](https://console.cloud.google.com/sql/instances/?hl=zh-cn) \u4e0a\u627e\u5230\u5c08\u7528 IP \u5730\u5740\uff0c\u4e5f\u53ef\u4ee5\u904b\u884c\u4ee5\u4e0b `gcloud` \u547d\u4ee4\uff1a\n```\ngcloud sql instances list\n```\n **\u5982\u9700\u4f7f\u7528\u516c\u5171 IP \u9032\u884c\u9023\u63a5\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c** \uff1a### 1.\u5982\u679c Compute Engine \u5be6\u4f8b\u9084\u6c92\u6709\u975c\u614b IPv4 IP \u5730\u5740\uff0c\u8acb\u7232\u5176\u6dfb\u52a0\u4e00\u500b\u3002\u60a8\u7121\u6cd5\u4f7f\u7528 IPv6 \u9023\u63a5\u5230 Compute Engine\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u6dfb\u52a0\u975c\u614b IP \u5730\u5740\uff0c\u8acb\u53c3\u95b1 Compute Engine \u6587\u6a94\u4e2d\u7684 [\u9810\u7559\u65b0\u7684\u975c\u614b\u5916\u90e8 IP \u5730\u5740](https://cloud.google.com/compute/docs/configure-instance-ip-addresses?hl=zh-cn#reserve_new_static) \u3002\n### 2.\u5c07 Compute Engine \u5be6\u4f8b\u7684\u975c\u614b IP \u5730\u5740\u6388\u6b0a\u7232\u53ef\u9023\u63a5\u5230 Cloud SQL \u5be6\u4f8b\u7684\u7db2\u7d61\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7232\u516c\u5171 IP \u9023\u63a5\u914d\u7f6e\u8a2a\u554f\u6b0a\u9650](https://cloud.google.com/sql/docs/postgres/configure-ip?hl=zh-cn) \u3002\n **\u6ce8\u610f** \uff1a\u53ea\u7232\u975c\u614bIP \u5730\u5740\u6388\u6b0a\u3002\u81e8\u6642 IP \u5730\u5740\u662f\u66ab\u6642\u7684\uff1b\u7232\u9019\u4e9b\u5730\u5740\u6388\u4e88\u8a2a\u554f\u5be6\u4f8b\u7684\u6b0a\u9650\u6703\u5e36\u4f86\u5b89\u5168\u98a8\u96aa\uff0c\u56e0\u7232\u5b83\u5011\u96a8\u5f8c\u53ef\u80fd\u6703\u88ab\u91cd\u65b0\u5206\u914d\u7d66\u5176\u4ed6 Compute Engine \u7528\u6236\u3002\n### 3.\u6253\u958b\u9023\u63a5\u5230 Compute Engine \u5be6\u4f8b\u7684 Cloud Shell \u7d42\u7aef\u3002\u6839\u64da\u5be6\u4f8b\u7684\u64cd\u4f5c\u7cfb\u7d71\uff0c\u4f7f\u7528\u76f8\u61c9\u7684\u8aaa\u660e\uff1a- \u5c0d\u65bc Linux\uff0c\u8acb\u53c3\u95b1 [\u9023\u63a5\u5230 Linux \u865b\u64ec\u6a5f](https://cloud.google.com/compute/docs/instances/connecting-to-instance?hl=zh-cn) \u3002\n- \u5c0d\u65bc Windows\uff0c\u8acb\u53c3\u95b1 [\u9023\u63a5\u5230 Windows \u865b\u64ec\u6a5f](https://cloud.google.com/compute/docs/instances/connecting-to-windows?hl=zh-cn) \u3002\u5982\u679c\u60a8\u7684 Compute Engine \u5be6\u4f8b\u6b63\u5728\u904b\u884c RHEL \u6216 CentOS \u516c\u958b\u6620\u50cf\uff0c\u5247 SELinux \u53ef\u80fd\u6703\u963b\u6b62\u4ee3\u7406\u9023\u63a5\u3002\u5982\u679c\u767c\u751f\u9019\u7a2e\u60c5\u6cc1\uff0c\u5fc5\u9808\u914d\u7f6e SELinux \u529f\u80fd\u4ee5\u5141\u8a31\u9023\u63a5\u3002\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u7528\u65bc RHEL \u7684 SELinux\uff0c\u8acb\u53c3\u95b1 [RHEL \u6587\u6a94](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/selinux_users_and_administrators_guide/index) \u3002  \u5982\u9700\u8a73\u7d30\u77ad\u89e3\u7528\u65bc CentOS \u7684 SELinux\uff0c\u8acb\u53c3\u95b1 [CentOS \u6587\u6a94](https://wiki.centos.org/HowTos/SELinux) \u3002\n### 4.\u5982\u679c\u5c1a\u672a\u5b89\u88dd psql \u5ba2\u6236\u7aef\uff0c\u8acb\u5c07\u5176\u5b89\u88dd\u5230 Compute Engine \u5be6\u4f8b\u4e0a\u3002\u901a\u904e\u8edf\u4ef6\u5305\u7ba1\u7406\u5668\u5b89\u88dd psql \u5ba2\u6236\u7aef\uff1a\n```\nsudo apt-get updatesudo apt-get install postgresql-client\n```\u901a\u904e\u8edf\u4ef6\u5305\u7ba1\u7406\u5668\u5b89\u88dd psql \u5ba2\u6236\u7aef\uff1a\n```\nsudo yum install postgresql\n```\u901a\u904e\u8edf\u4ef6\u5305\u7ba1\u7406\u5668\u5b89\u88dd psql \u5ba2\u6236\u7aef\uff1a\n```\nsudo zypper install postgresql\n```\n- \u5f9e [PostgreSQL \u4e0b\u8f09\u9801\u9762](https://www.postgresql.org/download/) \u4e0b\u8f09\u9069\u7528\u65bc\u60a8\u7684\u5e73\u81fa\u7684 PostgreSQL \u6838\u5fc3\u767c\u884c\u7248\u3002\u6838\u5fc3\u767c\u884c\u7248\u5305\u542b psql \u5ba2\u6236\u7aef\u3002\n- \u6309\u7167\u4e0b\u8f09\u9801\u9762\u4e0a\u7684\u8aaa\u660e\u5b89\u88dd PostgreSQL \u6578\u64da\u5eab\u3002\n### 5. \u9023\u63a5 psql \u5ba2\u6236\u7aef\u3002```\npsql -h CLOUD_SQL_PUBLIC_IP_ADDR -U USERNAME\n```\n\u60a8\u53ef\u4ee5\u5728 [Cloud SQL \u5be6\u4f8b\u9801\u9762](https://console.cloud.google.com/sql/instances/?hl=zh-cn) \u4e0a\u627e\u5230\u516c\u5171 IP \u5730\u5740\uff0c\u4e5f\u53ef\u4ee5\u904b\u884c\u4ee5\u4e0b `gcloud` \u547d\u4ee4\uff1a\n```\ngcloud sql instances list\n```\n\u5982\u9700\u67e5\u770b\u6709\u95dc\u5982\u4f55\u4f7f\u7528 SSL \u9032\u884c\u9023\u63a5\u7684\u793a\u4f8b\uff0c\u8acb\u53c3\u95b1 [\u901a\u904e SSL \u9023\u63a5](https://cloud.google.com/sql/docs/postgres/connect-admin-ip?hl=zh-cn#connect-ssl) \u3002\n### 6.\u7cfb\u7d71\u6703\u986f\u793a psql \u63d0\u793a\u7b26\u3002\n### 7. \u5982\u679c\u60a8\u9700\u8981\u4f7f\u672a\u4f7f\u7528\u7684\u9023\u63a5\u4fdd\u6301\u6d3b\u8e8d\u72c0\u614b\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\u8a2d\u7f6e [TCP keepalive](http://tldp.org/HOWTO/TCP-Keepalive-HOWTO/usingkeepalive.html) \u3002\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 Compute Engine \u6587\u6a94\u4e2d\u7684 [\u5728\u5be6\u4f8b\u548c\u4e92\u806f\u7db2\u4e4b\u9593\u901a\u4fe1](https://cloud.google.com/compute/docs/troubleshooting?hl=zh-cn#communicatewithinternet) \u3002\n\u5c0d\u65bc\u5be6\u4f8b\uff0c\u9023\u63a5\u6703\u81ea\u52d5\u4fdd\u6301\u6d3b\u8e8d\u72c0\u614b\u3002\n **\u5982\u9700\u5728 Compute Engine \u4e2d\u4f7f\u7528 Cloud SQL Auth \u4ee3\u7406\u9032\u884c\u9023\u63a5\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a** ### 1. \u5553\u7528 Cloud SQL Admin API\u3002Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n [\u5553\u7528 API](https://console.cloud.google.com/flows/enableapi?apiid=sqladmin&%3Bredirect=https%3A%2F%2Fconsole.cloud.google.com&hl=zh-cn) \n### 2.\u5275\u5efa\u670d\u52d9\u8cec\u865f\u3002 **\u6ce8\u610f** \uff1a\u5982\u679c Compute Engine \u5be6\u4f8b\u5177\u6709 **\u5b8c\u6574 API \u8a2a\u554f\u6b0a\u9650** \u6216 **Cloud SQL Admin API** \u7bc4\u570d\uff0c\u60a8\u53ef\u4ee5\u8df3\u904e\u6b64\u6b65\u9a5f\uff1b\u5553\u52d5 Cloud SQL Auth \u4ee3\u7406\u6642\u7121\u9700\u63d0\u4f9b\u8b49\u66f8\u6587\u4ef6\u3002\n\u5982\u679c\u60a8\u8981\u5f9e Compute Engine \u9023\u63a5\uff0c\u8acb\u78ba\u4fdd\u865b\u64ec\u6a5f\u5177\u6709\u6b63\u78ba\u7684`scope`\uff0c\u4ee5\u4fbf\u4f7f\u7528 Cloud SQL Admin API \u9032\u884c\u9023\u63a5\u3002 [\u5c07\u670d\u52d9\u8cec\u865f\u914d\u7f6e](https://cloud.google.com/compute/docs/access/create-enable-service-accounts-for-instances?hl=zh-cn#changeserviceaccountandscopes) \u7232\u5177\u6709\u4ee5\u4e0b\u4efb\u4e00\u8a2a\u554f\u6b0a\u9650\u7bc4\u570d\uff1a- https://www.googleapis.com/auth/sqlservice.admin\n- https://www.googleapis.com/auth/cloud-platform\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u8f49\u5230 **\u670d\u52d9\u8cec\u865f** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u670d\u52d9\u8cec\u865f\u201d](https://console.cloud.google.com/iam-admin/serviceaccounts/?hl=zh-cn) \n- \u9078\u64c7\u5305\u542b\u60a8\u7684 Cloud SQL \u5be6\u4f8b\u7684\u9805\u76ee\u3002\n- \u9ede\u64ca **\u5275\u5efa\u670d\u52d9\u8cec\u865f** \u3002\n- \u5728 **\u670d\u52d9\u8cec\u865f\u540d\u7a31** \u5b57\u6bb5\u4e2d\u8f38\u5165\u670d\u52d9\u8cec\u865f\u7684\u63cf\u8ff0\u6027\u540d\u7a31\u3002\n- \u5c07 **\u670d\u52d9\u8cec\u865f ID** \u66f4\u6539\u7232\u4e00\u500b\u4e0d\u91cd\u8907\u4e14\u6613\u65bc\u8b58\u5225\u7684\u503c\uff0c\u7136\u5f8c\u9ede\u64ca **\u5275\u5efa\u4e26\u7e7c\u7e8c** \u3002\n- \u9ede\u64ca **\u9078\u64c7\u89d2\u8272** \u5b57\u6bb5\uff0c\u7136\u5f8c\u9078\u64c7\u4ee5\u4e0b\u89d2\u8272\u4e4b\u4e00\uff1a\n- **Cloud SQL > Cloud SQL Client** \n- **Cloud SQL > Cloud SQL Editor** \n- **Cloud SQL > Cloud SQL Admin** \n- **\u6ce8\u610f** \uff1a\u5982\u9700\u5275\u5efa\u5177\u6709\u6240\u9700\u6b0a\u9650\u7684\u670d\u52d9\u8cec\u865f\uff0c\u60a8\u5fc5\u9808\u64c1\u6709`resourcemanager.projects.setIamPolicy`\u6b0a\u9650\u3002Project Owner\u3001Project IAM Admin \u548c Organization Administrator \u89d2\u8272\u5747\u64c1\u6709\u9019\u9805\u6b0a\u9650\u3002\u6b64\u5916\uff0c\u60a8\u9084\u5fc5\u9808\u5553\u7528 Cloud SQL Admin API\u3002\u5982\u679c\u60a8\u8981\u4f7f\u7528\u820a\u7248\u9805\u76ee\u89d2\u8272\uff08Viewer\u3001Editor\u3001Owner\uff09\uff0c\u5247\u8a72\u670d\u52d9\u8cec\u865f\u5fc5\u9808\u81f3\u5c11\u5177\u6709 Editor \u89d2\u8272\u3002- \u9ede\u64ca **\u5b8c\u6210** \u4ee5\u5b8c\u6210\u670d\u52d9\u8cec\u865f\u7684\u5275\u5efa\u904e\u7a0b\u3002\n- \u9ede\u64ca\u65b0\u670d\u52d9\u8cec\u865f\u7684\u64cd\u4f5c\u83dc\u55ae\uff0c\u7136\u5f8c\u9078\u64c7 **\u7ba1\u7406\u5bc6\u9470** \u3002\n- \u9ede\u64ca **\u6dfb\u52a0\u9375** \u4e0b\u62c9\u83dc\u55ae\uff0c\u7136\u5f8c\u9ede\u64ca **\u5275\u5efa\u65b0\u5bc6\u9470** \u3002\n- \u78ba\u8a8d\u5bc6\u9470\u985e\u578b\u662f JSON\uff0c\u7136\u5f8c\u9ede\u64ca **\u5275\u5efa** \u3002\u79c1\u9470\u6587\u4ef6\u5c07\u4e0b\u8f09\u5230\u60a8\u7684\u6a5f\u5668\u4e0a\u3002\u60a8\u53ef\u4ee5\u5c07\u6b64\u6587\u4ef6\u79fb\u81f3\u5176\u4ed6\u4f4d\u7f6e\uff0c\u4f46\u8981\u78ba\u4fdd\u5bc6\u9470\u6587\u4ef6\u7684\u5b89\u5168\u3002\n\u5982\u679c Compute Engine \u5be6\u4f8b\u8207 Cloud SQL \u5be6\u4f8b\u5728\u4e0d\u540c\u7684\u9805\u76ee\u4e2d\uff0c\u8acb\u78ba\u4fdd\u5176\u670d\u52d9\u8cec\u865f\u5728\u5305\u542b Cloud SQL \u5be6\u4f8b\u7684\u9805\u76ee\u4e2d\u64c1\u6709\u9069\u7576\u7684\u6b0a\u9650\uff1a\n- \u8f49\u5230 Google Cloud Console \u4e2d\u7684 Compute Engine \u5be6\u4f8b\u5217\u8868\u3002 [\u8f49\u5230 Compute Engine \u5be6\u4f8b\u5217\u8868](https://console.cloud.google.com/compute/instances?hl=zh-cn) \n- \u5982\u6709\u5fc5\u8981\uff0c\u8acb\u9078\u64c7\u8207 Compute Engine \u5be6\u4f8b\u95dc\u806f\u7684\u9805\u76ee\u3002\n- \u9078\u64c7 Compute Engine \u5be6\u4f8b\uff0c\u986f\u793a\u5176\u5c6c\u6027\u3002\n- \u5728 Compute Engine \u5be6\u4f8b\u5c6c\u6027\u4e2d\uff0c\u8907\u88fd\u670d\u52d9\u8cec\u865f\u7684\u540d\u7a31\u3002\n- \u8f49\u5230 Google Cloud Console \u4e2d\u7684 **IAM \u548c\u7ba1\u7406\u9805\u76ee** \u9801\u9762\u3002 [\u8f49\u5230\u201cIAM \u548c\u7ba1\u7406\u9805\u76ee\u201d\u9801\u9762](https://console.cloud.google.com/iam-admin/iam/project?hl=zh-cn) \n- \u9078\u64c7\u5305\u542b Cloud SQL \u5be6\u4f8b\u7684\u9805\u76ee\u3002\n- \u641c\u7d22\u670d\u52d9\u8cec\u865f\u540d\u7a31\u3002\n- \u5982\u679c\u670d\u52d9\u8cec\u865f\u5df2\u5b58\u5728\uff0c\u4e14\u8a72\u8cec\u865f\u64c1\u6709\u4e00\u500b\u5305\u542b `cloudsql.instances.connect` \u6b0a\u9650\u7684\u89d2\u8272\uff0c\u5247\u60a8\u53ef\u4ee5\u524d\u9032\u81f3 [\u7b2c 4 \u6b65](#open-terminal) \u3002`Cloud SQL Client` \u3001 `Cloud SQL Editor` \u548c `Cloud SQL Admin` \u89d2\u8272\u5747\u63d0\u4f9b\u5fc5\u8981\u7684\u6b0a\u9650\uff0c\u5c31\u50cf\u820a\u7248 `Editor` \u548c `Owner` \u9805\u76ee\u89d2\u8272\u4e00\u6a23\u3002\n- \u5426\u5247\uff0c\u8acb\u9ede\u64ca **\u6dfb\u52a0** \u4ee5\u6dfb\u52a0\u670d\u52d9\u8cec\u865f\u3002\n- \u5728 **\u6dfb\u52a0\u4e3b\u8cec\u865f** \u5c0d\u8a71\u6846\u4e2d\uff0c\u63d0\u4f9b\u670d\u52d9\u8cec\u865f\u7684\u540d\u7a31\uff0c\u7136\u5f8c\u9078\u64c7\u4e00\u500b\u5305\u542b `cloudsql.instances.connect` \u6b0a\u9650\u7684\u89d2\u8272\uff08\u9664 Viewer \u4e4b\u5916\u7684\u4efb\u4f55 Cloud SQL \u9810\u5b9a\u7fa9\u89d2\u8272\u5747\u53ef\uff09\u3002\u6216\u8005\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u9078\u64c7 **\u9805\u76ee > Editor** \u4f7f\u7528\u57fa\u672c\u7684 Editor \u89d2\u8272\uff0c\u4f46 Editor \u89d2\u8272\u64c1\u6709\u6574\u500b Google Cloud \u7684\u6b0a\u9650\u3002\u5982\u679c\u60a8\u770b\u4e0d\u5230\u9019\u4e9b\u89d2\u8272\uff0c\u5247\u8868\u660e\u60a8\u7684 Google Cloud \u7528\u6236\u53ef\u80fd\u6c92\u6709 `resourcemanager.projects.setIamPolicy` \u6b0a\u9650\u3002\u60a8\u53ef\u4ee5\u901a\u904e\u8f49\u5230 Google Cloud Console \u4e2d\u7684 [IAM \u9801\u9762](https://console.cloud.google.com/iam-admin?hl=zh-cn) \u4e26\u641c\u7d22\u60a8\u7684\u7528\u6236 ID \u4f86\u6aa2\u67e5\u6b0a\u9650\u3002\n- \u9ede\u64ca **Add** \uff08\u6dfb\u52a0\uff09\u3002\u73fe\u5728\uff0c\u60a8\u5c07\u770b\u5230\u64c1\u6709\u6307\u5b9a\u89d2\u8272\u7684\u670d\u52d9\u8cec\u865f\u3002### 3.\u6253\u958b\u9023\u63a5\u5230 Compute Engine \u5be6\u4f8b\u7684\u7d42\u7aef\u9023\u63a5\u3002\u6839\u64da\u5be6\u4f8b\u7684\u64cd\u4f5c\u7cfb\u7d71\uff0c\u4f7f\u7528\u76f8\u61c9\u7684\u8aaa\u660e\uff1a- \u5c0d\u65bc Linux\uff0c\u8acb\u53c3\u95b1 [\u9023\u63a5\u5230 Linux \u5be6\u4f8b](https://cloud.google.com/compute/docs/instances/connecting-to-instance?hl=zh-cn#gcetools) \u3002\n- \u5c0d\u65bc Windows\uff0c\u8acb\u53c3\u95b1 [\u9023\u63a5\u5230 Windows \u5be6\u4f8b](https://cloud.google.com/compute/docs/instances/connecting-to-windows?hl=zh-cn) \u3002\u5982\u679c\u60a8\u7684 Compute Engine \u5be6\u4f8b\u6b63\u5728\u904b\u884c RHEL \u6216 CentOS \u516c\u958b\u6620\u50cf\uff0c\u5247 SELinux \u53ef\u80fd\u6703\u963b\u6b62\u4ee3\u7406\u9023\u63a5\u3002\u5982\u679c\u767c\u751f\u9019\u7a2e\u60c5\u6cc1\uff0c\u5fc5\u9808\u914d\u7f6e SELinux \u529f\u80fd\u4ee5\u5141\u8a31\u9023\u63a5\u3002\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u7528\u65bc RHEL \u7684 SELinux\uff0c\u8acb\u53c3\u95b1 [RHEL \u6587\u6a94](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/selinux_users_and_administrators_guide/index) \u3002  \u5982\u9700\u8a73\u7d30\u77ad\u89e3\u7528\u65bc CentOS \u7684 SELinux\uff0c\u8acb\u53c3\u95b1 [CentOS \u6587\u6a94](https://wiki.centos.org/HowTos/SELinux) \u3002\n### 4.\u5982\u679c\u5c1a\u672a\u5b89\u88dd psql \u5ba2\u6236\u7aef\uff0c\u8acb\u5c07\u5176\u5b89\u88dd\u5230 Compute Engine \u5be6\u4f8b\u4e0a\u3002\u901a\u904e\u8edf\u4ef6\u5305\u7ba1\u7406\u5668\u5b89\u88dd psql \u5ba2\u6236\u7aef\uff1a\n```\nsudo apt-get updatesudo apt-get install postgresql-client\n```\u901a\u904e\u8edf\u4ef6\u5305\u7ba1\u7406\u5668\u5b89\u88dd psql \u5ba2\u6236\u7aef\uff1a\n```\nsudo yum install postgresql\n```\u901a\u904e\u8edf\u4ef6\u5305\u7ba1\u7406\u5668\u5b89\u88dd psql \u5ba2\u6236\u7aef\uff1a\n```\nsudo zypper install postgresql\n```\n- \u5f9e [PostgreSQL \u4e0b\u8f09\u9801\u9762](https://www.postgresql.org/download/) \u4e0b\u8f09\u9069\u7528\u65bc\u60a8\u7684\u5e73\u81fa\u7684 PostgreSQL \u6838\u5fc3\u767c\u884c\u7248\u3002\u6838\u5fc3\u767c\u884c\u7248\u5305\u542b psql \u5ba2\u6236\u7aef\u3002\n- \u6309\u7167\u4e0b\u8f09\u9801\u9762\u4e0a\u7684\u8aaa\u660e\u5b89\u88dd PostgreSQL \u6578\u64da\u5eab\u3002\n### 5. \u5728 Compute Engine \u5be6\u4f8b\u4e0a\u5b89\u88dd Cloud SQL Auth \u4ee3\u7406\u3002- \u4e0b\u8f09 Cloud SQL Auth \u4ee3\u7406\uff1a```\ncurl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.9.0/cloud-sql-proxy.linux.amd64\n```\n- \u4f7f Cloud SQL Auth \u4ee3\u7406\u53ef\u57f7\u884c\uff1a```\nchmod +x cloud-sql-proxy\n```\n- \u4e0b\u8f09 Cloud SQL Auth \u4ee3\u7406\uff1a```\ncurl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.9.0/cloud-sql-proxy.linux.386\n```\n- \u5982\u679c\u627e\u4e0d\u5230`curl`\u547d\u4ee4\uff0c\u8acb\u904b\u884c`sudo apt install curl`\u4e26\u91cd\u5fa9\u57f7\u884c\u4e0b\u8f09\u547d\u4ee4\u3002\n- \u4f7f Cloud SQL Auth \u4ee3\u7406\u53ef\u57f7\u884c\uff1a```\nchmod +x cloud-sql-proxy\n```\u53f3\u9375\u9ede\u64ca\n [https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.9.0/cloud-sql-proxy.x64.exe](https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.9.0/cloud-sql-proxy.x64.exe) \n\uff0c\u7136\u5f8c\u9078\u64c7\n **\u93c8\u63a5\u53e6\u5b58\u7232** \n\u4ee5\u4e0b\u8f09 Cloud SQL Auth \u4ee3\u7406\u3002\u5c07\u6587\u4ef6\u91cd\u547d\u540d\u7232\n`cloud-sql-proxy.exe`\n\u3002\n\u53f3\u9375\u9ede\u64ca\n [https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.9.0/cloud-sql-proxy.x86.exe](https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.9.0/cloud-sql-proxy.x86.exe) \n\uff0c\u7136\u5f8c\u9078\u64c7\n **\u93c8\u63a5\u53e6\u5b58\u7232** \n\u4ee5\u4e0b\u8f09 Cloud SQL Auth \u4ee3\u7406\u3002\u5c07\u6587\u4ef6\u91cd\u547d\u540d\u7232\n`cloud-sql-proxy.exe`\n\u3002\nCloud SQL Auth \u4ee3\u7406\u6709\u4e0d\u540c\u7684\u5bb9\u5668\u6620\u50cf\uff0c\u4f8b\u5982 `distroless` \u3001 `alpine` \u548c `buster` \u3002\u9ed8\u8a8d\u7684 Cloud SQL Auth \u4ee3\u7406\u5bb9\u5668\u6620\u50cf\u4f7f\u7528\u4e0d\u5305\u542b shell \u7684 [distroless](https://github.com/GoogleContainerTools/distroless) \u3002\u5982\u679c\u60a8\u9700\u8981 shell \u6216\u76f8\u95dc\u5de5\u5177\uff0c\u8acb\u4e0b\u8f09\u57fa\u65bc `alpine` \u6216 `buster` \u7684\u6620\u50cf\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [Cloud SQL Auth \u4ee3\u7406\u5bb9\u5668\u6620\u50cf](https://github.com/GoogleCloudPlatform/cloudsql-proxy#container-images) \u3002\n\u60a8\u53ef\u4ee5\u901a\u904e Docker \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5c07\u6700\u65b0\u6620\u50cf\u62c9\u53d6\u5230\u672c\u5730\u6a5f\u5668\uff1a\n```\ndocker pull gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.9.0\n```\n **\u6ce8\u610f** \uff1aCloud SQL Auth \u4ee3\u7406\u4f7f\u7528\u652f\u6301`gcr.io`\u7db2\u57df\u4f46\u5f9e Artifact Registry \u50b3\u9001\u6620\u50cf\u7684\u5009\u5eab\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5f9e Container Registry \u8f49\u63db](https://cloud.google.com/artifact-registry/docs/transition/transition-from-gcr?hl=zh-cn) \u3002\n\u5c0d\u65bc\u6b64\u8655\u672a\u5217\u51fa\u7684\u5176\u4ed6\u64cd\u4f5c\u7cfb\u7d71\uff0c\u60a8\u53ef\u4ee5\n [\u901a\u904e\u6e90\u4ee3\u78bc\u7de8\u8b6f Cloud SQL Auth \u4ee3\u7406](http://github.com/GoogleCloudPlatform/cloudsql-proxy) \n\u3002\n### 6. \u5553\u52d5 Cloud SQL Auth \u4ee3\u7406\u3002 **\u6ce8\u610f** \uff1a\u5982\u679c Compute Engine \u5be6\u4f8b\u5177\u6709 **\u5b8c\u6574 API \u8a2a\u554f\u6b0a\u9650** \u6216 **Cloud SQL Admin API** \u7bc4\u570d\uff0c\u5247\u5553\u52d5 Cloud SQL Auth \u4ee3\u7406\u6642\u7121\u9700\u63d0\u4f9b\u8b49\u66f8\u6587\u4ef6\u3002\n\u60a8\u53ef\u4ee5\u4f7f\u7528 TCP \u5957\u63a5\u5b57\u3001Unix \u5957\u63a5\u5b57\u6216 Cloud SQL Auth \u4ee3\u7406 Docker \u6620\u50cf\u5553\u52d5 Cloud SQL Auth \u4ee3\u7406\uff0c\u5177\u9ad4\u4f7f\u7528\u54ea\u4e00\u500b\u8981\u53d6\u6c7a\u65bc\u60a8\u6240\u7528\u7684\u8a9e\u8a00\u548c\u74b0\u5883\u3002Cloud SQL Auth \u4ee3\u7406\u4e8c\u9032\u5236\u6587\u4ef6\u9023\u63a5\u5230\u547d\u4ee4\u884c\u4e2d\u6307\u5b9a\u7684\u4e00\u500b\u6216\u591a\u500b Cloud SQL \u5be6\u4f8b\uff0c\u4e26\u6253\u958b\u672c\u5730\u9023\u63a5\u4f5c\u7232 TCP \u6216 Unix \u5957\u63a5\u5b57\u3002\u5176\u4ed6\u61c9\u7528\u548c\u670d\u52d9\uff08\u4f8b\u5982\u60a8\u7684\u61c9\u7528\u4ee3\u78bc\u6216\u6578\u64da\u5eab\u7ba1\u7406\u5ba2\u6236\u7aef\u5de5\u5177\uff09\u53ef\u4ee5\u901a\u904e\u9019\u4e9b TCP \u6216 Unix \u5957\u63a5\u5b57\u9023\u63a5\u9023\u63a5\u5230 Cloud SQL \u5be6\u4f8b\u3002\n **\u8b66\u544a** \uff1a\u5c07 Cloud SQL \u8eab\u4efd\u9a57\u8b49\u4ee3\u7406\u7d81\u5b9a\u5230\u5916\u90e8\u63a5\u53e3\u6642\uff0c\u8acb\u52d9\u5fc5\u5c0f\u5fc3\u8b39\u614e\u3002\u4efb\u4f55\u6709\u6b0a\u8a2a\u554f\u8a72\u63a5\u53e3/\u7aef\u53e3\u7684\u7528\u6236\u90fd\u5c07\u6709\u6b0a\u9023\u63a5\u5230\u60a8\u7684\u5be6\u4f8b\u3002\n\u5c0d\u65bc TCP \u9023\u63a5\uff0cCloud SQL Auth \u4ee3\u7406\u9ed8\u8a8d\u76e3\u807d `localhost` ( `127.0.0.1` )\u3002\u56e0\u6b64\uff0c\u7576\u60a8\u7232\u5be6\u4f8b\u6307\u5b9a `--port PORT_NUMBER` \u6642\uff0c\u672c\u5730\u9023\u63a5\u4f4d\u65bc `127.0.0.1:PORT_NUMBER` \u3002\n\u6216\u8005\uff0c\u60a8\u4e5f\u53ef\u4ee5\u7232\u672c\u5730\u9023\u63a5\u6307\u5b9a\u5176\u4ed6\u5730\u5740\u3002\u4f8b\u5982\uff0c\u4e0b\u65b9\u5c55\u793a\u77ad\u5982\u4f55\u8b93 Cloud SQL Auth \u4ee3\u7406\u76e3\u807d `0.0.0.0:1234` \u7684\u672c\u5730\u9023\u63a5\uff1a\n```\n./cloud-sql-proxy --address 0.0.0.0 --port 1234 INSTANCE_CONNECTION_NAME\n```- \u8907\u88fd\u60a8\u7684 \u3002\u60a8\u53ef\u4ee5\u5728 [Google Cloud \u63a7\u5236\u6aaf](https://console.cloud.google.com/sql?hl=zh-cn) \u4e2d\u7684\u5be6\u4f8b **\u6982\u89bd** \u9801\u9762\u4e0a\u627e\u5230\u5b83\uff0c\u4e5f\u53ef\u4ee5\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u7372\u53d6\u8a72\u4fe1\u606f\uff1a```\n\u00a0 \u00a0 gcloud sql instances describe INSTANCE_NAME --format='value(connectionName)'\n```.\u4f8b\u5982\uff1a \u3002\n- \u5982\u679c\u5be6\u4f8b\u540c\u6642\u914d\u7f6e\u4e86\u516c\u5171 IP \u548c\u5c08\u7528 IP\uff0c\u4e26\u4e14\u60a8\u5e0c\u671b Cloud SQL Auth \u4ee3\u7406\u4f7f\u7528 [\u5c08\u7528 IP](https://cloud.google.com/sql/docs/postgres/configure-private-ip?hl=zh-cn) \u5730\u5740\uff0c\u60a8\u5fc5\u9808\u5728\u5553\u52d5 Cloud SQL Auth \u4ee3\u7406\u6642\u63d0\u4f9b\u4ee5\u4e0b\u9078\u9805\uff1a```\n--private-ip\n```\n- \u5982\u679c\u60a8\u8981\u4f7f\u7528\u670d\u52d9\u8cec\u865f\u5c0d Cloud SQL Auth \u4ee3\u7406\u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u8a18\u4e0b\u96a8\u670d\u52d9\u8cec\u865f\u4e00\u8d77\u5275\u5efa\u7684\u79c1\u9470\u6587\u4ef6\u5728\u5ba2\u6236\u7aef\u6a5f\u5668\u4e0a\u7684\u4f4d\u7f6e\u3002\n- \u5553\u52d5 Cloud SQL Auth \u4ee3\u7406\u3002\u4e00\u4e9b\u53ef\u80fd\u7684 Cloud SQL Auth \u4ee3\u7406\u8abf\u7528\u5b57\u7b26\u4e32\u5982\u4e0b\u6240\u793a\uff1a- \u4f7f\u7528 Cloud SDK \u8eab\u4efd\u9a57\u8b49\uff1a```\n./cloud-sql-proxy --port 5432 INSTANCE_CONNECTION_NAME\n```\u6307\u5b9a\u7684\u7aef\u53e3\u5fc5\u9808\u5c1a\u672a\u88ab\u672c\u5730\u6578\u64da\u5eab\u670d\u52d9\u5668\u7b49\u6240\u4f54\u7528\u3002\n- \u4f7f\u7528\u670d\u52d9\u8cec\u865f\u4e26\u660e\u78ba\u5305\u542b\u5be6\u4f8b\u9023\u63a5\u7684\u540d\u7a31\uff08\u5efa\u8b70\u7528\u65bc\u751f\u7522\u74b0\u5883\uff09\uff1a```\n./cloud-sql-proxy \\--credentials-file PATH_TO_KEY_FILE INSTANCE_CONNECTION_NAME &\n```\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3 Cloud SQL Auth \u4ee3\u7406\u9078\u9805\uff0c\u8acb\u53c3\u95b1 [\u7528\u65bc\u9a57\u8b49 Cloud SQL Auth \u4ee3\u7406\u8eab\u4efd\u7684\u9078\u9805](https://cloud.google.com/sql/docs/postgres/connect-auth-proxy?hl=zh-cn#authentication-options) \u548c [\u7528\u65bc\u6307\u5b9a\u5be6\u4f8b\u7684\u9078\u9805](https://cloud.google.com/sql/docs/postgres/connect-auth-proxy?hl=zh-cn#instances-options) \u3002\n **\u6ce8\u610f** \uff1aCloud SQL Auth \u4ee3\u7406\u76ee\u524d\u4e0d\u652f\u6301 Windows \u4e0a\u7684 Unix \u5957\u63a5\u5b57\uff0c\u56e0\u6b64\u6b64\u9078\u9805\u50c5\u9069\u7528\u65bc Linux \u548c macOS \u5e73\u81fa\u3002\nCloud SQL Auth \u4ee3\u7406\u53ef\u4ee5\u76e3\u807d Unix \u5957\u63a5\u5b57\uff0c\u8a72\u5957\u63a5\u5b57\u662f Posix \u6a19\u6e96\u6a5f\u5236\uff0c\u8a72\u6a5f\u5236\u4f7f\u7528\u6587\u4ef6\u593e\u4f86\u7ba1\u7406\u540c\u4e00\u4e3b\u6a5f\u4e0a\u904b\u884c\u7684\u5169\u500b\u9032\u7a0b\u4e4b\u9593\u7684\u901a\u4fe1\u3002\u4f7f\u7528 Unix \u5957\u63a5\u5b57\u7684\u512a\u52e2\u5728\u65bc\u63d0\u9ad8\u4e86\u5b89\u5168\u6027\u4e26\u7e2e\u77ed\u4e86\u5ef6\u9072\u6642\u9593\uff0c\u4f46\u60a8\u7121\u6cd5\u5f9e\u5916\u90e8\u6a5f\u5668\u8a2a\u554f Unix \u5957\u63a5\u5b57\u3002\n **\u6ce8\u610f** \uff1aPostgreSQL \u6a19\u6e96\u8981\u6c42\u5957\u63a5\u5b57\u8def\u5f91\u4e2d\u5305\u542b\u201c.s.PGSQL.5432\u201d\u5f8c\u7db4\u3002\u6709\u4e9b\u5eab\u6703\u81ea\u52d5\u61c9\u7528\u6b64\u5f8c\u7db4\uff0c\u4f46\u6709\u4e9b\u5eab\u5247\u6703\u8981\u6c42\u60a8\u6309\u4ee5\u4e0b\u683c\u5f0f\u6307\u5b9a\u5957\u63a5\u5b57\u8def\u5f91\uff1a```\n\u00a0 /cloudsql/INSTANCE_CONNECTION_NAME/.s.PGSQL.5432\u00a0 \n```\n\u5982\u9700\u5275\u5efa\u548c\u4f7f\u7528 Unix \u5957\u63a5\u5b57\uff0c\u76ee\u6a19\u76ee\u9304\u5fc5\u9808\u5b58\u5728\uff0c\u4e26\u4e14 Cloud SQL Auth \u4ee3\u7406\u548c\u61c9\u7528\u5fc5\u9808\u5c0d\u5176\u5177\u6709\u8b80\u5beb\u6b0a\u9650\u3002- \u5982\u679c\u60a8\u8981\u660e\u78ba\u6307\u5b9a\u5be6\u4f8b\uff0c\u8acb\u8907\u88fd\u60a8\u7684\u3002 \u60a8\u53ef\u4ee5\u5728 [Google Cloud \u63a7\u5236\u6aaf](https://console.cloud.google.com/sql?hl=zh-cn) \u4e2d\u7684\u5be6\u4f8b **\u6982\u89bd** \u9801\u9762\u4e0a\u6216\u8005\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u627e\u5230\u5b83\uff1a```\ngcloud sql instances describe INSTANCE_NAME --format='value(connectionName)'\n```\u4f8b\u5982\uff1a \u3002\n- \u5275\u5efa\u8981\u7528\u4f86\u5b58\u653e Cloud SQL Auth \u4ee3\u7406\u5957\u63a5\u5b57\u7684\u76ee\u9304\uff1a```\nsudo mkdir /cloudsql; sudo chmod 777 /cloudsql\n```\n- \u5982\u679c\u60a8\u8981\u4f7f\u7528\u670d\u52d9\u8cec\u865f\u5c0d Cloud SQL Auth \u4ee3\u7406\u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u8a18\u4e0b\u96a8\u670d\u52d9\u8cec\u865f\u4e00\u8d77\u5275\u5efa\u7684\u79c1\u9470\u6587\u4ef6\u5728\u5ba2\u6236\u7aef\u6a5f\u5668\u4e0a\u7684\u4f4d\u7f6e\u3002\n- \u6253\u958b\u65b0\u7684 Cloud Shell \u7d42\u7aef\u7a97\u53e3\u4e26\u5553\u52d5 Cloud SQL Auth \u4ee3\u7406\u3002\u4e00\u4e9b\u53ef\u80fd\u7684 Cloud SQL Auth \u4ee3\u7406\u8abf\u7528\u5b57\u7b26\u4e32\u5982\u4e0b\u6240\u793a\uff1a- \u4f7f\u7528\u670d\u52d9\u8cec\u865f\u4e26\u660e\u78ba\u5305\u542b\u5be6\u4f8b\u9023\u63a5\u7684\u540d\u7a31\uff08\u5efa\u8b70\u7528\u65bc\u751f\u7522\u74b0\u5883\uff09\uff1a```\n./cloud-sql-proxy --unix-socket /cloudsql--credentials-file PATH_TO_KEY_FILE INSTANCE_CONNECTION_NAME &\n```\n- \u4f7f\u7528 Cloud SDK \u8eab\u4efd\u9a57\u8b49\u548c\u81ea\u52d5\u5be6\u4f8b\u767c\u73fe\uff1a```\n./cloud-sql-proxy --unix-socket /cloudsql &\n```\n\u5728 Cloud SQL Auth \u4ee3\u7406\u81ea\u8eab\u7684 Cloud Shell \u7d42\u7aef\u4e2d\u5553\u52d5 Cloud SQL Auth \u4ee3\u7406\u4ee5\u4fbf\u76e3\u63a7\u5176\u8f38\u51fa\uff0c\u907f\u514d\u8207\u5176\u4ed6\u7a0b\u5e8f\u7684\u8f38\u51fa\u76f8\u6df7\u6dc6\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3 Cloud SQL Auth \u4ee3\u7406\u9078\u9805\uff0c\u8acb\u53c3\u95b1 [\u7528\u65bc\u9a57\u8b49 Cloud SQL Auth \u4ee3\u7406\u8eab\u4efd\u7684\u9078\u9805](https://cloud.google.com/sql/docs/postgres/connect-auth-proxy?hl=zh-cn#authentication-options) \u548c [\u7528\u65bc\u6307\u5b9a\u5be6\u4f8b\u7684\u9078\u9805](https://cloud.google.com/sql/docs/postgres/connect-auth-proxy?hl=zh-cn#instances-options) \u3002\n- **\u6ce8\u610f** \uff1a\u4f7f\u7528 Cloud SQL Auth \u4ee3\u7406\u548c unix \u5957\u63a5\u5b57\u9023\u63a5\u5230 Cloud SQL \u6642\uff0c\u8acb\u78ba\u4fdd\u5957\u63a5\u5b57\u6587\u4ef6\u540d\u7684\u9577\u5ea6\u4e0d\u8d85\u904e\u7cfb\u7d71\u9650\u5236\u3002\u4e00\u822c\u4f86\u8aaa\uff0c\u5957\u63a5\u5b57\u6587\u4ef6\u540d\u5305\u542b 91 \u5230 108 \u500b\u5b57\u7b26\uff0c\u5177\u9ad4\u53d6\u6c7a\u65bc\u60a8\u6240\u7528\u7684\u7cfb\u7d71\u3002\u5728 Linux \u4e0a\uff0c\u8a72\u6587\u4ef6\u540d\u901a\u5e38\u5305\u542b 108 \u500b\u5b57\u7b26\uff1b\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u9032\u884c\u6aa2\u67e5\uff1a```\ncat /usr/include/linux/un.h | grep \"define UNIX_PATH_MAX\"\n```\n\u5982\u9700\u5728 Docker \u5bb9\u5668\u4e2d\u904b\u884c Cloud SQL Auth \u4ee3\u7406\uff0c\u8acb\u4f7f\u7528 [Google Container Registry](https://cloud.google.com/container-registry?hl=zh-cn) \u63d0\u4f9b\u7684 Cloud SQL Auth \u4ee3\u7406 Docker \u6620\u50cf\u3002\n\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u6240\u793a\u547d\u4ee4\u901a\u904e TCP \u5957\u63a5\u5b57\u6216 Unix \u5957\u63a5\u5b57\u5553\u52d5 Cloud SQL Auth \u4ee3\u7406\u3002\u9019\u4e9b\u9078\u9805\u4f7f\u7528 \u4f5c\u7232\u9023\u63a5\u5b57\u7b26\u4e32\u4f86\u6a19\u8b58 Cloud SQL \u5be6\u4f8b\u3002\u60a8\u53ef\u4ee5\u5728 [Google Cloud \u63a7\u5236\u6aaf](https://console.cloud.google.com/sql?hl=zh-cn) \u4e2d\u7684\u5be6\u4f8b **\u6982\u89bd** \u9801\u9762\u4e0a\u6216\u8005\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u627e\u5230 \uff1a\n```\ngcloud sql instances describe INSTANCE_NAME\n```\n\u3002\n\u4f8b\u5982\uff1a `myproject:myregion:myinstance` \u3002\n\u6ce8\u610f\uff1a\u5728 Windows \u4e0a\uff0cCloud SQL Auth \u4ee3\u7406\u4e0d\u652f\u6301\u76e3\u807d Unix \u7db2\u57df\u5957\u63a5\u5b57\u3002\n\u60a8\u53ef\u4ee5\u4f7f\u7528 TCP \u5957\u63a5\u5b57\u6216 Unix \u5957\u63a5\u5b57\u5553\u52d5 Cloud SQL Auth \u4ee3\u7406\uff0c\u5177\u9ad4\u4f7f\u7528\u54ea\u4e00\u500b\u8981\u53d6\u6c7a\u65bc\u60a8\u6240\u7528\u7684\u8a9e\u8a00\u548c\u74b0\u5883\u3002\u63a1\u7528 Java \u7de8\u7a0b\u8a9e\u8a00\u7de8\u5beb\u7684\u61c9\u7528\u6216 Windows \u74b0\u5883\u4e0d\u652f\u6301 Unix \u5957\u63a5\u5b57\u3002```\ndocker run -d \\\\\u00a0 -v PATH_TO_KEY_FILE:/path/to/service-account-key.json \\\\\u00a0 -p 127.0.0.1:5432:5432 \\\\\u00a0 gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.9.0 \\\\\u00a0 --address 0.0.0.0 --port 5432 \\\\\u00a0 --credentials-file /path/to/service-account-key.json INSTANCE_CONNECTION_NAME\n```\n\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f Compute Engine \u5be6\u4f8b\u63d0\u4f9b\u7684\u6191\u64da\uff0c\u8acb\u52ff\u5305\u542b `--credentials-file` \u53c3\u6578\u548c `-v :/path/to/service-account-key.json` \u884c\u3002\n\u8acb\u52d9\u5fc5\u5728 -p \u4e2d\u6307\u5b9a `127.0.0.1` \u524d\u7db4\uff0c\u4ee5\u514d Cloud SQL Auth \u4ee3\u7406\u5728\u672c\u5730\u4e3b\u6a5f\u5916\u90e8\u516c\u958b\u3002\u82e5\u8981\u5f9e Docker \u5bb9\u5668\u5916\u90e8\u8a2a\u554f\u7aef\u53e3\uff0c\u9700\u8981\u5728\u5be6\u4f8b\u53c3\u6578\u4e2d\u6307\u5b9a\u201c0.0.0.0\u201d\u3002```\ndocker run -d -v /cloudsql:/cloudsql \\\\\u00a0 -v PATH_TO_KEY_FILE:/path/to/service-account-key.json \\\\\u00a0 gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.9.0 --unix-socket=/cloudsql \\\\\u00a0 --credentials-file /path/to/service-account-key.json INSTANCE_CONNECTION_NAME\n```\n\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f Compute Engine \u5be6\u4f8b\u63d0\u4f9b\u7684\u6191\u64da\uff0c\u8acb\u52ff\u5305\u542b `--credentials-file` \u53c3\u6578\u548c `-v :/path/to/service-account-key.json` \u884c\u3002\n\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f\u5bb9\u5668\u512a\u5316\u578b\u6620\u50cf\uff0c\u8acb\u4f7f\u7528\u53ef\u5beb\u76ee\u9304\u4ee3\u66ff `/cloudsql` \uff0c\u4f8b\u5982\uff1a\n```\n-v /mnt/stateful_partition/cloudsql:/cloudsql\n```\n\u60a8\u53ef\u4ee5\u6307\u5b9a\u591a\u500b\u5be6\u4f8b\uff08\u7528\u82f1\u6587\u9017\u865f\u5206\u9694\uff09\uff0c\u60a8\u9084\u53ef\u4ee5\u4f7f\u7528 [Compute Engine \u5143\u6578\u64da](https://cloud.google.com/compute/docs/metadata?hl=zh-cn) \u4ee5\u52d5\u614b\u65b9\u5f0f\u78ba\u5b9a\u8981\u9023\u63a5\u7684\u5be6\u4f8b\u3002 [\u8a73\u7d30\u77ad\u89e3 Cloud SQL Auth \u4ee3\u7406\u53c3\u6578\u3002](https://cloud.google.com/sql/docs/postgres/sql-proxy?hl=zh-cn#flags) \n### 7. \u5553\u52d5 psql \u6703\u8a71\u3002\u4f7f\u7528\u7684\u9023\u63a5\u5b57\u7b26\u4e32\u53d6\u6c7a\u65bc\u60a8\u662f\u4f7f\u7528 TCP \u5957\u63a5\u5b57\u9084\u662f UNIX \u5957\u63a5\u5b57\u5553\u52d5 Cloud SQL Auth \u4ee3\u7406\u3002\n- \u5553\u52d5 psql \u5ba2\u6236\u7aef\uff1a```\npsql \"host=127.0.0.1 sslmode=disable dbname=DB_NAME user=USERNAME\"\n```\u5373\u4f7f `sslmode` \u53c3\u6578\u8a2d\u7f6e\u7232 `disable` \uff0cCloud SQL Auth \u4ee3\u7406\u4e5f\u6703\u63d0\u4f9b\u52a0\u5bc6\u9023\u63a5\u3002\u4f7f\u7528 TCP \u5957\u63a5\u5b57\u5efa\u7acb\u9023\u63a5\u6642\uff0c\u53ef\u901a\u904e `127.0.0.1` \u8a2a\u554f Cloud SQL Auth \u4ee3\u7406\u3002\n- \u5982\u679c\u51fa\u73fe\u63d0\u793a\uff0c\u8acb\u8f38\u5165\u5bc6\u78bc\u3002\n- \u7cfb\u7d71\u6703\u986f\u793a psql \u63d0\u793a\u7b26\u3002\n- \u5553\u52d5 psql \u5ba2\u6236\u7aef\uff1a```\npsql \"sslmode=disable host=/cloudsql/INSTANCE_CONNECTION_NAME dbname=DB_NAME user=USERNAME\"\n```\u5373\u4f7f `sslmode` \u53c3\u6578\u8a2d\u7f6e\u7232 `disable` \uff0cCloud SQL Auth \u4ee3\u7406\u4e5f\u6703\u63d0\u4f9b\u52a0\u5bc6\u9023\u63a5\u3002\n- \u8f38\u5165\u5bc6\u78bc\u3002\n- \u7cfb\u7d71\u6703\u986f\u793a psql \u63d0\u793a\u7b26\u3002\n\u9700\u8981\u5e6b\u52a9\uff1f\u5982\u9700\u7372\u5f97\u4ee3\u7406\u554f\u984c\u6392\u67e5\u65b9\u9762\u7684\u5e6b\u52a9\uff0c\u8acb\u53c3\u95b1 [Cloud SQL Auth \u4ee3\u7406\u9023\u63a5\u554f\u984c\u6392\u67e5](https://cloud.google.com/sql/docs/postgres/connect-auth-proxy?hl=zh-cn#troubleshooting) \uff0c\u6216\u53c3\u95b1\u6211\u5011\u7684 [Cloud SQL \u652f\u6301](https://cloud.google.com/sql/docs/postgres/getting-support?hl=zh-cn) \u9801\u9762\u3002\n## \u5f8c\u7e8c\u6b65\u9a5f- \u7372\u5f97 Cloud SQL Auth \u4ee3\u7406 [\u9023\u63a5\u554f\u984c\u6392\u67e5](https://cloud.google.com/sql/docs/postgres/connect-auth-proxy?hl=zh-cn#troubleshooting) \u65b9\u9762\u7684\u5e6b\u52a9\u3002\n- \u5275\u5efa [\u7528\u6236](https://cloud.google.com/sql/docs/postgres/create-manage-users?hl=zh-cn) \u548c [\u6578\u64da\u5eab](https://cloud.google.com/sql/docs/postgres/create-manage-databases?hl=zh-cn) \u3002\n- \u8a73\u7d30\u77ad\u89e3 [\u5c08\u7528 IP](https://cloud.google.com/sql/docs/postgres/private-ip?hl=zh-cn) \u3002\n- \u77ad\u89e3 [\u5f9e\u61c9\u7528\u9023\u63a5\u5230\u5be6\u4f8b\u7684\u9078\u9805](https://cloud.google.com/sql/docs/postgres/connect-overview?hl=zh-cn#external-connection-methods) \u3002\n- \u77ad\u89e3 [psql \u5ba2\u6236\u7aef](https://www.postgresql.org/docs/current/static/app-psql.html) \u3002\n- \u77ad\u89e3 [\u652f\u6301\u9078\u9805](https://cloud.google.com/sql/docs/support?hl=zh-cn) \u3002", "guide": "Cloud SQL"}