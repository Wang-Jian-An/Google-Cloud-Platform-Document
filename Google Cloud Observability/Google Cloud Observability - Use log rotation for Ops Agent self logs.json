{"title": "Google Cloud Observability - Use log rotation for Ops Agent self logs", "url": "https://cloud.google.com/stackdriver/docs/solutions/agents/ops-agent/rotate-logs", "abstract": "# Google Cloud Observability - Use log rotation for Ops Agent self logs\nThe Ops Agent writes to a log file called `logging-module.log` . When the agent runs unattended for long periods or when a problem occurs, this \"self log\" file can consume all available disk space. This document describes how to use log rotation to prevent this problem.\nOps Agent version 2.31.0 introduces a configurable log-rotation feature built into the agent. If you are running Ops Agent version 2.31.0 or newer, then you can use the built-in log-rotation feature; see [Configure log rotation in the Ops Agent](#configure-log-rotation) .\nYou can also manage log rotation manually. You might need a manual process if you are using a version of the Ops Agent without built-in log rotation, or if you prefer to rotate your logs manually. See [Set up self-log filerotation on Linux VMs](#rotate-self-logs) for one possible approach.\n", "content": "## Configure log rotation in the Ops Agent\nThis section describes how to modify the default log-rotation configuration used by Ops Agent to rotate its logs automatically. Using this feature requires Ops Agent version 2.31.0 or newer.\n### Default configuration\nThe Ops Agent uses the `default_self_log_file_rotation` entry to configure log rotation. This configuration entry takes three options; the following snippet shows the options and their default values:\n```\n default_self_log_file_rotation:\n enabled: true\n max_file_size_megabytes: 400\n backup_count: 1\n```\nThe `default_self_log_file_rotation` configuration takes three options:\n- `enabled`: Whether log rotation is enabled; default is`true`.\n- `max_file_size_megabytes`: The maximum size the log file can reach before it is backed up by log rotation. Measured in megabytes (1024bytes). Default is 400, minimum valid value is 1.\n- `backup_count`: The number of old log files to retain. Default is 1, minimum valid value is 1.\n### User configuration of log rotation\nTo modify the default log-rotation configuration, you override that configuration by redefining the configuration in the Ops Agent user-configuration file:\n- On Linux:`/etc/google-cloud-ops-agent/config.yaml`\n- On Windows:`C:\\Program Files\\Google\\Cloud Operations\\Ops Agent\\config\\config.yaml`\n**Note:** If you make any changes to the configuration file, then you must [restart the agent](/stackdriver/docs/solutions/agents/ops-agent/installation#restart) to apply the updated configurations.\nTo configure log rotation in the Ops Agent, add a `global` section to the user configuration file and include the configuration element `default_self_log_file_rotation` in the `global` section. You might already have logging or metrics pipelines in the this configuration file; add the `global` section after your pipelines. The result, specifying all options and default values, looks like the following:\n```\nlogging: ...\nmetrics: ...\nglobal:\n default_self_log_file_rotation:\n enabled: true\n max_file_size_megabytes: 400\n backup_count: 1\n```\n### Example configurations\nTo disable log rotation by the Ops Agent, specify the `enabled` option with the value `false` :\n```\nlogging: ...\nmetrics: ...\nglobal:\n default_self_log_file_rotation:\n enabled: false\n```\nTo rotate the log when the log file reaches 20 MB and keep 5 backups (6 files total):\n```\nlogging: ...\nmetrics: ...\nglobal:\n default_self_log_file_rotation:\n max_file_size_megabytes: 20\n backup_count: 5\n```\nTo rotate the log when the log file reaches 2,000 MB (2 GB) and keep 1 backup (2 files total):\n```\nlogging: ...\nmetrics: ...\nglobal:\n default_self_log_file_rotation:\n max_file_size_megabytes: 2000\n```\nTo rotate the log when the log file reaches 400 MB and keep 2 backups (3 files total):\n```\nlogging: ...\nmetrics: ...\nglobal:\n default_self_log_file_rotation:\n backup_count: 2\n```\nIf you make frequent changes as you refine your log-rotation configuration, remember to [restart the agent](/stackdriver/docs/solutions/agents/ops-agent/installation#restart) to apply your changes.\n## Set up self-log file rotation on Linux VMs\nTo limit the size of the logging sub-agent log at `/var/log/google-cloud-ops-agent/subagents/logging-module.log` , install and configure the `logrotate` utility.\n- Install the `logrotate` utility by running the following command: **On Debian and Ubuntu** ```\nsudo apt install logrotate\n``` **On CentOS, RHEL and Fedora** ```\nsudo yum install logrotate\n```\n- Create a `logrotate` config file at `/etc/logrotate.d/google-cloud-ops-agent.conf` .```\nsudo tee /etc/logrotate.d/google-cloud-ops-agent.conf > /dev/null << EOF# logrotate config to rotate Google Cloud Ops Agent self log file.# See https://manpages.debian.org/jessie/logrotate/logrotate.8.en.html for# the full options./var/log/google-cloud-ops-agent/subagents/logging-module.log{\u00a0 \u00a0 # Log files are rotated every day.\u00a0 \u00a0 daily\u00a0 \u00a0 # Log files are rotated this many times before being removed. This\u00a0 \u00a0 # effectively limits the disk space used by the Ops Agent self log files.\u00a0 \u00a0 rotate 30\u00a0 \u00a0 # Log files are rotated when they grow bigger than maxsize even before the\u00a0 \u00a0 # additionally specified time interval\u00a0 \u00a0 maxsize 256M\u00a0 \u00a0 # Skip rotation if the log file is missing.\u00a0 \u00a0 missingok\u00a0 \u00a0 # Do not rotate the log if it is empty.\u00a0 \u00a0 notifempty\u00a0 \u00a0 # Old versions of log files are compressed with gzip by default.\u00a0 \u00a0 compress\u00a0 \u00a0 # Postpone compression of the previous log file to the next rotation\u00a0 \u00a0 # cycle.\u00a0 \u00a0 delaycompress}EOF\n```\n- Set up [crontab](https://linux.die.net/man/5/crontab) or [systemdtimer](https://wiki.archlinux.org/title/Systemd/Timers) to trigger the `logrotate` utility periodically.\nAfter the log rotation takes effect, you see rotated files in the `/var/log/google-cloud-ops-agent/subagents/` directory. The results look similar to the following output:\n```\n/var/log/google-cloud-ops-agent/subagents$ ls -lhtotal 24K-rw-r--r-- 1 root root \u00a0717 Sep \u00a03 19:54 logging-module.log-rw-r--r-- 1 root root 6.8K Sep \u00a03 19:51 logging-module.log.1-rw-r--r-- 1 root root \u00a0874 Sep \u00a03 19:50 logging-module.log.2.gz-rw-r--r-- 1 root root \u00a0873 Sep \u00a03 19:50 logging-module.log.3.gz-rw-r--r-- 1 root root 3.2K Sep \u00a03 19:34 logging-module.log.4.gz\n```\nTo test log rotation, do the following:\n- Temporarily reduce the file size at which rotation is triggered by setting the `maxsize` value to `1k` in the `/etc/logrotate.d/google-cloud-ops-agent.conf` file.\n- Trigger the agent self log file to be larger than 1K by restarting the agent a few times:```\nsudo service google-cloud-ops-agent restart\n```\n- Wait for the `crontab` or `systemd timer` to take effect to trigger the `logrotate` utility, or trigger the `logrotate` utility manually by running this command:```\nsudo logrotate /etc/logrotate.d/google-cloud-ops-agent.conf\n```\n- Verify that you see rotated log files in the `/var/log/google-cloud-ops-agent/subagents/` directory.\n- Reset the log-rotation configuration by restoring the original `maxsize` value.", "guide": "Google Cloud Observability"}