{"title": "Google Cloud Observability - Argo Workflows", "url": "https://cloud.google.com/stackdriver/docs/managed-prometheus/exporters/argo-workflows", "abstract": "# Google Cloud Observability - Argo Workflows\nThis document describes how to configure your Google Kubernetes Engine deployment so that you can use Google Cloud Managed Service for Prometheus to collect metrics from Workflows Controller. This document shows you how to do the following:\n- Set up Workflows Controller to report metrics.\n- Configure a PodMonitoring resource for Managed Service for Prometheus  to collect the exported metrics.\n- Access a dashboard in Cloud Monitoring to view the metrics.\n- Configure alerting rules to monitor the metrics.These instructions apply only if you are using [managed collection](/stackdriver/docs/managed-prometheus/setup-managed) with Managed Service for Prometheus. If you are using self-deployed collection, then see the [Workflows documentation](https://github.com/argoproj/argo-workflows/) for installation information.\nFor information about Workflows, see [Argo Workflows](https://argoproj.github.io/argo-workflows/) .\n", "content": "## Prerequisites\nTo collect metrics from Workflows Controller by using Managed Service for Prometheus and managed collection, your deployment must meet the following requirements:\n- Your cluster must be running Google Kubernetes Engine version  1.21.4-gke.300 or later.\n- You must be running Managed Service for Prometheus  with managed collection enabled. For more information, see [  Get started with managed collection](/stackdriver/docs/managed-prometheus/setup-managed) .\n- To use dashboards available in Cloud Monitoring for the  Workflows integration, you must use`argo-workflows`version v3.4.3 or later.For more information about available dashboards, see [View dashboards](#monitoring-dashboard) .\n- Set up port forwarding by using the following command:```\nkubectl -n NAMESPACE_NAME port-forward POD_NAME 9090\n```\n- Access the endpoint `localhost:9090/metrics` by using the browser or the `curl` utility in another terminal session.## Define a PodMonitoring resource\nFor target discovery, the Managed Service for Prometheus Operator requires a PodMonitoring resource that corresponds to the Workflows exporter in the same namespace.\nYou can use the following PodMonitoring configuration:\n[View on GitHub](https://github.com/GoogleCloudPlatform/prometheus-engine/blob/HEAD/examples/argo-workflows/pod-monitoring.yaml)\n```\n# Copyright 2023 Google LLC\n## Licensed under the Apache License, Version 2.0 (the \"License\");# you may not use this file except in compliance with the License.# You may obtain a copy of the License at\n## \u00a0 \u00a0 https://www.apache.org/licenses/LICENSE-2.0\n## Unless required by applicable law or agreed to in writing, software# distributed under the License is distributed on an \"AS IS\" BASIS,# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.# See the License for the specific language governing permissions and# limitations under the License.apiVersion: monitoring.googleapis.com/v1kind: PodMonitoringmetadata:\u00a0 name: argo-workflows-controller\u00a0 labels:\u00a0 \u00a0 app.kubernetes.io/name: argo-workflows-controller\u00a0 \u00a0 app.kubernetes.io/part-of: google-cloud-managed-prometheusspec:\u00a0 endpoints:\u00a0 - port: 9090\u00a0 \u00a0 scheme: http\u00a0 \u00a0 interval: 30s\u00a0 \u00a0 path: /metrics\u00a0 selector:\u00a0 \u00a0 matchLabels:\u00a0 \u00a0 \u00a0 app: workflow-controller\n```\n`port`\n`matchLabels`\n`app: workflow-controller`\nTo apply configuration changes from a local file, run the following command:\n```\nkubectl apply -n NAMESPACE_NAME -f FILE_NAME\n```\nYou can also [use Terraform](/stackdriver/docs/managed-prometheus/setup-managed#terraform-scrape) to manage your configurations.\n## Define rules and alerts\nYou can use the following `Rules` configuration to define alerts on your Workflows metrics:\n[View on GitHub](https://github.com/GoogleCloudPlatform/prometheus-engine/blob/HEAD/examples/argo-workflows/rules.yaml)\n```\n# Copyright 2023 Google LLC\n## Licensed under the Apache License, Version 2.0 (the \"License\");# you may not use this file except in compliance with the License.# You may obtain a copy of the License at\n## \u00a0 \u00a0 https://www.apache.org/licenses/LICENSE-2.0\n## Unless required by applicable law or agreed to in writing, software# distributed under the License is distributed on an \"AS IS\" BASIS,# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.# See the License for the specific language governing permissions and# limitations under the License.apiVersion: monitoring.googleapis.com/v1kind: Rulesmetadata:\u00a0 name: argo-workflows-rules\u00a0 labels:\u00a0 \u00a0 app.kubernetes.io/component: rules\u00a0 \u00a0 app.kubernetes.io/name: argo-workflows-rules\u00a0 \u00a0 app.kubernetes.io/part-of: google-cloud-managed-prometheusspec:\u00a0 groups:\u00a0 - name: argo-workflows\u00a0 \u00a0 interval: 30s\u00a0 \u00a0 rules:\u00a0 \u00a0 - alert: ArgoWorkflowsWorkflowErrors\u00a0 \u00a0 \u00a0 annotations:\u00a0 \u00a0 \u00a0 \u00a0 description: |-\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Argo Workflows workflow errors\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 VALUE = {{ $value }}\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 LABELS: {{ $labels }}\u00a0 \u00a0 \u00a0 \u00a0 summary: Argo Workflows workflow errors (instance {{ $labels.instance }})\u00a0 \u00a0 \u00a0 expr: argo_workflows_error_count > 0\u00a0 \u00a0 \u00a0 for: 5m\u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 severity: critical\n```\nTo apply configuration changes from a local file, run the following command:\n```\nkubectl apply -n NAMESPACE_NAME -f FILE_NAME\n```\nYou can also [use Terraform](/stackdriver/docs/managed-prometheus/setup-managed#terraform-scrape) to manage your configurations.\nFor more information about applying rules to your cluster, see [Managed rule evaluation and alerting](/stackdriver/docs/managed-prometheus/rules-managed) .\n## Verify the configuration\nYou can use Metrics Explorer to verify that you correctly configured the Workflows exporter. It might take one or two minutes for Cloud Monitoring to ingest your metrics.\nTo verify the metrics are ingested, do the following:\n- In the navigation panel of the Google Cloud console, select **Monitoring** , and then select **Metrics explorer** : [Go to Metrics explorer](https://console.cloud.google.com/monitoring/metrics-explorer) \n- In the toolbar of the query-builder pane, select the button whose name is either **MQL** or **PromQL** .\n- Verify that **PromQL** is selected in the **Language** toggle. The language toggle is in the same toolbar that lets you format your query.\n- Enter and run the following query:```\nup{job=\"argo-workflows-controller\", cluster=\"CLUSTER_NAME\", namespace=\"NAMESPACE_NAME\"}\n```\n## View dashboards\nThe Cloud Monitoring integration includes the **Workflows Prometheus Overview** dashboard. Dashboards are automatically installed when you configure the integration. You can also view static previews of dashboards without installing the integration.\nTo view an installed dashboard, do the following:\n- In the navigation panel of the Google Cloud console, select **Monitoring** , and then select **Dashboards** : [Go to Dashboards](https://console.cloud.google.com/monitoring/dashboards) \n- Select the **Dashboard List** tab.\n- Choose the **Integrations** category.\n- Click the name of the dashboard, for example, **Workflows Prometheus Overview** .To view a static preview of the dashboard, do the following:\n- In the navigation panel of the Google Cloud console, select **Monitoring** , and then select **Integrations** : [Go to Integrations](https://console.cloud.google.com/monitoring/integrations) \n- Click the **Kubernetes Engine** deployment-platform filter.\n- Locate the Argo Workflows integration and click **View Details** .\n- Select the **Dashboards** tab.\n## Troubleshooting\nFor information about troubleshooting metric ingestion problems, see [Problems with collection from exporters](/stackdriver/docs/managed-prometheus/troubleshooting#exporter-problems) in [Troubleshooting ingestion-side problems](/stackdriver/docs/managed-prometheus/troubleshooting#ingest-problems) .", "guide": "Google Cloud Observability"}