{"title": "Google Cloud Observability - Manage VMs covered by the Ops Agent OS policy", "url": "https://cloud.google.com/stackdriver/docs/solutions/agents/ops-agent/manage-policies-auto-install", "abstract": "# Google Cloud Observability - Manage VMs covered by the Ops Agent OS policy\nIf you created Compute Engine VMs with the Ops Agent installed during creation or, in some cases, if you [installed the agent on existingVMs by using the Google Cloud console](/stackdriver/docs/solutions/agents/ops-agent/installation#gce-ui-install) , then Google Cloud also created VM Manager OS policies that install and monitor the Ops Agent. This document describes how to query those Ops Agent OS policies and manage the Ops Agent on VMs covered by the policies. For information about creating VMs with the Ops Agent automatically installed, see [Install the Ops Agent during VM creation](/stackdriver/docs/solutions/agents/ops-agent/install-agent-vm-creation) .\nAfter an Ops Agent OS policy has been created, you can do the following:\n- Determine which VMs are covered by the policy.\n- Determine which zones are covered by the policy.\n- Extend policy coverage to existing VMs.\n- Uninstall the agent from a VM covered by the policy.", "content": "## Find VMs covered by Ops Agent OS policies\nYou can use the Google Cloud console or the Google Cloud CLI to see which VMs in your Google Cloud project are covered by Ops Agent OS policies through an OS policy assignment. If you believe a VM is missing coverage, you can troubleshoot by doing the following:\n- [Verify that a VM has an Ops Agent OS policy label](/stackdriver/docs/solutions/agents/ops-agent/manage-policies-auto-install#view-label) .\n- [Verify that an Ops Agent OS policy assignment was successfully rolled out](/stackdriver/docs/solutions/agents/ops-agent/manage-policies-auto-install#view-assignments) .\n### Verify that an Ops Agent OS policy is assigned to VMs in a zone\nTo verify that the VMs in a zone are covered by the Ops Agent OS policy, use either the Google Cloud console or the gcloud CLI to see whether the VM is related to an Ops Agent OS policy assignment.\n- In the navigation panel of the Google Cloud console, select **Compute Engine** , and then select **OS policies** : [Go to OS policies](https://console.cloud.google.com/compute/config/instances) \n- On the **VM instances** tab, select the VM that you want to check.\n- If the VM is covered by an Ops Agent OS policy, then the **OS policy id** column includes `goog-ops-agent-policy` and the state is \"Compliant\".\nTo display a list of Ops Agent OS policy assignments in a zone, run the following command:\n```\ngcloud compute os-config os-policy-assignment-reports list --location=ZONE --filter=\"ASSIGNMENT_ID ~ goog-ops-agent\"\n```\nThe output shows a list of VMs with an Ops Agent OS policy assignment. If the Ops Agent is installed on the VM, the Summary column has a value of \"1/1 policies compliant\".\n```\nINSTANCE ASSIGNMENT_ID         LOCATION UPDATE_TIME     SUMMARY\ninstance-1 goog-ops-agent-v2-x86-template-1-0-0-us-east4-c us-east4-c 2023-04-28T02:11:15.118088Z 1/1 policies compliant\ninstance-3 goog-ops-agent-v2-x86-template-1-0-0-us-east4-c us-east4-c 2023-04-28T02:11:15.118088Z 1/1 policies compliant\n```\n### Verify that a VM has an Ops Agent OS policy label\nTo see which VMs in your Google Cloud project have the Ops Agent OS policy label, `goog-ops-agent-policy` , use either the Google Cloud console or the gcloud CLI.\n- In the navigation panel of the Google Cloud console, select **Compute Engine** , and then select **VM instances** : [Go to VM instances](https://console.cloud.google.com/compute) \n- Select the name of your VM.\n- In the **Basic information** panel, locate the **Labels** entry.If the VM is covered by the Ops Agent OS policy, then it has a label like `goog-ops-agent-policy:v2-x86-template-` `` .\nTo see all the VMs that have the Ops Agent OS policy label `goog-ops-agent-policy` , run the following command:\n```\ngcloud compute instances list --format=\"table(name,zone,labels)\" --filter=\"labels=goog-ops-agent-policy\"\n```\nThe output shows the name, zone, and labels of the VMs. For example:\n```\nNAME     ZONE   LABELS\ntest-vm1    us-central1-a {'goog-ops-agent-policy': 'v2-x86-template-1-0-0'}\ntest-vm1    us-east4-c  {'goog-ops-agent-policy': 'v2-x86-template-1-0-0'}\n```\nTo see whether a specific VM has the Ops Agent OS policy label, run the following command:\n```\ngcloud compute instances describe --format \"yaml(labels)\" --zone=ZONE VM_NAME\n```\nThe output shows a list of labels for your VM. If your VM has the Ops Agent OS policy label, then `goog-ops-agent-policy` appears in the `labels` list. For example:\n```\nlabels:\n goog-ops-agent-policy: v2-x86-template-1-0-0\n```\n### Verify that an Ops Agent OS policy assignment was successfully rolled out\nView your Google Cloud project OS policy assignments to verify that an Ops Agent OS policy assignment was correctly deployed to a specific zone.\n- In the navigation panel of the Google Cloud console, select **Compute Engine** , and then select **OS policies** : [Go to OS policies](https://console.cloud.google.com/compute/config/instances) \n- To see the state of OS policy rollouts, click the **OS policy assignments** tab.Ops Agent OS policy assignments have IDs that start with the string \"goog-ops-agent\". If the assignment was rolled out successfully, then it has a rollout state of \"Succeeded\".\nTo view all Ops Agent OS policy assignments in a zone, run the following command:\n```\ngcloud compute os-config os-policy-assignments list --location=ZONE --filter=\"ASSIGNMENT_ID ~ goog-ops-agent\"\n```\nThe output shows a list of Ops Agent OS policy assignments in a zone. If the assignment was rolled out successfully, then it has a rollout state of \"SUCCEEDED\". For example:\n```\nASSIGNMENT_ID          ROLLOUT_STATE REVISION_CREATE_TIME  REVISION_ID \ngoog-ops-agent-v2-x86-template-1-4-0-us-central1-b SUCCEEDED  2023-01-28T05:23:41Z.  940df3e9-77fd-470b-84df-53fb24825c4a\ngoog-ops-agent-v2-x86-template-1-0-0-us-central1-b SUCCEEDED  2022-01-28T05:23:41Z.  qwareaff-efte-erew-aeet-faer234t4gga\n```\nTo view details about a specific Ops Agent OS policy assignment, run the following command:\n```\ngcloud compute os-config os-policy-assignments describe POLICY_ASSIGNMENT_ID --location=ZONE\n```\n## Uninstall the Ops Agent on VMs covered by the Ops Agent OS policy\nIf you manually [uninstall the Ops Agent](/stackdriver/docs/solutions/agents/ops-agent/installation#uninstall) on a VM covered by the Ops Agent OS policy, then the policy re-installs it. To uninstall the Ops Agent, you must first remove the `goog-ops-agent-policy` label from the VM. After you have removed the Ops Agent OS policy label from a VM, you can uninstall the Ops Agent permanently.\n### Uninstall the Ops Agent on a specific VM\nTo remove the policy and uninstall the Ops Agent from a specific VM, you can use the Google Cloud console or the gcloud CLI.\n- In the navigation panel of the Google Cloud console, select **Compute Engine** , and then select **VM instances** : [Go to VM instances](https://console.cloud.google.com/compute) \n- Select the name of the VM that you want to edit.\n- Click **Edit** .\n- Go to the **Labels** section and then click **+ Add Labels** .\n- Locate the label with the key `goog-ops-agent-policy` and click **Delete item** .\n- [Uninstall the agent](/stackdriver/docs/solutions/agents/ops-agent/installation#uninstall) .- To remove the `goog-ops-agent-policy` label from a VM, run the following command:```\ngcloud compute instances update VM_NAME \\\n --remove-labels=goog-ops-agent-policy\n```\n- [Uninstall the agent](/stackdriver/docs/solutions/agents/ops-agent/installation#uninstall) .\n### Uninstall the Ops Agent on all VMs\nTo uninstall the Ops Agent from VMs in zone that has an Ops Agent OS policy assignment, use the script provided by Cloud Monitoring. You can't uninstall the agent from a group of VMs by using the Google Cloud console.\nTo run the script, you must have the [GuestPolicy Editor role](/iam/docs/understanding-roles#osconfig.guestPolicyEditor) ( `roles/osconfig.guestPolicyEditor` ).\nRun the following script in Cloud Shell. You can provide any number of zones:\n```\ncurl -sSO https://dl.google.com/cloudagents/undo-ops-agent-policies.sh\nbash undo-ops-agent-policies.sh ZONE1 ZONE2\n```\nThe script performs the following tasks in each zone:\n- Finds all Ops Agent OS policies.\n- Edits each policy so that it uninstalls the Ops Agent on its covered VMs.\n- Deletes the Ops Agent OS policy.\n- Removes the`goog-ops-agent-policy`label from each covered VM.## Add Ops Agent OS policy coverage to an existing VM\nThe Ops Agent OS policy covers only VMs that have the `goog-ops-agent-policy` label and are in the same zone as an existing Ops Agent OS policy assignment. However, you can extend coverage to other VMs that were created without the Ops Agent OS policy assigned to them.\nTo extend policy coverage to a VM, you need to know the template version of the Ops Agent OS policy assignment in your zone. If your zone has multiple Ops Agent OS policy assignments, then find the assignment with the latest template version. To show a list of Ops Agent OS policy assignments in a zone, run the following command:\n```\ngcloud compute os-config os-policy-assignments list --location=ZONE\n --filter=\"ASSIGNMENT_ID ~ goog-ops-agent\"\n```\nTo extend policy coverage to other VMs, use either the Google Cloud console or the gcloud CLI:\n- In the navigation panel of the Google Cloud console, select **Compute Engine** , and then select **VM instances** : [Go to VM instances](https://console.cloud.google.com/compute) \n- In the **VM instances** list, select the checkboxes next to the VMs that you want to label and then click **Labels** .\n- To add labels, click **+Add label** and add the key-value pair. The key must be `goog-ops-agent-policy` and the value is the desired template version, such as `` .\n- Save your changes.\nTo extend policy coverage to a VM without coverage, run the following commands:\n```\ngcloud compute instances update VM_NAME --zone=ZONE\n --update-labels=goog-ops-agent-policy:v2-x86-template-1-0-0\n```\n```\ngcloud compute instances add-metadata VM_NAME --zone=ZONE\n --metadata=enable-osconfig=TRUE\n```\n## Permission\nOps Agent installation uses VM Manager and requires permissions to activate the VM Manager API and create a policy. The required permissions are all available using the [Editor role](/iam/docs/understanding-roles#editor) ( `roles/Editor` ). Or you can ask a project administrator to grant the minimal permissions using the Google Cloud CLI.\nRequired permissions for installing the Ops Agent during VM creation:\n- `serviceusage.services.get`\n- `serviceusage.services.enable`\n- `osconfig.osPolicyAssignments.get`\n- `osconfig.osPolicyAssignments.create`\n- `osconfig.projectBillingConfigs.update`\n- `compute.instances.create`\nRequired permissions for installing Ops Agent on existing VMs:\n- `serviceusage.services.get`\n- `serviceusage.services.enable`\n- `osconfig.osPolicyAssignments.get`\n- `osconfig.osPolicyAssignments.create`\n- `osconfig.projectBillingConfigs.update`\n- `compute.instances.setMetadata`\n- `compute.instances.setLabels`\nYou can find corresponding roles that provide those permissions in [IAM basic and predefined roles reference](/iam/docs/understanding-roles) , with the exception of the `osconfig.projectBillingConfigs.update` permission. This permission is included in the `osconfig.projectBillingConfig` role. This role is not available in Google Cloud console but can be granted through gcloud CLI.\nSample commands to grant roles for permissions:\n```\ngcloud projects add-iam-policy-binding project-id --member='user:user-email' --role='roles/osconfig.projectBillingConfigEditor'\n```", "guide": "Google Cloud Observability"}