{"title": "Google Cloud Observability - Troubleshoot Ops Agent installation and start-up", "url": "https://cloud.google.com/stackdriver/docs/solutions/agents/ops-agent/troubleshoot-install-startup", "abstract": "# Google Cloud Observability - Troubleshoot Ops Agent installation and start-up\nThis document provides information to help you diagnose and resolve problems in the installation and start-up of the Ops Agent. If the agent is running but failing to ingest logs or metrics, see [Troubleshoot data ingestion](/stackdriver/docs/solutions/agents/ops-agent/troubleshoot-run-ingest) .\n", "content": "## Before you begin\nBefore trying to fix a problem, check the status of the agent's [health checks](/stackdriver/docs/solutions/agents/ops-agent/troubleshoot-find-info#health-checks) .\n## Agent fails to install\nYou may encounter the following errors when running the [installationscript](/stackdriver/docs/solutions/agents/ops-agent/installation#joint-install) .\n### The operating system isn't supported\nWhen the operating system isn't supported, the installation of the Ops Agent fails. The error message might look similar to the following:\n**Linux**\n```\nhttps://packages.cloud.google.com/yum/repos/google-cloud-ops-agent-el6-x86_64-all/repodata/repomd.xml: [Errno 14] PYCURL ERROR 22 - \"The requested URL returned error: 404 Not Found\"\nTrying other mirror.\nTo address this issue please refer to the below wiki article\nhttps://wiki.centos.org/yum-errors\nIf above article doesn't help to resolve this issue please use https://bugs.centos.org/.\nError: Cannot retrieve repository metadata (repomd.xml) for repository: google-cloud-ops-agent. Please verify its path and try again\n```\n### A legacy agent is installed that conflicts with the Ops Agent\nWhen a VM already has the [Cloud Logging agent](/logging/docs/agent/logging) or the [Cloud Monitoring agent](/monitoring/agent/monitoring) installed, they conflict with the new agent. The error message might look similar to the following:\n**Linux**\n```\nError:\n Problem: problem with installed package stackdriver-agent-6.0.5-1.el8.x86_64 - package google-cloud-ops-agent-0.1.0-1.el8.x86_64 conflicts with stackdriver-agent provided by stackdriver-agent-6.0.5-1.el8.x86_64\n```\nThe Ops Agent uses new configuration files that aren't compatible with the old agents. For more information, refer to the [Configure the Ops Agent](/stackdriver/docs/solutions/agents/ops-agent/configuration) guide.\nTo fix this error, do the following:\n- Save the custom configuration files for the [Cloud Monitoring agent](/monitoring/agent/custom-metrics-agent#agent-artifacts) and the [Cloud Logging agent](/logging/docs/agent/configuration#configure) .\n- Uninstall the old [Cloud Monitoring agent](/monitoring/agent/monitoring/installation#uninstall) and [Cloud Logging agent](/logging/docs/agent/logging/installation#uninstall) .After you uninstall the agent, the Google Cloud console might take up to one hour to report this change.\n### Ops Agent install fails after failed Monitoring agent install\nThe installation of the Ops Agent fails after a failed attempt to install the Monitoring agent. On a Debian operating system, the error messages when the Ops Agent fails to install are similar to the following:\n**Linux**\n```\n...\nE: The repository 'https://packages.cloud.google.com/apt google-cloud-monitoring-jammy-all Release' does not have a Release file.\n...\nCould not refresh the google-cloud-ops-agent apt repositories.\n```\nIf you try to install the Monitoring agent on an operating system that isn't supported by that agent, then the installation fails. The installation failure occurs after the Monitoring agent repository is added to the system. Installing the Ops Agent after a failed install of the Monitoring agent also fails due to an invalid Monitoring agent repository.\nNot all operating systems supported by the Ops Agent are also supported by the Monitoring agent. For information about supported operating systems, see [Ops Agent: Linux operating systems](/monitoring/agent/ops-agent#linux_operating_systems) and [Monitoring agent: Linux operating systems](/monitoring/agent/monitoring#linux_operating_systems) .\nTo install the Ops Agent, do the following:\n- Remove the repository for the Monitoring agent:If the script `add-monitoring-agent-repo.sh` is on your system, then run the following command:```\nsudo bash add-monitoring-agent-repo.sh --remove-repo\n```Otherwise, manually remove the repository:\n```\nsudo rm /etc/apt/sources.list.d/google-cloud-monitoring.list\n``````\n sudo rm /etc/yum.repos.d/google-cloud-monitoring.repo\n``````\nsudo rm /etc/zypp/repos.d/google-cloud-monitoring.repo\n```\n- Run the Ops Agent installation script.\n### Ops Agent install fails because the repository refresh fails\nThe installation of the Ops Agent fails because the refresh of the installed repositories fails.\n**Linux**\nFor an example of the failure message for a Debian operating system, where the repository refresh occurs due to a call to `apt-get update` , see the troubleshooting entry [Ops Agent install fails after failed Monitoring agent install](#invalid-magent-repo) .\nIf you encounter failures when refreshing the repositories, then you must resolve those failures before you can install the Ops Agent. You might be able to resolve these failures by deleting or disabling repositories that aren't necessary.\nAfter you are able to refresh the repositories, you can install the Ops Agent by running the Ops Agent installation script.\n## Agent is installed but not running\nIf you have installed the agent but the agent is not running, then the problem might be one of the following:\n- One of the primary components, \"Metrics Agent\" or \"Logging Agent\", has failed to start; see [Agent services not running](#systemd-not-running) .\n- One of the legacy agents is also installed on the VM; see [Conflict withcurrently installed agents](#legacy-conflict) .\n- A port that one of the components requires is in use by another process; see [Unavailable port](#port-errors) .\n- The configuration of the Ops Agent is invalid; see [Invalidconfiguration](#invalid_configuration) .\n### Agent services not running\nWhen the agent services are running as expected, the Metrics Agent and Logging Agent are listed as running when you query the status:\n**For Linux**\n```\nsudo systemctl status google-cloud-ops-agent\"*\"\n```\nSome lines in the output have been deleted for brevity.\n```\n\u25cf google-cloud-ops-agent.service - Google Cloud Ops Agent\n  Loaded: loaded (/lib/systemd/system/google-cloud-ops-agent.service; enabled; vendor preset: enabled)\n  Active: active (exited) since Wed 2023-05-03 21:22:28 UTC; 4 weeks 0 days ago\n Process: 3353828 ExecStartPre=/opt/google-cloud-ops-agent/libexec/google_cloud_ops_agent_engine -in /etc/go>\n Process: 3353837 ExecStart=/bin/true (code=exited, status=0/SUCCESS)\n Main PID: 3353837 (code=exited, status=0/SUCCESS)\n  CPU: 195ms\n[...]\n\u25cf google-cloud-ops-agent-opentelemetry-collector.service - Google Cloud Ops Agent - Metrics Agent\n  Loaded: loaded (/lib/systemd/system/google-cloud-ops-agent-opentelemetry-collector.service; static)\n  Active: active (running) since Wed 2023-05-03 21:22:29 UTC; 4 weeks 0 days ago\n Process: 3353840 ExecStartPre=/opt/google-cloud-ops-agent/libexec/google_cloud_ops_agent_engine -service=ot>\n Main PID: 3353855 (otelopscol)\n  Tasks: 9 (limit: 2355)\n  Memory: 65.3M\n  CPU: 40min 31.555s\n  CGroup: /system.slice/google-cloud-ops-agent-opentelemetry-collector.service\n    \u2514\u25003353855 /opt/google-cloud-ops-agent/subagents/opentelemetry-collector/otelopscol --config=/run/g>\n[...]\n\u25cf google-cloud-ops-agent-fluent-bit.service - Google Cloud Ops Agent - Logging Agent\n  Loaded: loaded (/lib/systemd/system/google-cloud-ops-agent-fluent-bit.service; static)\n  Active: active (running) since Wed 2023-05-03 21:22:29 UTC; 4 weeks 0 days ago\n Process: 3353838 ExecStartPre=/opt/google-cloud-ops-agent/libexec/google_cloud_ops_agent_engine -service=fl>\n Main PID: 3353856 (google_cloud_op)\n  Tasks: 31 (limit: 2355)\n  Memory: 58.3M\n  CPU: 29min 6.771s\n  CGroup: /system.slice/google-cloud-ops-agent-fluent-bit.service\n    \u251c\u25003353856 /opt/google-cloud-ops-agent/libexec/google_cloud_ops_agent_wrapper -config_path /etc/goo>\n    \u2514\u25003353872 /opt/google-cloud-ops-agent/subagents/fluent-bit/bin/fluent-bit --config /run/google-clo>\n[...]\n\u25cf google-cloud-ops-agent-diagnostics.service - Google Cloud Ops Agent - Diagnostics\n  Loaded: loaded (/lib/systemd/system/google-cloud-ops-agent-diagnostics.service; disabled; vendor preset: e>\n  Active: active (running) since Wed 2023-05-03 21:22:26 UTC; 4 weeks 0 days ago\n Main PID: 3353819 (google_cloud_op)\n  Tasks: 8 (limit: 2355)\n  Memory: 36.0M\n  CPU: 3min 19.488s\n  CGroup: /system.slice/google-cloud-ops-agent-diagnostics.service\n    \u2514\u25003353819 /opt/google-cloud-ops-agent/libexec/google_cloud_ops_agent_diagnostics -config /etc/goog>\n[...]\n```\n**For Windows**\n```\nGet-Service google-cloud-ops-agent*\nStatus Name    DisplayName\n------ ----    ----------Running google-cloud-op... Google Cloud Ops Agent\nRunning google-cloud-op... Google Cloud Ops Agent - Logging Agent\nRunning google-cloud-op... Google Cloud Ops Agent - Metrics Agent\nRunning google-cloud-op... Google Cloud Ops Agent - Diagnostics\n```\nIf the agent service is not running, you might see the following status:\n**Linux**\n```\n$ sudo service google-cloud-ops-agent status\n\u25cf google-cloud-ops-agent.service - Google Cloud Ops Agent\n Loaded: loaded (/lib/systemd/system/google-cloud-ops-agent.service; enabled; vendor preset: enabled)\n Active: inactive (dead) since Wed 2021-06-30 21:20:43 UTC; 6s ago\n```\n**Windows**\n```\nGet-Service google-cloud-ops-agent\nStatus Name     DisplayName\n------ ----     ----------Stopped google-cloud-ops-agent Google Cloud Ops Agent\n```\nTo fix this error, run the following command to start the service:\n**Linux**\n```\nsudo service google-cloud-ops-agent start\n```\n**Windows**\n```\nStart-Service google-cloud-ops-agent\n```\nIf the service fails to start, the configuration might be invalid.\n### Conflict with currently installed agents\n- The VM already has the [Cloud Logging agent](/logging/docs/agent/logging) or the [Cloud Monitoring agent](/monitoring/agent/monitoring) installed, and their configuration conflicts with the new agent's configuration. The error message might look similar to the following: **Windows** ```\nWe detected an existing Windows service for the StackdriverLogging agent,\nwhich is not compatible with the Ops Agent when the Ops Agent configuration\nhas a non-empty logging section. Please either remove the logging section\nfrom the Ops Agent configuration, or disable the StackdriverLogging agent,\nand then retry enabling the Ops Agent.\n```To fix this error, you have two options:- Disable the conflicting section of the Ops Agent configuration file. For more information, refer to the [Configure the Ops Agent](/stackdriver/docs/solutions/agents/ops-agent/configuration) guide.\n- Disable the conflicting [Cloud Logging agent](/logging/docs/agent/logging) or the [Cloud Monitoring agent](/monitoring/agent/monitoring) .- Save any custom configuration files for the [Cloud Loggingagent](/logging/docs/agent/logging/configuration#configure) .\n- Uninstall the old [Cloud Monitoring agent](/monitoring/agent/monitoring/installation#uninstall) and [Cloud Logging agent](/logging/docs/agent/logging/installation#uninstall) .\nAfter you uninstall the agent, the Google Cloud console might take up to one hour to report this change.\n### Required port is unavailable\nThe Ops Agent or one of its components can fail to start when the port needed by the component is being used by another process. The Ops Agent uses the following ports:\n- Port 20201, for the \"Metrics Agent\" component\n- Port 20202, for the \"Logging Agent\" component\nIf a process other than an Ops Agent component is using port 20201 or port 20202, then stop that process and restart the Ops Agent. Use the following steps to determine which process is using the ports:\n**Metrics Agent component** : To see which process is using port 20201, use the following command:\n```\nsudo netstat -ns -p | grep '20201'\n```\nThe following output shows the expected result: the Ops Agent metrics collector, `otelopscol` , is using the port:\n```\ntcp  0  0 127.0.0.1:50138   127.0.0.1:20201   ESTABLISHED 16850/otelopscol\ntcp6  0  0 :::20201    :::*     LISTEN  16850/otelopscol\ntcp6  0  0 127.0.0.1:20201   127.0.0.1:50138   ESTABLISHED 16850/otelopscol\n```\n **Logging Agent component** : To see which process is using port 20202, use the following command:\n```\nsudo netstat -ns -p | grep '20202'\n```\nThe following output shows the expected result: the Ops Agent logs collector, `fluent-bit` , is using the port:\n```\ntcp  0  0 0.0.0.0:20202   0.0.0.0:*    LISTEN  16640/fluent-bit\ntcp  0  0 127.0.0.1:20202   127.0.0.1:52998   TIME_WAIT \n``` **Metrics Agent component** : To see which process is using port 20201, use the following command:\n```\nnetstat -na -b | Select-String \"20201\" -Context 0,1\n```\nThe following output shows the expected result: the Ops Agent metrics collector, `google-cloud-metrics-agent_windows_amd64.exe` , is using the port:\n```\n> TCP 0.0.0.0:20201   0.0.0.0:0    LISTENING\n [google-cloud-metrics-agent_windows_amd64.exe]\n> TCP 127.0.0.1:20201  127.0.0.1:50090  ESTABLISHED\n [google-cloud-metrics-agent_windows_amd64.exe]\n> TCP 127.0.0.1:50090  127.0.0.1:20201  ESTABLISHED\n [google-cloud-metrics-agent_windows_amd64.exe]\n> TCP [::]:20201    [::]:0     LISTENING\n [google-cloud-metrics-agent_windows_amd64.exe]\n```\n **Logging Agent component** : To see which process is using port 20202, use the following command:\n```\nnetstat -na -b | Select-String \"20202\" -Context 0,1\n```\nThe following output shows the expected result: the Ops Agent logs collector, `fluent-bit.exe` , is using the port:\n```\n> TCP 0.0.0.0:20202   0.0.0.0:0    LISTENING\n [fluent-bit.exe]\n> TCP 127.0.0.1:20202  127.0.0.1:57535  TIME_WAIT\n> TCP 127.0.0.1:20202  127.0.0.1:57539  TIME_WAIT\n TCP 127.0.0.1:49807  127.0.0.1:49808  ESTABLISHED\n```\nPort-availability errors can be detected by the [health checks](/stackdriver/docs/solutions/agents/ops-agent/troubleshoot-find-info#health-checks) run by the Ops Agent.\n### Agent lacks API permissions\nIf the agent fails to start or fails to ingest data, then the problem might be that the \"Metrics Agent\" or \"Logging agent\" component lacks the necessary permission to access the API.\nThe service account used by the Ops Agent requires the following Identity and Access Management roles:\n- For the \"Logging Agent\" component: [Logs Writer (roles/logging.logWriter)](/logging/docs/access-control#logging.logWriter) \n- For the \"Metrics Agent\" component: [Monitoring Metric Writer (roles/monitoring.metricWriter)](/monitoring/access-control#mon_roles_desc) .\nThese roles include the permissions needed to write logging or metric data and must be granted to the service account associated with the VM. The service account you are using depends on how you configured the VM and authorized the agent. You might be using one of the following:\n- A service account [attached to theVM](/stackdriver/docs/solutions/agents/ops-agent/authorization#authorize_with_an_attached_service_account) .\n- A service account [that uses a privatekey](/stackdriver/docs/solutions/agents/ops-agent/authorization#private_key_authorization) .\nTo identify the service account associated with a VM, do the following:\n- In the navigation panel of the Google Cloud console, select **Compute Engine** , and then select **VM instances** : [Go to VM instances](https://console.cloud.google.com/compute) \n- If necessary, click the drop-down list of Google Cloud projects and select the name of your project.\n- Select the **Instances** tab if necessary.\n- In the list of VM instances, click on the name of the VM to view the **Details** page for the VM.\n- Locate the **API and identity management** section of the page. The service account is listed as the value of the **Service account** field.\nFor information about setting the roles granted to the service account, see [Verify and modify roles of an existing serviceaccount](/stackdriver/docs/solutions/agents/ops-agent/authorization#update-svc-acct) .\nAPI-permission errors can be detected by the [health checks](/stackdriver/docs/solutions/agents/ops-agent/troubleshoot-find-info#health-checks) run by the Ops Agent.\n### Invalid configuration\nIf the configuration is invalid, you might see the following error when trying to restart the agent service:\n**Linux**\n```\n$ sudo service google-cloud-ops-agent restart \\\n && sudo service google-cloud-ops-agent status\n\u25cf google-cloud-ops-agent-fluent-bit.service - Google Cloud Ops Agent - Logging Agent\n Loaded: loaded (/usr/lib/systemd/system/google-cloud-ops-agent-fluent-bit.service; static; vendor preset: disabled)\n Drop-In: /usr/lib/systemd/system/google-cloud-ops-agent-fluent-bit.service.d\n   \u2514\u2500directories.conf\n Active: failed (Result: exit-code) since Wed 2021-06-30 22:21:08 UTC; 2s ago\n Process: 1141421 ExecStart=/opt/google-cloud-ops-agent/subagents/fluent-bit/bin/fluent-bit --config ${RUNTIME_DIRECTORY}/fluent_bit_main.conf --parser ${RUNTIME_DIRECTORY}/fluent_bit_parser.conf --log_>\n Process: 1141847 ExecStartPre=/opt/google-cloud-ops-agent/libexec/google_cloud_ops_agent_engine -service=fluentbit -in /etc/google-cloud-ops-agent/config.yaml -logs ${LOGS_DIRECTORY} -state ${STATE_DIR>\n Main PID: 1141421 (code=exited, status=0/SUCCESS)\nJun 30 22:21:08 centos8-2 systemd[1]: google-cloud-ops-agent-fluent-bit.service: Control process exited, code=exited status=1\nJun 30 22:21:08 centos8-2 systemd[1]: google-cloud-ops-agent-fluent-bit.service: Failed with result 'exit-code'.\nJun 30 22:21:08 centos8-2 systemd[1]: Failed to start Google Cloud Ops Agent - Logging Agent.\nJun 30 22:21:08 centos8-2 systemd[1]: google-cloud-ops-agent-fluent-bit.service: Service RestartSec=100ms expired, scheduling restart.\nJun 30 22:21:08 centos8-2 systemd[1]: google-cloud-ops-agent-fluent-bit.service: Scheduled restart job, restart counter is at 5.\nJun 30 22:21:08 centos8-2 systemd[1]: Stopped Google Cloud Ops Agent - Logging Agent.\nJun 30 22:21:08 centos8-2 systemd[1]: google-cloud-ops-agent-fluent-bit.service: Start request repeated too quickly.\nJun 30 22:21:08 centos8-2 systemd[1]: google-cloud-ops-agent-fluent-bit.service: Failed with result 'exit-code'.\nJun 30 22:21:08 centos8-2 systemd[1]: Failed to start Google Cloud Ops Agent - Logging Agent.\n```\nUse `journalctl` to get the exact error message:\n```\nsudo journalctl -xe | grep \"google_cloud_ops_agent_engine\"\n```\nYou might see a message similar to the following:\n```\nJun 30 22:00:26 centos8-2 google_cloud_ops_agent_engine[1141491]: 2021/06/30 22:00:26 the agent config file is not valid YAML. detailed error: yaml: line 21: did not find expected key\n```\n**Windows**\n```\nfailed to generate config files: can't parse configuration: yaml: line 20: could not find expected ':'\n```\nTo fix the error, correct the invalid configuration and restart the agent. For reference, refer to the [Configure the Ops Agent](/stackdriver/docs/solutions/agents/ops-agent/configuration) guide.\n### Agent crashes and report mentions NVIDIA\nYou are attempting to run the Ops Agent on a Compute Engine VM with [attached GPUs](https://cloud.google.com/compute/docs/gpus/create-vm-with-gpus) . The agent crashes, and the output mentions NVIDIA.\n## Status information in the Google Cloud console is wrong\nThe Google Cloud console reports information about the status of agents on Compute Engine VMs in various dashboards, for example, the **VM Instances** dashboard in Cloud Monitoring. If this information does not match what you expect, the cause might simply be a delay as configuration changes work their way thought the system. But unexpected information might also indicate that the agent isn't running as you expect.\n### Installed agent reported by Google Cloud console as undetected\nThe agent must be running and ingesting data for the Google Cloud console to recognize that the agent is present. If you have installed the agent but the console status remains \"Not Detected\", then the agent is not running or it is running and not ingesting data. For more information, see the following:\n- [Agent is installed but not running](#agent-not-running) .\n- [Agent is running, but data is not ingested](/stackdriver/docs/solutions/agents/ops-agent/troubleshoot-run-ingest#data-not-ingested) .\n### Removed agent reported by Google Cloud console as installed\nAfter you uninstall the agent, the Google Cloud console might take up to one hour to report this change.", "guide": "Google Cloud Observability"}