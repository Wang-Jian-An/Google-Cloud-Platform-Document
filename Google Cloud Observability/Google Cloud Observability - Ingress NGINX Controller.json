{"title": "Google Cloud Observability - Ingress NGINX Controller", "url": "https://cloud.google.com/stackdriver/docs/managed-prometheus/exporters/ingress-nginx", "abstract": "# Google Cloud Observability - Ingress NGINX Controller\nThis document describes how to configure your Google Kubernetes Engine deployment so that you can use Google Cloud Managed Service for Prometheus to collect metrics from the Ingress NGINX Controller. This document shows you how to do the following:\n- Set up the Ingress NGINX Controller to report metrics.\n- Configure a PodMonitoring resource for Managed Service for Prometheus  to collect the exported metrics.\n- Access a dashboard in Cloud Monitoring to view the metrics.\n- Configure alerting rules to monitor the metrics.These instructions apply only if you are using [managed collection](/stackdriver/docs/managed-prometheus/setup-managed) with Managed Service for Prometheus. If you are using self-deployed collection, then see the [Ingress NGINX documentation](https://kubernetes.github.io/ingress-nginx/user-guide/monitoring/) for installation information.\nFor information about Ingress NGINX, see [Ingress NGINX](https://kubernetes.github.io/ingress-nginx) .\n", "content": "## Prerequisites\nTo collect metrics from the Ingress NGINX Controller by using Managed Service for Prometheus and managed collection, your deployment must meet the following requirements:\n- Your cluster must be running Google Kubernetes Engine version  1.21.4-gke.300 or later.\n- You must be running Managed Service for Prometheus  with managed collection enabled. For more information, see [  Get started with managed collection](/stackdriver/docs/managed-prometheus/setup-managed) .```\n kubectl exec -n NAMESPACE_NAME deploy/ingress-nginx-controller -- curl http://localhost:10254/metrics\n \n```\n## Define a PodMonitoring resource\nFor target discovery, the Managed Service for Prometheus Operator requires a PodMonitoring resource that corresponds to the Ingress NGINX exporter in the same namespace.\nYou can use the following PodMonitoring configuration:\n[View on GitHub](https://github.com/GoogleCloudPlatform/prometheus-engine/blob/HEAD/examples/ingress-nginx/pod-monitoring.yaml)\n```\n# Copyright 2022 Google LLC\n## Licensed under the Apache License, Version 2.0 (the \"License\");# you may not use this file except in compliance with the License.# You may obtain a copy of the License at\n## \u00a0 \u00a0 https://www.apache.org/licenses/LICENSE-2.0\n## Unless required by applicable law or agreed to in writing, software# distributed under the License is distributed on an \"AS IS\" BASIS,# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.# See the License for the specific language governing permissions and# limitations under the License.apiVersion: monitoring.googleapis.com/v1kind: PodMonitoringmetadata:\u00a0 name: ingress-nginx\u00a0 labels:\u00a0 \u00a0 app.kubernetes.io/name: ingress-nginx\u00a0 \u00a0 app.kubernetes.io/part-of: google-cloud-managed-prometheusspec:\u00a0 endpoints:\u00a0 - port: 10254\u00a0 \u00a0 scheme: http\u00a0 \u00a0 interval: 30s\u00a0 \u00a0 path: /metrics\u00a0 selector:\u00a0 \u00a0 matchLabels:\u00a0 \u00a0 \u00a0 app.kubernetes.io/name: ingress-nginx\n```\n`port`\n`matchLabels`\n`app.kubernetes.io/name: ingress-nginx`\nTo apply configuration changes from a local file, run the following command:\n```\nkubectl apply -n NAMESPACE_NAME -f FILE_NAME\n```\nYou can also [use Terraform](/stackdriver/docs/managed-prometheus/setup-managed#terraform-scrape) to manage your configurations.\n## Define rules and alerts\nYou can use the following `Rules` configuration to define alerts on your Ingress NGINX metrics:\n[View on GitHub](https://github.com/GoogleCloudPlatform/prometheus-engine/blob/HEAD/examples/ingress-nginx/rules.yaml)\n```\n# Copyright 2022 Google LLC\n## Licensed under the Apache License, Version 2.0 (the \"License\");# you may not use this file except in compliance with the License.# You may obtain a copy of the License at\n## \u00a0 \u00a0 https://www.apache.org/licenses/LICENSE-2.0\n## Unless required by applicable law or agreed to in writing, software# distributed under the License is distributed on an \"AS IS\" BASIS,# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.# See the License for the specific language governing permissions and# limitations under the License.apiVersion: monitoring.googleapis.com/v1kind: Rulesmetadata:\u00a0 name: ingress-nginx-rules\u00a0 labels:\u00a0 \u00a0 app.kubernetes.io/component: rules\u00a0 \u00a0 app.kubernetes.io/name: ingress-nginx-rules\u00a0 \u00a0 app.kubernetes.io/part-of: google-cloud-managed-prometheusspec:\u00a0 groups:\u00a0 - name: ingress-nginx\u00a0 \u00a0 interval: 30s\u00a0 \u00a0 rules:\u00a0 \u00a0 - alert: NGINXIngressDroppedConnections\u00a0 \u00a0 \u00a0 annotations:\u00a0 \u00a0 \u00a0 \u00a0 description: |-\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 NGINX Ingress dropped connections\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 VALUE = {{ $value }}\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 LABELS: {{ $labels }}\u00a0 \u00a0 \u00a0 \u00a0 summary: NGINX Ingress dropped connections (instance {{ $labels.instance }})\u00a0 \u00a0 \u00a0 expr: (nginx_ingress_controller_nginx_process_connections_total{state=\"accepted\"} - nginx_ingress_controller_nginx_process_connections_total{state=\"handled\"}) > 0\u00a0 \u00a0 \u00a0 for: 5m\u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 severity: critical\u00a0 \u00a0 - alert: NGINXIngressHighRequestRate\u00a0 \u00a0 \u00a0 annotations:\u00a0 \u00a0 \u00a0 \u00a0 description: |-\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 NGINX Ingress high request rate\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 VALUE = {{ $value }}\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 LABELS: {{ $labels }}\u00a0 \u00a0 \u00a0 \u00a0 summary: NGINX Ingress high request rate (instance {{ $labels.instance }})\u00a0 \u00a0 \u00a0 expr: rate(nginx_ingress_controller_requests[5m]) > 100\u00a0 \u00a0 \u00a0 for: 5m\u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 severity: warning\u00a0 \u00a0 - alert: NGINXIngressLowRequestRate\u00a0 \u00a0 \u00a0 annotations:\u00a0 \u00a0 \u00a0 \u00a0 description: |-\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 NGINX Ingress low request rate\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 VALUE = {{ $value }}\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 LABELS: {{ $labels }}\u00a0 \u00a0 \u00a0 \u00a0 summary: NGINX Ingress low request rate (instance {{ $labels.instance }})\u00a0 \u00a0 \u00a0 expr: rate(nginx_ingress_controller_requests[5m]) < 10\u00a0 \u00a0 \u00a0 for: 5m\u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 severity: warning\n```\nTo apply configuration changes from a local file, run the following command:\n```\nkubectl apply -n NAMESPACE_NAME -f FILE_NAME\n```\nYou can also [use Terraform](/stackdriver/docs/managed-prometheus/setup-managed#terraform-scrape) to manage your configurations.\nFor more information about applying rules to your cluster, see [Managed rule evaluation and alerting](/stackdriver/docs/managed-prometheus/rules-managed) .\n## Verify the configuration\nYou can use Metrics Explorer to verify that you correctly configured the Ingress NGINX exporter. It might take one or two minutes for Cloud Monitoring to ingest your metrics.\nTo verify the metrics are ingested, do the following:\n- In the navigation panel of the Google Cloud console, select **Monitoring** , and then select **Metrics explorer** : [Go to Metrics explorer](https://console.cloud.google.com/monitoring/metrics-explorer) \n- In the toolbar of the query-builder pane, select the button whose name is either **MQL** or **PromQL** .\n- Verify that **PromQL** is selected in the **Language** toggle. The language toggle is in the same toolbar that lets you format your query.\n- Enter and run the following query:```\nup{job=\"ingress-nginx\", cluster=\"CLUSTER_NAME\", namespace=\"NAMESPACE_NAME\"}\n```\n## View dashboards\nThe Cloud Monitoring integration includes the **Ingress NGINX Prometheus Overview** dashboard. Dashboards are automatically installed when you configure the integration. You can also view static previews of dashboards without installing the integration.\n**Note:** Some charts in the dashboard may appear unpopulated upon initial setup because Ingress NGINX only exports metrics like`nginx_ingress_controller_requests`after your Ingress resource starts receiving requests.\nTo view an installed dashboard, do the following:\n- In the navigation panel of the Google Cloud console, select **Monitoring** , and then select **Dashboards** : [Go to Dashboards](https://console.cloud.google.com/monitoring/dashboards) \n- Select the **Dashboard List** tab.\n- Choose the **Integrations** category.\n- Click the name of the dashboard, for example, **Ingress NGINX Prometheus Overview** .To view a static preview of the dashboard, do the following:\n- In the navigation panel of the Google Cloud console, select **Monitoring** , and then select **Integrations** : [Go to Integrations](https://console.cloud.google.com/monitoring/integrations) \n- Click the **Kubernetes Engine** deployment-platform filter.\n- Locate the Ingress NGINX Controller integration and click **View Details** .\n- Select the **Dashboards** tab.\n## Troubleshooting\nFor information about troubleshooting metric ingestion problems, see [Problems with collection from exporters](/stackdriver/docs/managed-prometheus/troubleshooting#exporter-problems) in [Troubleshooting ingestion-side problems](/stackdriver/docs/managed-prometheus/troubleshooting#ingest-problems) .", "guide": "Google Cloud Observability"}