{"title": "Google Cloud Observability - StatsD \u63d2\u4ef6", "url": "https://cloud.google.com/monitoring/agent/plugins/statsd?hl=zh-cn", "abstract": "# Google Cloud Observability - StatsD \u63d2\u4ef6\n[StatsD](https://github.com/etsy/statsd/wiki) \u662f\u4e00\u7a2e\u7528\u65bc\u63d0\u4ea4\u6307\u6a19\u7684\u5354\u8b70\uff0c\u4e5f\u662f\u4e00\u7a2e\u7528\u65bc\u6307\u6a19\u6578\u64da\u805a\u5408\u7684\u5b88\u8b77\u9032\u7a0b\u3002\u901a\u904e\u914d\u7f6e Monitoring \u4ee3\u7406\u7684 StatsD \u63d2\u4ef6\uff0c\u53ef\u4ee5\u4f7f\u4ee3\u7406\u7528\u4f5c\u5411 Monitoring \u5beb\u5165\u6307\u6a19\u7684 StatsD \u5b88\u8b77\u9032\u7a0b\u3002\n\u4f7f\u7528 StatsD \u63d2\u4ef6\u53ca\u5176\u9ed8\u8a8d\u914d\u7f6e\u662f\u5c07\u7528\u6236\u5b9a\u7fa9\u7684\u6307\u6a19\u5c0e\u5165 Monitoring \u7684\u6700\u7c21\u55ae\u65b9\u6cd5\u3002StatsD \u63d2\u4ef6\u50c5\u5728 Linux Stackdriver Monitoring \u4ee3\u7406\u4e2d\u53ef\u7528\u3002\nMonitoring \u4ee3\u7406\u9084\u53ef\u4ee5\u5c07\u5176\u4ed6 collectd \u6307\u6a19\u4f5c\u7232\u7528\u6236\u5b9a\u7fa9\u7684\u6307\u6a19\u5c0e\u51fa\uff0c\u4f46\u6c92\u6709\u7c21\u55ae\u7684\u9ed8\u8a8d\u914d\u7f6e\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u4ee3\u7406\u4e2d\u7528\u6236\u5b9a\u7fa9\u7684\u6307\u6a19](https://cloud.google.com/monitoring/agent/custom-metrics-agent?hl=zh-cn) \u3002\n\u6b64\u529f\u80fd\u50c5\u9069\u7528\u65bc\u5728 Linux \u4e0a\u904b\u884c\u7684\u4ee3\u7406\u3002\u4e0d\u9069\u7528\u65bc Windows\u3002\n", "content": "## \u300a\u767c\u73fe\u300b\u96dc\u8a8c\nMonitoring \u4e0d\u6703\u81ea\u52d5\u6aa2\u6e2c StatsD\u3002\u8981\u4f7f\u7528 StatsD \u6307\u6a19\uff0c\u8acb\u6309\u7167\u4e0b\u4e00\u90e8\u5206\u4e2d\u7684\u8aaa\u660e\u914d\u7f6e StatsD \u63d2\u4ef6\u3002\n## \u914d\u7f6e StatsD \u63d2\u4ef6\n### \u524d\u63d0\u689d\u4ef6\nStatsD \u63d2\u4ef6\u9700\u8981 5.5.2-356 \u6216\u66f4\u9ad8\u7248\u672c\u7684 Monitoring \u4ee3\u7406\u3002\u8981\u66f4\u65b0\u4ee3\u7406\uff0c\u8acb\u53c3\u95b1 [\u66f4\u65b0\u4ee3\u7406](https://cloud.google.com/monitoring/agent/monitoring/installation?hl=zh-cn#agent-version) \u3002\n### \u5553\u7528\u63d2\u4ef6\n\u5728\u904b\u884c Linux \u4e14\u53d7\u652f\u6301\u7684\u865b\u64ec\u6a5f\u5be6\u4f8b\u4e0a\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u4e0b\u8f09 [statsd.conf](https://raw.githubusercontent.com/Stackdriver/stackdriver-agent-service-configs/master/etc/collectd.d/statsd.conf) \uff0c\u4e26\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5c07\u5176\u653e\u7f6e\u5728 `/etc/stackdriver/collectd.d/` \u4e2d\uff1a```\n(cd /etc/stackdriver/collectd.d/ && sudo curl -O https://raw.githubusercontent.com/Stackdriver/stackdriver-agent-service-configs/master/etc/collectd.d/statsd.conf)\n```\n- \u9ed8\u8a8d\u914d\u7f6e\u6587\u4ef6\u6703\u6307\u793a\u4ee3\u7406\u63a5\u53d7\u9ed8\u8a8d StatsD \u7aef\u53e3 **8125** \u4e0a\u7684 StatsD \u6307\u6a19\u3002\u5982\u679c\u60f3\u5c07\u4e00\u4e9b\u6307\u6a19\u767c\u9001\u5230\u60a8\u81ea\u5df1\u7684 StatsD \u5b88\u8b77\u9032\u7a0b\uff0c\u5c07\u5176\u4ed6\u6307\u6a19\u767c\u9001\u5230\u4ee3\u7406\u7684 StatsD \u5b88\u8b77\u9032\u7a0b\uff0c\u8acb\u66f4\u6539\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u7aef\u53e3\u8a2d\u7f6e\u3002\n- \u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u91cd\u5553 Monitoring \u4ee3\u7406\u4ee5\u9078\u64c7 StatsD \u914d\u7f6e\uff1a```\nsudo service stackdriver-agent restart\n```\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3 `collectd` `statsd` \u63d2\u4ef6\uff0c\u8acb\u53c3\u95b1 [Plugin\uff1aStatsD](https://collectd.org/wiki/index.php/Plugin:StatsD) \u3002\n## \u7528\u6236\u5b9a\u7fa9\u7684\u6307\u6a19\u7684\u9ed8\u8a8d\u6620\u5c04\n\u7232\u5e6b\u52a9\u60a8\u5feb\u901f\u4e0a\u624b\uff0c\u4ee3\u7406\u7684 StatsD \u63d2\u4ef6\u9644\u5e36\u9ed8\u8a8d\u7684 collectd \u914d\u7f6e\uff0c\u8a72\u914d\u7f6e\u5f9e StatsD \u6307\u6a19\u6620\u5c04\u5230 Stackdriver \u7528\u6236\u5b9a\u7fa9\u7684\u6307\u6a19\uff1a\n- \u4f86\u81ea StatsD \u63d2\u4ef6\u7684\u6240\u6709\u6307\u6a19\u90fd\u5728 collectd `plugin` \u7d44\u6210\u90e8\u5206\u4e2d\u5177\u6709 `statsd` \u3002\n- \u5728 collectiond `type` \u7d44\u4ef6\u4e2d\u4fdd\u5b58\u7684\u6bcf\u500b StatsD **\u6307\u6a19\u985e\u578b** \u90fd\u6709\u4e00\u500b\u7528\u6236\u5b9a\u7fa9\u7684\u76f8\u61c9\u6307\u6a19\u985e\u578b\u540d\u7a31\u3002\n- \u5728 collectd `type_instance` \u7d44\u6210\u90e8\u5206\u4e2d\u4fdd\u5b58\u7684 StatsD **\u6307\u6a19\u540d\u7a31** \u5b58\u5132\u7232\u540d\u7232 `metric` \u6a19\u7c64\u7684\u503c\u3002`metric` \u6a19\u7c64\u7684\u503c\u4e0d\u540c\u65bc\u6307\u6a19\u985e\u578b `Timer` \uff1a\u5b83\u5305\u62ec\u6307\u6a19\u540d\u7a31\u548c\u4e00\u500b\u8a08\u6578\u5668\u540d\u7a31\uff1aaverage\u3001upper\u3001lower\u3001sum\u3001percentile-50\u3001percentile-95\u3002\n\u4f8b\u5982\uff0c\u4e0b\u8868\u986f\u793a\u4e86\u652f\u6301\u7684 StatsD \u6307\u6a19\u985e\u578b\u548c\u6307\u6a19\u540d\u7a31\u5982\u4f55\u6620\u5c04\u5230 Monitoring \u7528\u6236\u5b9a\u7fa9\u7684\u6307\u6a19\uff1a\n| StatsD \u985e\u578b | StatsD \u540d\u7a31 | Stackdriver \u6307\u6a19\u985e\u578b     | \u6307\u6a19\u7a2e\u985e | \u503c\u985e\u578b  | \u6307\u6a19\u6a19\u7c64      |\n|:--------------|:--------------|:-------------------------------------|:-----------|:-------------|:------------------------------|\n| \u8a08\u6578\u5668  | my.counter | custom.googleapis.com/statsd/derive | \u7d2f\u8a08  | Int64  | metric:my.counter    |\n| \u63a1\u6a23\u5e73\u5747\u503c | my.gauge  | custom.googleapis.com/statsd/gauge | \u63a1\u6a23\u5e73\u5747\u503c | \u96d9\u7cbe\u5ea6\u6d6e\u9ede\u6578 | metric:my.gauge    |\n| \u8a2d\u7f6e   | my.set  | custom.googleapis.com/statsd/objects | \u63a1\u6a23\u5e73\u5747\u503c | \u96d9\u7cbe\u5ea6\u6d6e\u9ede\u6578 | metric:my.set     |\n| \u8a08\u6642\u5668 1  | my.timer  | custom.googleapis.com/statsd/latency | \u63a1\u6a23\u5e73\u5747\u503c | \u96d9\u7cbe\u5ea6\u6d6e\u9ede\u6578 | metric:my.timer-average  |\n| nan   | nan   | \uff08\u76f8\u540c\uff09        | \uff08\u76f8\u540c\uff09 | \uff08\u76f8\u540c\uff09  | metric:my.timer-upper   |\n| nan   | nan   | \uff08\u76f8\u540c\uff09        | \uff08\u76f8\u540c\uff09 | \uff08\u76f8\u540c\uff09  | metric:my.timer-lower   |\n| nan   | nan   | \uff08\u76f8\u540c\uff09        | \uff08\u76f8\u540c\uff09 | \uff08\u76f8\u540c\uff09  | metric:my.timer-sum   |\n| nan   | nan   | \uff08\u76f8\u540c\uff09        | \uff08\u76f8\u540c\uff09 | \uff08\u76f8\u540c\uff09  | metric:my.timer-percentile-50 |\n| nan   | nan   | \uff08\u76f8\u540c\uff09        | \uff08\u76f8\u540c\uff09 | \uff08\u76f8\u540c\uff09  | metric:my.timer-percentile-95 |\n| nan   | nan   | custom.googleapis.com/statsd/gauge | \u63a1\u6a23\u5e73\u5747\u503c | \uff08\u76f8\u540c\uff09  | metric:my.timer-count   |\n**\u6ce8\u610f** \uff1a \u6709\u4e00\u500b\u5177\u6709\u76f8\u540c\u540d\u7a31\u7684 statsd \u8a08\u6642\u5668\u6307\u6a19\u7684\u50b3\u5165\u5e8f\u5217\u3002\u4ee3\u7406\u6703\u5f59\u7e3d StatsD \u8a08\u6642\u5668\u6307\u6a19\uff0c\u4e26\u5c07\u6458\u8981\u6578\u64da\u5c0e\u51fa\u5230 7 \u500b\u4e0d\u540c\u7684\u6642\u5e8f\u3002\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3 StatsD \u985e\u578b\uff0c\u8acb\u53c3\u95b1 [ StatsD \u898f\u7bc4](https://github.com/etsy/statsd/blob/master/docs/metric_types.md) \u3002\n## \u81ea\u5b9a\u7fa9\u5c0e\u51fa\u7684\u6307\u6a19\n\u9ed8\u8a8d\u7684 StatsD \u914d\u7f6e\u65e8\u5728\u8b93\u60a8\u5feb\u901f\u4e0a\u624b\u3002\u672c\u90e8\u5206\u53ef\u5e6b\u52a9\u60a8\u81ea\u5b9a\u7fa9\u914d\u7f6e\uff0c\u4ee5\u9069\u61c9\u66f4\u5fa9\u96dc\u7684\u9700\u6c42\u3002\n\u60a8\u9700\u8981\u719f\u6089\u7528\u6236\u5b9a\u7fa9\u7684\u6307\u6a19\u3002\u5982\u9700\u77ad\u89e3\u6307\u6a19\u8aaa\u660e\uff0c\u8acb\u53c3\u95b1 [\u6307\u6a19\u3001\u6642\u9593\u5e8f\u5217\u548c\u8cc7\u6e90](https://cloud.google.com/monitoring/api/v3/metrics?hl=zh-cn) \u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7528\u6236\u5b9a\u7fa9\u7684\u6307\u6a19\u6982\u89bd](https://cloud.google.com/monitoring/custom-metrics?hl=zh-cn) \u3002\n\u60a8\u53ef\u4ee5\u81ea\u5b9a\u7fa9\u4ee5\u4e0b\u5167\u5bb9\uff1a\n- \u60a8\u53ef\u4ee5\u66f4\u6539\u5206\u914d\u7d66\u9ed8\u8a8d `metric` \u6a19\u7c64\u7684\u503c\u3002\u4f7f\u7528\u7684\u6a19\u7c64\u503c\u8d8a\u591a\uff0c\u7528\u6236\u5b9a\u7fa9\u7684\u6307\u6a19\u4e2d\u5c31\u8d8a\u591a\u7684\u6642\u5e8f\u3002\u4f7f\u7528\u7684\u6a19\u7c64\u503c\u8d8a\u5c11\uff0c\u6642\u5e8f\u6578\u5c31\u8d8a\u5c11\u3002\n- \u60a8\u53ef\u4ee5\u66f4\u6539\u7528\u6236\u5b9a\u7fa9\u7684\u6307\u6a19\u985e\u578b\u3002\u60a8\u4e0d\u5fc5\u4f7f\u7528\u9ed8\u8a8d\u914d\u7f6e\u4e2d\u63d0\u4f9b\u7684\u9810\u5b9a\u7fa9\u985e\u578b\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u6a19\u8b58\u5177\u6709\u7279\u5b9a\u540d\u7a31\u7684\u6307\u6a19\uff0c\u4f75\u7232\u9019\u4e9b\u6307\u6a19\u4f7f\u7528\u5176\u4ed6\u7531\u7528\u6236\u5b9a\u7fa9\u7684\u6307\u6a19\u985e\u578b\u3002\n- \u5982\u679c\u60a8\u66f4\u6539\u7528\u6236\u5b9a\u7fa9\u7684\u6307\u6a19\u985e\u578b\uff0c\u5247\u9084\u53ef\u4ee5\u66f4\u6539\u8207\u6bcf\u7a2e\u985e\u578b\u95dc\u806f\u7684\u6a19\u7c64\u3002\u9ed8\u8a8d\u914d\u7f6e\u6709\u55ae\u500b\u6a19\u7c64\uff0c\u4f46\u60a8\u53ef\u4ee5\u6dfb\u52a0\u66f4\u591a\u6a19\u7c64\u6216\u66f4\u6539\u6a19\u7c64\u9375\u3002\n\u5982\u679c\u60a8\u66f4\u6539\u6307\u6a19\u985e\u578b\uff0c\u5247\u61c9\u5728 Monitoring API \u4e2d\u5b9a\u7fa9\u7528\u6236\u5b9a\u7fa9\u7684\u65b0\u6307\u6a19\u985e\u578b\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1\u4ee5\u4e0b [\u8a2d\u8a08\u6307\u6a19\u985e\u578b](#design-metric) \u90e8\u5206\u3002\n### \u793a\u4f8b\n\u5047\u8a2d\u60a8\u5728\u4f7f\u7528 StatsD \u76e3\u63a7\u4e00\u500b\u5305\u62ec `my_service_a` \u548c `my_service_b` \u5169\u9805\u670d\u52d9\u7684\u61c9\u7528\u3002\u5c0d\u65bc\u6bcf\u9805\u670d\u52d9\uff0c\u60a8\u5e0c\u671b\u5c07\u8868\u793a\u5931\u6557\u8acb\u6c42\u6578\u91cf\u7684\u8a08\u6578\u5668\u6307\u6a19\u5c0e\u51fa\u5230 Monitoring\u3002\u60a8\u4e0d\u60f3\u4f7f\u7528\u9ed8\u8a8d\u7684 StatsD \u6307\u6a19\u985e\u578b\u3002\n### \u50b3\u5165\u7684 collectd \u6307\u6a19\n\u5728\u5b9a\u7fa9\u60a8\u81ea\u5df1\u7684\u6307\u6a19\u985e\u578b\u4e4b\u524d\uff0c\u8acb\u52d9\u5fc5\u5148\u4e86\u89e3 collectd \u6307\u6a19\u7684\u7d50\u69cb\uff0c\u4ee5\u53ca\u9ed8\u8a8d\u60c5\u6cc1\u4e0b StatsD \u6307\u6a19\u5982\u4f55\u6620\u5c04\u5230\u7528\u6236\u5b9a\u7fa9\u7684\u6307\u6a19\u3002\n\u5305\u62ec StatsD \u6307\u6a19\u5728\u5167\u7684 collectd \u6307\u6a19\u5305\u542b\u4ee5\u4e0b\u7d44\u6210\u90e8\u5206\uff1a\n```\n Host, Plugin, Plugin-instance, Type, Type-instance\n```\n\u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u60a8\u8981\u5c0e\u51fa\u7684 StatsD \u6307\u6a19\u5728 collectd \u4e2d\u5177\u6709\u4ee5\u4e0b\u6a19\u8b58\u7b26\uff1a\n| \u7d44\u6210\u90e8\u5206 | \u9810\u671f\u503c      |\n|:-----------|:---------------------------|\n| \u4e3b\u6a5f  | \u4efb\u4f55      |\n| \u63d2\u4ef6  | statsd      |\n| \u63d2\u4ef6\u5be6\u4f8b | \u672a\u8a2d\u7f6e1     |\n| \u985e\u578b  | derive2     |\n| \u985e\u578b\u5be6\u4f8b | [SERVICE_NAME].GET.[CODE]3 |\n| [VALUE] | \u4efb\u610f\u503c4     |\n**\u6ce8\u610f** \uff1a StatsD \u63d2\u4ef6\u7576\u524d\u5c07\u6b64\u7d44\u6210\u90e8\u5206\u7559\u7a7a\u3002 StatsD \u8a08\u6578\u5668\u6307\u6a19\u6703\u6620\u5c04\u5230 collectd `derive` \u985e\u578b\u3002 \u4f8b\u5982\uff0c\u985e\u578b\u5be6\u4f8b\u53ef\u80fd\u7232 `my_service_a.GET.500` \u3002 [VALUE] \u901a\u5e38\u662f\u4e00\u500b\u6642\u9593\u6233\u548c\u4e00\u500b\u96d9\u7cbe\u5ea6\u6578\u5b57\u3002\n\u4e0b\u8868\u986f\u793a\u4e86\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\u6b64\u6307\u6a19\u7684\u6620\u5c04\u65b9\u5f0f\uff1a\n| StatsD \u985e\u578b | StatsD \u540d\u7a31   | Stackdriver \u6307\u6a19\u985e\u578b    | \u6307\u6a19\u7a2e\u985e | \u503c\u985e\u578b | \u6307\u6a19\u6a19\u7c64     |\n|:--------------|:---------------------|:------------------------------------|:-----------|:---------|:---------------------------|\n| \u8a08\u6578\u5668  | my_service_a.GET.500 | custom.googleapis.com/statsd/derive | \u7d2f\u8a08  | Int64 | metric:my_servce_a.GET.500 |\n| \u8a08\u6578\u5668  | my_service_b.GET.403 | custom.googleapis.com/statsd/derive | \u7d2f\u8a08  | Int64 | metric:my_servce_b.GET.403 |\n\u9ed8\u8a8d\u7684\u6620\u5c04\u53ef\u80fd\u6703\u7d66\u60a8\u5e36\u4f86\u4e00\u4e9b\u56f0\u96e3\uff1a\n- \u8a72\u7279\u5b9a\u8a08\u6578\u5668\u6307\u6a19 ( `[SERVICE_NAME].GET.[CODE]` ) \u8207\u6240\u6709\u5176\u4ed6\u8a08\u6578\u5668\u6307\u6a19\u5c6c\u65bc\u76f8\u540c\u7684\u7528\u6236\u5b9a\u7fa9\u7684\u6307\u6a19\u985e\u578b\u3002\u60a8\u7121\u6cd5\u8f15\u9b06\u50c5\u7372\u53d6\u6b64\u6307\u6a19\u7684\u6578\u64da\uff0c\u56e0\u7232 Stackdriver \u76ee\u524d\u4e0d\u652f\u6301\u5c0d\u6a19\u7c64\u9032\u884c\u6b63\u5247\u8868\u9054\u5f0f\u641c\u7d22\u3002\n- \u60a8\u7121\u6cd5\u8f15\u9b06\u7372\u53d6\u500b\u5225\u670d\u52d9\u7684\u6578\u64da\uff0c\u6216\u6578\u64da\u4e2d\u7684\u500b\u5225\u97ff\u61c9\u4ee3\u78bc\u3002\u4f8b\u5982\uff0c\u60a8\u7121\u6cd5\u8f15\u9b06\u7372\u53d6 `my_service_a` \u4e2d\u767c\u751f\u7684\uff08\u6240\u6709\u7a2e\u985e\u7684\uff09\u932f\u8aa4\u7e3d\u6578\u3002\n- \u9ed8\u8a8d\u914d\u7f6e\u6703\u5c07\u6240\u6709 StatsD \u6307\u6a19\u5c0e\u51fa\u5230 Stackdriver\uff0c\u5982\u679c\u60a8\u53ea\u5c0d\u67d0\u4e9b\u6307\u6a19\u611f\u8208\u8da3\uff0c\u5247\u9019\u53ef\u80fd\u6703\u9020\u6210\u8cbb\u7528\u904e\u9ad8\u3002\n### \u8a2d\u8a08\u6307\u6a19\u985e\u578b\n\u5982\u9700\u67e5\u770b\u6709\u95dc\u5275\u5efa\u6307\u6a19\u985e\u578b\u7684\u5b8c\u6574\u8a0e\u8ad6\uff0c\u8acb\u53c3\u95b1 [\u5275\u5efa\u7528\u6236\u5b9a\u7fa9\u7684\u6307\u6a19\u985e\u578b](https://cloud.google.com/monitoring/custom-metrics/creating-metrics?hl=zh-cn#md-create) \u3002\n\u5c0d\u65bc\u672c\u793a\u4f8b\u4e2d\u7684\u6578\u64da\uff0c\u4ee5\u4e0b\u7528\u6236\u5b9a\u7fa9\u7684\u6307\u6a19\u985e\u578b\u662f\u5408\u7406\u7684\u9078\u64c7\uff0c\u56e0\u7232\u5b83\u50c5\u5305\u542b\u60a8\u611f\u8208\u8da3\u7684 StatsD \u6307\u6a19\uff0c\u4e26\u4e14\u9078\u64c7\u7684\u6a19\u7c64\u6709\u52a9\u65bc\u66f4\u597d\u5730\u6574\u7406\u6578\u64da\uff1a\n- \u985e\u578b\uff1a`custom.googleapis.com/http/request_errors`\n- \u6a19\u7c64\uff1a\n- `service_name`\uff08STRING\uff09\uff1a\u670d\u52d9\u7684\u540d\u7a31\u3002\n- `response_code`\uff08INT64\uff09\uff1aHTTP \u97ff\u61c9\u4ee3\u78bc\u3002\n- \u7a2e\u985e\uff1a\u7d2f\u8a08\n- \u503c\u985e\u578b\uff1aINT64\n\u4e0b\u8868\u986f\u793a\u4e86 StatsD \u5230 Stackdriver \u7684\u6240\u9700\u6620\u5c04\uff1a\n| StatsD \u985e\u578b | StatsD \u540d\u7a31   | Stackdriver \u6307\u6a19\u985e\u578b      | \u6307\u6a19\u7a2e\u985e | \u503c\u985e\u578b | \u6307\u6a19\u6a19\u7c64          |\n|:--------------|:---------------------|:------------------------------------------|:-----------|:---------|:---------------------------------------------|\n| \u8a08\u6578\u5668  | my_service_a.GET.500 | custom.googleapis.com/http/request_errors | \u7d2f\u8a08  | Int64 | service_name:my_service_a, response_code:500 |\n| \u8a08\u6578\u5668  | my_service_b.GET.403 | custom.googleapis.com/http/request_errors | \u7d2f\u8a08  | Int64 | service_name:my_service_b, response_code:403 |\n\u8a2d\u8a08\u4e86\u6307\u6a19\u985e\u578b\u5f8c\uff0c\u8acb\u4f7f\u7528 [metricDescriptors.create](https://cloud.google.com/monitoring/api/ref_v3/rest/v3/projects.metricDescriptors/create?hl=zh-cn) \u9032\u884c\u5275\u5efa\u3002 \u5982\u9700\u77ad\u89e3\u5982\u4f55\u8b93 Monitoring \u7232\u60a8\u5275\u5efa\u6307\u6a19\u985e\u578b\uff0c\u8acb\u53c3\u95b1 [\u81ea\u52d5\u5275\u5efa\u6307\u6a19\u63cf\u8ff0\u7b26](https://cloud.google.com/monitoring/custom-metrics/creating-metrics?hl=zh-cn#auto-creation) \u3002\n### \u6620\u5c04\u914d\u7f6e\n\u5982\u9700\u5c07 StatsD \u6307\u6a19\u5c0e\u51fa\u5230\u65b0\u7684\u7528\u6236\u5b9a\u7fa9\u7684\u6307\u6a19\u985e\u578b\uff0c\u8acb\u5c07\u9ed8\u8a8d StatsD \u63d2\u4ef6\u914d\u7f6e `/etc/stackdriver/collectd.d/statsd.conf` \u7684\u5167\u5bb9\u66ff\u63db\u7232\u4ee5\u4e0b\u4ee3\u78bc\uff1a\n```\n<Plugin statsd>\u00a0 Host \"127.0.0.1\"\u00a0 Port \"8125\"\u00a0 DeleteSets true\u00a0 TimerPercentile 50.0\u00a0 TimerPercentile 95.0\u00a0 TimerLower true\u00a0 TimerUpper true\u00a0 TimerSum true\u00a0 TimerCount true</Plugin>LoadPlugin match_regexLoadPlugin target_setLoadPlugin target_replace# Insert a new rule in the default \"PreCache\" chain, to divert your metrics.PreCacheChain \"PreCache\"<Chain \"PreCache\">\u00a0 # The following rule does all the work for your metric:\u00a0 <Rule \"rewrite_request_errors\">\u00a0 \u00a0 # Do a careful match for just your metrics; if it fails, drop down\u00a0 \u00a0 # to the next rule:\u00a0 \u00a0 <Match regex>\u00a0 \u00a0 \u00a0 Plugin \"^statsd$\"\u00a0 \u00a0 \u00a0 TypeInstance \"^.*\\\\.GET\\\\..*$\" \u00a0 \u00a0# Match on type instance.\u00a0 \u00a0 </Match>\u00a0 \u00a0 <Target \"set\">\u00a0 \u00a0 \u00a0 # Specify the metric descriptor type:\u00a0 \u00a0 \u00a0 MetaData \"stackdriver_metric_type\" \"custom.googleapis.com/http/request_errors\"\u00a0 \u00a0 \u00a0 # Initialize the labels from the \"type_instance\" label; clean the values up in the next Target below.\u00a0 \u00a0 \u00a0 MetaData \"label:service_name\" \"%{type_instance}\"\u00a0 \u00a0 \u00a0 MetaData \"label:response_code\" \"%{type_instance}\"\u00a0 \u00a0 </Target>\u00a0 \u00a0 <Target \"replace\">\u00a0 \u00a0 \u00a0 # Remove \".GET.[code]\" to get the real service name.\u00a0 \u00a0 \u00a0 MetaData \"label:service_name\" \"\\\\.GET\\\\.[0-9]*$\" \"\"\u00a0 \u00a0 \u00a0 # Remove \"[service].GET.\" to get the real response code.\u00a0 \u00a0 \u00a0 MetaData \"label:response_code\" \"^[^\\\\.]*\\\\.GET\\\\.\" \"\"\u00a0 \u00a0 </Target>\u00a0 </Rule></Chain>\n```\n**\u6ce8\u610f** \uff1a\u5982\u679c\u5b89\u88dd\u6b64\u914d\u7f6e\u6587\u4ef6\uff0c\u5247\u9ed8\u8a8d\u7684 StatsD \u6620\u5c04\u6703\u88ab\u79fb\u9664\u3002\u5982\u679c\u60a8\u60f3\u4fdd\u7559\u5176\u4ed6 StatsD \u6307\u6a19\u7684\u9ed8\u8a8d\u6620\u5c04\uff0c\u5fc5\u9808\u5728\u65b0\u7684 `rewrite_request_errors` \u898f\u5247\u5f8c\u9762\u6dfb\u52a0\u9ed8\u8a8d StatsD \u914d\u7f6e\u4e2d\u7684 `Rule` \u3002\n### \u91cd\u5553\u4ee3\u7406\n\u901a\u904e\u5728\u865b\u64ec\u6a5f\u5be6\u4f8b\u4e0a\u57f7\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u91cd\u5553\u60a8\u7684\u4ee3\u7406\u4ee5\u9078\u64c7\u65b0\u914d\u7f6e\uff1a\n```\nsudo service stackdriver-agent restart\n```\n\u7528\u6236\u5b9a\u7fa9\u7684\u6307\u6a19\u4fe1\u606f\u6703\u7acb\u5373\u958b\u59cb\u6d41\u5165 Monitoring\u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n\u81ea\u5b9a\u7fa9 StatsD \u63d2\u4ef6\u8207\u7232 Monitoring \u81ea\u5b9a\u7fa9 collectd \u6307\u6a19\u76f8\u540c\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u4ee3\u7406\u4e2d\u7528\u6236\u5b9a\u7fa9\u7684\u6307\u6a19](https://cloud.google.com/monitoring/agent/custom-metrics-agent?hl=zh-cn) \u7684\u201c\u53c3\u8003\u201d\u548c\u201c\u554f\u984c\u6392\u67e5\u201d\u90e8\u5206\u3002", "guide": "Google Cloud Observability"}