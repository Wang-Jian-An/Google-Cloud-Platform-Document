{"title": "Google Cloud Observability - Installing the Monitoring Agent on individual VMs", "url": "https://cloud.google.com/stackdriver/docs/solutions/agents/monitoring/installation", "abstract": "# Google Cloud Observability - Installing the Monitoring Agent on individual VMs\n**This is a legacy agent.** While this agent is still supported on Linux, we recommend against using it for new Google Cloud workloads.Instead, we recommend that you use the [Ops Agent](/stackdriver/docs/solutions/agents/monitoring/../ops-agent) for new Google Cloud workloads and eventually transition your existing Compute Engine VMs to use the Ops Agent. The Ops Agent, which combines the collection of metrics and logging into a single agent, is the eventual replacement for the legacy agents.The Ops Agent is under active development, but there might be some use cases that it doesn't support. If the Ops Agent doesn't support your use case, then you can still use the Monitoring agent on Linux.There will be no new feature development or support for new operating systems for the legacy Monitoring agent.We strongly recommend against using the legacy Monitoring agent on Windows. The legacy Monitoring agent on Windows is unsupported, and all of its features are available in the Ops Agent. We strongly recommend using Ops Agent for monitoring Windows instances. However, if you have to run the legacy Logging agent on Windows and also need to collect metrics, you must use the legacy Monitoring agent; you can't run the Ops Agent and a legacy agent on the same machine.\nThe Monitoring agent collects logs and metrics on Compute Engine instances, sending your logs to Cloud Logging and your metrics to Cloud Monitoring.\n**Note:** The Cloud Monitoring agent is designed to ingest system, third-party, user-defined, and agent telemetry metrics. Some of these metrics are chargeable. For information about pricing, see [Monitoring pricing](/stackdriver/pricing#monitoring-costs) .\n", "content": "## Before you begin\nTo install the agent, ensure that you have the following:\n- A [supported VM instance](/stackdriver/docs/solutions/agents/monitoring#supported_vms) in a Google Cloud project or Amazon Web Services (AWS) account.- A minimum of 250 MiB of resident (RSS) memory is recommended to run the Monitoring agent.\nAlso ensure your VM is running a [supported operatingsystem](/stackdriver/docs/solutions/agents/monitoring#supported_operating_systems) .\n- Credentials on the VM instance that authorize communication with Cloud Logging or Cloud Monitoring. Compute Engine VM instances generally have the correct credentials by default. If either of the following scenarios applies to you, then you might not have the proper credentials and must complete the [Authorize the Monitoring agent](/stackdriver/docs/solutions/agents/monitoring/authorization) procedures:- Running AWS EC2 VM instances, you must [install authorizationcredentials](/stackdriver/docs/solutions/agents/monitoring/authorization) on your VMs before installing the agent.\n- Running very old Compute Engine instances or Compute Engine instances created without the default credentials.\nTo check if you have the proper credentials, run the [VerifyingCompute Engine credentials](/stackdriver/docs/solutions/agents/monitoring/troubleshooting#verify-creds) procedures.\n- For AWS users, do the following:- Connect your AWS account to a Google Cloud. For information about this process, see [Collect metrics from AWS accounts](/monitoring/settings/aws-accounts) . **Note:** When you connect your AWS account to a Google Cloud you create an [AWS Connector project](/monitoring/settings/aws-accounts#connector-project) . To make these projects easy to identify, we recommend that your AWS Connector projects follow a naming convention.\n- Refer to the [Google Cloud projects for AWS EC2 VM instances](#aws_connector_project) section for additional information.\n- For pricing information, go to [Pricing for Google Cloud Observability](/stackdriver/pricing) .\n- If you're using VMs that don't have access to remote package repositories, refer to the [VMs without remote package access](#remote_package_access) section for more information.## Installing the agent from the command line\n**Note:** First verify that all conditions are met in the [Before youbegin](#before_you_begin) section.\nTo install the agent using the command line, use the following instructions.\n### Installing the latest version of the agent\nTo install the latest version of the agent, complete the following steps.\n- Open a terminal connection to your VM instance using SSH or a similar tool and ensure you have `sudo` access.\n- Change to a directory you have write access to, for example your home directory.\n- Download and run the agent-installation script by using the following commands:```\ncurl -sSO https://dl.google.com/cloudagents/add-monitoring-agent-repo.sh\nsudo bash add-monitoring-agent-repo.sh --also-install\n```After it is installed, the agent is started automatically.\n- Connect to your instance using RDP or a similar tool and login to Windows.\n- Open a PowerShell terminal with administrator privileges by right-clicking the PowerShell icon and selecting **Run as Administrator** .\n- Run the following PowerShell commands:```\n(New-Object Net.WebClient).DownloadFile(\"https://repo.stackdriver.com/windows/StackdriverMonitoring-GCM-46.exe\", \"${env:UserProfile}\\StackdriverMonitoring-GCM-46.exe\")\n& \"${env:UserProfile}\\StackdriverMonitoring-GCM-46.exe\"\n```\n### Installing a specific version of the agent\nTo install a specific version of the agent, complete the following steps.\n- Open a terminal connection to your VM instance using SSH or a similar tool and ensure you have `sudo` access.\n- Change to a directory you have write access to, for example your home directory.\n- Download the agent installation script:```\ncurl -sSO https://dl.google.com/cloudagents/add-monitoring-agent-repo.sh\n```When running the `add-monitoring-agent-repo.sh` script, you can also set the following flags:- `--verbose`: Turns on verbose logging during the script execution.\n- `--also-install`: Installs the agent after adding the agent package repository.\n- `--version`: Sets the agent version for the script to install.\n- `--uninstall`: Uninstalls the agent.\n- `--remove-repo`: Removes the corresponding agent package repository after installing or uninstalling the agent.\n- `--dry-run`: Triggers only a dry run of the script execution and prints out the commands that it is supposed to execute.\nSee the script comments for more information and example usage.\n- Add the agent's package repository and install the agent:- To list the available agent versions in order to select which version to install, refer to [Listing all agent versions](#list-versions) .\n- For production environments, you might want to pin to a major version to avoid installing major versions that might include backward incompatible changes. To pin to a major version, run:```\nsudo bash add-monitoring-agent-repo.sh --also-install \\\n --version=MAJOR_VERSION.*.*\n```For example, to pin to the 6.x.x of the agent, run:```\nsudo bash add-monitoring-agent-repo.sh --also-install \\\n --version=6.*.*\n```\n- To install a specific version of the agent, run:```\nsudo bash add-monitoring-agent-repo.sh --also-install \\\n --version=MAJOR_VERSION.MINOR_VERSION.PATCH_VERSION\n```\n- Start the agent service```\nsudo service stackdriver-agent start\n```\nYou can delete the installation script after it runs successfully.- To verify that the agent is working as expected, run:```\nsudo service stackdriver-agent status\n```The status of the agent should be **OK** .\n- You can also examine the logs and ensure there are no errors:```\nsudo grep collectd /var/log/{syslog,messages} | tail\n```\nIf you have trouble with the installation, refer to the [Troubleshooting](/stackdriver/docs/solutions/agents/monitoring/troubleshooting) page.- Connect to your instance using RDP or a similar tool and login to Windows.\n- Open a PowerShell terminal with administrator privileges by right-clicking the PowerShell icon and selecting **Run as Administrator** . **Note:** Only the latest version of the agent is supported on VM instances running Windows. Installing previous versions is not recommended.- Run the following PowerShell commands:```\n(New-Object Net.WebClient).DownloadFile(\"https://repo.stackdriver.com/windows/StackdriverMonitoring-GCM-46.exe\", \"${env:UserProfile}\\StackdriverMonitoring-GCM-46.exe\")\n& \"${env:UserProfile}\\StackdriverMonitoring-GCM-46.exe\"\n```\nAlternatively, you can browse to the following URL to download and run the agent's installer: [https://repo.stackdriver.com/windows/StackdriverMonitoring-GCM-46.exe](https://repo.stackdriver.com/windows/StackdriverMonitoring-GCM-46.exe) **Caution:** You must download the installer to a non-system directory, such as `C:\\Users\\[USERNAME]` . For security reasons, the installer doesn't run from system directories, including the directory `C:\\` . If you download the installer to a system directory, move it to another directory before running it. **Note:** The agent installer also supports a \u201csilent\u201d option, `/S` , that can be used in scripting the installation.To install the agent silently, append the `/S` option to the invocation of the installer:```\n& \"${env:UserProfile}\\StackdriverMonitoring-GCM-46.exe\" /S\n``` **Caution:** Silent installation is an **asynchronous** operation. When the installation command exits, the agent is not yet installed. You can check for a successful installation by looking for the `StackdriverMonitoring` service. **Note:** The installer places the agent in the `C:\\Program Files (x86)\\Stackdriver\\Google Cloud ObservabilityAgent` directory by default. You can change that directory during installation.In \u201csilent\u201d mode use the `/D` option to specify the installation directory, for example:```\n& \"${env:UserProfile}\\StackdriverMonitoring-GCM-46.exe\" /S /D=\"C:\\Stackdriver\\Google Cloud Observability\\\"\n```You can delete the installer when it completes successfully.If you have trouble with the installation, refer to the [Troubleshooting](/stackdriver/docs/solutions/agents/monitoring/troubleshooting) page.\n## Viewing agent information by using the Google Cloud console\nYou can find status information about the agent on the pre-configured Monitoring **VM Instances** dashboard. To reach this dashboard, do the following:\nIn the navigation panel of the Google Cloud console, select **Monitoring** , select **Dashboards** , and then select **VM instances** :\n[Go to VM Instances Dashboard](https://console.cloud.google.com/monitoring/dashboards/resourceList/gce_instance)\nThe **List** view on the **Inventory** tab on the dashboard lists all VMs and includes a status column for your agent, as shown in the following screenshot:\nThe **Agent** column reports the following values:\n- **Not detected** : Either you don't have an agent installed or it is not running. If you aren't sure if you've installed an agent, then you can [query for the installed version](#agent-version) . If you've installed the agent, then you can [restart the agent](#restart) .\n- **Ops Agent** : You are running the Ops Agent. If you don't see a green checkmark beside the entry, then there is an agent upgrade available, based on the detected operating system of your VM.When you hover over the Ops Agent indicator in the table, you see information about the version of the Ops Agent. If you are running an older version, you also see a recommendation to upgrade your agent.\n- **Pending** : The Ops Agent is being installed or upgraded.\n- **Legacy Agent** : You are running the legacy Monitoring or the Logging agent. See [Migrating from the legacy agents to the OpsAgent](/stackdriver/docs/solutions/agents/ops-agent/transition#migrate_legacy) for information on transitioning to the Ops Agent.\n- **Not applicable** : This VM is not a supported platform for running the agent.\n- **Unknown** : The VM is not running, so the agent's status is not known.\nYou can install the Ops Agent by doing the following:\n- Select the VM instances on which you want to install agents.\n- Click the **Install/Update Ops Agent** option on the **Instances** table.\nYou can also install or update the Ops Agent from the **VM Details** page for a specific VM.\nWhen possible, the agent is installed by using an Ops Agent OS policy. For more information, see [Manage VMs covered by the Ops Agent OS policy](/stackdriver/docs/solutions/agents/monitoring/../ops-agent/manage-policies-auto-install) . Ops Agent OS policies aren't supported on all versions of all operating systems. In this case, clicking **Install/Update Ops Agent** provides a series of commands to run in Cloud Shell.\nThe Ops Agent collects both metrics and logs by default. You can change this default behavior by [configuring the Ops Agent](/stackdriver/docs/solutions/agents/monitoring/configuration) .\n## Optional tasks\nThis section describes how to perform common maintenance tasks.\n### Configuring the Monitoring agent\nTo adjust the agent configuration, see [Configure the Monitoring agent](/stackdriver/docs/solutions/agents/monitoring/configuration) .\n### Configuring an HTTP proxy\nIf you use an HTTP proxy for proxying requests to the Logging and Monitoring APIs, do the following:\n- Edit the following configuration file (create the file if it doesn't already exist):- For agent versions 6.0.0 and higher, edit:```\n/etc/default/stackdriver-agent\n```\n- For agent versions earlier than 6.0.0, edit the appropriate file for your OS:For Debian and Ubuntu, edit:```\n/etc/default/stackdriver-agent\n```For CentOS and SLES, edit:```\n/etc/default/stackdriver-collectd\n``` **Note:** If this file doesn't exist, create it.\n- Add the following to the file:```\n\u00a0export http_proxy=\"http://proxy-ip:proxy-port\"\u00a0export https_proxy=\"http://proxy-ip:proxy-port\"\u00a0export no_proxy=169.254.169.254 \u00a0# Skip proxy for the local Metadata Server.\n```\n- Restart the agent by running the following command on your VM instance:```\n\u00a0sudo service stackdriver-agent restart\n```\n- If you use an HTTP proxy, run the following command from an administrator command prompt. This sets the `HTTP_PROXY` and `HTTPS_PROXY` environment variables so that the agent can send data using outbound HTTPS:```\nsetx HTTP_PROXY http://proxy-ip:proxy-port /msetx HTTPS_PROXY http://proxy-ip:proxy-port /msetx no_proxy 169.254.169.254 /m\n```\n### Determining the agent version\nTo determine the version of the Monitoring agent on your system, run the following commands on your VM instance:\nRun the following command on Amazon Linux, Red Hat, or CentOS Linux:\n```\nrpm --query --queryformat '%{NAME} %{VERSION} %{RELEASE} %{ARCH}\\n' stackdriver-agent\n```Run the following command on Debian or Ubuntu:\n```\ndpkg-query --show --showformat '${Package} ${Version} ${Architecture} ${Status}\\n' stackdriver-agent\n```Run the following command on SUSE:\n```\nrpm --query --queryformat '%{NAME} %{VERSION} %{RELEASE} %{ARCH}\\n' stackdriver-agent\n```There is presently no way to determine the version of the Monitoring agent running on Windows.\n### Restarting the agent\nYou must restart the Monitoring agent to pick up changes in configuration files. To restart the agent, use the following instructions.\nRun the following command on your instance:\n```\n\u00a0 \u00a0 \u00a0sudo service stackdriver-agent restart\n```\n- Connect to your instance using RDP or a similar tool and login to Windows.\n- Open a PowerShell terminal with administrator privileges by right-clicking the PowerShell icon and selecting **Run as Administrator** .\n- Run the following PowerShell command:\n```\nRestart-Service -Name StackdriverMonitoring\n```\n### Upgrading the agent\nTo upgrade the Monitoring agent to the latest release, use the following instructions:\n**Note:** If you upgraded your instance's Linux operating system to a new major release, then you should first [remove the agent](#uninstall) and then [re-install it](#joint-install) using the procedures on this page, instead of completing these upgrade procedures.\nTo upgrade the agent to the latest version, run the following command:\n```\nsudo bash add-monitoring-agent-repo.sh --also-install\n```\nTo upgrade the agent to the latest point release of a specific major version, run the following command:\n```\nsudo bash add-monitoring-agent-repo.sh --also-install \\\u00a0 --version=MAJOR_VERSION.*.*\n```To upgrade to the latest agent release, install the newest agent as described in [Installing on Windows](#joint-install) on this page. The installer prompts you to uninstall the previous version of the agent.### Listing all agent versions\nTo list the available versions of the agent, run the following command:\nList the available versions of the agent:\n```\nsudo yum list --showduplicates stackdriver-agent\n```List the available versions of the agent:\n```\nsudo apt-cache madison stackdriver-agent\n```List the available versions of the agent:\n```\nsudo zypper search -s stackdriver-agent\n```Installing earlier versions of the agent on Windows is not supported.\n### Uninstalling the agent\nTo remove the Monitoring agent and its configuration files, use the following instructions.\nAfter you uninstall the agent, the Google Cloud console might take up to one hour to report this change.\nRun the following command:\n```\nsudo bash add-monitoring-agent-repo.sh --uninstall\n```\nOptionally, to remove the repository in addition to uninstalling the agent, append `--remove-repo` to the previous command.In the Windows Control Panel, choose **Uninstall a program** . You should see the Monitoring agent in the list of programs that you can uninstall. You can also run `uninstall.exe` from the directory where you installed the Monitoring agent.\n## Information about Google Cloud projects for AWS EC2 VM instances\nWhen the documentation refers to , for EC2 VM instances, this phrase refers to the AWS Connector project linked to your AWS account.\nWhen you connect your AWS account to a Google Cloud, you create an [AWS Connector project](/monitoring/settings/aws-accounts#connector-project) . For information about this process, see [Collect metrics from AWS accounts](/monitoring/settings/aws-accounts) .\nTo access the AWS Connector project for an AWS account, do one of the following:\n- Use the Google Cloud console project selector to identify the projects that match your AWS Connector project naming conventions, and then select the specific project for your AWS account.\n- Identify the Google Cloud project whose metrics scope includes your AWS account metrics and select that project in the Google Cloud console project selector. For this Google Cloud project, go to the **Monitoring** page and then select the **Settings** page. The **Settings** page lists the AWS Connector projects. You can use the Google Cloud console project selector to access the AWS Connector project.\n**Note:** Don't install the agent on an EC2 VM instance until you have connected your AWS account to Google Cloud. Until the connection is made, there is no associated Google Cloud project and therefore nowhere to send data.\n## VMs without remote package access\nInstalling the Monitoring agent [requires access](/stackdriver/docs/solutions/agents/monitoring#access) to remote package repositories, for both the agent package and (on Linux) its dependencies.\nIf you are using [VPC-SC](/vpc-service-controls) or a private network, the network configuration might also affect your ability to install agent dependencies from upstream repositories. The agent packages themselves are accessible by using [Private GoogleAccess](/vpc/docs/configure-private-google-access) . This can be configured following [Enable Private GoogleAccess](/vpc/docs/configure-private-google-access#enabling-pga) .\nIf your VM host's security policy denies access to remote package repositories, we recommend creating a [custom VMimage](/compute/docs/images/create-delete-deprecate-private-images) with the agent pre-installed and disabling package management in that image.\n## What's next\n- Learn about what [logs the agent sends to Cloud Logging using itsdefault configuration](/logging/docs/agent/default-logs) .", "guide": "Google Cloud Observability"}