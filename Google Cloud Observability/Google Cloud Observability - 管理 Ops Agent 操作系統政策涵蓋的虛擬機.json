{"title": "Google Cloud Observability - \u7ba1\u7406 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u6db5\u84cb\u7684\u865b\u64ec\u6a5f", "url": "https://cloud.google.com/stackdriver/docs/solutions/agents/ops-agent/manage-policies-auto-install?hl=zh-cn", "abstract": "# Google Cloud Observability - \u7ba1\u7406 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u6db5\u84cb\u7684\u865b\u64ec\u6a5f\n\u5982\u679c\u60a8\u5728\u5275\u5efa\u4e86 Compute Engine \u865b\u64ec\u6a5f\u4e26\u5728\u5275\u5efa\u671f\u9593\u5b89\u88dd\u4e86 Ops Agent\uff0c\u6216\u8005\u5728\u67d0\u4e9b\u60c5\u6cc1\u4e0b\uff0c\u5982\u679c\u60a8 [\u4f7f\u7528 Google Cloud \u63a7\u5236\u6aaf\u5728\u73fe\u6709\u865b\u64ec\u6a5f\u4e0a\u5b89\u88dd\u4ee3\u7406](https://cloud.google.com/stackdriver/docs/solutions/agents/ops-agent/installation?hl=zh-cn#gce-ui-install) \uff0c\u5247 Google Cloud \u9084\u5275\u5efa\u4e86\u7528\u65bc\u5b89\u88dd\u548c\u76e3\u63a7 Ops Agent \u7684\u865b\u64ec\u6a5f\u7ba1\u7406\u5668\u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u3002\u672c\u6587\u6a94\u4ecb\u7d39\u77ad\u5982\u4f55\u67e5\u8a62\u9019\u4e9b Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\uff0c\u4ee5\u53ca\u5982\u4f55\u7ba1\u7406\u653f\u7b56\u6db5\u84cb\u7684\u865b\u64ec\u6a5f\u4e0a\u7684 Ops Agent\u3002\u5982\u9700\u77ad\u89e3\u5982\u4f55\u5275\u5efa\u81ea\u52d5\u5b89\u88dd Ops Agent \u7684\u865b\u64ec\u6a5f\uff0c\u8acb\u53c3\u95b1 [\u5728\u5275\u5efa\u865b\u64ec\u6a5f\u671f\u9593\u5b89\u88dd Ops Agent](https://cloud.google.com/stackdriver/docs/solutions/agents/ops-agent/install-agent-vm-creation?hl=zh-cn) \u3002\n\u5275\u5efa Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u5f8c\uff0c\u60a8\u53ef\u4ee5\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u78ba\u5b9a\u8a72\u653f\u7b56\u6db5\u84cb\u54ea\u4e9b\u865b\u64ec\u6a5f\u3002\n- \u78ba\u5b9a\u8a72\u653f\u7b56\u6db5\u84cb\u54ea\u4e9b\u53ef\u7528\u5340\u3002\n- \u5c07\u653f\u7b56\u8986\u84cb\u7bc4\u570d\u64f4\u5c55\u5230\u73fe\u6709\u865b\u64ec\u6a5f\u3002\n- \u5f9e\u8a72\u653f\u7b56\u6db5\u84cb\u7684\u865b\u64ec\u6a5f\u4e2d\u5378\u8f09\u4ee3\u7406\u3002", "content": "## \u67e5\u627e Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u6db5\u84cb\u7684\u865b\u64ec\u6a5f\n\u60a8\u53ef\u4ee5\u4f7f\u7528 Google Cloud \u63a7\u5236\u6aaf\u6216 Google Cloud CLI \u67e5\u770b Google Cloud \u9805\u76ee\u4e2d\u7684\u54ea\u4e9b\u865b\u64ec\u6a5f\u7531 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u901a\u904e\u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u5206\u914d\u6db5\u84cb\u3002\u5982\u679c\u60a8\u8a8d\u7232\u6c92\u6709\u6db5\u84cb\u67d0\u500b\u865b\u64ec\u6a5f\uff0c\u5247\u53ef\u4ee5\u901a\u904e\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\u9032\u884c\u554f\u984c\u6392\u67e5\uff1a\n- [\u9a57\u8b49\u865b\u64ec\u6a5f\u662f\u5426\u5177\u6709 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u6a19\u7c64](https://cloud.google.com/stackdriver/docs/solutions/agents/ops-agent/manage-policies-auto-install?hl=zh-cn#view-label) \u3002\n- [\u9a57\u8b49 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u5206\u914d\u5df2\u6210\u529f\u767c\u4f48](https://cloud.google.com/stackdriver/docs/solutions/agents/ops-agent/manage-policies-auto-install?hl=zh-cn#view-assignments) \u3002\n### \u9a57\u8b49\u5df2\u5c07 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u5206\u914d\u7d66\u53ef\u7528\u5340\u4e2d\u7684\u865b\u64ec\u6a5f\n\u5982\u9700\u9a57\u8b49\u53ef\u7528\u5340\u4e2d\u7684\u865b\u64ec\u6a5f\u5728 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u7684\u6db5\u84cb\u7bc4\u570d\u5167\uff0c\u8acb\u4f7f\u7528 Google Cloud \u63a7\u5236\u6aaf\u6216 gcloud CLI \u67e5\u770b\u865b\u64ec\u6a5f\u662f\u5426\u8207 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u5206\u914d\u76f8\u95dc\u3002\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5c0e\u822a\u9762\u677f\u4e2d\uff0c\u9078\u64c7 **Compute Engine** \uff0c\u7136\u5f8c\u9078\u64c7 **\u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56** : [\u9032\u5165\u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56](https://console.cloud.google.com/compute/config/instances?hl=zh-cn) \n- \u5728 **\u865b\u64ec\u6a5f\u5be6\u4f8b** \u6a19\u7c64\u9801\u4e0a\uff0c\u9078\u64c7\u8981\u6aa2\u67e5\u7684\u865b\u64ec\u6a5f\u3002\n- \u5982\u679c\u865b\u64ec\u6a5f\u5728 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u7684\u6db5\u84cb\u7bc4\u570d\u5167\uff0c\u5247 **\u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56 ID** \u5217\u5305\u542b `goog-ops-agent-policy` \u4e14\u72c0\u614b\u7232\u201c\u5408\u898f\u201d\u3002\n\u5982\u9700\u986f\u793a\u53ef\u7528\u5340\u4e2d\u7684 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u5206\u914d\u5217\u8868\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ngcloud compute os-config os-policy-assignment-reports list --location=ZONE --filter=\"ASSIGNMENT_ID ~ goog-ops-agent\"\n```\n\u8f38\u51fa\u6703\u986f\u793a\u5177\u6709 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u5206\u914d\u7684\u865b\u64ec\u6a5f\u5217\u8868\u3002\u5982\u679c\u865b\u64ec\u6a5f\u4e0a\u5b89\u88dd\u4e86 Ops Agent\uff0c\u5247\u201c\u6458\u8981\u201d\u5217\u7684\u503c\u7232\u201c\u7b26\u5408 1/1 \u653f\u7b56\u201d\u3002\n```\nINSTANCE ASSIGNMENT_ID         LOCATION UPDATE_TIME     SUMMARY\ninstance-1 goog-ops-agent-v2-x86-template-1-0-0-us-east4-c us-east4-c 2023-04-28T02:11:15.118088Z 1/1 policies compliant\ninstance-3 goog-ops-agent-v2-x86-template-1-0-0-us-east4-c us-east4-c 2023-04-28T02:11:15.118088Z 1/1 policies compliant\n```\n### \u9a57\u8b49\u865b\u64ec\u6a5f\u5177\u6709 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u6a19\u7c64\n\u5982\u9700\u67e5\u770b Google Cloud \u9805\u76ee\u4e2d\u54ea\u4e9b\u865b\u64ec\u6a5f\u5177\u6709 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u6a19\u7c64 `goog-ops-agent-policy` \uff0c\u8acb\u4f7f\u7528 Google Cloud \u63a7\u5236\u6aaf\u6216 gcloud CLI\u3002\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5c0e\u822a\u9762\u677f\u4e2d\uff0c\u9078\u64c7 **Compute Engine** \uff0c\u7136\u5f8c\u9078\u64c7 **\u865b\u64ec\u6a5f\u5be6\u4f8b** \uff1a [\u524d\u5f80\u865b\u64ec\u6a5f\u5be6\u4f8b](https://console.cloud.google.com/compute?hl=zh-cn) \n- \u9078\u64c7\u865b\u64ec\u6a5f\u7684\u540d\u7a31\u3002\n- \u5728 **\u57fa\u672c\u4fe1\u606f** \u9762\u677f\u4e2d\uff0c\u627e\u5230 **\u6a19\u7c64** \u689d\u76ee\u3002\u5982\u679c\u865b\u64ec\u6a5f\u5728 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u7684\u6db5\u84cb\u7bc4\u570d\u5167\uff0c\u5247\u5b83\u5177\u6709 `goog-ops-agent-policy:v2-x86-template-` `` \u6a19\u7c64\u3002\n\u5982\u9700\u67e5\u770b\u5177\u6709 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u6a19\u7c64 `goog-ops-agent-policy` \u7684\u6240\u6709\u865b\u64ec\u6a5f\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ngcloud compute instances list --format=\"table(name,zone,labels)\" --filter=\"labels=goog-ops-agent-policy\"\n```\n\u8f38\u51fa\u6703\u986f\u793a\u865b\u64ec\u6a5f\u7684\u540d\u7a31\u3001\u53ef\u7528\u5340\u548c\u6a19\u7c64\u3002\u4f8b\u5982\uff1a\n```\nNAME     ZONE   LABELS\ntest-vm1    us-central1-a {'goog-ops-agent-policy': 'v2-x86-template-1-0-0'}\ntest-vm1    us-east4-c  {'goog-ops-agent-policy': 'v2-x86-template-1-0-0'}\n```\n\u5982\u9700\u67e5\u770b\u7279\u5b9a\u865b\u64ec\u6a5f\u662f\u5426\u5177\u6709 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u6a19\u7c64\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ngcloud compute instances describe --format \"yaml(labels)\" --zone=ZONE VM_NAME\n```\n\u8f38\u51fa\u6703\u986f\u793a\u865b\u64ec\u6a5f\u7684\u6a19\u7c64\u5217\u8868\u3002\u5982\u679c\u60a8\u7684\u865b\u64ec\u6a5f\u5177\u6709 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u6a19\u7c64\uff0c\u5247 `goog-ops-agent-policy` \u6703\u986f\u793a\u5728 `labels` \u5217\u8868\u4e2d\u3002\u4f8b\u5982\uff1a\n```\nlabels:\n goog-ops-agent-policy: v2-x86-template-1-0-0\n```\n### \u9a57\u8b49 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u5206\u914d\u5df2\u6210\u529f\u767c\u4f48\n\u67e5\u770b Google Cloud \u9805\u76ee\u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u5206\u914d\uff0c\u4ee5\u9a57\u8b49 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u5206\u914d\u662f\u5426\u5df2\u6b63\u78ba\u90e8\u7f72\u5230\u7279\u5b9a\u53ef\u7528\u5340\u3002\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5c0e\u822a\u9762\u677f\u4e2d\uff0c\u9078\u64c7 **Compute Engine** \uff0c\u7136\u5f8c\u9078\u64c7 **\u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56** : [\u9032\u5165\u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56](https://console.cloud.google.com/compute/config/instances?hl=zh-cn) \n- \u5982\u9700\u67e5\u770b\u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u767c\u4f48\u7684\u72c0\u614b\uff0c\u8acb\u9ede\u64ca **\u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u5206\u914d** \u6a19\u7c64\u9801\u3002Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u5206\u914d\u5177\u6709\u4ee5\u5b57\u7b26\u4e32\u201cgoog-ops-agent\u201d\u958b\u982d\u7684 ID\u3002\u5982\u679c\u5206\u914d\u6210\u529f\u767c\u4f48\uff0c\u5247\u5176\u767c\u4f48\u72c0\u614b\u7232\u201c\u6210\u529f\u201d\u3002\n\u5982\u9700\u67e5\u770b\u53ef\u7528\u5340\u4e2d\u7684\u6240\u6709 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u5206\u914d\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ngcloud compute os-config os-policy-assignments list --location=ZONE --filter=\"ASSIGNMENT_ID ~ goog-ops-agent\"\n```\n\u8f38\u51fa\u6703\u986f\u793a\u53ef\u7528\u5340\u4e2d\u7684 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u5206\u914d\u5217\u8868\u3002\u5982\u679c\u5206\u914d\u6210\u529f\u767c\u4f48\uff0c\u5247\u5176\u767c\u4f48\u72c0\u614b\u7232\u201c\u6210\u529f\u201d\u3002\u4f8b\u5982\uff1a\n```\nASSIGNMENT_ID          ROLLOUT_STATE REVISION_CREATE_TIME  REVISION_ID\ngoog-ops-agent-v2-x86-template-1-4-0-us-central1-b SUCCEEDED  2023-01-28T05:23:41Z.  940df3e9-77fd-470b-84df-53fb24825c4a\ngoog-ops-agent-v2-x86-template-1-0-0-us-central1-b SUCCEEDED  2022-01-28T05:23:41Z.  qwareaff-efte-erew-aeet-faer234t4gga\n```\n\u5982\u9700\u67e5\u770b\u7279\u5b9a Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u5206\u914d\u4efb\u52d9\u7684\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ngcloud compute os-config os-policy-assignments describe POLICY_ASSIGNMENT_ID --location=ZONE\n```\n## \u5728 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u6db5\u84cb\u7684\u865b\u64ec\u6a5f\u4e0a\u5378\u8f09 Ops Agent\n\u5982\u679c\u60a8\u5728 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u6db5\u84cb\u7684\u865b\u64ec\u6a5f\u4e0a\u624b\u52d5 [\u5378\u8f09 Ops Agent](https://cloud.google.com/stackdriver/docs/solutions/agents/ops-agent/installation?hl=zh-cn#uninstall) \uff0c\u5247\u8a72\u653f\u7b56\u6703\u91cd\u65b0\u5b89\u88dd\u3002\u5982\u9700\u5378\u8f09 Ops Agent\uff0c\u60a8\u5fc5\u9808\u5148\u5f9e\u865b\u64ec\u6a5f\u4e2d\u79fb\u9664 `goog-ops-agent-policy` \u6a19\u7c64\u3002\u5f9e\u865b\u64ec\u6a5f\u4e2d\u79fb\u9664 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u6a19\u7c64\u5f8c\uff0c\u60a8\u53ef\u4ee5\u6c38\u4e45\u5378\u8f09 Ops Agent\u3002\n### \u5728\u7279\u5b9a\u865b\u64ec\u6a5f\u4e0a\u5378\u8f09 Ops Agent\n\u5982\u9700\u5f9e\u7279\u5b9a\u865b\u64ec\u6a5f\u79fb\u9664\u653f\u7b56\u4e26\u5378\u8f09 Ops Agent\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 Google Cloud \u63a7\u5236\u6aaf\u6216 gcloud CLI\u3002\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5c0e\u822a\u9762\u677f\u4e2d\uff0c\u9078\u64c7 **Compute Engine** \uff0c\u7136\u5f8c\u9078\u64c7 **\u865b\u64ec\u6a5f\u5be6\u4f8b** \uff1a [\u524d\u5f80\u865b\u64ec\u6a5f\u5be6\u4f8b](https://console.cloud.google.com/compute?hl=zh-cn) \n- \u9078\u64c7\u8981\u4fee\u6539\u7684\u865b\u64ec\u6a5f\u7684\u540d\u7a31\u3002\n- \u9ede\u64ca **\u4fee\u6539** \u3002\n- \u8f49\u5230 **\u6a19\u7c64** \u90e8\u5206\uff0c\u7136\u5f8c\u9ede\u64ca **+ \u6dfb\u52a0\u6a19\u7c64** \u3002\n- \u627e\u5230\u5305\u542b\u9375 `goog-ops-agent-policy` \u7684\u6a19\u7c64\uff0c\u7136\u5f8c\u9ede\u64ca **\u522a\u9664\u9805** \u3002\n- [\u5378\u8f09\u4ee3\u7406](https://cloud.google.com/stackdriver/docs/solutions/agents/ops-agent/installation?hl=zh-cn#uninstall) \u3002- \u5982\u9700\u5f9e\u865b\u64ec\u6a5f\u4e2d\u79fb\u9664 `goog-ops-agent-policy` \u6a19\u7c64\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud compute instances update VM_NAME \\\n --remove-labels=goog-ops-agent-policy\n```\n- [\u5378\u8f09\u4ee3\u7406](https://cloud.google.com/stackdriver/docs/solutions/agents/ops-agent/installation?hl=zh-cn#uninstall) \u3002\n### \u5728\u6240\u6709\u865b\u64ec\u6a5f\u4e0a\u5378\u8f09 Ops Agent\n\u5982\u9700\u5f9e\u5177\u6709 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u5206\u914d\u7684\u53ef\u7528\u5340\u7684\u865b\u64ec\u6a5f\u4e2d\u5378\u8f09 Ops Agent\uff0c\u8acb\u4f7f\u7528 Cloud Monitoring \u63d0\u4f9b\u7684\u8173\u672c\u3002\u60a8\u7121\u6cd5\u4f7f\u7528 Google Cloud \u63a7\u5236\u6aaf\u5f9e\u4e00\u7d44\u865b\u64ec\u6a5f\u4e2d\u5378\u8f09\u4ee3\u7406\u3002\n\u5982\u9700\u904b\u884c\u8a72\u8173\u672c\uff0c\u60a8\u5fc5\u9808\u5177\u6709 [GuestPolicy Editor \u89d2\u8272](https://cloud.google.com/iam/docs/understanding-roles?hl=zh-cn#osconfig.guestPolicyEditor) ( `roles/osconfig.guestPolicyEditor` )\u3002\n\u5728 Cloud Shell \u4e2d\u904b\u884c\u4ee5\u4e0b\u8173\u672c\u3002\u60a8\u53ef\u4ee5\u63d0\u4f9b\u4efb\u610f\u6578\u91cf\u7684\u53ef\u7528\u5340\uff1a\n```\ncurl -sSO https://dl.google.com/cloudagents/undo-ops-agent-policies.sh\nbash undo-ops-agent-policies.sh ZONE1 ZONE2\n```\n\u8a72\u8173\u672c\u6703\u5728\u6bcf\u500b\u53ef\u7528\u5340\u4e2d\u57f7\u884c\u4ee5\u4e0b\u4efb\u52d9\uff1a\n- \u67e5\u627e\u6240\u6709 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u3002\n- \u4fee\u6539\u6bcf\u9805\u653f\u7b56\uff0c\u4ee5\u4fbf\u5728\u5176\u8986\u84cb\u7684\u865b\u64ec\u6a5f\u4e0a\u5378\u8f09 Ops Agent\u3002\n- \u522a\u9664 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u3002\n- \u5f9e\u6bcf\u500b\u6db5\u84cb\u7684\u865b\u64ec\u6a5f\u4e2d\u79fb\u9664`goog-ops-agent-policy`\u6a19\u7c64\u3002## \u5411\u73fe\u6709\u865b\u64ec\u6a5f\u6dfb\u52a0 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u8986\u84cb\u7bc4\u570d\nOps Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u50c5\u6db5\u84cb\u5177\u6709 `goog-ops-agent-policy` \u6a19\u7c64\u4e14\u8207\u73fe\u6709 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u5206\u914d\u4efb\u52d9\u4f4d\u65bc\u540c\u4e00\u53ef\u7528\u5340\u7684\u865b\u64ec\u6a5f\u3002\u4f46\u662f\uff0c\u60a8\u53ef\u4ee5\u5c07\u8986\u84cb\u7bc4\u570d\u64f4\u5c55\u5230\u6c92\u6709\u5206\u914d Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u7684\u5176\u4ed6\u865b\u64ec\u6a5f\u3002\n\u5982\u9700\u5c07\u653f\u7b56\u8986\u84cb\u7bc4\u570d\u64f4\u5c55\u5230\u865b\u64ec\u6a5f\uff0c\u60a8\u9700\u8981\u77e5\u9053\u53ef\u7528\u5340\u4e2d Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u5206\u914d\u7684\u6a21\u677f\u7248\u672c\u3002\u5982\u679c\u60a8\u7684\u53ef\u7528\u5340\u6709\u591a\u500b Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u5206\u914d\uff0c\u5247\u67e5\u627e\u5177\u6709\u6700\u65b0\u6a21\u677f\u7248\u672c\u7684\u5206\u914d\u3002\u5982\u9700\u986f\u793a\u53ef\u7528\u5340\u4e2d\u7684 Ops Agent \u64cd\u4f5c\u7cfb\u7d71\u653f\u7b56\u5206\u914d\u5217\u8868\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ngcloud compute os-config os-policy-assignments list --location=ZONE\n --filter=\"ASSIGNMENT_ID ~ goog-ops-agent\"\n```\n\u5982\u9700\u5c07\u653f\u7b56\u8986\u84cb\u7bc4\u570d\u64f4\u5c55\u5230\u5176\u4ed6\u865b\u64ec\u6a5f\uff0c\u8acb\u4f7f\u7528 Google Cloud \u63a7\u5236\u6aaf\u6216 gcloud CLI\uff1a\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5c0e\u822a\u9762\u677f\u4e2d\uff0c\u9078\u64c7 **Compute Engine** \uff0c\u7136\u5f8c\u9078\u64c7 **\u865b\u64ec\u6a5f\u5be6\u4f8b** \uff1a [\u524d\u5f80\u865b\u64ec\u6a5f\u5be6\u4f8b](https://console.cloud.google.com/compute?hl=zh-cn) \n- \u5728 **\u865b\u64ec\u6a5f\u5be6\u4f8b** \u5217\u8868\u4e2d\uff0c\u9078\u4e2d\u8981\u52a0\u6a19\u7c64\u7684\u865b\u64ec\u6a5f\u65c1\u908a\u7684\u8907\u9078\u6846\uff0c\u7136\u5f8c\u9ede\u64ca **\u6a19\u7c64** \u3002\n- \u5982\u9700\u6dfb\u52a0\u6a19\u7c64\uff0c\u8acb\u9ede\u64ca **+ \u6dfb\u52a0\u6a19\u7c64** \uff0c\u7136\u5f8c\u6dfb\u52a0\u9375\u503c\u5c0d\u3002\u9375\u5fc5\u9808\u7232 `goog-ops-agent-policy` \uff0c\u503c\u7232\u6240\u9700\u7684\u6a21\u677f\u7248\u672c\uff0c\u4f8b\u5982 `` \u3002\n- \u4fdd\u5b58\u66f4\u6539\u3002\n\u5982\u9700\u5c07\u653f\u7b56\u8986\u84cb\u7bc4\u570d\u64f4\u5c55\u5230\u6c92\u6709\u8986\u84cb\u7684\u865b\u64ec\u6a5f\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ngcloud compute instances update VM_NAME --zone=ZONE\n --update-labels=goog-ops-agent-policy:v2-x86-template-1-0-0\n```\n```\ngcloud compute instances add-metadata VM_NAME --zone=ZONE\n --metadata=enable-osconfig=TRUE\n```\n## \u6b0a\u9650\nOps Agent \u5b89\u88dd\u4f7f\u7528\u865b\u64ec\u6a5f\u7ba1\u7406\u5668\uff0c\u9700\u8981\u76f8\u61c9\u6b0a\u9650\u624d\u80fd\u6fc0\u6d3b VM Manager API \u4e26\u5275\u5efa\u653f\u7b56\u3002\u4f7f\u7528 [Editor \u89d2\u8272](https://cloud.google.com/iam/docs/understanding-roles?hl=zh-cn#editor) ( `roles/Editor` ) \u53ef\u63d0\u4f9b\u6240\u6709\u6240\u9700\u7684\u6b0a\u9650\u3002\u6216\u8005\uff0c\u60a8\u53ef\u4ee5\u8b93\u9805\u76ee\u7ba1\u7406\u54e1\u4f7f\u7528 Google Cloud CLI \u6388\u4e88\u6700\u5c0f\u6b0a\u9650\u3002\n\u5728\u5275\u5efa\u865b\u64ec\u6a5f\u671f\u9593\u5b89\u88dd Ops Agent \u6240\u9700\u7684\u6b0a\u9650\uff1a\n- `serviceusage.services.get`\n- `serviceusage.services.enable`\n- `osconfig.osPolicyAssignments.get`\n- `osconfig.osPolicyAssignments.create`\n- `osconfig.projectBillingConfigs.update`\n- `compute.instances.create`\n\u5728\u73fe\u6709\u865b\u64ec\u6a5f\u4e0a\u5b89\u88dd Ops Agent \u6240\u9700\u7684\u6b0a\u9650\uff1a\n- `serviceusage.services.get`\n- `serviceusage.services.enable`\n- `osconfig.osPolicyAssignments.get`\n- `osconfig.osPolicyAssignments.create`\n- `osconfig.projectBillingConfigs.update`\n- `compute.instances.setMetadata`\n- `compute.instances.setLabels`\n\u60a8\u53ef\u4ee5\u5728 [IAM \u57fa\u672c\u89d2\u8272\u548c\u9810\u5b9a\u7fa9\u89d2\u8272\u53c3\u8003\u6587\u6a94](https://cloud.google.com/iam/docs/understanding-roles?hl=zh-cn) \u4e2d\u627e\u5230\u63d0\u4f9b\u9019\u4e9b\u6b0a\u9650\u7684\u76f8\u61c9\u89d2\u8272\uff0c\u4f46 `osconfig.projectBillingConfigs.update` \u6b0a\u9650\u9664\u5916\u3002 `osconfig.projectBillingConfig` \u89d2\u8272\u64c1\u6709\u6b64\u6b0a\u9650\u3002\u6b64\u89d2\u8272\u7121\u6cd5\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7372\u5f97\uff0c\u4f46\u53ef\u4ee5\u901a\u904e gcloud CLI \u6388\u4e88\u3002\n\u7528\u65bc\u6388\u4e88\u6b0a\u9650\u7684\u89d2\u8272\u7684\u793a\u4f8b\u547d\u4ee4\uff1a\n```\ngcloud projects add-iam-policy-binding project-id --member='user:user-email' --role='roles/osconfig.projectBillingConfigEditor'\n```", "guide": "Google Cloud Observability"}