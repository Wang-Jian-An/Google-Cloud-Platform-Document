{"title": "Google Cloud Observability - \u5275\u5efa\u63d0\u9192\u653f\u7b56", "url": "https://cloud.google.com/stackdriver/docs/solutions/slo-monitoring/api/create-policy-api?hl=zh-cn", "abstract": "# Google Cloud Observability - \u5275\u5efa\u63d0\u9192\u653f\u7b56\n\u7cfb\u7d71\u6703\u57fa\u65bc [\u6aa2\u7d22 SLO \u6578\u64da](https://cloud.google.com/stackdriver/docs/solutions/slo-monitoring/api/timeseries-selectors?hl=zh-cn) \u4e2d\u8aaa\u660e\u7684\u6642\u9593\u5e8f\u5217\u9078\u64c7\u5668 `select_slo_burn_rate` \u767c\u51fa\u6709\u95dc\u932f\u8aa4\u9810\u7b97\u6d88\u8017\u7387\u7684\u63d0\u9192\u653f\u7b56\u3002\u9084\u6709\u5176\u4ed6\u6642\u9593\u5e8f\u5217\u9078\u64c7\u5668\uff0c\u60a8\u53ef\u4ee5\u5c07\u5176\u4e2d\u4e00\u4e9b\u7528\u4f5c\u63d0\u9192\u653f\u7b56\u7684\u57fa\u790e\u3002\u5982\u9700\u67e5\u770b\u57fa\u65bc SLO \u7684\u63d0\u9192\u653f\u7b56\u7684\u8a0e\u8ad6\uff0c\u8acb\u53c3\u95b1 [\u6d88\u8017\u7387\u63d0\u9192](https://cloud.google.com/stackdriver/docs/solutions/slo-monitoring/alerting-on-budget-burn-rate?hl=zh-cn) \u3002\n\u60a8\u53ef\u4ee5\u4f7f\u7528 [alertPolicies.create](https://cloud.google.com/monitoring/api/ref_v3/rest/v3/projects.alertPolicies/create?hl=zh-cn) \u65b9\u6cd5\u5275\u5efa\u63d0\u9192\u653f\u7b56\u3002 [\u7ba1\u7406\u63d0\u9192\u653f\u7b56](https://cloud.google.com/monitoring/alerts/using-alerting-api?hl=zh-cn) \u4e2d\u4ecb\u7d39\u4e86\u6b64\u65b9\u6cd5\u7684\u4e00\u822c\u7528\u6cd5\u3002\nSLO \u7684\u63d0\u9192\u653f\u7b56\u8207\u5176\u4ed6\u6307\u6a19\u95be\u503c\u63d0\u9192\u653f\u7b56\u985e\u4f3c\uff0c\u4f46\u5b83\u5011\u5728\u67d0\u4e00\u7279\u5b9a\u65b9\u9762\u6709\u6240\u4e0d\u540c\uff1a\u689d\u4ef6 [MetricThreshold](https://cloud.google.com/monitoring/api/ref_v3/rest/v3/projects.alertPolicies?hl=zh-cn#MetricThreshold) \u898f\u7bc4\u4e2d\u7684 `filter` \u4f7f\u7528\u6642\u9593\u5e8f\u5217\u9078\u64c7\u5668\uff0c\u800c\u4e0d\u662f\u4e00\u5c0d\u6307\u6a19\u548c\u53d7\u76e3\u63a7\u7684\u8cc7\u6e90\u985e\u578b\u3002\n", "content": "## \u57fa\u65bc SLO \u7684\u63d0\u9192\u653f\u7b56\u7684\u689d\u4ef6\n\u4e00\u9805\u63d0\u9192\u7b56\u7565\u5fc5\u9808\u81f3\u5c11\u5305\u542b\u4e00\u500b\u689d\u4ef6\u3002\u5c0d\u65bc\u57fa\u65bc SLO \u7684\u689d\u4ef6\uff0c\u8acb\u4f7f\u7528 [MetricThreshold](https://cloud.google.com/monitoring/api/ref_v3/rest/v3/projects.alertPolicies?hl=zh-cn#MetricThreshold) \u985e\u578b\u7684\u689d\u4ef6\u3002\n\u6307\u6a19\u95be\u503c\u689d\u4ef6\u53ef\u4ee5\u5305\u542b\u5169\u5c0d\u6642\u9593\u5e8f\u5217\u914d\u7f6e\uff1a `filter` \u548c `aggregations` \u3002\u7531\u65bc SLO \u6578\u64da\u7684\u6aa2\u7d22\u65b9\u5f0f\u8207\u5176\u4ed6\u6642\u9593\u5e8f\u5217\u6578\u64da\u4e0d\u540c\uff0c\u56e0\u6b64 SLO \u689d\u4ef6\u4e2d\u4f7f\u7528\u7684\u552f\u4e00\u5b57\u6bb5\u662f `filter` \u5b57\u6bb5\u3002\nSLO \u689d\u4ef6\u8981\u8a2d\u7f6e `comparison` \u3001 `thresholdValue` \u3001 `duration` \u548c `trigger` \u5b57\u6bb5\u3002\n\u6b64\u793a\u4f8b\u5275\u5efa\u4e86\u4e00\u5247\u689d\u4ef6\uff0c\u7576\u6d88\u8017\u7387\u8d85\u904e\u6b63\u5e38\u6bd4\u7387 2 \u500d\u6642\u6703\u9055\u53cd\u8a72\u689d\u4ef6\u3002\u8a72\u7d50\u69cb\u5982\u4e0b\u6240\u793a\uff1a\n```\n\u00a0\u00a0\"conditions\": [ {\n \u00a0 \u00a0\"displayName\":\"SLO burn rate alert for ${SLO_ID} exceeds 2\",\n\u00a0\u00a0\u00a0\u00a0 \"conditionThreshold\": {\n\u00a0\u00a0\u00a0\u00a0\u00a0 \u00a0\"filter\": DATA_RETRIEVAL_FILTER_FOR_SLO,\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 \"comparison\":\"COMPARISON_GT\",\n\u00a0\u00a0\u00a0\u00a0 \u00a0\u00a0\"thresholdValue\": 2,\n\u00a0\u00a0\u00a0\u00a0\u00a0 \u00a0\"duration\": {\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 \u00a0\u00a0\"seconds\":\"0\",\n\u00a0\u00a0\u00a0\u00a0\u00a0 \u00a0},\n  },\n\u00a0\u00a0\u00a0\u00a0}\n\u00a0\u00a0],\n```\n\u8981\u8a2d\u7f6e `filter` \u5b57\u6bb5\uff0c\u60a8\u9700\u8981\u7279\u5b9a SLO \u7684\u8cc7\u6e90\u540d\u7a31\u3002\u8a72\u503c\u7684\u683c\u5f0f\u7232 `projects/${PROJECT}/services/${SERVICE_ID}/serviceLevelObjectives/${SLO_ID}` \u3002\u5982\u9700\u77ad\u89e3\u67e5\u627e SLO ID \u7684\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 [\u5217\u51fa SLO](https://cloud.google.com/stackdriver/docs/solutions/slo-monitoring/api/using-api?hl=zh-cn#slos-list) \u3002\n\u8981\u91dd\u5c0d\u6d88\u8017\u7387\u5275\u5efa\u63d0\u9192\uff0c\u8acb\u4f7f\u7528\u6642\u9593\u5e8f\u5217\u9078\u64c7\u5668 `select_slo_burn_rate` \u3002\u6b64\u9078\u64c7\u5668\u63a1\u7528\u5169\u500b\u503c\uff1a\u76ee\u6a19 SLO \u548c\u56de\u6eaf\u671f\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [select_slo_burn_rate](https://cloud.google.com/stackdriver/docs/solutions/slo-monitoring/api/timeseries-selectors?hl=zh-cn#tss-burn-rate) \u3002\n\u4f8b\u5982\uff0c\u4ee5\u4e0b\u904e\u6ffe\u5668\u53ef\u7372\u53d6\u56de\u6eaf\u671f\u7232 1 \u5c0f\u6642\u7684\u76ee\u6a19 SLO \u7684\u6d88\u8017\u7387\uff1a\n`\"filter\":\"select_slo_burn_rate(\\\"projects/${PROJECT}/services/${SERVICE_ID}/serviceLevelObjectives/${SLO_ID}\\\", \\\"60m\\\")\"`\n## \u63d0\u9192\u653f\u7b56\u7684\u5176\u9918\u90e8\u5206\n\u8981\u5b8c\u6210\u63d0\u9192\u653f\u7b56\uff0c\u8acb\u7232\u5176\u9918\u5b57\u6bb5\u6307\u5b9a\u503c\uff1a\n- `displayName`\uff1a\u63d0\u9192\u653f\u7b56\u7684\u8aaa\u660e\u3002\n- `combiner`\uff1a\u63cf\u8ff0\u7d44\u5408\u689d\u4ef6\u7684\u908f\u8f2f\u3002\u6b64\u653f\u7b56\u53ea\u6709\u4e00\u500b\u689d\u4ef6\uff0c\u56e0\u6b64\u8981\u9ebc\u4f7f\u7528`AND`\uff0c\u8981\u9ebc\u4f7f\u7528`OR`\u3002\n- `notificationChannels`\uff1a\u89f8\u767c\u63d0\u9192\u653f\u7b56\u6642\u8981\u4f7f\u7528\u7684\u4e00\u7cfb\u5217\u73fe\u6709\u901a\u77e5\u6e20\u9053\u3002\u5982\u9700\u77ad\u89e3\u5982\u4f55\u67e5\u627e\u548c\u5275\u5efa\u901a\u77e5\u6e20\u9053\uff0c\u8acb\u53c3\u95b1 [\u901a\u77e5\u6e20\u9053](https://cloud.google.com/monitoring/alerts/using-channels-api?hl=zh-cn#nc) \u3002\n- `documentation`\uff1a\u9055\u53cd\u689d\u4ef6\u6642\u767c\u9001\u7684\u4fe1\u606f\uff0c\u5e6b\u52a9\u6536\u4ef6\u4eba\u8a3a\u65b7\u554f\u984c\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [Documentation](https://cloud.google.com/monitoring/api/ref_v3/rest/v3/projects.alertPolicies?hl=zh-cn#Documentation) \u3002## \u5275\u5efa\u63d0\u9192\u653f\u7b56\n\u4ee5\u4e0b\u793a\u4f8b\u4f7f\u7528 API \u5275\u5efa\u4e86\u4e00\u500b\u6d88\u8017\u7387\u63d0\u9192\u653f\u7b56\u3002 \u5982\u9700\u77ad\u89e3\u5982\u4f55\u5217\u51fa\u3001\u4fee\u6539\u548c\u522a\u9664\u63d0\u9192\u653f\u7b56\uff0c\u8acb\u53c3\u95b1 [\u901a\u904e API \u7ba1\u7406\u63d0\u9192\u653f\u7b56](https://cloud.google.com/monitoring/alerts/using-alerting-api?hl=zh-cn) \u3002\n\u8981\u4f7f\u7528\n`curl`\n\u5275\u5efa\u63d0\u9192\u653f\u7b56\uff0c\u8acb\u5c07\n`POST`\n\u6d88\u606f\u767c\u9001\u5230\n`https://monitoring.googleapis.com/v3/projects/${PROJECT_ID}/alertPolicies`\n\u7aef\u9ede\uff0c\u4e26\u5728\u8acb\u6c42\u6b63\u6587\u4e2d\u63d0\u4f9b\u63d0\u9192\u653f\u7b56\u3002\u8acb\u6c42\u6b63\u6587\u4e2d\u7684 JSON \u63cf\u8ff0\u4e86\u4e00\u500b\u63d0\u9192\u653f\u7b56\uff0c\u8a72\u653f\u7b56\u4f7f\u7528\u7684\u95be\u503c\u689d\u4ef6\u4ee5\u56de\u6eaf\u671f\u7232 1 \u5c0f\u6642\u7684\n`select_slo_burn_rate`\n\u6642\u9593\u5e8f\u5217\u9078\u64c7\u5668\u7232\u57fa\u790e\u3002\n- \u5275\u5efa\u4e00\u500b\u8b8a\u91cf\u4ee5\u4fdd\u5b58\u8acb\u6c42\u6b63\u6587\uff1a```\nCREATE_ALERT_POST_BODY=$(cat <<EOF{\u00a0 \"displayName\":\"SLO burn-rate alert for ${SLO_ID} with a threshold of 2\",\u00a0 \"combiner\":\"AND\",\u00a0 \"conditions\": [\u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \"displayName\":\"SLO burn rate alert for ${SLO_ID} exceeds 2\",\u00a0 \u00a0 \u00a0 \"conditionThreshold\": {\u00a0 \u00a0 \u00a0 \u00a0 \"filter\":\"select_slo_burn_rate(\\\"projects/${PROJECT}/services/${SERVICE_ID}/serviceLevelObjectives/${SLO_ID}\\\", \\\"60m\\\")\",\u00a0 \u00a0 \u00a0 \u00a0 \"comparison\":\"COMPARISON_GT\",\u00a0 \u00a0 \u00a0 \u00a0 \"thresholdValue\": 2,\u00a0 \u00a0 \u00a0 \u00a0 \"duration\": {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"seconds\":\"0\",\u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 }\u00a0 ],\u00a0 \"notificationChannels\": [\"${NOTIFICATION_CHANNEL}\", ],\u00a0 \"documentation\": {\u00a0 \u00a0 \u00a0\"content\": \"SLO burn for the past 60m exceeded twice the acceptable budget burn rate.\",\u00a0 \u00a0 \u00a0\"mime_type\": \"text/markdown\",\u00a0 },}EOF)\n```\n- \u5c07\u8acb\u6c42\u767c\u4f48\u5230\u7aef\u9ede\uff1a```\ncurl \u00a0--http1.1 --header \"Authorization: Bearer ${ACCESS_TOKEN}\" --header \"Content-Type: application/json\" -X POST -d \"${CREATE_ALERT_POST_BODY}\" https://monitoring.googleapis.com/v3/projects/${PROJECT_ID}/alertPolicies\n```", "guide": "Google Cloud Observability"}