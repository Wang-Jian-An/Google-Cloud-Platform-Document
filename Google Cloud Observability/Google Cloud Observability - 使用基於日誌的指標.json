{"title": "Google Cloud Observability - \u4f7f\u7528\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19", "url": "https://cloud.google.com/stackdriver/docs/solutions/slo-monitoring/sli-metrics/logs-based-metrics?hl=zh-cn", "abstract": "# Google Cloud Observability - \u4f7f\u7528\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19\n\u672c\u9801\u9762\u4ecb\u7d39\u767c\u51fa\u65e5\u8a8c\u4ee5\u5275\u5efa\u53ef\u7528\u6027\u548c\u5ef6\u9072\u6642\u9593 SLI \u7684\u57fa\u790e\u77e5\u8b58\u3002\u5b83\u9084\u63d0\u4f9b\u4e86\u6709\u95dc\u5982\u4f55\u4f7f\u7528\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19\u5b9a\u7fa9 SLO \u7684\u5be6\u73fe\u793a\u4f8b\u3002\n\u4f7f\u7528\u65e5\u8a8c\u689d\u76ee\u4e2d\u7684\u6578\u64da\u5143\u7d20\u5275\u5efa\u670d\u52d9\u7b49\u7d1a\u6307\u6a19\u662f\u4e00\u7a2e\u5229\u7528\u73fe\u6709\u65e5\u8a8c\u8f09\u8377\u7684\u7c21\u55ae\u65b9\u6cd5\u3002\u5426\u5247\uff0c\u60a8\u53ef\u4ee5\u5411\u73fe\u6709\u670d\u52d9\u6dfb\u52a0\u65e5\u8a8c\u8a18\u9304\uff0c\u9019\u53ef\u80fd\u6bd4\u5275\u5efa\u6307\u6a19\u63d2\u6a01\u66f4\u5bb9\u6613\u3002\n", "content": "## \u65e5\u8a8c\u548c\u6307\u6a19\n\u65e5\u8a8c\u6703\u6536\u96c6\u540d\u7232\u65e5\u8a8c\u689d\u76ee \u7684\u8a18\u9304\uff0c\u7528\u65bc\u63cf\u8ff0\u8a08\u7b97\u6a5f\u7cfb\u7d71\u4e2d\u767c\u751f\u7684\u7279\u5b9a\u4e8b\u4ef6\u3002\u65e5\u8a8c\u7528\u4ee3\u78bc\u3001\u904b\u884c\u4ee3\u78bc\u7684\u5e73\u81fa\u670d\u52d9\uff08\u4f8b\u5982 Dataflow\uff09\u4ee5\u53ca\u5e73\u81fa\u6240\u4f9d\u8cf4\u7684\u57fa\u790e\u67b6\u69cb\uff08\u4f8b\u5982 Compute Engine \u5be6\u4f8b\uff09\u7de8\u5beb\u3002\n\u7531\u65bc\u73fe\u4ee3\u7cfb\u7d71\u4e2d\u7684\u65e5\u8a8c\u5f9e\u5beb\u5165\u78c1\u76e4\u7684\u6587\u672c\u6587\u4ef6\u4e2d\u525d\u96e2\uff08\u6709\u6642\u4ecd\u662f\u6587\u672c\u6587\u4ef6\uff09\uff0c\u56e0\u6b64\u65e5\u8a8c\u689d\u76ee\u985e\u4f3c\u65bc\u65e5\u8a8c\u6587\u4ef6\u4e2d\u7684\u4e00\u884c\uff0c\u4e26\u4e14\u53ef\u4ee5\u88ab\u8996\u7232\u65e5\u8a8c\u8a18\u9304\u7684\u57fa\u672c\u55ae\u5143\u3002\n\u65e5\u8a8c\u689d\u76ee\u81f3\u5c11\u5305\u542b\u5169\u500b\u5167\u5bb9\uff1a\n- \u6642\u9593\u6233\uff0c\u7528\u65bc\u6307\u793a\u4e8b\u4ef6\u767c\u751f\u7684\u6642\u9593\u6216\u5c07\u4e8b\u4ef6\u63d0\u53d6\u5230\u65e5\u8a8c\u8a18\u9304\u7cfb\u7d71\u4e2d\u7684\u6642\u9593\u3002\n- \u6587\u672c\u8f09\u8377\uff0c\u4ee5\u975e\u7d50\u69cb\u5316\u6587\u672c\u6578\u64da\u6216\u7d50\u69cb\u5316\u6578\u64da\u5f62\u5f0f\uff0c\u901a\u5e38\u63a1\u7528 JSON \u683c\u5f0f\u3002\n\u65e5\u8a8c\u9084\u53ef\u4ee5\u5305\u542b\u95dc\u806f\u7684\u5143\u6578\u64da\uff0c\u7279\u5225\u662f\u5728\u5c07\u5b83\u5011\u63d0\u53d6\u5230 Cloud Logging \u4e2d\u6642\u3002\u6b64\u985e\u5143\u6578\u64da\u53ef\u80fd\u5305\u62ec\u5beb\u5165\u65e5\u8a8c\u7684\u8cc7\u6e90\u3001\u65e5\u8a8c\u540d\u7a31\u548c\u6bcf\u500b\u689d\u76ee\u7684\u56b4\u91cd\u7a0b\u5ea6\u3002\n### \u65e5\u8a8c\n\u65e5\u8a8c\u6709\u5169\u500b\u4e3b\u8981\u7528\u9014\uff1a\n- \u65e5\u8a8c\u4ecb\u7d39\u7684\u662f\u7cfb\u7d71\u5167\u90e8\u767c\u751f\u7684\u7279\u5b9a\u4e8b\u4ef6\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u4e8b\u4ef6\u65e5\u8a8c\u4f86\u8f38\u51fa\u6d88\u606f\uff0c\u4ee5\u78ba\u4fdd\u7528\u6236\u5de5\u4f5c\u6b63\u5e38\uff08\u201c\u4efb\u52d9\u6210\u529f\u201d\uff09\uff0c\u6216\u8005\u5728\u51fa\u73fe\u554f\u984c\u6642\u63d0\u4f9b\u4fe1\u606f\uff08\u201c\u5f9e\u670d\u52d9\u5668\u6536\u5230\u7570\u5e38\u201d\uff09\u3002\n- \u4e8b\u52d9\u65e5\u8a8c\u63cf\u8ff0\u4e86\u7cfb\u7d71\u6216\u7d44\u4ef6\u8655\u7406\u7684\u6bcf\u500b\u4e8b\u52d9\u7684\u8a73\u7d30\u4fe1\u606f\u3002\u4f8b\u5982\uff0c\u8ca0\u8f09\u5e73\u8861\u5668\u6703\u8a18\u9304\u5176\u6536\u5230\u7684\u6bcf\u500b\u8acb\u6c42\uff08\u7121\u8ad6\u8acb\u6c42\u662f\u5426\u6210\u529f\uff09\uff0c\u4e26\u8a18\u9304\u5176\u4ed6\u4fe1\u606f\uff0c\u5982\u8acb\u6c42\u7684\u7db2\u5740\u3001HTTP \u97ff\u61c9\u4ee3\u78bc\u4ee5\u53ca\u53ef\u80fd\u50cf\u4f7f\u7528\u4e86\u54ea\u500b\u5f8c\u7aef\u4f86\u670d\u52d9\u8a72\u8acb\u6c42\u7684\u4fe1\u606f\u3002\n### \u6307\u6a19\n\u8207\u65e5\u8a8c\u4e0d\u540c\uff0c\u6307\u6a19\u901a\u5e38\u4e0d\u6703\u63cf\u8ff0\u5177\u9ad4\u4e8b\u4ef6\u3002\u6307\u6a19\u66f4\u5e38\u7528\u65bc\u8868\u793a\u7cfb\u7d71\u5728\u4e00\u6bb5\u6642\u9593\u5167\u7684\u72c0\u614b\u6216\u904b\u884c\u72c0\u6cc1\u3002\u6307\u6a19\u7531\u4e00\u7cfb\u5217\u6e2c\u91cf\u7cfb\u7d71\u7684\u76f8\u95dc\u6578\u64da\u9ede\u7d44\u6210\uff1a\u6bcf\u500b\u6578\u64da\u9ede\u90fd\u5305\u542b\u4e00\u500b\u6642\u9593\u6233\u548c\u4e00\u500b\u6578\u503c\u3002\n\u6307\u6a19\u9084\u53ef\u4ee5\u5177\u6709\u8207\u4e4b\u95dc\u806f\u7684\u5143\u6578\u64da\uff1b\u6578\u64da\u9ede\u5e8f\u5217\uff08\u7a31\u7232\u6642\u9593\u5e8f\u5217\uff09 \u53ef\u80fd\u5305\u542b\u6307\u6a19\u540d\u7a31\u3001\u8aaa\u660e\uff0c\u9084\u5e38\u5e38\u5305\u542b\u7528\u65bc\u6307\u5b9a\u54ea\u4e9b\u8cc7\u6e90\u6b63\u5728\u5beb\u5165\u6578\u64da\u7684\u6a19\u7c64\u7b49\u4fe1\u606f\u3002\u5982\u9700\u77ad\u89e3 Monitoring \u6307\u6a19\u6a21\u578b\uff0c\u8acb\u53c3\u95b1 [\u6307\u6a19\u3001\u6642\u9593\u5e8f\u5217\u548c\u8cc7\u6e90](https://cloud.google.com/monitoring/api/v3/metrics?hl=zh-cn) \u3002\n### \u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19\n\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19\u662f\u57fa\u65bc\u65e5\u8a8c\u689d\u76ee\uff0c\u901a\u904e\u5f9e\u65e5\u8a8c\u689d\u76ee\u4e2d\u63d0\u53d6\u4fe1\u606f\u4e26\u5c07\u5176\u8f49\u63db\u7232\u6642\u9593\u5e8f\u5217\u6578\u64da\u5275\u5efa\u7684\u3002Cloud Logging \u63d0\u4f9b\u4e86\u901a\u904e\u65e5\u8a8c\u689d\u76ee\u5275\u5efa\u4ee5\u4e0b\u5169\u7a2e\u6307\u6a19\u7684\u6a5f\u5236\uff1a\n- \u8a08\u6578\u5668\u6307\u6a19 \uff0c\u7528\u65bc\u8a08\u7b97\u8207\u7279\u5b9a\u904e\u6ffe\u689d\u4ef6\u5339\u914d\u7684\u65e5\u8a8c\u689d\u76ee\u6578\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u8a08\u6578\u5668\u6307\u6a19\u4f86\u78ba\u5b9a\u65e5\u8a8c\u4e2d\u8a18\u9304\u7684\u8acb\u6c42\u6216\u932f\u8aa4\u6578\u3002\n- \u5206\u4f48\u6307\u6a19 \uff0c\u4f7f\u7528\u6b63\u5247\u8868\u9054\u5f0f\u4f86\u89e3\u6790\u6bcf\u500b\u65e5\u8a8c\u689d\u76ee\u4e2d\u7684\u8f09\u8377\uff0c\u4ee5\u5c07\u6578\u503c\u4ee5\u5206\u4f48\u5f62\u5f0f\u9032\u884c\u63d0\u53d6\u3002\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3 Cloud Logging \u4e2d\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19](https://cloud.google.com/logging/docs/logs-based-metrics?hl=zh-cn) \u3002\n### \u5c07\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19\u7528\u4f5c SLI\n\u901a\u904e\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19\uff0c\u60a8\u53ef\u4ee5\u63a1\u7528\u5728 Monitoring \u4e2d\u69cb\u5efa SLI \u6240\u7528\u7684\u5f62\u5f0f\u5f9e\u65e5\u8a8c\u4e2d\u63d0\u53d6\u6578\u64da\uff1a\n- \u60a8\u53ef\u4ee5\u4f7f\u7528\u57fa\u65bc\u65e5\u8a8c\u7684\u8a08\u6578\u5668\u6307\u6a19\u4f86\u8868\u793a\u57fa\u65bc\u8acb\u6c42\u7684\u53ef\u7528\u6027 SLI\u3002\n- \u60a8\u53ef\u4ee5\u4f7f\u7528\u57fa\u65bc\u65e5\u8a8c\u7684\u5206\u4f48\u6307\u6a19\u4f86\u8868\u793a\u57fa\u65bc\u8acb\u6c42\u7684\u5ef6\u9072\u6642\u9593 SLI\u3002\n### \u793a\u4f8b\u65e5\u8a8c\u689d\u76ee\nStack Doctor \u61c9\u7528\u662f\u9032\u884c\u670d\u52d9\u63d2\u6a01\u4ee5\u767c\u51fa\u65e5\u8a8c\u6d88\u606f\u7684\u793a\u4f8b\uff0c\u65e5\u8a8c\u6d88\u606f\u5305\u542b\u6709\u95dc\u670d\u52d9\u7684\u6240\u6709\u8acb\u6c42\u3001\u932f\u8aa4\u548c\u5ef6\u9072\u6642\u9593\u7684\u4fe1\u606f\u3002 [stack-doctor GitHub \u4ee3\u78bc\u5eab](https://github.com/yuriatgoogle/stack-doctor/blob/master/log-based-metrics/slis/slis.js) \u4e2d\u63d0\u4f9b\u4e86\u8a72\u670d\u52d9\u7684\u4ee3\u78bc\u3002\n\u670d\u52d9\u6703\u5728 `projects/stack-doctor/logs/bunyan_log` \u65e5\u8a8c\u4e2d\u751f\u6210 Cloud Logging \u65e5\u8a8c\u689d\u76ee\u3002\u6bcf\u7a2e\u4e8b\u4ef6\u985e\u578b\u7684\u65e5\u8a8c\u689d\u76ee\u90fd\u5305\u542b\u4e0d\u540c\u7684 `message` \u503c\u3002\u4e0d\u540c\u985e\u578b\u7684\u4e8b\u4ef6\u7684\u65e5\u8a8c\u689d\u76ee\u5982\u4e0b\u6240\u793a\uff1a\n- \u91dd\u5c0d\u6bcf\u500b\u8acb\u6c42\uff1a```\n{\u00a0 \"insertId\": \"..........iTRVT5MOK2VOsVe31bzrTD\",\u00a0 \"jsonPayload\": {\u00a0 \u00a0 \"pid\": 81846,\u00a0 \u00a0 \"time\": \"Mon Aug 31 2020 20:30:49 GMT-0700 (Pacific Daylight Time)\",\u00a0 \u00a0 \"hostname\": \"<hostname>\",\u00a0 \u00a0 \"level\": 30,\u00a0 \u00a0 \"message\": \"request made\",\u00a0 \u00a0 \"v\": 0,\u00a0 \u00a0 \"name\": \"sli-log\"\u00a0 },\u00a0 \u00a0 \"resource\": {\u00a0 \u00a0 \"type\": \"global\",\u00a0 \u00a0 \"labels\": {\u00a0 \u00a0 \u00a0 \"project_id\": \"stack-doctor\"\u00a0 \u00a0 }\u00a0 },\u00a0 \"timestamp\": \"2020-09-01T03:30:49.263999938Z\",\u00a0 \"severity\": \"INFO\",\u00a0 \"logName\": \"projects/stack-doctor/logs/bunyan_log\",\u00a0 \"receiveTimestamp\": \"2020-09-01T03:30:50.003471183Z\"}\n```\n- \u91dd\u5c0d\u6210\u529f\u7684\u8acb\u6c42\uff1a```\n{\u00a0 \"insertId\": \"..........qTRVT5MOK2VOsVe31bzrTD\",\u00a0 \"jsonPayload\": {\u00a0 \u00a0 \"name\": \"sli-log\",\u00a0 \u00a0 \"v\": 0,\u00a0 \u00a0 \"pid\": 81846,\u00a0 \u00a0 \"level\": 30,\u00a0 \u00a0 \"hostname\": \"<hostname>\",\u00a0 \u00a0 \"time\": \"Mon Aug 31 2020 20:30:49 GMT-0700 (Pacific Daylight Time)\",\u00a0 \u00a0 \"message\": \"success!\"\u00a0 },\u00a0 \"resource\": {\u00a0 \u00a0 \"type\": \"global\",\u00a0 \u00a0 \"labels\": {\u00a0 \u00a0 \u00a0 \"project_id\": \"stack-doctor\"\u00a0 \u00a0 }\u00a0 },\u00a0 \"timestamp\": \"2020-09-01T03:30:49.874000072Z\",\u00a0 \"severity\": \"INFO\",\u00a0 \"logName\": \"projects/stack-doctor/logs/bunyan_log\",\u00a0 \"receiveTimestamp\": \"2020-09-01T03:30:50.201547371Z\"}\n```\n- \u91dd\u5c0d\u5df2\u5b8c\u6210\u7684\u8acb\u6c42\uff1a```\n{\u00a0 \"insertId\": \"..........mTRVT5MOK2VOsVe31bzrTD\",\u00a0 \"jsonPayload\": {\u00a0 \u00a0 \"time\": \"Mon Aug 31 2020 20:30:49 GMT-0700 (Pacific Daylight Time)\",\u00a0 \u00a0 \"level\": 30,\u00a0 \u00a0 \"name\": \"sli-log\",\u00a0 \u00a0 \"message\": \"slept for 606 ms\",\u00a0 \u00a0 \"hostname\": \"<hostname>\",\u00a0 \u00a0 \"pid\": 81846,\u00a0 \u00a0 \"v\": 0\u00a0 },\u00a0 \"resource\": {\u00a0 \u00a0 \"type\": \"global\",\u00a0 \u00a0 \"labels\": {\u00a0 \u00a0 \u00a0 \"project_id\": \"stack-doctor\"\u00a0 \u00a0 }\u00a0 },\u00a0 \"timestamp\": \"2020-09-01T03:30:49.874000072Z\",\u00a0 \"severity\": \"INFO\",\u00a0 \"logName\": \"projects/stack-doctor/logs/bunyan_log\",\u00a0 \"receiveTimestamp\": \"2020-09-01T03:30:50.201547371Z\"}\n```\n- \u91dd\u5c0d\u932f\u8aa4\uff1a```\n{\u00a0 \"insertId\": \"..........DTRVT5MOK2VOsVe31bzrTD\",\u00a0 \"jsonPayload\": {\u00a0 \u00a0 \"hostname\": \"<hostname>\",\u00a0 \u00a0 \"level\": 50,\u00a0 \u00a0 \"pid\": 81846,\u00a0 \u00a0 \"message\": \"failure!\",\u00a0 \u00a0 \"name\": \"sli-log\",\u00a0 \u00a0 \"time\": \"Mon Aug 31 2020 20:30:44 GMT-0700 (Pacific Daylight Time)\",\u00a0 \u00a0 \"v\": 0\u00a0 },\u00a0 \"resource\": {\u00a0 \u00a0 \"type\": \"global\",\u00a0 \u00a0 \"labels\": {\u00a0 \u00a0 \u00a0 \"project_id\": \"stack-doctor\"\u00a0 \u00a0 }\u00a0 },\u00a0 \"timestamp\": \"2020-09-01T03:30:44.414999961Z\",\u00a0 \"severity\": \"ERROR\",\u00a0 \"logName\": \"projects/stack-doctor/logs/bunyan_log\",\u00a0 \"receiveTimestamp\": \"2020-09-01T03:30:46.182157077Z\"}\n```\n\u6839\u64da\u9019\u4e9b\u689d\u76ee\uff0c\u60a8\u53ef\u4ee5\u5275\u5efa\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19\uff0c\u4ee5\u7d71\u8a08\u6240\u6709\u8acb\u6c42\u6578\u3001\u7d71\u8a08\u932f\u8aa4\u6578\u4e26\u8ddf\u8e64\u8acb\u6c42\u5ef6\u9072\u6642\u9593\u3002\u7136\u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19\u4f86\u5275\u5efa\u53ef\u7528\u6027\u548c\u5ef6\u9072\u6642\u9593 SLI\u3002\n## \u7232 SLI \u5275\u5efa\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19\u3002\n\u60a8\u5fc5\u9808\u5148\u5275\u5efa\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19\uff0c\u7136\u5f8c\u624d\u80fd\u6839\u64da\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19\u5275\u5efa SLI\u3002\n- \u5c0d\u65bc\u91dd\u5c0d\u8acb\u6c42\u548c\u932f\u8aa4\u8a08\u6578\u7684\u53ef\u7528\u6027 SLI\uff0c\u53ef\u4ee5\u4f7f\u7528\u57fa\u65bc\u65e5\u8a8c\u7684\u8a08\u6578\u5668\u6307\u6a19\u3002\n- \u5c0d\u65bc\u5ef6\u9072\u6642\u9593 SLI\uff0c\u53ef\u4ee5\u4f7f\u7528\u57fa\u65bc\u65e5\u8a8c\u7684\u5206\u4f48\u6307\u6a19\u3002\n\u5275\u5efa\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5728 Metrics Explorer \u4e2d\u641c\u7d22\u9019\u4e9b\u6307\u6a19\uff0c\u5f9e\u800c\u5728 Monitoring \u4e2d\u627e\u5230\u9019\u4e9b\u6307\u6a19\u3002\u5728 Monitoring \u4e2d\uff0c\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19\u7684\u524d\u7db4\u7232 `logging.googleapis.com/user` \u3002\n**\u6ce8\u610f** \uff1a\u4ee5\u4e0b\u793a\u4f8b\u6703\u91dd\u5c0d `global` \u53d7\u76e3\u63a7\u7684\u8cc7\u6e90\u5275\u5efa\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19\uff0c\u901a\u5e38\u4e0d\u5efa\u8b70\u9019\u6a23\u505a\u3002\u5c0d\u65bc\u5be6\u969b\u90e8\u7f72\uff0c\u8acb\u8b39\u614e\u91dd\u5c0d\u73fe\u6709\u53d7\u76e3\u63a7\u7684\u8cc7\u6e90\u767c\u51fa\u65e5\u8a8c\u3002\n### \u53ef\u7528\u6027 SLI \u7684\u6307\u6a19\n\u60a8\u53ef\u4ee5\u901a\u904e\u4f7f\u7528 [TimeSeriesRatio](https://cloud.google.com/monitoring/api/ref_v3/rest/v3/services.serviceLevelObjectives?hl=zh-cn#TimeSeriesRatio) \u7d50\u69cb\u8a2d\u7f6e\u201c\u6b63\u5e38\u201d\u6216\u201c\u932f\u8aa4\u201d\u8acb\u6c42\u6578\u8207\u8acb\u6c42\u7e3d\u6578\u7684\u6bd4\u7387\uff0c\u5728 Cloud Monitoring API \u4e2d\u8868\u793a\u57fa\u65bc\u8acb\u6c42\u7684\u53ef\u7528\u6027 SLI\u3002\u6b64\u6bd4\u7387\u7528\u65bc [RequestBasedSli](https://cloud.google.com/monitoring/api/ref_v3/rest/v3/services.serviceLevelObjectives?hl=zh-cn#RequestBasedSli) \u7d50\u69cb\u7684 `goodTotalRatio` \u5b57\u6bb5\u3002\n\u60a8\u5fc5\u9808\u5275\u5efa\u53ef\u7528\u65bc\u69cb\u9020\u6b64\u6bd4\u7387\u7684\u57fa\u65bc\u65e5\u8a8c\u7684\u8a08\u6578\u5668\u6307\u6a19\u3002\u60a8\u5fc5\u9808\u81f3\u5c11\u5275\u5efa\u4ee5\u4e0b\u6307\u6a19\u4e2d\u7684\u5169\u500b\uff1a\n- \u7d71\u8a08\u4e8b\u4ef6\u7e3d\u6578\u7684\u6307\u6a19\uff1b\u6b64\u6307\u6a19\u7528\u65bc\u6bd4\u7387\u7684 `totalServiceFilter` \u3002\u5c0d\u65bc\u201cstack-doctor\u201d\u793a\u4f8b\uff0c\u60a8\u53ef\u4ee5\u5275\u5efa\u4e00\u500b\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19\uff0c\u7528\u65bc\u7d71\u8a08\u5728\u5176\u4e2d\u986f\u793a\u201c\u767c\u51fa\u7684\u8acb\u6c42\u201d\u6d88\u606f\u5b57\u7b26\u4e32\u7684\u65e5\u8a8c\u689d\u76ee\u6578\u3002\n- \u7d71\u8a08\u201c\u932f\u8aa4\u201d\u4e8b\u4ef6\u6578\u7684\u6307\u6a19\uff0c\u6b64\u6307\u6a19\u7528\u65bc\u6bd4\u7387\u7684 `badServiceFilter` \u3002\u5c0d\u65bc\u201cstack-doctor\u201d\u793a\u4f8b\uff0c\u60a8\u53ef\u4ee5\u5275\u5efa\u4e00\u500b\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19\uff0c\u7528\u65bc\u7d71\u8a08\u5728\u5176\u4e2d\u986f\u793a\u201c\u5931\u6557\uff01\u201d\u6d88\u606f\u5b57\u7b26\u4e32\u7684\u65e5\u8a8c\u689d\u76ee\u6578\u3002\n- \u7d71\u8a08\u201c\u6b63\u5e38\u201d\u4e8b\u4ef6\u6578\u7684\u6307\u6a19\uff0c\u6b64\u6307\u6a19\u7528\u65bc\u6bd4\u7387\u7684 `goodServiceFilter` \u3002\u5c0d\u65bc\u201cstack-doctor\u201d\u793a\u4f8b\uff0c\u60a8\u53ef\u4ee5\u5275\u5efa\u4e00\u500b\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19\uff0c\u7528\u65bc\u7d71\u8a08\u5728\u5176\u4e2d\u986f\u793a\u201c\u6210\u529f\uff01\u201d\u6d88\u606f\u5b57\u7b26\u4e32\u7684\u65e5\u8a8c\u689d\u76ee\u6578\u3002\n\u91dd\u5c0d\u8a72\u793a\u4f8b\u6240\u8ff0\u7684 SLI \u57fa\u65bc\u540d\u7232 `log_based_total_requests` \u7684\u8acb\u6c42\u7e3d\u6578\u7684\u6307\u6a19\u548c\u540d\u7232 `log_based_errors` \u7684\u932f\u8aa4\u6578\u7684\u6307\u6a19\u3002\n\u60a8\u53ef\u4ee5\u4f7f\u7528 Google Cloud Console\u3001Cloud Logging API \u6216 Google Cloud CLI \u5275\u5efa\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19\u3002\u5982\u9700\u4f7f\u7528 Google Cloud \u63a7\u5236\u6aaf\u5275\u5efa\u57fa\u65bc\u65e5\u8a8c\u7684\u8a08\u6578\u5668\u6307\u6a19\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u904e\u7a0b\uff1a\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5c0e\u822a\u9762\u677f\u4e2d\uff0c\u9078\u64c7 **Logging** \uff0c\u7136\u5f8c\u9078\u64c7 **\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19** \uff1a [\u524d\u5f80\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19](https://console.cloud.google.com/logs/metrics?hl=zh-cn) \u201c\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19\u201d\u9801\u9762\u986f\u793a\u4e86\u7528\u6236\u5b9a\u7fa9\u7684\u6307\u6a19\u8868\u548c\u7cfb\u7d71\u5b9a\u7fa9\u7684\u6307\u6a19\u8868\u3002\n- \u9ede\u64ca\u4f4d\u65bc\u7528\u6236\u5b9a\u7fa9\u7684\u6307\u6a19\u8868\u4e0a\u65b9\u7684 **\u5275\u5efa\u6307\u6a19** \u3002\n- \u5728 **\u6307\u6a19\u985e\u578b** \u7a97\u683c\u4e2d\uff0c\u9078\u64c7 **\u8a08\u6578\u5668** \u3002\n- \u5728 **\u8a73\u7d30\u4fe1\u606f** \u7a97\u683c\u4e2d\uff0c\u7232\u65b0\u6307\u6a19\u6307\u5b9a\u540d\u7a31\u3002\u5c0d\u65bc\u201cstack-doctor\u201d\u793a\u4f8b\uff0c\u8f38\u5165 `log_based_total_requests` \u6216 `log_based_errors` \u3002\u60a8\u53ef\u4ee5\u5ffd\u7565\u6b64\u793a\u4f8b\u7684\u5176\u4ed6\u5b57\u6bb5\u3002\n- \u5728 **\u904e\u6ffe\u689d\u4ef6\u9078\u64c7** \u9762\u677f\u4e2d\uff0c\u5275\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u4ee5\u50c5\u6aa2\u7d22\u8981\u5728\u6307\u6a19\u4e2d\u8a08\u6578\u7684\u65e5\u8a8c\u689d\u76ee\u3002\u5c0d\u65bc\u201cstack-doctor\u201d\u793a\u4f8b\uff0c\u91dd\u5c0d `log_based_total_requests` \u7684\u67e5\u8a62\u53ef\u80fd\u5305\u542b\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nresource.type=\"global\"\nlogName=\"projects/stack-doctor/logs/bunyan_log\"\njsonPayload.message=\"request made\"\n```\u91dd\u5c0d `logs_based_errors` \u7684\u67e5\u8a62\u6703\u66f4\u6539\u6d88\u606f\u5b57\u7b26\u4e32\uff1a```\nresource.type=\"global\"\nlogName=\"projects/stack-doctor/logs/bunyan_log\"\njsonPayload.message=\"failure!\"\n```\n- \u9ede\u64ca **\u9810\u89bd\u65e5\u8a8c** \u4ee5\u6aa2\u67e5\u60a8\u7684\u904e\u6ffe\u689d\u4ef6\uff0c\u4e26\u5728\u5fc5\u8981\u6642\u9032\u884c\u8abf\u6574\u3002\n- \u5ffd\u7565\u6b64\u793a\u4f8b\u7684 **\u6a19\u7c64** \u7a97\u683c\u3002\n- \u9ede\u64ca **\u5275\u5efa\u6307\u6a19** \u4ee5\u5b8c\u6210\u8a72\u904e\u7a0b\u3002\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u5275\u5efa\u57fa\u65bc\u65e5\u8a8c\u7684\u8a08\u6578\u5668\u6307\u6a19\uff0c\u8acb\u53c3\u95b1 [\u5275\u5efa\u8a08\u6578\u5668\u6307\u6a19](https://cloud.google.com/logging/docs/logs-based-metrics/counter-metrics?hl=zh-cn#creating_a_counter_metric) \u3002\n### \u5ef6\u9072\u6642\u9593 SLI \u7684\u6307\u6a19\n\u60a8\u53ef\u4ee5\u4f7f\u7528 [DistributionCut](https://cloud.google.com/monitoring/api/ref_v3/rest/v3/services.serviceLevelObjectives?hl=zh-cn#DistributionCut) \u7d50\u69cb\u5728 Cloud Monitoring API \u4e2d\u8868\u793a\u57fa\u65bc\u8acb\u6c42\u7684\u5ef6\u9072\u6642\u9593 SLI\uff0c\u8a72 SLI \u7528\u65bc [RequestBasedSli](https://cloud.google.com/monitoring/api/ref_v3/rest/v3/services.serviceLevelObjectives?hl=zh-cn#RequestBasedSli) \u7d50\u69cb\u7684 `distributionCut` \u5b57\u6bb5\u3002\u60a8\u5fc5\u9808\u5275\u5efa\u57fa\u65bc\u65e5\u8a8c\u7684\u5206\u4f48\u6307\u6a19\u624d\u80fd\u5275\u5efa\u5ef6\u9072\u6642\u9593 SLI\u3002\u6b64\u793a\u4f8b\u6703\u5275\u5efa\u4e00\u500b\u540d\u7232 `log_based_latency.` \u7684\u57fa\u65bc\u65e5\u8a8c\u7684\u5206\u4f48\u6307\u6a19\n\u60a8\u53ef\u4ee5\u4f7f\u7528 Google Cloud Console\u3001Cloud Logging API \u6216 Google Cloud CLI \u5275\u5efa\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19\u3002\u5982\u9700\u4f7f\u7528 Google Cloud \u63a7\u5236\u6aaf\u5275\u5efa\u57fa\u65bc\u65e5\u8a8c\u7684\u5206\u4f48\u6307\u6a19\uff0c\u8acb\u6309\u7167\u4ee5\u4e0b\u6b65\u9a5f\u64cd\u4f5c\uff1a\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5c0e\u822a\u9762\u677f\u4e2d\uff0c\u9078\u64c7 **Logging** \uff0c\u7136\u5f8c\u9078\u64c7 **\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19** \uff1a [\u524d\u5f80\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19](https://console.cloud.google.com/logs/metrics?hl=zh-cn) \u201c\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19\u201d\u9801\u9762\u986f\u793a\u4e86\u7528\u6236\u5b9a\u7fa9\u7684\u6307\u6a19\u8868\u548c\u7cfb\u7d71\u5b9a\u7fa9\u7684\u6307\u6a19\u8868\u3002\n- \u9ede\u64ca\u4f4d\u65bc\u7528\u6236\u5b9a\u7fa9\u7684\u6307\u6a19\u8868\u4e0a\u65b9\u7684 **\u5275\u5efa\u6307\u6a19** \u3002\n- \u5728 **\u6307\u6a19\u985e\u578b** \u7a97\u683c\u4e2d\uff0c\u9078\u64c7 **\u5206\u4f48** \u3002\n- \u5728 **\u8a73\u7d30\u4fe1\u606f** \u7a97\u683c\u4e2d\uff0c\u7232\u65b0\u6307\u6a19\u6307\u5b9a\u540d\u7a31\u3002\u5c0d\u65bc\u201cstack-doctor\u201d\u793a\u4f8b\uff0c\u8f38\u5165 `log_based_latency` \u3002\u60a8\u53ef\u4ee5\u5ffd\u7565\u6b64\u793a\u4f8b\u7684\u5176\u4ed6\u5b57\u6bb5\u3002\n- \u5728 **\u904e\u6ffe\u689d\u4ef6\u9078\u64c7** \u9762\u677f\u4e2d\uff0c\u5275\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u4ee5\u50c5\u6aa2\u7d22\u8981\u5728\u6307\u6a19\u4e2d\u8a08\u6578\u7684\u65e5\u8a8c\u689d\u76ee\u3002\u5c0d\u65bc\u201cstack-doctor\u201d\u793a\u4f8b\uff0c\u91dd\u5c0d `log_based_latency` \u7684\u67e5\u8a62\u53ef\u80fd\u5305\u542b\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nresource.type=\"global\"\nlogName=\"projects/stack-doctor/logs/bunyan_log\"\njsonPayload.message=\"slept for\"\n```\u7232\u904e\u6ffe\u689d\u4ef6\u67e5\u8a62\u6307\u5b9a\u4ee5\u4e0b\u5b57\u6bb5\uff1a- **\u5b57\u6bb5\u540d\u7a31** \uff1a`json.message`\n- **\u6b63\u5247\u8868\u9054\u5f0f** \uff1a `\\s(\\d*)\\s`\u5df2\u5b8c\u6210\u8acb\u6c42\u7684\u6d88\u606f\u5b57\u7b26\u4e32\u7684\u683c\u5f0f\u7232\u201c\u5df2\u4f11\u7720 n \u6beb\u79d2\u201d\u3002\u6b63\u5247\u8868\u9054\u5f0f\u5f9e\u5b57\u7b26\u4e32\u4e2d\u63d0\u53d6\u5ef6\u9072\u6642\u9593\u503c n \u3002\n- \u5ffd\u7565\u6b64\u793a\u4f8b\u7684 **\u6a19\u7c64** \u7a97\u683c\u3002\n- \u9ede\u64ca **\u5275\u5efa\u6307\u6a19** \u4ee5\u5b8c\u6210\u8a72\u904e\u7a0b\u3002\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u5275\u5efa\u57fa\u65bc\u65e5\u8a8c\u7684\u5206\u4f48\u6307\u6a19\uff0c\u8acb\u53c3\u95b1 [\u5275\u5efa\u5206\u4f48\u6307\u6a19](https://cloud.google.com/logging/docs/logs-based-metrics/distribution-metrics?hl=zh-cn) \u3002\n## \u53ef\u7528\u6027 SLI\n\u5728 Cloud Monitoring \u4e2d\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u4f7f\u7528 [TimeSeriesRatio](https://cloud.google.com/monitoring/api/ref_v3/rest/v3/services.serviceLevelObjectives?hl=zh-cn#TimeSeriesRatio) \u7d50\u69cb\u4f86\u8868\u793a\u57fa\u65bc\u8acb\u6c42\u7684\u53ef\u7528\u6027 SLI\u3002\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u4e86\u4e00\u500b\u5728\u6bd4\u7387\u4e2d\u4f7f\u7528 `log_based_total_requests` \u548c `log_based_errors` \u6307\u6a19\u7684 SLO\u3002\u6b64 SLO \u9810\u8a08\u5728\u4e00\u500b\u6efe\u52d5\u7684 24 \u5c0f\u6642\u9031\u671f\u5167\uff0c\u6b63\u5e38\u8acb\u6c42\u6578\u8207\u8acb\u6c42\u7e3d\u6578\u7684\u6bd4\u7387\u81f3\u5c11\u7232 98%\u3002\n```\n{\u00a0\"serviceLevelIndicator\": {\u00a0 \u00a0\"requestBased\": {\u00a0 \u00a0 \u00a0\"goodTotalRatio\": {\u00a0 \u00a0 \u00a0 \u00a0\"totalServiceFilter\":\u00a0 \u00a0 \u00a0 \u00a0 \u00a0\"metric.type=\\\"logging.googleapis.com/user/log_based_total_requests\\\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 resource.type=\\\"global\\\"\",\u00a0 \u00a0 \u00a0 \u00a0\"badServiceFilter\":\u00a0 \u00a0 \u00a0 \u00a0 \u00a0\"metric.type=\\\"logging.googleapis.com/user/log_based_errors\\\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 resource.type=\\\"global\\\"\"\u00a0 \u00a0 \u00a0}\u00a0 \u00a0}\u00a0},\u00a0\"goal\": 0.98,\u00a0\"rollingPeriod\": \"86400s\",\u00a0\"displayName\": \"Log-Based Availability\"}\n```\n## \u5ef6\u9072\u6642\u9593 SLI\n\u5728 Cloud Monitoring \u4e2d\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u4f7f\u7528 [DistributionCut](https://cloud.google.com/monitoring/api/ref_v3/rest/v3/services.serviceLevelObjectives?hl=zh-cn#DistributionCut) \u7d50\u69cb\u4f86\u8868\u793a\u57fa\u65bc\u8acb\u6c42\u7684\u5ef6\u9072\u6642\u9593 SLI\u3002\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u4e86\u4e00\u500b SLO\uff0c\u8a72 SLO \u4f7f\u7528 `log_based_latency` \u6307\u6a19\uff0c\u4e26\u9810\u8a08\u5728\u4e00\u500b\u6efe\u52d5\u7684 24 \u5c0f\u6642\u9031\u671f\u5167 98% \u7684\u8acb\u6c42\u5728 500 \u6beb\u79d2\u5167\u5b8c\u6210\uff1a\n```\n{\u00a0 \"serviceLevelIndicator\": {\u00a0 \u00a0 \"requestBased\": {\u00a0 \u00a0 \u00a0 \"distributionCut\": {\u00a0 \u00a0 \u00a0 \u00a0 \"distributionFilter\":\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"metric.type=\\\"logging.googleapis.com/user/log_based_latency\\\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 resource.type=\\\"global\\\"\",\u00a0 \u00a0 \u00a0 \u00a0 \"range\": {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"min\": 0,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"max\": 500\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 }\u00a0 },\u00a0 \"goal\": 0.98,\u00a0 \"rollingPeriod\": \"86400s\",\u00a0 \"displayName\": \"98% requests under 500 ms\"}\n```\n## \u5176\u4ed6\u8cc7\u6e90\n- [\u60a8\u53ef\u4ee5\u91dd\u5c0d Stackdriver \u4e2d\u7684\u65e5\u8a8c\u767c\u51fa\u63d0\u9192\u55ce\uff1f| \u4f5c\u8005 Yuri Grinshteyn | Google Cloud - \u793e\u5340](https://medium.com/google-cloud/can-you-alert-on-logs-in-stackdriver-7dfb07f495c0) \n- [\u5275\u5efa\u5716\u8868\u548c\u63d0\u9192 | Cloud Logging](https://cloud.google.com/logging/docs/logs-based-metrics/charts-and-alerts?hl=zh-cn) \n- [\u4f7f\u7528\u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19\u767c\u6398\u65e5\u8a8c\u7684\u50f9\u503c](https://cloud.google.com/blog/products/gcp/extracting-value-from-your-logs-with-stackdriver-logs-based-metrics?hl=zh-cn)", "guide": "Google Cloud Observability"}