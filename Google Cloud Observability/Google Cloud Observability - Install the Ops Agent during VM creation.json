{"title": "Google Cloud Observability - Install the Ops Agent during VM creation", "url": "https://cloud.google.com/stackdriver/docs/solutions/agents/ops-agent/install-agent-vm-creation", "abstract": "# Google Cloud Observability - Install the Ops Agent during VM creation\nThis document describes how the Google Cloud console can automatically install the Ops Agent for you when you create a VM instance. During the installation process, the Compute Engine [VM Manager](/compute/docs/vm-manager) creates an Ops Agent OS policy that installs the agent and reinstalls it when necessary. The VM Manager helps you get the Ops Agent running on your VM and ensures that the agent is always installed.\n", "content": "## Overview\nThe VM Manager uses OS configuration policies to manage the Ops Agent installation. A configuration policy is applied to a VM by using a mapping called an assignment ID, which looks like the following example:\n```\ngoog-ops-agent-v2-x86-template-1-0-0-ZONE\n```\nAn assignment ID for an Ops Agent OS policy consists of the following components:\n- The name of the policy: \"goog-ops-agent\"\n- A template for creating the policy: \"v2-x86-template\"\n- A version string for the template. The version, which might change over time, is a value like \"\".\n- The zone to which the assignment ID applies, a value like \"us-central1-a\".\nA VM is associated with an assignment ID by using the labels on the VM instance. A Compute Engine VM is a monitored resource of type [gce_instance](/monitoring/api/resources#tag_gce_instance) and includes a `zone` label. When you use the Google Cloud console to create a VM with the Ops Agent installed, the VM Manager adds another label to the VM, which looks like `goog-ops-agent-policy:v2-x86-template-` `` . This label identifies the policy, template, and version:\n- Label key, the identifier for the policy:`goog-ops-agent-policy`\n- Label value, the policy template and version:`v2-x86-template-` ``\nWhen you create a VM in the Google Cloud console, you can select the **Install Ops Agent for Monitoring and Logging** checkbox. When you click **Create** , VM Manager assigns the VM a label of `goog-ops-agent-policy:v2-x86-template-` `` and installs the Ops Agent. If the VM is the first VM in its zone, then VM Manager also creates an Ops Agent OS policy and an Ops Agent OS policy assignment for that zone.\nWhile a zone has an Ops Agent OS policy assignment, the Ops Agent OS policy monitors VMs that have the following characteristics:\n- The VM has the`goog-ops-agent-policy:v2-x86-template-` ``label.\n- The VM is in the same zone as the Ops Agent OS policy assignment.\nThe Ops Agent OS policy checks every hour whether its covered VMs have the Ops Agent installed. If the Ops Agent isn't installed, then the Ops Agent OS policy installs the latest version of the agent.\n## Create a VM with automatic installation of the Ops Agent\nTo install the Ops Agent automatically during VM creation and apply the Ops Agent OS policy assignment to the VM, do the following:\n- Grant roles to your Google Account. Run the following command once for each of the following   IAM roles: `roles/osconfig.osPolicyAssignmentEditor` ```\ngcloud projects add-iam-policy-binding PROJECT_ID --member=\"user:EMAIL_ADDRESS\" --role=ROLE\n```- Replace``with your project ID.\n- Replace``with your email address.\n- Replace``with each individual role.\n- Follow the steps in [Create a VM instance from a public image](/compute/docs/instances/create-start-instance#publicimage) .  Before you click **Create** , select the **Install Ops Agent for Monitoring and Logging** checkbox:\n- Click **Create** .When you install the Ops Agent automatically for the first time in a zone, if you don't have VM Manager enabled for your Google Cloud project, then the VM-creation process does the following:- Enables VM Manager to operate in [restricted mode](/compute/docs/vm-manager#pricing) .\n- Creates the Ops Agent OS policy and an Ops Agent OS policy assignment   for the zone. The Ops Agent OS policy is a field of the policy   assignment.\n- Enables OS patch, OS configuration, and OS inventory management by   by setting the VM metadata label`enable-osconfig`to`TRUE`.\n- Creates the VM and assigns it the Ops Agent OS policy label.\nIf you create a VM and automatically install the Ops Agent in a zone where an Ops Agent OS policy assignment already exists, then the VM-creation process creates the VM and assigns it the Ops Agent OS policy label.\n## Example\nYour Google Cloud project doesn't have any Ops Agent OS policy assignments. You create two VMs, and in the `us-central1-a` zone. You then create and in the `us-east1-b` zone. , , and had the **Install Ops Agent for Monitoring and Logging** checkbox selected during creation.\n- When you create, VM Manager creates an Ops Agent OS policy for the`us-central1-a`zone and an OS policy assignment with the ID`goog-ops-agent-v2-x86-template-` `` `-us-central1-a`. VM Manager then sets the policy label on.\n- When you create, VM Manager sets the same policy label on.\n- When you create, VM Manager creates an Ops Agent OS policy for the`us-east1-b`zone and an OS policy assignment with the ID`goog-ops-agent-v2-x86-template-` `` `-us-east1-b`. VM Manager then assigns the policy label to.\nThe Ops Agent OS policies then cover the following VMs based on the Ops Agent OS policy assignment IDs:\n| OS Policy Assignment ID       | Covers VMs In: | Covered VMs   |\n|:---------------------------------------------------|:-----------------|:-----------------------|\n| goog-ops-agent-v2-x86-template-1-0-0-us-central1-a | us-central1-a | instance-1, instance-2 |\n| goog-ops-agent-v2-x86-template-1-0-0-us-east1-b | us-east1-b  | instance-3    |\nBy default, isn't covered because you didn't select **Install Ops Agent for Monitoring and Logging** , so it doesn't have the `goog-ops-agent-policy:v2-x86-template-` `` label. If you also want to apply the Ops Agent OS policy to , then see [Add Ops Agent OS policy coverage to an existing VM](/stackdriver/docs/solutions/agents/ops-agent/manage-policies-auto-install#add-coverage) .\n## Manage Ops Agent versions on VMs covered by the Ops Agent OS policy\nThe Ops Agent OS policy doesn't update the Ops Agent when new versions of the agent are released. As long as the VM has some version of the Ops Agent installed, the policy does nothing. If you uninstall the Ops Agent, then the policy detects that the Ops Agent isn't installed and then installs the latest version.\nTo upgrade your VM to the latest version of the Ops Agent, uninstall the version that you are currently running and let the Ops Agent OS policy install the latest version.\nIf you need to install a previous version of the Ops Agent, you can [uninstall the Ops Agent on VMs covered by the Ops Agent OS policy](/stackdriver/docs/solutions/agents/ops-agent/manage-policies-auto-install#uninstall) and then [install a specific version of the agent](/stackdriver/docs/solutions/agents/ops-agent/installation#install-specific-version) .\n## Troubleshooting\nFor information about troubleshooting agent installation and Ops Agent OS policies, see [Manage VMs covered by the Ops Agent OS policy](/stackdriver/docs/solutions/agents/ops-agent/manage-policies-auto-install) and [Agent diagnostics tool for automatic installation policies](/stackdriver/docs/solutions/agents/ops-agent/troubleshoot-find-info#agent_diagnostics_tool_for_automatic_installation_policies) .\n## Pricing\nOS policies are generic tools for installing packages. By default, when VM Manager is enabled because you've created a VM with the Ops Agent automatically installed, VM Manager is enabled in the limited mode. For information about VM Manager modes and pricing, see [VM Manager Pricing](/compute/docs/vm-manager#pricing) .\n## What's next\nFor information about managing VMs covered by the Ops Agent OS policy, see [Manage VMs covered by the Ops Agent OS policy](/stackdriver/docs/solutions/agents/ops-agent/manage-policies-auto-install) .", "guide": "Google Cloud Observability"}