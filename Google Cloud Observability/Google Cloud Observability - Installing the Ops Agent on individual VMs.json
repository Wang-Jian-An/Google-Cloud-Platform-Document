{"title": "Google Cloud Observability - Installing the Ops Agent on individual VMs", "url": "https://cloud.google.com/stackdriver/docs/solutions/agents/ops-agent/installation", "abstract": "# Google Cloud Observability - Installing the Ops Agent on individual VMs\n**Key Point:** Now you can install all of the Google Cloud Observability agents across your entire fleet of Compute Engine Linux VMs in a single step. With one command, you can create a policy that governs new and existing VMs, ensuring proper installation and optional auto-upgrade of the agents. For more information, refer to the [Managing AgentPolicies](/stackdriver/docs/solutions/agents/ops-agent/managing-agent-policies) guide.\nThe Ops Agent collects logs and metrics on Compute Engine instances, sending your logs to Cloud Logging and your metrics to Cloud Monitoring.\n", "content": "## Before you begin\nTo install the agent, ensure that you have the following:\n- A [supported VM instance](/stackdriver/docs/solutions/agents/ops-agent#supported_vms) in a Google Cloud project.\n- A [supported operating system](/stackdriver/docs/solutions/agents/ops-agent#supported_operating_systems) .\n- Credentials on the VM instance that authorize communication with Cloud Logging and Cloud Monitoring. Compute Engine VM instances generally have the correct credentials by default. If you are running very old Compute Engine instances or if you created Compute Engine instances without the default credentials, then you might not have the proper credentials. You must complete the [Authorize the Ops Agent](/stackdriver/docs/solutions/agents/ops-agent/authorization) procedures.\n- Ensure that you [enable the services](/service-usage/docs/enable-disable) for both the Cloud Logging API and Cloud Monitoring API.\n- Ensure your VM doesn't have the legacy [Cloud Loggingagent](/logging/docs/agent) or [Cloud Monitoring agent](/monitoring/agent) installed on it. This can cause ingestion of duplicate logs or a conflict in metrics ingestion. In addition, this agent uses new configuration files that are not compatible with the old agents.If you have the old agents installed, save the [custom configuration files forthe Cloud Monitoring agent](/monitoring/agent/custom-metrics-agent#agent-artifacts) and the [custom configuration files for the Cloud Loggingagent](/logging/docs/agent/logging/configuration#configure) , and complete the [uninstall steps for the Cloud Monitoringagent](/monitoring/agent/monitoring/installation#uninstall) and the [uninstall steps forthe Cloud Logging agent](/logging/docs/agent/logging/installation#uninstall) .\n- For users with VMs that don't have access to remote package repositories, refer to the [VMs without remote package access](#remote_package_access) section for more information.## Installing the agent automatically during VM creation\nFor more information, see [Install the Ops Agent during VM creation](/stackdriver/docs/solutions/agents/ops-agent/install-agent-vm-creation) .\n## Installing the agent from the command line\n**Note:** First verify that all conditions are met in the [Before youbegin](#before_you_begin) section.\nTo install the agent using the command line, use the following instructions.\n### Installing the latest version of the agent\nTo install the latest version of the agent, complete the following steps.\n- Open a terminal connection to your VM instance using SSH or a similar tool and ensure you have `sudo` access.\n- Change to a directory you have write access to, for example your home directory.\n- Download and run the agent-installation script by using the following commands:```\ncurl -sSO https://dl.google.com/cloudagents/add-google-cloud-ops-agent-repo.sh\nsudo bash add-google-cloud-ops-agent-repo.sh --also-install\n```After it is installed, the agent is started automatically.\n- Connect to your instance using RDP or a similar tool and login to Windows.\n- Open a PowerShell terminal with administrator privileges by right-clicking the PowerShell icon and selecting **Run as Administrator** .\n- Run the following PowerShell commands:```\n(New-Object Net.WebClient).DownloadFile(\"https://dl.google.com/cloudagents/add-google-cloud-ops-agent-repo.ps1\", \"${env:UserProfile}\\add-google-cloud-ops-agent-repo.ps1\")\nInvoke-Expression \"${env:UserProfile}\\add-google-cloud-ops-agent-repo.ps1 -AlsoInstall\"\n```\n### Installing a specific version of the agent\nTo install a specific version of the agent, complete the following steps.\n- Open a terminal connection to your VM instance using SSH or a similar tool and ensure you have `sudo` access.\n- Change to a directory you have write access to, for example your home directory.\n- Download the agent installation script:```\ncurl -sSO https://dl.google.com/cloudagents/add-google-cloud-ops-agent-repo.sh\n```When running the `add-google-cloud-ops-agent-repo.sh` script, you can also set the following flags:- `--verbose`: Turns on verbose logging during the script execution.\n- `--also-install`: Installs the agent after adding the agent package repository.\n- `--version`: Sets the agent version for the script to install.\n- `--uninstall`: Uninstalls the agent.\n- `--remove-repo`: Removes the corresponding agent package repository after installing or uninstalling the agent.\n- `--dry-run`: Triggers only a dry run of the script execution and prints out the commands that it is supposed to execute.\n- `--uninstall-standalone-logging-agent`: Uninstalls the legacy Logging agent (`StackdriverLogging`).\n- `--uninstall-standalone-monitoring-agent`: Uninstalls the legacy Monitoring agent (`StackdriverMonitoring`).\nSee the script comments for more information and example usage.\n- Add the agent's package repository and install the agent:- To list the available agent versions in order to select which version to install, refer to [Listing all agent versions](#list-versions) .\n- For production environments, you might want to pin to a major version to avoid installing major versions that might include backward incompatible changes. To pin to a major version, run:```\nsudo bash add-google-cloud-ops-agent-repo.sh --also-install \\\n --version=MAJOR_VERSION.*.*\n```For example, to pin to the 1.x.x of the agent, run:```\nsudo bash add-google-cloud-ops-agent-repo.sh --also-install \\\n --version=1.*.*\n```\n- To install a specific version of the agent, run:```\nsudo bash add-google-cloud-ops-agent-repo.sh --also-install \\\n --version=MAJOR_VERSION.MINOR_VERSION.PATCH_VERSION\n```\nYou can delete the installation script after it runs successfully.- To verify that the agent is working as expected, run:```\nsudo systemctl status google-cloud-ops-agent\"*\"\n```Verify that the components \"Logging Agent\" and \"Metrics Agent\" are running.\nIf you have trouble with the installation, refer to the [Troubleshooting](/stackdriver/docs/solutions/agents/ops-agent/troubleshooting) page.- Connect to your instance using RDP or a similar tool and login to Windows.\n- Open a PowerShell terminal with administrator privileges by right-clicking the PowerShell icon and selecting **Run as Administrator** .\n- Download the agent installation script:```\n(New-Object Net.WebClient).DownloadFile(\"https://dl.google.com/cloudagents/add-google-cloud-ops-agent-repo.ps1\", \"${env:UserProfile}\\add-google-cloud-ops-agent-repo.ps1\")\n```When running the `add-google-cloud-ops-agent-repo.ps1` script, you can also set the following flags:- `-Verbose`: Turns on verbose logging during the script execution.\n- `-AlsoInstall`: Installs the agent after adding the agent package repository.\n- `-Version`: Sets the agent version for the script to install.\n- `-Uninstall`: Uninstalls the agent.\n- `-RemoveRepo`: Removes the corresponding agent package repository after installing or uninstalling the agent.\n- `-WhatIf`: Triggers only a dry run of the script execution and prints out the commands that it is supposed to execute.\n- `-UninstallStandaloneLoggingAgent`: Uninstalls the legacy Logging agent (`StackdriverLogging`).\n- `-UninstallStandaloneMonitoringAgent`: Uninstalls the legacy Monitoring agent (`StackdriverMonitoring`).\nSee the script comments for more information and example usage.\n- Add the agent's package repository and install the agent:- To list the available agent versions in order to select which version to install, refer to [Listing all agent versions](#list-versions) .\n- For production environments, you might want to pin to a major version to avoid installing major versions that might include backward incompatible changes. To pin to a major version, run:```\nInvoke-Expression \"${env:UserProfile}\\add-google-cloud-ops-agent-repo.ps1 -AlsoInstall -Version MAJOR_VERSION.*.*\"\n```For example, to pin to the 1.x.x of the agent, run:```\nInvoke-Expression \"${env:UserProfile}\\add-google-cloud-ops-agent-repo.ps1 -AlsoInstall -Version 1.*.*\"\n```\n- To install a specific version of the agent, run:```\nInvoke-Expression \"${env:UserProfile}\\add-google-cloud-ops-agent-repo.ps1 -AlsoInstall -Version version-number\"\n```For example:```\nInvoke-Expression \"${env:UserProfile}\\add-google-cloud-ops-agent-repo.ps1 -AlsoInstall -Version 1.0.1\"\n```\nYou can delete the installation script after it runs successfully.- To verify that the agent is working as expected, run:```\nGet-Service google-cloud-ops-agent\n```The status of the agent should be `Running` .\nIf you have trouble with the installation, refer to the [Troubleshooting](/stackdriver/docs/solutions/agents/ops-agent/troubleshooting) page.\n## Installing the agent by using the Google Cloud console\n**Note:** First verify that all conditions are met in the [Before youbegin](#before_you_begin) section.\nYou can install the Ops Agent on one or more Compute Engine VMs by using the Google Cloud console from the Cloud Monitoring or Compute Engine pages.\nIn the navigation panel of the Google Cloud console, select **Monitoring** , select **Dashboards** , and then select **VM instances** :\n [Go to VM Instances Dashboard](https://console.cloud.google.com/monitoring/dashboards/resourceList/gce_instance) The **List** view on the **Inventory** tab on the dashboard lists all VMs and includes a status column for your agent, as shown in the following screenshot:\n \nThe **Agent** column reports the following values:- **Not detected** : Either you don't have an agent installed or it is not running. If you aren't sure if you've installed an agent, then you can [query for the installed version](#agent-version) . If you've installed the agent, then you can [restart the agent](#restart) . If you've installed and started the Ops Agent but the status remains **Not detected** , then the agent might not have started correctly or is unable to send metrics.To troubleshoot start-up problems, see [Agent is installed but notrunning](/stackdriver/docs/solutions/agents/ops-agent/troubleshoot-install-startup#agent-not-running) . To troubleshoot metric-ingestion problems, see [Troubleshoot dataingestion](/stackdriver/docs/solutions/agents/ops-agent/troubleshoot-run-ingest) . The general [agent-diagnostics script](/stackdriver/docs/solutions/agents/ops-agent/troubleshoot-find-info#agent-diagnostics) and [health checks](/stackdriver/docs/solutions/agents/ops-agent/troubleshoot-find-info#health-checks) might also be helpful.\n- **Ops Agent** : You are running the Ops Agent. If you don't see a green checkmark beside the entry, then there is an agent upgrade available, based on the detected operating system of your VM.When you hover over the Ops Agent indicator in the table, you see information about the version of the Ops Agent. If you are running an older version, you also see a recommendation to upgrade your agent.\n- **Pending** : The Ops Agent is being installed or upgraded.If the agent installation remains **Pending** for more than 10 minutes, then there might be a problem in applying the Ops Agent OS policy or starting the agent. For troubleshooting information, see [Agent diagnostics tool for automatic installation policies](/stackdriver/docs/solutions/agents/ops-agent/troubleshoot-find-info#install-ospolicy) .\n- **Legacy Agent** : You are running the legacy Monitoring or the Logging agent. See [Migrating from the legacy agents to the OpsAgent](/stackdriver/docs/solutions/agents/ops-agent/transition#migrate_legacy) for information on transitioning to the Ops Agent.\n- **Not applicable** : This VM is not a supported platform for running the agent.\n- **Unknown** : The VM is not running, so the agent's status is not known.\nYou can install the Ops Agent by doing the following:- Select the VM instances on which you want to install agents.\n- Click the **Install/Update Ops Agent** option on the **Instances** table.\nYou can also install or update the Ops Agent from the **VM Details** page for a specific VM.\nWhen possible, the agent is installed by using an Ops Agent OS policy. For more information, see [Manage VMs covered by the Ops Agent OS policy](/stackdriver/docs/solutions/agents/ops-agent/../ops-agent/manage-policies-auto-install) . Ops Agent OS policies aren't supported on all versions of all operating systems. In this case, clicking **Install/Update Ops Agent** provides a series of commands to run in Cloud Shell.\nThe Ops Agent collects both metrics and logs by default. You can change this default behavior by [configuring the Ops Agent](/stackdriver/docs/solutions/agents/ops-agent/configuration) .- In the navigation panel of the Google Cloud console, select **Compute Engine** , and then select **VM instances** : [Go to VM instances](https://console.cloud.google.com/compute) \n- Click the name of the VM on which you want to install the agent.\n- Click the **Observability** tab.\n- Click **Install Ops Agent** .When possible, the agent is installed by using an Ops Agent OS policy. For more information, see [Manage VMs covered by the Ops Agent OS policy](/stackdriver/docs/solutions/agents/ops-agent/../ops-agent/manage-policies-auto-install) . Ops Agent OS policies aren't supported on all versions of all operating systems. In this case, clicking **Install/Update Ops Agent** provides a series of commands to run in Cloud Shell.The Ops Agent collects both metrics and logs by default. You can change this default behavior by [configuring the Ops Agent](/stackdriver/docs/solutions/agents/ops-agent/configuration) .If the agent installation remains **Pending** for more than 10 minutes, then there might be a problem in applying the Ops Agent OS policy or starting the agent. For troubleshooting information, see [Agent diagnostics tool for automatic installation policies](/stackdriver/docs/solutions/agents/ops-agent/troubleshoot-find-info#install-ospolicy) .\n## Verify that the Ops Agent is running\nThere are two ways to verify that the Ops Agent is running correctly:\n- Check that all the [healthchecks](/stackdriver/docs/solutions/agents/ops-agent/troubleshoot-find-info#health-checks) passed.\n- In the navigation panel of the Google Cloud console, select **Monitoring** , select **Dashboards** , and then select **VM instances** : [Go to VM Instances Dashboard](https://console.cloud.google.com/monitoring/dashboards/resourceList/gce_instance) Then check that the **Agent** column for this VM indicates the Ops Agent.## Optional tasks\nThis section describes how to perform common maintenance tasks.\n### Configuring an HTTP proxy\nIf you use an HTTP proxy for proxying requests to the Logging and Monitoring APIs, do the following:\n- Edit the following configuration file (create the file if it doesn't already exist):```\n\u00a0/etc/systemd/system.conf\n```\n- Add the following to the file:```\n\u00a0DefaultEnvironment=\"HTTP_PROXY=http://proxy-ip:proxy-port\" \"HTTPS_PROXY=http://proxy-ip:proxy-port\" \"NO_PROXY=http://metadata.google.internal\" \u00a0# Skip proxy for the local Metadata Server.\n```\n- Reload the environment variables:```\n\u00a0sudo systemctl daemon-reload\n```\n- Restart the agent by running the following command on your VM instance:```\n\u00a0sudo systemctl restart google-cloud-ops-agent\"*\"\n```\n- If you use an HTTP proxy, run the following command from an administrator command prompt. This sets the `HTTP_PROXY` and `HTTPS_PROXY` environment variables so that the agent can send data using outbound HTTPS:```\nsetx HTTP_PROXY http://proxy-ip:proxy-port /msetx HTTPS_PROXY http://proxy-ip:proxy-port /msetx no_proxy metadata.google.internal /m\n```\n### Determining the agent version\nTo determine the version of the Ops Agent on your system, run the following commands on your VM instance:\nTo see the version of your Ops Agent on a VM:- Locate the entry for the VM in the **Instances** table in the Monitoring **VM Instances** page. For navigation information, see [Installing the agent by using the Google Cloud console](#gce-ui-install) .\n- Hover over the **Ops Agent** indicator in the table entry.\nRun the following command on Red Hat or CentOS Linux:\n```\nrpm --query --queryformat '%{NAME} %{VERSION} %{RELEASE} %{ARCH}\\n' google-cloud-ops-agent\n```Run the following command on Debian or Ubuntu:\n```\ndpkg-query --show --showformat '${Package} ${Version} ${Architecture} ${Status}\\n' google-cloud-ops-agent\n```Run the following command on SUSE:\n```\nrpm --query --queryformat '%{NAME} %{VERSION} %{RELEASE} %{ARCH}\\n' google-cloud-ops-agent\n```Run the following command on Windows:\n```\ngooget installed google-cloud-ops-agent\n```\n### Restarting the agent\nYou must restart the Ops Agent to pick up changes in configuration files. To restart the agent, use the following instructions.\nRun the following command on your instance:\n```\n\u00a0 \u00a0 \u00a0sudo systemctl restart google-cloud-ops-agent\n```\n- Connect to your instance using RDP or a similar tool and login to Windows.\n- Open a PowerShell terminal with administrator privileges by right-clicking the PowerShell icon and selecting **Run as Administrator** .\n- Run the following PowerShell command:\n```\nRestart-Service google-cloud-ops-agent -Force\n```\n### Upgrading the agent\nTo upgrade the Ops Agent to the latest release, use the following instructions:\n**Note:** If you upgraded your instance's Linux operating system to a new major release, then you should first [remove the agent](#uninstall) and then [re-install it](#joint-install) using the procedures on this page, instead of completing these upgrade procedures.\nYou can upgrade the Ops Agent by using Cloud Monitoring installation instructions. For more information, see [Installing the agent by using theGoogle Cloud console](#gce-ui-install) .To upgrade the agent to the latest version, run the following command:\n```\nsudo bash add-google-cloud-ops-agent-repo.sh --also-install\n```\nTo upgrade the agent to the latest point release of a specific major version, run the following command:\n```\nsudo bash add-google-cloud-ops-agent-repo.sh --also-install \\\u00a0 --version=MAJOR_VERSION.*.*\n```To upgrade to the latest agent release:- Connect to your instance using RDP or a similar tool and login to Windows.\n- Open a PowerShell terminal with administrator privileges by right-clicking the PowerShell icon and selecting **Run as Administrator** . **Note:** If you're upgrading your agent from a version earlier than 2.0.3 to version 2.0.3 or later, the upgrade removes the old config file. If you customized your agent configuration, be sure to save a backup of your configuration file before upgrading, and then to apply the necessary changes to the configuration file after the upgrade.```\nCopy-Item -Path \"C:\\Program Files\\Google\\Cloud Operations\\Ops Agent\\config\\config.yaml\" -Destination \"C:\\Program Files\\Google\\Cloud Operations\\Ops Agent\\config\\config.bak\"\n```\n- Run the following PowerShell commands to remove your installed agent and to run the installation command:```\ngooget -noconfirm remove google-cloud-ops-agent\ngooget -noconfirm install google-cloud-ops-agent\n```### Listing all agent versions\nTo list the available versions of the agent, run the following command:\nList the available versions of the agent:\n```\nsudo yum list --showduplicates google-cloud-ops-agent\n```List the available versions of the agent:\n```\nsudo apt-cache madison google-cloud-ops-agent\n```List the available versions of the agent:\n```\nsudo zypper search -s google-cloud-ops-agent\n```List the available versions of the agent:\n```\ngooget available google-cloud-ops-agent\n```\n### Uninstalling the agent\nTo remove the Ops Agent and its configuration files, use the following instructions.\n**Note:** If the Ops Agent was installed during VM creation, see [Manage VMs covered by Ops Agent OS policy](/stackdriver/docs/solutions/agents/ops-agent/manage-policies-auto-install) .\nAfter you uninstall the agent, the Google Cloud console might take up to one hour to report this change.\nRun the following command:\n```\nsudo bash add-google-cloud-ops-agent-repo.sh --uninstall\n```\nOptionally, to remove the repository in addition to uninstalling the agent, append `--remove-repo` to the previous command.To uninstall the Ops Agent, follow the following steps:- Connect to your instance using RDP or a similar tool and login to Windows.\n- Open a PowerShell terminal with administrator privileges by right-clicking the PowerShell icon and selecting **Run as Administrator** .\n- Run the following PowerShell command:```\ngooget -noconfirm remove google-cloud-ops-agent\n```## VMs without remote package access\nInstalling the Ops Agent [requires access](/stackdriver/docs/solutions/agents/ops-agent#access) to remote package repositories, for both the agent package and (on Linux) its dependencies.\nIf you are using [VPC-SC](/vpc-service-controls) or a private network, the network configuration might also affect your ability to install agent dependencies from upstream repositories. The agent packages themselves are accessible by using [Private GoogleAccess](/vpc/docs/configure-private-google-access) . This can be configured following [Enable Private GoogleAccess](/vpc/docs/configure-private-google-access#enabling-pga) .\nIf your VM host's security policy denies access to remote package repositories, we recommend creating a [custom VMimage](/compute/docs/images/create-delete-deprecate-private-images) with the agent pre-installed and disabling package management in that image.\n## What's next\n- Learn about what [logs the agent sends to Cloud Logging using itsdefault configuration](/stackdriver/docs/solutions/agents/ops-agent/configuration#default) .\n- For information on viewing your logs, see [Using theLogs Explorer](/logging/docs/view/logs-explorer-interface) .", "guide": "Google Cloud Observability"}