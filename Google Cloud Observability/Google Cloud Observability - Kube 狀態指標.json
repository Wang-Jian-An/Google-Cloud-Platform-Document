{"title": "Google Cloud Observability - Kube \u72c0\u614b\u6307\u6a19", "url": "https://cloud.google.com/stackdriver/docs/managed-prometheus/exporters/kube_state_metrics?hl=zh-cn", "abstract": "# Google Cloud Observability - Kube \u72c0\u614b\u6307\u6a19\n\u672c\u6587\u6a94\u4ecb\u7d39\u77ad\u5982\u4f55\u914d\u7f6e Google Kubernetes Engine \u90e8\u7f72\uff0c\u4ee5\u4fbf\u4f7f\u7528 Google Cloud Managed Service for Prometheus \u5f9e Kube \u72c0\u614b\u6307\u6a19\u4e2d\u6536\u96c6\u6307\u6a19\u3002\u672c\u9801\u9762\u4ecb\u7d39\u5982\u4f55\u5b8c\u6210\u4ee5\u4e0b\u4efb\u52d9\uff1a\n- \u8a2d\u7f6e Kube State Metrics \u4ee5\u5831\u544a\u6307\u6a19\u3002\n- \u7232 Managed Service for Prometheus \u914d\u7f6e PodMonitoring \u8cc7\u6e90\u4ee5\u6536\u96c6\u5c0e\u51fa\u7684\u6307\u6a19\u3002\n- \u5728 Cloud Monitoring \u4e2d\u8a2a\u554f\u4fe1\u606f\u4e2d\u5fc3\u4ee5\u67e5\u770b\u6307\u6a19\u3002\n- \u914d\u7f6e\u63d0\u9192\u898f\u5247\u4ee5\u76e3\u63a7\u6307\u6a19\u3002\u4ee5\u4e0b\u8aaa\u660e\u50c5\u5728\u60a8\u5c07 [\u4ee3\u7ba1\u5f0f\u6536\u96c6\u529f\u80fd](https://cloud.google.com/stackdriver/docs/managed-prometheus/setup-managed?hl=zh-cn) \u8207 Managed Service for Prometheus \u642d\u914d\u4f7f\u7528\u6642\u9069\u7528\u3002 \u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f\u81ea\u884c\u90e8\u7f72\u7684\u6536\u96c6\u529f\u80fd\uff0c\u8acb\u53c3\u95b1 Kube \u72c0\u614b\u6307\u6a19\u7684 [\u6e90\u4ee3\u78bc\u5eab](https://github.com/kubernetes/kube-state-metrics) \u4ee5\u77ad\u89e3\u5b89\u88dd\u4fe1\u606f\u3002\n", "content": "## \u524d\u63d0\u689d\u4ef6\n\u8981\u4f7f\u7528 Managed Service for Prometheus \u548c\u4ee3\u7ba1\u5f0f\u6536\u96c6\u529f\u80fd\u5f9e Kube \u72c0\u614b\u6307\u6a19\u6536\u96c6\u6307\u6a19\uff0c\u60a8\u7684\u90e8\u7f72\u5fc5\u9808\u6eff\u8db3\u4ee5\u4e0b\u8981\u6c42\uff1a\n- \u60a8\u7684\u96c6\u7fa3\u5fc5\u9808\u904b\u884c Google Kubernetes Engine 1.21.4-gke.300 \u6216\u66f4\u9ad8\u7248\u672c\u3002\n- \u60a8\u5fc5\u9808\u904b\u884c Managed Service for Prometheus\uff0c\u4e26\u5553\u7528\u4ee3\u7ba1\u5f0f\u6536\u96c6\u529f\u80fd\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u4ee3\u7ba1\u5f0f\u6536\u96c6\u529f\u80fd\u4f7f\u7528\u5165\u9580](https://cloud.google.com/stackdriver/docs/managed-prometheus/setup-managed?hl=zh-cn) \u3002\n- \u5982\u9700\u4f7f\u7528 Cloud Monitoring \u4e2d\u63d0\u4f9b\u7684\u4fe1\u606f\u4e2d\u5fc3\u9032\u884c\u96c6\u6210\uff0c\u60a8\u5fc5\u9808\u4f7f\u7528`kube-state-metrics`2.4.2 \u7248\u6216\u66f4\u9ad8\u7248\u672c\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u53ef\u7528\u7684\u4fe1\u606f\u4e2d\u5fc3\uff0c\u8acb\u53c3\u95b1 [\u5b89\u88dd\u4fe1\u606f\u4e2d\u5fc3](#monitoring-dashboard) \u3002\n## \u4ee3\u7ba1\u5f0f Kube State Metrics\nGKE \u63d0\u4f9b Kube State Metrics \u7684\u5168\u4ee3\u7ba1\u5f0f\u90e8\u7f72\uff0c\u4f5c\u7232\u914d\u7f6e\u6b64\u96c6\u6210\u7684\u66ff\u4ee3\u65b9\u6848\u3002\u53ef\u5b89\u88dd\u8edf\u4ef6\u5305\u63d0\u4f9b\u4e86\u4e00\u7d44\u6709\u91dd\u5c0d\u6027\u7684\u7cbe\u9078 kube \u72c0\u614b\u6307\u6a19\uff0c\u9700\u8981\u8f03\u5c11\u7684\u8a2d\u7f6e\u5de5\u4f5c\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u8edf\u4ef6\u5305\uff1aKube State Metrics](https://cloud.google.com/kubernetes-engine/docs/how-to/configure-metrics?hl=zh-cn#ksm-package) \u3002\n## \u5b89\u88dd Kube \u72c0\u614b\u6307\u6a19\n\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u914d\u7f6e\u4f86\u5b89\u88dd Kube State Metrics\uff1a\n[\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/prometheus-engine/blob/HEAD/examples/kube-state-metrics/kube-state-metrics.yaml)\n```\n# Copyright 2023 Google LLC\n## Licensed under the Apache License, Version 2.0 (the \"License\");# you may not use this file except in compliance with the License.# You may obtain a copy of the License at\n## \u00a0 \u00a0 https://www.apache.org/licenses/LICENSE-2.0\n## Unless required by applicable law or agreed to in writing, software# distributed under the License is distributed on an \"AS IS\" BASIS,# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.# See the License for the specific language governing permissions and# limitations under the License.apiVersion: apps/v1kind: StatefulSetmetadata:\u00a0 labels:\u00a0 \u00a0 app.kubernetes.io/name: kube-state-metrics\u00a0 \u00a0 app.kubernetes.io/version: 2.8.2\u00a0 namespace: gmp-public\u00a0 name: kube-state-metricsspec:\u00a0 replicas: 1\u00a0 selector:\u00a0 \u00a0 matchLabels:\u00a0 \u00a0 \u00a0 app.kubernetes.io/name: kube-state-metrics\u00a0 serviceName: kube-state-metrics\u00a0 template:\u00a0 \u00a0 metadata:\u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 app.kubernetes.io/name: kube-state-metrics\u00a0 \u00a0 \u00a0 \u00a0 app.kubernetes.io/version: 2.8.2\u00a0 \u00a0 spec:\u00a0 \u00a0 \u00a0 affinity:\u00a0 \u00a0 \u00a0 \u00a0 nodeAffinity:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 requiredDuringSchedulingIgnoredDuringExecution:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 nodeSelectorTerms:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - matchExpressions:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - key: kubernetes.io/arch\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 operator: In\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 values:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - arm64\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - amd64\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - key: kubernetes.io/os\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 operator: In\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 values:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - linux\u00a0 \u00a0 \u00a0 containers:\u00a0 \u00a0 \u00a0 - name: kube-state-metric\u00a0 \u00a0 \u00a0 \u00a0 image: k8s.gcr.io/kube-state-metrics/kube-state-metrics:v2.8.2\u00a0 \u00a0 \u00a0 \u00a0 env:\u00a0 \u00a0 \u00a0 \u00a0 - name: POD_NAME\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 valueFrom:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 fieldRef:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 fieldPath: metadata.name\u00a0 \u00a0 \u00a0 \u00a0 - name: POD_NAMESPACE\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 valueFrom:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 fieldRef:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 fieldPath: metadata.namespace\u00a0 \u00a0 \u00a0 \u00a0 args:\u00a0 \u00a0 \u00a0 \u00a0 - --pod=$(POD_NAME)\u00a0 \u00a0 \u00a0 \u00a0 - --pod-namespace=$(POD_NAMESPACE)\u00a0 \u00a0 \u00a0 \u00a0 - --port=8080\u00a0 \u00a0 \u00a0 \u00a0 - --telemetry-port=8081\u00a0 \u00a0 \u00a0 \u00a0 ports:\u00a0 \u00a0 \u00a0 \u00a0 - name: metrics\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 containerPort: 8080\u00a0 \u00a0 \u00a0 \u00a0 - name: metrics-self\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 containerPort: 8081\u00a0 \u00a0 \u00a0 \u00a0 resources:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 requests:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 cpu: 100m\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 memory: 190Mi\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 limits:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 memory: 250Mi\u00a0 \u00a0 \u00a0 \u00a0 securityContext:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 allowPrivilegeEscalation: false\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 privileged: false\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 capabilities:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 drop:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - all\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 runAsUser: 1000\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 runAsGroup: 1000\u00a0 \u00a0 \u00a0 \u00a0 livenessProbe:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 httpGet:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 path: /healthz\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 port: 8080\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 initialDelaySeconds: 5\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 timeoutSeconds: 5\u00a0 \u00a0 \u00a0 \u00a0 readinessProbe:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 httpGet:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 path: /\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 port: 8081\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 initialDelaySeconds: 5\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 timeoutSeconds: 5\u00a0 \u00a0 \u00a0 serviceAccountName: kube-state-metrics---apiVersion: v1kind: Servicemetadata:\u00a0 labels:\u00a0 \u00a0 app.kubernetes.io/name: kube-state-metrics\u00a0 \u00a0 app.kubernetes.io/version: 2.8.2\u00a0 namespace: gmp-public\u00a0 name: kube-state-metricsspec:\u00a0 clusterIP: None\u00a0 ports:\u00a0 - name: metrics\u00a0 \u00a0 port: 8080\u00a0 \u00a0 targetPort: metrics\u00a0 - name: metrics-self\u00a0 \u00a0 port: 8081\u00a0 \u00a0 targetPort: metrics-self\u00a0 selector:\u00a0 \u00a0 app.kubernetes.io/name: kube-state-metrics---apiVersion: v1kind: ServiceAccountmetadata:\u00a0 namespace: gmp-public\u00a0 name: kube-state-metrics\u00a0 labels:\u00a0 \u00a0 app.kubernetes.io/name: kube-state-metrics\u00a0 \u00a0 app.kubernetes.io/version: 2.8.2---apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata:\u00a0 name: gmp-public:kube-state-metrics\u00a0 labels:\u00a0 \u00a0 app.kubernetes.io/name: kube-state-metrics\u00a0 \u00a0 app.kubernetes.io/version: 2.8.2roleRef:\u00a0 apiGroup: rbac.authorization.k8s.io\u00a0 kind: ClusterRole\u00a0 name: gmp-public:kube-state-metricssubjects:- kind: ServiceAccount\u00a0 namespace: gmp-public\u00a0 name: kube-state-metrics---apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRolemetadata:\u00a0 name: gmp-public:kube-state-metrics\u00a0 labels:\u00a0 \u00a0 app.kubernetes.io/name: kube-state-metrics\u00a0 \u00a0 app.kubernetes.io/version: 2.8.2rules:- apiGroups:\u00a0 - \"\"\u00a0 resources:\u00a0 - configmaps\u00a0 - secrets\u00a0 - nodes\u00a0 - pods\u00a0 - services\u00a0 - resourcequotas\u00a0 - replicationcontrollers\u00a0 - limitranges\u00a0 - persistentvolumeclaims\u00a0 - persistentvolumes\u00a0 - namespaces\u00a0 - endpoints\u00a0 verbs:\u00a0 - list\u00a0 - watch- apiGroups:\u00a0 - \"\"\u00a0 resources:\u00a0 - pods\u00a0 verbs:\u00a0 - get- apiGroups:\u00a0 - extensions\u00a0 resources:\u00a0 - daemonsets\u00a0 - deployments\u00a0 - replicasets\u00a0 - ingresses\u00a0 verbs:\u00a0 - list\u00a0 - watch- apiGroups:\u00a0 - apps\u00a0 resources:\u00a0 - statefulsets\u00a0 - daemonsets\u00a0 - deployments\u00a0 - replicasets\u00a0 verbs:\u00a0 - list\u00a0 - watch- apiGroups:\u00a0 - apps\u00a0 resources:\u00a0 - statefulsets\u00a0 verbs:\u00a0 - get- apiGroups:\u00a0 - batch\u00a0 resources:\u00a0 - cronjobs\u00a0 - jobs\u00a0 verbs:\u00a0 - list\u00a0 - watch- apiGroups:\u00a0 - autoscaling\u00a0 resources:\u00a0 - horizontalpodautoscalers\u00a0 verbs:\u00a0 - list\u00a0 - watch- apiGroups:\u00a0 - authentication.k8s.io\u00a0 resources:\u00a0 - tokenreviews\u00a0 verbs:\u00a0 - create- apiGroups:\u00a0 - authorization.k8s.io\u00a0 resources:\u00a0 - subjectaccessreviews\u00a0 verbs:\u00a0 - create- apiGroups:\u00a0 - policy\u00a0 resources:\u00a0 - poddisruptionbudgets\u00a0 verbs:\u00a0 - list\u00a0 - watch- apiGroups:\u00a0 - certificates.k8s.io\u00a0 resources:\u00a0 - certificatesigningrequests\u00a0 verbs:\u00a0 - list\u00a0 - watch- apiGroups:\u00a0 - storage.k8s.io\u00a0 resources:\u00a0 - storageclasses\u00a0 - volumeattachments\u00a0 verbs:\u00a0 - list\u00a0 - watch- apiGroups:\u00a0 - admissionregistration.k8s.io\u00a0 resources:\u00a0 - mutatingwebhookconfigurations\u00a0 - validatingwebhookconfigurations\u00a0 verbs:\u00a0 - list\u00a0 - watch- apiGroups:\u00a0 - networking.k8s.io\u00a0 resources:\u00a0 - networkpolicies\u00a0 - ingresses\u00a0 verbs:\u00a0 - list\u00a0 - watch- apiGroups:\u00a0 - coordination.k8s.io\u00a0 resources:\u00a0 - leases\u00a0 verbs:\u00a0 - list\u00a0 - watch---apiVersion: autoscaling/v2kind: HorizontalPodAutoscalermetadata:\u00a0 name: kube-state-metrics\u00a0 namespace: gmp-publicspec:\u00a0 maxReplicas: 10\u00a0 minReplicas: 1\u00a0 scaleTargetRef:\u00a0 \u00a0 apiVersion: apps/v1\u00a0 \u00a0 kind: StatefulSet\u00a0 \u00a0 name: kube-state-metrics\u00a0 metrics:\u00a0 - type: Resource\u00a0 \u00a0 resource:\u00a0 \u00a0 \u00a0 name: memory\u00a0 \u00a0 \u00a0 target:\u00a0 \u00a0 \u00a0 \u00a0 type: Utilization\u00a0 \u00a0 \u00a0 \u00a0 averageUtilization: 60\u00a0 behavior:\u00a0 \u00a0 scaleDown:\u00a0 \u00a0 \u00a0 policies:\u00a0 \u00a0 \u00a0 - type: Pods\u00a0 \u00a0 \u00a0 \u00a0 value: 1\u00a0 \u00a0 \u00a0 \u00a0 # Under-utilization needs to persist for `periodSeconds` before any action can be taken.\u00a0 \u00a0 \u00a0 \u00a0 # Current supported max from https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/horizontal-pod-autoscaler-v2beta2/.\u00a0 \u00a0 \u00a0 \u00a0 periodSeconds: 1800\u00a0 \u00a0 \u00a0 # Current supported max from https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/horizontal-pod-autoscaler-v2beta2/.\u00a0 \u00a0 \u00a0 stabilizationWindowSeconds: 3600---apiVersion: monitoring.googleapis.com/v1kind: ClusterPodMonitoringmetadata:\u00a0 name: kube-state-metrics\u00a0 labels:\u00a0 \u00a0 app.kubernetes.io/name: kube-state-metrics\u00a0 \u00a0 app.kubernetes.io/part-of: google-cloud-managed-prometheusspec:\u00a0 selector:\u00a0 \u00a0 matchLabels:\u00a0 \u00a0 \u00a0 app.kubernetes.io/name: kube-state-metrics\u00a0 endpoints:\u00a0 - port: metrics\u00a0 \u00a0 interval: 30s\u00a0 \u00a0 metricRelabeling:\u00a0 \u00a0 - action: keep\u00a0 \u00a0 \u00a0 # Curated subset of metrics to reduce costs while populating default set of sample dashboards at\u00a0 \u00a0 \u00a0 # https://github.com/GoogleCloudPlatform/monitoring-dashboard-samples/tree/master/dashboards/kubernetes\u00a0 \u00a0 \u00a0 # Change this regex to fit your needs for which objects you want to monitor\u00a0 \u00a0 \u00a0 regex: kube_(daemonset|deployment|replicaset|pod|namespace|node|statefulset|persistentvolume|horizontalpodautoscaler|job_created)(_.+)?\u00a0 \u00a0 \u00a0 sourceLabels: [__name__]\u00a0 targetLabels:\u00a0 \u00a0 metadata: [] # explicitly empty so the metric labels are respected---apiVersion: monitoring.googleapis.com/v1kind: PodMonitoringmetadata:\u00a0 namespace: gmp-public\u00a0 name: kube-state-metrics\u00a0 labels:\u00a0 \u00a0 app.kubernetes.io/name: kube-state-metrics\u00a0 \u00a0 app.kubernetes.io/part-of: google-cloud-managed-prometheusspec:\u00a0 selector:\u00a0 \u00a0 matchLabels:\u00a0 \u00a0 \u00a0 app.kubernetes.io/name: kube-state-metrics\u00a0 endpoints:\u00a0 - port: metrics-self\u00a0 \u00a0 interval: 30s\n```\n\u5982\u9700\u5f9e\u672c\u5730\u6587\u4ef6\u61c9\u7528\u914d\u7f6e\u66f4\u6539\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\nkubectl apply -f FILE_NAME\n```\n\u60a8\u9084\u53ef\u4ee5 [\u4f7f\u7528 Terraform](https://cloud.google.com/stackdriver/docs/managed-prometheus/setup-managed?hl=zh-cn#terraform-scrape) \u7ba1\u7406\u60a8\u7684\u914d\u7f6e\u3002\n## \u5b9a\u7fa9\u898f\u5247\u548c\u63d0\u9192\n\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b `Rules` \u914d\u7f6e\u4f86\u5b9a\u7fa9\u6307\u6a19\u63d0\u9192\uff1a\n[\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/prometheus-engine/blob/HEAD/examples/kube-state-metrics/rules.yaml)\n```\n# Copyright 2022 Google LLC\n## Licensed under the Apache License, Version 2.0 (the \"License\");# you may not use this file except in compliance with the License.# You may obtain a copy of the License at\n## \u00a0 \u00a0 https://www.apache.org/licenses/LICENSE-2.0\n## Unless required by applicable law or agreed to in writing, software# distributed under the License is distributed on an \"AS IS\" BASIS,# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.# See the License for the specific language governing permissions and# limitations under the License.apiVersion: monitoring.googleapis.com/v1kind: Rulesmetadata:\u00a0 namespace: gmp-public\u00a0 name: kube-state-metrics-rules\u00a0 labels:\u00a0 \u00a0 app.kubernetes.io/component: rules\u00a0 \u00a0 app.kubernetes.io/name: kube-state-metrics\u00a0 \u00a0 app.kubernetes.io/part-of: google-cloud-managed-prometheusspec:\u00a0 groups:\u00a0 \u00a0 - name: kube-state-metrics\u00a0 \u00a0 \u00a0 interval: 30s\u00a0 \u00a0 \u00a0 rules:\u00a0 \u00a0 \u00a0 - alert: KubeStateMetricsListErrors\u00a0 \u00a0 \u00a0 \u00a0 annotations:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 description: kube-state-metrics is experiencing errors at an elevated rate in list operations. This is likely causing it to not be able to expose metrics about Kubernetes objects correctly or at all.\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 summary: kube-state-metrics is experiencing errors in list operations.\u00a0 \u00a0 \u00a0 \u00a0 expr: |\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 (sum(rate(kube_state_metrics_list_total{job=\"kube-state-metrics\",result=\"error\"}[5m]))\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 /\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 sum(rate(kube_state_metrics_list_total{job=\"kube-state-metrics\"}[5m])))\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 > 0.01\u00a0 \u00a0 \u00a0 \u00a0 for: 15m\u00a0 \u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 severity: critical\u00a0 \u00a0 \u00a0 - alert: KubeStateMetricsWatchErrors\u00a0 \u00a0 \u00a0 \u00a0 annotations:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 description: kube-state-metrics is experiencing errors at an elevated rate in watch operations. This is likely causing it to not be able to expose metrics about Kubernetes objects correctly or at all.\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 summary: kube-state-metrics is experiencing errors in watch operations.\u00a0 \u00a0 \u00a0 \u00a0 expr: |\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 (sum(rate(kube_state_metrics_watch_total{job=\"kube-state-metrics\",result=\"error\"}[5m]))\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 /\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 sum(rate(kube_state_metrics_watch_total{job=\"kube-state-metrics\"}[5m])))\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 > 0.01\u00a0 \u00a0 \u00a0 \u00a0 for: 15m\u00a0 \u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 severity: critical\u00a0 \u00a0 \u00a0 - alert: KubeStateMetricsShardingMismatch\u00a0 \u00a0 \u00a0 \u00a0 annotations:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 description: kube-state-metrics pods are running with different --total-shards configuration, some Kubernetes objects may be exposed multiple times or not exposed at all.\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 summary: kube-state-metrics sharding is misconfigured.\u00a0 \u00a0 \u00a0 \u00a0 expr: |\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 stdvar (kube_state_metrics_total_shards{job=\"kube-state-metrics\"}) != 0\u00a0 \u00a0 \u00a0 \u00a0 for: 15m\u00a0 \u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 severity: critical\u00a0 \u00a0 \u00a0 - alert: KubeStateMetricsShardsMissing\u00a0 \u00a0 \u00a0 \u00a0 annotations:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 description: kube-state-metrics shards are missing, some Kubernetes objects are not being exposed.\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 summary: kube-state-metrics shards are missing.\u00a0 \u00a0 \u00a0 \u00a0 expr: |\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 2^max(kube_state_metrics_total_shards{job=\"kube-state-metrics\"}) - 1\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 -\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 sum( 2 ^ max by (shard_ordinal) (kube_state_metrics_shard_ordinal{job=\"kube-state-metrics\"}) )\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 != 0\u00a0 \u00a0 \u00a0 \u00a0 for: 15m\u00a0 \u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 severity: critical\n```\n\u5982\u9700\u5f9e\u672c\u5730\u6587\u4ef6\u61c9\u7528\u914d\u7f6e\u66f4\u6539\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\nkubectl apply -f FILE_NAME\n```\n\u60a8\u9084\u53ef\u4ee5 [\u4f7f\u7528 Terraform](https://cloud.google.com/stackdriver/docs/managed-prometheus/setup-managed?hl=zh-cn#terraform-scrape) \u7ba1\u7406\u60a8\u7684\u914d\u7f6e\u3002\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u5c07\u898f\u5247\u61c9\u7528\u65bc\u60a8\u7684\u96c6\u7fa3\uff0c\u8acb\u53c3\u95b1 [\u4ee3\u7ba1\u5f0f\u898f\u5247\u8a55\u4f30\u548c\u63d0\u9192](https://cloud.google.com/stackdriver/docs/managed-prometheus/rules-managed?hl=zh-cn) \u3002\n`Rules`\n[kube-state-metrics](https://github.com/kubernetes/kube-state-metrics/blob/master/examples/prometheus-alerting-rules/alerts.yaml)\n## \u9a57\u8b49\u914d\u7f6e\n\u60a8\u53ef\u4ee5\u4f7f\u7528 Metrics Explorer \u4f86\u9a57\u8b49\u662f\u5426\u6b63\u78ba\u914d\u7f6e\u4e86\u5c0e\u51fa\u5668\u3002Cloud Monitoring \u53ef\u80fd\u9700\u8981\u4e00\u5169\u5206\u9418\u6642\u9593\u4f86\u6ce8\u5165\u60a8\u7684\u6307\u6a19\u3002\n\u8981\u9a57\u8b49\u6307\u6a19\u662f\u5426\u5df2\u6ce8\u5165\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5c0e\u822a\u9762\u677f\u4e2d\uff0c\u9078\u64c7 **Monitoring** \uff0c\u7136\u5f8c\u9078\u64c7 **Metrics Explorer** \uff1a [\u9032\u5165 Metrics Explorer](https://console.cloud.google.com/monitoring/metrics-explorer?hl=zh-cn) \n- \u5728\u67e5\u8a62\u69cb\u5efa\u5668\u7a97\u683c\u7684\u5de5\u5177\u6b04\u4e2d\uff0c\u9078\u64c7\u540d\u7232 **MQL** \u6216 **PromQL** \u7684\u6309\u9215\u3002\n- \u9a57\u8b49\u5df2\u5728 **\u8a9e\u8a00** \u5207\u63db\u958b\u95dc\u4e2d\u9078\u64c7 **PromQL** \u3002\u8a9e\u8a00\u5207\u63db\u958b\u95dc\u4f4d\u65bc\u540c\u4e00\u5de5\u5177\u6b04\u4e2d\uff0c\u7528\u65bc\u8a2d\u7f6e\u67e5\u8a62\u7684\u683c\u5f0f\u3002\n- \u8f38\u5165\u4e26\u904b\u884c\u4ee5\u4e0b\u67e5\u8a62\uff1a```\nup{job=\"kube-state-metrics\", cluster=\"CLUSTER_NAME\", namespace=\"gmp-public\"}\n```\n## \u5b89\u88dd\u4fe1\u606f\u4e2d\u5fc3\nCloud Monitoring \u63d0\u4f9b\u4e86\u4e00\u500b\u7528\u65bc\u96c6\u6210\u7684\u4fe1\u606f\u4e2d\u5fc3\u793a\u4f8b\u5eab\u3002\u793a\u4f8b\u5eab\u5305\u542b\u201cPrometheus\u201d\u4fe1\u606f\u4e2d\u5fc3\uff0c\u60a8\u53ef\u4ee5\u5b89\u88dd\u8a72\u4fe1\u606f\u4e2d\u5fc3\u4ee5\u67e5\u770b Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684\u6578\u64da\u3002\n\u8acb\u6ce8\u610f\uff0c **Kubernetes \u96c6\u7fa3 Prometheus \u6982\u89bd** \u4fe1\u606f\u4e2d\u5fc3\u8981\u6c42\u5b89\u88dd [Node Exporter](https://cloud.google.com/stackdriver/docs/managed-prometheus/exporters/node_exporter?hl=zh-cn) \u3002 **Kubernetes Pod Prometheus \u6982\u89bd** \u4fe1\u606f\u4e2d\u5fc3\u8981\u6c42\u5b89\u88dd [Node Exporter](https://cloud.google.com/stackdriver/docs/managed-prometheus/exporters/node_exporter?hl=zh-cn) \u548c [cAdvisor/Kubelet](https://cloud.google.com/stackdriver/docs/managed-prometheus/exporters/kubelet-cadvisor?hl=zh-cn) \u3002\n\u5982\u9700\u5f9e\u793a\u4f8b\u5eab\u5b89\u88dd\u4fe1\u606f\u4e2d\u5fc3\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5c0e\u822a\u9762\u677f\u4e2d\uff0c\u9078\u64c7 **Monitoring** \uff0c\u7136\u5f8c\u9078\u64c7 **\u4fe1\u606f\u4e2d\u5fc3** \uff1a [\u524d\u5f80\u4fe1\u606f\u4e2d\u5fc3](https://console.cloud.google.com/monitoring/dashboards?hl=zh-cn) \n- \u9078\u64c7 **\u793a\u4f8b\u5eab** \u6a19\u7c64\u9801\u3002\n- \u9078\u64c7 **\u5176\u4ed6** \u985e\u5225\u3002\n- \uff08\u53ef\u9078\uff09\u5982\u9700\u5728\u4e0d\u5b89\u88dd\u4fe1\u606f\u4e2d\u5fc3\u7684\u60c5\u6cc1\u4e0b\u67e5\u770b\u975c\u614b\u9810\u89bd\uff0c\u8acb\u9ede\u64ca **\u9810\u89bd** \u3002\n- \u9078\u64c7\u8981\u5b89\u88dd\u7684\u4fe1\u606f\u4e2d\u5fc3\uff0c\u7136\u5f8c\u9ede\u64ca **\u5c0e\u5165** \u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u5b89\u88dd\u4fe1\u606f\u4e2d\u5fc3\uff0c\u8acb\u53c3\u95b1 [\u5b89\u88dd\u793a\u4f8b\u4fe1\u606f\u4e2d\u5fc3](https://cloud.google.com/monitoring/dashboards/dashboard-templates?hl=zh-cn#install-templates) \u3002\n## \u554f\u984c\u6392\u67e5\n\u5982\u9700\u77ad\u89e3\u5982\u4f55\u6392\u67e5\u6307\u6a19\u8a3b\u5165\u554f\u984c\uff0c\u8acb\u53c3\u95b1 [\u6392\u67e5\u6ce8\u5165\u7aef\u554f\u984c](https://cloud.google.com/stackdriver/docs/managed-prometheus/troubleshooting?hl=zh-cn#ingest-problems) \u4e2d\u7684 [\u5f9e\u5c0e\u51fa\u5668\u6536\u96c6\u7684\u554f\u984c](https://cloud.google.com/stackdriver/docs/managed-prometheus/troubleshooting?hl=zh-cn#exporter-problems) \u3002", "guide": "Google Cloud Observability"}