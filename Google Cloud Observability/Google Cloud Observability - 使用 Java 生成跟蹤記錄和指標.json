{"title": "Google Cloud Observability - \u4f7f\u7528 Java \u751f\u6210\u8ddf\u8e64\u8a18\u9304\u548c\u6307\u6a19", "url": "https://cloud.google.com/stackdriver/docs/instrumentation/setup/java?hl=zh-cn", "abstract": "# Google Cloud Observability - \u4f7f\u7528 Java \u751f\u6210\u8ddf\u8e64\u8a18\u9304\u548c\u6307\u6a19\n\u672c\u6587\u6a94\u4ecb\u7d39\u77ad\u5982\u4f55\u4fee\u6539 Java \u61c9\u7528\u4ee5\u4f7f\u7528\u958b\u6e90 [OpenTelemetry](https://opentelemetry.io/docs/what-is-opentelemetry/) \u6846\u67b6\u6536\u96c6\u8ddf\u8e64\u8a18\u9304\u548c\u6307\u6a19\u6578\u64da\uff0c\u4ee5\u53ca\u5982\u4f55\u5c07\u7d50\u69cb\u5316 JSON \u65e5\u8a8c\u5beb\u5165\u6a19\u6e96\u8f38\u51fa\u3002\u672c\u6587\u6a94\u9084\u4ecb\u7d39\u4e86\u60a8\u53ef\u4ee5\u5b89\u88dd\u548c\u904b\u884c\u7684\u793a\u4f8b Java Spring Boot \u61c9\u7528\u3002 \u61c9\u7528\u5df2\u914d\u7f6e\u7232\u751f\u6210\u6307\u6a19\u3001\u8ddf\u8e64\u8a18\u9304\u548c\u65e5\u8a8c\u3002\u7121\u8ad6\u60a8\u662f\u5426\u4f7f\u7528 [Spring Boot \u6846\u67b6](https://spring.io/projects/spring-boot/) \uff0c\u6b65\u9a5f\u90fd\u662f\u76f8\u540c\u7684\u3002\n", "content": "## \u6e96\u5099\u5de5\u4f5c\u5553\u7528 Cloud Logging API, Cloud Monitoring API, and Cloud Trace API\u3002\n[\u5553\u7528 API](https://console.cloud.google.com/flows/enableapi?apiid=logging.googleapis.com%E3%80%81monitoring.googleapis.com%E3%80%81trace.googleapis.com&hl=zh-cn)\n## \u5c0d\u61c9\u7528\u9032\u884c\u63d2\u6a01\u8655\u7406\u4ee5\u6536\u96c6\u8ddf\u8e64\u8a18\u9304\u3001\u6307\u6a19\u548c\u65e5\u8a8c\n\u5982\u9700\u5c0d\u61c9\u7528\u9032\u884c\u63d2\u6a01\u8655\u7406\u4ee5\u6536\u96c6\u8ddf\u8e64\u8a18\u9304\u548c\u6307\u6a19\u6578\u64da\uff0c\u4e26\u5c07\u7d50\u69cb\u5316 JSON \u5beb\u5165\u6a19\u6e96\u8f38\u51fa\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u6b65\u9a5f\uff0c\u5982\u672c\u6587\u6a94\u5f8c\u7e8c\u90e8\u5206\u6240\u8ff0\uff1a\n- [\u5c07\u60a8\u7684\u61c9\u7528\u914d\u7f6e\u7232\u4f7f\u7528 OpenTelemetry Java \u4ee3\u7406](#config-agent) \n- [\u914d\u7f6e OpenTelemetry](#config-otel) \n- [\u914d\u7f6e\u7d50\u69cb\u5316\u65e5\u8a8c\u8a18\u9304](#config-structured-logging) \n- [\u5beb\u5165\u7d50\u69cb\u5316\u65e5\u8a8c](#write-structured-logging) \n### \u5c07\u60a8\u7684\u61c9\u7528\u914d\u7f6e\u7232\u4f7f\u7528 OpenTelemetry Java \u4ee3\u7406\n\u5982\u9700\u5c07\u61c9\u7528\u914d\u7f6e\u7232\u5beb\u5165\u7d50\u69cb\u5316\u65e5\u8a8c\u4e26\u4f7f\u7528 OpenTelemetry \u6536\u96c6\u6307\u6a19\u548c\u8ddf\u8e64\u8a18\u9304\u6578\u64da\uff0c\u8acb\u66f4\u65b0\u61c9\u7528\u7684\u8abf\u7528\u4ee5\u4f7f\u7528 [OpenTelemetry Java \u4ee3\u7406](https://opentelemetry.io/docs/instrumentation/java/automatic/) \u3002\u9019\u7a2e\u5c0d\u61c9\u7528\u9032\u884c\u63d2\u6a01\u8655\u7406\u7684\u65b9\u6cd5\u7a31\u7232\u201c\u81ea\u52d5\u63d2\u6a01\u201d\uff0c\u56e0\u7232\u5b83\u4e0d\u9700\u8981\u4fee\u6539\u61c9\u7528\u4ee3\u78bc\u3002\n\u4ee5\u4e0b\u4ee3\u78bc\u793a\u4f8b\u6f14\u793a\u4e86\u4e00\u500b Dockerfile\uff0c\u7528\u65bc\u4e0b\u8f09 OpenTelemetry Java \u4ee3\u7406 JAR \u6587\u4ef6\u4e26\u66f4\u65b0\u547d\u4ee4\u884c\u8abf\u7528\u4ee5\u50b3\u905e `-javaagent` \u6a19\u8a8c\u3002\n[\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/opentelemetry-operations-java/blob/HEAD/examples/instrumentation-quickstart/Dockerfile)\n```\nRUN wget -O /opentelemetry-javaagent.jar https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/download/v1.31.0/opentelemetry-javaagent.jarCMD sh -c \"java -javaagent:/opentelemetry-javaagent.jar -cp app:app/lib/* com.example.demo.DemoApplication \\\u00a0 \u00a0 \u00a0 \u00a0 2>&1 | tee /var/log/app.log\"\n```\n\u6216\u8005\uff0c\u60a8\u9084\u53ef\u4ee5\u5728 `JAVA_TOOL_OPTIONS` \u74b0\u5883\u8b8a\u91cf\u4e2d\u8a2d\u7f6e `-javaagent` \u6a19\u8a8c\uff1a\n```\nexport JAVA_TOOL_OPTIONS=\"-javaagent:PATH/TO/opentelemetry-javaagent.jar\"\n```\n### \u914d\u7f6e OpenTelemetry\nOpenTelemetry Java \u4ee3\u7406\u7684\u9ed8\u8a8d\u914d\u7f6e\u4f7f\u7528 [OTLP \u5354\u8b70](https://opentelemetry.io/docs/specs/otlp/) \u5c0e\u51fa\u8ddf\u8e64\u8a18\u9304\u548c\u6307\u6a19\u3002\u5b83\u9084\u6703\u5c07 OpenTelemetry \u914d\u7f6e\u7232\u4f7f\u7528 [W3C \u8ddf\u8e64\u4e0a\u4e0b\u6587](https://www.w3.org/TR/trace-context/) \u683c\u5f0f\u4f86 [\u50b3\u64ad\u8ddf\u8e64\u4e0a\u4e0b\u6587](https://opentelemetry.io/docs/concepts/context-propagation/#propagation) \u3002\u6b64\u914d\u7f6e\u53ef\u78ba\u4fdd span \u5728\u8ddf\u8e64\u8a18\u9304\u4e2d\u5177\u6709\u6b63\u78ba\u7684\u7236\u5b50\u95dc\u4fc2\u3002\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\u548c\u914d\u7f6e\u9078\u9805\uff0c\u8acb\u53c3\u95b1 [OpenTelemetry Java \u81ea\u52d5\u63d2\u6a01](https://opentelemetry.io/docs/instrumentation/java/automatic/agent-config/) \u3002\n### \u914d\u7f6e\u7d50\u69cb\u5316\u65e5\u8a8c\u8a18\u9304\n\u5982\u9700\u5c07\u8ddf\u8e64\u8a18\u9304\u4fe1\u606f\u4f5c\u7232\u5beb\u5165\u6a19\u6e96\u8f38\u51fa\u7684 JSON \u683c\u5f0f\u65e5\u8a8c\u7684\u4e00\u90e8\u5206\u6dfb\u52a0\uff0c\u8acb\u5c07\u61c9\u7528\u914d\u7f6e\u7232\u8f38\u51fa JSON \u683c\u5f0f\u7684\u7d50\u69cb\u5316\u65e5\u8a8c\u3002\u6211\u5011\u5efa\u8b70\u60a8\u4f7f\u7528 [Logback](https://logback.qos.ch/index.html) \u4f5c\u7232\u65e5\u8a8c\u8a18\u9304\u5be6\u73fe\u3002\u4ee5\u4e0b\u4ee3\u78bc\u793a\u4f8b\u5c55\u793a\u4e86\u4e00\u500b\u914d\u7f6e\u7232\u4f7f\u7528 [Logstash \u7de8\u78bc\u5668](https://github.com/logfellow/logstash-logback-encoder) \u8f38\u51fa JSON \u7d50\u69cb\u5316\u65e5\u8a8c\u7684 `logback.xml` \u6587\u4ef6\uff1a\n[\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/opentelemetry-operations-java/blob/HEAD/examples/instrumentation-quickstart/src/main/resources/logback.xml)\n```\n<encoder class=\"net.logstash.logback.encoder.LogstashEncoder\">\u00a0 <!-- Format JSON logs for the Logging agent\u00a0 https://cloud.google.com/logging/docs/structured-logging#special-payload-fields -->\u00a0 <provider class=\"net.logstash.logback.composite.loggingevent.LoggingEventPatternJsonProvider\">\u00a0 \u00a0 <pattern>\u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \"logging.googleapis.com/trace\": \"%mdc{trace_id}\",\u00a0 \u00a0 \u00a0 \u00a0 \"logging.googleapis.com/spanId\": \"%mdc{span_id}\",\u00a0 \u00a0 \u00a0 \u00a0 \"logging.googleapis.com/trace_sampled\": \"#asBoolean{%replace(%mdc{trace_flags}){'01', 'true'}}\"\u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 </pattern>\u00a0 </provider>\u00a0 <!-- Rename fields for the Logging agent -->\u00a0 <fieldNames>\u00a0 \u00a0 <level>severity</level>\u00a0 \u00a0 <timestamp>timestamp</timestamp>\u00a0 \u00a0 <levelValue>[ignore]</levelValue>\u00a0 </fieldNames>\u00a0 <!-- Exclude tracing MDC keys which are handled above -->\u00a0 <excludeMdcKeyName>trace_id</excludeMdcKeyName>\u00a0 <excludeMdcKeyName>span_id</excludeMdcKeyName>\u00a0 <excludeMdcKeyName>trace_flags</excludeMdcKeyName></encoder>\n```\n\u6b64\u914d\u7f6e\u6703\u5f9e SLF4J \u7684 [\u6620\u5c04\u8a3a\u65b7\u4e0a\u4e0b\u6587](https://logback.qos.ch/manual/mdc.html) \u4e2d\u63d0\u53d6\u6709\u95dc\u6d3b\u8e8d span \u7684\u4fe1\u606f\uff0c\u4e26\u5c07\u8a72\u4fe1\u606f\u4f5c\u7232\u5c6c\u6027\u6dfb\u52a0\u5230\u65e5\u8a8c\u4e2d\u3002\u7136\u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u9019\u4e9b\u5c6c\u6027\u5c07\u65e5\u8a8c\u8207\u8ddf\u8e64\u8a18\u9304\u76f8\u95dc\u806f\uff1a\n- `logging.googleapis.com/trace`\uff1a\u8207\u65e5\u8a8c\u689d\u76ee\u95dc\u806f\u7684\u8ddf\u8e64\u8a18\u9304\u7684\u8cc7\u6e90\u540d\u7a31\u3002\n- `logging.googleapis.com/spanId`\uff1a\u8207\u65e5\u8a8c\u689d\u76ee\u95dc\u806f\u7684\u8ddf\u8e64\u8a18\u9304\u7684 span ID\u3002\n- `logging.googleapis.com/trace_sampled`\uff1a\u6b64\u5b57\u6bb5\u7684\u503c\u5fc5\u9808\u662f`true`\u6216`false`\u3002\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u9019\u4e9b\u5b57\u6bb5\uff0c\u8acb\u53c3\u95b1 [LogEntry](https://cloud.google.com/logging/docs/reference/v2/rest/v2/LogEntry?hl=zh-cn) \u7d50\u69cb\u3002\n### \u5beb\u5165\u7d50\u69cb\u5316\u65e5\u8a8c\n\u5982\u9700\u5beb\u5165\u93c8\u63a5\u5230\u8ddf\u8e64\u8a18\u9304\u7684\u7d50\u69cb\u5316\u65e5\u8a8c\uff0c\u8acb\u4f7f\u7528 [SLF4J](https://www.slf4j.org/) \u65e5\u8a8c\u8a18\u9304 API\u3002\u4f8b\u5982\uff0c\u4ee5\u4e0b\u8a9e\u53e5\u986f\u793a\u77ad\u5982\u4f55\u8abf\u7528 `Logger.info()` \u65b9\u6cd5\uff1a\n```\nlogger.info(\"handle /multi request with subRequests={}\", subRequests);\n```\nOpenTelemetry Java \u4ee3\u7406\u4f7f\u7528 [OpenTelemetry Context](https://opentelemetry.io/docs/specs/otel/context/) \u4e2d\u7576\u524d\u6d3b\u8e8d span \u7684 [span \u4e0a\u4e0b\u6587](https://opentelemetry.io/docs/concepts/signals/traces/#span-context) \u81ea\u52d5\u586b\u5145 SLF4J \u7684\u6620\u5c04\u8a3a\u65b7\u4e0a\u4e0b\u6587\u3002\u7136\u5f8c\uff0c\u6b64\u4e0a\u4e0b\u6587\u6703\u5305\u542b\u5728 JSON \u65e5\u8a8c\u4e2d\uff0c\u5982 [\u914d\u7f6e\u7d50\u69cb\u5316\u65e5\u8a8c\u8a18\u9304](#config-structured-logging) \u4e2d\u6240\u8ff0\u3002\n## \u904b\u884c\u914d\u7f6e\u7232\u6536\u96c6\u9059\u6e2c\u6578\u64da\u7684\u793a\u4f8b\u61c9\u7528\n\u793a\u4f8b\u61c9\u7528\u4f7f\u7528\u8207\u4f9b\u61c9\u5546\u7121\u95dc\u7684\u683c\u5f0f\uff0c\u5305\u62ec JSON \u65e5\u8a8c\u3001OTLP \u6307\u6a19\u548c\u8ddf\u8e64\u8a18\u9304\uff0c\u4ee5\u53ca [Spring Boot Framework](https://spring.io/projects/spring-boot/) \u3002\u7232\u4e86\u5c07\u9059\u6e2c\u8def\u7531\u5230 Google Cloud\uff0c\u6b64\u793a\u4f8b\u4f7f\u7528\u914d\u7f6e\u4e86 Google \u5c0e\u51fa\u5668\u7684 OpenTelemetry `Collector` \u3002\u8a72\u61c9\u7528\u6709\u5169\u500b\u7aef\u9ede\uff1a\n- `/multi`\u6b64\u7aef\u9ede\u7531 `handleMulti` \u51fd\u6578\u8655\u7406\u3002\u61c9\u7528\u4e2d\u7684\u8ca0\u8f09\u751f\u6210\u5668\u6703\u5411 `/multi` \u7aef\u9ede\u767c\u51fa\u8acb\u6c42\u3002\u5b83\u63a5\u6536\u4e00\u500b\u8acb\u6c42\uff0c\u4e26\u5411\u672c\u5730\u670d\u52d9\u5668\u4e0a\u7684 `/single` \u7aef\u9ede\u767c\u9001 3 \u5230 7 \u500b\u8acb\u6c42\u3002 [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/opentelemetry-operations-java/blob/HEAD/examples/instrumentation-quickstart/src/main/java/com/example/demo/MultiController.java) ```\n/**\u00a0* handleMulti handles an http request by making 3-7 http requests to the /single endpoint.\u00a0*\u00a0* <p>OpenTelemetry instrumentation requires no changes here. It will automatically generate a\u00a0* span for the controller body.\u00a0*/@GetMapping(\"/multi\")public Mono<String> handleMulti() throws Exception {\u00a0 int subRequests = ThreadLocalRandom.current().nextInt(3, 8);\u00a0 // Write a structured log with the request context, which allows the log to\u00a0 // be linked with the trace for this request.\u00a0 logger.info(\"handle /multi request with subRequests={}\", subRequests);\u00a0 // Make 3-7 http requests to the /single endpoint.\u00a0 return Flux.range(0, subRequests)\u00a0 \u00a0 \u00a0 .concatMap(\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 i -> client.get().uri(\"http://localhost:8080/single\").retrieve().bodyToMono(Void.class))\u00a0 \u00a0 \u00a0 .then(Mono.just(\"ok\"));}\n```\n- `/single`\u6b64\u7aef\u9ede\u7531 `handleSingle` \u51fd\u6578\u8655\u7406\u3002\u5b83\u6703\u4f11\u7720\u4e00\u5c0f\u6bb5\u6642\u9593\uff0c\u7136\u5f8c\u4ee5\u5b57\u7b26\u4e32\u505a\u51fa\u97ff\u61c9\u3002 [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/opentelemetry-operations-java/blob/HEAD/examples/instrumentation-quickstart/src/main/java/com/example/demo/SingleController.java) ```\n/**\u00a0* handleSingle handles an http request by sleeping for 100-200 ms. It writes the number of\u00a0* milliseconds slept as its response.\u00a0*\u00a0* <p>OpenTelemetry instrumentation requires no changes here. It will automatically generate a\u00a0* span for the controller body.\u00a0*/@GetMapping(\"/single\")public String handleSingle() throws InterruptedException {\u00a0 int sleepMillis = ThreadLocalRandom.current().nextInt(100, 200);\u00a0 logger.info(\"Going to sleep for {}\", sleepMillis);\u00a0 Thread.sleep(sleepMillis);\u00a0 logger.info(\"Finishing the request\");\u00a0 return String.format(\"slept %s\\n\", sleepMillis);}\n```\n### \u4e0b\u8f09\u4e26\u90e8\u7f72\u61c9\u7528\n**\u6ce8\u610f** \uff1a\u6211\u5011\u5efa\u8b70\u4f7f\u7528 Cloud Shell \u904b\u884c\u793a\u4f8b\u61c9\u7528\u3002\u4e0d\u904e\uff0c\u5982\u679c\u8981\u5728 Linux \u6216 Mac \u4e0a\u672c\u5730\u904b\u884c\u793a\u4f8b\u61c9\u7528\uff0c\u8acb\u8df3\u904e\u4ee5\u4e0b\u8aaa\u660e\u4e2d\u7684\u7b2c\u4e00\u6b65\u3002\n\u5982\u9700\u904b\u884c\u793a\u4f8b\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u6fc0\u6d3b Cloud Shell\u3002 [\u6fc0\u6d3b Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn)  [Cloud Shell](https://cloud.google.com/shell/docs/how-cloud-shell-works?hl=zh-cn) \u6703\u8a71\u96a8\u5373\u6703\u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5e95\u90e8\u5553\u52d5\uff0c\u4e26\u986f\u793a\u547d\u4ee4\u884c\u63d0\u793a\u7b26\u3002Cloud Shell \u662f\u4e00\u500b\u5df2\u5b89\u88dd Google Cloud CLI \u4e14\u5df2\u7232\u7576\u524d\u9805\u76ee\u8a2d\u7f6e\u503c\u7684 Shell \u74b0\u5883\u3002\u8a72\u6703\u8a71\u53ef\u80fd\u9700\u8981\u5e7e\u79d2\u9418\u6642\u9593\u4f86\u5b8c\u6210\u521d\u59cb\u5316\u3002\n- \u514b\u9686\u4ee3\u78bc\u5eab\uff1a```\ngit clone https://github.com/GoogleCloudPlatform/opentelemetry-operations-java\n```\n- \u8f49\u5230\u793a\u4f8b\u76ee\u9304\uff1a```\ncd opentelemetry-operations-java/examples/instrumentation-quickstart\n```\n- \u69cb\u5efa\u4e26\u904b\u884c\u793a\u4f8b\uff1a```\ndocker compose up --abort-on-container-exit\n```\u5982\u679c\u60a8\u672a\u5728 Cloud Shell \u4e0a\u904b\u884c\uff0c\u8acb\u4f7f\u7528\u6307\u5411\u6191\u64da\u6587\u4ef6\u7684 `GOOGLE_APPLICATION_CREDENTIALS` \u74b0\u5883\u8b8a\u91cf\u904b\u884c\u61c9\u7528\u3002 [\u61c9\u7528\u9ed8\u8a8d\u6191\u64da](https://cloud.google.com/docs/authentication/application-default-credentials?hl=zh-cn#personal) \u63d0\u4f9b\u4e86\u4e00\u500b\u6191\u64da\u6587\u4ef6 ( `$HOME/.config/gcloud/application_default_credentials.json` )\u3002```\n# Set environment variablesexport GOOGLE_CLOUD_PROJECT=\"PROJECT_ID\"export GOOGLE_APPLICATION_CREDENTIALS=\"$HOME/.config/gcloud/application_default_credentials.json\"export USERID=\"$(id -u)\"# Rundocker compose -f docker-compose.yaml -f docker-compose.creds.yaml up --abort-on-container-exit\n```\n### \u67e5\u770b\u6307\u6a19\n\u793a\u4f8b\u61c9\u7528\u4e2d\u7684 OpenTelemetry \u63d2\u6a01\u751f\u6210 Prometheus \u6307\u6a19\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 [Metrics Explorer](https://cloud.google.com/monitoring/charts/metrics-explorer?hl=zh-cn) \u67e5\u770b\u9019\u4e9b\u6307\u6a19\uff1a\n- `Prometheus/http_server_duration_milliseconds/histogram` \u6703\u8a18\u9304\u670d\u52d9\u5668\u8acb\u6c42\u7684\u6301\u7e8c\u6642\u9593\uff0c\u4e26\u5c07\u7d50\u679c\u5b58\u5132\u5728\u76f4\u65b9\u5716\u4e2d\u3002\n- `Prometheus/http_client_duration_milliseconds/histogram` \u6703\u8a18\u9304\u5ba2\u6236\u7aef\u8acb\u6c42\u7684\u6301\u7e8c\u6642\u9593\uff0c\u4e26\u5c07\u7d50\u679c\u5b58\u5132\u5728\u76f4\u65b9\u5716\u4e2d\u3002- \u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5c0e\u822a\u9762\u677f\u4e2d\uff0c\u9078\u64c7 **Monitoring** \uff0c\u7136\u5f8c\u9078\u64c7 **Metrics Explorer** \uff1a [\u9032\u5165 Metrics Explorer](https://console.cloud.google.com/monitoring/metrics-explorer?hl=zh-cn) \n- \u5728 **\u6307\u6a19** \u5143\u7d20\u4e2d\uff0c\u5c55\u958b **\u9078\u64c7\u6307\u6a19** \u83dc\u55ae\uff0c\u5728\u904e\u6ffe\u6b04\u4e2d\u8f38\u5165`http_server`\uff0c\u7136\u5f8c\u4f7f\u7528\u5b50\u83dc\u55ae\u9078\u64c7\u4e00\u500b\u7279\u5b9a\u8cc7\u6e90\u985e\u578b\u548c\u6307\u6a19\uff1a- \u5728 **\u6d3b\u8e8d\u8cc7\u6e90** \u83dc\u55ae\u4e2d\uff0c\u9078\u64c7 **Prometheus \u76ee\u6a19** \u3002\n- \u5728 **\u6d3b\u8e8d\u6307\u6a19\u985e\u5225** \u83dc\u55ae\u4e2d\uff0c\u9078\u64c7 **HTTP** \u3002\n- \u5728 **\u6d3b\u8e8d\u6307\u6a19** \u83dc\u55ae\u4e2d\uff0c\u9078\u64c7\u6307\u6a19\u3002\n- \u9ede\u64ca **\u61c9\u7528** \u3002\n- \u914d\u7f6e\u6578\u64da\u7684\u67e5\u770b\u65b9\u5f0f\u3002\u5982\u679c\u6307\u6a19\u7684\u6e2c\u91cf\u7d50\u679c\u662f\u7d2f\u7a4d\u7684\uff0c\u5247 Metrics Explorer \u6703\u81ea\u52d5\u6309\u6821\u6e96\u6642\u9593\u6bb5\u5c0d\u6e2c\u91cf\u6578\u64da\u9032\u884c\u6b78\u4e00\u5316\uff0c\u5f9e\u800c\u4f7f\u5716\u8868\u986f\u793a\u901f\u7387\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7a2e\u985e\u3001\u985e\u578b\u548c\u8f49\u63db](https://cloud.google.com/monitoring/api/v3/aggregation?hl=zh-cn#ts-conversion) \u3002\u6e2c\u91cf\u6574\u6578\u6216\u96d9\u7cbe\u5ea6\u503c\u6642\uff08\u4f8b\u5982\u4f7f\u7528\u5169\u500b `counter` \u6307\u6a19\uff09\uff0cMetrics Explorer \u6703\u81ea\u52d5\u5c0d\u6240\u6709\u6642\u5e8f\u6c42\u548c\u3002\u5982\u9700\u67e5\u770b `/multi` \u548c `/single` HTTP \u8def\u7531\u7684\u6578\u64da\uff0c\u8acb\u5c07 **\u805a\u5408** \u689d\u76ee\u7684\u7b2c\u4e00\u500b\u83dc\u55ae\u8a2d\u7f6e\u7232 **\u7121** \u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u914d\u7f6e\u5716\u8868\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528 Metrics Explorer \u6642\u9078\u64c7\u6307\u6a19](https://cloud.google.com/monitoring/charts/metrics-selector?hl=zh-cn) \u3002\n### \u67e5\u770b\u8ddf\u8e64\u8a18\u9304\n\u5982\u9700\u67e5\u770b\u8ddf\u8e64\u8a18\u9304\u6578\u64da\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5c0e\u822a\u9762\u677f\u4e2d\uff0c\u9078\u64c7 **Trace** \uff0c\u7136\u5f8c\u9078\u64c7 **Trace \u63a2\u7d22\u5668** \uff1a [\u8f49\u5230 Trace \u63a2\u7d22\u5668](https://console.cloud.google.com/traces/list?hl=zh-cn) \n- \u5728\u6563\u9ede\u5716\u4e2d\uff0c\u9078\u64c7 URI \u7232`/multi`\u7684\u8ddf\u8e64\u8a18\u9304\u3002\n- \u5728 **\u8ddf\u8e64\u8a18\u9304\u8a73\u60c5** \u9762\u677f\u7684\u7518\u7279\u5716\u4e2d\uff0c\u9078\u64c7\u6a19\u8a18\u7232 `/multi` \u7684 span\u3002\u6b64\u6642\u6703\u6253\u958b\u4e00\u500b\u9762\u677f\uff0c\u5176\u4e2d\u986f\u793a HTTP \u8acb\u6c42\u7684\u76f8\u95dc\u4fe1\u606f\u3002\u9019\u4e9b\u8a73\u7d30\u4fe1\u606f\u5305\u62ec\u65b9\u6cd5\u3001\u72c0\u614b\u4ee3\u78bc\u3001\u5b57\u7bc0\u6578\u4ee5\u53ca\u8abf\u7528\u65b9\u7684\u7528\u6236\u4ee3\u7406\u3002\n- \u5982\u9700\u67e5\u770b\u8207\u6b64\u8ddf\u8e64\u8a18\u9304\u95dc\u806f\u7684\u65e5\u8a8c\uff0c\u8acb\u9078\u64c7 **\u65e5\u8a8c\u548c\u4e8b\u4ef6** \u6a19\u7c64\u9801\u3002\u8a72\u6a19\u7c64\u9801\u6703\u986f\u793a\u5404\u500b\u65e5\u8a8c\u3002\u5982\u9700\u67e5\u770b\u65e5\u8a8c\u689d\u76ee\u7684\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u5c55\u958b\u65e5\u8a8c\u689d\u76ee\u3002\u60a8\u9084\u53ef\u4ee5\u9ede\u64ca **\u67e5\u770b\u65e5\u8a8c** \uff0c\u4e26\u4f7f\u7528 Logs Explorer \u67e5\u770b\u65e5\u8a8c\u3002\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u4f7f\u7528 Cloud Trace \u63a2\u7d22\u5668\uff0c\u8acb\u53c3\u95b1 [\u67e5\u627e\u548c\u63a2\u7d22\u8ddf\u8e64\u8a18\u9304](https://cloud.google.com/trace/docs/finding-traces?hl=zh-cn) \u3002\n### \u67e5\u770b\u65e5\u8a8c\n\u5728 Logs Explorer \u4e2d\uff0c\u60a8\u53ef\u4ee5\u6aa2\u67e5\u65e5\u8a8c\uff0c\u9084\u53ef\u4ee5\u67e5\u770b\u95dc\u806f\u7684\u8ddf\u8e64\u8a18\u9304\uff08\u5982\u679c\u5b58\u5728\uff09\u3002\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5c0e\u822a\u9762\u677f\u4e2d\uff0c\u9078\u64c7 **Logging** \uff0c\u7136\u5f8c\u9078\u64c7 **Logs Explorer** \uff1a [\u524d\u5f80 Logs Explorer](https://console.cloud.google.com/logs/query?hl=zh-cn) \n- \u627e\u5230\u5177\u6709 `handle /multi request` \u8aaa\u660e\u7684\u65e5\u8a8c\u3002\u5982\u9700\u67e5\u770b\u65e5\u8a8c\u7684\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u5c55\u958b\u65e5\u8a8c\u689d\u76ee\u3002\n- \u9ede\u64ca\u5305\u542b\u201c\u8655\u7406/\u591a\u8acb\u6c42\u201d\u6d88\u606f\u7684\u65e5\u8a8c\u689d\u76ee\u4e2d\u7684 **\u8ddf\u8e64\u8a18\u9304** \uff0c\u7136\u5f8c\u9078\u64c7 **\u67e5\u770b\u8ddf\u8e64\u8a18\u9304\u8a73\u60c5** \u3002 **\u8ddf\u8e64\u8a18\u9304\u8a73\u60c5** \u9762\u677f\u96a8\u5373\u6703\u6253\u958b\u4e26\u986f\u793a\u6240\u9078\u8ddf\u8e64\u8a18\u9304\u3002\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u4f7f\u7528 Logs Explorer\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528 Logs Explorer \u67e5\u770b\u65e5\u8a8c](https://cloud.google.com/logging/docs/view/logs-explorer-interface?hl=zh-cn) \u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n- [OpenTelemetry](https://opentelemetry.io/docs/what-is-opentelemetry/) \n- [OTLP \u6982\u89bd](https://opentelemetry.io/docs/specs/otlp/) \n- [\u7d50\u69cb\u5316\u65e5\u8a8c\u8a18\u9304](https://cloud.google.com/logging/docs/structured-logging?hl=zh-cn) \n- [\u6392\u67e5 Managed Service for Prometheus \u7684\u554f\u984c](https://cloud.google.com/stackdriver/docs/managed-prometheus/troubleshooting?hl=zh-cn) \n- [\u6392\u67e5 Cloud Trace \u554f\u984c](https://cloud.google.com/trace/docs/troubleshooting?hl=zh-cn)", "guide": "Google Cloud Observability"}