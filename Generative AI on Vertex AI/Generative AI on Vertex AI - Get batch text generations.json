{"title": "Generative AI on Vertex AI - Get batch text generations", "url": "https://cloud.google.com/vertex-ai/generative-ai/docs/text/batch-prediction-genai", "abstract": "# Generative AI on Vertex AI - Get batch text generations\nBatch predictions are a way to efficiently send large numbers of non-latency sensitive text prompts requests. Different from online prediction, where you are limited to one input request at a time, you can send a large number of LLM requests in a single batch request. Similar to how batch prediction is done for [tabular data in Vertex AI](/vertex-ai/docs/tabular-data/classification-regression/get-batch-predictions) , you determine your output location, add your input prompts, and your responses asynchronously populate in your output location.\nAfter you submit a batch request for a text model and review its results, you can tweak the model through model tuning. After tuning, you can submit your updated model for batch generations as usual. To learn more about tuning models, see [Tune foundation models](/vertex-ai/generative-ai/docs/models/tune-models) .\n", "content": "## Text models that support batch predictions\n- `text-bison`## Prepare your inputs\nThe input for batch requests specifies the items to send to your model for a batch generation. When using text classification on models you can use a JSON Lines file or a BigQuery table to specify a list of inputs. You store your BigQuery table in BigQuery and your JSON Lines file in Cloud Storage.\nBatch requests for text models only accept BigQuery storage sources and Cloud Storage. Requests can include up to 30,000 prompts.\nTo learn more about formatting, see:\n- [JSON Line](/vertex-ai/docs/predictions/get-batch-predictions#json-lines) \n- [BigQuery](/vertex-ai/docs/predictions/get-batch-predictions#bigquery) \n### JSONL example\n```\n{\"prompt\":\"Give a short description of a machine learning model:\"}{\"prompt\":\"Best recipe for banana bread:\"}\n```\n```\n{\"instance\":{\"prompt\":\"Give...\"},\"predictions\": [{\"content\":\"A machine\",\"safetyAttributes\":{...}}],\"status\":\"\"}{\"instance\":{\"prompt\":\"Best...\"},\"predictions\": [{\"content\":\"Sure\", \"safetyAttributes\":{...}}],\"status\":\"\"}\n```\n### BigQuery example\nThis example shows a single column BigQuery table.\n| prompt             |\n|:--------------------------------------------------------|\n| \"Give a short description of a machine learning model:\" |\n| \"Best recipe for banana bread:\"       |\n| prompt             | predictions                                               | status |\n|:--------------------------------------------------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------:|\n| \"Give a short description of a machine learning model:\" | '[{ \"content\": \"A machine learning model is a statistical method\", \"safetyAttributes\": { \"blocked\": false, \"scores\": [ 0.10000000149011612 ], \"categories\": [ \"Violent\" ] } }]'   |  nan |\n| \"Best recipe for banana bread:\"       | '[{\"content\": \"Sure, here is a recipe for banana bread:\\n\\nIngredients:\\n\\n*\", \"safetyAttributes\": { \"scores\": [ 0.10000000149011612 ], \"blocked\": false, \"categories\": [ \"Violent\" ] } }]' |  nan |\n## Request a batch response\nDepending on the number of input items that you've submitted, a batch generation task can take some time to complete.\nTo test a text prompt by using the Vertex AI API, send a POST request to the publisher model endpoint.\nBefore using any of the request data, make the following replacements:- : The name of your Google Cloud project.\n- : The job name.\n- : A map of model parameters. Some Acceptable parameters include:  maxOutputTokens, topK, topP, and temperature.\n- : The input source URI. This is either a BigQuery table URI or a JSONL  file URI in Cloud Storage.\n- : Output target URI.\nHTTP method and URL:\n```\nPOST https://us-central1-aiplatform.googleapis.com/v1/projects/PROJECT_ID/locations/us-central1/batchPredictionJobs\n```\nRequest JSON body:\n```\n{\n \"name\": \"BP_JOB_NAME\",\n \"displayName\": \"BP_JOB_NAME\",\n \"model\": \"publishers/google/models/text-bison\",\n \"model_parameters\": \"MODEL_PARAM\"\n \"inputConfig\": {\n  \"instancesFormat\":\"bigquery\",\n  \"bigquerySource\":{\n  \"inputUri\" : \"INPUT_URI\"\n  }\n },\n \"outputConfig\": {\n  \"predictionsFormat\":\"bigquery\",\n  \"bigqueryDestination\":{\n  \"outputUri\": \"OUTPUT_URI\"\n  }\n }\n}\n```\nTo send your request, choose one of these options:\n **Note:** The following command assumes that you have logged in to  the`gcloud`CLI with your user account by running [gcloud init](/sdk/gcloud/reference/init) or [gcloud auth login](/sdk/gcloud/reference/auth/login) ,  or by using [Cloud Shell](/shell/docs) ,  which automatically logs you into the`gcloud`CLI.  You can check the currently active account by running [gcloud auth list](/sdk/gcloud/reference/auth/list) .\nSave the request body in a file named `request.json` ,  and execute the following command:\n```\ncurl -X POST \\ -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\ -H \"Content-Type: application/json; charset=utf-8\" \\ -d @request.json \\ \"https://us-central1-aiplatform.googleapis.com/v1/projects/PROJECT_ID/locations/us-central1/batchPredictionJobs\"\n``` **Note:** The following command assumes that you have logged in to  the`gcloud`CLI with your user account by running [gcloud init](/sdk/gcloud/reference/init) or [gcloud auth login](/sdk/gcloud/reference/auth/login) ,  or by using [Cloud Shell](/shell/docs) ,  which automatically logs you into the`gcloud`CLI.  You can check the currently active account by running [gcloud auth list](/sdk/gcloud/reference/auth/list) .\nSave the request body in a file named `request.json` ,  and execute the following command:\n```\n$cred = gcloud auth print-access-token$headers = @{ \"Authorization\" = \"Bearer $cred\" }Invoke-WebRequest ` -Method POST ` -Headers $headers ` -ContentType: \"application/json; charset=utf-8\" ` -InFile request.json ` -Uri \"https://us-central1-aiplatform.googleapis.com/v1/projects/PROJECT_ID/locations/us-central1/batchPredictionJobs\" | Select-Object -Expand Content\n```\nYou should receive a JSON response similar to the following:\n```\n{\n \"name\": \"projects/{PROJECT_ID}/locations/us-central1/batchPredictionJobs/{BATCH_JOB_ID}\",\n \"displayName\": \"BP_sample_publisher_BQ_20230712_134650\",\n \"model\": \"projects/{PROJECT_ID}/locations/us-central1/models/text-bison\",\n \"inputConfig\": {\n \"instancesFormat\": \"bigquery\",\n \"bigquerySource\": {\n  \"inputUri\": \"bq://sample.text_input\"\n }\n },\n \"modelParameters\": {},\n \"outputConfig\": {\n \"predictionsFormat\": \"bigquery\",\n \"bigqueryDestination\": {\n  \"outputUri\": \"bq://sample.llm_dataset.embedding_out_BP_sample_publisher_BQ_20230712_134650\"\n }\n },\n \"state\": \"JOB_STATE_PENDING\",\n \"createTime\": \"2023-07-12T20:46:52.148717Z\",\n \"updateTime\": \"2023-07-12T20:46:52.148717Z\",\n \"labels\": {\n \"owner\": \"sample_owner\",\n \"product\": \"llm\"\n },\n \"modelVersionId\": \"1\",\n \"modelMonitoringStatus\": {}\n}\n```\nThe response includes a unique identifier for the batch job. You can poll for the status of the batch job using the until the job `state` is `JOB_STATE_SUCCEEDED` . For example:\n```\ncurl \\\u00a0 -X GET \\\u00a0 -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\\u00a0 -H \"Content-Type: application/json\" \\https://us-central1-aiplatform.googleapis.com/v1/projects/PROJECT_ID/locations/us-central1/batchPredictionJobs/BATCH_JOB_ID\n```\n **Note:** The concurrent job quota is 1 due to scarce backend resources. Custom Service account, live progress, CMEK, and VPCSC reports are not supported at this time.\nTo learn how to install or update the Python, see [Install the Vertex AI SDK for Python](/vertex-ai/docs/start/use-vertex-ai-python-sdk) .    For more information, see the [   Python API reference documentation](/python/docs/reference/aiplatform/latest) .\n```\nfrom vertexai.preview.language_models import TextGenerationModeltext_model = TextGenerationModel.from_pretrained(\"text-bison\")batch_prediction_job = text_model.batch_predict(\u00a0 source_uri=[\"gs://BUCKET_NAME/test_table.jsonl\"],\u00a0 destination_uri_prefix=\"gs://BUCKET_NAME/tmp/2023-05-25-vertex-LLM-Batch-Prediction/result3\",\u00a0 # Optional:\u00a0 model_parameters={\u00a0 \u00a0 \u00a0 \"maxOutputTokens\": \"200\",\u00a0 \u00a0 \u00a0 \"temperature\": \"0.2\",\u00a0 \u00a0 \u00a0 \"topP\": \"0.95\",\u00a0 \u00a0 \u00a0 \"topK\": \"40\",\u00a0 },)print(batch_prediction_job.display_name)print(batch_prediction_job.resource_name)print(batch_prediction_job.state)\n```\n## Retrieve batch output\nWhen a batch prediction task is complete, the output is stored in the Cloud Storage bucket or BigQuery table that you specified in your request.\n## What's next\n- Learn how to [test text prompts](/vertex-ai/generative-ai/docs/text/test-text-prompts) .\n- Learn other task-specific prompt design strategies for text:- [Summarization prompts](/vertex-ai/generative-ai/docs/text/text-prompts#summarization_prompts) \n- [Extraction prompts](/vertex-ai/generative-ai/docs/text/text-prompts#extraction_prompts) \n- Learn how to [tune a model](/vertex-ai/generative-ai/docs/models/tune-models) .", "guide": "Generative AI on Vertex AI"}