{"title": "Generative AI on Vertex AI - \u7372\u53d6\u6279\u91cf\u4ee3\u78bc\u9810\u6e2c\u7d50\u679c", "url": "https://cloud.google.com/vertex-ai/generative-ai/docs/code/batch-prediction-genai-code?hl=zh-cn", "abstract": "# Generative AI on Vertex AI - \u7372\u53d6\u6279\u91cf\u4ee3\u78bc\u9810\u6e2c\u7d50\u679c\n\u6279\u91cf\u7372\u53d6\u97ff\u61c9\u662f\u9ad8\u6548\u767c\u9001\u5927\u91cf\u4ee3\u78bc\u8acb\u6c42\u7684\u65b9\u6cd5\uff0c\u4f7f\u7528\u6b64\u65b9\u6cd5\u6642\u97ff\u61c9\u7684\u5ef6\u9072\u6642\u9593\u4e26\u4e0d\u91cd\u8981\u3002\u8207\u7372\u53d6\u5728\u7dda\u97ff\u61c9\uff08\u4e00\u6b21\u53ea\u80fd\u6709\u4e00\u500b\u8f38\u5165\u8acb\u6c42\uff09\u4e0d\u540c\uff0c\u6279\u91cf\u9810\u6e2c\u6703\u5728\u55ae\u500b\u6279\u91cf\u8acb\u6c42\u4e2d\u767c\u9001\u5927\u91cf\u4ee3\u78bc\u751f\u6210\u6a21\u578b\u8acb\u6c42\u3002\u8207\u91dd\u5c0d [Vertex AI \u4e0a\u7684\u751f\u6210\u5f0f AI \u4e2d\u7684\u8868\u683c\u6578\u64da](https://cloud.google.com/vertex-ai/docs/tabular-data/classification-regression/get-batch-predictions?hl=zh-cn) \u7684\u6279\u91cf\u9810\u6e2c\u4e00\u6a23\uff0c\u60a8\u53ef\u4ee5\u78ba\u5b9a\u8f38\u51fa\u4f4d\u7f6e\u4e26\u6dfb\u52a0\u8f38\u5165\uff0c\u7136\u5f8c\u97ff\u61c9\u5c07\u7570\u6b65\u586b\u5145\u5230\u8f38\u51fa\u4f4d\u7f6e\u3002\n\u5728\u63d0\u4ea4\u6279\u8655\u7406\u8acb\u6c42\u4e26\u67e5\u770b\u5176\u7d50\u679c\u5f8c\uff0c\u60a8\u53ef\u4ee5\u8abf\u512a\u4ee3\u78bc\u751f\u6210\u57fa\u790e\u6a21\u578b\uff0c\u4ee5\u6539\u5584\u7d50\u679c\u5728\u7279\u5b9a\u4efb\u52d9\u4e2d\u7684\u8868\u73fe\u3002\u8abf\u512a\u5f8c\uff0c\u60a8\u53ef\u4ee5\u63d0\u4ea4\u7d93\u904e\u8abf\u512a\u7684\u6a21\u578b\u4ee5\u9032\u884c\u6279\u91cf\u751f\u6210\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u8abf\u512a\u6a21\u578b\uff0c\u8acb\u53c3\u95b1 [\u8abf\u512a\u8a9e\u8a00\u57fa\u790e\u6a21\u578b](https://cloud.google.com/vertex-ai/generative-ai/docs/models/tune-code-models?hl=zh-cn) \u3002\n", "content": "## \u652f\u6301\u6279\u91cf\u9810\u6e2c\u7684\u4ee3\u78bc\u6a21\u578b\n- `code-bison`## \u6e96\u5099\u8f38\u5165\n\u6279\u91cf\u8acb\u6c42\u7684\u8f38\u5165\u662f\u53ef\u4ee5\u5b58\u5132\u5728 BigQuery \u8868\u4e2d\u6216\u4f5c\u7232 [JSON \u884c (JSONL)](https://jsonlines.org/) \u6587\u4ef6\u5b58\u5132\u5728 Cloud Storage \u4e2d\u7684\u63d0\u793a\u5217\u8868\u3002\u6bcf\u500b\u8acb\u6c42\u6700\u591a\u53ef\u5305\u542b 30,000 \u9805\u63d0\u793a\u3002\n### JSONL \u793a\u4f8b\n\u672c\u90e8\u5206\u5c55\u793a\u77ad\u5982\u4f55\u8a2d\u7f6e\u8f38\u5165\u548c\u8f38\u51fa JSONL \u6587\u4ef6\u683c\u5f0f\u7684\u793a\u4f8b\u3002\n```\n{\"prefix\":\"Write a Python function that determines if a year is a leap year:\"}{\"prefix\":\"Write a unit test for Python code that reverses a string:\"}\n```\n```\n{\"instance\":{\"prefix\":\"Write...\"},\"predictions\": [{\"content\":\"def is_leap_year(year):...\",\"safetyAttributes\":{...}}],\"status\":\"\"}{\"instance\":{\"prefix\":\"Write...\"},\"predictions\": [{\"content\":\"import unittest...\", \"safetyAttributes\":{...}}],\"status\":\"\"}\n```\n### BigQuery \u793a\u4f8b\n\u672c\u90e8\u5206\u4ecb\u7d39\u5982\u4f55\u8a2d\u7f6e BigQuery \u8f38\u5165\u548c\u8f38\u51fa\u7684\u683c\u5f0f\u3002\n\u6b64\u793a\u4f8b\u5c55\u793a\u4e86\u4e00\u500b\u55ae\u5217 BigQuery \u8868\u3002\n| \u524d\u7db4          |\n|:-----------------------------------------|\n| \u201c\u7de8\u5beb Python \u51fd\u6578\u4ee5\u78ba\u5b9a\u67d0\u4e00\u5e74\u662f\u5426\u7232\u958f\u5e74\u201d |\n| \u201c\u7232\u53cd\u8f49\u5b57\u7b26\u4e32\u7684 Python \u4ee3\u78bc\u7de8\u5beb\u55ae\u5143\u6e2c\u8a66\u201d |\n| \u524d\u7db4          | \u9810\u6e2c                                                                                                                                | \u72c0\u614b |\n|:-----------------------------------------|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------:|\n| \u201c\u7de8\u5beb Python \u51fd\u6578\u4ee5\u78ba\u5b9a\u67d0\u4e00\u5e74\u662f\u5426\u7232\u958f\u5e74\u201d | { \"predictions\": [ { \"safetyAttributes\": { \"scores\": [], \"blocked\": false, \"categories\": [] }, \"content\": \"```python\\ndef is_leap_year(year):\\n \\\"\\\"\\\"\\n Determine if a year is a leap year.\\n\\n Args:\\n year: The year to check.\\n\\n Returns:\\n True if the year is a leap year, False otherwise.\\n \\\"\\\"\\\"\\n\\n if year % 4 != 0:\\n return False\\n\\n if year % 100 == 0 and year % 400 != 0:\\n return False\\n\\n return True\\n```\", \"citationMetadata\": { \"citations\": [] }, \"score\": -1.5572503805160522 } ], }  | nan |\n| \u201c\u7232\u53cd\u8f49\u5b57\u7b26\u4e32\u7684 Python \u4ee3\u78bc\u7de8\u5beb\u55ae\u5143\u6e2c\u8a66\u201d | { \"predictions\": [ { \"safetyAttributes\": { \"scores\": [], \"blocked\": false, \"categories\": [] }, \"score\": -1.7523338794708252, \"citationMetadata\": { \"citations\": [] }, \"content\": \"```python\\nimport unittest\\n\\nclass TestReverseString(unittest.TestCase):\\n\\n def test_reverse_string(self):\\n input_string = \\\"Hello World\\\"\\n expected_output = \\\"dlroW olleH\\\"\\n output = reverse_string(input_string)\\n self.assertEqual(output, expected_output)\\n\\nif __name__ == '__main__':\\n unittest.main()\\n```\" } ], } | nan |\n## \u8acb\u6c42\u6279\u91cf\u97ff\u61c9\n\u60a8\u53ef\u4ee5\u4f7f\u7528 Google Cloud \u63a7\u5236\u6aaf\u6216 Python \u7248 Vertex AI SDK \u5275\u5efa\u4ee3\u78bc\u751f\u6210\u6279\u91cf\u97ff\u61c9\u3002\u63d0\u4ea4\u7684\u8f38\u5165\u9805\u8d8a\u591a\uff0c\u5b8c\u6210\u6279\u91cf\u751f\u6210\u904e\u7a0b\u6240\u9700\u7684\u6642\u9593\u5c31\u8d8a\u9577\u3002\n\u5982\u9700\u4f7f\u7528 Vertex AI API \u6e2c\u8a66\u4ee3\u78bc\u63d0\u793a\uff0c\u8acb\u5411\u767c\u4f48\u8005\u6a21\u578b\u7aef\u9ede\u767c\u9001 POST \u8acb\u6c42\u3002\n\u5728\u4f7f\u7528\u4efb\u4f55\u8acb\u6c42\u6578\u64da\u4e4b\u524d\uff0c\u8acb\u5148\u9032\u884c\u4ee5\u4e0b\u66ff\u63db\uff1a- \uff1a\u60a8\u7684 Google Cloud \u9805\u76ee\u7684\u540d\u7a31\u3002\n- \uff1a\u4f5c\u696d\u540d\u7a31\u3002\n- \uff1a\u6307\u5b9a\u6a21\u578b\u53c3\u6578\u53ca\u5176\u503c\u7684\u9375\u503c\u5c0d\u5217\u8868\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u6307\u5b9a\u6a21\u578b\u7684`maxOutputTokens`\u548c`temperature`\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u4ee3\u78bc\u751f\u6210\u53c3\u6578](https://cloud.google.com/vertex-ai/generative-ai/docs/model-reference/code-generation?hl=zh-cn#request_body) \u3002\n- \uff1a\u8f38\u5165\u6e90 URI\u3002\u8f38\u5165\u6e90\u662f BigQuery \u8868\u6216 Cloud Storage \u5b58\u5132\u6876\u4e2d\u7684 JSONL \u6587\u4ef6\u3002\n- \uff1a\u8f38\u51fa\u76ee\u6a19 URI\u3002\nHTTP \u65b9\u6cd5\u548c\u7db2\u5740\uff1a\n```\nPOST https://us-central1-aiplatform.googleapis.com/v1/projects/PROJECT_ID/locations/us-central1/batchPredictionJobs\n```\n\u8acb\u6c42 JSON \u6b63\u6587\uff1a\n```\n{\n \"name\": \"BP_JOB_NAME\",\n \"displayName\": \"BP_JOB_NAME\",\n \"model\": \"publishers/google/models/text-bison\",\n \"model_parameters\": \"MODEL_PARAM\"\n \"inputConfig\": {\n  \"instancesFormat\":\"bigquery\",\n  \"bigquerySource\":{\n  \"inputUri\" : \"INPUT_URI\"\n  }\n },\n \"outputConfig\": {\n  \"predictionsFormat\":\"bigquery\",\n  \"bigqueryDestination\":{\n  \"outputUri\": \"OUTPUT_URI\"\n }\n }\n}\n```\n\u5982\u9700\u767c\u9001\u8acb\u6c42\uff0c\u8acb\u9078\u64c7\u4ee5\u4e0b\u65b9\u5f0f\u4e4b\u4e00\uff1a\n **\u6ce8\u610f** \uff1a\u4ee5\u4e0b\u547d\u4ee4\u5047\u5b9a\u60a8\u5df2\u4f7f\u7528\u60a8\u7684\u7528\u6236\u8cec\u865f\u901a\u904e\u904b\u884c [gcloud init](https://cloud.google.com/sdk/gcloud/reference/init?hl=zh-cn) \u6216 [gcloud auth login](https://cloud.google.com/sdk/gcloud/reference/auth/login?hl=zh-cn) \u767b\u9304`gcloud`CLI\uff0c\u6216\u8005\u4f7f\u7528\u4e86 [Cloud Shell](https://cloud.google.com/shell/docs?hl=zh-cn) \uff0c\u9019\u6703\u4f7f\u60a8\u81ea\u52d5\u767b\u9304`gcloud`CLI\u3002\u60a8\u53ef\u4ee5\u904b\u884c [gcloud auth list](https://cloud.google.com/sdk/gcloud/reference/auth/list?hl=zh-cn) \u4f86\u6aa2\u67e5\u7576\u524d\u6d3b\u8e8d\u7684\u8cec\u865f\u3002\n\u5c07\u8acb\u6c42\u6b63\u6587\u4fdd\u5b58\u5728\u540d\u7232 `request.json` \u7684\u6587\u4ef6\u4e2d\uff0c\u7136\u5f8c\u57f7\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ncurl -X POST \\ -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\ -H \"Content-Type: application/json; charset=utf-8\" \\ -d @request.json \\ \"https://us-central1-aiplatform.googleapis.com/v1/projects/PROJECT_ID/locations/us-central1/batchPredictionJobs\"\n``` **\u6ce8\u610f** \uff1a\u4ee5\u4e0b\u547d\u4ee4\u5047\u5b9a\u60a8\u5df2\u4f7f\u7528\u60a8\u7684\u7528\u6236\u8cec\u865f\u901a\u904e\u904b\u884c [gcloud init](https://cloud.google.com/sdk/gcloud/reference/init?hl=zh-cn) \u6216 [gcloud auth login](https://cloud.google.com/sdk/gcloud/reference/auth/login?hl=zh-cn) \u767b\u9304`gcloud`CLI\uff0c\u6216\u8005\u4f7f\u7528\u4e86 [Cloud Shell](https://cloud.google.com/shell/docs?hl=zh-cn) \uff0c\u9019\u6703\u4f7f\u60a8\u81ea\u52d5\u767b\u9304`gcloud`CLI\u3002\u60a8\u53ef\u4ee5\u904b\u884c [gcloud auth list](https://cloud.google.com/sdk/gcloud/reference/auth/list?hl=zh-cn) \u4f86\u6aa2\u67e5\u7576\u524d\u6d3b\u8e8d\u7684\u8cec\u865f\u3002\n\u5c07\u8acb\u6c42\u6b63\u6587\u4fdd\u5b58\u5728\u540d\u7232 `request.json` \u7684\u6587\u4ef6\u4e2d\uff0c\u7136\u5f8c\u57f7\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\n$cred = gcloud auth print-access-token$headers = @{ \"Authorization\" = \"Bearer $cred\" }Invoke-WebRequest ` -Method POST ` -Headers $headers ` -ContentType: \"application/json; charset=utf-8\" ` -InFile request.json ` -Uri \"https://us-central1-aiplatform.googleapis.com/v1/projects/PROJECT_ID/locations/us-central1/batchPredictionJobs\" | Select-Object -Expand Content\n```\n\u60a8\u61c9\u8a72\u6536\u5230\u985e\u4f3c\u4ee5\u4e0b\u5167\u5bb9\u7684 JSON \u97ff\u61c9\uff1a\n```\n{\n \"name\": \"projects/{PROJECT_ID}/locations/us-central1/batchPredictionJobs/{BATCH_JOB_ID}\",\n \"displayName\": \"BP_sample_publisher_BQ_20230712_134650\",\n \"model\": \"projects/{PROJECT_ID}/locations/us-central1/models/text-bison\",\n \"inputConfig\": {\n \"instancesFormat\": \"bigquery\",\n \"bigquerySource\": {\n  \"inputUri\": \"bq://sample.text_input\"\n }\n },\n \"modelParameters\": {},\n \"outputConfig\": {\n \"predictionsFormat\": \"bigquery\",\n \"bigqueryDestination\": {\n  \"outputUri\": \"bq://sample.llm_dataset.embedding_out_BP_sample_publisher_BQ_20230712_134650\"\n }\n },\n \"state\": \"JOB_STATE_PENDING\",\n \"createTime\": \"2023-07-12T20:46:52.148717Z\",\n \"updateTime\": \"2023-07-12T20:46:52.148717Z\",\n \"labels\": {\n \"owner\": \"sample_owner\",\n \"product\": \"llm\"\n },\n \"modelVersionId\": \"1\",\n \"modelMonitoringStatus\": {}\n}\n```\n\u97ff\u61c9\u5305\u542b\u6279\u91cf\u4f5c\u696d\u7684\u552f\u4e00\u6a19\u8b58\u7b26\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528 \u8f2a\u8a62\u6279\u91cf\u4f5c\u696d\u7684\u72c0\u614b\uff0c\u76f4\u5230\u4f5c\u696d `state` \u7232 `JOB_STATE_SUCCEEDED` \u3002 \u4f8b\u5982\uff1a\n```\ncurl \\\u00a0 -X GET \\\u00a0 -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\\u00a0 -H \"Content-Type: application/json\" \\https://us-central1-aiplatform.googleapis.com/v1/projects/PROJECT_ID/locations/us-central1/batchPredictionJobs/BATCH_JOB_ID\n```\n **\u6ce8\u610f** \uff1a\u4e00\u6b21\u53ea\u80fd\u904b\u884c\u4e00\u500b\u6279\u91cf\u97ff\u61c9\u4f5c\u696d\u3002\u76ee\u524d\u4e0d\u652f\u6301\u81ea\u5b9a\u7fa9\u670d\u52d9\u8cec\u865f\u3001\u5be6\u6642\u9032\u5ea6\u3001CMEK \u548c VPCSC \u5831\u544a\u3002\n\u5982\u9700\u77ad\u89e3\u5982\u4f55\u5b89\u88dd\u6216\u66f4\u65b0 Python\uff0c\u8acb\u53c3\u95b1 [\u5b89\u88dd Python \u7248 Vertex AI SDK](https://cloud.google.com/vertex-ai/docs/start/use-vertex-ai-python-sdk?hl=zh-cn) \u3002  \u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [   Python API \u53c3\u8003\u6587\u6a94](https://cloud.google.com/python/docs/reference/aiplatform/latest?hl=zh-cn) \u3002\n```\nfrom vertexai.preview.language_models import CodeGenerationModelcode_model = CodeGenerationModel.from_pretrained(\"code-bison\")batch_prediction_job = code_model.batch_predict(\u00a0 dataset=[\"gs://BUCKET_NAME/test_table.jsonl\"],\u00a0 destination_uri_prefix=\"gs://BUCKET_NAME/tmp/2023-05-25-vertex-LLM-Batch-Prediction/result3\",\u00a0 # Optional:\u00a0 model_parameters={\u00a0 \u00a0 \u00a0 \"maxOutputTokens\": \"200\",\u00a0 \u00a0 \u00a0 \"temperature\": \"0.2\",\u00a0 },)print(batch_prediction_job.display_name)print(batch_prediction_job.resource_name)print(batch_prediction_job.state)\n```\n## \u6aa2\u7d22\u6279\u91cf\u8f38\u51fa\n\u6279\u91cf\u9810\u6e2c\u4efb\u52d9\u5b8c\u6210\u5f8c\uff0c\u8f38\u51fa\u6703\u5b58\u5132\u5728\u60a8\u5728\u8acb\u6c42\u4e2d\u6307\u5b9a\u7684 Cloud Storage \u5b58\u5132\u6876\u6216 BigQuery \u8868\u4e2d\u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u77ad\u89e3\u5982\u4f55 [\u6e2c\u8a66\u4ee3\u78bc\u63d0\u793a](https://cloud.google.com/vertex-ai/generative-ai/docs/code/test-code-generation-prompts?hl=zh-cn) \u3002\n- \u67e5\u770b [\u4ee3\u78bc\u751f\u6210](https://cloud.google.com/vertex-ai/generative-ai/docs/model-reference/code-generation?hl=zh-cn) \u53c3\u8003\u9801\u9762\u3002", "guide": "Generative AI on Vertex AI"}