{"title": "Cloud Video Intelligence API - \u8996\u983b\u5206\u985e", "url": "https://cloud.google.com/video-intelligence/docs/streaming/video-classification?hl=zh-cn", "abstract": "# Cloud Video Intelligence API - \u8996\u983b\u5206\u985e\n**    Beta \u7248     ** \u6b64\u529f\u80fd\u9808\u9075\u5b88 [\u670d\u52d9\u5c08\u7528\u689d\u6b3e](https://cloud.google.com/terms/service-terms?hl=zh-cn#1) \u7684\u201c\u901a\u7528\u670d\u52d9\u689d\u6b3e\u201d\u90e8\u5206\u4e2d\u7684\u201c\u975e\u6b63\u5f0f\u7248\u7522\u54c1\u689d\u6b3e\u201d\u3002 \u975e\u6b63\u5f0f\u7248\u529f\u80fd\u201c\u6309\u539f\u6a23\u201d\u63d0\u4f9b\uff0c\u53ef\u80fd\u53ea\u80fd\u7372\u5f97\u6709\u9650\u7684\u652f\u6301\u3002 \u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u767c\u4f48\u968e\u6bb5\u8aaa\u660e](https://cloud.google.com/products?hl=zh-cn#product-launch-stages) \u3002\n\u8996\u983b\u5206\u985e\u53ef\u8b58\u5225\u7269\u9ad4\u3001\u4f4d\u7f6e\u3001\u6d3b\u52d5\u3001\u52d5\u7269\u54c1\u7a2e\u3001\u7522\u54c1\u7b49\u3002\n\u5982\u9700\u4f7f\u7528\u9810\u8a13\u7df4\u6a21\u578b\uff0c\u8acb\u53c3\u95b1 [\u5206\u6790\u6a19\u7c64](https://cloud.google.com/video-intelligence/docs/streaming/label-analysis?hl=zh-cn) \u3002\n", "content": "## \u4f7f\u7528 AutoML \u8996\u983b\n### \u6e96\u5099\u5de5\u4f5c\n\u5982\u9700\u77ad\u89e3\u5275\u5efa AutoML \u6a21\u578b\u7684\u80cc\u666f\u4fe1\u606f\uff0c\u8acb\u67e5\u770b Vertex AI [\u65b0\u624b\u6307\u5357](https://cloud.google.com/vertex-ai/docs/beginner/beginners-guide?hl=zh-cn#video) \u3002\u5982\u9700\u77ad\u89e3\u5982\u4f55\u5275\u5efa AutoML \u6a21\u578b\uff0c\u8acb\u53c3\u95b1 Vertex AI \u6587\u6a94\u201c\u958b\u767c\u548c\u4f7f\u7528\u6a5f\u5668\u5b78\u7fd2\u6a21\u578b\u201d\u4e2d\u7684 [\u8996\u983b\u6578\u64da](https://cloud.google.com/vertex-ai/docs/training-overview?hl=zh-cn#video_data) \u3002\n### \u4f7f\u7528\u60a8\u7684 AutoML \u6a21\u578b\n\u4ee5\u4e0b\u4ee3\u78bc\u793a\u4f8b\u6f14\u793a\u77ad\u5982\u4f55\u4f7f\u7528 [AutoML \u6a21\u578b](https://cloud.google.com/vertex-ai/docs/beginner/beginners-guide?hl=zh-cn#video) \uff0c\u901a\u904e\u6d41\u5f0f\u5ba2\u6236\u7aef\u5eab\u5be6\u73fe\u8996\u983b\u5206\u985e\u3002\n\u8981\u5411 Video Intelligence \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u8a2d\u7f6e\u61c9\u7528\u9ed8\u8a8d\u6191\u64da\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7232\u672c\u5730\u958b\u767c\u74b0\u5883\u8a2d\u7f6e\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/docs/authentication/provide-credentials-adc?hl=zh-cn#local-dev) \u3002\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/java-docs-samples/blob/HEAD/video/src/main/java/beta/video/StreamingAutoMlClassification.java) \n```\nimport com.google.api.gax.rpc.BidiStream;import com.google.cloud.videointelligence.v1p3beta1.LabelAnnotation;import com.google.cloud.videointelligence.v1p3beta1.LabelFrame;import com.google.cloud.videointelligence.v1p3beta1.StreamingAnnotateVideoRequest;import com.google.cloud.videointelligence.v1p3beta1.StreamingAnnotateVideoResponse;import com.google.cloud.videointelligence.v1p3beta1.StreamingAutomlClassificationConfig;import com.google.cloud.videointelligence.v1p3beta1.StreamingFeature;import com.google.cloud.videointelligence.v1p3beta1.StreamingVideoAnnotationResults;import com.google.cloud.videointelligence.v1p3beta1.StreamingVideoConfig;import com.google.cloud.videointelligence.v1p3beta1.StreamingVideoIntelligenceServiceClient;import com.google.protobuf.ByteString;import io.grpc.StatusRuntimeException;import java.io.IOException;import java.nio.file.Files;import java.nio.file.Path;import java.nio.file.Paths;import java.util.Arrays;import java.util.concurrent.TimeoutException;class StreamingAutoMlClassification {\u00a0 // Perform streaming video classification with an AutoML Model\u00a0 static void streamingAutoMlClassification(String filePath, String projectId, String modelId)\u00a0 \u00a0 \u00a0 throws TimeoutException, StatusRuntimeException, IOException {\u00a0 \u00a0 // String filePath = \"path_to_your_video_file\";\u00a0 \u00a0 // String projectId = \"YOUR_GCP_PROJECT_ID\";\u00a0 \u00a0 // String modelId = \"YOUR_AUTO_ML_CLASSIFICATION_MODEL_ID\";\u00a0 \u00a0 try (StreamingVideoIntelligenceServiceClient client =\u00a0 \u00a0 \u00a0 \u00a0 StreamingVideoIntelligenceServiceClient.create()) {\u00a0 \u00a0 \u00a0 Path path = Paths.get(filePath);\u00a0 \u00a0 \u00a0 byte[] data = Files.readAllBytes(path);\u00a0 \u00a0 \u00a0 // Set the chunk size to 5MB (recommended less than 10MB).\u00a0 \u00a0 \u00a0 int chunkSize = 5 * 1024 * 1024;\u00a0 \u00a0 \u00a0 int numChunks = (int) Math.ceil((double) data.length / chunkSize);\u00a0 \u00a0 \u00a0 String modelPath =\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 String.format(\"projects/%s/locations/us-central1/models/%s\", projectId, modelId);\u00a0 \u00a0 \u00a0 System.out.println(modelPath);\u00a0 \u00a0 \u00a0 StreamingAutomlClassificationConfig streamingAutomlClassificationConfig =\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 StreamingAutomlClassificationConfig.newBuilder().setModelName(modelPath).build();\u00a0 \u00a0 \u00a0 StreamingVideoConfig streamingVideoConfig =\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 StreamingVideoConfig.newBuilder()\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .setFeature(StreamingFeature.STREAMING_AUTOML_CLASSIFICATION)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .setAutomlClassificationConfig(streamingAutomlClassificationConfig)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .build();\u00a0 \u00a0 \u00a0 BidiStream<StreamingAnnotateVideoRequest, StreamingAnnotateVideoResponse> call =\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 client.streamingAnnotateVideoCallable().call();\u00a0 \u00a0 \u00a0 // The first request must **only** contain the audio configuration:\u00a0 \u00a0 \u00a0 call.send(\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 StreamingAnnotateVideoRequest.newBuilder().setVideoConfig(streamingVideoConfig).build());\u00a0 \u00a0 \u00a0 // Subsequent requests must **only** contain the audio data.\u00a0 \u00a0 \u00a0 // Send the requests in chunks\u00a0 \u00a0 \u00a0 for (int i = 0; i < numChunks; i++) {\u00a0 \u00a0 \u00a0 \u00a0 call.send(\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 StreamingAnnotateVideoRequest.newBuilder()\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .setInputContent(\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ByteString.copyFrom(\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Arrays.copyOfRange(data, i * chunkSize, i * chunkSize + chunkSize)))\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .build());\u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 // Tell the service you are done sending data\u00a0 \u00a0 \u00a0 call.closeSend();\u00a0 \u00a0 \u00a0 for (StreamingAnnotateVideoResponse response : call) {\u00a0 \u00a0 \u00a0 \u00a0 if (response.hasError()) {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 System.out.println(response.getError().getMessage());\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 break;\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 StreamingVideoAnnotationResults annotationResults = response.getAnnotationResults();\u00a0 \u00a0 \u00a0 \u00a0 for (LabelAnnotation annotation : annotationResults.getLabelAnnotationsList()) {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 String entity = annotation.getEntity().getDescription();\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 // There is only one frame per annotation\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 LabelFrame labelFrame = annotation.getFrames(0);\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 double offset =\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 labelFrame.getTimeOffset().getSeconds() + labelFrame.getTimeOffset().getNanos() / 1e9;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 float confidence = labelFrame.getConfidence();\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 System.out.format(\"At %fs segment: %s (%f)\\n\", offset, entity, confidence);\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 System.out.println(\"Video streamed successfully.\");\u00a0 \u00a0 }\u00a0 }}\n```\u8981\u5411 Video Intelligence \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u8a2d\u7f6e\u61c9\u7528\u9ed8\u8a8d\u6191\u64da\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7232\u672c\u5730\u958b\u767c\u74b0\u5883\u8a2d\u7f6e\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/docs/authentication/provide-credentials-adc?hl=zh-cn#local-dev) \u3002\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/nodejs-docs-samples/blob/HEAD/video-intelligence/analyze-streaming-automl-classification.js) \n```\n/**\u00a0* TODO(developer): Uncomment these variables before running the sample.\u00a0*/// const path = 'Local file to analyze, e.g. ./my-file.mp4';// const modelId = 'autoMl model'// const projectId = 'Your GCP Project'const {StreamingVideoIntelligenceServiceClient} =\u00a0 require('@google-cloud/video-intelligence').v1p3beta1;const fs = require('fs');// Instantiates a clientconst client = new StreamingVideoIntelligenceServiceClient();// Streaming configurationconst modelPath = `projects/${projectId}/locations/us-central1/models/${modelId}`;const configRequest = {\u00a0 videoConfig: {\u00a0 \u00a0 feature: 'STREAMING_AUTOML_CLASSIFICATION',\u00a0 \u00a0 automlClassificationConfig: {\u00a0 \u00a0 \u00a0 modelName: modelPath,\u00a0 \u00a0 },\u00a0 },};const readStream = fs.createReadStream(path, {\u00a0 highWaterMark: 5 * 1024 * 1024, //chunk size set to 5MB (recommended less than 10MB)\u00a0 encoding: 'base64',});//Load file content// Note: Input videos must have supported video codecs. See// https://cloud.google.com/video-intelligence/docs/streaming/streaming#supported_video_codecs// for more details.const chunks = [];readStream\u00a0 .on('data', chunk => {\u00a0 \u00a0 const request = {\u00a0 \u00a0 \u00a0 inputContent: chunk.toString(),\u00a0 \u00a0 };\u00a0 \u00a0 chunks.push(request);\u00a0 })\u00a0 .on('close', () => {\u00a0 \u00a0 // configRequest should be the first in the stream of requests\u00a0 \u00a0 stream.write(configRequest);\u00a0 \u00a0 for (let i = 0; i < chunks.length; i++) {\u00a0 \u00a0 \u00a0 stream.write(chunks[i]);\u00a0 \u00a0 }\u00a0 \u00a0 stream.end();\u00a0 });const stream = client\u00a0 .streamingAnnotateVideo()\u00a0 .on('data', response => {\u00a0 \u00a0 //Gets annotations for video\u00a0 \u00a0 const annotations = response.annotationResults;\u00a0 \u00a0 const labels = annotations.labelAnnotations;\u00a0 \u00a0 labels.forEach(label => {\u00a0 \u00a0 \u00a0 console.log(\u00a0 \u00a0 \u00a0 \u00a0 `Label ${label.entity.description} occurs at: ${\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 label.frames[0].timeOffset.seconds || 0\u00a0 \u00a0 \u00a0 \u00a0 }` + `.${(label.frames[0].timeOffset.nanos / 1e6).toFixed(0)}s`\u00a0 \u00a0 \u00a0 );\u00a0 \u00a0 \u00a0 console.log(` Confidence: ${label.frames[0].confidence}`);\u00a0 \u00a0 });\u00a0 })\u00a0 .on('error', response => {\u00a0 \u00a0 console.error(response);\u00a0 });\n```\u8981\u5411 Video Intelligence \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u8a2d\u7f6e\u61c9\u7528\u9ed8\u8a8d\u6191\u64da\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7232\u672c\u5730\u958b\u767c\u74b0\u5883\u8a2d\u7f6e\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/docs/authentication/provide-credentials-adc?hl=zh-cn#local-dev) \u3002\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/python-docs-samples/blob/HEAD/videointelligence/samples/analyze/beta_snippets.py) \n```\nimport iofrom google.cloud import videointelligence_v1p3beta1 as videointelligence# path = 'path_to_file'# project_id = 'gcp_project_id'# model_id = 'automl_classification_model_id'client = videointelligence.StreamingVideoIntelligenceServiceClient()model_path = \"projects/{}/locations/us-central1/models/{}\".format(\u00a0 \u00a0 project_id, model_id)# Here we use classification as an example.automl_config = videointelligence.StreamingAutomlClassificationConfig(\u00a0 \u00a0 model_name=model_path)video_config = videointelligence.StreamingVideoConfig(\u00a0 \u00a0 feature=videointelligence.StreamingFeature.STREAMING_AUTOML_CLASSIFICATION,\u00a0 \u00a0 automl_classification_config=automl_config,)# config_request should be the first in the stream of requests.config_request = videointelligence.StreamingAnnotateVideoRequest(\u00a0 \u00a0 video_config=video_config)# Set the chunk size to 5MB (recommended less than 10MB).chunk_size = 5 * 1024 * 1024# Load file content.# Note: Input videos must have supported video codecs. See# https://cloud.google.com/video-intelligence/docs/streaming/streaming#supported_video_codecs# for more details.stream = []with io.open(path, \"rb\") as video_file:\u00a0 \u00a0 while True:\u00a0 \u00a0 \u00a0 \u00a0 data = video_file.read(chunk_size)\u00a0 \u00a0 \u00a0 \u00a0 if not data:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 break\u00a0 \u00a0 \u00a0 \u00a0 stream.append(data)def stream_generator():\u00a0 \u00a0 yield config_request\u00a0 \u00a0 for chunk in stream:\u00a0 \u00a0 \u00a0 \u00a0 yield videointelligence.StreamingAnnotateVideoRequest(input_content=chunk)requests = stream_generator()# streaming_annotate_video returns a generator.# The default timeout is about 300 seconds.# To process longer videos it should be set to# larger than the length (in seconds) of the stream.responses = client.streaming_annotate_video(requests, timeout=600)for response in responses:\u00a0 \u00a0 # Check for errors.\u00a0 \u00a0 if response.error.message:\u00a0 \u00a0 \u00a0 \u00a0 print(response.error.message)\u00a0 \u00a0 \u00a0 \u00a0 break\u00a0 \u00a0 for label in response.annotation_results.label_annotations:\u00a0 \u00a0 \u00a0 \u00a0 for frame in label.frames:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 print(\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"At {:3d}s segment, {:5.1%} {}\".format(\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 frame.time_offset.seconds,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 frame.confidence,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 label.entity.entity_id,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 )\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 )\n```", "guide": "Cloud Video Intelligence API"}