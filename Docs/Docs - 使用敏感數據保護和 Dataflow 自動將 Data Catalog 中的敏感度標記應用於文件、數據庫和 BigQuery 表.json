{"title": "Docs - \u4f7f\u7528\u654f\u611f\u6578\u64da\u4fdd\u8b77\u548c Dataflow \u81ea\u52d5\u5c07 Data Catalog \u4e2d\u7684\u654f\u611f\u5ea6\u6a19\u8a18\u61c9\u7528\u65bc\u6587\u4ef6\u3001\u6578\u64da\u5eab\u548c BigQuery \u8868", "url": "https://cloud.google.com/architecture/automatically-apply-sensitivity-tags-in-data-catalog?hl=zh-cn", "abstract": "# Docs - \u4f7f\u7528\u654f\u611f\u6578\u64da\u4fdd\u8b77\u548c Dataflow \u81ea\u52d5\u5c07 Data Catalog \u4e2d\u7684\u654f\u611f\u5ea6\u6a19\u8a18\u61c9\u7528\u65bc\u6587\u4ef6\u3001\u6578\u64da\u5eab\u548c BigQuery \u8868\nLast reviewed 2022-01-11 UTC\n\u672c\u6587\u6a94\u4ecb\u7d39\u77ad\u5982\u4f55\u5c07\n [Data Catalog](https://cloud.google.com/data-catalog?hl=zh-cn) \n\u8207\u81ea\u52d5 Dataflow \u6d41\u6c34\u7dda\u642d\u914d\u4f7f\u7528\uff0c\u4ee5\u8b58\u5225\n [\u6578\u64da\u654f\u611f\u5ea6](https://cloud.google.com/dlp/docs/sensitivity-risk-calculation?hl=zh-cn) \n\u6a19\u8a18\u4e26\u5c07\u5176\u61c9\u7528\u65bc Cloud Storage \u6587\u4ef6\u3001\u95dc\u4fc2\u578b\u6578\u64da\u5eab\uff08\u5982 MySQL\u3001PostgreSQL \u7b49\uff09\u548c\n [BigQuery](https://cloud.google.com/bigquery?hl=zh-cn) \n\u4e2d\u7684\u6578\u64da\u3002\n\u6b64 Dataflow \u6d41\u6c34\u7dda\u4f7f\u7528 [\u654f\u611f\u6578\u64da\u4fdd\u8b77](https://cloud.google.com/dlp?hl=zh-cn) \u4f86\u6aa2\u6e2c\u500b\u4eba\u8eab\u4efd\u4fe1\u606f (PII) \u7b49\u654f\u611f\u6578\u64da\uff0c\u7136\u5f8c\u5c0d Data Catalog \u4e2d\u7684\u767c\u73fe\u7d50\u679c\u9032\u884c\u6a19\u8a18\u3002\n\u672c\u6587\u6a94\u4e2d\u6240\u8ff0\u7684\u89e3\u6c7a\u65b9\u6848\u57fa\u65bc\u5176\u914d\u5957\u6587\u6a94\u4e2d\u6240\u8ff0\u7684\u57fa\u65bc\u6587\u4ef6\u7684\u4ee4\u724c\u5316\u89e3\u6c7a\u65b9\u6848\u7684\u67b6\u69cb\u9032\u884c\u69cb\u5efa\uff1a [\u4f7f\u7528\u654f\u611f\u6578\u64da\u4fdd\u8b77\u3001Cloud Key Management Service \u548c Dataflow \u81ea\u52d5\u5c0d\u57fa\u65bc\u6587\u4ef6\u7684\u654f\u611f\u6578\u64da\u9032\u884c\u4ee4\u724c\u5316\u8655\u7406](https://cloud.google.com/community/tutorials/auto-data-tokenize?hl=zh-cn) \u3002\u9019\u5169\u500b\u6587\u6a94\u7684\u4e3b\u8981\u5340\u5225\u5728\u65bc\u672c\u6587\u6a94\u4ecb\u7d39\u7684\u89e3\u6c7a\u65b9\u6848\u9084\u6703\u4f7f\u7528\u4f86\u6e90\u548c\u6578\u64da\u654f\u611f\u5ea6\u6a19\u8a18\u67b6\u69cb\u7232\u654f\u611f\u6578\u64da\u4fdd\u8b77\u9aee\u73fe\u7d50\u679c\u5275\u5efa Data Catalog \u689d\u76ee\u3002\u6b64\u5916\uff0c\u5b83\u9084\u4f7f\u7528 [Java \u6578\u64da\u5eab\u9023\u63a5 (JDBC)](https://wikipedia.org/wiki/Java_Database_Connectivity) \u9023\u63a5\u4f86\u6aa2\u67e5\u95dc\u4fc2\u578b\u6578\u64da\u5eab\u3002\n\u672c\u6587\u6a94\u9069\u7528\u65bc\u8ca0\u8cac\u6578\u64da\u5b89\u5168\u3001\u6578\u64da\u6cbb\u7406\u3001\u6578\u64da\u8655\u7406\u6216\u6578\u64da\u5206\u6790\u7684\u6280\u8853\u578b\u53d7\u8846\u3002\u672c\u6587\u6a94\u5047\u5b9a\u60a8\u719f\u6089\u6578\u64da\u8655\u7406\u548c\u6578\u64da\u96b1\u79c1\uff0c\u800c\u7121\u9700\u6210\u7232\u5c08\u5bb6\u3002\u53e6\u5916\u9084\u5047\u5b9a\u60a8\u5c0d Shell \u8173\u672c\u6709\u4e00\u5b9a\u7684\u77ad\u89e3\uff0c\u4e26\u5c0d Google Cloud \u6709\u57fa\u672c\u7684\u77ad\u89e3\u3002", "content": "## \u67b6\u69cb\u6b64\u67b6\u69cb\u5b9a\u7fa9\u4e86\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\u7684\u6d41\u6c34\u7dda\uff1a- \u4f7f\u7528 JDBC \u5f9e\u95dc\u4fc2\u578b\u6578\u64da\u5eab\u4e2d\u63d0\u53d6\u6578\u64da\u3002\n- \u4f7f\u7528\u6578\u64da\u5eab\u7684`LIMIT`\u5b50\u53e5\u5c0d\u8a18\u9304\u9032\u884c\u63a1\u6a23\u3002\n- \u901a\u904e Cloud Data Loss Prevention API\uff08\u5c6c\u65bc\u654f\u611f\u6578\u64da\u4fdd\u8b77\uff09\u8655\u7406\u8a18\u9304\uff0c\u4ee5\u8b58\u5225\u654f\u611f\u985e\u5225\u3002\n- \u5c07\u767c\u73fe\u7d50\u679c\u4fdd\u5b58\u5230 BigQuery \u8868\u548c Data Catalog\u3002\n\u4e0b\u5716\u5c55\u793a\u4e86\u6d41\u6c34\u7dda\u57f7\u884c\u7684\u64cd\u4f5c\uff1a\u8a72\u89e3\u6c7a\u65b9\u6848\u4f7f\u7528 JDBC \u9023\u63a5\u8a2a\u554f\u95dc\u4fc2\u578b\u6578\u64da\u5eab\u3002\u4f7f\u7528 BigQuery \u8868\u4f5c\u7232\u6578\u64da\u6e90\u6642\uff0c\u8a72\u89e3\u6c7a\u65b9\u6848\u4f7f\u7528 [BigQuery Storage API](https://cloud.google.com/bigquery/docs/reference/storage?hl=zh-cn) \u7e2e\u77ed\u52a0\u8f09\u6642\u9593\u3002\n \u63a1\u6a23\u548c\u8b58\u5225\u6d41\u6c34\u7dda\u5c07\u4ee5\u4e0b\u6587\u4ef6\u8f38\u51fa\u5230 Cloud Storage\uff1a- \u6e90\u67b6\u69cb\u7684 Avro \u67b6\u69cb\uff08\u7b49\u6548\uff09\n- \u6aa2\u6e2c\u5230\u7684\u6bcf\u500b\u8f38\u5165\u5217\uff08`PERSON_NAME`\u3001`PHONE_NUMBER`\u548c`STREET_ADDRESS`\uff09\u7684 [infoTypes \u6578\u64da](https://cloud.google.com/dlp/docs/infotypes-reference?hl=zh-cn) \n\u6b64\u89e3\u6c7a\u65b9\u6848\u4f7f\u7528 [\u8a18\u9304\u5c55\u5e73](https://cloud.google.com/community/tutorials/auto-data-tokenize?hl=zh-cn#concepts) \u529f\u80fd\u4f86\u8655\u7406\u8a18\u9304\u4e2d\u7684\u5d4c\u5957\u5b57\u6bb5\u548c\u91cd\u8907\u5b57\u6bb5\u3002\n## \u76ee\u6a19\n- \u5275\u5efa Data Catalog \u6a19\u8a18\u548c\u5be6\u9ad4\u7d44\n- \u90e8\u7f72\u63a1\u6a23\u548c\u8b58\u5225\u6d41\u6c34\u7dda\n- \u5275\u5efa\u81ea\u5b9a\u7fa9 Data Catalog \u5be6\u9ad4\n- \u5c07\u654f\u611f\u5ea6\u6a19\u8a18\u61c9\u7528\u65bc\u81ea\u5b9a\u7fa9 Data Catalog \u5be6\u9ad4\n- \u9a57\u8b49\u654f\u611f\u5ea6\u6a19\u8a18\u6578\u64da\u662f\u5426\u4e5f\u5728 BigQuery \u4e2d\n## \u8cbb\u7528\nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728\u672c\u6587\u6a94\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Google Cloud \u7684\u4ee5\u4e0b\u6536\u8cbb\u7d44\u4ef6\uff1a- [\u654f\u611f\u6578\u64da\u4fdd\u8b77](https://cloud.google.com/dlp/pricing?hl=zh-cn) \n- [Cloud SQL](https://cloud.google.com/sql/pricing?hl=zh-cn) \n- [Cloud Storage](https://cloud.google.com/storage/pricing?hl=zh-cn) \n- [Dataflow](https://cloud.google.com/dataflow/pricing?hl=zh-cn) \n- [Data Catalog](https://cloud.google.com/dataplex/pricing?hl=zh-cn#data-catalog-pricing) \n\u60a8\u53ef\u4f7f\u7528 [\u50f9\u683c\u8a08\u7b97\u5668](https://cloud.google.com/products/calculator?hl=zh-cn) \u6839\u64da\u60a8\u7684\u9810\u8a08\u4f7f\u7528\u60c5\u6cc1\u4f86\u4f30\u7b97\u8cbb\u7528\u3002 \n## \u6e96\u5099\u5de5\u4f5c- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u6fc0\u6d3b Cloud Shell\u3002 [\u6fc0\u6d3b Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn)  [Cloud Shell](https://cloud.google.com/shell/docs/how-cloud-shell-works?hl=zh-cn) \u6703\u8a71\u96a8\u5373\u6703\u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5e95\u90e8\u5553\u52d5\uff0c\u4e26\u986f\u793a\u547d\u4ee4\u884c\u63d0\u793a\u7b26\u3002Cloud Shell \u662f\u4e00\u500b\u5df2\u5b89\u88dd Google Cloud CLI \u4e14\u5df2\u7232\u7576\u524d\u9805\u76ee\u8a2d\u7f6e\u503c\u7684 Shell \u74b0\u5883\u3002\u8a72\u6703\u8a71\u53ef\u80fd\u9700\u8981\u5e7e\u79d2\u9418\u6642\u9593\u4f86\u5b8c\u6210\u521d\u59cb\u5316\u3002\n## \u8a2d\u7f6e\u60a8\u7684\u74b0\u5883\n- \u5728 Cloud Shell \u4e2d\uff0c\u514b\u9686\u6e90\u4ee3\u78bc\u5eab\uff0c\u7136\u5f8c\u524d\u5f80\u514b\u9686\u6587\u4ef6\u7684\u76ee\u9304\uff1a```\ngit clone https://github.com/GoogleCloudPlatform/auto-data-tokenize.gitcd auto-data-tokenize/\n```\n- \u4f7f\u7528\u6587\u672c\u7de8\u8f2f\u5668\u4fee\u6539 `set_variables.sh` \u8173\u672c\u4ee5\u8a2d\u7f6e\u6240\u9700\u7684\u74b0\u5883\u8b8a\u91cf\u3002\u5ffd\u7565\u8173\u672c\u4e2d\u7684\u5176\u4ed6\u8b8a\u91cf\u3002 \u5b83\u5011\u8207\u672c\u6587\u6a94\u7121\u95dc\u3002```\n# The Google Cloud project to use:\nexport PROJECT_ID=\"PROJECT_ID\"\n# The Compute Engine region to use for running dataflow jobs and create a\n# temporary storage bucket:\nexport REGION_ID= \"REGION_ID\"\n# The Cloud Storage bucket to use as a temporary bucket for Dataflow:\nexport TEMP_GCS_BUCKET=\"CLOUD_STORAGE_BUCKET_NAME\"\n# Name of the service account to use (not the email address)\n# (For example, tokenizing-runner):\nexport DLP_RUNNER_SERVICE_ACCOUNT_NAME=\"DLP_RUNNER_SERVICE_ACCOUNT_NAME\"\n# Entry Group ID to use for creating/searching for Entries\n# in Data Catalog for non-BigQuery entries.\n# The ID must begin with a letter or underscore, contain only English\n# letters, numbers and underscores, and have 64 characters or fewer.\nexport\nDATA_CATALOG_ENTRY_GROUP_ID=\"DATA_CATALOG_ENTRY_GROUP_ID\"\n# The Data Catalog Tag Template ID to use\n# for creating sensitivity tags in Data Catalog.\n# The ID must contain only lowercase letters (a-z), numbers (0-9), or\n# underscores (_), and must start with a letter or underscore.\n# The maximum size is 64 bytes when encoded in UTF-8\nexport INSPECTION_TAG_TEMPLATE_ID=\"INSPECTION_TAG_TEMPLATE_ID\"\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- \uff1a\u60a8\u7684\u9805\u76ee ID\u3002\n- \uff1a\u5305\u542b\u4e00\u500b\u6216\u591a\u500b\u5b58\u5132\u6876\u7684\u5340\u57df\u3002\u9078\u64c7 [Data Catalog \u5340\u57df](https://cloud.google.com/data-catalog/docs/concepts/regions?hl=zh-cn) \u4e2d\u7684\u4f4d\u7f6e\u3002\n- \uff1a\u5b58\u5132\u6876\u7684\u540d\u7a31\u3002\n- \uff1a\u60a8\u7684\u670d\u52d9\u8cec\u865f\u7684\u540d\u7a31\u3002\n- \uff1a\u975e BigQuery \u6578\u64da\u76ee\u9304\u689d\u76ee\u7d44\u7684\u540d\u7a31\u3002\n- \uff1a\u60a8\u7232 Data Catalog \u6a19\u8a18\u6a21\u677f\u6307\u5b9a\u7684\u540d\u7a31\n- \u904b\u884c\u8a72\u8173\u672c\u4ee5\u8a2d\u7f6e\u74b0\u5883\u8b8a\u91cf\uff1a```\nsource set_variables.sh\n```\n## \u5275\u5efa\u8cc7\u6e90\u672c\u6587\u6a94\u4e2d\u4ecb\u7d39\u7684\u67b6\u69cb\u4f7f\u7528\u4ee5\u4e0b\u8cc7\u6e90\uff1a- \u7528\u65bc\u904b\u884c Dataflow \u6d41\u6c34\u7dda\u7684\u670d\u52d9\u8cec\u865f\uff0c\u4ee5\u4fbf\u5553\u7528\u7cbe\u7d30\u7684\u8a2a\u554f\u6b0a\u9650\u63a7\u5236\n- \u7528\u65bc\u5b58\u5132\u81e8\u6642\u6578\u64da\u548c\u6e2c\u8a66\u6578\u64da\u7684 Cloud Storage \u5b58\u5132\u6876\n- \u7528\u65bc\u5c07\u654f\u611f\u5ea6\u6a19\u8a18\u9644\u52a0\u5230\u689d\u76ee\u7684 Data Catalog \u6a19\u8a18\u6a21\u677f\n- \u4f5c\u7232 JDBC \u4f86\u6e90\u7684 MySQL on Cloud SQL \u5be6\u4f8b\n### \u5275\u5efa\u670d\u52d9\u8cec\u865f\u6211\u5011\u5efa\u8b70\u60a8\u904b\u884c\u5177\u6709\u7cbe\u7d30\u8a2a\u554f\u6b0a\u9650\u63a7\u5236\u7684\u6d41\u6c34\u7dda\u4ee5\u6539\u9032\u8a2a\u554f\u5206\u5340\u3002\u5982\u679c\u60a8\u7684\u9805\u76ee\u6c92\u6709\u7528\u6236\u5275\u5efa\u7684\u670d\u52d9\u8cec\u865f\uff0c\u8acb\u5275\u5efa\u4e00\u500b\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa\u4e00\u500b\u670d\u52d9\u8cec\u865f\u4f86\u7528\u4f5c Dataflow \u7684\u7528\u6236\u7ba1\u7406\u63a7\u5236\u5668\u7684\u670d\u52d9\u8cec\u865f\uff1a```\n\u00a0 gcloud iam service-accounts create ${DLP_RUNNER_SERVICE_ACCOUNT_NAME} \\\u00a0 --project=\"${PROJECT_ID}\" \\\u00a0 --description=\"Service Account for Sampling and Cataloging pipelines.\" \\\u00a0 --display-name=\"Sampling and Cataloging pipelines\"\n```\n- \u5275\u5efa\u5177\u6709\u8a2a\u554f\u654f\u611f\u6578\u64da\u4fdd\u8b77\u3001Dataflow\u3001Cloud SQL \u548c Data Catalog \u6240\u9700\u6b0a\u9650\u7684\u81ea\u5b9a\u7fa9\u89d2\u8272\uff1a```\n\u00a0 export SAMPLING_CATALOGING_ROLE_NAME=\"sampling_cataloging_runner\"\u00a0 gcloud iam roles create ${SAMPLING_CATALOGING_ROLE_NAME} \\\u00a0 --project=\"${PROJECT_ID}\" \\\u00a0 --file=tokenizing_runner_permissions.yaml\n```\n- \u5c07\u81ea\u5b9a\u7fa9\u89d2\u8272\u548c Dataflow Worker \u89d2\u8272\u61c9\u7528\u65bc\u8a72\u670d\u52d9\u8cec\u865f\uff0c\u4f7f\u5176\u4ee5 Dataflow \u5de5\u4f5c\u5668\u8eab\u4efd\u904b\u884c\uff1a```\n\u00a0 gcloud projects add-iam-policy-binding ${PROJECT_ID} \\\u00a0 --member=\"serviceAccount:${DLP_RUNNER_SERVICE_ACCOUNT_EMAIL}\" \\\u00a0 --role=projects/${PROJECT_ID}/roles/${SAMPLING_CATALOGING_ROLE_NAME}\u00a0 gcloud projects add-iam-policy-binding ${PROJECT_ID} \\\u00a0 --member=\"serviceAccount:${DLP_RUNNER_SERVICE_ACCOUNT_EMAIL}\" \\\u00a0 --role=roles/dataflow.worker\n```\n### \u5275\u5efa Cloud Storage \u5b58\u5132\u5206\u5340\n- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa\u4e00\u500b Cloud Storage \u5b58\u5132\u6876\u4ee5\u5b58\u5132\u6e2c\u8a66\u6578\u64da\u548c\u4f5c\u7232 Dataflow \u66ab\u5b58\u4f4d\u7f6e\uff1a```\ngsutil mb -p ${PROJECT_ID} -l ${REGION_ID} \"gs://${TEMP_GCS_BUCKET}\"\n```\n### \u5275\u5efa Data Catalog \u689d\u76ee\u7d44Data Catalog \u7dad\u8b77\u4e00\u500b\u4ee3\u8868 Google Cloud \u8cc7\u6e90\u6216\u5176\u4ed6\u8cc7\u6e90\u7684\u689d\u76ee\u5217\u8868\u3002\u689d\u76ee\u6309\u689d\u76ee\u7d44\u9032\u884c\u7d44\u7e54\u3002BigQuery \u5b58\u5728\u4e00\u500b\u96b1\u5f0f\u689d\u76ee\u7d44 ( `@bigquery` )\u3002\u60a8\u5fc5\u9808\u7232\u5176\u4ed6\u985e\u578b\u7684\u8cc7\u6e90\u5275\u5efa\u689d\u76ee\u7d44\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3 Data Catalog \u689d\u76ee\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528\u6587\u4ef6\u96c6\u689d\u76ee\u986f\u793a Cloud Storage \u4e2d\u7684\u6587\u4ef6](https://cloud.google.com/data-catalog/docs/how-to/filesets?hl=zh-cn) \u3002\n\u5728 Data Catalog \u4e2d\uff0c\u689d\u76ee\u7d44\u5c31\u50cf\u5305\u542b\u689d\u76ee\u7684\u6587\u4ef6\u593e\u3002\u689d\u76ee\u8868\u793a\u6578\u64da\u8cc7\u6e90\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa\u4e00\u500b\u65b0\u7684\u689d\u76ee\u7d44\uff0c\u6d41\u6c34\u7dda\u53ef\u4ee5\u5728\u5176\u4e2d\u7232\u60a8\u7684 MySQL \u8868\u6dfb\u52a0\u689d\u76ee\uff1a```\ngcloud data-catalog entry-groups create \\\"${DATA_CATALOG_ENTRY_GROUP_ID}\" \\--project=\"${PROJECT_ID}\" \\--location=\"${REGION_ID}\"\n```\n### \u5275\u5efa\u6aa2\u67e5\u6a19\u8a18\u6a21\u677f\n- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa Data Catalog \u6a19\u8a18\u6a21\u677f\u4ee5\u652f\u6301\u5c0d\u5e36\u6709\u654f\u611f\u4fe1\u606f\u7684\u654f\u611f\u6578\u64da\u4fdd\u8b77\u689d\u76ee\u9032\u884c\u6a19\u8a18\uff1a```\ngcloud data-catalog tag-templates create ${INSPECTION_TAG_TEMPLATE_ID} \\--project=\"${PROJECT_ID}\" \u00a0\\--location=\"${REGION_ID}\" \\--display-name=\"Auto DLP sensitive categories\" \\--field=id=infoTypes,type=string,display-name=\"DLP infoTypes\",required=TRUE \\--field=id=inspectTimestamp,type=timestamp,display-name=\"Inspection run timestamp\",required=TRUE\n```\n### \u5728 BigQuery \u4e2d\u5275\u5efa\u6aa2\u67e5\u7d50\u679c\u8868\n- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa BigQuery \u8868\u4ee5\u5b58\u5132\u4f86\u81ea\u654f\u611f\u6578\u64da\u4fdd\u8b77\u7684\u5f59\u7e3d\u767c\u73fe\u7d50\u679c\uff1a```\nbq mk --dataset \\--location=\"${REGION_ID}\" \\--project_id=\"${PROJECT_ID}\" \u00a0\\inspection_resultsbq mk --table \\--project_id=\"${PROJECT_ID}\" \u00a0\\inspection_results.SensitivityInspectionResults \\inspection_results_bigquery_schema.json\n```\n### \u5728 Cloud SQL \u5be6\u4f8b\u4e0a\u8a2d\u7f6e MySQL\u5c0d\u65bc\u6578\u64da\u6e90\uff0c\u8acb\u4f7f\u7528 Cloud SQL \u5be6\u4f8b\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u5be6\u4f8b\u5316 MySQL on Cloud SQL \u5be6\u4f8b\u4e26\u4f7f\u7528\u793a\u4f8b\u6578\u64da\u52a0\u8f09\u8a72\u5be6\u4f8b\uff1a```\nexport SQL_INSTANCE=\"mysql-autodlp-instance\"export SQL_ROOT_PASSWORD=\"root1234\"gcloud sql instances create \"${SQL_INSTANCE}\" \\--project=\"${PROJECT_ID}\" \u00a0\\--region=\"${REGION_ID}\" \\--database-version=MYSQL_5_7 \\--root-password=\"${SQL_ROOT_PASSWORD}\"\n``` **\u6ce8\u610f** \uff1a\u5553\u52d5\u65b0\u5be6\u4f8b\u53ef\u80fd\u9700\u8981\u4e00\u4e9b\u6642\u9593\u3002\n- \u5c07\u6578\u64da\u5eab\u5bc6\u78bc\u4fdd\u5b58\u5728 Secret Manager \u4e2d\u3002\u4e0d\u61c9\u5b58\u5132\u6216\u8a18\u9304\u6578\u64da\u5eab\u5bc6\u78bc\u548c\u5176\u4ed6 Secret \u4fe1\u606f\u3002 [Secret Manager](https://cloud.google.com/secret-manager?hl=zh-cn) \u53ef\u8b93\u60a8\u5b89\u5168\u5730\u5b58\u5132\u548c\u6aa2\u7d22\u6b64\u985e Secret\u3002\u5c07 MySQL \u6578\u64da\u5eab\u6839\u5bc6\u78bc\u5b58\u5132\u7232\u96f2 Secret\uff1a```\nexport SQL_PASSWORD_SECRET_NAME=\"mysql-password\"printf $SQL_ROOT_PASSWORD |gcloud secrets create \"${SQL_PASSWORD_SECRET_NAME}\" \\--data-file=- \\--locations=\"${REGION_ID}\" \\--replication-policy=\"user-managed\" \\--project=\"${PROJECT_ID}\"\n```\n### \u5c07\u6e2c\u8a66\u6578\u64da\u8907\u88fd\u5230 Cloud SQL \u5be6\u4f8b\u6e2c\u8a66\u6578\u64da\u662f\u4e00\u500b\u6f14\u793a\u6578\u64da\u96c6\uff0c\u5176\u4e2d\u5305\u542b 5,000 \u500b\u96a8\u6a5f\u751f\u6210\u7684\u540d\u5b57\u548c\u59d3\u6c0f\u4ee5\u53ca\u7f8e\u570b\u683c\u5f0f\u7684\u96fb\u8a71\u865f\u78bc\u3002 `demonstration-dataset` \u8868\u5305\u542b\u56db\u5217\uff1a `row_id` \u3001 `person_name` \u3001 `contact_type` \u3001 `contact_number` \u3002\u60a8\u9084\u53ef\u4ee5\u4f7f\u7528\u81ea\u5df1\u7684\u6578\u64da\u96c6\u3002\u5982\u679c\u60a8\u4f7f\u7528\u81ea\u5df1\u7684\u6578\u64da\u96c6\uff0c\u8acb\u8a18\u5f97\u8abf\u6574\u672c\u6587\u6a94\u7684 [\u5728 BigQuery \u4e2d\u9a57\u8b49](#verify-in-bigquery) \u7684\u5efa\u8b70\u503c\u3002\u8981\u5c07\u96a8\u9644\u7684\u6f14\u793a\u6578\u64da\u96c6 ( `contacts5k.sql.gz` ) \u8907\u88fd\u5230\u60a8\u7684 Cloud SQL \u5be6\u4f8b\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u5728 Cloud Shell \u4e2d\uff0c\u5c07\u793a\u4f8b\u6578\u64da\u96c6\u8907\u88fd\u5230 Cloud Storage \u4ee5\u66ab\u5b58\u5230 Cloud SQL \u4e2d\uff1a```\ngsutil cp contacts5k.sql.gz gs://${TEMP_GCS_BUCKET}\n```\n- \u5728 Cloud SQL \u5be6\u4f8b\u4e2d\u5275\u5efa\u65b0\u7684\u6578\u64da\u5eab\uff1a```\nexport DATABASE_ID=\"auto_dlp_test\"gcloud sql databases create \"${DATABASE_ID}\" \\--project=\"${PROJECT_ID}\" \u00a0\\--instance=\"${SQL_INSTANCE}\"\n```\n- \u5c07 Storage Object Admin \u89d2\u8272\u6388\u4e88\u60a8\u7684 Cloud SQL \u670d\u52d9\u8cec\u865f\uff0c\u4ee5\u4fbf\u5b83\u53ef\u4ee5\u8a2a\u554f\u5b58\u5132\u7a7a\u9593\uff1a```\nexport SQL_SERVICE_ACCOUNT=$(gcloud sql instances describe\"${SQL_INSTANCE}\" --project=\"${PROJECT_ID}\" | grepserviceAccountEmailAddress: | sed \"s/serviceAccountEmailAddress: //g\")gsutil iam ch \"serviceAccount:${SQL_SERVICE_ACCOUNT}:objectAdmin\" \\gs://${TEMP_GCS_BUCKET}\n```\n- \u5c07\u6578\u64da\u52a0\u8f09\u5230\u65b0\u8868\u4e2d\uff1a```\ngcloud sql import sql \"${SQL_INSTANCE}\" \\\"gs://${TEMP_GCS_BUCKET}/contacts5k.sql.gz\" \\--project=\"${PROJECT_ID}\" \u00a0\\--database=\"${DATABASE_ID}\"\n```\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u5c07\u6578\u64da\u5c0e\u5165 Cloud SQL\uff0c\u8acb\u53c3\u95b1 [\u5c0e\u5165\u548c\u5c0e\u51fa\u6578\u64da\u7684\u6700\u4f73\u5be6\u8e10](https://cloud.google.com/sql/docs/mysql/import-export?hl=zh-cn#mysqldump) \u3002\n## \u7de8\u8b6f\u6a21\u584a\n- \u5728 Cloud Shell \u4e2d\uff0c\u7de8\u8b6f\u6a21\u584a\u4ee5\u69cb\u5efa\u7528\u65bc\u90e8\u7f72\u63a1\u6a23\u548c\u8b58\u5225\u6d41\u6c34\u7dda\u548c\u6a19\u8a18\u5316\u6d41\u6c34\u7dda\u7684\u53ef\u57f7\u884c\u6587\u4ef6\uff1a```\n\u00a0./gradlew clean buildNeeded shadowJar -x test\n```\uff08\u53ef\u9078\uff09\u5982\u9700\u904b\u884c\u55ae\u5143\u6e2c\u8a66\u548c\u96c6\u6210\u6e2c\u8a66\uff0c\u8acb\u79fb\u9664 `-x test` \u6a19\u8a8c\u3002\u5982\u679c\u5c1a\u672a\u5b89\u88dd `libncurses5` \uff0c\u8acb\u4f7f\u7528 `sudo apt-get install libncurses5` \u5728 Cloud Shell \u4e2d\u9032\u884c\u5b89\u88dd\u3002\n## \u904b\u884c\u63a1\u6a23\u548c\u8b58\u5225\u6d41\u6c34\u7dda\u63a1\u6a23\u548c\u654f\u611f\u6578\u64da\u4fdd\u8b77\u8b58\u5225\u6d41\u6c34\u7dda\u6309\u4ee5\u4e0b\u9806\u5e8f\u57f7\u884c\u4ee5\u4e0b\u4efb\u52d9\uff1a- \u5f9e\u63d0\u4f9b\u7684\u4f86\u6e90\u4e2d\u63d0\u53d6\u8a18\u9304\u3002\u4f8b\u5982\uff0c\u654f\u611f\u6578\u64da\u4fdd\u8b77\u6a19\u8b58\u65b9\u6cd5\u50c5\u652f\u6301\u6241\u5e73\u8868\uff0c\u56e0\u6b64\u6d41\u6c34\u7dda\u6703\u5c07 Avro\u3001Parquet \u6216 BigQuery \u8a18\u9304\u5c55\u5e73\uff0c\u56e0\u7232\u9019\u4e9b\u8a18\u9304\u53ef\u4ee5\u5305\u542b\u5d4c\u5957\u548c\u91cd\u8907\u5b57\u6bb5\u3002\n- \u5c0d\u6240\u9700\u6a23\u672c\u7684\u5404\u500b\u5217\u9032\u884c\u63a1\u6a23\uff0c\u4e0d\u5305\u62ec`null`\u6216\u7a7a\u503c\u3002\n- \u4f7f\u7528\u654f\u611f\u6578\u64da\u4fdd\u8b77\u8b58\u5225\u654f\u611f\u7684`infoTypes`\u6578\u64da\uff0c\u65b9\u6cd5\u662f\u5c07\u6a23\u672c\u6279\u91cf\u8655\u7406\u7232\u654f\u611f\u6578\u64da\u4fdd\u8b77\u53ef\u63a5\u53d7\u7684\u6279\u6b21\u5927\u5c0f\uff08\u5c0f\u65bc 500 Kb \u4e26\u4e14\u5c11\u65bc 50,000 \u500b\u503c\uff09\u3002\n- \u5c07\u5831\u544a\u5beb\u5165 Cloud Storage \u548c BigQuery \u4ee5\u4f9b\u65e5\u5f8c\u53c3\u8003\u3002\n- \u5728\u60a8\u63d0\u4f9b\u6a19\u8a18\u6a21\u677f\u548c\u689d\u76ee\u7d44\u4fe1\u606f\u6642\uff0c\u5275\u5efa Data Catalog \u5be6\u9ad4\u3002\u63d0\u4f9b\u6b64\u4fe1\u606f\u6642\uff0c\u6d41\u6c34\u7dda\u6703\u6839\u64da\u76f8\u61c9\u7684\u5217\u91dd\u5c0d Data Catalog \u4e2d\u7684\u689d\u76ee\u5275\u5efa\u654f\u611f\u5ea6\u6a19\u8a18\u3002\n### \u5275\u5efa Dataflow Flex \u6a21\u677f\u85c9\u52a9 [Dataflow Flex \u6a21\u677f](https://cloud.google.com/dataflow/docs/concepts/dataflow-templates?hl=zh-cn) \uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 Google Cloud \u63a7\u5236\u6aaf\u3001Google Cloud CLI \u6216 REST API \u8abf\u7528\u5728 Google Cloud \u4e0a\u8a2d\u7f6e\u548c\u904b\u884c\u6d41\u6c34\u7dda\u3002\u672c\u6587\u6a94\u63d0\u4f9b\u4e86 Google Cloud \u63a7\u5236\u6aaf\u7684\u8aaa\u660e\u3002\u7d93\u5178\u6a21\u677f\u4f5c\u7232\u57f7\u884c\u5716\u66ab\u5b58\u5728 Cloud Storage \u4e0a\uff0c\u800c Flex \u6a21\u677f\u5c07\u6d41\u6c34\u7dda\u4f5c\u7232\u5bb9\u5668\u6620\u50cf\u6253\u5305\u5230\u9805\u76ee\u7684 [Container Registry](https://cloud.google.com/container-registry?hl=zh-cn) \u4e2d\u3002\u901a\u904e Flex \u6a21\u677f\uff0c\u60a8\u53ef\u4ee5\u5206\u96e2\u69cb\u5efa\u548c\u904b\u884c\u6d41\u6c34\u7dda\uff0c\u4e26\u8207\u8a08\u5283\u6d41\u6c34\u7dda\u904b\u884c\u7684\u7de8\u6392\u7cfb\u7d71\u96c6\u6210\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3 Dataflow Flex \u6a21\u677f\uff0c\u8acb\u53c3\u95b1 [\u8a55\u4f30\u8981\u4f7f\u7528\u7684\u6a21\u677f\u985e\u578b](https://cloud.google.com/dataflow/docs/concepts/dataflow-templates?hl=zh-cn#comparing-templated-jobs) \u3002\nDataflow Flex \u6a21\u677f\u6703\u5c07\u69cb\u5efa\u548c\u66ab\u5b58\u6b65\u9a5f\u8207\u6b63\u5728\u904b\u884c\u7684\u6b65\u9a5f\u5206\u958b\u3002\u7232\u6b64\uff0c\u53ef\u4ee5\u4f7f\u7528 [DataflowStartFlexTemplateOperator](https://airflow.apache.org/docs/apache-airflow-providers-google/stable/_api/airflow/providers/google/cloud/operators/dataflow/index.html#airflow.providers.google.cloud.operators.dataflow.DataflowStartFlexTemplateOperator) \u6a21\u584a\u5f9e API \u8abf\u7528\u548c Cloud Composer \u5553\u52d5 Dataflow \u6d41\u6c34\u7dda\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u5b9a\u7fa9\u7528\u65bc\u5b58\u5132\u6a21\u677f\u898f\u7bc4\u6587\u4ef6\u7684\u4f4d\u7f6e\uff0c\u8a72\u6587\u4ef6\u5305\u542b\u904b\u884c Dataflow \u4f5c\u696d\u6240\u9700\u7684\u4fe1\u606f\uff1a```\nexportFLEX_TEMPLATE_PATH=\"gs://${TEMP_GCS_BUCKET}/dataflow/templates/sample-inspect-tag-pipeline.json\"exportFLEX_TEMPLATE_IMAGE=\"us.gcr.io/${PROJECT_ID}/dataflow/sample-inspect-tag-pipeline:latest\"\n```\n- \u69cb\u5efa Dataflow Flex \u6a21\u677f\uff1a```\ngcloud dataflow flex-template build \"${FLEX_TEMPLATE_PATH}\" \\--image-gcr-path=\"${FLEX_TEMPLATE_IMAGE}\" \\--service-account-email=\"${DLP_RUNNER_SERVICE_ACCOUNT_EMAIL}\" \\--sdk-language=\"JAVA\" \\--flex-template-base-image=JAVA11 \\--metadata-file=\"sample_identify_tag_pipeline_metadata.json\" \\--jar=\"build/libs/auto-data-tokenize-all.jar\" \\--env=\"FLEX_TEMPLATE_JAVA_MAIN_CLASS=\\\"com.google.cloud.solutions.autotokenize.pipeline.DlpInspectionPipeline\\\"\"\n```\n### \u904b\u884c\u6d41\u6c34\u7dda\u63a1\u6a23\u548c\u8b58\u5225\u6d41\u6c34\u7dda\u6703\u63d0\u53d6\u7531 `sampleSize` \u503c\u6307\u5b9a\u7684\u8a18\u9304\u6578\u3002\u7136\u5f8c\uff0c\u5b83\u6703\u5c55\u5e73\u6bcf\u689d\u8a18\u9304\uff0c\u4e26\u4f7f\u7528\u654f\u611f\u6578\u64da\u4fdd\u8b77\u8b58\u5225 `infoTypes` \u5b57\u6bb5\uff08\u4ee5\u8b58\u5225\u654f\u611f\u4fe1\u606f\u985e\u578b\uff09\u3002\u7cfb\u7d71\u6703\u8a08\u7b97 `infoTypes` \u503c\uff0c\u7136\u5f8c\u6309\u5217\u540d\u7a31\u548c `infoType` \u5b57\u6bb5\u9032\u884c\u805a\u5408\uff0c\u4ee5\u69cb\u5efa\u654f\u611f\u5ea6\u5831\u544a\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u5553\u52d5\u63a1\u6a23\u548c\u8b58\u5225\u6d41\u6c34\u7dda\uff0c\u4ee5\u8b58\u5225\u6578\u64da\u6e90\u4e2d\u7684\u654f\u611f\u5217\uff1a```\nexportCLOUD_SQL_JDBC_CONNECTION_URL=\"jdbc:mysql:///${DATABASE_ID}?cloudSqlInstance=${PROJECT_ID}%3A${REGION_ID}%3A${SQL_INSTANCE}&socketFactory=com.google.cloud.sql.mysql.SocketFactory\"gcloud dataflow flex-template run \"sample-inspect-tag-`date +%Y%m%d-%H%M%S`\" \\\u00a0 --template-file-gcs-location \"${FLEX_TEMPLATE_PATH}\" \\\u00a0 --region \"${REGION_ID}\" \\\u00a0 --service-account-email \"${DLP_RUNNER_SERVICE_ACCOUNT_EMAIL}\" \\\u00a0 --staging-location \"gs://${TEMP_GCS_BUCKET}/staging\" \\\u00a0 --worker-machine-type \"n1-standard-1\" \\\u00a0 --parameters sampleSize=2000 \\\u00a0 --parameters sourceType=\"JDBC_TABLE\" \\\u00a0 --parameters inputPattern=\"Contacts\" \\\u00a0 --parameters reportLocation=\"gs://${TEMP_GCS_BUCKET}/auto_dlp_report/\" \\\u00a0 --parameters reportBigQueryTable=\"${PROJECT_ID}:inspection_results.SensitivityInspectionResults\" \\\u00a0 --parameters jdbcConnectionUrl=\"${CLOUD_SQL_JDBC_CONNECTION_URL}\" \\\u00a0 --parameters jdbcDriverClass=\"com.mysql.cj.jdbc.Driver\" \\\u00a0 --parameters jdbcUserName=\"root\" \\\u00a0 --parameters jdbcPasswordSecretsKey=\"projects/${PROJECT_ID}/secrets/${SQL_PASSWORD_SECRET_NAME}/versions/1\" \\\u00a0 --parameters ^:^jdbcFilterClause=\"ROUND(RAND() * 10) IN (1,3)\" \\\u00a0 --parameters dataCatalogEntryGroupId=\"projects/${PROJECT_ID}/locations/${REGION_ID}/entryGroups/${DATA_CATALOG_ENTRY_GROUP_ID}\" \\\u00a0 --parameters dataCatalogInspectionTagTemplateId=\"projects/${PROJECT_ID}/locations/${REGION_ID}/tagTemplates/${INSPECTION_TAG_TEMPLATE_ID}\"\n```\n`jdbcConnectionUrl` \u53c3\u6578\u6307\u5b9a\u5305\u542b\u7528\u6236\u540d\u548c\u5bc6\u78bc\u8a73\u7d30\u4fe1\u606f\u7684 JDBC \u6578\u64da\u5eab\u9023\u63a5\u7db2\u5740\u3002\u8207\u69cb\u5efa\u78ba\u5207\u7684\u9023\u63a5\u7db2\u5740\u6709\u95dc\u7684\u8a73\u7d30\u4fe1\u606f\u53d6\u6c7a\u65bc\u60a8\u7684\u6578\u64da\u5eab\u4f9b\u61c9\u5546\u548c\u8a17\u7ba1\u5408\u4f5c\u4f19\u4f34\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u9023\u63a5\u5230\u57fa\u65bc Cloud SQL \u7684\u95dc\u4fc2\u578b\u6578\u64da\u5eab\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528 Cloud SQL \u9023\u63a5\u5668\u9032\u884c\u9023\u63a5](https://cloud.google.com/sql/docs/mysql/connect-connectors?hl=zh-cn) \u3002\n\u8a72\u6d41\u6c34\u7dda\u6703\u69cb\u9020\u4e00\u500b\u67e5\u8a62\uff08\u5982 `SELECT * FROM [TableName]` \uff09\u4f86\u8b80\u53d6\u8868\u8a18\u9304\u4ee5\u9032\u884c\u6aa2\u67e5\u3002\n\u6b64\u67e5\u8a62\u53ef\u80fd\u6703\u5728\u6578\u64da\u5eab\u4ee5\u53ca\u6d41\u6c34\u7dda\u4e2d\u52a0\u8f09\u6578\u64da\uff0c\u5c24\u5176\u662f\u5c0d\u65bc\u5927\u578b\u8868\u3002\u60a8\u53ef\u4ee5\u8996\u60c5\u6cc1\u512a\u5316\u8981\u5728\u6578\u64da\u5eab\u7aef\u6aa2\u67e5\u7684\u8a18\u9304\u6a23\u672c\u3002\u7232\u6b64\uff0c\u8acb\u63d2\u5165 `jdbcFilterClause` \u4f5c\u7232\u5728\u672c\u6587\u6a94\u5f8c\u9762 [\u201c\u5728 BigQuery \u4e2d\u9a57\u8b49\u201d\u90e8\u5206](#verify-in-bigquery) \u4e2d\u63d0\u4f9b\u7684\u4ee3\u78bc\u793a\u4f8b\u4e2d\u51fa\u73fe\u7684\u67e5\u8a62\u7684 `WHERE` \u5b50\u53e5\u3002\n\u5982\u9700\u904b\u884c\u5831\u544a\uff0c\u60a8\u53ef\u4ee5\u9078\u64c7\u4ee5\u4e0b\u4e00\u500b\u6216\u591a\u500b\u5831\u544a\u63a5\u6536\u5668\uff1a- `reportLocation`\uff0c\u7528\u65bc\u5c07\u5831\u544a\u5b58\u5132\u5728 Cloud Storage \u5b58\u5132\u6876\u4e2d\n- `report``BIGQUERY_TABLE`\uff0c\u7528\u65bc\u5c07\u5831\u544a\u5b58\u5132\u5728`BigQueryTable`\u4e2d\n- `dataCatalogEntryGroupId`\uff0c\u7528\u65bc\u5728 Data Catalog \u4e2d\u5275\u5efa\u548c\u6a19\u8a18\u689d\u76ee\uff08\u5982\u679c`sourceType`\u7232`BIGQUERY_TABLE`\uff0c\u8acb\u7701\u7565\u6b64\u53c3\u6578\uff09\n\u8a72\u6d41\u6c34\u7dda\u652f\u6301\u4ee5\u4e0b\u6e90\u985e\u578b\u3002\u8981\u78ba\u5b9a `sourceType` \u548c `inputPattern` \u53c3\u6578\u7684\u6b63\u78ba\u7d44\u5408\uff0c\u8acb\u4f7f\u7528\u4e0b\u8868\u4e2d\u5217\u51fa\u7684\u9078\u9805\u3002\n\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u60a8\u53ea\u4f7f\u7528 `JDBC_TABLE` \u8868\u3002\n| sourceType  | \u6578\u64da\u6e90                                          | inputPattern    |\n|:---------------|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------------------------|\n| JDBC_TABLE  | \u95dc\u4fc2\u578b\u6578\u64da\u5eab\uff08\u4f7f\u7528 JDBC\uff09                                     | TABLE_NAME     |\n| AVRO   | Cloud Storage \u4e2d\u7684 Avro \u6587\u4ef6\u3002 \u5982\u9700\u9078\u64c7\u8207\u4e00\u500b\u6a21\u5f0f\u5339\u914d\u7684\u591a\u500b\u6587\u4ef6\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u55ae\u500b\u901a\u914d\u7b26\u3002\u4ee5\u4e0b\u6a21\u5f0f\u6703\u9078\u64c7\u4ee5\u524d\u7db4 (data-) \u958b\u982d\u7684\u6240\u6709\u6587\u4ef6\uff1a gs://my-bucket/path/to/folder/data-* | gs://LOCATION_OF_FILES  |\n| PARQUET  | Cloud Storage \u4e2d\u7684 Parquet \u6587\u4ef6\u3002 \u5982\u9700\u9078\u64c7\u8207\u4e00\u500b\u6a21\u5f0f\u5339\u914d\u7684\u591a\u500b\u6587\u4ef6\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u55ae\u500b\u901a\u914d\u7b26\u3002\u4ee5\u4e0b\u6a21\u5f0f\u6703\u9078\u64c7\u4ee5\u524d\u7db4 (data-) \u958b\u982d\u7684\u6240\u6709\u6587\u4ef6\uff1a gs://my-bucket/path/to/folder/data-* | gs://LOCATION_OF_FILES  |\n| BIGQUERY_TABLE | BigQuery \u8868\u3002 \u8b80\u53d6\u6240\u6709\u884c\uff0c\u7136\u5f8c\u4f7f\u7528\u6d41\u6c34\u7dda\u96a8\u6a5f\u9032\u884c\u63a1\u6a23\u3002                              | PROJECT_ID:=DATASET.=TABLE |\n\u6d41\u6c34\u7dda\u6703\u6aa2\u6e2c\u654f\u611f\u6578\u64da\u4fdd\u8b77\u652f\u6301\u7684\u6240\u6709 [\u6a19\u6e96 infoTypes](https://cloud.google.com/dlp/docs/infotypes-reference?hl=zh-cn) \u3002\u60a8\u53ef\u4ee5\u4f7f\u7528 `--observableinfoTypes` \u53c3\u6578\u63d0\u4f9b\u5176\u4ed6\u81ea\u5b9a\u7fa9 `infoTypes` \u3002\u4e0b\u5716\u986f\u793a\u4e86 Dataflow \u57f7\u884c DAG\u3002DAG \u6709\u5169\u500b\u5206\u652f\u3002\u5169\u500b\u5206\u652f\u90fd\u5f9e `ReadJdbcTable` \u958b\u59cb\uff0c\u5230 `ExtractReport` \u7d50\u675f\u3002\u63a5\u7740\uff0c\u751f\u6210\u5831\u544a\u6216\u5b58\u5132\u6578\u64da\u3002\n### \u6aa2\u7d22\u5831\u544a\u63a1\u6a23\u548c\u8b58\u5225\u6d41\u6c34\u7dda\u8f38\u51fa\u4ee5\u4e0b\u6587\u4ef6\uff1a- \u6e90\u7684 Avro \u67b6\u69cb\u6587\u4ef6\uff08\u6216\u8f49\u63db\u7232 Avro \u7684\u67b6\u69cb\uff09\n- \u6bcf\u500b\u654f\u611f\u5217\u5c0d\u61c9\u4e00\u500b\u6587\u4ef6\uff0c\u5176\u4e2d\u5305\u542b`infoType`\u4fe1\u606f\u548c\u8a08\u6578\n\u5982\u9700\u6aa2\u7d22\u5831\u544a\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u5728 Cloud Shell \u4e2d\uff0c\u6aa2\u7d22\u5831\u544a\uff1a```\nmkdir -p auto_dlp_report/gsutil -m cp\"gs://${TEMP_GCS_BUCKET}/auto_dlp_report/*.json\"auto_dlp_report/\n```\n- \u5217\u51fa\u6240\u6709\u5df2\u8b58\u5225\u7684\u5217\u540d\u7a31\uff1a```\ncat auto_dlp_report/col-*.json | jq .columnName\n```\u8f38\u51fa\u5982\u4e0b\u6240\u793a\uff1a`\"$.topLevelRecord.contact_number\" \"$.topLevelRecord.person_name\"`\n- \u4f7f\u7528\u6587\u4ef6\u7684 `cat` \u547d\u4ee4\u67e5\u770b\u5df2\u8b58\u5225\u5217\u7684\u8a73\u7d30\u4fe1\u606f\uff1a```\ncat auto_dlp_report/col-topLevelRecord-contact_number-00000-of-00001.json\n```\u4ee5\u4e0b\u7232 `cc` \u5217\u7684\u4ee3\u78bc\u6bb5\uff1a`{ \"columnName\": \"$.topLevelRecord.contact_number\", \"infoTypes\": [{ \"infoType\": \"PHONE_NUMBER\", \"count\": \"990\" }] }`- `columnName`\u503c\u7570\u5e38\uff0c\u56e0\u7232\u96b1\u5f0f\u5c07\u6578\u64da\u5eab\u884c\u8f49\u63db\u7232 Avro \u8a18\u9304\u3002\n- `count`\u503c\u56e0\u57f7\u884c\u671f\u9593\u96a8\u6a5f\u9078\u64c7\u7684\u6a23\u672c\u800c\u7570\u3002\n### \u9a57\u8b49 Data Catalog \u4e2d\u7684\u654f\u611f\u5ea6\u6a19\u8a18\u63a1\u6a23\u548c\u8b58\u5225\u6d41\u6c34\u7dda\u6703\u5275\u5efa\u4e00\u500b\u65b0\u689d\u76ee\uff0c\u4e26\u5c07\u654f\u611f\u5ea6\u6a19\u8a18\u61c9\u7528\u65bc\u76f8\u61c9\u7684\u5217\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u6aa2\u7d22\u7232\u201c\u806f\u7e6b\u4eba\u201d\u8868\u5275\u5efa\u7684\u689d\u76ee\uff1a```\ngcloud data-catalog entries describe Contacts \\\u00a0 --entry-group=${DATA_CATALOG_ENTRY_GROUP_ID} \\\u00a0 --project=\"${PROJECT_ID}\" \u00a0\\\u00a0 --location=\"${REGION_ID}\"\n```\u6b64\u547d\u4ee4\u6703\u986f\u793a\u8a72\u8868\u7684\u8a73\u7d30\u4fe1\u606f\uff0c\u5305\u62ec\u5176\u67b6\u69cb\u3002\n- \u986f\u793a\u9644\u52a0\u5230\u6b64\u689d\u76ee\u7684\u6240\u6709\u654f\u611f\u5ea6\u6a19\u8a18\uff1a```\ngcloud data-catalog tags list --entry=Contacts\u00a0 --entry-group=${DATA_CATALOG_ENTRY_GROUP_ID} \\\u00a0 --project=\"${PROJECT_ID}\" \u00a0\\\u00a0 --location=\"${REGION_ID}\"\n```\n- \u9a57\u8b49\u4ee5\u4e0b\u5217\u4e2d\u662f\u5426\u5b58\u5728\u654f\u611f\u5ea6\u6a19\u8a18\uff1a `contact_number` \u3001 `person_name` \u3002\u654f\u611f\u6578\u64da\u4fdd\u8b77\u8b58\u5225\u7684 `infoTypes` \u6578\u64da\u53ef\u80fd\u5305\u542b\u4e00\u4e9b\u8aa4\u5831\u985e\u578b\u3002\u4f8b\u5982\uff0c\u5b83\u53ef\u4ee5\u5c07 `person_name` \u985e\u578b\u6a19\u8b58\u7232 `DATE` \u985e\u578b\uff0c\u56e0\u7232\u67d0\u4e9b\u96a8\u6a5f `person_names` \u5b57\u7b26\u4e32\u53ef\u4ee5\u662f 4 \u6708\u30015 \u6708\u30016 \u6708\u6216\u5176\u4ed6\u65e5\u671f\u3002\u8f38\u51fa\u7684\u654f\u611f\u5ea6\u6a19\u8a18\u8a73\u7d30\u4fe1\u606f\u5982\u4e0b\uff1a```\ncolumn: contact_number\nfields:\n infoTypes:\n displayName: DLP infoTypes\n stringValue: '[PHONE_NUMBER]'\n inspectTimestamp:\n displayName: Inspection run timestamp\n timestampValue: '2021-05-20T16:34:29.596Z'\nname: projects/auto-dlp/locations/asia-southeast1/entryGroups/sql_databases/entries/Contacts/tags/CbS0CtGSpZyJ\ntemplate: projects/auto-dlp/locations/asia-southeast1/tagTemplates/auto_dlp_inspection\ntemplateDisplayName: Auto DLP sensitive categories\n--column: person_name\nfields:\n infoTypes:\n displayName: DLP infoTypes\n stringValue: '[DATE, PERSON_NAME]'\n inspectTimestamp:\n displayName: Inspection run timestamp\n timestampValue: '2021-05-20T16:34:29.594Z'\nname: projects/auto-dlp/locations/asia-southeast1/entryGroups/sql_databases/entries/Contacts/tags/Cds1aiO8R0pT\ntemplate: projects/auto-dlp/locations/asia-southeast1/tagTemplates/auto_dlp_inspection\ntemplateDisplayName: Auto DLP sensitive categories\n```\n## \u5728 BigQuery \u4e2d\u9a57\u8b49Dataflow \u6d41\u6c34\u7dda\u5c07\u5f59\u7e3d\u767c\u73fe\u7d50\u679c\u9644\u52a0\u5230\u63d0\u4f9b\u7684 BigQuery \u8868\u4e2d\u3002\u8a72\u67e5\u8a62\u6703\u8f38\u51fa\u5f9e BigQuery \u8868\u4e2d\u6aa2\u7d22\u5230\u7684\u6aa2\u67e5\u7d50\u679c\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u6aa2\u67e5\u7d50\u679c\uff1a```\nbq query \\\u00a0 --location=\"${REGION_ID}\" \u00a0\\\u00a0 --project=\"${PROJECT_ID}\" \u00a0\\\u00a0 --use_legacy_sql=false \\'SELECT\u00a0 \u00a0input_pattern AS table_name,\u00a0 \u00a0ColumnReport.column_name AS column_name,\u00a0 \u00a0ColumnReport.info_types AS info_types\u00a0FROM\u00a0 \u00a0`inspection_results.SensitivityInspectionResults`,\u00a0 \u00a0UNNEST(column_report) ColumnReport;\u00a0WHERE column_name=\"$.topLevelRecord.contact_number\"'\n```\u8f38\u51fa\u5982\u4e0b\u6240\u793a\uff1a```\n+------------+---------------------------------+----------------------------------------------+| table_name | \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 column_name \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 | \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0info_types \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0|+------------+---------------------------------+----------------------------------------------+| Contacts \u00a0 | $.topLevelRecord.contact_number | [{\"info_type\":\"PHONE_NUMBER\",\"count\":\"990\"}] |+------------+---------------------------------+----------------------------------------------+\n```## \u6e05\u7406\u7232\u907f\u514d\u56e0\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528\u7684\u8cc7\u6e90\u5c0e\u81f4\u60a8\u7684 Google Cloud \u8cec\u865f\u7522\u751f\u8cbb\u7528\uff0c\u8acb\u522a\u9664\u5305\u542b\u9019\u4e9b\u8cc7\u6e90\u7684\u9805\u76ee\uff0c\u6216\u8005\u4fdd\u7559\u9805\u76ee\u4f46\u522a\u9664\u5404\u500b\u8cc7\u6e90\u3002\n### \u522a\u9664\u9805\u76ee- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- **\u8b66\u544a** \uff1a\u522a\u9664\u9805\u76ee\u6703\u7522\u751f\u4ee5\u4e0b\u5f71\u97ff- **\u9805\u76ee\u4e2d\u7684\u6240\u6709\u5167\u5bb9\u90fd\u6703\u88ab\u522a\u9664\u3002** \u5982\u679c\u60a8\u5c07\u73fe\u6709\u9805\u76ee\u7528\u65bc\u672c\u6587\u6a94\u4e2d\u7684\u4efb\u52d9\uff0c\u5247\u522a\u9664\u8a72\u9805\u76ee\u5f8c\uff0c\u9084\u5c07\u522a\u9664\u60a8\u5df2\u5728\u8a72\u9805\u76ee\u4e2d\u5b8c\u6210\u7684\u4efb\u4f55\u5176\u4ed6\u5de5\u4f5c\u3002\n- **\u81ea\u5b9a\u7fa9\u9805\u76ee ID \u4e1f\u5931\u3002** \u5275\u5efa\u6b64\u9805\u76ee\u6642\uff0c\u60a8\u53ef\u80fd\u5275\u5efa\u4e86\u8981\u5728\u5c07\u4f86\u4f7f\u7528\u7684\u81ea\u5b9a\u7fa9\u9805\u76ee ID\u3002\u8981\u4fdd\u7559\u4f7f\u7528\u8a72\u9805\u76ee ID \u7684\u7db2\u5740\uff08\u4f8b\u5982`appspot.com`\u7db2\u5740\uff09\uff0c\u8acb\u522a\u9664\u9805\u76ee\u5167\u7684\u6240\u9078\u8cc7\u6e90\uff0c\u800c\u4e0d\u662f\u522a\u9664\u6574\u500b\u9805\u76ee\u3002\n\u5982\u679c\u60a8\u6253\u7b97\u63a2\u7d22\u591a\u500b\u67b6\u69cb\u3001\u6559\u7a0b\u6216\u5feb\u901f\u5165\u9580\uff0c\u5247\u91cd\u8907\u4f7f\u7528\u9805\u76ee\u53ef\u4ee5\u5e6b\u52a9\u60a8\u907f\u514d\u8d85\u51fa\u9805\u76ee\u914d\u984d\u9650\u5236\u3002\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u9032\u5165 **\u7ba1\u7406\u8cc7\u6e90** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u7ba1\u7406\u8cc7\u6e90\u201d](https://console.cloud.google.com/iam-admin/projects?hl=zh-cn) \n- \u5728\u9805\u76ee\u5217\u8868\u4e2d\uff0c\u9078\u64c7\u8981\u522a\u9664\u7684\u9805\u76ee\uff0c\u7136\u5f8c\u9ede\u64ca **\u522a\u9664** \u3002\n- \u5728\u5c0d\u8a71\u6846\u4e2d\u8f38\u5165\u9805\u76ee ID\uff0c\u7136\u5f8c\u9ede\u64ca **\u95dc\u9589** \u4ee5\u522a\u9664\u9805\u76ee\u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u95b1\u8b80\u4ee5\u4e0b\u914d\u5957\u6587\u6a94\uff0c\u77ad\u89e3\u4f7f\u7528\u6587\u4ef6\u4f5c\u7232\u8f38\u5165\u7684\u985e\u4f3c\u89e3\u6c7a\u65b9\u6848\uff1a [\u4f7f\u7528\u654f\u611f\u6578\u64da\u4fdd\u8b77\u3001Cloud Key Management Service \u548c Dataflow \u81ea\u52d5\u5c0d\u57fa\u65bc\u6587\u4ef6\u7684\u654f\u611f\u6578\u64da\u9032\u884c\u4ee4\u724c\u5316\u8655\u7406](https://cloud.google.com/community/tutorials/auto-data-tokenize?hl=zh-cn) \u3002\n- \u77ad\u89e3\u5982\u4f55 [\u6aa2\u67e5\u5b58\u5132\u7a7a\u9593\u548c\u6578\u64da\u5eab\u4e2d\u662f\u5426\u5b58\u5728\u654f\u611f\u6578\u64da](https://cloud.google.com/dlp/docs/inspecting-storage?hl=zh-cn) \u3002\n- \u77ad\u89e3\u5982\u4f55 [\u4f7f\u7528\u654f\u611f\u6578\u64da\u4fdd\u8b77\u5c0d\u5927\u898f\u6a21\u6578\u64da\u96c6\u4e2d\u7684\u500b\u4eba\u8eab\u4efd\u4fe1\u606f\u9032\u884c\u53bb\u6a19\u8b58\u5316\u548c\u91cd\u6a19\u8b58\u8655\u7406](https://cloud.google.com/solutions/de-identification-re-identification-pii-using-cloud-dlp?hl=zh-cn) \u3002\n- \u5982\u9700\u67e5\u770b\u66f4\u591a\u53c3\u8003\u67b6\u69cb\u3001\u5716\u8868\u548c\u6700\u4f73\u5be6\u8e10\uff0c\u8acb\u700f\u89bd [\u96f2\u67b6\u69cb\u4e2d\u5fc3](https://cloud.google.com/architecture?hl=zh-cn) \u3002", "guide": "Docs"}