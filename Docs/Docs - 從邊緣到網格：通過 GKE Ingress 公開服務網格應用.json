{"title": "Docs - \u5f9e\u908a\u7de3\u5230\u7db2\u683c\uff1a\u901a\u904e GKE Ingress \u516c\u958b\u670d\u52d9\u7db2\u683c\u61c9\u7528", "url": "https://cloud.google.com/architecture/exposing-service-mesh-apps-through-gke-ingress?hl=zh-cn", "abstract": "# Docs - \u5f9e\u908a\u7de3\u5230\u7db2\u683c\uff1a\u901a\u904e GKE Ingress \u516c\u958b\u670d\u52d9\u7db2\u683c\u61c9\u7528\nLast reviewed 2022-09-29 UTC\n\u672c\u6559\u7a0b\u4ecb\u7d39\u5982\u4f55\u5c07 Anthos Service Mesh \u8207 Cloud Load Balancing \u7d50\u5408\u4f7f\u7528\uff0c\u4ee5\u5c07\u670d\u52d9\u7db2\u683c\u4e2d\u7684\u61c9\u7528\u516c\u958b\u7d66\u4e92\u806f\u7db2\u5ba2\u6236\u7aef\u3002\nAnthos Service Mesh \u662f\u57fa\u65bc Istio \u7684\u4ee3\u7ba1\u5f0f\u670d\u52d9\u7db2\u683c\uff0c\u53ef\u7232\u61c9\u7528\u63d0\u4f9b\u53ef\u89c0\u6e2c\u7684\u6a19\u6e96\u5316\u5b89\u5168\u589e\u5f37\u578b\u901a\u4fe1\u5c64\u3002\u7121\u8ad6\u60a8\u662f\u4f7f\u7528 Anthos Service Mesh\u3001Traffic Director \u9084\u662f Istio\uff0c\u670d\u52d9\u7db2\u683c\u90fd\u53ef\u4ee5\u7232\u5728\u7db2\u683c\u4e2d\u9032\u884c\u901a\u4fe1\u7684\u5ba2\u6236\u63d0\u4f9b\u5168\u9762\u7684\u901a\u4fe1\u5e73\u81fa\u3002\u4f46\u662f\uff0c\u4ecd\u7136\u96e3\u4ee5\u5c07\u7db2\u683c\u5916\u90e8\u7684\u5ba2\u6236\u7aef\u9023\u63a5\u5230\u7db2\u683c\u4e2d\u8a17\u7ba1\u7684\u61c9\u7528\u3002\n\u60a8\u53ef\u4ee5\u901a\u904e\u591a\u7a2e\u65b9\u5f0f\u5411\u5ba2\u6236\u7aef\u516c\u958b\u61c9\u7528\uff0c\u5177\u9ad4\u53d6\u6c7a\u65bc\u5ba2\u6236\u7aef\u6240\u5728\u7684\u4f4d\u7f6e\u3002\u672c\u6559\u7a0b\u4ecb\u7d39\u77ad\u5982\u4f55\u5c07 Cloud Load Balancing \u8207 Anthos Service Mesh \u7d50\u5408\u4f7f\u7528\u4ee5\u5411\u5ba2\u6236\u7aef\u516c\u958b\u61c9\u7528\uff0c\u5f9e\u800c\u5c07\u8ca0\u8f09\u5747\u8861\u5668\u8207\u670d\u52d9\u7db2\u683c\u96c6\u6210\u5728\u4e00\u8d77\u3002\u672c\u6559\u7a0b\u9762\u5411\u904b\u884c Anthos Service Mesh \u7684\u9ad8\u7d1a\u5f9e\u696d\u4eba\u54e1\uff0c\u4f46\u4e5f\u9069\u7528\u65bc Google Kubernetes Engine \u4e0a\u7684 Istio\u3002", "content": "## \u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u7db2\u95dcIstio 0.8 \u5f15\u5165\u4e86\u7db2\u683c [\u5165\u7ad9\u6d41\u91cf\u7db2\u95dc](https://istio.io/latest/docs/concepts/traffic-management/#gateways) \uff0c\u6b64\u7db2\u95dc\u63d0\u4f9b\u7684\u5c08\u7528\u4ee3\u7406\u96c6\u7684\u7aef\u53e3\u6703\u5411\u4f86\u81ea\u670d\u52d9\u7db2\u683c\u5916\u90e8\u7684\u6d41\u91cf\u516c\u958b\u3002\u9019\u4e9b\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u4ee3\u7406\u5141\u8a31\u60a8\u7368\u7acb\u65bc\u61c9\u7528\u8def\u7531\u884c\u7232\uff0c\u63a7\u5236 L4 \u516c\u958b\u884c\u7232\u3002\u4ee3\u7406\u9084\u5141\u8a31\u60a8\u5728\u7db2\u683c\u5916\u90e8\u6d41\u91cf\u5230\u9054\u61c9\u7528 Sidecar \u4e4b\u524d\u5c07\u8def\u7531\u548c\u653f\u7b56\u61c9\u7528\u5230\u7db2\u683c\u5916\u90e8\u6d41\u91cf\u3002\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u5b9a\u7fa9\u4e86\u6d41\u91cf\u5230\u9054\u7db2\u683c\u4e2d\u7684\u7bc0\u9ede\u6642\u7684\u8655\u7406\u65b9\u5f0f\uff0c\u4f46\u662f\u5916\u90e8\u7d44\u4ef6\u5fc5\u9808\u5b9a\u7fa9\u6d41\u91cf\u5982\u4f55\u9996\u5148\u5230\u9054\u7db2\u683c\u3002\n\u5982\u9700\u7ba1\u7406\u6b64\u5916\u90e8\u6d41\u91cf\uff0c\u60a8\u9700\u8981\u4e00\u500b\u4f4d\u65bc\u7db2\u683c\u5916\u90e8\u7684\u8ca0\u8f09\u5747\u8861\u5668\u3002\u672c\u6559\u7a0b\u4f7f\u7528\u901a\u904e GKE Ingress \u8cc7\u6e90\u9810\u914d\u7684 Google Cloud Load Balancing \u81ea\u52d5\u57f7\u884c\u90e8\u7f72\u3002\u6b64\u8a2d\u7f6e\u7684 [\u898f\u7bc4\u793a\u4f8b](https://istio.io/latest/docs/tasks/traffic-management/ingress/ingress-control/#determining-the-ingress-ip-and-ports) \u662f\u5916\u90e8\u8ca0\u8f09\u5747\u8861\u670d\u52d9\uff0c\u5c0d\u65bc Google Cloud\uff0c\u6703\u90e8\u7f72\u516c\u5171 TCP/UDP \u8ca0\u8f09\u5747\u8861\u5668\u3002\u8a72\u8ca0\u8f09\u5747\u8861\u5668\u6307\u5411 GKE \u96c6\u7fa3\u7684 NodePort\u3002\u9019\u4e9b NodePort \u6703\u516c\u958b Istio \u5165\u7ad9\u6d41\u91cf\u7db2\u95dc Pod\uff0c\u800c Pod \u6703\u5c07\u6d41\u91cf\u8def\u7531\u5230\u4e0b\u6e38\u7db2\u683c Sidecar \u4ee3\u7406\u3002\u4e0b\u5716\u6f14\u793a\u4e86\u6b64\u62d3\u64b2\u3002\u5167\u90e8\u5c08\u7528\u6d41\u91cf\u7684\u8ca0\u8f09\u5747\u8861\u985e\u4f3c\u65bc\u6b64\u67b6\u69cb\uff0c\u53ea\u662f\u6539\u7232\u90e8\u7f72\u5167\u90e8 TCP/UDP \u8ca0\u8f09\u5747\u8861\u5668\u3002\u5c07 L4 \u900f\u660e\u8ca0\u8f09\u5747\u8861\u8207\u7db2\u683c\u5165\u7ad9\u7db2\u95dc\u7d50\u5408\u4f7f\u7528\u5177\u6709\u4ee5\u4e0b\u512a\u52e2\uff1a- \u6b64\u8a2d\u7f6e\u7c21\u5316\u4e86\u8ca0\u8f09\u5747\u8861\u5668\u7684\u90e8\u7f72\u904e\u7a0b\u3002\n- \u5982\u679c\u96c6\u7fa3\u8b8a\u66f4\u3001\u7bc0\u9ede\u4e2d\u65b7\u6216\u8655\u7406\u4e2d\u65b7\uff0c\u5247\u8ca0\u8f09\u5747\u8861\u5668\u6703\u63d0\u4f9b\u7a69\u5b9a\u7684\u865b\u64ec IP (VIP)\u3001\u5065\u5eb7\u6aa2\u67e5\u548c\u53ef\u9760\u7684\u6d41\u91cf\u5206\u914d\u3002\n- \u6240\u6709\u8def\u7531\u898f\u5247\u3001TLS \u7d42\u7d50\u548c\u6d41\u91cf\u653f\u7b56\u90fd\u6703\u5728\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u7db2\u95dc\u4e2d\u7684\u540c\u4e00\u500b\u4f4d\u7f6e\u8655\u7406\u3002\n **\u6ce8\u610f** \uff1a\u5c0d\u65bc Anthos Service Mesh \u4e2d\u7684\u61c9\u7528\uff0c\u5916\u90e8 TCP/UDP \u8ca0\u8f09\u5747\u8861\u5668\u7684\u90e8\u7f72\u662f\u9ed8\u8a8d\u516c\u958b\u985e\u578b\u3002\u60a8\u53ef\u4ee5\u901a\u904e Kubernetes Service \u90e8\u7f72\u8ca0\u8f09\u5747\u8861\u5668\uff0c\u800c Kubernetes Service \u6703\u9078\u64c7\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u4ee3\u7406\u7684 Pod\u3002\n## GKE Ingress \u548c Service\u60a8\u53ef\u4ee5\u901a\u904e\u591a\u7a2e\u65b9\u5f0f\u7232\u96c6\u7fa3\u5916\u90e8\u7684\u5ba2\u6236\u7aef\u63d0\u4f9b\u5c0d\u61c9\u7528\u7684\u8a2a\u554f\u6b0a\u9650\u3002\u4e0b\u8868\u5217\u51fa\u4e86\u53ef\u7528\u65bc\u5728 Google Cloud \u4e0a\u90e8\u7f72\u8ca0\u8f09\u5747\u8861\u5668\u7684 Kubernetes \u57fa\u672c\u7d44\u4ef6\u3002\u7528\u65bc\u5411\u5ba2\u6236\u7aef\u516c\u958b\u61c9\u7528\u7684\u8ca0\u8f09\u5747\u8861\u5668\u7684\u985e\u578b\u5f88\u5927\u7a0b\u5ea6\u4e0a\u53d6\u6c7a\u65bc\u5ba2\u6236\u7aef\u662f\u5916\u90e8\u5ba2\u6236\u7aef\u9084\u662f\u5167\u90e8\u5ba2\u6236\u7aef\u3001\u9700\u8981\u54ea\u7a2e\u5354\u8b70\u652f\u6301\u4ee5\u53ca\u670d\u52d9\u7db2\u683c\u662f\u8de8\u8d8a\u591a\u500b GKE \u96c6\u7fa3\u9084\u662f\u5305\u542b\u5728\u55ae\u500b\u96c6\u7fa3\u4e2d\u3002\n\u4e0b\u8868\u4e2d\u7684\u4efb\u4f55\u8ca0\u8f09\u5747\u8861\u5668\u985e\u578b\u90fd\u53ef\u4ee5\u516c\u958b\u7db2\u683c\u8a17\u7ba1\u7684\u61c9\u7528\uff0c\u5177\u9ad4\u53d6\u6c7a\u65bc\u4f7f\u7528\u5834\u666f\u3002\n| GKE \u8cc7\u6e90        | \u57fa\u65bc\u96f2\u7684\u8ca0\u8f09\u5747\u8861\u5668  | \u7279\u6027                 |\n|:----------------------------------------|:------------------------|:----------------------------------------------------------------------|\n| \u9069\u7528\u65bc\u5916\u90e8 HTTP(S) \u8ca0\u8f09\u5747\u8861\u5668\u7684 Ingress | \u5916\u90e8 HTTP(S) \u8ca0\u8f09\u5747\u8861\u5668 | Google Edge \u63a5\u5165\u9ede (PoP) \u4e2d\u7684 L7 \u4ee3\u7406 \u516c\u5171 VIP \u5168\u7403\u7bc4\u570d \u55ae\u96c6\u7fa3  |\n| \u9069\u7528\u65bc\u5167\u90e8 HTTP(S) \u8ca0\u8f09\u5747\u8861\u5668\u7684 Ingress | \u5167\u90e8 HTTP(S) \u8ca0\u8f09\u5747\u8861\u5668 | Virtual Private Cloud (VPC) \u7db2\u7d61\u4e2d\u7684 L7 \u4ee3\u7406 \u5c08\u7528 VIP \u5730\u5340\u7bc4\u570d \u55ae\u96c6\u7fa3 |\n| \u5916\u90e8 LoadBalancer \u670d\u52d9     | \u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668   | Google Edge PoP \u7684 L4 \u76f4\u901a \u516c\u5171 VIP \u5730\u5340\u7bc4\u570d \u55ae\u96c6\u7fa3     |\n| \u5167\u90e8 LoadBalancer \u670d\u52d9     | \u5167\u90e8 TCP/UDP \u8ca0\u8f09\u5747\u8861\u5668 | VPC \u8def\u7531\u7db2\u7d61\u4e2d\u7684 L4 \u76f4\u901a \u5c08\u7528 VIP \u5730\u5340\u7bc4\u570d \u55ae\u96c6\u7fa3      |\n| \u591a\u96c6\u7fa3 Ingress\uff08\u591a\u96c6\u7fa3\u3001\u5916\u90e8\u5165\u7ad9\u6d41\u91cf\uff09 | \u5916\u90e8 HTTP(S) \u8ca0\u8f09\u5747\u8861\u5668 | Google Edge PoP \u4e2d\u7684 L7 \u4ee3\u7406 \u516c\u5171 VIP \u5168\u7403\u7bc4\u570d \u591a\u96c6\u7fa3     |\n **\u6ce8\u610f** \uff1a\u5118\u7ba1\u60a8\u53ef\u4ee5\u901a\u904e\u7bc0\u9ede IP \u76f4\u63a5\u516c\u958b\u5728 Anthos Service Mesh \u4e2d\u8a17\u7ba1\u7684\u61c9\u7528\uff0c\u4f46\u5c0d\u65bc\u5927\u591a\u6578\u751f\u7522\u74b0\u5883\uff0c\u6211\u5011\u4e0d\u5efa\u8b70\u4f7f\u7528\u6b64\u65b9\u6cd5\u3002\u901a\u904e\u7bc0\u9ede IP \u76f4\u63a5\u516c\u958b\u4e26\u4e0d\u7a69\u5b9a\uff0c\u9084\u53ef\u80fd\u9020\u6210\u5b89\u5168\u98a8\u96aa\u3002\u5982\u9700\u5c07\u6d41\u91cf\u5b9a\u5411\u5230 Anthos Service Mesh \u4e2d\u8a17\u7ba1\u7684\u61c9\u7528\uff0c\u5efa\u8b70\u60a8\u4f7f\u7528 L4 \u6216 L7 \u8ca0\u8f09\u5747\u8861\u5668\u3002\n\u96d6\u7136 Anthos Service Mesh \u7684\u9ed8\u8a8d\u8ca0\u8f09\u5747\u8861\u5668\u662f\u5916\u90e8 TCP/UDP \u8ca0\u8f09\u5747\u8861\u5668\uff0c\u4f46\u672c\u6559\u7a0b\u91cd\u9ede\u4ecb\u7d39\u5916\u90e8 HTTP(S) \u8ca0\u8f09\u5747\u8861\u5668\u3002\u5916\u90e8 HTTP(S) \u8ca0\u8f09\u5747\u8861\u5668\u63d0\u4f9b\u8207\u8af8\u5982 Identity-Aware Proxy (IAP)\u3001Google Cloud Armor \u548c Cloud CDN \u7b49\u908a\u7de3\u670d\u52d9\u4ee5\u53ca\u908a\u7de3\u4ee3\u7406\u7684\u5168\u7403\u5206\u4f48\u5f0f\u7db2\u7d61\u7684\u96c6\u6210\u3002\u4e0b\u4e00\u90e8\u5206\u4ecb\u7d39\u4f7f\u7528\u5169\u5c64 HTTP \u8ca0\u8f09\u5747\u8861\u7684\u67b6\u69cb\u548c\u512a\u52e2\u3002## Cloud \u5165\u7ad9\u6d41\u91cf\u548c\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u5c07\u7db2\u683c\u5916\u90e8\u7684 L7 \u8ca0\u8f09\u5747\u8861\u8207\u7db2\u683c\u5165\u7ad9\u5c64\u4e00\u8d77\u90e8\u7f72\u5177\u6709\u660e\u986f\u512a\u52e2\uff0c\u5c0d\u65bc\u4e92\u806f\u7db2\u6d41\u91cf\u800c\u8a00\u5c24\u5176\u5982\u6b64\u3002\u5373\u4f7f Anthos Service Mesh \u548c Istio \u5165\u7ad9\u6d41\u91cf\u7db2\u95dc\u5728\u7db2\u683c\u4e2d\u63d0\u4f9b\u4e86\u9ad8\u7d1a\u8def\u7531\u548c\u6d41\u91cf\u7ba1\u7406\uff0c\u67d0\u4e9b\u529f\u80fd\u4ecd\u53ef\u4ee5\u5728\u7db2\u7d61\u908a\u7de3\u5f97\u5230\u66f4\u597d\u7684\u670d\u52d9\u3002\u901a\u904e Google Cloud \u7684\u5916\u90e8 HTTP(S) \u8ca0\u8f09\u5747\u8861\u5668\u5229\u7528\u4e92\u806f\u7db2\u908a\u7de3\u7db2\u7d61\uff0c\u8f03\u4e4b\u57fa\u65bc\u7db2\u683c\u7684\u5165\u7ad9\u6d41\u91cf\uff0c\u53ef\u5728\u6027\u80fd\u3001\u53ef\u9760\u6027\u6216\u5b89\u5168\u6027\u65b9\u9762\u7372\u5f97\u986f\u8457\u7684\u512a\u52e2\u3002\u9019\u4e9b\u512a\u52e2\u5982\u4e0b\u6240\u793a\uff1a- [\u5168\u7403 Anycast VIP \u901a\u544a\u4ee5\u53ca\u904d\u4f48\u5168\u7403\u7684 TLS \u548c HTTP \u7d42\u7d50](https://cloud.google.com/security/infrastructure/design?hl=zh-cn#google_front_end_service) \n- [\u4f7f\u7528 Google Cloud Armor \u5728\u908a\u7de3\u9032\u884c DDoS \u9632\u79a6\u548c\u6d41\u91cf\u904e\u6ffe](https://cloud.google.com/armor/docs/security-policy-concepts?hl=zh-cn) \n- [\u901a\u904e IAP \u4f7f\u7528 API \u7db2\u95dc\u529f\u80fd](https://cloud.google.com/iap/docs/enabling-kubernetes-howto?hl=zh-cn) \n- [\u4f7f\u7528 Google \u7ba1\u7406\u7684\u8b49\u66f8\u81ea\u52d5\u5275\u5efa\u548c\u8f2a\u7528\u516c\u5171\u8b49\u66f8](https://cloud.google.com/kubernetes-engine/docs/how-to/managed-certs?hl=zh-cn) \n- [\u4f7f\u7528\u591a\u96c6\u7fa3 Ingress \u5728\u908a\u7de3\u5be6\u73fe\u591a\u96c6\u7fa3\u548c\u591a\u5340\u57df\u8ca0\u8f09\u5747\u8861](https://cloud.google.com/kubernetes-engine/docs/concepts/ingress-for-anthos?hl=zh-cn) \n\u6b64 L7 \u8ca0\u8f09\u5747\u8861\u7684\u5916\u90e8\u5c64\u7a31\u7232 \uff0c\u56e0\u7232\u5b83\u662f\u4ee5\u96f2\u7ba1\u7406\u7684\u8ca0\u8f09\u5747\u8861\u5668\u7232\u57fa\u790e\uff0c\u800c\u4e0d\u662f\u7531\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u4f7f\u7528\u7684\u81ea\u8a17\u7ba1\u4ee3\u7406\u3002Cloud Ingress \u548c\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u7d50\u5408\uff0c\u53ef\u5229\u7528 Google Cloud \u57fa\u790e\u67b6\u69cb\u548c\u7db2\u683c\u7684\u4e92\u88dc\u529f\u80fd\u3002\u4e0b\u5716\u8aaa\u660e\u4e86\u5982\u4f55\u5c07 Cloud Ingress \u548c\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u7d50\u5408\uff0c\u4ee5\u5145\u7576\u4e92\u806f\u7db2\u6d41\u91cf\u7684\u5169\u500b\u8ca0\u8f09\u5747\u8861\u5c64\u3002\u5728\u9019\u7a2e\u62d3\u64b2\u4e2d\uff0cCloud Ingress \u5c64\u5f9e\u670d\u52d9\u7db2\u683c\u5916\u90e8\u7372\u53d6\u6d41\u91cf\uff0c\u4e26\u5c07\u8a72\u6d41\u91cf\u5b9a\u5411\u5230\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u5c64\u3002\u7136\u5f8c\uff0c\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u5c64\u6703\u5c07\u6d41\u91cf\u5b9a\u5411\u5230\u7db2\u683c\u8a17\u7ba1\u7684\u61c9\u7528\u5f8c\u7aef\u3002## Cloud \u548c\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u62d3\u64b2\u672c\u90e8\u5206\u4ecb\u7d39\u4e86\u6bcf\u500b\u5165\u7ad9\u6d41\u91cf\u5c64\u4e00\u8d77\u4f7f\u7528\u6642\u53ef\u5be6\u73fe\u7684\u4e92\u88dc\u6027\u89d2\u8272\u3002\u9019\u4e9b\u89d2\u8272\u4e0d\u662f\u5177\u9ad4\u7684\u898f\u5247\uff0c\u800c\u662f\u5229\u7528\u6bcf\u4e00\u5c64\u512a\u9ede\u7684\u6307\u5357\u3002\u9019\u7a2e\u6a21\u5f0f\u53ef\u80fd\u6703\u6709\u8b8a\u9ad4\u7248\u672c\uff0c\u5177\u9ad4\u53d6\u6c7a\u65bc\u60a8\u7684\u4f7f\u7528\u5834\u666f\u3002- **Cloud Ingress** \u3002\u8207\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u642d\u914d\u4f7f\u7528\u6642\uff0cCloud Ingress \u5c64\u6700\u9069\u5408\u7528\u65bc\u908a\u7de3\u5b89\u5168\u548c\u5168\u7403\u8ca0\u8f09\u5747\u8861\u3002\u7531\u65bc Cloud Ingress \u5c64\u5728\u908a\u7de3\u8207 DDoS \u4fdd\u8b77\u3001\u96f2\u9632\u706b\u7246\u3001\u8eab\u4efd\u9a57\u8b49\u548c\u52a0\u5bc6\u7522\u54c1\u96c6\u6210\u5728\u4e00\u8d77\uff0c\u56e0\u6b64\u9019\u500b\u5c64\u64c5\u9577\u5728\u7db2\u683c\u5916\u90e8\u904b\u884c\u9019\u4e9b\u670d\u52d9\u3002\u8def\u7531\u908f\u8f2f\u5728\u9019\u500b\u5c64\u901a\u5e38\u5f88\u7c21\u55ae\uff0c\u4f46\u662f\u5c0d\u65bc\u591a\u96c6\u7fa3\u548c\u591a\u5730\u5340\u74b0\u5883\u800c\u8a00\uff0c\u908f\u8f2f\u53ef\u80fd\u6703\u66f4\u5fa9\u96dc\u3002\u7531\u65bc\u9762\u5411\u4e92\u806f\u7db2\u7684\u8ca0\u8f09\u5747\u8861\u5668\u7684\u95dc\u9375\u529f\u80fd\uff0cCloud Ingress \u5c64\u53ef\u80fd\u7531\u57fa\u790e\u67b6\u69cb\u5718\u968a\u7ba1\u7406\uff0c\u8a72\u5718\u968a\u5c0d\u61c9\u7528\u5728\u4e92\u806f\u7db2\u4e0a\u7684\u516c\u958b\u548c\u4fdd\u8b77\u65b9\u5f0f\u5177\u6709\u7368\u4f54\u63a7\u5236\u6b0a\u3002\u8f03\u4e4b\u958b\u767c\u8005\u9a45\u52d5\u7684\u57fa\u790e\u67b6\u69cb\uff0c\u6b64\u63a7\u5236\u6a5f\u5236\u6703\u964d\u4f4e\u6b64\u5c64\u7684\u9748\u6d3b\u6027\u548c\u52d5\u614b\u6027\uff0c\u56e0\u6b64\u5982\u679c\u8003\u616e\u4f7f\u7528\u6b64\u63a7\u5236\u6a5f\u5236\uff0c\u5247\u53ef\u80fd\u6703\u5f71\u97ff\u60a8\u8981\u5411\u8ab0\u63d0\u4f9b\u5c0d\u6b64\u5c64\u7684\u7ba1\u7406\u54e1\u6b0a\u9650\u4ee5\u53ca\u4ee5\u4f55\u7a2e\u65b9\u5f0f\u63d0\u4f9b\u3002\n- **\u7db2\u683c\u5165\u7ad9\u6d41\u91cf** \u3002\u8207 Cloud Ingress \u642d\u914d\u4f7f\u7528\u6642\uff0c\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u5c64\u63d0\u4f9b\u9760\u8fd1\u61c9\u7528\u7684\u9748\u6d3b\u8def\u7531\u3002\u7531\u65bc\u5177\u6709\u9019\u7a2e\u9748\u6d3b\u6027\uff0c\u5c0d\u65bc\u8907\u96dc\u8def\u7531\u908f\u8f2f\u548c\u61c9\u7528\u7d1a\u5225\u7684\u53ef\u898b\u6027\uff0c\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u6bd4 Cloud Ingress \u66f4\u597d\u3002\u5165\u7ad9\u6d41\u91cf\u5c64\u4e4b\u9593\u7684\u5206\u9694\u9084\u4f7f\u61c9\u7528\u6240\u6709\u8005\u80fd\u66f4\u5bb9\u6613\u5730\u76f4\u63a5\u63a7\u5236\u6b64\u5c64\uff0c\u800c\u4e0d\u6703\u5f71\u97ff\u5176\u4ed6\u5718\u968a\u3002\u901a\u904e L4 \u8ca0\u8f09\u5747\u8861\u5668\u800c\u4e0d\u662f L7 \u8ca0\u8f09\u5747\u8861\u5668\u516c\u958b\u670d\u52d9\u7db2\u683c\u61c9\u7528\u6642\uff0c\u61c9\u5728\u7db2\u683c\u5167\u90e8\u7684\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u5c64\u7d42\u7d50\u5ba2\u6236\u7aef TLS\uff0c\u4ee5\u5e6b\u52a9\u4fdd\u8b77\u61c9\u7528\u3002\n### \u5065\u5eb7\u6aa2\u67e5\u4f7f\u7528 L7 \u8ca0\u8f09\u5747\u8861\u7684\u5169\u5c64\u6240\u5e36\u4f86\u7684\u4e00\u7a2e\u8907\u96dc\u6027\u662f\u5065\u5eb7\u6aa2\u67e5\u3002\u60a8\u5fc5\u9808\u914d\u7f6e\u6bcf\u500b\u8ca0\u8f09\u5747\u8861\u5668\u4ee5\u6aa2\u67e5\u4e0b\u4e00\u5c64\u7684\u904b\u884c\u72c0\u6cc1\uff0c\u78ba\u4fdd\u5b83\u53ef\u4ee5\u63a5\u6536\u6d41\u91cf\u3002\u4e0b\u5716\u4e2d\u7684\u62d3\u64b2\u7d50\u69cb\u986f\u793a\u4e86 Cloud Ingress \u5982\u4f55\u6aa2\u67e5\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u4ee3\u7406\u7684\u904b\u884c\u72c0\u6cc1\uff0c\u800c\u7db2\u683c\u53c8\u5982\u4f55\u53cd\u904e\u4f86\u6aa2\u67e5\u61c9\u7528\u5f8c\u7aef\u7684\u904b\u884c\u72c0\u6cc1\u3002\u6b64\u62d3\u64b2\u5177\u6709\u4ee5\u4e0b\u6ce8\u610f\u4e8b\u9805\uff1a- **Cloud Ingress** \u3002\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u901a\u904e\u5165\u7ad9\u6d41\u91cf\u914d\u7f6e Google Cloud \u8ca0\u8f09\u5747\u8861\u5668\uff0c\u4ee5\u6aa2\u67e5\u6240\u516c\u958b\u5065\u5eb7\u6aa2\u67e5\u7aef\u53e3\u4e0a\u7684\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u4ee3\u7406\u7684\u5065\u5eb7\u72c0\u6cc1\u3002\u5982\u679c\u7db2\u683c\u4ee3\u7406\u95dc\u9589\uff0c\u6216\u8005\u96c6\u7fa3\u3001\u7db2\u683c\u6216\u5730\u5340\u4e0d\u53ef\u7528\uff0c\u5247 Google Cloud \u8ca0\u8f09\u5747\u8861\u5668\u6703\u6aa2\u6e2c\u6b64\u60c5\u6cc1\uff0c\u4e26\u4e14\u4e0d\u6703\u5c07\u6d41\u91cf\u767c\u9001\u5230\u7db2\u683c\u4ee3\u7406\u3002\n- **\u7db2\u683c\u5165\u7ad9\u6d41\u91cf** \u3002\u5728\u7db2\u683c\u61c9\u7528\u4e2d\uff0c\u60a8\u53ef\u4ee5\u76f4\u63a5\u5c0d\u5f8c\u7aef\u57f7\u884c\u5065\u5eb7\u6aa2\u67e5\uff0c\u4ee5\u4fbf\u53ef\u4ee5\u5728\u672c\u5730\u57f7\u884c\u8ca0\u8f09\u5747\u8861\u548c\u6d41\u91cf\u7ba1\u7406\u3002\n## \u5b89\u5168\u4e0a\u8ff0\u62d3\u64b2\u6d89\u53ca\u5e7e\u500b\u5b89\u5168\u8981\u7d20\u3002\u6700\u95dc\u9375\u7684\u8981\u7d20\u4e4b\u4e00\u662f\u5982\u4f55\u914d\u7f6e\u52a0\u5bc6\u548c\u90e8\u7f72\u8b49\u66f8\u3002 [\u7528\u65bc\u5916\u90e8 HTTP(S) \u8ca0\u8f09\u5747\u8861\u5668\u7684\u5165\u7ad9\u6d41\u91cf](https://cloud.google.com/kubernetes-engine/docs/concepts/ingress?hl=zh-cn#ingress_for_external_and_internal_traffic) \u8207 [Google \u7ba1\u7406\u7684\u8b49\u66f8](https://cloud.google.com/load-balancing/docs/ssl-certificates/google-managed-certs?hl=zh-cn) \u9032\u884c\u4e86\u6df1\u5ea6\u96c6\u6210\u3002\u6b64\u96c6\u6210\u53ef\u81ea\u52d5\u9810\u914d\u516c\u5171\u8b49\u66f8\uff0c\u5c07\u5b83\u5011\u95dc\u806f\u5230\u8ca0\u8f09\u5747\u8861\u5668\uff0c\u7136\u5f8c\u901a\u904e\u8072\u660e\u6027 GKE Ingress \u63a5\u53e3\u7e8c\u8a02\u548c\u8f2a\u7528\u8b49\u66f8\u3002\u4e92\u806f\u7db2\u5ba2\u6236\u7aef\u6839\u64da\u516c\u5171\u8b49\u66f8\u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u4e26\u4f5c\u7232 Virtual Private Cloud (VPC) \u4e2d\u7684\u7b2c\u4e00\u500b\u8e8d\u9ede\u9023\u63a5\u5230\u5916\u90e8\u8ca0\u8f09\u5747\u8861\u5668\u3002\nGoogle Front End (GFE) \u548c\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u4ee3\u7406\u4e4b\u9593\u7684\u4e0b\u4e00\u500b\u8e8d\u9ede\u6703 [\u9ed8\u8a8d\u52a0\u5bc6](https://cloud.google.com/load-balancing/docs/backend-service?hl=zh-cn#encryption_between_the_load_balancer_and_backends) \u3002GFE \u8207\u5176\u5f8c\u7aef\u4e4b\u9593\u7684\u7db2\u7d61\u7d1a\u52a0\u5bc6\u6703\u81ea\u52d5\u61c9\u7528\u3002\u4f46\u662f\uff0c\u5982\u679c\u60a8\u7684\u5b89\u5168\u8981\u6c42\u898f\u5b9a\u5e73\u81fa\u6240\u6709\u8005\u4fdd\u7559\u52a0\u5bc6\u5bc6\u9470\u7684\u6240\u6709\u6b0a\uff0c\u5247\u53ef\u4ee5\u5728\u96c6\u7fa3\u5165\u7ad9\u6d41\u91cf (GFE) \u548c\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\uff08Envoy \u4ee3\u7406\u5be6\u4f8b\uff09\u4e4b\u9593\u5553\u7528\u5177\u6709 TLS \u52a0\u5bc6\u7684 HTTP/2\u3002\u7232\u6b64\u8def\u5f91\u5553\u7528\u5177\u6709 TLS \u52a0\u5bc6\u7684 HTTP/2 \u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u81ea\u7c3d\u540d\u8b49\u66f8\u6216\u516c\u5171\u8b49\u66f8\u4f86\u52a0\u5bc6\u6d41\u91cf\uff0c\u56e0\u7232 [GFE \u4e0d\u6703\u5c0d\u5176\u9032\u884c\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/load-balancing/docs/backend-service?hl=zh-cn#encryption_between_the_load_balancer_and_backends) \u3002\u672c\u6307\u5357\u4e2d\u6f14\u793a\u4e86\u984d\u5916\u7684\u9019\u5c64\u52a0\u5bc6\u3002\u7232\u9632\u6b62\u8b49\u66f8\u88ab\u932f\u8aa4\u8655\u7406\uff0c\u8acb\u52ff\u5728\u5176\u4ed6\u5730\u65b9\u4f7f\u7528\u516c\u5171\u8ca0\u8f09\u5747\u8861\u5668\u7684\u516c\u5171\u8b49\u66f8\u3002\u76f8\u53cd\uff0c\u6211\u5011\u5efa\u8b70\u60a8\u5728\u670d\u52d9\u7db2\u683c\u4e2d\u4f7f\u7528\u55ae\u7368\u7684\u8b49\u66f8\u3002\n\u5982\u679c\u670d\u52d9\u7db2\u683c\u5f37\u5236\u57f7\u884c TLS\uff0c\u5247\u5c07\u5c0d Sidecar \u4ee3\u7406\u4e4b\u9593\u7684\u6240\u6709\u6d41\u91cf\u4ee5\u53ca\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u9032\u884c\u52a0\u5bc6\u3002\u4e0b\u5716\u8aaa\u660e\u4e86\u5f9e\u5ba2\u6236\u7aef\u5230 Google Cloud \u8ca0\u8f09\u5747\u8861\u5668\u3001\u5f9e\u8ca0\u8f09\u5747\u8861\u5668\u5230\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u4ee3\u7406\u4ee5\u53ca\u5f9e\u5165\u7ad9\u6d41\u91cf\u4ee3\u7406\u5230 Sidecar \u4ee3\u7406\u7684 HTTPS \u52a0\u5bc6\u3002## \u76ee\u6a19\n- \u5728 Google Cloud \u4e0a\u90e8\u7f72 Google Kubernetes Engine (GKE) \u96c6\u7fa3\u3002\n- \u5728 GKE \u96c6\u7fa3\u4e0a\u90e8\u7f72\u57fa\u65bc Istio \u7684 Anthos Service Mesh\u3002\n- \u914d\u7f6e GKE Ingress \u4ee5\u7d42\u7d50\u516c\u5171 HTTPS \u6d41\u91cf\uff0c\u4e26\u5c07\u8a72\u6d41\u91cf\u5b9a\u5411\u5230\u670d\u52d9\u7db2\u683c\u8a17\u7ba1\u7684\u61c9\u7528\u3002\n- \u5728\u60a8\u5411\u4e92\u806f\u7db2\u4e0a\u7684\u5ba2\u6236\u7aef\u516c\u958b\u7684 GKE \u96c6\u7fa3\u4e0a\u90e8\u7f72 Online Boutique \u61c9\u7528\u3002\n## \u8cbb\u7528\nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728\u672c\u6587\u6a94\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Google Cloud \u7684\u4ee5\u4e0b\u6536\u8cbb\u7d44\u4ef6\uff1a- [Google Kubernetes Engine](https://cloud.google.com/kubernetes-engine/pricing?hl=zh-cn) \n- [Compute Engine](https://cloud.google.com/compute/all-pricing?hl=zh-cn) \n- [Cloud Load Balancing](https://cloud.google.com/vpc/network-pricing?hl=zh-cn#lb) \n- [Anthos Service Mesh](https://cloud.google.com/service-mesh/pricing?hl=zh-cn) \n- [Google Cloud Armor](https://cloud.google.com/armor/pricing?hl=zh-cn) \n- [Cloud Endpoints](https://cloud.google.com/endpoints/pricing?hl=zh-cn) \n\u60a8\u53ef\u4f7f\u7528 [\u50f9\u683c\u8a08\u7b97\u5668](https://cloud.google.com/products/calculator?hl=zh-cn) \u6839\u64da\u60a8\u7684\u9810\u8a08\u4f7f\u7528\u60c5\u6cc1\u4f86\u4f30\u7b97\u8cbb\u7528\u3002 \nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5b8c\u6210\u672c\u6587\u6a94\u4e2d\u63cf\u8ff0\u7684\u4efb\u52d9\u5f8c\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u522a\u9664\u6240\u5275\u5efa\u7684\u8cc7\u6e90\u4f86\u907f\u514d\u7e7c\u7e8c\u8a08\u8cbb\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u6e05\u7406](#clean-up) \u3002## \u6e96\u5099\u5de5\u4f5c- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728 Google Cloud Console \u4e2d\u7684\u9805\u76ee\u9078\u64c7\u5668\u9801\u9762\u4e0a\uff0c\u9078\u64c7\u6216 [\u5275\u5efa\u4e00\u500b Google Cloud \u9805\u76ee](https://cloud.google.com/resource-manager/docs/creating-managing-projects?hl=zh-cn) \u3002 **\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u4e0d\u6253\u7b97\u4fdd\u7559\u5728\u6b64\u904e\u7a0b\u4e2d\u5275\u5efa\u7684\u8cc7\u6e90\uff0c\u8acb\u5275\u5efa\u65b0\u7684\u9805\u76ee\uff0c\u800c\u4e0d\u8981\u9078\u64c7\u73fe\u6709\u7684\u9805\u76ee\u3002\u5b8c\u6210\u672c\u6559\u7a0b\u4ecb\u7d39\u7684\u6b65\u9a5f\u5f8c\uff0c\u60a8\u53ef\u4ee5\u522a\u9664\u6240\u5275\u5efa\u7684\u9805\u76ee\uff0c\u4e26\u79fb\u9664\u8207\u8a72\u9805\u76ee\u95dc\u806f\u7684\u6240\u6709\u8cc7\u6e90\u3002 [\u8f49\u5230\u201c\u9805\u76ee\u9078\u64c7\u5668\u201d](https://console.cloud.google.com/projectselector2/home/dashboard?hl=zh-cn) \n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them [\u78ba\u4fdd\u60a8\u7684 Google Cloud \u9805\u76ee\u5df2\u5553\u7528\u7d50\u7b97\u529f\u80fd](https://cloud.google.com/billing/docs/how-to/verify-billing-enabled?hl=zh-cn#console) \u3002\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u6fc0\u6d3b Cloud Shell\u3002 [\u6fc0\u6d3b Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn) \u60a8\u5c07\u901a\u904e Cloud Shell \u904b\u884c\u672c\u6559\u7a0b\u4e2d\u7684\u6240\u6709\u7d42\u7aef\u547d\u4ee4\u3002\n- \u5347\u7d1a\u5230\u6700\u65b0\u7248\u672c\u7684 Google Cloud CLI\uff1a```\ngcloud components update\n```\n- \u8a2d\u7f6e\u9ed8\u8a8d\u7684 Google Cloud \u9805\u76ee\uff1a```\nexport PROJECT=PROJECTexport PROJECT_NUMBER=$(gcloud projects describe ${PROJECT} --format=\"value(projectNumber)\")gcloud config set project ${PROJECT}\n```\u5c07 `` \u66ff\u63db\u7232\u60a8\u8981\u7528\u65bc\u672c\u6559\u7a0b\u7684\u9805\u76ee ID\u3002\n- \u5275\u5efa\u5de5\u4f5c\u76ee\u9304\uff1a```\nmkdir -p ${HOME}/edge-to-meshcd ${HOME}/edge-to-meshexport WORKDIR=`pwd`\n```\u5b8c\u6210\u672c\u6559\u7a0b\u5f8c\uff0c\u60a8\u53ef\u4ee5\u522a\u9664\u5de5\u4f5c\u76ee\u9304\u3002\n## \u5275\u5efa GKE \u96c6\u7fa3\u672c\u6559\u7a0b\u4e2d\u4ecb\u7d39\u7684\u529f\u80fd\u9700\u8981\u4f7f\u7528 GKE \u96c6\u7fa3 1.16 \u6216\u66f4\u9ad8\u7248\u672c\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa\u4e00\u500b\u65b0\u7684 `kubeconfig` \u6587\u4ef6\u3002\u6b64\u6b65\u9a5f\u78ba\u4fdd\u4e0d\u6703\u5c0e\u81f4\u8207\u73fe\u6709\uff08\u9ed8\u8a8d\uff09 `kubeconfig` \u6587\u4ef6\u885d\u7a81\u3002```\ntouch edge2mesh_kubeconfigexport KUBECONFIG=${WORKDIR}/edge2mesh_kubeconfig\n```\n- \u7232 GKE \u96c6\u7fa3\u5b9a\u7fa9\u74b0\u5883\u8b8a\u91cf\uff1a```\nexport CLUSTER_NAME=edge-to-meshexport CLUSTER_LOCATION=us-west1-a\n```\n- \u5553\u7528 Google Kubernetes Engine API\u3002\n```\ngcloud services enable container.googleapis.com\n```\n\u672c\u6559\u7a0b\u5305\u542b [Config Connector](https://cloud.google.com/config-connector/docs/overview?hl=zh-cn) \u8cc7\u6e90\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u9019\u4e9b\u8cc7\u6e90\u4f86\u5b8c\u6210\u8207\u60a8\u5728 `gcloud` \u6a19\u7c64\u9801\u4e2d\u5b8c\u6210\u7684\u76f8\u540c\u4efb\u52d9\u3002\u5982\u9700\u4f7f\u7528\u9019\u4e9b\u8cc7\u6e90\uff0c\u8acb [\u5b89\u88dd Config Connector](https://cloud.google.com/config-connector/docs/concepts/installation-types?hl=zh-cn) \uff0c\u7136\u5f8c\u4ee5\u6700\u9069\u5408\u60a8\u7684\u74b0\u5883\u7684\u65b9\u5f0f\u61c9\u7528\u9019\u4e9b\u8cc7\u6e90\u3002\n\u4f7f\u7528\u4ee5\u4e0b [Services](https://cloud.google.com/config-connector/docs/reference/resource-docs/serviceusage/service?hl=zh-cn) \u6e05\u55ae\uff1a\n```\napiVersion: serviceusage.cnrm.cloud.google.com/v1beta1kind: Servicemetadata:\u00a0 annotations:\u00a0 \u00a0 cnrm.cloud.google.com/deletion-policy: \"abandon\"\u00a0 \u00a0 cnrm.cloud.google.com/disable-dependent-services: \"false\"\u00a0 name: container.googleapis.comspec:\u00a0 resourceID: container.googleapis.com\u00a0 projectRef:\u00a0 \u00a0 external: PROJECT\n```\n- \u5275\u5efa GKE \u96c6\u7fa3\u3002\n```\ngcloud container clusters create ${CLUSTER_NAME} \\\u00a0 \u00a0 --machine-type=e2-standard-4 \\\u00a0 \u00a0 --num-nodes=4 \\\u00a0 \u00a0 --zone ${CLUSTER_LOCATION} \\\u00a0 \u00a0 --enable-ip-alias \\\u00a0 \u00a0 --workload-pool=${PROJECT}.svc.id.goog \\\u00a0 \u00a0 --release-channel rapid \\\u00a0 \u00a0 --addons HttpLoadBalancing \\\u00a0 \u00a0 --labels mesh_id=proj-${PROJECT_NUMBER}\n```\n\u4f7f\u7528\u4ee5\u4e0b [ContainerCluster](https://cloud.google.com/config-connector/docs/reference/resource-docs/container/containercluster?hl=zh-cn) \u548c [ContainerNodePool](https://cloud.google.com/config-connector/docs/reference/resource-docs/container/containernodepool?hl=zh-cn) \u6e05\u55ae\uff1a\n```\napiVersion: container.cnrm.cloud.google.com/v1beta1kind: ContainerNodePoolmetadata:\u00a0 annotations:\u00a0 \u00a0 cnrm.cloud.google.com/project-id: PROJECT\u00a0 name: edge-to-meshspec:\u00a0 clusterRef:\u00a0 \u00a0 name: edge-to-mesh\u00a0 location: us-west1-a\u00a0 nodeConfig:\u00a0 \u00a0 machineType: e2-standard-4\u00a0 nodeCount: 4---apiVersion: container.cnrm.cloud.google.com/v1beta1kind: ContainerClustermetadata:\u00a0 annotations:\u00a0 \u00a0 cnrm.cloud.google.com/project-id: PROJECT\u00a0 \u00a0 cnrm.cloud.google.com/remove-default-node-pool: \"true\"\u00a0 labels:\u00a0 \u00a0 mesh_id: proj-PROJECT_NUMBER\u00a0 name: edge-to-meshspec:\u00a0 addonsConfig:\u00a0 \u00a0 httpLoadBalancing:\u00a0 \u00a0 \u00a0 disabled: false\u00a0 location: us-west1-a\u00a0 initialNodeCount: 1\u00a0 releaseChannel:\u00a0 \u00a0 channel: RAPID\u00a0 workloadIdentityConfig:\u00a0 \u00a0 workloadPool: PROJECT.svc.id.goog\n```\n\u5c07 `PROJECT_NUMBER` \u66ff\u63db\u7232\u4e4b\u524d\u6aa2\u7d22\u5230\u7684 `PROJECT_NUMBER` \u74b0\u5883\u8b8a\u91cf\u7684\u503c\u3002\n\u5982\u9700\u4f7f\u7528\u96f2\u5165\u7ad9\u6d41\u91cf\uff0c\u60a8\u5fc5\u9808\u5553\u7528 HTTP \u8ca0\u8f09\u5747\u8861\u63d2\u4ef6\u3002GKE \u96c6\u7fa3\u9ed8\u8a8d\u5553\u7528\u4e86 HTTP \u8ca0\u8f09\u5747\u8861\uff1b\u60a8\u4e0d\u5f97\u5c07\u5176\u505c\u7528\u3002\u5982\u9700\u4f7f\u7528\u4ee3\u7ba1\u5f0f Anthos Service Mesh\uff0c\u60a8\u5fc5\u9808\u5728\u96c6\u7fa3\u4e0a\u61c9\u7528 `mesh_id` \u6a19\u7c64\u3002\n- \u78ba\u4fdd\u8a72\u96c6\u7fa3\u6b63\u5728\u904b\u884c\uff1a```\ngcloud container clusters list\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nNAME   LOCATION MASTER_VERSION MASTER_IP  MACHINE_TYPE NODE_VERSION  NUM_NODES STATUS\nedge-to-mesh us-west1-a v1.22.6-gke.300 35.233.195.59 e2-standard-4 v1.22.6-gke.300 4   RUNNING\n```\n- \u9023\u63a5\u5230\u8a72\u96c6\u7fa3\uff1a```\ngcloud container clusters get-credentials ${CLUSTER_NAME} \\\u00a0 \u00a0 --zone ${CLUSTER_LOCATION} \\\u00a0 \u00a0 --project ${PROJECT}\n```\n## \u5b89\u88dd\u670d\u52d9\u7db2\u683c\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u914d\u7f6e [\u4f7f\u7528\u968a\u5217 API \u7684\u4ee3\u7ba1\u5f0f Anthos Service Mesh](https://cloud.google.com/service-mesh/docs/managed/auto-control-plane-with-fleet?hl=zh-cn) \u3002- \u5553\u7528\u5fc5\u9700\u7684 API\uff1a\n```\ngcloud services enable mesh.googleapis.com\n```\n\u4f7f\u7528\u4ee5\u4e0b [Services](https://cloud.google.com/config-connector/docs/reference/resource-docs/serviceusage/service?hl=zh-cn) \u6e05\u55ae\uff1a\n```\napiVersion: serviceusage.cnrm.cloud.google.com/v1beta1kind: Servicemetadata:\u00a0 annotations:\u00a0 \u00a0 cnrm.cloud.google.com/deletion-policy: \"abandon\"\u00a0 \u00a0 cnrm.cloud.google.com/disable-dependent-services: \"false\"\u00a0 name: mesh.googleapis.comspec:\u00a0 resourceID: mesh.googleapis.com\u00a0 projectRef:\u00a0 \u00a0 external: PROJECT\n```\n- \u5728\u8266\u968a\u4e0a\u5553\u7528 Anthos Service Mesh\uff1a\n```\ngcloud container fleet mesh enable\n```\n\u4f7f\u7528\u4ee5\u4e0b [GKEHubFeature](https://cloud.google.com/config-connector/docs/reference/resource-docs/gkehub/gkehubfeature?hl=zh-cn) \u6e05\u55ae\uff1a\n```\napiVersion: gkehub.cnrm.cloud.google.com/v1beta1kind: GKEHubFeaturemetadata:\u00a0 name: servicemeshspec:\u00a0 projectRef:\u00a0 \u00a0 external: PROJECT\u00a0 location: global\u00a0 resourceID: servicemesh\n```\n- \u5c07\u96c6\u7fa3\u8a3b\u518a\u5230\u8266\u968a\uff1a\n```\ngcloud container fleet memberships register ${CLUSTER_NAME} \\\u00a0 \u00a0 --gke-cluster ${CLUSTER_LOCATION}/${CLUSTER_NAME} \\\u00a0 \u00a0 --enable-workload-identity\n```\n\u4f7f\u7528\u4ee5\u4e0b [GKEHubMembership](https://cloud.google.com/config-connector/docs/reference/resource-docs/gkehub/gkehubmembership?hl=zh-cn) \u6e05\u55ae\uff1a\n```\napiVersion: gkehub.cnrm.cloud.google.com/v1beta1kind: GKEHubMembershipmetadata:\u00a0 annotations:\u00a0 \u00a0 cnrm.cloud.google.com/project-id: PROJECT\u00a0 name: edge-to-meshspec:\u00a0 location: global\u00a0 authority:\u00a0 \u00a0 issuer: https://container.googleapis.com/v1/projects/PROJECT/locations/us-west1-a/clusters/edge-to-mesh\u00a0 endpoint:\u00a0 \u00a0 gkeCluster:\u00a0 \u00a0 \u00a0 resourceRef:\u00a0 \u00a0 \u00a0 \u00a0 name: edge-to-mesh\n```\n- \u5553\u7528\u81ea\u52d5\u63a7\u5236\u5e73\u9762\u7ba1\u7406\u548c\u4ee3\u7ba1\u5f0f\u6578\u64da\u5e73\u9762\uff1a\n```\ngcloud container fleet mesh update \\\u00a0 \u00a0 --management automatic \\\u00a0 \u00a0 --memberships ${CLUSTER_NAME}\n```\n\u4f7f\u7528\u4ee5\u4e0b [GKEHubFeatureMembership](https://cloud.google.com/config-connector/docs/reference/resource-docs/gkehub/gkehubfeaturemembership?hl=zh-cn) \u6e05\u55ae\uff1a\n```\napiVersion: gkehub.cnrm.cloud.google.com/v1beta1kind: GKEHubFeatureMembershipmetadata:\u00a0 name: servicemesh-membershipspec:\u00a0 projectRef:\u00a0 \u00a0 external: PROJECT_ID\u00a0 location: global\u00a0 membershipRef:\u00a0 \u00a0 name: edge-to-mesh\u00a0 featureRef:\u00a0 \u00a0 name: servicemesh\u00a0 mesh:\u00a0 \u00a0 management: MANAGEMENT_AUTOMATIC\n```\n- \u5e7e\u5206\u9418\u5f8c\uff0c\u9a57\u8b49\u63a7\u5236\u5e73\u9762\u72c0\u614b\u662f\u5426\u7232 `ACTIVE` \uff1a```\ngcloud container fleet mesh describe\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\n...\nmembershipSpecs:\n projects/841956571429/locations/global/memberships/edge-to-mesh:\n mesh:\n  management: MANAGEMENT_AUTOMATIC\nmembershipStates:\n projects/841956571429/locations/global/memberships/edge-to-mesh:\n servicemesh:\n  controlPlaneManagement:\n  details:\n  - code: REVISION_READY\n   details: 'Ready: asm-managed-rapid'\n  state: ACTIVE\n  dataPlaneManagement:\n  details:\n  - code: OK\n   details: Service is running.\n  state: ACTIVE\n state:\n  code: OK\n  description: 'Revision(s) ready for use: asm-managed-rapid.'\n  updateTime: '2022-09-29T05:30:28.320896186Z'\nname: projects/your-project/locations/global/features/servicemesh\nresourceState:\n state: ACTIVE\n...\n```\n## \u90e8\u7f72 GKE Ingress\u5728\u4ee5\u4e0b\u6b65\u9a5f\u4e2d\uff0c\u60a8\u5c07\u901a\u904e GKE \u7684 Ingress \u63a7\u5236\u5668\u90e8\u7f72\u5916\u90e8 HTTP(S) \u8ca0\u8f09\u5747\u8861\u5668\u3002Ingress \u8cc7\u6e90\u6703\u81ea\u52d5\u57f7\u884c\u8ca0\u8f09\u5747\u8861\u5668\u3001\u8ca0\u8f09\u5747\u8861\u5668 TLS \u8b49\u66f8\u4ee5\u53ca\u5f8c\u7aef\u5065\u5eb7\u6aa2\u67e5\u7684\u9810\u914d\u3002\u6b64\u5916\uff0c\u60a8\u9084\u53ef\u4ee5\u4f7f\u7528 Cloud Endpoints \u81ea\u52d5\u7232\u61c9\u7528\u9810\u914d\u516c\u5171 DNS \u540d\u7a31\u3002\n### \u5b89\u88dd\u5165\u7ad9\u6d41\u91cf\u7db2\u95dc\u7232\u4fdd\u8b49\u5b89\u5168\u6027\uff0c\u6211\u5011\u5efa\u8b70\u5728\u8207\u63a7\u5236\u5c64\u9762\u4e0d\u540c\u7684\u547d\u540d\u7a7a\u9593\u4e2d\u90e8\u7f72\u5165\u7ad9\u6d41\u91cf\u7db2\u95dc\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa\u4e00\u500b\u5c08\u7528\u7684 `asm-ingress` \u547d\u540d\u7a7a\u9593\uff1a```\nkubectl create namespace asm-ingress\n```\n- \u5c07\u547d\u540d\u7a7a\u9593\u6a19\u7c64\u6dfb\u52a0\u5230 `asm-ingress` \u547d\u540d\u7a7a\u9593\uff1a```\nkubectl label namespace asm-ingress istio-injection=enabled\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nnamespace/asm-ingress labeled\n```\u4f7f\u7528 `istio-injection=enabled` \u7232 `asm-ingress` \u547d\u540d\u7a7a\u9593\u6dfb\u52a0\u6a19\u7c64\u6703\u6307\u793a Anthos Service Mesh \u5728\u90e8\u7f72\u61c9\u7528\u6642\u81ea\u52d5\u6ce8\u5165 Envoy \u908a\u8eca\u4ee3\u7406\u3002\n- \u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5c07 `Deployment` \u6e05\u55ae\u5275\u5efa\u7232 `ingress-deployment.yaml` \uff1a```\ncat <<EOF > ingress-deployment.yamlapiVersion: apps/v1kind: Deploymentmetadata:\u00a0 name: asm-ingressgateway\u00a0 namespace: asm-ingressspec:\u00a0 selector:\u00a0 \u00a0 matchLabels:\u00a0 \u00a0 \u00a0 asm: ingressgateway\u00a0 template:\u00a0 \u00a0 metadata:\u00a0 \u00a0 \u00a0 annotations:\u00a0 \u00a0 \u00a0 \u00a0 # This is required to tell Anthos Service Mesh to inject the gateway with the\u00a0 \u00a0 \u00a0 \u00a0 # required configuration.\u00a0 \u00a0 \u00a0 \u00a0 inject.istio.io/templates: gateway\u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 asm: ingressgateway\u00a0 \u00a0 spec:\u00a0 \u00a0 \u00a0 securityContext:\u00a0 \u00a0 \u00a0 \u00a0 fsGroup: 1337\u00a0 \u00a0 \u00a0 \u00a0 runAsGroup: 1337\u00a0 \u00a0 \u00a0 \u00a0 runAsNonRoot: true\u00a0 \u00a0 \u00a0 \u00a0 runAsUser: 1337\u00a0 \u00a0 \u00a0 containers:\u00a0 \u00a0 \u00a0 - name: istio-proxy\u00a0 \u00a0 \u00a0 \u00a0 securityContext:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 allowPrivilegeEscalation: false\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 capabilities:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 drop:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - all\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 privileged: false\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 readOnlyRootFilesystem: true\u00a0 \u00a0 \u00a0 \u00a0 image: auto # The image will automatically update each time the pod starts.\u00a0 \u00a0 \u00a0 \u00a0 resources:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 limits:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 cpu: 2000m\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 memory: 1024Mi\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 requests:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 cpu: 100m\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 memory: 128Mi\u00a0 \u00a0 \u00a0 serviceAccountName: asm-ingressgateway---apiVersion: autoscaling/v2kind: HorizontalPodAutoscalermetadata:\u00a0 name: asm-ingressgateway\u00a0 namespace: asm-ingressspec:\u00a0 maxReplicas: 5\u00a0 minReplicas: 3\u00a0 metrics:\u00a0 - type: Resource\u00a0 \u00a0 resource:\u00a0 \u00a0 \u00a0 name: cpu\u00a0 \u00a0 \u00a0 target:\u00a0 \u00a0 \u00a0 \u00a0 type: Utilization\u00a0 \u00a0 \u00a0 \u00a0 averageUtilization: 50\u00a0 scaleTargetRef:\u00a0 \u00a0 apiVersion: apps/v1\u00a0 \u00a0 kind: Deployment\u00a0 \u00a0 name: asm-ingressgateway---apiVersion: rbac.authorization.k8s.io/v1kind: Rolemetadata:\u00a0 name: asm-ingressgateway\u00a0 namespace: asm-ingressrules:- apiGroups: [\"\"]\u00a0 resources: [\"secrets\"]\u00a0 verbs: [\"get\", \"watch\", \"list\"]---apiVersion: rbac.authorization.k8s.io/v1kind: RoleBindingmetadata:\u00a0 name: asm-ingressgateway\u00a0 namespace: asm-ingressroleRef:\u00a0 apiGroup: rbac.authorization.k8s.io\u00a0 kind: Role\u00a0 name: asm-ingressgatewaysubjects:\u00a0 - kind: ServiceAccount\u00a0 \u00a0 name: asm-ingressgateway---apiVersion: v1kind: ServiceAccountmetadata:\u00a0 name: asm-ingressgateway\u00a0 namespace: asm-ingressEOF\n```\u6b64 `Deployment` \u5177\u6709\u81ea\u5df1\u7684 `ServiceAccount` \u4ee5\u53ca\u95dc\u806f\u7684 `Role` \u548c `RoleBinding` \uff0c\u5141\u8a31\u7db2\u95dc\u8a2a\u554f\u8b49\u66f8\u3002\n- \u5728\u96c6\u7fa3\u4e2d\u90e8\u7f72 `ingress-deployment.yaml` \u4ee5\u5275\u5efa `Deployment` \u8cc7\u6e90\uff1a```\nkubectl apply -f ingress-deployment.yaml\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\ndeployment.apps/asm-ingressgateway configured\nrole.rbac.authorization.k8s.io/asm-ingressgateway configured\nrolebinding.rbac.authorization.k8s.io/asm-ingressgateway configured\nserviceaccount/asm-ingressgateway created\n```\u78ba\u4fdd\u6240\u6709\u90e8\u7f72\u90fd\u5df2\u5553\u52d5\u4e26\u904b\u884c\uff1a```\nkubectl wait --for=condition=available --timeout=600s deployment --all -n asm-ingress\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\ndeployment.apps/asm-ingressgateway condition met\n```\n- \u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5c07 `Service` \u6e05\u55ae\u5275\u5efa\u7232 `ingress-service.yaml` \uff1a```\ncat <<EOF > ingress-service.yamlapiVersion: v1kind: Servicemetadata:\u00a0 name: asm-ingressgateway\u00a0 namespace: asm-ingress\u00a0 annotations:\u00a0 \u00a0 cloud.google.com/neg: '{\"ingress\": true}'\u00a0 \u00a0 cloud.google.com/backend-config: '{\"default\": \"ingress-backendconfig\"}'\u00a0 \u00a0 cloud.google.com/app-protocols: '{\"https\":\"HTTP2\"}' # HTTP/2 with TLS encryption\u00a0 labels:\u00a0 \u00a0 asm: ingressgatewayspec:\u00a0 ports:\u00a0 # status-port exposes a /healthz/ready endpoint that can be used with GKE Ingress health checks\u00a0 - name: status-port\u00a0 \u00a0 port: 15021\u00a0 \u00a0 protocol: TCP\u00a0 \u00a0 targetPort: 15021\u00a0 # Any ports exposed in Gateway resources should be exposed here.\u00a0 - name: http2\u00a0 \u00a0 port: 80\u00a0 \u00a0 targetPort: 8080\u00a0 - name: https\u00a0 \u00a0 port: 443\u00a0 \u00a0 targetPort: 8443\u00a0 selector:\u00a0 \u00a0 asm: ingressgateway\u00a0 type: ClusterIPEOF\n```\u6b64 `Service` \u5177\u6709\u4ee5\u4e0b\u6ce8\u91cb\uff0c\u53ef\u5728\u90e8\u7f72 Ingress \u8ca0\u8f09\u5747\u8861\u5668\u6642\u8a2d\u7f6e\u5176\u53c3\u6578\uff1a- `cloud.google.com/backend-config`\u662f\u6307\u540d\u7232 [BackendConfig](https://cloud.google.com/kubernetes-engine/docs/how-to/ingress-features?hl=zh-cn#configuring_ingress_features) \u7684\u81ea\u5b9a\u7fa9\u8cc7\u6e90\u7684\u540d\u7a31\u3002Ingress \u63a7\u5236\u5668\u4f7f\u7528`BackendConfig`\u8a2d\u7f6e Google Cloud`BackendService`\u8cc7\u6e90\u7684\u53c3\u6578\u3002\u60a8\u53ef\u4ee5\u5728\u4e0b\u4e00\u6b65\u4e2d\u4f7f\u7528\u6b64\u8cc7\u6e90\u4f86\u5b9a\u7fa9 Google Cloud \u5065\u5eb7\u6aa2\u67e5\u7684\u81ea\u5b9a\u7fa9\u53c3\u6578\u3002\n- `cloud.google.com/neg: '{\"ingress\": true}'`\u7528\u65bc\u5553\u7528\u5bb9\u5668\u539f\u751f\u8ca0\u8f09\u5747\u8861\u7684 Ingress \u5f8c\u7aef\uff08\u672c\u4f8b\u4e2d\u7232\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u4ee3\u7406\uff09\u3002\u7232\u4e86\u66f4\u6709\u6548\u3001\u66f4\u7a69\u5b9a\u5730\u5be6\u73fe\u8ca0\u8f09\u5747\u8861\uff0c\u9019\u4e9b\u5f8c\u7aef\u4f7f\u7528 [\u7db2\u7d61\u7aef\u9ede\u7d44 (NEG)](https://cloud.google.com/load-balancing/docs/negs?hl=zh-cn) \u4ee3\u66ff\u5be6\u4f8b\u7d44\u3002\n- \u7232\u4e86\u7372\u5f97\u984d\u5916\u52a0\u5bc6\u5c64\uff0c`cloud.google.com/app-protocols: '{\"https\":\"HTTP2\"}'`\u6307\u793a GFE \u4f7f\u7528\u5177\u6709 TLS \u7684 HTTP2 \u9023\u63a5\u5230\u670d\u52d9\u7db2\u683c\u7684\u5165\u7ad9\u7db2\u95dc\uff0c\u5982 [\u9069\u7528\u65bc\u5916\u90e8 HTTP(S) \u8ca0\u8f09\u5747\u8861\u7684 Ingress](https://cloud.google.com/kubernetes-engine/docs/concepts/ingress-xlb?hl=zh-cn#https_tls_between_load_balancer_and_your_application) \u548c [\u5916\u90e8 HTTP(S) \u8ca0\u8f09\u5747\u8861\u6982\u89bd](https://cloud.google.com/load-balancing/docs/https?hl=zh-cn#protocol_to_the_backends) \u6240\u8ff0\u3002\n- \u5728\u96c6\u7fa3\u4e2d\u90e8\u7f72 `ingress-service.yaml` \u4ee5\u5275\u5efa `Service` \u8cc7\u6e90\uff1a```\nkubectl apply -f ingress-service.yaml\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nservice/asm-ingressgateway created\n```\n### \u61c9\u7528\u5f8c\u7aef\u670d\u52d9\u8a2d\u7f6e\n- \u5728 Cloud Shell \u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u5c07 `BackendConfig` \u6e05\u55ae\u5275\u5efa\u7232 `ingress-backendconfig.yaml` \uff1a```\ncat <<EOF > ingress-backendconfig.yamlapiVersion: cloud.google.com/v1kind: BackendConfigmetadata:\u00a0 name: ingress-backendconfig\u00a0 namespace: asm-ingressspec:\u00a0 healthCheck:\u00a0 \u00a0 requestPath: /healthz/ready\u00a0 \u00a0 port: 15021\u00a0 \u00a0 type: HTTP\u00a0 securityPolicy:\u00a0 \u00a0 name: edge-fw-policyEOF\n````BackendConfig` \u662f\u81ea\u5b9a\u7fa9\u8cc7\u6e90\u5b9a\u7fa9 (CRD)\uff0c\u7528\u65bc\u5b9a\u7fa9 Ingress \u8ca0\u8f09\u5747\u8861\u7684\u5f8c\u7aef\u53c3\u6578\u3002\u5982\u9700\u67e5\u770b\u53ef\u901a\u904e GKE Ingress \u914d\u7f6e\u7684\u5f8c\u7aef\u548c\u524d\u7aef\u53c3\u6578\u7684\u5b8c\u6574\u5217\u8868\uff0c\u8acb\u53c3\u95b1 [Ingress \u529f\u80fd](https://cloud.google.com/kubernetes-engine/docs/how-to/ingress-features?hl=zh-cn) \u3002\u5728\u672c\u6559\u7a0b\u4e2d\uff0c `BackendConfig` \u6e05\u55ae\u6307\u5b9a\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u4ee3\u7406\u7684\u81ea\u5b9a\u7fa9\u5065\u5eb7\u6aa2\u67e5\u3002Anthos Service Mesh \u548c Istio \u5728 `/healthz/ready` \u8def\u5f91\u7684\u7aef\u53e3 `15021` \u4e0a\u516c\u958b [Sidecar \u4ee3\u7406\u5065\u5eb7\u6aa2\u67e5](https://istio.io/latest/docs/ops/deployment/requirements/#ports-used-by-istio) \u3002 [\u81ea\u5b9a\u7fa9\u5065\u5eb7\u6aa2\u67e5\u53c3\u6578](https://cloud.google.com/kubernetes-engine/docs/concepts/ingress?hl=zh-cn#direct_hc) \u662f\u5fc5\u9700\u7684\uff0c\u56e0\u7232\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u4ee3\u7406\u7684\u670d\u52d9\u7aef\u53e3 ( `443` ) \u8207\u5065\u5eb7\u6aa2\u67e5\u7aef\u53e3 ( `15021` ) \u4e0d\u540c\u3002GKE Ingress \u5728 `BackendConfig` \u4e2d\u4f7f\u7528\u4ee5\u4e0b\u5065\u5eb7\u6aa2\u67e5\u53c3\u6578\u4f86\u914d\u7f6e Google Cloud \u8ca0\u8f09\u5747\u8861\u5668\u5065\u5eb7\u6aa2\u67e5\u3002\u6b64\u5916\uff0c\u9084\u5f15\u7528\u4e86\u5b89\u5168\u653f\u7b56\uff0c\u4ee5\u5e6b\u52a9\u9632\u7bc4\u4f86\u81ea\u4e0d\u540c\u985e\u578b\u7684\u7db2\u7d61\u653b\u64ca\u7684\u8ca0\u8f09\u5747\u8861\u6d41\u91cf\u3002- `healthCheck.port`\u6703\u5b9a\u7fa9\u7aef\u53e3\uff0c\u4ee5\u5728\u6bcf\u500b Pod \u7684 IP \u5730\u5740\u4e0a\u63a5\u6536 Google Cloud \u8ca0\u8f09\u5747\u8861\u5668\u57f7\u884c\u7684\u5065\u5eb7\u6aa2\u67e5\u3002\n- `healthCheck.requestPath`\u6703\u5b9a\u7fa9 HTTP \u8def\u5f91\uff0c\u4ee5\u5728\u6307\u5b9a\u7aef\u53e3\u4e0a\u63a5\u6536\u5065\u5eb7\u6aa2\u67e5\u3002\n- `type`\u6703\u5b9a\u7fa9\u5065\u5eb7\u6aa2\u67e5\u7684\u5354\u8b70\uff08\u5728\u6b64\u793a\u4f8b\u4e2d\u7232 HTTP\uff09\u3002\n- `securityPolicy.name`\u662f\u6307 [Cloud Armor \u5b89\u5168\u653f\u7b56](https://cloud.google.com/armor/docs/configure-security-policies?hl=zh-cn) \u7684\u540d\u7a31\u3002\n- \u5728\u96c6\u7fa3\u4e2d\u90e8\u7f72 `ingress-backendconfig.yaml` \u4ee5\u5275\u5efa `BackendConfig` \u8cc7\u6e90\uff1a```\nkubectl apply -f ingress-backendconfig.yaml\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nbackendconfig.cloud.google.com/ingress-backendconfig created\n```\u5728\u90e8\u7f72 Ingress \u8cc7\u6e90\u4e4b\u524d\uff0c `BackendConfig` \u53c3\u6578\u548c `asm-ingressgateway` Service \u8a3b\u91cb\u4e0d\u6703\u61c9\u7528\u65bc Google Cloud \u8ca0\u8f09\u5747\u8861\u5668\u3002Ingress \u90e8\u7f72\u6703\u5c07\u6240\u6709\u9019\u4e9b\u8cc7\u6e90\u76f8\u95dc\u806f\u3002\n### \u5b9a\u7fa9\u5b89\u5168\u653f\u7b56 [Google Cloud Armor](https://cloud.google.com/armor?hl=zh-cn) \u63d0\u4f9b\u7684 DDoS \u9632\u79a6\u548c [\u53ef\u81ea\u5b9a\u7fa9\u7684\u5b89\u5168\u7b56\u7565](https://cloud.google.com/armor/docs/configure-security-policies?hl=zh-cn) \u53ef\u901a\u904e Ingress \u8cc7\u6e90\u95dc\u806f\u81f3\u8ca0\u8f09\u5747\u8861\u5668\u3002\u5728\u4ee5\u4e0b\u6b65\u9a5f\u4e2d\uff0c\u60a8\u5c07\u5275\u5efa\u5b89\u5168\u653f\u7b56\uff0c\u4ee5\u4f7f\u7528 [\u9810\u914d\u7f6e\u898f\u5247](https://cloud.google.com/armor/docs/rule-tuning?hl=zh-cn#preconfigured_rules) \u4f86\u963b\u6b62\u8de8\u7ad9\u8173\u672c\u653b\u64ca (XSS)\u3002\u6b64\u898f\u5247\u6709\u52a9\u65bc\u963b\u6b62\u8207\u5df2\u77e5\u653b\u64ca\u7c3d\u540d\u5339\u914d\u7684\u6d41\u91cf\uff0c\u4f46\u5141\u8a31\u6240\u6709\u5176\u4ed6\u6d41\u91cf\u3002\u60a8\u7684\u74b0\u5883\u53ef\u80fd\u6839\u64da\u5de5\u4f5c\u8ca0\u8f09\u4f7f\u7528\u4e0d\u540c\u7684\u898f\u5247\u3002\n- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa\u4e00\u500b\u540d\u7232 `edge-fw-policy` \u7684\u5b89\u5168\u653f\u7b56\uff1a```\ngcloud compute security-policies create edge-fw-policy \\\u00a0 \u00a0 --description \"Block XSS attacks\"\n```\n- \u5275\u5efa\u4f7f\u7528\u9810\u914d\u7f6e XSS \u904e\u6ffe\u689d\u4ef6\u7684\u5b89\u5168\u653f\u7b56\u898f\u5247\uff1a```\ngcloud compute security-policies rules create 1000 \\\u00a0 \u00a0 --security-policy edge-fw-policy \\\u00a0 \u00a0 --expression \"evaluatePreconfiguredExpr('xss-stable')\" \\\u00a0 \u00a0 --action \"deny-403\" \\\u00a0 \u00a0 --description \"XSS attack filtering\"\n```\n\u4f7f\u7528\u4ee5\u4e0b [ComputeSecurityPolicy](https://cloud.google.com/config-connector/docs/reference/resource-docs/compute/computesecuritypolicy?hl=zh-cn) \u6e05\u55ae\uff1a\n```\napiVersion: compute.cnrm.cloud.google.com/v1beta1kind: ComputeSecurityPolicymetadata:\u00a0 annotations:\u00a0 \u00a0 cnrm.cloud.google.com/project-id: PROJECT_ID\u00a0 name: edge-fw-policyspec:\u00a0 rule:\u00a0 - action: allow\u00a0 \u00a0 description: \"Default rule\"\u00a0 \u00a0 match:\u00a0 \u00a0 \u00a0 versionedExpr: SRC_IPS_V1\u00a0 \u00a0 \u00a0 config:\u00a0 \u00a0 \u00a0 \u00a0 srcIpRanges:\u00a0 \u00a0 \u00a0 \u00a0 - \"*\"\u00a0 \u00a0 priority: 2147483647\u00a0 - action: deny-403\u00a0 \u00a0 description: \"XSS attack filtering\"\u00a0 \u00a0 match:\u00a0 \u00a0 \u00a0 expr:\u00a0 \u00a0 \u00a0 \u00a0 expression: \"evaluatePreconfiguredExpr('xss-stable')\"\u00a0 \u00a0 priority: 1000\n```\u4e0a\u4e00\u90e8\u5206\u4e2d\u7684 `ingress-backendconfig` \u5f15\u7528\u4e86 `edge-fw-policy` \u3002\u90e8\u7f72 Ingress \u8cc7\u6e90\u5f8c\uff0c\u5b83\u6703\u5c07\u6b64\u5b89\u5168\u653f\u7b56\u8207\u8ca0\u8f09\u5747\u8861\u5668\u7d81\u5b9a\uff0c\u4ee5\u5e6b\u52a9\u4fdd\u8b77 `asm-ingressgateway` Service \u7684\u4efb\u4f55\u5f8c\u7aef\u3002\n### \u914d\u7f6e IP \u5c0b\u5740\u548c DNS\n- \u5728 Cloud Shell \u4e2d\uff0c\u7232 Google Cloud \u8ca0\u8f09\u5747\u8861\u5668\u5275\u5efa\u5168\u7403\u975c\u614b IP\uff1a\n```\ngcloud compute addresses create ingress-ip --global\n```\n\u4f7f\u7528\u4ee5\u4e0b [ComputeAddress](https://cloud.google.com/config-connector/docs/reference/resource-docs/compute/computeaddress?hl=zh-cn) \u6e05\u55ae\uff1a\n```\napiVersion: compute.cnrm.cloud.google.com/v1beta1kind: ComputeAddressmetadata:\u00a0 annotations:\u00a0 \u00a0 cnrm.cloud.google.com/project-id: PROJECT_ID\u00a0 name: ingress-ipspec:\u00a0 location: global\n```\n\u6b64\u975c\u614b IP \u7531 Ingress \u8cc7\u6e90\u4f7f\u7528\uff0c\u5373\u4f7f\u5916\u90e8\u8ca0\u8f09\u5747\u8861\u5668\u767c\u751f\u66f4\u6539\uff0c\u8a72 IP \u4e5f\u53ef\u4ee5\u4fdd\u6301\u4e0d\u8b8a\u3002\n- \u7372\u53d6\u975c\u614b IP \u5730\u5740\uff1a```\nexport GCLB_IP=$(gcloud compute addresses describe ingress-ip --global --format \"value(address)\")echo ${GCLB_IP}\n```\u5982\u9700\u91dd\u5c0d\u60a8\u7684 Ingress IP \u5275\u5efa\u6613\u65bc\u4f7f\u7528\u7684\u7a69\u5b9a\u6620\u5c04\uff0c\u60a8\u5fc5\u9808\u5177\u6709\u516c\u5171 DNS \u8a18\u9304\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u6240\u9700\u7684\u4efb\u4f55 DNS \u63d0\u4f9b\u5546\u548c\u81ea\u52d5\u5316\u529f\u80fd\u3002\u672c\u6559\u7a0b\u4f7f\u7528 Endpoints \u800c\u4e0d\u662f\u5275\u5efa\u4ee3\u7ba1\u5f0f DNS \u5340\u57df\u3002Endpoints \u7232\u516c\u5171 IP \u63d0\u4f9b\u514d\u8cbb\u7684 [Google \u7ba1\u7406\u7684 DNS \u8a18\u9304](https://cloud.google.com/endpoints/docs/openapi/cloud-goog-dns-configure?hl=zh-cn) \u3002\n- \u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u5275\u5efa\u540d\u7232 `dns-spec.yaml` \u7684 YAML \u898f\u7bc4\u6587\u4ef6\uff1a```\ncat <<EOF > dns-spec.yamlswagger: \"2.0\"info:\u00a0 description: \"Cloud Endpoints DNS\"\u00a0 title: \"Cloud Endpoints DNS\"\u00a0 version: \"1.0.0\"paths: {}host: \"frontend.endpoints.${PROJECT}.cloud.goog\"x-google-endpoints:- name: \"frontend.endpoints.${PROJECT}.cloud.goog\"\u00a0 target: \"${GCLB_IP}\"EOF\n```YAML \u898f\u7bc4\u4ee5 `frontend.endpoints.${PROJECT}.cloud.goog` \u7684\u5f62\u5f0f\u5b9a\u7fa9\u516c\u5171 DNS \u8a18\u9304\uff0c\u5176\u4e2d `${PROJECT}` \u662f\u60a8\u7684\u552f\u4e00\u9805\u76ee\u7de8\u865f\u3002\n- \u5728 Google Cloud \u9805\u76ee\u4e2d\u90e8\u7f72 `dns-spec.yaml` \u6587\u4ef6\uff1a```\ngcloud endpoints services deploy dns-spec.yaml\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nOperation finished successfully. The following command can describe the Operation details:\n gcloud endpoints operations describe operations/rollouts.frontend.endpoints.edge2mesh.cloud.goog:442b2b38-4aee-4c60-b9fc-28731657ee08\nService Configuration [2021-11-14r0] uploaded for service [frontend.endpoints.edge2mesh.cloud.goog]\n```\u5728\u914d\u7f6e IP \u548c DNS \u5f8c\uff0c\u60a8\u53ef\u4ee5\u751f\u6210\u516c\u5171\u8b49\u66f8\u4f86\u4fdd\u8b77 Ingress \u524d\u7aef\u3002GKE Ingress [\u652f\u6301 Google \u7ba1\u7406\u7684\u8b49\u66f8](https://cloud.google.com/kubernetes-engine/docs/how-to/managed-certs?hl=zh-cn) \u4f5c\u7232 Kubernetes \u8cc7\u6e90\uff0c\u8b93\u60a8\u80fd\u5920\u901a\u904e\u8072\u660e\u65b9\u5f0f\u9810\u914d\u8b49\u66f8\u3002\n### \u9810\u914d TLS \u8b49\u66f8\n- \u5728 Cloud Shell \u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u5c07 `ManagedCertificate` \u6e05\u55ae\u5275\u5efa\u7232 `managed-cert.yaml` \uff1a```\ncat <<EOF > managed-cert.yamlapiVersion: networking.gke.io/v1kind: ManagedCertificatemetadata:\u00a0 name: gke-ingress-cert\u00a0 namespace: asm-ingressspec:\u00a0 domains:\u00a0 \u00a0 - \"frontend.endpoints.${PROJECT}.cloud.goog\"EOF\n```\u6b64 YAML \u6587\u4ef6\u6307\u5b9a\u4f7f\u7528\u901a\u904e Endpoints \u5275\u5efa\u7684 DNS \u540d\u7a31\u4f86\u9810\u914d\u516c\u5171\u8b49\u66f8\u3002\u7531\u65bc Google \u5168\u9762\u7ba1\u7406\u9019\u4e9b\u516c\u5171\u8b49\u66f8\u7684\u751f\u547d\u9031\u671f\uff0c\u56e0\u6b64\u9019\u4e9b\u8b49\u66f8\u6703\u5b9a\u671f\u81ea\u52d5\u751f\u6210\u4e26\u8f2a\u7528\uff0c\u7528\u6236\u7121\u9700\u76f4\u63a5\u5e72\u9810\u3002\n- \u5728\u60a8\u7684 GKE \u96c6\u7fa3\u4e2d\u90e8\u7f72 `managed-cert.yaml` \u6587\u4ef6\uff1a```\nkubectl apply -f managed-cert.yaml\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nmanagedcertificate.networking.gke.io/gke-ingress-cert created\n```\n- \u6aa2\u67e5 `ManagedCertificate` \u8cc7\u6e90\u4ee5\u67e5\u770b\u8b49\u66f8\u751f\u6210\u9032\u5ea6\uff1a```\nkubectl describe managedcertificate gke-ingress-cert -n asm-ingress\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nName:   gke-ingress-cert\nNamespace: asm-ingress\nLabels:  <none>\nAnnotations: kubectl.kubernetes.io/last-applied-configuration:\n    {\"apiVersion\":\"networking.gke.io/v1\",\"kind\":\"ManagedCertificate\",\"metadata\":{\"annotations\":{},\"name\":\"gke-ingress-cert\",\"namespace\":\"...\nAPI Version: networking.gke.io/v1\nKind:   ManagedCertificate\nMetadata:\n Creation Timestamp: 2020-08-05T20:44:49Z\n Generation:   2\n Resource Version: 1389781\n Self Link:   /apis/networking.gke.io/v1/namespaces/asm-ingress/managedcertificates/gke-ingress-cert\n UID:     d74ec346-ced9-47a8-988a-6e6e9ddc4019\nSpec:\n Domains:\n frontend.endpoints.edge2mesh.cloud.goog\nStatus:\n Certificate Name: mcrt-306c779e-8439-408a-9634-163664ca6ced\n Certificate Status: Provisioning\n Domain Status:\n Domain: frontend.endpoints.edge2mesh.cloud.goog\n Status: Provisioning\nEvents:\n Type Reason Age From       Message\n ---- ------ ---- ----       ------ Normal Create 44s managed-certificate-controller Create SslCertificate mcrt-306c779e-8439-408a-9634-163664ca6ced\n```\u8b49\u66f8\u6e96\u5099\u5c31\u7dd2\u5f8c\uff0c `Certificate Status` \u7232 `Active` \u3002 **\u6ce8\u610f** \uff1a\u9810\u914d\u8b49\u66f8\u7684\u904e\u7a0b\u6700\u591a\u53ef\u80fd\u9700\u8981 30 \u5206\u9418\uff0c\u4f46\u5176\u9918\u6b65\u9a5f\u53ef\u4ee5\u4e26\u884c\u9032\u884c\u3002\u9810\u914d\u8b49\u66f8\u5f8c\uff0c\u5b83\u6703\u81ea\u52d5\u95dc\u806f\u5230 Ingress \u8ca0\u8f09\u5747\u8861\u5668\u3002\n### \u90e8\u7f72 Ingress \u8cc7\u6e90\n- \u5728 Cloud Shell \u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u5c07 `Ingress` \u6e05\u55ae\u5275\u5efa\u7232 `ingress.yaml` \uff1a```\ncat <<EOF > ingress.yamlapiVersion: networking.k8s.io/v1kind: Ingressmetadata:\u00a0 name: gke-ingress\u00a0 namespace: asm-ingress\u00a0 annotations:\u00a0 \u00a0 kubernetes.io/ingress.allow-http: \"false\"\u00a0 \u00a0 kubernetes.io/ingress.global-static-ip-name: \"ingress-ip\"\u00a0 \u00a0 networking.gke.io/managed-certificates: \"gke-ingress-cert\"\u00a0 \u00a0 kubernetes.io/ingress.class: \"gce\"spec:\u00a0 defaultBackend:\u00a0 \u00a0 service:\u00a0 \u00a0 \u00a0 name: asm-ingressgateway\u00a0 \u00a0 \u00a0 port:\u00a0 \u00a0 \u00a0 \u00a0 number: 443\u00a0 rules:\u00a0 - http:\u00a0 \u00a0 \u00a0 paths:\u00a0 \u00a0 \u00a0 - path: /*\u00a0 \u00a0 \u00a0 \u00a0 pathType: ImplementationSpecific\u00a0 \u00a0 \u00a0 \u00a0 backend:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 service:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 name: asm-ingressgateway\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 port:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 number: 443EOF\n```\u6b64\u6e05\u55ae\u5b9a\u7fa9\u4e86\u4e00\u500b\u5c07\u6240\u6709\u5148\u524d\u8cc7\u6e90\u95dc\u806f\u5728\u4e00\u8d77\u7684 Ingress \u8cc7\u6e90\u3002\u6e05\u55ae\u6307\u5b9a\u4e86\u4ee5\u4e0b\u5b57\u6bb5\uff1a- `kubernetes.io/ingress.allow-http: \"false\"`\u6703\u505c\u7528 Google Cloud \u8ca0\u8f09\u5747\u8861\u5668\u7684\u7aef\u53e3`80`\u4e0a\u7684 HTTP \u6d41\u91cf\u3002\u7531\u65bc\u7aef\u53e3`443`\u50c5\u5075\u807d HTTPS\uff0c\u800c\u4e14\u7aef\u53e3`80`\u5df2\u505c\u7528\uff0c\u56e0\u6b64\u9019\u53ef\u4ee5\u6709\u6548\u5730\u9632\u6b62\u4efb\u4f55\u5ba2\u6236\u7aef\u4f7f\u7528\u672a\u52a0\u5bc6\u7684\u6d41\u91cf\u9032\u884c\u9023\u63a5\u3002\n- `kubernetes.io/ingress.global-static-ip-name: \"ingress-ip\"`\u6703\u5c07\u5148\u524d\u5275\u5efa\u7684 IP \u5730\u5740\u8207\u8ca0\u8f09\u5747\u8861\u5668\u76f8\u95dc\u806f\u3002\u901a\u904e\u6b64\u93c8\u63a5\uff0c\u60a8\u53ef\u4ee5\u5c07 IP \u5730\u5740\u8207\u8ca0\u8f09\u5747\u8861\u5668\u5206\u958b\u5275\u5efa\uff0c\u4ee5\u4fbf\u53ef\u4ee5\u5728\u8ca0\u8f09\u5747\u8861\u5668\u751f\u547d\u9031\u671f\u4e2d\u91cd\u8907\u4f7f\u7528\u8a72\u5730\u5740\u3002\n- `networking.gke.io/managed-certificates: \"gke-ingress-cert\"`\u6703\u5c07\u6b64\u8ca0\u8f09\u5747\u8861\u5668\u8207\u4ee5\u524d\u5275\u5efa\u7684 Google \u7ba1\u7406\u7684 SSL \u8b49\u66f8\u8cc7\u6e90\u76f8\u95dc\u806f\u3002\n- \u5728\u60a8\u7684\u96c6\u7fa3\u4e2d\u90e8\u7f72 `ingress.yaml` \uff1a```\nkubectl apply -f ingress.yaml\n```\n- \u6aa2\u67e5 Ingress \u8cc7\u6e90\uff0c\u4ee5\u6aa2\u67e5\u8ca0\u8f09\u5747\u8861\u5668\u90e8\u7f72\u7684\u9032\u5ea6\uff1a```\nkubectl describe ingress gke-ingress -n asm-ingress\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\n...\nAnnotations:\n ingress.kubernetes.io/https-forwarding-rule:  k8s2-fs-fq3ng2uk-asm-ingress-gke-ingress-qm3qqdor\n ingress.kubernetes.io/ssl-cert:     mcrt-306c779e-8439-408a-9634-163664ca6ced\n networking.gke.io/managed-certificates:   gke-ingress-cert\n kubernetes.io/ingress.global-static-ip-name: ingress-ip\n ingress.gcp.kubernetes.io/pre-shared-cert: mcrt-306c779e-8439-408a-9634-163664ca6ced\n ingress.kubernetes.io/backends:    {\"k8s-be-31610--07bdde06b914144a\":\"HEALTHY\",\"k8s1-07bdde06-asm-ingress-asm-ingressgateway-443-228c1881\":\"HEALTHY\"}\n ingress.kubernetes.io/forwarding-rule:  k8s2-fr-fq3ng2uk-asm-ingress-gke-ingress-qm3qqdor\n ingress.kubernetes.io/https-target-proxy:  k8s2-ts-fq3ng2uk-asm-ingress-gke-ingress-qm3qqdor\n ingress.kubernetes.io/target-proxy:   k8s2-tp-fq3ng2uk-asm-ingress-gke-ingress-qm3qqdor\n ingress.kubernetes.io/url-map:    k8s2-um-fq3ng2uk-asm-ingress-gke-ingress-qm3qqdor\n...\n```\u5982\u679c `ingress.kubernetes.io/backends` \u8a3b\u91cb\u6307\u660e\u5f8c\u7aef\u7232 `HEALTHY` \uff0c\u5247\u8868\u793a Ingress \u8cc7\u6e90\u5df2\u6e96\u5099\u5c31\u7dd2\u3002\u9019\u4e9b\u8a3b\u91cb\u9084\u6703\u986f\u793a\u5df2\u9810\u914d\u7684\u4e0d\u540c Google Cloud \u8cc7\u6e90\u7684\u540d\u7a31\uff0c\u5305\u62ec\u5f8c\u7aef\u670d\u52d9\u3001SSL \u8b49\u66f8\u548c HTTPS \u76ee\u6a19\u4ee3\u7406\u3002\n### \u5b89\u88dd\u81ea\u7c3d\u540d\u5165\u7ad9\u6d41\u91cf\u7db2\u95dc\u8b49\u66f8\u5728\u4ee5\u4e0b\u6b65\u9a5f\u4e2d\uff0c\u60a8\u5c07\u751f\u6210\u4e26\u5b89\u88dd\u4e00\u500b\u8b49\u66f8\uff08\u4f5c\u7232 Kubernetes `secret` \u8cc7\u6e90\uff09\uff0c\u4f7f GFE \u80fd\u5920\u5efa\u7acb\u8207\u670d\u52d9\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u7db2\u95dc\u7684 TLS \u9023\u63a5\u3002\u5982\u9700\u66f4\u8a73\u7d30\u5730\u77ad\u89e3\u5165\u7ad9\u6d41\u91cf\u7db2\u95dc\u8b49\u66f8\u7684\u8981\u6c42\uff0c\u8acb\u53c3\u95b1 [\u5b89\u5168\u5f8c\u7aef\u5354\u8b70\u6ce8\u610f\u4e8b\u9805\u6307\u5357](https://cloud.google.com/load-balancing/docs/ssl-certificates/encryption-to-the-backends?hl=zh-cn#secure_backend_protocol_considerations) \u3002- \u5728 Cloud Shell \u4e2d\uff0c\u4f7f\u7528 `openssl` \u5275\u5efa\u79c1\u9470\u548c\u8b49\u66f8\uff1a```\nopenssl req -new -newkey rsa:4096 -days 365 -nodes -x509 \\\u00a0-subj \"/CN=frontend.endpoints.${PROJECT}.cloud.goog/O=Edge2Mesh Inc\" \\\u00a0-keyout frontend.endpoints.${PROJECT}.cloud.goog.key \\\u00a0-out frontend.endpoints.${PROJECT}.cloud.goog.crt\n```\n- \u5728 `asm-ingress` \u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa `Secret` \uff1a```\nkubectl -n asm-ingress create secret tls edge2mesh-credential \\\u00a0--key=frontend.endpoints.${PROJECT}.cloud.goog.key \\\u00a0--cert=frontend.endpoints.${PROJECT}.cloud.goog.crt\n```\n### \u914d\u7f6e\u9069\u7528\u65bc\u5916\u90e8\u8ca0\u8f09\u5747\u8861\u7684\u5165\u7ad9\u6d41\u91cf\u7db2\u95dc\u5728\u4ee5\u4e0b\u6b65\u9a5f\u4e2d\uff0c\u60a8\u5c07\u5728 `asm-ingress` \u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa [\u5171\u4eab Gateway](https://istio.io/latest/docs/setup/additional-setup/gateway/#shared-gateway) \u8cc7\u6e90\u3002\u7db2\u95dc\u901a\u5e38\u7531\u5e73\u81fa\u7ba1\u7406\u54e1\u6216\u7db2\u7d61\u7ba1\u7406\u54e1\u5718\u968a\u8ca0\u8cac\u904b\u884c\u3002\u56e0\u6b64\uff0c `Gateway` \u8cc7\u6e90\u5728\u7531\u5e73\u81fa\u7ba1\u7406\u54e1\u8ca0\u8cac\u7ba1\u7406\u7684 `asm-ingress` \u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa\uff0c\u53ef\u901a\u904e\u4ed6\u5011\u81ea\u5df1\u7684 `VirtualService` \u689d\u76ee\u5728\u5176\u4ed6\u547d\u540d\u7a7a\u9593\u4e2d\u4f7f\u7528\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u5c07 `Gateway` \u6e05\u55ae\u5275\u5efa\u7232 `ingress-gateway.yaml` \uff1a```\ncat <<EOF > ingress-gateway.yamlapiVersion: networking.istio.io/v1alpha3kind: Gatewaymetadata:\u00a0 \u00a0 name: asm-ingressgateway\u00a0 \u00a0 namespace: asm-ingressspec:\u00a0 selector:\u00a0 \u00a0 asm: ingressgateway\u00a0 servers:\u00a0 - port:\u00a0 \u00a0 \u00a0 number: 443\u00a0 \u00a0 \u00a0 name: https\u00a0 \u00a0 \u00a0 protocol: HTTPS\u00a0 \u00a0 hosts:\u00a0 \u00a0 - \"*\" # IMPORTANT: Must use wildcard here when using SSL, see note below\u00a0 \u00a0 tls:\u00a0 \u00a0 \u00a0 mode: SIMPLE\u00a0 \u00a0 \u00a0 credentialName: edge2mesh-credentialEOF\n```\u8acb\u6ce8\u610f\uff0c\u60a8\u5fc5\u9808\u5728 `Gateway` \u7684 `hosts` \u5b57\u6bb5\u4e2d\u4f7f\u7528\u901a\u914d\u7b26 `*` \u689d\u76ee\u3002GCLB \u4e0d\u4f7f\u7528\u5f8c\u7aef\u7684 SNI \u64f4\u5c55\u7a0b\u5e8f\u3002\u4f7f\u7528\u901a\u914d\u7b26\u689d\u76ee\u6703\u5c07\u52a0\u5bc6\u7684\u6578\u64da\u5305\uff08\u5f9e GCLB\uff09\u767c\u9001\u5230 ASM \u5165\u7ad9\u6d41\u91cf\u7db2\u95dc\u3002ASM \u5165\u7ad9\u6d41\u91cf\u7db2\u95dc\u89e3\u5bc6\u6578\u64da\u5305\uff0c\u4e26\u4f7f\u7528 HTTP \u4e3b\u6a5f\u6a19\u982d\uff08\u5728\u89e3\u5bc6\u7684\u6578\u64da\u5305\u4e2d\uff09\u505a\u51fa\u8def\u7531\u6c7a\u7b56\uff08\u57fa\u65bc `VirtualService` \u689d\u76ee\uff09\u3002\n- \u5728\u60a8\u7684\u96c6\u7fa3\u4e2d\u90e8\u7f72 `ingress-gateway.yaml` \uff1a```\nkubectl apply -f ingress-gateway.yaml\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\ngateway.networking.istio.io/asm-ingressgateway created\n```\n## \u5b89\u88dd Online Boutique \u793a\u4f8b\u61c9\u7528\n- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa\u4e00\u500b\u5c08\u7528\u7684 `onlineboutique` \u547d\u540d\u7a7a\u9593\uff1a```\nkubectl create namespace onlineboutique\n```\n- \u5c07\u547d\u540d\u7a7a\u9593\u6a19\u7c64\u6dfb\u52a0\u5230 `onlineboutique` \u547d\u540d\u7a7a\u9593\uff1a```\nkubectl label namespace onlineboutique istio-injection=enabled\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nnamespace/onlineboutique labeled\n```\u4f7f\u7528 `istio-injection=enabled` \u7232 `onlineboutique` \u547d\u540d\u7a7a\u9593\u6dfb\u52a0\u6a19\u7c64\u6703\u6307\u793a Anthos Service Mesh \u5728\u90e8\u7f72\u61c9\u7528\u6642\u81ea\u52d5\u6ce8\u5165 Envoy \u908a\u8eca\u4ee3\u7406\u3002\n- \u4e0b\u8f09 Online Boutique \u793a\u4f8b\u61c9\u7528\u7684 Kubernetes YAML \u6587\u4ef6\uff1a```\ncurl -LO \\\u00a0 \u00a0 https://raw.githubusercontent.com/GoogleCloudPlatform/microservices-demo/main/release/kubernetes-manifests.yaml\n```\n- \u90e8\u7f72 Online Boutique \u61c9\u7528\uff1a```\nkubectl apply -f kubernetes-manifests.yaml -n onlineboutique\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\ndeployment.apps/frontend created\nservice/frontend created\nservice/frontend-external created\n...\n```\n- \u78ba\u4fdd\u6240\u6709\u90e8\u7f72\u90fd\u5df2\u5553\u52d5\u4e26\u904b\u884c\uff1a```\nkubectl get pods -n onlineboutique\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nNAME          READY STATUS RESTARTS AGE\nadservice-d854d8786-fjb7q    2/2  Running 0   3m\ncartservice-85b5d5b4ff-8qn7g    2/2  Running 0   2m59s\ncheckoutservice-5f9bf659b8-sxhsq   2/2  Running 0   3m1s\n...\n```\n- \u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5c07 `VirtualService` \u6e05\u55ae\u5275\u5efa\u7232 `frontend-virtualservice.yaml` \uff1a```\ncat <<EOF > frontend-virtualservice.yamlapiVersion: networking.istio.io/v1alpha3kind: VirtualServicemetadata:\u00a0 name: frontend-ingress\u00a0 namespace: onlineboutiquespec:\u00a0 hosts:\u00a0 - \"frontend.endpoints.${PROJECT}.cloud.goog\"\u00a0 gateways:\u00a0 - asm-ingress/asm-ingressgateway\u00a0 http:\u00a0 - route:\u00a0 \u00a0 - destination:\u00a0 \u00a0 \u00a0 \u00a0 host: frontend\u00a0 \u00a0 \u00a0 \u00a0 port:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 number: 80EOF\n```\u8acb\u6ce8\u610f\uff0c `VirtualService` \u662f\u5728\u61c9\u7528\u547d\u540d\u7a7a\u9593 ( `onlineboutique` ) \u4e2d\u5275\u5efa\u7684\u3002\u901a\u5e38\uff0c\u61c9\u7528\u6240\u6709\u8005\u6703\u6c7a\u5b9a\u4e26\u914d\u7f6e\u5c07\u6d41\u91cf\u8def\u7531\u5230 `frontend` \u61c9\u7528\u7684\u65b9\u5f0f\u548c\u5167\u5bb9\uff0c\u4ee5\u4fbf\u61c9\u7528\u6240\u6709\u8005\u90e8\u7f72 `VirtualService` \u3002\n- \u5728\u60a8\u7684\u96c6\u7fa3\u4e2d\u90e8\u7f72 `frontend-virtualservice.yaml` \uff1a```\nkubectl apply -f frontend-virtualservice.yaml\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nvirtualservice.networking.istio.io/frontend-virtualservice created\n```\n- \u8a2a\u554f\u4ee5\u4e0b\u93c8\u63a5\uff1a```\necho \"https://frontend.endpoints.${PROJECT}.cloud.goog\"\n```\u7cfb\u7d71\u6703\u986f\u793a\u60a8\u7684 Online Boutique \u524d\u7aef\u3002 **\u6ce8\u610f** \uff1a\u60a8\u53ef\u80fd\u6703\u9047\u5230 `ERR_SSL_VERSION_OR_CIPHER_MISMATCH` \u932f\u8aa4\u3002\u5982\u679c\u8b49\u66f8\u5c1a\u672a\u50b3\u64ad\u5230\u5168\u7403\u6240\u6709 Google Front End (GFE)\uff0c\u5c31\u6703\u767c\u751f\u6b64\u932f\u8aa4\u3002\u7b49\u5f85\u5e7e\u5206\u9418\uff0c\u7136\u5f8c\u518d\u6b21\u5617\u8a66\u93c8\u63a5\u3002\n- \u5982\u9700\u986f\u793a\u8b49\u66f8\u7684\u8a73\u60c5\uff0c\u8acb\u5728\u700f\u89bd\u5668\u7684\u5730\u5740\u6b04\u4e2d\u9ede\u64ca lock **\u67e5\u770b\u7ad9\u9ede\u4fe1\u606f** \uff0c\u7136\u5f8c\u9ede\u64ca **\u8b49\u66f8\uff08\u6709\u6548\uff09** \u3002\u8b49\u66f8\u67e5\u770b\u5668\u6703\u986f\u793a\u4ee3\u7ba1\u8b49\u66f8\u7684\u8a73\u60c5\uff0c\u5305\u62ec\u5230\u671f\u65e5\u671f\u548c\u9812\u767c\u8b49\u66f8\u7684\u4eba\u3002\n\u73fe\u5728\uff0c\u60a8\u6709\u4e00\u500b\u5168\u7403 HTTPS \u8ca0\u8f09\u5747\u8861\u5668\uff0c\u4f5c\u7232\u670d\u52d9\u7db2\u683c\u8a17\u7ba1\u61c9\u7528\u7684\u524d\u7aef\u3002## \u6e05\u7406\u5b8c\u6210\u672c\u6559\u7a0b\u5f8c\uff0c\u60a8\u53ef\u4ee5\u6e05\u7406\u60a8\u5728 Google Cloud \u4e0a\u5275\u5efa\u7684\u8cc7\u6e90\uff0c\u4ee5\u514d\u9019\u4e9b\u8cc7\u6e90\u5c07\u4f86\u7522\u751f\u8cbb\u7528\u3002\u60a8\u53ef\u4ee5\u5fb9\u5e95\u522a\u9664\u9805\u76ee\uff0c\u4e5f\u53ef\u4ee5\u522a\u9664\u96c6\u7fa3\u8cc7\u6e90\uff0c\u7136\u5f8c\u522a\u9664\u96c6\u7fa3\u3002\n### \u522a\u9664\u9805\u76ee- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- **\u8b66\u544a** \uff1a\u522a\u9664\u9805\u76ee\u6703\u7522\u751f\u4ee5\u4e0b\u5f71\u97ff- **\u9805\u76ee\u4e2d\u7684\u6240\u6709\u5167\u5bb9\u90fd\u6703\u88ab\u522a\u9664\u3002** \u5982\u679c\u60a8\u5c07\u73fe\u6709\u9805\u76ee\u7528\u65bc\u672c\u6587\u6a94\u4e2d\u7684\u4efb\u52d9\uff0c\u5247\u522a\u9664\u8a72\u9805\u76ee\u5f8c\uff0c\u9084\u5c07\u522a\u9664\u60a8\u5df2\u5728\u8a72\u9805\u76ee\u4e2d\u5b8c\u6210\u7684\u4efb\u4f55\u5176\u4ed6\u5de5\u4f5c\u3002\n- **\u81ea\u5b9a\u7fa9\u9805\u76ee ID \u4e1f\u5931\u3002** \u5275\u5efa\u6b64\u9805\u76ee\u6642\uff0c\u60a8\u53ef\u80fd\u5275\u5efa\u4e86\u8981\u5728\u5c07\u4f86\u4f7f\u7528\u7684\u81ea\u5b9a\u7fa9\u9805\u76ee ID\u3002\u8981\u4fdd\u7559\u4f7f\u7528\u8a72\u9805\u76ee ID \u7684\u7db2\u5740\uff08\u4f8b\u5982`appspot.com`\u7db2\u5740\uff09\uff0c\u8acb\u522a\u9664\u9805\u76ee\u5167\u7684\u6240\u9078\u8cc7\u6e90\uff0c\u800c\u4e0d\u662f\u522a\u9664\u6574\u500b\u9805\u76ee\u3002\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u9032\u5165 **\u7ba1\u7406\u8cc7\u6e90** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u7ba1\u7406\u8cc7\u6e90\u201d](https://console.cloud.google.com/iam-admin/projects?hl=zh-cn) \n- \u5728\u9805\u76ee\u5217\u8868\u4e2d\uff0c\u9078\u64c7\u8981\u522a\u9664\u7684\u9805\u76ee\uff0c\u7136\u5f8c\u9ede\u64ca **\u522a\u9664** \u3002\n- \u5728\u5c0d\u8a71\u6846\u4e2d\u8f38\u5165\u9805\u76ee ID\uff0c\u7136\u5f8c\u9ede\u64ca **\u95dc\u9589** \u4ee5\u522a\u9664\u9805\u76ee\u3002\n### \u9010\u500b\u522a\u9664\u8cc7\u6e90\u5982\u679c\u60a8\u5e0c\u671b\u4fdd\u7559\u5728\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528\u7684 Google Cloud \u9805\u76ee\uff0c\u8acb\u522a\u9664\u55ae\u500b\u8cc7\u6e90\uff1a- \u522a\u9664 Ingress \u8cc7\u6e90\uff1a```\nkubectl delete -f ingress.yaml\n```\n- \u522a\u9664\u4ee3\u7ba1\u5f0f\u8b49\u66f8\uff1a```\nkubectl delete -f managed-cert.yaml\n```\n- \u522a\u9664 Endpoints DNS \u689d\u76ee\uff1a```\ngcloud endpoints services delete \"frontend.endpoints.${PROJECT}.cloud.goog\"\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nAre you sure? This will set the service configuration to be deleted, along\nwith all of the associated consumer information. Note: This does not\nimmediately delete the service configuration or data and can be undone using\nthe undelete command for 30 days. Only after 30 days will the service be\npurged from the system.\n```\n- \u7576\u7cfb\u7d71\u63d0\u793a\u60a8\u7e7c\u7e8c\u6642\uff0c\u8acb\u8f38\u5165 \u3002\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nWaiting for async operation operations/services.frontend.endpoints.edge2mesh.cloud.goog-5 to complete...\nOperation finished successfully. The following command can describe the Operation details:\n gcloud endpoints operations describe operations/services.frontend.endpoints.edge2mesh.cloud.goog-5\n```\n- \u522a\u9664\u975c\u614b IP \u5730\u5740\uff1a```\ngcloud compute addresses delete ingress-ip --global\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nThe following global addresses will be deleted:\n - [ingress-ip]\n```\n- \u7576\u7cfb\u7d71\u63d0\u793a\u60a8\u7e7c\u7e8c\u6642\uff0c\u8acb\u8f38\u5165 \u3002\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nDeleted\n[https://www.googleapis.com/compute/v1/projects/edge2mesh/global/addresses/ingress-ip].\n```\n- \u522a\u9664 GKE \u96c6\u7fa3\uff1a```\ngcloud container clusters delete $CLUSTER_NAME --zone $CLUSTER_LOCATION\n```\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u77ad\u89e3 [GKE Ingress \u63d0\u4f9b\u7684\u53ef\u8207\u670d\u52d9\u7db2\u683c\u914d\u5408\u4f7f\u7528\u7684\u66f4\u591a\u529f\u80fd](https://cloud.google.com/kubernetes-engine/docs/how-to/ingress-features?hl=zh-cn) \u3002\n- \u77ad\u89e3 [\u9069\u7528\u65bc GKE \u7684\u4e0d\u540c\u985e\u578b\u7684 Cloud Load Balancing](https://cloud.google.com/blog/products/containers-kubernetes/exposing-services-on-gke?hl=zh-cn) \u3002\n- \u77ad\u89e3 [Anthos Service Mesh \u63d0\u4f9b\u7684\u529f\u80fd](https://cloud.google.com/service-mesh/docs/overview?hl=zh-cn) \u3002\n- \u77ad\u89e3\u5982\u4f55 [\u8de8\u591a\u500b GKE \u96c6\u7fa3\u90e8\u7f72 Ingress \u4ee5\u5be6\u73fe\u591a\u5730\u5340\u8ca0\u8f09\u5747\u8861](https://cloud.google.com/kubernetes-engine/docs/concepts/ingress-for-anthos?hl=zh-cn) \u3002\n- \u63a2\u7d22\u6709\u95dc Google Cloud \u7684\u53c3\u8003\u67b6\u69cb\u3001\u5716\u8868\u548c\u6700\u4f73\u505a\u6cd5\u3002\u67e5\u770b\u6211\u5011\u7684 [Cloud Architecture Center](https://cloud.google.com/architecture?hl=zh-cn) \u3002", "guide": "Docs"}