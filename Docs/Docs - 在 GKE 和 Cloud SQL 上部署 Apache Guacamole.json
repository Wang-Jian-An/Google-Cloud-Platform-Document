{"title": "Docs - \u5728 GKE \u548c Cloud SQL \u4e0a\u90e8\u7f72 Apache Guacamole", "url": "https://cloud.google.com/architecture/deploy-guacamole-gke/deployment?hl=zh-cn", "abstract": "# Docs - \u5728 GKE \u548c Cloud SQL \u4e0a\u90e8\u7f72 Apache Guacamole\nLast reviewed 2023-11-15 UTC\n\u672c\u6587\u6a94\u4ecb\u7d39\u77ad\u5982\u4f55 [\u5728 GKE \u548c Cloud SQL \u4e0a\u90e8\u7f72 Apache Guacamole](https://cloud.google.com/architecture/deploy-guacamole-gke?hl=zh-cn) \u3002\n\u4ee5\u4e0b\u8aaa\u660e\u9069\u7528\u65bc\u5e0c\u671b\u5728 GKE \u548c Cloud SQL \u4e0a\u8a17\u7ba1 Guacamole \u7684\u670d\u52d9\u5668\u7ba1\u7406\u54e1\u548c\u5de5\u7a0b\u5e2b\u3002\u672c\u6587\u6a94\u5047\u5b9a\u60a8\u719f\u6089\u5982\u4f55\u5c07\u5de5\u4f5c\u8ca0\u8f09\u90e8\u7f72\u5230 Kubernetes \u548c Cloud SQL for MySQL\u3002\u6211\u5011\u5efa\u8b70\u60a8\u540c\u6642\u719f\u6089 Identity and Access Management \u548c Google Compute Engine\u3002\n", "content": "## \u67b6\u69cb\n\u4e0b\u5716\u5c55\u793a\u77ad\u5982\u4f55\u4f7f\u7528 IAP \u914d\u7f6e Google Cloud \u8ca0\u8f09\u5747\u8861\u5668\uff0c\u4ee5\u4fdd\u8b77\u5728 GKE \u4e2d\u904b\u884c\u7684 Guacamole \u5ba2\u6236\u7aef\u5be6\u4f8b\uff1a\nGuacamole \u5ba2\u6236\u7aef\u9023\u63a5\u5230 guacd \u5f8c\u7aef\u670d\u52d9\uff0c\u8a72\u670d\u52d9\u4f5c\u7232\u8207\u4e00\u500b\u6216\u591a\u500b Compute Engine \u865b\u64ec\u6a5f\u7684\u9060\u7a0b\u684c\u9762\u9023\u63a5\u7684\u4ee3\u7406\u3002\u9019\u4e9b\u8173\u672c\u9084\u6703\u90e8\u7f72 Cloud SQL \u5be6\u4f8b\u4f86\u7ba1\u7406 Guacamole \u7684\u914d\u7f6e\u6578\u64da\u3002\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [GKE \u548c Cloud SQL \u4e0a\u7684 Apache Guacamole](https://cloud.google.com/architecture/deploy-guacamole-gke?hl=zh-cn) \u3002\n## \u76ee\u6a19\n- \u4f7f\u7528 Terraform \u90e8\u7f72\u57fa\u790e\u67b6\u69cb\u3002\n- \u5728 Cloud SQL \u4e2d\u5275\u5efa Guacamole \u6578\u64da\u5eab\u3002\n- \u4f7f\u7528 Skaffold \u5c07 Guacamole \u90e8\u7f72\u5230 GKE \u96c6\u7fa3\u3002\n- \u901a\u904e Guacamole \u6e2c\u8a66\u8207\u865b\u64ec\u6a5f\u7684\u9023\u63a5\u3002## \u8cbb\u7528\u5728\u672c\u6587\u6a94\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Google Cloud \u7684\u4ee5\u4e0b\u6536\u8cbb\u7d44\u4ef6\uff1a\n- [Compute Engine](https://cloud.google.com/compute/all-pricing?hl=zh-cn) \n- [GKE](https://cloud.google.com/kubernetes-engine/pricing?hl=zh-cn) \n- [Cloud SQL](https://cloud.google.com/sql/pricing?hl=zh-cn) \n- [Artifact Registry](https://cloud.google.com/artifact-registry/pricing?hl=zh-cn) \n\u60a8\u53ef\u4f7f\u7528 [\u50f9\u683c\u8a08\u7b97\u5668](https://cloud.google.com/products/calculator?hl=zh-cn) \u6839\u64da\u60a8\u7684\u9810\u8a08\u4f7f\u7528\u60c5\u6cc1\u4f86\u4f30\u7b97\u8cbb\u7528\u3002\u5b8c\u6210\u672c\u6587\u6a94\u4e2d\u63cf\u8ff0\u7684\u4efb\u52d9\u5f8c\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u522a\u9664\u6240\u5275\u5efa\u7684\u8cc7\u6e90\u4f86\u907f\u514d\u7e7c\u7e8c\u8a08\u8cbb\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u6e05\u7406](#clean-up) \u3002\n## \u6e96\u5099\u5de5\u4f5c\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728 Google Cloud Console \u4e2d\u7684\u9805\u76ee\u9078\u64c7\u5668\u9801\u9762\u4e0a\uff0c\u9078\u64c7\u6216 [\u5275\u5efa\u4e00\u500b Google Cloud \u9805\u76ee](https://cloud.google.com/resource-manager/docs/creating-managing-projects?hl=zh-cn) \u3002 **\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u4e0d\u6253\u7b97\u4fdd\u7559\u5728\u6b64\u904e\u7a0b\u4e2d\u5275\u5efa\u7684\u8cc7\u6e90\uff0c\u8acb\u5275\u5efa\u65b0\u7684\u9805\u76ee\uff0c\u800c\u4e0d\u8981\u9078\u64c7\u73fe\u6709\u7684\u9805\u76ee\u3002\u5b8c\u6210\u672c\u6559\u7a0b\u4ecb\u7d39\u7684\u6b65\u9a5f\u5f8c\uff0c\u60a8\u53ef\u4ee5\u522a\u9664\u6240\u5275\u5efa\u7684\u9805\u76ee\uff0c\u4e26\u79fb\u9664\u8207\u8a72\u9805\u76ee\u95dc\u806f\u7684\u6240\u6709\u8cc7\u6e90\u3002 [\u8f49\u5230\u201c\u9805\u76ee\u9078\u64c7\u5668\u201d](https://console.cloud.google.com/projectselector2/home/dashboard?hl=zh-cn) \n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them [\u78ba\u4fdd\u60a8\u7684 Google Cloud \u9805\u76ee\u5df2\u5553\u7528\u7d50\u7b97\u529f\u80fd](https://cloud.google.com/billing/docs/how-to/verify-billing-enabled?hl=zh-cn#console) \u3002\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5553\u7528 Resource Manager, Service Usage, Artifact Registry, and Compute Engine API\u3002 [\u5553\u7528 API](https://console.cloud.google.com/flows/enableapi?apiid=cloudresourcemanager.googleapis.com%2Cserviceusage.googleapis.com%2Ccompute.googleapis.com%2Cartifactregistry.googleapis.com&hl=zh-cn) \n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u6fc0\u6d3b Cloud Shell\u3002 [\u6fc0\u6d3b Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn) ## \u90e8\u7f72\u57fa\u790e\u67b6\u69cb\n\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Terraform \u90e8\u7f72\u4ee5\u4e0b\u8cc7\u6e90\uff1a\n- \u865b\u64ec\u79c1\u6709\u4e91\n- \u9632\u706b\u7246\u898f\u5247\n- GKE \u96c6\u7fa3\n- Artifact Registry \u88fd\u54c1\u5eab\n- Cloud SQL for MySQL\n- \u7528\u65bc\u7ba1\u7406 MySQL \u6578\u64da\u5eab\u7684\u865b\u64ec\u6a5f\n- \u670d\u52d9\u8cec\u865f\nTerraform \u914d\u7f6e\u9084\u652f\u6301\u5728\u60a8\u7684\u9805\u76ee\u4e2d\u4f7f\u7528 IAP\u3002\n- \u5728 Cloud Shell \u4e2d\uff0c\u514b\u9686 GitHub \u4ee3\u78bc\u5eab\uff1a```\ngit clone https://github.com/GoogleCloudPlatform/guacamole-on-gcp.git\n```\n- \u4f7f\u7528 Terraform \u90e8\u7f72\u6240\u9700\u7684\u57fa\u790e\u67b6\u69cb\uff1a```\ncd guacamole-on-gcp/tf-infraunset GOOGLE_CLOUD_QUOTA_PROJECTterraform init -upgradeterraform apply\n```\n- \u6309\u7167\u8aaa\u660e\u8f38\u5165\u60a8\u7684 Google Cloud \u9805\u76ee ID\u3002\n- \u5982\u9700\u6279\u51c6 Terraform \u5c07\u8cc7\u6e90\u90e8\u7f72\u5230\u60a8\u7684\u9805\u76ee\u7684\u8acb\u6c42\uff0c\u8acb\u8f38\u5165 `yes` \u3002\u90e8\u7f72\u6240\u6709\u8cc7\u6e90\u9700\u8981\u5e7e\u5206\u9418\u6642\u9593\u624d\u80fd\u5b8c\u6210\u3002## \u90e8\u7f72 Guacamole \u6578\u64da\u5eab\n\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u5728 Cloud SQL for MySQL \u4e2d\u5275\u5efa Guacamole \u6578\u64da\u5eab\u548c\u8868\uff0c\u4e26\u4f7f\u7528\u7ba1\u7406\u54e1\u7528\u6236\u4fe1\u606f\u586b\u5145\u6578\u64da\u5eab\u3002\n- \u5728 Cloud Shell \u4e2d\uff0c\u8a2d\u7f6e\u74b0\u5883\u8b8a\u91cf\u4e26\u627e\u5230\u6578\u64da\u5eab root \u5bc6\u78bc\uff1a```\ncd ..source bin/read-tf-output.sh\n```\u8a18\u4e0b\u6578\u64da\u5eab root \u5bc6\u78bc\uff1b\u60a8\u9700\u8981\u5728\u5f8c\u7e8c\u6b65\u9a5f\u4e2d\u7528\u5230\u5b83\u3002\u8173\u672c\u6703\u5f9e Terraform \u904b\u884c\u4e2d\u8b80\u53d6\u8f38\u51fa\u8b8a\u91cf\u4e26\u8a2d\u7f6e\u4ee5\u4e0b\u74b0\u5883\u8b8a\u91cf\uff0c\u9019\u4e9b\u74b0\u5883\u8b8a\u91cf\u7528\u65bc\u6574\u500b\u904e\u7a0b\uff1a```\nCLOUD_SQL_INSTANCEZONEREGIONDB_MGMT_VMPROJECT_IDGKE_CLUSTERGUACAMOLE_URLSUBNET\n```\n- \u5c07 `create-schema.sql` \u548c `insert-admin-user.sql` \u8173\u672c\u6587\u4ef6\u8907\u88fd\u5230\u6578\u64da\u5eab\u7ba1\u7406\u865b\u64ec\u6a5f\uff0c\u7136\u5f8c\u9023\u63a5\u5230\u865b\u64ec\u6a5f\uff1a```\ngcloud compute scp \\\u00a0 \u00a0 --tunnel-through-iap \\\u00a0 \u00a0 --zone=$ZONE \\\u00a0 \u00a0 create-schema.sql \\\u00a0 \u00a0 insert-admin-user.sql \\\u00a0 \u00a0 $DB_MGMT_VM:gcloud compute ssh $DB_MGMT_VM \\\u00a0 \u00a0 --zone=$ZONE \\\u00a0 \u00a0 --tunnel-through-iap\n```\u73fe\u5728\uff0c\u5df2\u901a\u904e Cloud Shell \u5efa\u7acb\u8207\u6578\u64da\u5eab\u7ba1\u7406\u865b\u64ec\u6a5f\u7684\u63a7\u5236\u6aaf\u6703\u8a71\u3002\n- \u5b89\u88dd MySQL \u5ba2\u6236\u7aef\u5de5\u5177\uff1a```\nsudo apt-get updatesudo apt-get install -y mariadb-client\n```\n- \u9023\u63a5\u5230 Cloud SQL \u4e26\u5275\u5efa\u6578\u64da\u5eab\u3002\u7576\u7cfb\u7d71\u63d0\u793a\u60a8\u8f38\u5165\u5bc6\u78bc\u6642\uff0c\u8acb\u4f7f\u7528\u60a8\u5728\u672c\u90e8\u5206\u524d\u9762\u8a18\u4e0b\u7684 root \u5bc6\u78bc\u3002```\nexport CLOUD_SQL_PRIVATE_IP=$(curl http://metadata.google.internal/computeMetadata/v1/instance/attributes/cloud_sql_ip -H \"Metadata-Flavor: Google\")mysql -h $CLOUD_SQL_PRIVATE_IP -u root -p\n```\n- \u7232\u6578\u64da\u5eab\u7528\u6236\u6388\u4e88\u5c0d\u65b0\u5275\u5efa\u7684\u6578\u64da\u5eab\u7684\u6b0a\u9650\uff1a```\nCREATE DATABASE guacamole;USE guacamole;GRANT SELECT,INSERT,UPDATE,DELETE ON guacamole.* TO 'guac-db-user';FLUSH PRIVILEGES;SOURCE create-schema.sql;SOURCE insert-admin-user.sql;quit\n```\n- MySQL \u547d\u4ee4\u904b\u884c\u5b8c\u7562\u5f8c\uff0c\u9000\u51fa\u865b\u64ec\u6a5f SSH \u6703\u8a71\uff1a```\nexit\n```## \u4f7f\u7528 Skaffold \u5c07 Guacamole \u90e8\u7f72\u5230 GKE\n\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 [Skaffold](https://skaffold.dev/) \u5c07 Guacamole \u61c9\u7528\u90e8\u7f72\u5230 GKE \u96c6\u7fa3\u3002Skaffold \u53ef\u8655\u7406\u69cb\u5efa\u3001\u63a8\u9001 Guacamole \u6620\u50cf\u4e26\u5c07\u5176\u90e8\u7f72\u5230 GKE \u96c6\u7fa3\u7684\u5de5\u4f5c\u6d41\u3002\n- \u5728 Cloud Shell \u4e2d\uff0c\u4f7f\u7528 terraform \u90e8\u7f72 GKE \u914d\u7f6e\uff1a```\ncd tf-k8sterraform init -upgradeterraform apply -parallelism=1\n```\n- \u7372\u53d6 GKE \u96c6\u7fa3\u7684\u6191\u64da\uff1a```\ngcloud container clusters get-credentials \\\u00a0 \u00a0 --region $REGION $GKE_CLUSTER\n```\n- \u5f9e\u514b\u9686\u7684 git \u4ee3\u78bc\u5eab\u7684\u6839\u76ee\u9304\u904b\u884c Skaffold\uff1a```\ncd ..skaffold --default-repo $REGION-docker.pkg.dev/$PROJECT_ID/guac-repo run\n```Skaffold \u5de5\u5177\u6703\u901a\u904e [Google Cloud Build](https://skaffold.dev/docs/builders/build-environments/cloud-build/) \u7232 Guacamole \u69cb\u5efa\u5bb9\u5668\u6620\u50cf\uff08\u547d\u4ee4\u884c\u5305\u542b\u4e00\u500b\u6a19\u8a8c\uff0c\u7528\u65bc\u6307\u5b9a\u8981\u5c07\u6620\u50cf\u63a8\u9001\u5230\u54ea\u500b\u4ee3\u78bc\u5eab\uff09\u3002\u8a72\u5de5\u5177\u9084\u6703\u904b\u884c [kustomize](https://kustomize.io/) \u6b65\u9a5f\uff0c\u4ee5\u6839\u64da Terraform \u904b\u884c\u7684\u8f38\u51fa\u751f\u6210 Kubernetes ConfigMap \u548c Secret\u3002\n- \u9a57\u8b49\u662f\u5426\u5df2\u9810\u914d\u8b49\u66f8\uff1a```\nkubectl get -w managedcertificates/guacamole-client-cert \\-n guacamole \\-o jsonpath=\"{.spec.domains[0]} is {.status.domainStatus[0].status}\"\n```\u9810\u914d\u8b49\u66f8\u6700\u591a\u53ef\u80fd\u9700\u8981 60 \u5206\u9418\u624d\u80fd\u5b8c\u6210\u3002\n- \u9810\u914d\u8b49\u66f8\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5728\u700f\u89bd\u5668\u4e2d\u8a2a\u554f\u7db2\u5740\u3002- \u67e5\u770b\u4f86\u81ea terraform \u8f38\u51fa\u7684\u7db2\u5740\uff1a```\necho $GUACAMOLE_URL\n```\n- \u5728\u700f\u89bd\u5668\u7a97\u53e3\u4e2d\uff0c\u8f38\u5165\u60a8\u5728\u4e0a\u4e00\u6b65\u4e2d\u7372\u5f97\u7684\u7db2\u5740\u3002\n- \u7576 IAP \u63d0\u793a\u60a8\u6642\uff0c\u4f7f\u7528\u60a8\u7684 Google \u6191\u64da\u767b\u9304\u3002\u767b\u9304\u5f8c\uff0c\u6839\u64da\u60a8\u5148\u524d\u5728\u6b64\u904e\u7a0b\u4e2d\u904b\u884c\u7684 `insert-admin-user.sql` \u8173\u672c\uff0c\u4ee5\u7ba1\u7406\u54e1\u6b0a\u9650\u767b\u9304 Guacamole\u3002 **\u6ce8\u610f** \uff1a\u6b64\u904e\u7a0b\u5275\u5efa\u7684 OAuth \u914d\u7f6e\u8a2d\u7f6e\u7232 [\u5167\u90e8](https://support.google.com/cloud/answer/6158849?hl=zh-cn) \u3002\u4e5f\u5c31\u662f\u8aaa\uff0c\u60a8\u5fc5\u9808\u4f7f\u7528\u5728\u6b64\u904e\u7a0b\u4e2d\u90e8\u7f72 Guacamole \u6240\u4f7f\u7528\u7684\u7d44\u7e54\u4e2d\u7684 Google \u8cec\u865f\uff1b\u5426\u5247\uff0c\u60a8\u6703\u6536\u5230 `HTTP/403 org_internal` \u932f\u8aa4\u3002\u5982\u679c\u60a8\u7684\u700f\u89bd\u5668\u6703\u8a71\u5df2\u767b\u9304\u5176\u4ed6 Google \u8cec\u865f\uff0c\u8acb\u5617\u8a66\u5728\u7121\u75d5\u6a21\u5f0f\u6a19\u7c64\u9801\u4e2d\u9023\u63a5\u5230\u8a72\u7db2\u5740\u3002\u73fe\u5728\uff0c\u60a8\u53ef\u4ee5\u901a\u904e Guacamole \u754c\u9762\u6839\u64da\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\u6dfb\u52a0\u5176\u4ed6\u7528\u6236\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [Guacamole \u6587\u6a94\u4e2d\u7684\u7ba1\u7406](https://guacamole.apache.org/doc/gug/administration.html) \u3002\u9019\u4e9b\u5176\u4ed6\u7528\u6236\u9084\u9700\u8981\u901a\u904e Google IAM\uff08\u5177\u6709 `IAP-secured Web App User` \u89d2\u8272\uff09\u7372\u5f97\u6b0a\u9650\u3002\n## \u6e2c\u8a66\u8207\u865b\u64ec\u6a5f\u7684\u9023\u63a5\n\u5728\u90e8\u7f72\u3001\u914d\u7f6e\u548c\u6210\u529f\u767b\u9304 Guacamole \u5f8c\uff0c\u60a8\u53ef\u4ee5\u5275\u5efa Windows \u865b\u64ec\u6a5f\u4e26\u901a\u904e Guacamole \u9023\u63a5\u5230\u65b0\u5275\u5efa\u7684\u865b\u64ec\u6a5f\u3002\n### \u5275\u5efa\u865b\u64ec\u6a5f\n- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa Windows \u865b\u64ec\u6a5f\u4ee5\u6e2c\u8a66\u8207\u4ee5\u4e0b\u865b\u64ec\u6a5f\u7684\u9023\u63a5\uff1a```\nexport TEST_VM=windows-vmgcloud compute instances create $TEST_VM \\\u00a0 \u00a0 --project=$PROJECT_ID \\\u00a0 \u00a0 --zone=$ZONE \\\u00a0 \u00a0 --machine-type=n1-standard-1 \\\u00a0 \u00a0 --subnet=$SUBNET \\\u00a0 \u00a0 --no-address \\\u00a0 \u00a0 --image-family=windows-2019 \\\u00a0 \u00a0 --image-project=windows-cloud \\\u00a0 \u00a0 --boot-disk-size=50GB \\\u00a0 \u00a0 --boot-disk-type=pd-standard \\\u00a0 \u00a0 \u2014-shielded-secure-boot\n```\u904b\u884c\u8a72\u547d\u4ee4\u5f8c\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u7b49\u5f85\u5e7e\u5206\u9418\uff0c\u4ee5\u4fbf Windows \u5b8c\u6210\u521d\u59cb\u5316\uff0c\u7136\u5f8c\u518d\u7e7c\u7e8c\u57f7\u884c\u4e0b\u4e00\u6b65\u3002\n- \u91cd\u7f6e\u60a8\u525b\u525b\u5275\u5efa\u7684\u865b\u64ec\u6a5f\u7684 Windows \u5bc6\u78bc\uff1a```\ngcloud compute reset-windows-password $TEST_VM \\\u00a0 \u00a0 --user=admin \\\u00a0 \u00a0 --zone=$ZONE\n```\n### \u6dfb\u52a0\u8207\u865b\u64ec\u6a5f\u7684\u65b0\u9023\u63a5\n- \u5728\u700f\u89bd\u5668\u7a97\u53e3\u4e2d\uff0c\u8f38\u5165\u5f9e [\u4f7f\u7528 Skaffold \u5c07 Guacamole \u90e8\u7f72\u5230 GKE](#deploy-guacamole-to-gke-by-using-skaffold) \u7372\u5f97\u7684 Guacamole \u5be6\u4f8b\u7db2\u5740\uff0c\u7136\u5f8c\u901a\u904e IAP \u767b\u9304\u3002\n- \u5728 Guacamole \u754c\u9762\u4e2d\uff0c\u9ede\u64ca\u60a8\u7684\u7528\u6236\u540d\uff0c\u7136\u5f8c\u9ede\u64ca **\u8a2d\u7f6e** \u3002\n- \u5728 **\u9023\u63a5** \u6a19\u7c64\u9801\u4e0b\uff0c\u9ede\u64ca **\u65b0\u5efa\u9023\u63a5** \u3002- \u5728 **\u540d\u7a31** \u5b57\u6bb5\u4e2d\uff0c\u8f38\u5165\u9023\u63a5\u7684\u540d\u7a31\u3002\n- \u5728 **\u4f4d\u7f6e** \u5b57\u6bb5\u4e2d\uff0c\u8f38\u5165\u9023\u63a5\u7684\u4f4d\u7f6e\u3002\n- \u5f9e **\u5354\u8b70** \u4e0b\u62c9\u5217\u8868\u4e2d\uff0c\u9078\u64c7 **RDP** \u3002\n- \u5728 **\u7db2\u7d61** \u4e0b\u7684 **\u4e3b\u6a5f\u540d** \u5b57\u6bb5\u4e2d\uff0c\u8f38\u5165\u60a8\u5275\u5efa\u7684\u865b\u64ec\u6a5f\u7684\u540d\u7a31 `windows-vm` \u3002\u60a8\u7684\u9805\u76ee DNS \u6703\u5c07\u6b64\u4e3b\u6a5f\u540d\u89e3\u6790\u7232\u5be6\u4f8b\u7684\u5167\u90e8 IP \u5730\u5740\u3002 **\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u5728\u8207 Guacamole GKE \u96c6\u7fa3\u4e0d\u540c\u7684\u53ef\u7528\u5340\u4e2d\u5275\u5efa\u865b\u64ec\u6a5f\uff0c\u5247\u9700\u8981\u5b8c\u5168\u9650\u5b9a\u865b\u64ec\u6a5f\u540d\u7a31\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5167\u90e8 DNS](https://cloud.google.com/compute/docs/internal-dns?hl=zh-cn) \u3002\n- \u5728 **\u8eab\u4efd\u9a57\u8b49** \u90e8\u5206\u4e2d\uff0c\u8a2d\u7f6e\u4ee5\u4e0b\u5b57\u6bb5\uff1a- **\u7528\u6236\u540d** \uff1a`admin`\n- **\u5bc6\u78bc** \uff1a\u91cd\u7f6e\u865b\u64ec\u6a5f\u7684\u5bc6\u78bc\u6642\u7372\u5f97\u7684\u5bc6\u78bc\n- **\u5b89\u5168\u6a21\u5f0f** \uff1a`NLA`\uff08\u7db2\u7d61\u7d1a\u8eab\u4efd\u9a57\u8b49\uff09\n- **\u5ffd\u7565\u670d\u52d9\u5668\u8b49\u66f8** \uff1a\u9078\u4e2d\u8a72\u8907\u9078\u6846Compute Engine Windows \u865b\u64ec\u6a5f\u9810\u914d\u4e86\u9060\u7a0b\u684c\u9762\u670d\u52d9\u7684\u81ea\u7c3d\u540d\u8b49\u66f8\uff0c\u56e0\u6b64\u60a8\u9700\u8981\u6307\u793a Guacamole \u5ffd\u7565\u8b49\u66f8\u9a57\u8b49\u554f\u984c\u3002\n- \u9ede\u64ca **\u4fdd\u5b58** \u3002\n- \u9ede\u64ca\u60a8\u7684\u7528\u6236\u540d\uff0c\u7136\u5f8c\u9078\u64c7 **\u4e3b\u9801** \u3002\n- \u9ede\u64ca\u60a8\u525b\u525b\u5275\u5efa\u7684\u9023\u63a5\u4ee5\u6e2c\u8a66\u9023\u63a5\u6027\u3002\u5e7e\u79d2\u9418\u5f8c\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230\u865b\u64ec\u6a5f\u5be6\u4f8b\u7684\u684c\u9762\u3002\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u914d\u7f6e Guacamole\uff0c\u8acb\u53c3\u95b1 [Apache Guacamole \u624b\u518a](https://guacamole.apache.org/doc/gug/) \u3002\n## \u6e05\u7406\n\u7232\u907f\u514d\u56e0\u6b64\u904e\u7a0b\u4e2d\u4f7f\u7528\u7684\u8cc7\u6e90\u5c0e\u81f4\u60a8\u7684 Google Cloud \u8cec\u865f\u7522\u751f\u8cbb\u7528\uff0c\u8acb\u522a\u9664\u5305\u542b\u9019\u4e9b\u8cc7\u6e90\u7684\u9805\u76ee\uff0c\u6216\u8005\u4fdd\u7559\u9805\u76ee\u4f46\u522a\u9664\u5404\u500b\u8cc7\u6e90\u3002\n### \u522a\u9664\u9805\u76ee- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- **\u8b66\u544a** \uff1a\u522a\u9664\u9805\u76ee\u6703\u7522\u751f\u4ee5\u4e0b\u5f71\u97ff- **\u9805\u76ee\u4e2d\u7684\u6240\u6709\u5167\u5bb9\u90fd\u6703\u88ab\u522a\u9664\u3002** \u5982\u679c\u60a8\u5c07\u73fe\u6709\u9805\u76ee\u7528\u65bc\u672c\u6587\u6a94\u4e2d\u7684\u4efb\u52d9\uff0c\u5247\u522a\u9664\u8a72\u9805\u76ee\u5f8c\uff0c\u9084\u5c07\u522a\u9664\u60a8\u5df2\u5728\u8a72\u9805\u76ee\u4e2d\u5b8c\u6210\u7684\u4efb\u4f55\u5176\u4ed6\u5de5\u4f5c\u3002\n- **\u81ea\u5b9a\u7fa9\u9805\u76ee ID \u4e1f\u5931\u3002** \u5275\u5efa\u6b64\u9805\u76ee\u6642\uff0c\u60a8\u53ef\u80fd\u5275\u5efa\u4e86\u8981\u5728\u5c07\u4f86\u4f7f\u7528\u7684\u81ea\u5b9a\u7fa9\u9805\u76ee ID\u3002\u8981\u4fdd\u7559\u4f7f\u7528\u8a72\u9805\u76ee ID \u7684\u7db2\u5740\uff08\u4f8b\u5982`appspot.com`\u7db2\u5740\uff09\uff0c\u8acb\u522a\u9664\u9805\u76ee\u5167\u7684\u6240\u9078\u8cc7\u6e90\uff0c\u800c\u4e0d\u662f\u522a\u9664\u6574\u500b\u9805\u76ee\u3002\n\u5982\u679c\u60a8\u6253\u7b97\u63a2\u7d22\u591a\u500b\u67b6\u69cb\u3001\u6559\u7a0b\u6216\u5feb\u901f\u5165\u9580\uff0c\u5247\u91cd\u8907\u4f7f\u7528\u9805\u76ee\u53ef\u4ee5\u5e6b\u52a9\u60a8\u907f\u514d\u8d85\u51fa\u9805\u76ee\u914d\u984d\u9650\u5236\u3002\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u9032\u5165 **\u7ba1\u7406\u8cc7\u6e90** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u7ba1\u7406\u8cc7\u6e90\u201d](https://console.cloud.google.com/iam-admin/projects?hl=zh-cn) \n- \u5728\u9805\u76ee\u5217\u8868\u4e2d\uff0c\u9078\u64c7\u8981\u522a\u9664\u7684\u9805\u76ee\uff0c\u7136\u5f8c\u9ede\u64ca **\u522a\u9664** \u3002\n- \u5728\u5c0d\u8a71\u6846\u4e2d\u8f38\u5165\u9805\u76ee ID\uff0c\u7136\u5f8c\u9ede\u64ca **\u95dc\u9589** \u4ee5\u522a\u9664\u9805\u76ee\u3002### \u522a\u9664\u65b0\u8cc7\u6e90\n\u4f5c\u7232\u522a\u9664\u6574\u500b\u9805\u76ee\u7684\u66ff\u4ee3\u65b9\u6cd5\uff0c\u60a8\u53ef\u4ee5\u522a\u9664\u5728\u6b64\u904e\u7a0b\u4e2d\u5275\u5efa\u7684\u5404\u500b\u8cc7\u6e90\u3002\u8acb\u6ce8\u610f\uff0c\u60a8\u7121\u6cd5\u5f9e\u9805\u76ee\u4e2d\u79fb\u9664 OAuth \u6b0a\u9650\u8acb\u6c42\u9801\u9762\u914d\u7f6e\uff0c\u53ea\u80fd\u9032\u884c\u4fee\u6539\u3002\n- \u5728 Cloud Shell \u4e2d\uff0c\u4f7f\u7528 terraform \u522a\u9664\u8cc7\u6e90\uff1a```\ncd ~/guacamole-on-gcp/tf-k8sterraform destroycd ~/guacamole-on-gcp/tf-infraterraform destroygcloud compute instances delete $TEST_VM \u2013-zone=$ZONE\n```## \u5f8c\u7e8c\u6b65\u9a5f\n- \u67e5\u770b\u6709\u95dc [\u5f37\u5316\u96c6\u7fa3\u7684\u5b89\u5168\u6027](https://cloud.google.com/kubernetes-engine/docs/how-to/hardening-your-cluster?hl=zh-cn) \u7684 GKE \u6307\u5c0e\u3002\n- \u67e5\u770b [\u5728\u61c9\u7528\u5c64\u5c0d Secret \u52a0\u5bc6](https://cloud.google.com/kubernetes-engine/docs/how-to/encrypting-secrets?hl=zh-cn) \uff0c\u4ee5\u77ad\u89e3\u5982\u4f55\u589e\u5f37 Secret\uff08\u4f8b\u5982\u6578\u64da\u5eab\u6191\u64da\u548c OAuth \u6191\u64da\uff09\u7684\u5b89\u5168\u6027\u3002\n- \u67e5\u770b [IAM Conditions](https://cloud.google.com/iam/docs/conditions-overview?hl=zh-cn) \uff0c\u4ee5\u77ad\u89e3\u5982\u4f55\u66f4\u7cbe\u7d30\u5730\u63a7\u5236\u7528\u6236\u5c0d Guacamole \u7684\u8a2a\u554f\u6b0a\u9650\u3002\n- \u67e5\u770b [GitHub \u4ee3\u78bc\u5eab](https://github.com/GoogleCloudPlatform/guacamole-on-gcp) \u4e2d\u7684\u81ea\u5b9a\u7fa9\u8eab\u4efd\u9a57\u8b49\u63d0\u4f9b\u65b9\uff0c\u4ee5\u8a73\u7d30\u77ad\u89e3 IAP \u96c6\u6210\u7684\u5de5\u4f5c\u539f\u7406\u3002\n- \u5982\u9700\u67e5\u770b\u66f4\u591a\u53c3\u8003\u67b6\u69cb\u3001\u5716\u8868\u548c\u6700\u4f73\u5be6\u8e10\uff0c\u8acb\u700f\u89bd [\u96f2\u67b6\u69cb\u4e2d\u5fc3](https://cloud.google.com/architecture?hl=zh-cn) \u3002", "guide": "Docs"}