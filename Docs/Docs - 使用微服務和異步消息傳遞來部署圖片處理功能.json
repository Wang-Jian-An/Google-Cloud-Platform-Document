{"title": "Docs - \u4f7f\u7528\u5fae\u670d\u52d9\u548c\u7570\u6b65\u6d88\u606f\u50b3\u905e\u4f86\u90e8\u7f72\u5716\u7247\u8655\u7406\u529f\u80fd", "url": "https://cloud.google.com/architecture/image-processing-using-microservices-and-asynchronous-messaging/deployment?hl=zh-cn", "abstract": "# Docs - \u4f7f\u7528\u5fae\u670d\u52d9\u548c\u7570\u6b65\u6d88\u606f\u50b3\u905e\u4f86\u90e8\u7f72\u5716\u7247\u8655\u7406\u529f\u80fd\nLast reviewed 2023-07-17 UTC\n\u672c\u6587\u6a94\u4ecb\u7d39\u5982\u4f55\u5be6\u73fe [\u5c07\u5fae\u670d\u52d9\u8207 Pub/Sub \u548c GKE \u96c6\u6210](https://cloud.google.com/architecture/image-processing-using-microservices-and-asynchronous-messaging?hl=zh-cn) \u4e2d\u6240\u8ff0\u7684\u53c3\u8003\u67b6\u69cb\u3002\u6b64\u67b6\u69cb\u65e8\u5728\u4f7f\u7528\u5bb9\u5668\u548c\u7570\u6b65\u6d88\u606f\u50b3\u905e\u529f\u80fd\u4f86\u8655\u7406\u9577\u6642\u9593\u904b\u884c\u7684\u9032\u7a0b\u3002\n\u672c\u6587\u6a94\u4f7f\u7528\u4e00\u500b\u793a\u4f8b\u7167\u7247\u5206\u4eab\u61c9\u7528\u4f86\u751f\u6210\u7167\u7247\u7e2e\u7565\u5716\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528 Google Kubernetes Engine (GKE) \u4f86\u90e8\u7f72\u61c9\u7528\uff0c\u4e26\u4f7f\u7528 Pub/Sub \u4f86\u7570\u6b65\u8abf\u7528\u9577\u6642\u9593\u904b\u884c\u7684\u9032\u7a0b\u3002\u60a8\u9084\u53ef\u4ee5\u4f7f\u7528\u9069\u7528\u65bc Cloud Storage \u7684 Pub/Sub \u901a\u77e5\u529f\u80fd\u4f86\u6dfb\u52a0\u4e00\u4e9b\u8f14\u52a9\u4f5c\u696d\uff0c\u800c\u7121\u9700\u4fee\u6539\u61c9\u7528\u7684\u4ee3\u78bc\u3002\n\u61c9\u7528\u7531 Cloud Build \u5bb9\u5668\u5316\u4e26\u5b58\u5132\u5728 Artifact Registry \u4e2d\u3002\u5b83\u4f7f\u7528 Cloud Vision \u4f86\u6aa2\u6e2c\u4e0d\u7576\u5716\u7247\u3002\n", "content": "## \u67b6\u69cb\n\u4e0b\u5716\u5c55\u793a\u4e86\u5be6\u73fe [\u53c3\u8003\u67b6\u69cb](https://cloud.google.com/architecture/image-processing-using-microservices-and-asynchronous-messaging?hl=zh-cn#architecture) \u7684\u793a\u4f8b\u76f8\u518a\u61c9\u7528\u7684\u8a2d\u8a08\u3002\n**\u5716 1.** \u57fa\u65bc\u4f7f\u7528\u5bb9\u5668\u548c\u7570\u6b65\u6d88\u606f\u50b3\u905e\u7684\u5716\u7247\u8655\u7406\u67b6\u69cb\u3002\n\u4e0a\u5716\u5c55\u793a\u77ad\u5982\u4f55\u751f\u6210\u7e2e\u7565\u5716\uff1a\n- \u5ba2\u6236\u7aef\u5c07\u5716\u7247\u4e0a\u50b3\u5230\u61c9\u7528\u3002\n- \u61c9\u7528\u5c07\u5716\u7247\u5b58\u5132\u5728 [Cloud Storage](https://cloud.google.com/storage/pricing?hl=zh-cn) \u4e2d\u3002\n- \u7cfb\u7d71\u7232\u7e2e\u7565\u5716\u751f\u6210\u8acb\u6c42\u3002\n- \u7e2e\u7565\u5716\u751f\u6210\u5668\u751f\u6210\u7e2e\u7565\u5716\u3002\n- \u6210\u529f\u97ff\u61c9\u88ab\u9aee\u9001\u5230\u76f8\u518a\u61c9\u7528\u3002\n- \u6210\u529f\u7684\u97ff\u61c9\u88ab\u9aee\u9001\u7d66\u5ba2\u6236\u7aef\uff0c\u60a8\u53ef\u4ee5\u5728 [Cloud Storage](https://cloud.google.com/storage/pricing?hl=zh-cn) \u4e2d\u627e\u5230\u8a72\u7e2e\u7565\u5716\u3002\n\u4e0b\u5716\u5c55\u793a\u4e86\u61c9\u7528\u5982\u4f55\u4ee5\u7570\u6b65\u65b9\u5f0f\u5c07\u7e2e\u7565\u5716\u751f\u6210\u529f\u80fd\u4f5c\u7232\u4e00\u9805\u55ae\u7368\u7684\u670d\u52d9\u4f86\u5be6\u73fe\u3002\n**\u5716 2.** \u7e2e\u7565\u5716\u63d0\u53d6\u9032\u7a0b\u7684\u67b6\u69cb\u3002\n\u60a8\u53ef\u4ee5\u4f7f\u7528 Pub/Sub \u5411\u7e2e\u7565\u5716\u751f\u6210\u670d\u52d9\u767c\u9001\u670d\u52d9\u8acb\u6c42\u3002\u9019\u4e00\u65b0\u67b6\u69cb\u4ee5\u7570\u6b65\u65b9\u5f0f\u8abf\u7528\u670d\u52d9\uff0c\u4f7f\u61c9\u7528\u5c07\u97ff\u61c9\u767c\u9001\u56de\u5ba2\u6236\u7aef\u5f8c\u7e94\u5728\u5f8c\u81fa\u5275\u5efa\u7e2e\u7565\u5716\u3002\u8a72\u8a2d\u8a08\u9084\u8b93\u60a8\u53ef\u4ee5\u5c0d\u7e2e\u7565\u5716\u751f\u6210\u670d\u52d9\u9032\u884c\u64f4\u7e2e\uff0c\u4ee5\u4fbf\u591a\u500b\u4f5c\u696d\u80fd\u5920\u4e26\u884c\u904b\u884c\u3002\n## \u76ee\u6a19\n- \u5728 GKE \u4e0a\u90e8\u7f72\u793a\u4f8b\u76f8\u518a\u61c9\u7528\u3002\n- \u5f9e\u61c9\u7528\u767c\u51fa\u7570\u6b65\u670d\u52d9\u8abf\u7528\u3002\n- \u5728\u5c07\u65b0\u6587\u4ef6\u4e0a\u50b3\u5230 Cloud Storage \u5b58\u5132\u6876\u6642\uff0c\u4f7f\u7528 Cloud Storage \u7684 Pub/Sub \u901a\u77e5\u89f8\u767c\u61c9\u7528\u3002\n- \u4f7f\u7528 Pub/Sub \u57f7\u884c\u66f4\u591a\u4efb\u52d9\uff0c\u800c\u7121\u9700\u4fee\u6539\u61c9\u7528\u3002## \u8cbb\u7528\u5728\u672c\u6587\u6a94\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Google Cloud \u7684\u4ee5\u4e0b\u6536\u8cbb\u7d44\u4ef6\uff1a\n- [Cloud Storage](https://cloud.google.com/storage/pricing?hl=zh-cn) \n- [Cloud SQL](https://cloud.google.com/sql/pricing?hl=zh-cn) \n- [Pub/Sub](https://cloud.google.com/pubsub/pricing?hl=zh-cn) \n- [GKE \u4f7f\u7528\u7684 Compute Engine \u5be6\u4f8b](https://cloud.google.com/kubernetes-engine/pricing?hl=zh-cn) \n- [GKE \u7684\u96c6\u7fa3\u7ba1\u7406\u8cbb\u7528](https://cloud.google.com/kubernetes-engine/pricing?hl=zh-cn#cluster_management_fee_and_free_tier) \n- [Cloud Load Balancing](https://cloud.google.com/vpc/network-pricing?hl=zh-cn#lb) \n- [Cloud Build](https://cloud.google.com/build/pricing?hl=zh-cn) \n- [Artifact Registry](https://cloud.google.com/artifact-registry?hl=zh-cn) \n- [Vision](https://cloud.google.com/vision?hl=zh-cn) \n\u60a8\u53ef\u4f7f\u7528 [\u50f9\u683c\u8a08\u7b97\u5668](https://cloud.google.com/products/calculator?hl=zh-cn) \u6839\u64da\u60a8\u7684\u9810\u8a08\u4f7f\u7528\u60c5\u6cc1\u4f86\u4f30\u7b97\u8cbb\u7528\u3002\n\u5b8c\u6210\u793a\u4f8b\u61c9\u7528\u7684\u69cb\u5efa\u5f8c\uff0c\u60a8\u53ef\u4ee5\u522a\u9664\u6240\u5275\u5efa\u7684\u8cc7\u6e90\u4ee5\u907f\u514d\u7e7c\u7e8c\u8a08\u8cbb\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u6e05\u7406](#clean-up) \u3002\n## \u9808\u77e5\u4e8b\u9805\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u6fc0\u6d3b Cloud Shell\u3002 [\u6fc0\u6d3b Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn)  [Cloud Shell](https://cloud.google.com/shell/docs/how-cloud-shell-works?hl=zh-cn) \u6703\u8a71\u96a8\u5373\u6703\u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5e95\u90e8\u5553\u52d5\uff0c\u4e26\u986f\u793a\u547d\u4ee4\u884c\u63d0\u793a\u7b26\u3002Cloud Shell \u662f\u4e00\u500b\u5df2\u5b89\u88dd Google Cloud CLI \u4e14\u5df2\u7232\u7576\u524d\u9805\u76ee\u8a2d\u7f6e\u503c\u7684 Shell \u74b0\u5883\u3002\u8a72\u6703\u8a71\u53ef\u80fd\u9700\u8981\u5e7e\u79d2\u9418\u6642\u9593\u4f86\u5b8c\u6210\u521d\u59cb\u5316\u3002\n## \u8a2d\u7f6e\u74b0\u5883\n\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u7232\u6574\u500b\u6587\u6a94\u4e2d\u4f7f\u7528\u7684\u503c\u5206\u914d\u9ed8\u8a8d\u8a2d\u7f6e\u3002\u5982\u679c\u60a8\u95dc\u9589 Cloud Shell \u6703\u8a71\uff0c\u5247\u6703\u4e1f\u5931\u9019\u4e9b\u74b0\u5883\u8a2d\u7f6e\u3002\n- \u5728 Cloud Shell \u4e2d\uff0c\u8a2d\u7f6e\u9ed8\u8a8d Google Cloud \u9805\u76ee\uff1a```\ngcloud config set project PROJECT_ID\n```\u5c07 `` \u66ff\u63db\u7232\u60a8\u7684 Google Cloud \u9805\u76ee ID\u3002\n- \u8a2d\u7f6e\u9ed8\u8a8d\u7684 Compute Engine \u5340\u57df\uff1a```\ngcloud config set compute/region REGION\nexport REGION=REGION\n```\u5c07 `` \u66ff\u63db\u7232\u60a8\u9644\u8fd1\u7684\u5340\u57df\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5340\u57df\u548c\u5730\u5340](https://cloud.google.com/compute/docs/regions-zones?hl=zh-cn) \u3002\n- \u8a2d\u7f6e\u9ed8\u8a8d\u7684 Compute Engine \u53ef\u7528\u5340\uff1a```\ngcloud config set compute/zone ZONE\nexport ZONE=ZONE\n```\u5c07 `` \u66ff\u63db\u7232\u60a8\u9644\u8fd1\u7684\u53ef\u7528\u5340\u3002\n- \u4e0b\u8f09\u793a\u4f8b\u61c9\u7528\u6587\u4ef6\u4e26\u8a2d\u7f6e\u7576\u524d\u76ee\u9304\uff1a```\ngit clone https://github.com/GoogleCloudPlatform/gke-photoalbum-example\ncd gke-photoalbum-example\n```## \u5275\u5efa Cloud Storage \u5b58\u5132\u6876\u4e26\u4e0a\u50b3\u9ed8\u8a8d\u7e2e\u7565\u5716\n- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa Cloud Storage \u5b58\u5132\u5206\u5340\u4ee5\u5b58\u5132\u539f\u59cb\u5716\u7247\u548c\u7e2e\u7565\u5716\uff1a```\nexport PROJECT_ID=$(gcloud config get-value project)\ngsutil mb -c regional -l ${REGION} gs://${PROJECT_ID}-photostore\n```\n- \u4e0a\u50b3\u9ed8\u8a8d\u7e2e\u7565\u5716\u6587\u4ef6\uff1a```\ngsutil cp ./application/photoalbum/images/default.png \\\n gs://${PROJECT_ID}-photostore/thumbnails/default.png\n```- \u6309\u4ee5\u4e0b\u683c\u5f0f\u5b58\u5132\u4e0a\u50b3\u7684\u5716\u7247\uff1a`gs://` `` `-photostore/` ``\uff0c\u5176\u4e2d``\u8868\u793a\u4e0a\u50b3\u7684\u5716\u7247\u6587\u4ef6\u7684\u540d\u7a31\u3002\n- \u6309\u4ee5\u4e0b\u683c\u5f0f\u5b58\u5132\u751f\u6210\u7684\u7e2e\u7565\u5716\uff1a`gs://` `` `-photostore/thumbnails/` ``\u3002\n- \u539f\u59cb\u5716\u7247\u548c\u76f8\u61c9\u7684\u7e2e\u7565\u5716\u5177\u6709\u76f8\u540c\u7684``\u503c\uff0c\u4f46\u7e2e\u7565\u5716\u5b58\u5132\u5728`thumbnails`\u5b58\u5132\u6876\u4e2d\u3002\n- \u5275\u5efa\u7e2e\u7565\u5716\u6642\uff0c\u76f8\u518a\u61c9\u7528\u4e2d\u6703\u986f\u793a\u4ee5\u4e0b `default.png` \u4f54\u4f4d\u7b26\u7e2e\u7565\u5716\u3002 \n- \u5c07\u7e2e\u7565\u5716\u6587\u4ef6\u8a2d\u7232\u516c\u958b\uff1a```\ngsutil acl ch -u AllUsers:R \\\n gs://${PROJECT_ID}-photostore/thumbnails/default.png\n```## \u5275\u5efa Cloud SQL \u5be6\u4f8b\u548c MySQL \u6578\u64da\u5eab\n- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa Cloud SQL \u5be6\u4f8b\uff1a```\ngcloud sql instances create photoalbum-db --region=${REGION} \\\n --database-version=MYSQL_8_0\n```\n- \u6aa2\u7d22\u9023\u63a5\u540d\u7a31\uff1a```\ngcloud sql instances describe photoalbum-db \\\n --format=\"value(connectionName)\"\n```\u8a18\u4e0b\u8a72\u540d\u7a31\uff0c\u5f8c\u9762\u60a8\u5c07\u7528\u5230\u8a72\u540d\u7a31\u3002\n- \u7232 `root@%` MySQL \u7528\u6236\u8a2d\u7f6e\u5bc6\u78bc\uff1a```\ngcloud sql users set-password root --host=% --instance=photoalbum-db \\\n --password=PASSWORD\n```\u5c07 `` \u66ff\u63db\u7232 `root@%` \u7528\u6236\u7684\u5b89\u5168\u5bc6\u78bc\u3002\n- \u9023\u63a5\u5230 Cloud SQL \u5be6\u4f8b\uff1a```\ngcloud sql connect photoalbum-db --user=root --quiet\n```\u51fa\u73fe\u63d0\u793a\u6642\uff0c\u8f38\u5165\u60a8\u5728\u4e0a\u4e00\u6b65\u4e2d\u8a2d\u7f6e\u7684\u5bc6\u78bc\u3002\n- \u5275\u5efa\u4e00\u500b\u540d\u7232 `photo_db` \u7684\u6578\u64da\u5eab\uff0c\u5176\u4e2d\u7528\u6236\u7232 `appuser` \uff0c\u5bc6\u78bc\u7232 `pas4appuser` \uff1a```\ncreate database photo_db;\ncreate user 'appuser'@'%' identified by 'pas4appuser';\ngrant all on photo_db.* to 'appuser'@'%' with grant option;\nflush privileges;\n```\n- \u78ba\u8a8d\u7d50\u679c\u4e26\u5f9e MySQL \u9000\u51fa\uff1a```\nshow databases;\nselect user from mysql.user;\nexit\n```\u5728\u8f38\u51fa\u4e2d\uff0c\u78ba\u8a8d\u5df2\u5275\u5efa `photo_db` \u6578\u64da\u5eab\u548c `appuser` \u7528\u6236\uff1a```\nmysql> show databases;\n+--------------------+\n| Database   |\n+--------------------+\n| information_schema |\n| mysql    |\n| performance_schema |\n| photo_db   |\n| sys    |\n+--------------------+\n5 rows in set (0.16 sec)\nmysql> \\t\nOutfile disabled.\nmysql> select user from mysql.user;\n+-------------------+\n| user    |\n+-------------------+\n| appuser   |\n| cloudsqlreplica |\n| cloudsqlsuperuser |\n| root    |\n| cloudsqlexport |\n| cloudsqlimport |\n| cloudsqloneshot |\n| root    |\n| cloudsqlexport |\n| cloudsqlimport |\n| cloudsqloneshot |\n| root    |\n| cloudsqlapplier |\n| cloudsqlimport |\n| mysql.infoschema |\n| mysql.session  |\n| mysql.sys   |\n| root    |\n+-------------------+\n18 rows in set (0.16 sec)\nmysql> exit\nBye\n```## \u5275\u5efa Pub/Sub \u4e3b\u984c\u548c\u8a02\u95b1\n- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa\u540d\u7232 `thumbnail-service` \u7684 Pub/Sub \u4e3b\u984c\uff1a```\ngcloud pubsub topics create thumbnail-service\n```\u76f8\u518a\u61c9\u7528\u901a\u904e\u5728 `thumbnail-service` \u4e3b\u984c\u4e0a\u767c\u4f48\u6d88\u606f\uff0c\u5411\u7e2e\u7565\u5716\u751f\u6210\u670d\u52d9\u767c\u9001\u8acb\u6c42\u3002\n- \u5275\u5efa\u540d\u7232 `thumbnail-workers` \u7684 Pub/Sub \u8a02\u95b1\uff1a```\ngcloud pubsub subscriptions create --topic thumbnail-service thumbnail-workers\n```\u7e2e\u7565\u5716\u751f\u6210\u670d\u52d9\u6703\u6536\u5230\u4f86\u81ea `thumbnail-workers` \u8a02\u95b1\u7684\u8acb\u6c42\u3002## \u5275\u5efa GKE \u96c6\u7fa3\n- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa\u4e00\u500b\u6709\u6b0a\u8abf\u7528 API \u7684 GKE \u96c6\u7fa3\uff1a```\ngcloud container clusters create \"photoalbum-cluster\" \\\n --scopes \"https://www.googleapis.com/auth/cloud-platform\" \\\n --num-nodes \"5\"\n```\n- \u914d\u7f6e\u8a2a\u554f\u6191\u64da\uff0c\u4ee5\u4fbf\u5728\u5f8c\u7e8c\u6b65\u9a5f\u4e2d\u4f7f\u7528 `kubectl` \u547d\u4ee4\u7ba1\u7406\u96c6\u7fa3\uff1a```\ngcloud container clusters get-credentials photoalbum-cluster\n```\n- \u986f\u793a\u7bc0\u9ede\u5217\u8868\uff1a```\nkubectl get nodes\n```\u5728\u8f38\u51fa\u4e2d\uff0c\u78ba\u8a8d\u6709 5 \u500b\u7bc0\u9ede\u7684 `STATUS` \u503c\u7232 `Ready` \uff1a```\nNAME            STATUS ROLES AGE  VERSION\ngke-photoalbum-cluster-default-pool-d637570a-2pfh Ready <none> 2m55s v1.24.10-gke.2300\ngke-photoalbum-cluster-default-pool-d637570a-3rm4 Ready <none> 2m55s v1.24.10-gke.2300\ngke-photoalbum-cluster-default-pool-d637570a-f7l4 Ready <none> 2m55s v1.24.10-gke.2300\ngke-photoalbum-cluster-default-pool-d637570a-qb2z Ready <none> 2m53s v1.24.10-gke.2300\ngke-photoalbum-cluster-default-pool-d637570a-rvnp Ready <none> 2m54s v1.24.10-gke.2300\n```## \u5275\u5efa Artifact Registry \u4ee3\u78bc\u5eab\n- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa\u4e00\u500b\u4ee3\u78bc\u5eab\u4f86\u5b58\u5132\u5bb9\u5668\u6620\u50cf\uff1a```\ngcloud artifacts repositories create photoalbum-repo \\\n --repository-format=docker \\\n --location=us-central1 \\\n --description=\"Docker repository\"\n```## \u7232\u61c9\u7528\u69cb\u5efa\u6620\u50cf\n- \u5728\u6587\u672c\u7de8\u8f2f\u5668\u4e2d\uff0c\u6253\u958b `application/photoalbum/src/auth_decorator.py` \u6587\u4ef6\u4e26\u66f4\u65b0\u7528\u6236\u540d\u548c\u5bc6\u78bc\uff1a```\nUSERNAME = 'username'\nPASSWORD = 'passw0rd'\n```\n- \u5728 Cloud Shell \u4e2d\uff0c\u4f7f\u7528 Cloud Build \u670d\u52d9\u7232\u76f8\u518a\u61c9\u7528\u69cb\u5efa\u6620\u50cf\uff1a```\ngcloud builds submit ./application/photoalbum -t \\\n us-central1-docker.pkg.dev/${PROJECT_ID}/photoalbum-repo/photoalbum-app\n```\n- \u4f7f\u7528 Cloud Build \u670d\u52d9\u7232 `thumbnail-worker` \u7e2e\u7565\u5716\u751f\u6210\u670d\u52d9\u69cb\u5efa\u6620\u50cf\uff1a```\ngcloud builds submit ./application/thumbnail -t \\\n us-central1-docker.pkg.dev/${PROJECT_ID}/photoalbum-repo/thumbnail-worker\n```## \u90e8\u7f72\u76f8\u518a\u61c9\u7528\n- \u5728 Cloud Shell \u4e2d\uff0c\u4f7f\u7528\u60a8\u74b0\u5883\u4e2d\u7684\u503c\u66f4\u65b0\u76f8\u518a\u548c\u7e2e\u7565\u5716\u751f\u6210\u5668\u7684 Kubernetes Deployment \u6e05\u55ae\uff1a```\nconnection_name=$(gcloud sql instances describe photoalbum-db \\\n --format \"value(connectionName)\")\ndigest_photoalbum=$(gcloud container images describe \\\n us-central1-docker.pkg.dev/${PROJECT_ID}/photoalbum-repo/photoalbum-app:latest --format \\\n \"value(image_summary.digest)\")\nsed -i.bak -e \"s/\\[PROJECT_ID\\]/${PROJECT_ID}/\" \\\n -e \"s/\\[CONNECTION_NAME\\]/${connection_name}/\" \\\n -e \"s/\\[DIGEST\\]/${digest_photoalbum}/\" \\\n config/photoalbum-deployment.yaml\ndigest_thumbnail=$(gcloud container images describe \\\n us-central1-docker.pkg.dev/${PROJECT_ID}/photoalbum-repo/thumbnail-worker:latest --format \\\n \"value(image_summary.digest)\")\nsed -i.bak -e \"s/\\[PROJECT_ID\\]/${PROJECT_ID}/\" \\\n -e \"s/\\[CONNECTION_NAME\\]/${connection_name}/\" \\\n -e \"s/\\[DIGEST\\]/${digest_thumbnail}/\" \\\n  config/thumbnail-deployment.yaml\n```\n- \u5275\u5efa\u90e8\u7f72\u8cc7\u6e90\u4ee5\u5553\u52d5\u76f8\u518a\u61c9\u7528\u548c\u7e2e\u7565\u5716\u751f\u6210\u670d\u52d9\uff1a```\nkubectl create -f config/photoalbum-deployment.yaml\nkubectl create -f config/thumbnail-deployment.yaml\n```\n- \u5275\u5efa\u670d\u52d9\u8cc7\u6e90\uff0c\u7232\u61c9\u7528\u5206\u914d\u5916\u90e8 IP \u5730\u5740\uff1a```\nkubectl create -f config/photoalbum-service.yaml\n```\n- \u67e5\u770b Pod \u7684\u7d50\u679c\uff1a```\nkubectl get pods\n```\u5728\u8f38\u51fa\u4e2d\uff0c\u78ba\u8a8d\u6bcf\u500b `photoalbum-app` \u548c `thumbail-worker` Pod \u6709 3 \u500b Pod \u4e14\u5176 `STATUS` \u503c\u7232 `Running` \uff1a```\nNAME        READY  STATUS RESTARTS AGE\nphotoalbum-app-555f7cbdb7-cp8nw  2/2  Running 0   2m\nphotoalbum-app-555f7cbdb7-ftlc6  2/2  Running 0   2m\nphotoalbum-app-555f7cbdb7-xsr4b  2/2  Running 0   2m\nthumbnail-worker-86bd95cd68-728k5 2/2  Running 0   2m\nthumbnail-worker-86bd95cd68-hqxqr 2/2  Running 0   2m\nthumbnail-worker-86bd95cd68-xnxhc 2/2  Running 0   2m\n````thumbnail-worker` Pod \u6703\u901a\u904e `thumbnail-workers` \u8a02\u95b1\u4f86\u8a02\u95b1\u7e2e\u7565\u5716\u751f\u6210\u8acb\u6c42\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1\u5982\u4f55\u5728 [\u6e90\u4ee3\u78bc](https://github.com/GoogleCloudPlatform/gke-photoalbum-example/blob/master/application/thumbnail/src/worker.py) \u4e2d\u4f7f\u7528 `callback` \u51fd\u6578\u3002\n- \u67e5\u770b\u670d\u52d9\u7684\u7d50\u679c\uff1a```\nkubectl get services\n```\u5728\u8f38\u51fa\u4e2d\uff0c\u78ba\u8a8d `photoalbum-service` \u670d\u52d9\u7684 `EXTERNAL-IP` \u5217\u4e2d\u6709\u4e00\u500b\u5916\u90e8 IP \u5730\u5740\u3002\u670d\u52d9\u53ef\u80fd\u9700\u8981\u5e7e\u5206\u9418\u6642\u9593\u624d\u80fd\u5168\u90e8\u904b\u884c\u3002```\nNAME     TYPE   CLUSTER-IP  EXTERNAL-IP  PORT(S)  AGE\nkubernetes   ClusterIP  10.23.240.1  <none>   443/TCP  20m\nphotoalbum-service LoadBalancer 10.23.253.241 146.148.111.115 80:32657/TCP 2m\n```\u8a18\u4e0b\u8a72\u5916\u90e8 IP \u5730\u5740\uff0c\u5f8c\u9762\u60a8\u5c07\u7528\u5230\u8a72 IP \u5730\u5740\u3002\u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u8a72 IP \u5730\u5740\u7232 `146.148.111.115` \u3002## \u6e2c\u8a66\u76f8\u518a\u61c9\u7528\n- \u5982\u9700\u5728\u7db2\u7d61\u700f\u89bd\u5668\u4e2d\u8a2a\u554f\u5df2\u90e8\u7f72\u7684\u61c9\u7528\uff0c\u8acb\u8f49\u5230\u4ee5\u4e0b\u7db2\u5740\uff0c\u4e26\u8f38\u5165\u60a8\u4e4b\u524d\u8a2d\u7f6e\u7684\u7528\u6236\u540d\u548c\u5bc6\u78bc\uff1a```\nhttp://EXTERNAL_IP\n```\u5c07 `` \u66ff\u63db\u7232\u60a8\u5728\u4e0a\u4e00\u6b65\u4e2d\u8907\u88fd\u7684 IP \u5730\u5740\u3002\n- \u5982\u9700\u4e0a\u50b3\u5716\u7247\u6587\u4ef6\uff0c\u8acb\u9ede\u64ca **\u4e0a\u50b3** \u3002 \u6b64\u6642\uff0c\u5c4f\u5e55\u4e0a\u5c07\u986f\u793a\u7e2e\u7565\u5716\u4f54\u4f4d\u7b26\u3002\u5728\u5f8c\u81fa\uff0c\u7e2e\u7565\u5716\u751f\u6210\u670d\u52d9\u6703\u5275\u5efa\u5df2\u4e0a\u50b3\u5716\u7247\u7684\u7e2e\u7565\u5716\u3002\u5982\u9700\u67e5\u770b\u751f\u6210\u7684\u7e2e\u7565\u5716\uff0c\u8acb\u9ede\u64ca **\u5237\u65b0** \u3002Cloud Vision API \u6703\u6dfb\u52a0\u5b83\u6aa2\u6e2c\u5230\u7684\u5716\u7247\u6a19\u7c64\u3002 \u8981\u67e5\u770b\u539f\u59cb\u5716\u7247\uff0c\u8acb\u9ede\u64ca\u7e2e\u7565\u5716\u3002## \u6dfb\u52a0\u4e0d\u7576\u5716\u7247\u6aa2\u6e2c\u529f\u80fd\n\u4e0b\u5716\u6f14\u793a\u77ad\u5982\u4f55\u4f7f\u7528 Cloud Storage \u7684 Pub/Sub \u901a\u77e5\u4f86\u89f8\u767c\u7528\u65bc\u6aa2\u6e2c\u4e0d\u7576\u5167\u5bb9\u7684\u670d\u52d9\u3002\u7576 Cloud Storage \u5b58\u5132\u5206\u5340\u4e2d\u5b58\u5132\u4e86\u5305\u542b\u4e0d\u7576\u5167\u5bb9\u7684\u65b0\u6587\u4ef6\u6642\uff0c\u6b64\u529f\u80fd\u6703\u5c0d\u5716\u7247\u9032\u884c\u6a21\u7cca\u8655\u7406\u3002\n\u5728\u4e0a\u5716\u4e2d\uff0c\u8a72\u670d\u52d9\u4f7f\u7528 Vision API \u7684 [\u5b89\u5168\u641c\u7d22\u6aa2\u6e2c](https://cloud.google.com/vision/docs/detecting-safe-search?hl=zh-cn) \u529f\u80fd\u6aa2\u6e2c\u5716\u7247\u4e2d\u7684\u4e0d\u7576\u5167\u5bb9\u3002\n\u7531\u65bc\u7167\u7247\u61c9\u7528\u6703\u7570\u6b65\u89f8\u767c\u7e2e\u7565\u5716\u751f\u6210\u5668\u548c\u5716\u7247\u6aa2\u67e5\u5de5\u5177\uff1b\u56e0\u6b64\uff0c\u7121\u6cd5\u4fdd\u8b49\u5b83\u5011\u6309\u7279\u5b9a\u9806\u5e8f\u57f7\u884c\u3002\u5982\u679c\u7e2e\u7565\u5716\u751f\u6210\u767c\u751f\u5728\u5716\u7247\u6a21\u7cca\u8655\u7406\u4e4b\u524d\uff0c\u90a3\u9ebc\u60a8\u53ef\u80fd\u6703\u5728\u77ed\u6642\u9593\u5167\u770b\u5230\u4e0d\u7576\u7e2e\u7565\u5716\u3002\u4f46\u662f\uff0c\u5716\u7247\u6aa2\u67e5\u5de5\u5177\u6700\u7d42\u6703\u5c0d\u4e0d\u7576\u5716\u7247\u548c\u4e0d\u7576\u7e2e\u7565\u5716\u9032\u884c\u6a21\u7cca\u8655\u7406\u3002\n### \u5275\u5efa Pub/Sub \u4e3b\u984c\u3001\u8a02\u95b1\u548c\u901a\u77e5\n- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa\u540d\u7232 `safeimage-service` \u7684 Pub/Sub \u4e3b\u984c\uff1a```\ngcloud pubsub topics create safeimage-service\n```\n- \u5275\u5efa\u540d\u7232 `safeimage-workers` \u7684 Pub/Sub \u8a02\u95b1\uff1a```\ngcloud pubsub subscriptions create --topic safeimage-service \\\n safeimage-workers\n```\n- \u914d\u7f6e [Pub/Sub \u901a\u77e5](https://cloud.google.com/storage/docs/pubsub-notifications?hl=zh-cn) \uff0c\u4ee5\u4fbf\u5728\u65b0\u6587\u4ef6\u4e0a\u50b3\u5230 Cloud Storage \u5b58\u5132\u5206\u5340\u6642\u5411 `safeimage-service` \u4e3b\u984c\u767c\u9001\u6d88\u606f\uff1a```\ngsutil notification create -t safeimage-service -f json \\\n gs://${PROJECT_ID}-photostore\n```\n### \u69cb\u5efa\u548c\u90e8\u7f72\u5de5\u4f5c\u5668\u6620\u50cf\n- \u5728 Cloud Shell \u4e2d\uff0c\u4f7f\u7528 Cloud Build \u7232 `safeimage-workers` \u8a02\u95b1\u69cb\u5efa\u5bb9\u5668\u6620\u50cf\uff1a```\ngcloud builds submit ./application/safeimage \\\n -t us-central1-docker.pkg.dev/${PROJECT_ID}/photoalbum-repo/safeimage-worker\n```\n- \u4f7f\u7528 Google Cloud \u9805\u76ee ID\u3001Cloud SQL \u9023\u63a5\u540d\u7a31\u548c\u5bb9\u5668\u6620\u50cf\u6458\u8981\u66f4\u65b0\u5b89\u5168\u6620\u50cf\u670d\u52d9\u7684 Kubernetes Deployment \u6e05\u55ae\uff1a```\ndigest_safeimage=$(gcloud container images describe \\\n us-central1-docker.pkg.dev/${PROJECT_ID}/photoalbum-repo/safeimage-worker:latest --format \\\n \"value(image_summary.digest)\")\nsed -i.bak -e \"s/\\[PROJECT_ID\\]/${PROJECT_ID}/\" \\\n -e \"s/\\[CONNECTION_NAME\\]/${connection_name}/\" \\\n -e \"s/\\[DIGEST\\]/${digest_safeimage}/\" \\\n config/safeimage-deployment.yaml\n```\n### \u5275\u5efa\u90e8\u7f72\u8cc7\u6e90\n- \u5275\u5efa\u540d\u7232 `safeimage-deployment` \u7684\u90e8\u7f72\u8cc7\u6e90\u4ee5\u90e8\u7f72 `safeimage-service` \u4e3b\u984c\uff1a```\nkubectl create -f config/safeimage-deployment.yaml\n```\n- \u6aa2\u67e5\u7d50\u679c\uff1a```\nkubectl get pods\n```\u5728\u8f38\u51fa\u4e2d\uff0c\u78ba\u8a8d\u6709 3 \u500b `safeimage-worker` Pod \u7684 `STATUS` \u503c\u7232 `Running` \u3002```\nNAME        READY  STATUS RESTARTS AGE\nphotoalbum-app-555f7cbdb7-cp8nw  2/2  Running 0   30m\nphotoalbum-app-555f7cbdb7-ftlc6  2/2  Running 0   30m\nphotoalbum-app-555f7cbdb7-xsr4b  2/2  Running 8   30m\nsafeimage-worker-7dc8c84f54-6sqzs 1/1  Running 0   2m\nsafeimage-worker-7dc8c84f54-9bskw 1/1  Running 0   2m\nsafeimage-worker-7dc8c84f54-b7gtp 1/1  Running 0   2m\nthumbnail-worker-86bd95cd68-9wrpv 2/2  Running 0   30m\nthumbnail-worker-86bd95cd68-kbhsn 2/2  Running 2   30m\nthumbnail-worker-86bd95cd68-n4rj7 2/2  Running 0   30m\n````safeimage-worker` Pod \u6703\u901a\u904e `safeimage-workers` \u8a02\u95b1\u4f86\u8a02\u95b1\u4e0d\u7576\u5716\u7247\u6aa2\u6e2c\u8acb\u6c42\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1\u5982\u4f55\u5728 [\u6e90\u4ee3\u78bc](https://github.com/GoogleCloudPlatform/gke-photoalbum-example/blob/master/application/safeimage/src/worker.py) \u4e2d\u4f7f\u7528 `callback` \u51fd\u6578\u3002\n### \u6e2c\u8a66\u4e0d\u7576\u5716\u7247\u6aa2\u6e2c\u529f\u80fd\n\u5728\u6b64\u90e8\u5206\u4e2d\uff0c\u60a8\u9700\u8981\u4e0a\u50b3\u4e00\u5f35\u6e2c\u8a66\u5716\u7247\uff0c\u4ee5\u9a57\u8b49 [\u5b89\u5168\u641c\u7d22\u6aa2\u6e2c](https://cloud.google.com/vision/docs/detecting-safe-search?hl=zh-cn) \u529f\u80fd\u662f\u5426\u5c0d\u4e0d\u7576\u5716\u7247\u9032\u884c\u4e86\u6a21\u7cca\u8655\u7406\u3002\u6e2c\u8a66\u5716\u7247\u662f\u4e00\u5f35\u88dd\u626e\u6210\u6bad\u5c4d\u7684\u5973\u5b69\u7684\u7167\u7247\uff08\u7d93 [Pixaby CC0 \u8a31\u53ef](https://pixabay.com/service/license/) \u6388\u6b0a\u4f7f\u7528\uff09\u3002\n- [\u4e0b\u8f09\u6e2c\u8a66\u5716\u7247](https://cdn.pixabay.com/photo/2014/10/24/06/11/zombie-500828_1280.jpg) \u3002\n- \u5982\u9700\u4e0a\u50b3\u5716\u7247\uff0c\u8acb\u8f49\u5230`http://` ``\uff0c\u7136\u5f8c\u9ede\u64ca **\u4e0a\u50b3** \u3002\n- \u9ede\u64ca **\u5237\u65b0** \u3002\u6b64\u6642\uff0c\u8a72\u61c9\u7528\u6703\u986f\u793a\u7d93\u904e\u6a21\u7cca\u8655\u7406\u7684\u7e2e\u7565\u5716\u3002 \u8981\u67e5\u770b\u4e0a\u50b3\u7684\u5716\u7247\u662f\u5426\u4e5f\u7d93\u904e\u4e86\u6a21\u7cca\u8655\u7406\uff0c\u8acb\u9ede\u64ca\u7e2e\u7565\u5716\u3002## \u6e05\u7406\n\u5982\u679c\u60a8\u4e0d\u60f3\u4fdd\u7559\u7232\u793a\u4f8b\u61c9\u7528\u5275\u5efa\u7684 Google Cloud \u8cc7\u6e90\uff0c\u5247\u53ef\u4ee5\u79fb\u9664\u9019\u4e9b\u8cc7\u6e90\uff0c\u4ee5\u514d\u65e5\u5f8c\u7e7c\u7e8c\u7232\u9019\u4e9b\u8cc7\u6e90\u4ed8\u8cbb\u3002\u60a8\u53ef\u4ee5\u5fb9\u5e95\u522a\u9664\u9805\u76ee\uff0c\u4e5f\u53ef\u4ee5\u522a\u9664\u96c6\u7fa3\u8cc7\u6e90\uff0c\u7136\u5f8c\u522a\u9664\u96c6\u7fa3\u3002\n### \u522a\u9664\u9805\u76ee- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- **\u8b66\u544a** \uff1a\u522a\u9664\u9805\u76ee\u6703\u7522\u751f\u4ee5\u4e0b\u5f71\u97ff- **\u9805\u76ee\u4e2d\u7684\u6240\u6709\u5167\u5bb9\u90fd\u6703\u88ab\u522a\u9664\u3002** \u5982\u679c\u60a8\u5c07\u73fe\u6709\u9805\u76ee\u7528\u65bc\u672c\u6587\u6a94\u4e2d\u7684\u4efb\u52d9\uff0c\u5247\u522a\u9664\u8a72\u9805\u76ee\u5f8c\uff0c\u9084\u5c07\u522a\u9664\u60a8\u5df2\u5728\u8a72\u9805\u76ee\u4e2d\u5b8c\u6210\u7684\u4efb\u4f55\u5176\u4ed6\u5de5\u4f5c\u3002\n- **\u81ea\u5b9a\u7fa9\u9805\u76ee ID \u4e1f\u5931\u3002** \u5275\u5efa\u6b64\u9805\u76ee\u6642\uff0c\u60a8\u53ef\u80fd\u5275\u5efa\u4e86\u8981\u5728\u5c07\u4f86\u4f7f\u7528\u7684\u81ea\u5b9a\u7fa9\u9805\u76ee ID\u3002\u8981\u4fdd\u7559\u4f7f\u7528\u8a72\u9805\u76ee ID \u7684\u7db2\u5740\uff08\u4f8b\u5982`appspot.com`\u7db2\u5740\uff09\uff0c\u8acb\u522a\u9664\u9805\u76ee\u5167\u7684\u6240\u9078\u8cc7\u6e90\uff0c\u800c\u4e0d\u662f\u522a\u9664\u6574\u500b\u9805\u76ee\u3002\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u9032\u5165 **\u7ba1\u7406\u8cc7\u6e90** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u7ba1\u7406\u8cc7\u6e90\u201d](https://console.cloud.google.com/iam-admin/projects?hl=zh-cn) \n- \u5728\u9805\u76ee\u5217\u8868\u4e2d\uff0c\u9078\u64c7\u8981\u522a\u9664\u7684\u9805\u76ee\uff0c\u7136\u5f8c\u9ede\u64ca **\u522a\u9664** \u3002\n- \u5728\u5c0d\u8a71\u6846\u4e2d\u8f38\u5165\u9805\u76ee ID\uff0c\u7136\u5f8c\u9ede\u64ca **\u95dc\u9589** \u4ee5\u522a\u9664\u9805\u76ee\u3002### \u9010\u500b\u522a\u9664\u8cc7\u6e90\n\u9664\u4e86\u522a\u9664\u9805\u76ee\u4e4b\u5916\uff0c\u60a8\u4e5f\u53ef\u4ee5\u9010\u500b\u522a\u9664\u81ea\u5df1\u5275\u5efa\u7684\u8cc7\u6e90\u3002\n- \u522a\u9664 GKE \u4e2d\u7684\u8cc7\u6e90\uff1a```\nkubectl delete -f config/safeimage-deployment.yaml\nkubectl delete -f config/photoalbum-service.yaml\nkubectl delete -f config/thumbnail-deployment.yaml\nkubectl delete -f config/photoalbum-deployment.yaml\n```\n- \u522a\u9664 GKE \u4e2d\u7684\u96c6\u7fa3\uff1a```\ngcloud container clusters delete photoalbum-cluster --quiet\n```\n- \u5f9e Artifact Registry \u4e2d\u522a\u9664\u4ee3\u78bc\u5eab\uff1a```\ngcloud artifacts repositories delete photoalbum-repo --location us-central1 --quiet\n```\n- \u522a\u9664 Pub/Sub \u4e2d\u7684\u8a02\u95b1\u548c\u4e3b\u984c\uff1a```\ngcloud pubsub subscriptions delete safeimage-workers\ngcloud pubsub topics delete safeimage-service\ngcloud pubsub subscriptions delete thumbnail-workers\ngcloud pubsub topics delete thumbnail-service\n```\n- \u522a\u9664 Cloud SQL \u5be6\u4f8b\uff1a```\ngcloud sql instances delete photoalbum-db --quiet\n```\n- \u522a\u9664 Cloud Storage \u5b58\u5132\u5206\u5340\uff1a```\ngsutil rm -r gs://${PROJECT_ID}-photostore\ngsutil rm -r gs://${PROJECT_ID}_cloudbuild\n```\n- \u522a\u9664\u6587\u4ef6\uff1a```\ncd ..\nrm -rf gke-photoalbum-example\n```## \u5f8c\u7e8c\u6b65\u9a5f\n- \u77ad\u89e3 [DevOps](https://dora.dev/) \uff0c\u4e26\u8a73\u7d30\u77ad\u89e3\u8207\u6b64\u53c3\u8003\u67b6\u69cb\u76f8\u95dc\u7684 [\u67b6\u69cb](https://dora.dev/devops-capabilities/technical/loosely-coupled-architecture/) \u529f\u80fd\u3002\n- \u9032\u884c [DevOps \u5feb\u901f\u6aa2\u67e5](https://www.devops-research.com/quickcheck.html) \uff0c\u77ad\u89e3\u60a8\u8207\u696d\u754c\u5176\u4ed6\u516c\u53f8\u76f8\u6bd4\u6240\u8655\u7684\u4f4d\u7f6e\u3002\n- \u5982\u9700\u67e5\u770b\u66f4\u591a\u53c3\u8003\u67b6\u69cb\u3001\u5716\u8868\u548c\u6700\u4f73\u5be6\u8e10\uff0c\u8acb\u700f\u89bd [\u96f2\u67b6\u69cb\u4e2d\u5fc3](https://cloud.google.com/architecture?hl=zh-cn) \u3002", "guide": "Docs"}