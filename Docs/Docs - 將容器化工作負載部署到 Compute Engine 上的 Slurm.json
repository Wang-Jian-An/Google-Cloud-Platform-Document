{"title": "Docs - \u5c07\u5bb9\u5668\u5316\u5de5\u4f5c\u8ca0\u8f09\u90e8\u7f72\u5230 Compute Engine \u4e0a\u7684 Slurm", "url": "https://cloud.google.com/architecture/deploying-containerized-workloads-slurm-cluster-compute-engine?hl=zh-cn", "abstract": "# Docs - \u5c07\u5bb9\u5668\u5316\u5de5\u4f5c\u8ca0\u8f09\u90e8\u7f72\u5230 Compute Engine \u4e0a\u7684 Slurm\n\u672c\u6559\u7a0b\u4ecb\u7d39\u5982\u4f55\u5728\n [Compute Engine](https://cloud.google.com/compute?hl=zh-cn) \n\u4e0a\u7684\n [Slurm](https://slurm.schedmd.com/overview.html) \n\u96c6\u7fa3\u4e2d\u904b\u884c\u5bb9\u5668\u5316\u5de5\u4f5c\u8ca0\u8f09\u3002 \u672c\u6559\u7a0b\u9069\u5408\u5728 Slurm \u96c6\u7fa3\u4e2d\u904b\u884c\u5176\u5de5\u4f5c\u8ca0\u8f09\u7684\u958b\u767c\u8005\uff0c\u4e26\u5047\u8a2d\u5176\u719f\u6089\u4ee5\u4e0b\u57fa\u790e\u77e5\u8b58\uff1a\n- Slurm\n- Linux \u547d\u4ee4\u884c\u7528\u6cd5\n- [Cloud Build](https://cloud.google.com/build?hl=zh-cn) \n- \u5bb9\u5668\n [Singularity \u5bb9\u5668\u5e73\u81fa](https://sylabs.io/singularity/) \u662f\u4e00\u7a2e\u4ee5\u5bb9\u5668\u683c\u5f0f\u6253\u5305\u548c\u57f7\u884c\u9ad8\u6027\u80fd\u8a08\u7b97 (HPC) \u5de5\u4f5c\u8ca0\u8f09\u7684\u6a19\u6e96\u6a5f\u5236\u3002\u7576\u60a8\u5c07\u5de5\u4f5c\u8ca0\u8f09\u6253\u5305\u5728 Singularity \u5bb9\u5668\u4e2d\u6642\uff0c\u7ba1\u7406\u54e1\u4e0d\u5fc5\u5728\u96c6\u7fa3\u4e2d\u5b89\u88dd\u4efb\u4f55\u5176\u4ed6\u8edf\u4ef6\u3002\u60a8\u53ef\u4ee5\u5c07\u6574\u500b\u5de5\u4f5c\u6d41\u7a0b\uff08\u5305\u62ec\u8edf\u4ef6\u3001\u5eab\u548c\u6578\u64da\uff09\u653e\u5165\u5bb9\u5668\u4e2d\uff0c\u4e26\u5728 Slurm \u4f5c\u696d\u4e2d\u904b\u884c\u8a72\u6d41\u7a0b\u3002\n\u4e0b\u5716\u5c55\u793a\u77ad\u5982\u4f55\u4f7f\u7528\u57fa\u65bc Cloud Storage \u7684\u5bb9\u5668\u4ee3\u78bc\u5eab\u589e\u5f37 Slurm \u96c6\u7fa3\uff0c\u4ee5\u652f\u6301\u57f7\u884c\u6253\u5305\u7232 Singularity \u5bb9\u5668\u7684\u5de5\u4f5c\u8ca0\u8f09\u3002\u5728\u4e0a\u5716\u4e2d\uff0cSlurm \u96c6\u7fa3\u90e8\u7f72\u5728 Google Cloud \u9805\u76ee\u4e2d\uff0c\u5982\u4e0b\u6240\u793a\uff1a- Slurm \u96c6\u7fa3\u5305\u542b\u4ee5\u4e0b\u6a19\u6e96\u7d44\u4ef6\uff1a- \u4e00\u500b\u767b\u9304\u7bc0\u9ede\n- \u4e00\u500b\u63a7\u5236\u5668\u7bc0\u9ede\n- \u5171\u4eab NFS \u5b58\u5132\u7a7a\u9593\n- \u591a\u500b\u8a08\u7b97\u7bc0\u9ede\n- \u5305\u542b Singularity \u5bb9\u5668\u6620\u50cf\u7684 Cloud Storage \u5b58\u5132\u5206\u5340\u8207\u96c6\u7fa3\u76f8\u95dc\u806f\u3002\n- \u5728\u8a08\u7b97\u7bc0\u9ede\u4e0a\u57f7\u884c\u7684\u4f5c\u696d\u53ef\u4ee5\u4f7f\u7528 Singularity \u904b\u884c\u6642\u5c07\u6253\u5305\u7232\u5bb9\u5668\u7684\u5de5\u4f5c\u8ca0\u8f09\u62c9\u53d6\u81f3\u7bc0\u9ede\u57f7\u884c\u3002\n", "content": "## \u76ee\u6a19\n- \u5728 Compute Engine \u4e0a\u7684 Slurm \u96c6\u7fa3\u4e2d\u5b89\u88dd Singularity \u5bb9\u5668\u5e73\u81fa\u3002\n- \u4f7f\u7528 Cloud Build \u5275\u5efa Singularity \u5bb9\u5668\u3002\n- \u5728 Slurm \u8a08\u7b97\u7bc0\u9ede\u4e0a\u904b\u884c\u5bb9\u5668\u3002\n## \u8cbb\u7528\nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728\u672c\u6587\u6a94\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Google Cloud \u7684\u4ee5\u4e0b\u6536\u8cbb\u7d44\u4ef6\uff1a- [Compute Engine](https://cloud.google.com/compute/all-pricing?hl=zh-cn) \n- [Cloud Build](https://cloud.google.com/build/pricing?hl=zh-cn) \n\u60a8\u53ef\u4f7f\u7528 [\u50f9\u683c\u8a08\u7b97\u5668](https://cloud.google.com/products/calculator?hl=zh-cn) \u6839\u64da\u60a8\u7684\u9810\u8a08\u4f7f\u7528\u60c5\u6cc1\u4f86\u4f30\u7b97\u8cbb\u7528\u3002 \nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5b8c\u6210\u672c\u6587\u6a94\u4e2d\u63cf\u8ff0\u7684\u4efb\u52d9\u5f8c\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u522a\u9664\u6240\u5275\u5efa\u7684\u8cc7\u6e90\u4f86\u907f\u514d\u7e7c\u7e8c\u8a08\u8cbb\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u6e05\u7406](#clean-up) \u3002## \u6e96\u5099\u5de5\u4f5c- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- \u5fc5\u8981\u6642 [\u90e8\u7f72 Slurm \u96c6\u7fa3](https://cloud.google.com/hpc-toolkit/docs/quickstarts/slurm-cluster?hl=zh-cn) \u3002\u78ba\u4fdd\u60a8\u90e8\u7f72\u7684\u96c6\u7fa3\u6216\u8005\u60a8\u5728\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528\u7684\u96c6\u7fa3\u5df2\u7232\u5176\u8a08\u7b97\u7bc0\u9ede\u5553\u7528 [cloud-platform OAuth \u7bc4\u570d](https://cloud.google.com/storage/docs/authentication?hl=zh-cn#oauth-scopes) \u3002\n## \u6e96\u5099\u74b0\u5883\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u8a2d\u7f6e\u5728\u6574\u500b\u6559\u7a0b\u4e2d\u4f7f\u7528\u7684\u74b0\u5883\u8b8a\u91cf\u3002\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u6fc0\u6d3b Cloud Shell\u3002 [\u6fc0\u6d3b Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn) \n- \u5728 Cloud Shell \u4e2d\uff0c\u8a2d\u7f6e\u74b0\u5883\u8b8a\u91cf\uff1a```\nexport PROJECT_ID=\"$(gcloud config get-value core/project)\"export SINGULARITY_REPO=\"${PROJECT_ID}-singularity\"export SINGULARITY_VERSION=RELEASE_NUMBERexport JOBOUTPUT_BUCKET=\"${PROJECT_ID}-singularity-job-out\"\n```\n\u5c07 `` \u66ff\u63db\u7232\u60a8\u8981\u4f7f\u7528\u7684 Singularity \u7248\u672c\u7684\u8a9e\u7fa9\u7248\u672c\u865f\u3002\u5728\u5927\u591a\u6578\u60c5\u6cc1\u4e0b\uff0c\u6211\u5011\u5efa\u8b70\u60a8\u4f7f\u7528 [\u6700\u65b0\u7684 Singularity \u7248\u672c](https://github.com/hpcng/singularity/releases) \u3002## \u5b89\u88dd Singularity \u5bb9\u5668\u5e73\u81fa\u4ee5\u4e0b\u6b65\u9a5f\u4ecb\u7d39\u77ad\u5982\u4f55\u5728 Slurm \u96c6\u7fa3\u7684 `/apps` \u76ee\u9304\u4e2d\u5b89\u88dd Singularity\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u767b\u9304 Slurm \u96c6\u7fa3\u7684\u767b\u9304\u7bc0\u9ede\uff1a```\nexport CLUSTER_LOGIN_NODE=$(gcloud compute instances list \\\\\u00a0 --zones CLUSTER_ZONE \\\\\u00a0 --filter=\"name ~ .*login.\" \\\\\u00a0 --format=\"value(name)\" | head -n1)\\gcloud compute ssh ${CLUSTER_LOGIN_NODE} \\\\\u00a0 --zone CLUSTER_ZONE\n```\n- \u66f4\u65b0\u5df2\u5b89\u88dd\u7684\u8edf\u4ef6\u5305\u4e26\u5b89\u88dd\u5fc5\u8981\u7684\u958b\u767c\u5de5\u5177\uff1a```\nsudo yum update -y && \\\u00a0 \u00a0 \u00a0sudo yum groupinstall -y 'Development Tools' && \\\u00a0 \u00a0 \u00a0sudo yum install -y \\\u00a0 \u00a0 \u00a0openssl-devel \\\u00a0 \u00a0 \u00a0libuuid-devel \\\u00a0 \u00a0 \u00a0libseccomp-devel \\\u00a0 \u00a0 \u00a0wget \\\u00a0 \u00a0 \u00a0squashfs-tools \\\u00a0 \u00a0 \u00a0cryptsetup\n```\n- \u5b89\u88dd [Go \u7de8\u7a0b\u8a9e\u8a00](https://golang.org/dl/) \uff0c\u5c07 \u66ff\u63db\u7232\u60a8\u8981\u4f7f\u7528\u7684 Go \u7248\u672c\u7684\u7248\u672c\u865f\u3002\u5728\u5927\u591a\u6578\u60c5\u6cc1\u4e0b\uff0c\u6211\u5011\u5efa\u8b70\u60a8\u4f7f\u7528\u6700\u65b0\u7684 Go \u7248\u672c\u3002```\nexport GOLANG_VERSION=GOLANG_VERSIONexport OS=linux ARCH=amd64wget https://dl.google.com/go/go$GOLANG_VERSION.$OS-$ARCH.tar.gzsudo tar -C /usr/local -xzvf go$GOLANG_VERSION.$OS-$ARCH.tar.gzrm go$GOLANG_VERSION.$OS-$ARCH.tar.gzecho 'export GOPATH=${HOME}/go' >> ~/.bashrcecho 'export PATH=/usr/local/go/bin:${PATH}:${GOPATH}/bin' >> ~/.bashrcsource ~/.bashrc\n```\n- \u4e0b\u8f09 Singularity \u7248\u672c\uff1a```\nexport SINGULARITY_VERSION=RELEASE_NUMBERwget https://github.com/sylabs/singularity/releases/download/v${SINGULARITY_VERSION}/singularity-${SINGULARITY_VERSION}.tar.gz && \\tar -xzf singularity-${SINGULARITY_VERSION}.tar.gz && \\cd singularity\n```\n- \u5728 `/apps` \u76ee\u9304\u4e2d\u69cb\u5efa\u4e26\u5b89\u88dd Singularity\uff1a```\n./mconfig --prefix=/apps/singularity/${SINGULARITY_VERSION} && \\\u00a0 \u00a0 make -C ./builddir && \\\u00a0 \u00a0 sudo make -C ./builddir install\n```\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cSingularity \u6703\u5047\u8a2d\u5176\u914d\u7f6e\u6587\u4ef6\u4f4d\u65bc `/etc` \u76ee\u9304\u4e2d\u3002\u4e0a\u8ff0\u547d\u4ee4\u4e2d\u7684 `--prefix` \u6a19\u8a8c\u6703\u66f4\u6539\u69cb\u5efa\uff0c\u56e0\u6b64 Singularity \u6703\u5728 `/apps/singularity/` `` \u76ee\u9304\u4e2d\u67e5\u627e\u9019\u4e9b\u6587\u4ef6\u3002 `/apps` \u76ee\u9304\u5728\u6240\u6709 Slurm \u8a08\u7b97\u7bc0\u9ede\u4e0a\u90fd\u53ef\u7528\u3002\n- \u5275\u5efa Singularity \u6a21\u584a\u6587\u4ef6\uff1a```\nsudo mkdir /apps/modulefiles/singularitysudo bash -c \"cat > /apps/modulefiles/singularity/${SINGULARITY_VERSION}\" <<SINGULARITY_MODULEFILE#%Module1.0\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n##\n### modules singularity/${SINGULARITY_VERSION}.\n##\n## modulefiles/singularity/${SINGULARITY_VERSION}.\n##proc ModulesHelp { } {\u00a0 \u00a0 \u00a0 \u00a0 global version modroot\u00a0 \u00a0 \u00a0 \u00a0 puts stderr \"singularity/${SINGULARITY_VERSION} - sets the environment for Singularity ${SINGULARITY_VERSION}\"}module-whatis \u00a0 \"Sets the environment for using Singularity ${VERSION}\"# for Tcl script use onlyset \u00a0 \u00a0 topdir \u00a0 \u00a0 \u00a0 \u00a0 \u00a0/apps/singularity/${SINGULARITY_VERSION}set \u00a0 \u00a0 version \u00a0 \u00a0 \u00a0 \u00a0 ${SINGULARITY_VERSION}set \u00a0 \u00a0 sys \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 linux86prepend-path \u00a0 \u00a0PATH \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\\$topdir/binSINGULARITY_MODULEFILE\n```\n- \u9a57\u8b49 Singularity \u5b89\u88dd\uff1a```\nmodule load singularity/${SINGULARITY_VERSION}singularity\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nUsage:\n singularity [global options...] <command>\nAvailable Commands:\n build  Build a Singularity image\n cache  Manage the local cache\n capability Manage Linux capabilities for users and groups\n config  Manage various singularity configuration (root user only)\n delete  Deletes requested image from the library\n exec  Run a command within a container\n inspect  Show metadata for an image\n instance Manage containers running as services\n key   Manage OpenPGP keys\n oci   Manage OCI containers\n plugin  Manage Singularity plugins\n pull  Pull an image from a URI\n push  Upload image to the provided URI\n remote  Manage singularity remote endpoints\n run   Run the user-defined default command within a container\n run-help Show the user-defined help for an image\n search  Search a Container Library for images\n shell  Run a shell within a container\n sif   siftool is a program for Singularity Image Format (SIF) file manipulation\n sign  Attach a cryptographic signature to an image\n test  Run the user-defined tests within a container\n verify  Verify cryptographic signatures attached to an image\n version  Show the version for Singularity\nRun 'singularity --help' for more detailed usage information.\n```\n- \u6309 \u9000\u51fa Slurm \u96c6\u7fa3\u767b\u9304\u7bc0\u9ede\u3002\n## \u4f7f\u7528 Cloud Build \u69cb\u5efa\u5bb9\u5668\u4e0b\u5716\u5c55\u793a\u4e86 Singularity \u5bb9\u5668\u7684\u69cb\u5efa\u904e\u7a0b\uff1a\u5728\u4e0a\u5716\u4e2d\uff0cCloud Build \u81ea\u5b9a\u7fa9 Singularity \u69cb\u5efa\u6b65\u9a5f\u5df2\u6dfb\u52a0\u5230 Google Cloud \u9805\u76ee\u7684 Container Registry \u4e2d\u3002Singularity \u69cb\u5efa\u6b65\u9a5f\u5c31\u7dd2\u4e4b\u5f8c\uff0cCloud Build \u5c07\u5de5\u4f5c\u8ca0\u8f09\u6253\u5305\u7232\u5b58\u5132\u5728 Cloud Storage \u4e2d\u7684 Singularity \u5bb9\u5668\u6620\u50cf\u3002\n\u6309\u7167\u4ee5\u4e0b\u6b65\u9a5f\u8a2d\u7f6e\u6b64\u904e\u7a0b\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa\u4e00\u500b Dockerfile\uff0c\u7528\u65bc\u6307\u5b9a\u5b89\u88dd\u4e86 Singularity \u904b\u884c\u6642\u7684\u5bb9\u5668\uff1a```\ncat <<SINGULARITYDOCKERFILE > DockerfileFROM gcr.io/cloud-builders/go:debianARG singularity_version=${SINGULARITY_VERSION}RUN GOPATH=/go && \\\\\u00a0 \u00a0 apt-get update && \\\\\u00a0 \u00a0 apt-get install -y build-essential \\\\\u00a0 \u00a0 \u00a0 \u00a0 libssl-dev \\\\\u00a0 \u00a0 \u00a0 \u00a0 uuid-dev \\\\\u00a0 \u00a0 \u00a0 \u00a0 libgpgme11-dev \\\\\u00a0 \u00a0 \u00a0 \u00a0 squashfs-tools \\\\\u00a0 \u00a0 \u00a0 \u00a0 libseccomp-dev \\\\\u00a0 \u00a0 \u00a0 \u00a0 pkg-config wget && \\\\\u00a0 \u00a0 go get github.com/golang/dep/cmd/dep && \\\\\u00a0 \u00a0 mkdir -p \\${GOPATH}/src/github.com/sylabs && \\\\\u00a0 \u00a0 cd \\${GOPATH}/src/github.com/sylabs && \\\\\u00a0 \u00a0 wget https://github.com/sylabs/singularity/releases/download/v\\${singularity_version}/singularity-\\${singularity_version}.tar.gz && \\\\\u00a0 \u00a0 tar -xzvf singularity-\\${singularity_version}.tar.gz && \\\\\u00a0 \u00a0 cd singularity && \\\\\u00a0 \u00a0 ./mconfig -p /usr/local && \\\\\u00a0 \u00a0 make -C builddir && \\\\\u00a0 \u00a0 make -C builddir installENTRYPOINT [\"/usr/local/bin/singularity\"]SINGULARITYDOCKERFILE\n```Cloud Build \u652f\u6301\u5275\u5efa [\u81ea\u5b9a\u7fa9\u69cb\u5efa\u6b65\u9a5f](https://cloud.google.com/build/docs/create-custom-build-steps?hl=zh-cn) \u3002\u904b\u884c\u4e0a\u8ff0\u547d\u4ee4\u6642\uff0c\u81ea\u5b9a\u7fa9\u69cb\u5efa\u6b65\u9a5f\u5c07\u6253\u5305\u7232 Docker \u5bb9\u5668\u3002\n- \u901a\u904e\u5275\u5efa\u69cb\u5efa\u914d\u7f6e\u6587\u4ef6\u4f86\u5b9a\u7fa9\u81ea\u5b9a\u7fa9\u69cb\u5efa\u6b65\u9a5f\uff1a```\ncat <<SINGULARITYBUILDER > singularitybuilder.yamlsteps:- name: 'gcr.io/cloud-builders/docker'\u00a0 args: ['build', '--build-arg', 'singularity_version=\\${_SINGULARITY_VERSION}', '-t', 'gcr.io/${PROJECT_ID}/singularity-\\${_SINGULARITY_VERSION}', '.']images: ['gcr.io/${PROJECT_ID}/singularity-\\${_SINGULARITY_VERSION}']SINGULARITYBUILDER\n```\u4e0a\u8ff0\u547d\u4ee4\u6703\u5275\u5efa\u4e00\u500b [\u69cb\u5efa\u914d\u7f6e](https://cloud.google.com/build/docs/configuring-builds/create-basic-configuration?hl=zh-cn) \u6587\u4ef6\uff0cCloud Build \u7528\u5b83\u4f86\u69cb\u5efa Singularity \u69cb\u5efa\u6b65\u9a5f\u5bb9\u5668\u6620\u50cf\u4e26\u5c07\u5176\u63a8\u9001\u5230\u9805\u76ee\u7684 `gcr.io` \u5bb9\u5668\u8a3b\u518a\u8868\u3002\n- \u4f7f\u7528 Cloud Build \u5275\u5efa Singularity \u69cb\u5efa\u6b65\u9a5f\uff1a```\ngcloud builds submit \\\u00a0 --config=singularitybuilder.yaml \\\u00a0 --substitutions=_SINGULARITY_VERSION=${SINGULARITY_VERSION}\n```\n- \u5b9a\u7fa9 Singularity \u5bb9\u5668\uff1a```\ncat << CONTAINERDEF > oceananigans.defBootstrap: dockerFrom: julia:1.4%environment\u00a0 \u00a0 export JULIA_DEPOT_PATH=:/opt/julia\u00a0 \u00a0 export GKSwstype=100%runscript\u00a0 \u00a0 julia /usr/local/src/two_dimensional_turbulence.jl%files\u00a0 \u00a0 Oceananigans.jl/examples/two_dimensional_turbulence.jl /usr/local/src%post\u00a0 \u00a0 export JULIA_DEPOT_PATH=/opt/julia\u00a0 \u00a0 export PATH=/usr/local/julia/bin:$PATH\u00a0 \u00a0 julia -e 'using Pkg; Pkg.add(\"Oceananigans\"); Pkg.add(\"Plots\"); Pkg.add(\"Statistics\"); using Oceananigans, Plots, Statistics;'\u00a0 \u00a0 chmod -R 645 /opt/juliaCONTAINERDEF\n``` [Singularity \u5b9a\u7fa9\u6587\u4ef6](https://sylabs.io/guides/3.8/user-guide/definition_files.html) \u662f\u7528\u65bc\u69cb\u5efa Singularity \u5bb9\u5668\u6620\u50cf\u7684\u914d\u65b9\u3002\u6b64\u547d\u4ee4\u5275\u5efa\u7684 `workload.def` \u6587\u4ef6\u4ee5 [Juila](https://julialang.org/) 1.4 Docker \u5bb9\u5668\u6620\u50cf\u958b\u982d\uff0c\u4e26\u5c07\u5176\u8f49\u63db\u7232 Singularity \u6620\u50cf\u683c\u5f0f\u3002\u7136\u5f8c\uff0cSingularity \u69cb\u5efa\u6a5f\u5236\u6703\u5c07 `two_dimensional_turbulence.jl` \u793a\u4f8b\u4ee3\u78bc\u8907\u88fd\u5230\u6620\u50cf\u4e2d\uff0c\u6700\u5f8c\u52a0\u8f09\u5176\u4ed6 Julia \u8edf\u4ef6\u5305\u3002\u57f7\u884c\u5bb9\u5668\u6642\uff0c\u5b83\u4f7f\u7528 Julia \u904b\u884c\u6642\u4f86\u904b\u884c\u793a\u4f8b\u4ee3\u78bc\u3002\n- \u7232\u5bb9\u5668\u6620\u50cf\u5275\u5efa Cloud Storage \u5b58\u5132\u5206\u5340\uff1a```\ngsutil mb gs://${SINGULARITY_REPO}\n```\n- \u5275\u5efa\u5bb9\u5668\u69cb\u5efa\u898f\u7bc4\uff1a```\ncat <<CONTAINERBUILDER > containerbuilder.yamlsteps:- name: gcr.io/cloud-builders/git\u00a0 args: ['clone', 'https://github.com/CliMA/Oceananigans.jl']- name: gcr.io/$PROJECT_ID/singularity-\\${_SINGULARITY_VERSION}\u00a0 args: ['build', 'oceananigans.sif', 'oceananigans.def']artifacts:\u00a0 objects:\u00a0 \u00a0 location: 'gs://${SINGULARITY_REPO}'\u00a0 \u00a0 paths: ['oceananigans.sif']CONTAINERBUILDER\n```\u4e0a\u8ff0\u547d\u4ee4\u6703\u5275\u5efa\u4e00\u500b Cloud Build \u69cb\u5efa\u914d\u7f6e\u6587\u4ef6\uff0c\u4ee5\u6307\u5b9a\u4ee5\u4e0b\u6b65\u9a5f\uff1a- \u7b2c\u4e00\u6b65\u662f\u514b\u9686 [Oceananines.jl](https://github.com/CliMA/Oceananigans.jl) \u4ee3\u78bc\u5eab\uff0c\u5176\u4e2d\u5305\u542b Singularity \u5bb9\u5668\u5c07\u904b\u884c\u7684\u793a\u4f8b\u4ee3\u78bc\u3002\n- \u7b2c\u4e8c\u6b65\u4f7f\u7528\u60a8\u7232\u69cb\u5efa\u5bb9\u5668\u800c\u5275\u5efa\u7684 Singularity \u81ea\u5b9a\u7fa9\u69cb\u5efa\u6b65\u9a5f\u3002\u5bb9\u5668\u6620\u50cf\u5c07\u4fdd\u5b58\u5230`gs://${SINGULARITY_REPO}`Cloud Storage \u5b58\u5132\u5206\u5340\u4e2d\u3002\n- \u69cb\u5efa\u5bb9\u5668\u3002```\ngcloud builds submit --config=containerbuilder.yaml --substitutions=_SINGULARITY_VERSION=${SINGULARITY_VERSION} --timeout 45m\n```\n- \u9a57\u8b49\u5bb9\u5668\u69cb\u5efa\uff1a```\ngsutil ls gs://${SINGULARITY_REPO}\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\ngs://SINGULARITY_REPO/oceanagins.sif\n```\n- \u6388\u4e88\u5c0d\u5bb9\u5668\u7684\u8b80\u53d6\u6b0a\u9650\uff0c\u4ee5\u4fbf Slurm \u4f5c\u696d\u53ef\u4ee5\u62c9\u53d6\u5bb9\u5668\u6620\u50cf\uff1a```\ngsutil acl ch -g All:R gs://${SINGULARITY_REPO}/oceananigans.sif\n```\n## \u5728 Slurm \u4f5c\u696d\u4e2d\u4f7f\u7528\u5bb9\u5668\u672c\u90e8\u5206\u4ecb\u7d39\u5982\u4f55\u904b\u884c\u4f7f\u7528\u60a8\u5728\u4e0a\u4e00\u90e8\u5206\u4e2d\u5275\u5efa\u7684 Singularity \u5bb9\u5668\u7684 Slurm \u4f5c\u696d\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa\u4e00\u500b\u904b\u884c\u5bb9\u5668\u5316\u5de5\u4f5c\u8ca0\u8f09\u7684\u8173\u672c\uff1a```\ncat <<EXAMPLESCRIPT > workload.sh#!/usr/bin/env bashset -xcb=\\${1} \u00a0 # container bucketob=\\${2} \u00a0 # output bucket# create a temporary directory so that multiple jobs on the same# don't interfere with one anothertmpdir=\\$(mktemp -d)cd \\${tmpdir}# generates a file named: 2d_turbulence_vorticity.mp4singularity run \\${cb}/oceananigans.sif# append a random string to make the file name uniquers=\\$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 16 | head -n 1)mp4=\"\\${ob}/2d_turbulence_vorticity_\\${rs}.mp4\"\u00a0 # write the output file to the output bucket with the unique name\u00a0 # and make it readablegsutil cp ./2d_turbulence_vorticity.mp4 \\${mp4}gsutil acl ch -g All:R \\${mp4}# clean up and exitrm 2d_turbulence_vorticity.mp4cdrm -rf \\${tmpdir}exit 0EXAMPLESCRIPT\n```\u60a8\u901a\u904e\u4e0a\u8ff0\u547d\u4ee4\u5275\u5efa\u7684 `workload.sh` \u8173\u672c\u6703\u4f7f\u7528 Singularity \u904b\u884c\u6642\u4f86\u57f7\u884c Oceananigans \u5bb9\u5668\u3002\u57f7\u884c\u7d50\u679c\u662f\u4e00\u6bb5 6 \u79d2\u7684\u5f71\u7247\uff0c\u5176\u4e2d\u986f\u793a\u4e8c\u7dad\u96a8\u6a5f\u901f\u5ea6\u5834\u7684\u7c98\u6eef\u6df7\u4e82\u8870\u6e1b\u3002\u7cfb\u7d71\u751f\u6210\u4e00\u500b\u5305\u542b\u5f71\u7247\u7684 `.mp4` \u6587\u4ef6\u5f8c\uff0c\u5de5\u4f5c\u8ca0\u8f09\u8173\u672c\u6703\u7232\u5176\u63d0\u4f9b\u4e00\u500b\u552f\u4e00\u540d\u7a31\uff0c\u4e26\u5c07\u5176\u8907\u88fd\u5230 `${JOBOUTPUT_BUCKET}` Cloud Storage \u5b58\u5132\u5206\u5340\u3002\n- \u5275\u5efa\u5c07\u5de5\u4f5c\u8ca0\u8f09\u4f5c\u7232\u4e26\u884c\u4f5c\u696d\u904b\u884c\u7684\u8173\u672c\uff1a```\ncat <<JOBSCRIPT > job.sh#!/usr/bin/env bashmodule load singularity/${SINGULARITY_VERSION}srun ./workload.sh \\${1} \\${2}module unload singularity/${SINGULARITY_VERSION}exit 0JOBSCRIPT\n```\u4e0a\u8ff0\u547d\u4ee4\u6703\u5275\u5efa\u4e00\u500b `job.sh` \u8173\u672c\uff0c\u8a72\u8173\u672c\u4f7f\u7528 Slurm [srun](https://slurm.schedmd.com/srun.html) \u547d\u4ee4\u5c07\u5de5\u4f5c\u8ca0\u8f09\u8173\u672c\u4f5c\u7232 Slurm \u96c6\u7fa3\u4e0a\u5b89\u6392\u7684\u4e26\u884c\u4f5c\u696d\u57f7\u884c\u3002\n- \u5c07\u8173\u672c\u9077\u79fb\u5230\u96c6\u7fa3\u767b\u9304\u7bc0\u9ede\uff1a```\nexport CLUSTER_LOGINNODE=\"$(gcloud compute instances list --filter=\"name ~ .*login.\" --format=\"value(name)\")\"gcloud compute scp job.sh workload.sh ${CLUSTER_LOGINNODE}:~gcloud compute ssh ${CLUSTER_LOGINNODE} --command \"chmod a+x ~/workload.sh\"\n```\n- \u7232\u5bb9\u5668\u4f5c\u696d\u7684\u8f38\u51fa\u5275\u5efa\u4e00\u500b\u516c\u5171 Cloud Storage \u5b58\u5132\u5206\u5340\uff1a```\ngsutil mb gs://${JOBOUTPUT_BUCKET}gsutil acl ch -g All:W gs://${JOBOUTPUT_BUCKET}\n```\n- \u5b89\u6392\u4f5c\u696d\uff1a```\ngcloud compute ssh ${CLUSTER_LOGINNODE} \\--command \"sbatch -N1 --mem-per-cpu=2G -t00:10:00 \\./job.sh https://storage.googleapis.com/${SINGULARITY_REPO} \\gs://${JOBOUTPUT_BUCKET}\"\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff0c\u5176\u4e2d \u662f\u5df2\u5b89\u6392\u4f5c\u696d\u7684 Slurm \u8b58\u5225\u865f\uff1a```\nSubmitted batch job JOB_ID\n```\n- \u67e5\u770b\u4f5c\u696d\u7684\u9032\u5ea6\uff1a```\n```shwatch -n60 gcloud compute ssh ${CLUSTER_LOGINNODE} --command \"squeue\"```\n```\u7b49\u5f85 \u5f9e\u968a\u5217\u4e2d\u6d88\u5931\uff0c\u7136\u5f8c\u6309 \u9000\u51fa `watch` \u547d\u4ee4\u3002\n- \u6aa2\u67e5\u4f5c\u696d\u7684\u7d50\u679c\uff1a```\ngsutil ls -l gs://${JOBOUTPUT_BUCKET}\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\n 642907 2020-05-01T18:33:46Z gs://JOBOUTPUT_BUCKET/2d_turbulence_vorticity_47FqamVUPHzVcaRf.mp4\n 640056 2020-05-01T16:42:47Z gs://JOBOUTPUT_BUCKET/2d_turbulence_vorticity_4cdm6V65MBPJVhGw.mp4\n```\u8981\u67e5\u770b\u5de5\u4f5c\u8ca0\u8f09\u5275\u5efa\u7684\u52d5\u756b\uff0c\u8acb\u5c07\u700f\u89bd\u5668\u5b9a\u5411\u5230\u4ee5\u4e0b\u64cd\u4f5c\u8fd4\u56de\u7684\u7db2\u5740\uff1a```\ngsutil ls gs://${JOBOUTPUT_BUCKET} | head -n 1 | sed 's|gs\\:/|https\\://storage.googleapis.com|'\n```\n## \u6e05\u9664\u6578\u64da\n### \u522a\u9664\u9805\u76ee\n\u7232\u4e86\u907f\u514d\u7522\u751f\u8cbb\u7528\uff0c\u6700\u7c21\u55ae\u7684\u65b9\u6cd5\u662f\u522a\u9664\u60a8\u7232\u672c\u6559\u7a0b\u5275\u5efa\u7684\u9805\u76ee\u3002\n\u5982\u9700\u522a\u9664\u9805\u76ee\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- **\u8b66\u544a** \uff1a\u522a\u9664\u9805\u76ee\u6703\u7522\u751f\u4ee5\u4e0b\u5f71\u97ff- **\u9805\u76ee\u4e2d\u7684\u6240\u6709\u5167\u5bb9\u90fd\u6703\u88ab\u522a\u9664\u3002** \u5982\u679c\u60a8\u5c07\u73fe\u6709\u9805\u76ee\u7528\u65bc\u672c\u6587\u6a94\u4e2d\u7684\u4efb\u52d9\uff0c\u5247\u522a\u9664\u8a72\u9805\u76ee\u5f8c\uff0c\u9084\u5c07\u522a\u9664\u60a8\u5df2\u5728\u8a72\u9805\u76ee\u4e2d\u5b8c\u6210\u7684\u4efb\u4f55\u5176\u4ed6\u5de5\u4f5c\u3002\n- **\u81ea\u5b9a\u7fa9\u9805\u76ee ID \u4e1f\u5931\u3002** \u5275\u5efa\u6b64\u9805\u76ee\u6642\uff0c\u60a8\u53ef\u80fd\u5275\u5efa\u4e86\u8981\u5728\u5c07\u4f86\u4f7f\u7528\u7684\u81ea\u5b9a\u7fa9\u9805\u76ee ID\u3002\u8981\u4fdd\u7559\u4f7f\u7528\u8a72\u9805\u76ee ID \u7684\u7db2\u5740\uff08\u4f8b\u5982`appspot.com`\u7db2\u5740\uff09\uff0c\u8acb\u522a\u9664\u9805\u76ee\u5167\u7684\u6240\u9078\u8cc7\u6e90\uff0c\u800c\u4e0d\u662f\u522a\u9664\u6574\u500b\u9805\u76ee\u3002\n\u5982\u679c\u60a8\u6253\u7b97\u63a2\u7d22\u591a\u500b\u67b6\u69cb\u3001\u6559\u7a0b\u6216\u5feb\u901f\u5165\u9580\uff0c\u5247\u91cd\u8907\u4f7f\u7528\u9805\u76ee\u53ef\u4ee5\u5e6b\u52a9\u60a8\u907f\u514d\u8d85\u51fa\u9805\u76ee\u914d\u984d\u9650\u5236\u3002\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u9032\u5165 **\u7ba1\u7406\u8cc7\u6e90** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u7ba1\u7406\u8cc7\u6e90\u201d](https://console.cloud.google.com/iam-admin/projects?hl=zh-cn) \n- \u5728\u9805\u76ee\u5217\u8868\u4e2d\uff0c\u9078\u64c7\u8981\u522a\u9664\u7684\u9805\u76ee\uff0c\u7136\u5f8c\u9ede\u64ca **\u522a\u9664** \u3002\n- \u5728\u5c0d\u8a71\u6846\u4e2d\u8f38\u5165\u9805\u76ee ID\uff0c\u7136\u5f8c\u9ede\u64ca **\u95dc\u9589** \u4ee5\u522a\u9664\u9805\u76ee\u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u77ad\u89e3 [\u5728 Compute Engine \u4e0a\u904b\u884c\u7dca\u5bc6\u8026\u5408\u7684 HPC \u61c9\u7528\u7684\u6700\u4f73\u505a\u6cd5](https://cloud.google.com/solutions/best-practices-for-using-mpi-on-compute-engine?hl=zh-cn) \u3002\n- \u63a2\u7d22\u6709\u95dc Google Cloud \u7684\u53c3\u8003\u67b6\u69cb\u3001\u5716\u8868\u548c\u6700\u4f73\u5be6\u8e10\u3002\u67e5\u770b\u6211\u5011\u7684 [Cloud Architecture Center](https://cloud.google.com/architecture?hl=zh-cn) \u3002", "guide": "Docs"}