{"title": "Docs - \u7232\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u8a2d\u7f6e CI/CD \u6d41\u6c34\u7dda", "url": "https://cloud.google.com/architecture/cicd-pipeline-for-data-processing?hl=zh-cn", "abstract": "# Docs - \u7232\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u8a2d\u7f6e CI/CD \u6d41\u6c34\u7dda\nLast reviewed 2023-04-20 UTC\n\u672c\u6559\u7a0b\u4ecb\u7d39\u5982\u4f55\u8a2d\u7f6e\u6301\u7e8c\u96c6\u6210/\u6301\u7e8c\u90e8\u7f72 (CI/CD) \u6d41\u6c34\u7dda\uff0c\u4ee5\u901a\u904e\u5728 Google Cloud \u4e0a\u4f7f\u7528\u4ee3\u7ba1\u5f0f\u7522\u54c1\u5be6\u73fe CI/CD \u65b9\u6cd5\u4f86\u8655\u7406\u6578\u64da\u3002\u6578\u64da\u79d1\u5b78\u5bb6\u548c\u5206\u6790\u5e2b\u53ef\u4ee5\u8abf\u6574\u5f9e CI/CD \u5be6\u8e10\u4e2d\u7e3d\u7d50\u51fa\u4f86\u7684\u65b9\u6cd5\uff0c\u5e6b\u52a9\u78ba\u4fdd\u6578\u64da\u6d41\u7a0b\u548c\u5de5\u4f5c\u6d41\u7684\u9ad8\u8cea\u91cf\u3001\u53ef\u7dad\u8b77\u6027\u548c\u9069\u61c9\u6027\u3002\u60a8\u53ef\u4ee5\u904b\u7528\u4ee5\u4e0b\u65b9\u6cd5\uff1a- \u6e90\u4ee3\u78bc\u7684\u7248\u672c\u63a7\u5236\u3002\n- \u81ea\u52d5\u69cb\u5efa\u3001\u6e2c\u8a66\u548c\u90e8\u7f72\u61c9\u7528\u3002\n- \u8207\u751f\u7522\u74b0\u5883\u5206\u958b\u4e14\u9694\u96e2\u3002\n- \u53ef\u8907\u88fd\u7684\u74b0\u5883\u8a2d\u7f6e\u7a0b\u5e8f\u3002\n\u672c\u6559\u7a0b\u9069\u7528\u65bc\u64d4\u4efb\u4e0b\u5217\u5de5\u4f5c\u7684\u6578\u64da\u79d1\u5b78\u5bb6\u548c\u5206\u6790\u5e2b\uff1a\u69cb\u5efa\u91cd\u8907\u904b\u884c\u7684\u6578\u64da\u8655\u7406\u4f5c\u696d\u4ee5\u5e6b\u52a9\u4ed6\u5011\u69cb\u5efa\u7cfb\u7d71\u6027\u4e14\u81ea\u52d5\u7dad\u8b77\u6578\u64da\u8655\u7406\u5de5\u4f5c\u8ca0\u8f09\u7684\u7814\u767c (R&D)\u3002", "content": "## \u90e8\u7f72\u67b6\u69cb\u5728\u672c\u6307\u5357\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528\u4ee5\u4e0b Google Cloud \u7522\u54c1\uff1a- [Cloud Build](https://cloud.google.com/build?hl=zh-cn) \uff0c\u5275\u5efa CI/CD \u6d41\u6c34\u7dda\uff0c\u7528\u65bc\u69cb\u5efa\u3001\u90e8\u7f72\u548c\u6e2c\u8a66\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u4ee5\u53ca\u6578\u64da\u8655\u7406\u672c\u8eab\u3002 Cloud Build \u662f\u4e00\u9805\u4ee3\u7ba1\u5f0f\u670d\u52d9\uff0c\u53ef\u5728 Google Cloud \u4e0a\u904b\u884c\u69cb\u5efa\u3002\u69cb\u5efa\u662f\u6307\u4e00\u7cfb\u5217\u69cb\u5efa\u6b65\u9a5f\uff0c\u5176\u4e2d\u6bcf\u500b\u6b65\u9a5f\u90fd\u5728 Docker \u5bb9\u5668\u4e2d\u904b\u884c\u3002\n- [Cloud Composer](https://cloud.google.com/composer?hl=zh-cn) \uff0c\u5b9a\u7fa9\u548c\u904b\u884c\u5de5\u4f5c\u6d41\u6b65\u9a5f\uff0c\u4f8b\u5982\u5553\u52d5\u6578\u64da\u8655\u7406\u3001\u6e2c\u8a66\u548c\u9a57\u8b49\u7d50\u679c\u3002Cloud Composer \u662f\u4e00\u9805\u4ee3\u7ba1\u5f0f [Apache Airflow](https://airflow.apache.org/) \u670d\u52d9\uff0c\u63d0\u4f9b\u74b0\u5883\u4f9b\u60a8\u5275\u5efa\u3001\u8abf\u5ea6\u3001\u76e3\u63a7\u548c\u7ba1\u7406\u8907\u96dc\u5de5\u4f5c\u6d41\uff0c\u4f8b\u5982\u672c\u6559\u7a0b\u4e2d\u7684\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u3002\n- [Dataflow](https://cloud.google.com/dataflow?hl=zh-cn) \uff1a\u7528\u65bc\u5c07 Apache Beam [WordCount](https://beam.apache.org/get-started/wordcount-example/#wordcount-example) \u793a\u4f8b\u4f5c\u7232\u793a\u4f8b\u6578\u64da\u6d41\u7a0b\u904b\u884c\u3002\n### CI/CD \u6d41\u6c34\u7dda\u6982\u62ec\u4f86\u8b1b\uff0cCI/CD \u6d41\u6c34\u7dda\u5305\u542b\u4ee5\u4e0b\u6b65\u9a5f\uff1a- Cloud Build \u4f7f\u7528 [Maven \u69cb\u5efa\u5668](https://github.com/GoogleCloudPlatform/cloud-builders/tree/master/mvn) \u5c07 WordCount \u793a\u4f8b\u6253\u5305\u9032\u81ea\u904b\u884c\u7684 Java \u6b78\u6a94 (JAR) \u6587\u4ef6\u4e2d\u3002 Maven Builder \u662f\u5b89\u88dd\u6709 Maven \u7684\u5bb9\u5668\u3002\u7576\u69cb\u5efa\u6b65\u9a5f\u914d\u7f6e\u7232\u4f7f\u7528 Maven \u69cb\u5efa\u5668\u6642\uff0cMaven \u6703\u904b\u884c\u9019\u4e9b\u4efb\u52d9\u3002\n- Cloud Build \u6703\u5c07 JAR \u6587\u4ef6\u4e0a\u50b3\u5230 Cloud Storage\u3002\n- Cloud Build \u5c0d\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u4ee3\u78bc\u904b\u884c\u55ae\u5143\u6e2c\u8a66\uff0c\u4e26\u5c07\u5de5\u4f5c\u6d41\u4ee3\u78bc\u90e8\u7f72\u5230 Cloud Composer\u3002\n- Cloud Composer \u9078\u53d6 JAR \u6587\u4ef6\u4e26\u5728 Dataflow \u4e0a\u904b\u884c\u6578\u64da\u8655\u7406\u4f5c\u696d\u3002\n\u4e0b\u5716\u986f\u793a\u4e86 CI/CD \u6d41\u6c34\u7dda\u6b65\u9a5f\u7684\u8a73\u7d30\u8996\u5716\u3002\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u6e2c\u8a66\u74b0\u5883\u548c\u751f\u7522\u74b0\u5883\u7684\u90e8\u7f72\u5206\u7232\u5169\u500b\u4e0d\u540c\u7684 Cloud Build \u6d41\u6c34\u7dda - \u6e2c\u8a66\u6d41\u6c34\u7dda\u548c\u751f\u7522\u6d41\u6c34\u7dda\u3002\n\u5728\u4e0a\u5716\u4e2d\uff0c\u6e2c\u8a66\u6d41\u6c34\u7dda\u5305\u542b\u4ee5\u4e0b\u6b65\u9a5f\uff1a- \u958b\u767c\u8005\u5c0d Cloud Source Repositories \u4ee3\u78bc\u5eab\u7684\u4ee3\u78bc\u9032\u884c\u66f4\u6539\u3002\n- \u4ee3\u78bc\u66f4\u6539\u89f8\u767c Cloud Build \u4e2d\u7684\u6e2c\u8a66\u69cb\u5efa\u3002\n- Cloud Build \u69cb\u5efa\u81ea\u52d5\u57f7\u884c JAR \u6587\u4ef6\uff0c\u4e26\u5c07\u5176\u90e8\u7f72\u5230 Cloud Storage \u4e0a\u7684\u6e2c\u8a66 JAR \u5b58\u5132\u5206\u5340\u3002\n- Cloud Build \u5c07\u6e2c\u8a66\u6587\u4ef6\u90e8\u7f72\u5230 Cloud Storage \u4e0a\u7684\u6e2c\u8a66\u6587\u4ef6\u5b58\u5132\u5206\u5340\u3002\n- Cloud Build \u5728 Cloud Composer \u4e2d\u8a2d\u7f6e\u8b8a\u91cf\uff0c\u4ee5\u5f15\u7528\u65b0\u90e8\u7f72\u7684 JAR \u6587\u4ef6\u3002\n- Cloud Build \u6e2c\u8a66\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41 [\u6709\u5411\u7121\u74b0\u5716](https://airflow.apache.org/concepts.html) (DAG)\uff0c\u4e26\u5c07\u5176\u90e8\u7f72\u5230 Cloud Storage \u4e0a\u7684 Cloud Composer \u5b58\u5132\u5206\u5340\u3002\n- \u6b64\u6642\u5de5\u4f5c\u6d41 DAG \u6587\u4ef6\u5df2\u90e8\u7f72\u5230 Cloud Composer\u3002\n- Cloud Build \u89f8\u767c\u65b0\u90e8\u7f72\u7684\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u958b\u59cb\u904b\u884c\u3002\n- \u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u96c6\u6210\u6e2c\u8a66\u901a\u904e\u5f8c\uff0c\u6d88\u606f\u6703\u767c\u5e03\u5230 Pub/Sub\uff0c\u8a72\u6d88\u606f\u5305\u542b\u5c0d\u6d88\u606f\u6578\u64da\u5b57\u6bb5\u4e2d\u6700\u65b0\u81ea\u52d5\u57f7\u884c JAR\uff08\u5f9e Airflow \u8b8a\u91cf\u4e2d\u7372\u53d6\uff09\u7684\u5f15\u7528\u3002\n\u5728\u4e0a\u5716\u4e2d\uff0c\u751f\u7522\u6d41\u6c34\u7dda\u5305\u542b\u4ee5\u4e0b\u6b65\u9a5f\uff1a- \u7576\u6d88\u606f\u767c\u4f48\u5230 Pub/Sub \u4e3b\u984c\u6642\uff0c\u7cfb\u7d71\u6703\u89f8\u767c\u751f\u7522\u90e8\u7f72\u6d41\u6c34\u7dda\u3002\n- \u958b\u767c\u8005\u624b\u52d5\u6279\u51c6\u751f\u7522\u90e8\u7f72\u6d41\u6c34\u7dda\uff0c\u69cb\u5efa\u904b\u884c\u3002\n- Cloud Build \u5c07\u6700\u65b0\u7684\u81ea\u52d5\u57f7\u884c JAR \u6587\u4ef6\u5f9e\u6e2c\u8a66 JAR \u5b58\u5132\u5206\u5340\u8907\u88fd\u5230 Cloud Storage \u4e0a\u7684\u751f\u7522 JAR \u5b58\u5132\u5206\u5340\u3002\n- Cloud Build \u6e2c\u8a66\u751f\u7522\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41 DAG \u4e26\u5c07\u5176\u90e8\u7f72\u5230 Cloud Storage \u4e0a\u7684 Cloud Composer \u5b58\u5132\u5206\u5340\u3002\n- \u6b64\u6642\u751f\u7522\u5de5\u4f5c\u6d41 DAG \u6587\u4ef6\u5df2\u90e8\u7f72\u5230 Cloud Composer\u3002\n\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u751f\u7522\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u90e8\u7f72\u5230\u8207\u6e2c\u8a66\u5de5\u4f5c\u6d41\u76f8\u540c\u7684 Cloud Composer \u74b0\u5883\u4e2d\uff0c\u4ee5\u5c31\u6240\u6709\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u63d0\u4f9b\u7d71\u4e00\u8996\u5716\u3002\u7232\u4e86\u9054\u5230\u672c\u6559\u7a0b\u7684\u76ee\u7684\uff0c\u6211\u5011\u4f7f\u7528\u4e0d\u540c\u7684 Cloud Storage \u5206\u5340\u4f86\u4fdd\u5b58\u8f38\u5165\u548c\u8f38\u51fa\u6578\u64da\uff0c\u5f9e\u800c\u5206\u96e2\u74b0\u5883\u3002\n\u7232\u4e86\u5b8c\u5168\u5206\u96e2\u74b0\u5883\uff0c\u60a8\u9700\u8981\u5728\u4e0d\u540c\u9805\u76ee\u4e2d\u5275\u5efa\u591a\u500b Cloud Composer \u74b0\u5883\uff0c\u9019\u4e9b\u74b0\u5883\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\u5f7c\u6b64\u5206\u96e2\u3002\u9019\u7a2e\u5206\u96e2\u6709\u52a9\u65bc\u4fdd\u8b77\u60a8\u7684\u751f\u7522\u74b0\u5883\u3002\u6b64\u65b9\u6cd5\u4e0d\u5728\u672c\u6559\u7a0b\u63a2\u8a0e\u7bc4\u570d\u4e4b\u5167\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u8a2a\u554f\u591a\u500b Google Cloud \u9805\u76ee\u4e2d\u7684\u8cc7\u6e90\uff0c\u8acb\u53c3\u95b1 [\u8a2d\u7f6e\u670d\u52d9\u5e33\u865f\u6b0a\u9650](https://cloud.google.com/build/docs/securing-builds/set-service-account-permissions?hl=zh-cn) \u3002\n### \u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u5982\u9700\u77ad\u89e3 Cloud Composer \u5982\u4f55\u904b\u884c\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\uff0c\u8acb\u53c3\u95b1\u7528 Python \u7de8\u5beb\u7684 [\u6709\u5411\u7121\u74b0\u5716](https://airflow.apache.org/concepts.html) (DAG)\u3002\u5728 DAG \u4e2d\uff0c\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u7684\u6240\u6709\u6b65\u9a5f\u90fd\u901a\u904e\u5b83\u5011\u4e4b\u9593\u7684\u4f9d\u8cf4\u95dc\u4fc2\u4e00\u8d77\u5b9a\u7fa9\u3002\nCI/CD \u6d41\u6c34\u7dda\u6703\u5728\u6bcf\u500b\u69cb\u5efa\u4e2d\u81ea\u52d5\u5c07 DAG \u5b9a\u7fa9\u5f9e Cloud Source Repositories \u4ee3\u78bc\u5eab\u90e8\u7f72\u5230 Cloud Composer\u3002\u6b64\u6d41\u7a0b\u53ef\u78ba\u4fdd Cloud Composer \u59cb\u7d42\u8207\u6700\u65b0\u7684\u5de5\u4f5c\u6d41\u5b9a\u7fa9\u4fdd\u6301\u540c\u6b65\uff0c\u7121\u9700\u4efb\u4f55\u4eba\u5de5\u5e72\u9810\u3002\n\u6e2c\u8a66\u74b0\u5883\u7684 DAG \u5b9a\u7fa9\u9664\u4e86\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u4e4b\u5916\uff0c\u9084\u5b9a\u7fa9\u4e86\u7aef\u5230\u7aef\u6e2c\u8a66\u6b65\u9a5f\u3002\u6e2c\u8a66\u6b65\u9a5f\u6709\u52a9\u65bc\u78ba\u4fdd\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u6b63\u78ba\u904b\u884c\u3002\n\u4e0b\u5716\u5c55\u793a\u4e86\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u3002\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u5305\u62ec\u4ee5\u4e0b\u6b65\u9a5f\uff1a- \u5728 Dataflow \u4e2d\u904b\u884c WordCount \u6578\u64da\u6d41\u7a0b\u3002\n- \u5f9e WordCount \u6d41\u7a0b\u4e2d\u4e0b\u8f09\u8f38\u51fa\u6587\u4ef6\u3002WordCount \u6d41\u7a0b\u8f38\u51fa\u4e09\u500b\u6587\u4ef6\uff1a- `download_result_1`\n- `download_result_2`\n- `download_result_3`\n- \u4e0b\u8f09\u540d\u7232 `download_ref_string` \u7684\u53c3\u8003\u6587\u4ef6\u3002\n- \u6839\u64da\u53c3\u8003\u6587\u4ef6\u9a57\u8b49\u7d50\u679c\u3002\u6b64\u96c6\u6210\u6e2c\u8a66\u5f59\u7e3d\u6240\u6709\u4e09\u4efd\u7d50\u679c\uff0c\u4e26\u5c07\u5f59\u7e3d\u7684\u7d50\u679c\u8207\u53c3\u8003\u6587\u4ef6\u9032\u884c\u6bd4\u8f03\u3002\n- \u96c6\u6210\u6e2c\u8a66\u901a\u904e\u5f8c\uff0c\u5c07\u6d88\u606f\u767c\u4f48\u5230 Pub/Sub\u3002\n\u4f7f\u7528 Cloud Composer \u7b49\u4efb\u52d9\u7de8\u6392\u6846\u67b6\u4f86\u7ba1\u7406\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\uff0c\u9019\u6709\u52a9\u65bc\u7de9\u89e3\u5de5\u4f5c\u6d41\u7684\u4ee3\u78bc\u8907\u96dc\u6027\u3002\n### \u6e2c\u8a66\u9664\u4e86\u9a57\u8b49\u7aef\u5230\u7aef\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u7684\u96c6\u6210\u6e2c\u8a66\u4e4b\u5916\uff0c\u672c\u6559\u7a0b\u9084\u5305\u542b\u5169\u500b\u55ae\u5143\u6e2c\u8a66\u3002\u5206\u5225\u662f\u6578\u64da\u8655\u7406\u4ee3\u78bc\u81ea\u52d5\u6e2c\u8a66\u548c\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u4ee3\u78bc\u81ea\u52d5\u6e2c\u8a66\u3002\u6578\u64da\u8655\u7406\u4ee3\u78bc\u6e2c\u8a66\u4f7f\u7528 Java \u7de8\u5beb\uff0c\u5728 Maven \u69cb\u5efa\u904e\u7a0b\u4e2d\u81ea\u52d5\u904b\u884c\u3002\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u4ee3\u78bc\u6e2c\u8a66\u4f7f\u7528 Python \u7de8\u5beb\uff0c\u4f5c\u7232\u7368\u7acb\u7684\u69cb\u5efa\u6b65\u9a5f\u904b\u884c\u3002## \u76ee\u6a19\n- \u914d\u7f6e Cloud Composer \u74b0\u5883\u3002\n- \u7232\u60a8\u7684\u6578\u64da\u5275\u5efa Cloud Storage \u5b58\u5132\u5206\u5340\u3002\n- \u5275\u5efa\u69cb\u5efa\u3001\u6e2c\u8a66\u548c\u751f\u7522\u6d41\u6c34\u7dda\u3002\n- \u914d\u7f6e\u69cb\u5efa\u89f8\u767c\u5668\u3002\n## \u8cbb\u7528\nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728\u672c\u6587\u6a94\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Google Cloud \u7684\u4ee5\u4e0b\u6536\u8cbb\u7d44\u4ef6\uff1a- [Cloud Source Repositories](https://cloud.google.com/source-repositories/pricing?hl=zh-cn) \n- [Cloud Build](https://cloud.google.com/build/pricing?hl=zh-cn) \n- [Cloud Composer](https://cloud.google.com/composer/pricing?hl=zh-cn) \n- [Dataflow](https://cloud.google.com/dataflow/pricing?hl=zh-cn) \n- [Cloud Storage](https://cloud.google.com/storage/pricing?hl=zh-cn) \n\u60a8\u53ef\u4f7f\u7528 [\u50f9\u683c\u8a08\u7b97\u5668](https://cloud.google.com/products/calculator?hl=zh-cn) \u6839\u64da\u60a8\u7684\u9810\u8a08\u4f7f\u7528\u60c5\u6cc1\u4f86\u4f30\u7b97\u8cbb\u7528\u3002 \nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5b8c\u6210\u672c\u6587\u6a94\u4e2d\u63cf\u8ff0\u7684\u4efb\u52d9\u5f8c\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u522a\u9664\u6240\u5275\u5efa\u7684\u8cc7\u6e90\u4f86\u907f\u514d\u7e7c\u7e8c\u8a08\u8cbb\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u6e05\u7406](#clean-up) \u3002## \u6e96\u5099\u5de5\u4f5c\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them## \u793a\u4f8b\u4ee3\u78bc\u793a\u4f8b\u4ee3\u78bc\u4f4d\u65bc\u4ee5\u4e0b\u5169\u500b\u6587\u4ef6\u593e\u4e2d\uff1a- `env-setup`\u6587\u4ef6\u593e\u5305\u542b\u7528\u65bc\u521d\u59cb\u8a2d\u7f6e Google Cloud \u74b0\u5883\u7684 Shell \u8173\u672c\u3002\n- `source-code` \u6587\u4ef6\u593e\u5305\u542b\u96a8\u6642\u9593\u63a8\u79fb\u800c\u958b\u767c\u7684\u4ee3\u78bc\uff0c\u9700\u8981\u7531\u6e90\u4ee3\u78bc\u63a7\u5236\uff0c\u53ef\u89f8\u767c\u81ea\u52d5\u7de8\u8b6f\u548c\u6e2c\u8a66\u6d41\u7a0b\u3002\u6b64\u6587\u4ef6\u593e\u5305\u542b\u4ee5\u4e0b\u5b50\u6587\u4ef6\u593e\uff1a- `data-processing-code`\u6587\u4ef6\u593e\u5305\u542b Apache Beam \u6d41\u7a0b\u6e90\u4ee3\u78bc\u3002\n- `workflow-dag`\u6587\u4ef6\u593e\u5305\u542b\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u7684 Composer DAG \u5b9a\u7fa9\uff0c\u4ee5\u53ca\u8a2d\u8a08\u3001\u5be6\u65bd\u548c\u6e2c\u8a66 Dataflow \u6d41\u7a0b\u7684\u6b65\u9a5f\u3002\n- `build-pipeline`\u6587\u4ef6\u593e\u5305\u542b\u5169\u500b Cloud Build \u914d\u7f6e\uff1a\u4e00\u500b\u7528\u65bc\u6e2c\u8a66\u6d41\u6c34\u7dda\uff0c\u53e6\u4e00\u500b\u7528\u65bc\u751f\u7522\u6d41\u6c34\u7dda\u3002\u6b64\u6587\u4ef6\u593e\u9084\u5305\u542b\u6d41\u6c34\u7dda\u7684\u652f\u6301\u8173\u672c\u3002\n\u7232\u4e86\u5be6\u73fe\u672c\u6559\u7a0b\u7684\u76ee\u7684\uff0c\u6578\u64da\u8655\u7406\u548c DAG \u5de5\u4f5c\u6d41\u7684\u6e90\u4ee3\u78bc\u6587\u4ef6\u4f4d\u65bc\u540c\u4e00\u6e90\u4ee3\u78bc\u5b58\u5132\u5eab\u4e2d\u7684\u4e0d\u540c\u6587\u4ef6\u593e\u4e2d\u3002 \u5728\u751f\u7522\u74b0\u5883\u4e2d\uff0c\u6e90\u4ee3\u78bc\u6587\u4ef6\u901a\u5e38\u4f4d\u65bc\u81ea\u5df1\u7684\u6e90\u4ee3\u78bc\u5b58\u5132\u5eab\u4e2d\uff0c\u7531\u4e0d\u540c\u7684\u5718\u968a\u7ba1\u7406\u3002## \u8a2d\u7f6e\u60a8\u7684\u74b0\u5883\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u5728 [Cloud Shell](https://cloud.google.com/shell/docs/features?hl=zh-cn) \u4e2d\u904b\u884c\u547d\u4ee4\u3002 Cloud Shell \u986f\u793a\u7232 Google Cloud Console \u5e95\u90e8\u7684\u4e00\u500b\u7a97\u53e3\u3002- \u5728 Google Cloud Console \u4e2d\uff0c\u6253\u958b Cloud Shell\uff1a [\u6253\u958b Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn) \n- \u514b\u9686\u793a\u4f8b\u4ee3\u78bc\u5eab\uff1a```\ngit clone https://github.com/GoogleCloudPlatform/ci-cd-for-data-processing-workflow.git\n```\n- \u904b\u884c\u8173\u672c\u4ee5\u8a2d\u7f6e\u74b0\u5883\u8b8a\u91cf\uff1a```\ncd ~/ci-cd-for-data-processing-workflow/env-setupsource set_env.sh\n```\u8a72\u8173\u672c\u8a2d\u7f6e\u4ee5\u4e0b\u74b0\u5883\u8b8a\u91cf\uff1a- \u60a8\u7684 Google Cloud \u9805\u76ee ID\n- \u60a8\u7684\u5730\u5340\u548c\u5340\u57df\n- \u69cb\u5efa\u6d41\u6c34\u7dda\u548c\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u4f7f\u7528\u7684 Cloud Storage \u5b58\u5132\u5206\u5340\u7684\u540d\u7a31\u3002\n\u7531\u65bc\u6703\u8a71\u4e4b\u9593\u4e0d\u4fdd\u7559\u74b0\u5883\u8b8a\u91cf\uff0c\u60a8\u5b8c\u6210\u672c\u6559\u7a0b\u6642\uff0c\u5982\u679c\u60a8\u7684 Cloud Shell \u6703\u8a71\u95dc\u9589\u6216\u65b7\u958b\u9023\u63a5\uff0c\u5247\u9700\u8981\u91cd\u7f6e\u74b0\u5883\u8b8a\u91cf\u3002\n## \u5275\u5efa Cloud Composer \u74b0\u5883\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u8a2d\u7f6e\u4e00\u500b Cloud Composer \u74b0\u5883\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u5c07 **Cloud Composer v2 API Service Agent Extension** ( `roles/composer.ServiceAgentV2Ext` ) \u89d2\u8272\u6dfb\u52a0\u5230 Cloud Composer Service Agent \u5e33\u865f\uff1a```\ngcloud projects add-iam-policy-binding $GCP_PROJECT_ID \\\u00a0 \u00a0 --member serviceAccount:service-$PROJECT_NUMBER@cloudcomposer-accounts.iam.gserviceaccount.com \\\u00a0 \u00a0 --role roles/composer.ServiceAgentV2Ext\n```\n- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa Cloud Composer \u74b0\u5883\uff1a```\ngcloud composer environments create $COMPOSER_ENV_NAME \\\u00a0 \u00a0 --location $COMPOSER_REGION \\\u00a0 \u00a0 --image-version composer-2.0.14-airflow-2.2.5\n``` **\u6ce8\u610f** \uff1a\u9810\u914d Cloud Composer \u74b0\u5883\u901a\u5e38\u9700\u8981\u7d04 15 \u5206\u9418\uff0c\u4f46\u6700\u591a\u53ef\u80fd\u9700\u8981\u4e00\u500b\u5c0f\u6642\u3002\u7b49\u5230\u6b64\u904e\u7a0b\u5b8c\u6210\u5f8c\u518d\u7e7c\u7e8c\u57f7\u884c\u4e0b\u4e00\u6b65\u3002\n- \u904b\u884c\u8173\u672c\u4ee5\u5728 Cloud Composer \u74b0\u5883\u4e2d\u8a2d\u7f6e\u8b8a\u91cf\u3002\u6578\u64da\u8655\u7406 DAG \u9700\u8981\u8b8a\u91cf\u3002```\ncd ~/ci-cd-for-data-processing-workflow/env-setupchmod +x set_composer_variables.sh./set_composer_variables.sh\n```\u8a72\u8173\u672c\u8a2d\u7f6e\u4ee5\u4e0b\u74b0\u5883\u8b8a\u91cf\uff1a- \u60a8\u7684 Google Cloud \u9805\u76ee ID\n- \u60a8\u7684\u5730\u5340\u548c\u5340\u57df\n- \u69cb\u5efa\u6d41\u6c34\u7dda\u548c\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u4f7f\u7528\u7684 Cloud Storage \u5b58\u5132\u5206\u5340\u7684\u540d\u7a31\u3002\n### \u63d0\u53d6 Cloud Composer \u74b0\u5883\u5c6c\u6027Cloud Composer \u4f7f\u7528 Cloud Storage \u5b58\u5132\u5206\u5340\u4f86\u5b58\u5132 DAG\u3002 \u5c07 DAG \u5b9a\u7fa9\u6587\u4ef6\u79fb\u52d5\u5230\u8a72\u5b58\u5132\u5206\u5340\u6703\u89f8\u767c Cloud Composer \u81ea\u52d5\u8b80\u53d6\u6587\u4ef6\u3002\u60a8\u5728\u5275\u5efa Cloud Composer \u74b0\u5883\u6642\u7232 Cloud Composer \u5275\u5efa\u4e86 Cloud Storage \u5b58\u5132\u5206\u5340\u3002 \u5728\u4ee5\u4e0b\u7a0b\u5e8f\u4e2d\uff0c\u60a8\u5c07\u63d0\u53d6\u5b58\u5132\u5206\u5340\u7684\u7db2\u5740\uff0c\u7136\u5f8c\u914d\u7f6e CI/CD \u6d41\u6c34\u7dda\u4ee5\u81ea\u52d5\u5c07 DAG \u5b9a\u7fa9\u90e8\u7f72\u5230 Cloud Storage \u5b58\u5132\u5206\u5340\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u5c07\u5b58\u5132\u5206\u5340\u7684\u7db2\u5740\u5c0e\u51fa\u7232\u74b0\u5883\u8b8a\u91cf\uff1a```\nexport COMPOSER_DAG_BUCKET=$(gcloud composer environments describe $COMPOSER_ENV_NAME \\\u00a0 \u00a0 --location $COMPOSER_REGION \\\u00a0 \u00a0 --format=\"get(config.dagGcsPrefix)\")\n```\n- \u5c0e\u51fa Cloud Composer \u4f7f\u7528\u7684\u670d\u52d9\u5e33\u865f\u7684\u540d\u7a31\uff0c\u4ee5\u4fbf\u8a2a\u554f Cloud Storage \u5b58\u5132\u5206\u5340\uff1a```\nexport COMPOSER_SERVICE_ACCOUNT=$(gcloud composer environments describe $COMPOSER_ENV_NAME \\\u00a0 \u00a0 --location $COMPOSER_REGION \\\u00a0 \u00a0 --format=\"get(config.nodeConfig.serviceAccount)\")\n```\n## \u5275\u5efa Cloud Storage \u5b58\u5132\u5206\u5340\u5728\u672c\u7bc0\u4e2d\uff0c\u60a8\u5c07\u5275\u5efa\u4e00\u7d44 Cloud Storage \u5b58\u5132\u5206\u5340\u4ee5\u5b58\u5132\u4ee5\u4e0b\u5167\u5bb9\uff1a- \u69cb\u5efa\u904e\u7a0b\u7684\u4e2d\u9593\u6b65\u9a5f\u7684\u5de5\u4ef6\u3002\n- \u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u7684\u8f38\u5165\u548c\u8f38\u51fa\u6587\u4ef6\u3002\n- Dataflow \u4f5c\u696d\u5b58\u5132\u5176\u4e8c\u9032\u5236\u6587\u4ef6\u7684\u66ab\u5b58\u4f4d\u7f6e\u3002\n\u5982\u9700\u5275\u5efa Cloud Storage \u5206\u5340\uff0c\u8acb\u5b8c\u6210\u4ee5\u4e0b\u6b65\u9a5f\uff1a- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa Cloud Storage \u5b58\u5132\u5206\u5340\u4e26\u6388\u4e88 Cloud Composer \u670d\u52d9\u5e33\u865f\u904b\u884c\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u7684\u6b0a\u9650\uff1a```\ncd ~/ci-cd-for-data-processing-workflow/env-setupchmod +x create_buckets.sh./create_buckets.sh\n```\n## \u5275\u5efa Pub/Sub \u4e3b\u984c\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u5275\u5efa\u4e00\u500b Pub/Sub \u4e3b\u984c\uff0c\u7528\u65bc\u63a5\u6536\u5f9e\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u96c6\u6210\u6e2c\u8a66\u767c\u9001\u7684\u6d88\u606f\uff0c\u4ee5\u81ea\u52d5\u89f8\u767c\u751f\u7522\u69cb\u5efa\u6d41\u6c34\u7dda\u3002- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u9032\u5165 **Pub/Sub \u4e3b\u984c** \u9801\u9762\u3002 [\u9032\u5165\u201c\u4e3b\u984c\u201d\u9801\u9762](https://console.cloud.google.com/cloudpubsub/topic/list?hl=zh-cn) \n- \u9ede\u64ca **\u5275\u5efa\u4e3b\u984c** \u3002\n- \u5982\u9700\u914d\u7f6e\u4e3b\u984c\uff0c\u8acb\u5b8c\u6210\u4ee5\u4e0b\u6b65\u9a5f\uff1a- \u5c0d\u65bc **\u4e3b\u984c ID** \uff0c\u8f38\u5165`integration-test-complete-topic`\u3002\n- \u78ba\u8a8d **\u6dfb\u52a0\u9ed8\u8a8d\u8a02\u95b1** \u9078\u9805\u8655\u65bc\u9078\u4e2d\u72c0\u614b\u3002\n- \u5c07\u5176\u9918\u9078\u9805\u4fdd\u7559\u672a\u9078\u4e2d\u72c0\u614b\u3002\n- \u5c0d\u65bc **\u52a0\u5bc6** \uff0c\u9078\u64c7 **Google \u7ba1\u7406\u7684\u52a0\u5bc6\u5bc6\u9470** \u3002\n- \u9ede\u64ca **\u5275\u5efa\u4e3b\u984c** \u3002\n \n## \u5c07\u6e90\u4ee3\u78bc\u63a8\u9001\u5230 Cloud Source Repositories \u4ee3\u78bc\u5eab\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u9700\u8981\u5c07\u4e00\u500b\u6e90\u4ee3\u78bc\u5eab\u6dfb\u52a0\u5230\u7248\u672c\u63a7\u5236\u4e2d\u3002\u4e0b\u5217\u6b65\u9a5f\u5c55\u793a\u4e86\u4ee3\u78bc\u5eab\u662f\u5982\u4f55\u958b\u767c\u4e26\u96a8\u6642\u9593\u767c\u751f\u8b8a\u5316\u7684\u3002\u6bcf\u7576\u5c07\u66f4\u6539\u63a8\u9001\u5230\u5b58\u5132\u5eab\u6642\uff0c\u7cfb\u7d71\u90fd\u6703\u89f8\u767c\u6d41\u6c34\u7dda\u7684\u69cb\u5efa\u3001\u90e8\u7f72\u548c\u6e2c\u8a66\u904e\u7a0b\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u5c07 `source-code` \u6587\u4ef6\u593e\u63a8\u9001\u5230 Cloud Source Repositories\uff1a```\ngcloud source repos create $SOURCE_CODE_REPOcp -r ~/ci-cd-for-data-processing-workflow/source-code ~/$SOURCE_CODE_REPOcd ~/$SOURCE_CODE_REPOgit initgit remote add google \\\u00a0 \u00a0 https://source.developers.google.com/p/$GCP_PROJECT_ID/r/$SOURCE_CODE_REPOgit add .git commit -m 'initial commit'git push google master\n```\u9019\u4e9b\u662f\u5728\u65b0\u76ee\u9304\u4e2d\u521d\u59cb\u5316 Git \u4e26\u5c07\u5167\u5bb9\u63a8\u9001\u5230\u9060\u7a0b\u4ee3\u78bc\u5eab\u7684\u6a19\u6e96\u547d\u4ee4\u3002\n## \u5275\u5efa Cloud Build \u6d41\u6c34\u7dda\u5728\u672c\u7bc0\u4e2d\uff0c\u60a8\u5c07\u5275\u5efa\u7528\u65bc\u69cb\u5efa\u3001\u90e8\u7f72\u548c\u6e2c\u8a66\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u7684\u69cb\u5efa\u6d41\u6c34\u7dda\u3002\n### \u6388\u4e88\u5c0d Cloud Build \u670d\u52d9\u5e33\u865f\u7684\u8a2a\u554f\u6b0a\u9650Cloud Build \u6703\u90e8\u7f72 Cloud Composer DAG \u4e26\u89f8\u767c\u5de5\u4f5c\u6d41\uff0c\u9019\u4e9b\u5de5\u4f5c\u6d41\u6703\u5728\u60a8\u5411 Cloud Build \u670d\u52d9\u5e33\u865f\u6dfb\u52a0\u5176\u4ed6\u8a2a\u554f\u6b0a\u9650\u6642\u5553\u7528\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u4f7f\u7528 Cloud Composer \u6642\u53ef\u7528\u7684\u4e0d\u540c\u89d2\u8272\uff0c\u8acb\u53c3\u95b1 [\u8a2a\u554f\u63a7\u5236\u6587\u6a94](https://cloud.google.com/composer/docs/how-to/access-control?hl=zh-cn#roles) \u3002- \u5728 Cloud Shell \u4e2d\uff0c\u7232 Cloud Build \u670d\u52d9\u5e33\u865f\u6dfb\u52a0 `composer.admin` \u89d2\u8272\uff0c\u4f7f Cloud Build \u4f5c\u696d\u53ef\u4ee5\u5728 Cloud Composer \u4e2d\u8a2d\u7f6e Airflow \u8b8a\u91cf\uff1a```\ngcloud projects add-iam-policy-binding $GCP_PROJECT_ID \\\u00a0 \u00a0 --member=serviceAccount:$PROJECT_NUMBER@cloudbuild.gserviceaccount.com \\\u00a0 \u00a0 --role=roles/composer.admin\n```\n- \u7232 Cloud Build \u670d\u52d9\u5e33\u865f\u6dfb\u52a0 `composer.worker` \u89d2\u8272\uff0c\u4f7f Cloud Build \u4f5c\u696d\u53ef\u4ee5\u89f8\u767c Cloud Composer \u4e2d\u7684\u6578\u64da\u5de5\u4f5c\u6d41\uff1a```\ngcloud projects add-iam-policy-binding $GCP_PROJECT_ID \\\u00a0 \u00a0 --member=serviceAccount:$PROJECT_NUMBER@cloudbuild.gserviceaccount.com \\\u00a0 \u00a0 --role=roles/composer.worker\n```\n### \u5275\u5efa\u69cb\u5efa\u548c\u6e2c\u8a66\u6d41\u6c34\u7dda\u69cb\u5efa\u548c\u6e2c\u8a66\u6d41\u6c34\u7dda\u6b65\u9a5f\u5728 [YAML \u914d\u7f6e\u6587\u4ef6](https://cloud.google.com/build/docs/configuring-builds/create-basic-configuration?hl=zh-cn) \u4e2d\u914d\u7f6e\u3002 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u7232 `git` \u3001 `maven` \u3001 `gsutil` \u548c `gcloud` \u4f7f\u7528\u9810\u69cb\u5efa\u7684 [\u69cb\u5efa\u5668\u6620\u50cf](https://cloud.google.com/build/docs/cloud-builders?hl=zh-cn) \uff0c\u4ee5\u5728\u6bcf\u500b\u69cb\u5efa\u6b65\u9a5f\u4e2d\u904b\u884c\u4efb\u52d9\u3002 \u60a8\u53ef\u4ee5\u4f7f\u7528\u914d\u7f6e\u8b8a\u91cf [\u66ff\u4ee3\u5167\u5bb9](https://cloud.google.com/build/docs/build-config?hl=zh-cn#substitutions) \u4f86\u5b9a\u7fa9\u69cb\u5efa\u6642\u7684\u74b0\u5883\u8a2d\u7f6e\u3002\u6e90\u4ee3\u78bc\u5b58\u5132\u5eab\u4f4d\u7f6e\u7531\u8b8a\u91cf\u66ff\u4ee3\u5167\u5bb9\u4ee5\u53ca Cloud Storage \u5b58\u5132\u5206\u5340\u7684\u4f4d\u7f6e\u5b9a\u7fa9\u3002\u69cb\u5efa\u6642\uff0c\u6709\u4e86\u6b64\u4fe1\u606f\u624d\u80fd\u90e8\u7f72 JAR \u6587\u4ef6\u3001\u6e2c\u8a66\u6587\u4ef6\u548c DAG \u5b9a\u7fa9\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u63d0\u4ea4\u69cb\u5efa\u6d41\u6c34\u7dda\u914d\u7f6e\u6587\u4ef6\u4ee5\u5728 Cloud Build \u4e2d\u5275\u5efa\u6d41\u6c34\u7dda\uff1a```\ncd ~/ci-cd-for-data-processing-workflow/source-code/build-pipelinegcloud builds submit --config=build_deploy_test.yaml --substitutions=\\REPO_NAME=$SOURCE_CODE_REPO,\\_DATAFLOW_JAR_BUCKET=$DATAFLOW_JAR_BUCKET_TEST,\\_COMPOSER_INPUT_BUCKET=$INPUT_BUCKET_TEST,\\_COMPOSER_REF_BUCKET=$REF_BUCKET_TEST,\\_COMPOSER_DAG_BUCKET=$COMPOSER_DAG_BUCKET,\\_COMPOSER_ENV_NAME=$COMPOSER_ENV_NAME,\\_COMPOSER_REGION=$COMPOSER_REGION,\\_COMPOSER_DAG_NAME_TEST=$COMPOSER_DAG_NAME_TEST\n```\u6b64\u547d\u4ee4\u6307\u793a Cloud Build \u901a\u904e\u4ee5\u4e0b\u6b65\u9a5f\u904b\u884c\u69cb\u5efa\uff1a- \u69cb\u5efa\u4e26\u90e8\u7f72 WordCount \u81ea\u52d5\u57f7\u884c JAR \u6587\u4ef6\u3002- \u67e5\u770b\u6e90\u4ee3\u78bc\u3002\n- \u5c07 WordCount Beam \u6e90\u4ee3\u78bc\u7de8\u8b6f\u7232\u81ea\u52d5\u57f7\u884c JAR \u6587\u4ef6\u3002\n- \u5c07 JAR \u6587\u4ef6\u5b58\u5132\u5728 Cloud Storage \u4e2d\uff0cCloud Composer \u53ef\u4ee5\u5f9e\u4e2d\u9078\u53d6\u8a72\u6587\u4ef6\u4ee5\u904b\u884c WordCount \u8655\u7406\u4f5c\u696d\u3002\n- \u5728 Cloud Composer \u4e0a\u90e8\u7f72\u548c\u8a2d\u7f6e\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u3002- \u5c0d\u5de5\u4f5c\u6d41 DAG \u4f7f\u7528\u7684\u81ea\u5b9a\u7fa9\u64cd\u4f5c\u7b26\u4ee3\u78bc\u904b\u884c\u55ae\u5143\u6e2c\u8a66\u3002\n- \u5728 Cloud Storage \u4e0a\u90e8\u7f72\u6e2c\u8a66\u8f38\u5165\u6587\u4ef6\u548c\u6e2c\u8a66\u53c3\u8003\u6587\u4ef6\u3002\u6e2c\u8a66\u8f38\u5165\u6587\u4ef6\u662f WordCount \u8655\u7406\u4f5c\u696d\u7684\u8f38\u5165\u3002\u4f7f\u7528\u6e2c\u8a66\u53c3\u8003\u6587\u4ef6\u4f5c\u7232\u53c3\u8003\uff0c\u4ee5\u9a57\u8b49 WordCount \u8655\u7406\u4f5c\u696d\u7684\u8f38\u51fa\u3002\n- \u5c07 Cloud Composer \u8b8a\u91cf\u8a2d\u7f6e\u7232\u6307\u5411\u65b0\u69cb\u5efa\u7684 JAR \u6587\u4ef6\u3002\n- \u5c07\u5de5\u4f5c\u6d41 DAG \u5b9a\u7fa9\u90e8\u7f72\u5230 Cloud Composer \u74b0\u5883\u3002\n- \u5728\u6e2c\u8a66\u74b0\u5883\u4e2d\u904b\u884c\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u4ee5\u89f8\u767c\u6e2c\u8a66\u8655\u7406\u5de5\u4f5c\u6d41\u3002\n### \u9a57\u8b49\u69cb\u5efa\u548c\u6e2c\u8a66\u6d41\u6c34\u7dda\u63d0\u4ea4\u69cb\u5efa\u6587\u4ef6\u5f8c\uff0c\u8acb\u9a57\u8b49\u69cb\u5efa\u6b65\u9a5f\u3002- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u8f49\u5230 **\u69cb\u5efa\u8a18\u9304** \u9801\u9762\u4ee5\u67e5\u770b\u904e\u53bb\u548c\u7576\u524d\u6b63\u5728\u904b\u884c\u7684\u6240\u6709\u69cb\u5efa\u7684\u5217\u8868\u3002 [\u8f49\u5230\u201c\u69cb\u5efa\u8a18\u9304\u201d\u9801\u9762](https://console.cloud.google.com/cloud-build?hl=zh-cn) \n- \u9ede\u64ca\u7576\u524d\u6b63\u5728\u904b\u884c\u7684\u69cb\u5efa\u3002\n- \u5728 **\u69cb\u5efa\u8a73\u60c5** \u9801\u9762\u4e0a\uff0c\u9a57\u8b49\u69cb\u5efa\u6b65\u9a5f\u662f\u5426\u8207\u4e0a\u8ff0\u6b65\u9a5f\u76f8\u7b26\u3002 \u69cb\u5efa\u7d50\u675f\u6642\uff0c **\u69cb\u5efa\u8a73\u60c5** \u9801\u9762\u4e0a\u7684\u69cb\u5efa **\u72c0\u614b** \u5b57\u6bb5\u6703\u986f\u793a `Build successful` \u3002\n- \u5728 Cloud Shell \u4e2d\uff0c\u9a57\u8b49 WordCount \u793a\u4f8b JAR \u6587\u4ef6\u662f\u5426\u5df2\u8907\u88fd\u5230\u6b63\u78ba\u7684\u5b58\u5132\u5206\u5340\uff1a```\ngsutil ls gs://$DATAFLOW_JAR_BUCKET_TEST/dataflow_deployment*.jar\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\ngs://\u2026-composer-dataflow-source-test/dataflow_deployment_e88be61e-50a6-4aa0-beac-38d75871757e.jar\n```\n- \u7372\u53d6\u60a8\u7684 Cloud Composer \u7db2\u9801\u754c\u9762\u7684\u7db2\u5740\u3002\u8acb\u8a18\u4e0b\u8a72\u7db2\u5740\uff0c\u56e0\u7232\u4e0b\u4e00\u6b65\u9700\u8981\u4f7f\u7528\u5b83\u3002```\ngcloud composer environments describe $COMPOSER_ENV_NAME \\\u00a0 \u00a0 --location $COMPOSER_REGION \\\u00a0 \u00a0 --format=\"get(config.airflowUri)\"\n```\n- \u4f7f\u7528\u4e0a\u4e00\u6b65\u7372\u53d6\u7684\u7db2\u5740\u8f49\u5230 Cloud Composer \u754c\u9762\uff0c\u9a57\u8b49 DAG \u662f\u5426\u6210\u529f\u904b\u884c\u3002\u5982\u679c **\u904b\u884c** \u5217\u672a\u986f\u793a\u4efb\u4f55\u4fe1\u606f\uff0c\u8acb\u7b49\u5f85\u5e7e\u5206\u9418\u4e26\u91cd\u65b0\u52a0\u8f09\u9801\u9762\u3002- \u5982\u9700\u9a57\u8b49\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41 DAG `test_word_count` \u662f\u5426\u5df2\u90e8\u7f72\u4e14\u8655\u65bc\u904b\u884c\u6a21\u5f0f\uff0c\u8acb\u5c07\u6307\u91dd\u61f8\u505c\u5728 **\u904b\u884c** \u4e0b\u65b9\u7684\u6dfa\u7da0\u8272\u5713\u5708\u4e0a\uff0c\u4e26\u9a57\u8b49\u5b83\u662f\u5426\u986f\u793a **\u6b63\u5728\u904b\u884c** \u3002 \n- \u5982\u8981\u4ee5\u5716\u5f62\u65b9\u5f0f\u67e5\u770b\u6b63\u5728\u904b\u884c\u7684\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\uff0c\u8acb\u9ede\u64ca\u6dfa\u7da0\u8272\u5713\u5708\uff0c\u7136\u5f8c\u9ede\u64ca **DAG \u904b\u884c** \u9801\u9762\u4e0a\u7684 **Dag Id\uff1atest_word_count** \u3002\n- \u91cd\u65b0\u52a0\u8f09 **\u5716\u8868\u8996\u5716** \u9801\u9762\u4ee5\u66f4\u65b0\u7576\u524d DAG \u904b\u884c\u7684\u72c0\u614b\u3002\u5de5\u4f5c\u6d41\u901a\u5e38\u9700\u8981\u4e09\u5230\u4e94\u5206\u9418\u624d\u80fd\u5b8c\u6210\u3002\u5982\u9700\u9a57\u8b49 DAG \u904b\u884c\u662f\u5426\u6210\u529f\u5b8c\u6210\uff0c\u8acb\u5c07\u6307\u91dd\u653e\u5728\u6bcf\u500b\u4efb\u52d9\u4e0a\uff0c\u4ee5\u9a57\u8b49\u63d0\u793a\u662f\u5426\u986f\u793a **\u72c0\u614b\uff1a\u6210\u529f** \u3002\u5012\u6578\u7b2c\u4e8c\u500b\u4efb\u52d9\u540d\u7232 `do_comparison` \uff0c\u662f\u7528\u65bc\u6839\u64da\u53c3\u8003\u6587\u4ef6\u9a57\u8b49\u6d41\u7a0b\u8f38\u51fa\u7684\u96c6\u6210\u6e2c\u8a66\u3002\n- \u96c6\u6210\u6e2c\u8a66\u5b8c\u6210\u5f8c\uff0c\u6700\u5f8c\u4e00\u500b\u4efb\u52d9\uff08\u540d\u7232 `publish_test_complete` \uff09\u6703\u5c07\u6d88\u606f\u767c\u4f48\u5230 `integration-test-complete-topic` Pub/Sub \u4e3b\u984c\uff0c\u4ee5\u7528\u65bc\u89f8\u767c\u751f\u7522\u69cb\u5efa\u6d41\u6c34\u7dda\u3002- \u5982\u9700\u9a57\u8b49\u5df2\u767c\u4f48\u7684\u6d88\u606f\u662f\u5426\u5305\u542b\u5c0d\u6700\u65b0 JAR \u6587\u4ef6\u7684\u6b63\u78ba\u5f15\u7528\uff0c\u6211\u5011\u53ef\u4ee5\u5f9e\u9ed8\u8a8d\u7684 `integration-test-complete-topic-sub` Pub/Sub \u8a02\u95b1\u62c9\u53d6\u8a72\u6d88\u606f\u3002\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u9032\u5165 **\u8a02\u95b1** \u9801\u9762\u3002 [\u9032\u5165\u201c\u8a02\u95b1\u201d\u9801\u9762](https://console.cloud.google.com/cloudpubsub/subscription/list?hl=zh-cn) \n- \u9ede\u64ca **integration-test-complete-topic-sub** \uff0c\u9078\u64c7 **\u6d88\u606f** \u6a19\u7c64\u9801\uff0c\u7136\u5f8c\u9ede\u64ca **\u62c9\u53d6** \n- \u8f38\u51fa\u61c9\u985e\u4f3c\u5982\u4e0b\u6240\u793a\uff1a \n### \u5275\u5efa\u751f\u7522\u6d41\u6c34\u7dda\u7576\u6e2c\u8a66\u8655\u7406\u5de5\u4f5c\u6d41\u6210\u529f\u904b\u884c\u6642\uff0c\u60a8\u53ef\u4ee5\u5c07\u7576\u524d\u7248\u672c\u7684\u5de5\u4f5c\u6d41\u63d0\u5347\u81f3\u751f\u7522\u74b0\u5883\u3002\u76ee\u524d\u6709\u4ee5\u4e0b\u5e7e\u7a2e\u65b9\u6cd5\u53ef\u4ee5\u5c07\u5de5\u4f5c\u6d41\u90e8\u7f72\u5230\u751f\u7522\u74b0\u5883\uff1a- \u624b\u52d5\u3002\n- \u5728\u6e2c\u8a66\u6216\u66ab\u5b58\u74b0\u5883\u4e2d\u901a\u904e\u6240\u6709\u6e2c\u8a66\u6642\u81ea\u52d5\u89f8\u767c\u3002\n- \u7531\u9810\u5b9a\u4f5c\u696d\u81ea\u52d5\u89f8\u767c\u3002\n\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u7576\u6e2c\u8a66\u74b0\u5883\u4e2d\u6240\u6709\u6e2c\u8a66\u90fd\u901a\u904e\u6642\uff0c\u7cfb\u7d71\u6703\u81ea\u52d5\u89f8\u767c\u751f\u7522\u69cb\u5efa\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u81ea\u52d5\u5316\u65b9\u6cd5\uff0c\u8acb\u53c3\u95b1 [\u767c\u4f48\u5de5\u7a0b](https://landing.google.com/sre/sre-book/chapters/release-engineering/?hl=zh-cn) \u3002\n\u5728\u5be6\u73fe\u81ea\u52d5\u5316\u65b9\u6cd5\u4e4b\u524d\uff0c\u60a8\u9700\u8981\u624b\u52d5\u90e8\u7f72\u5230\u751f\u7522\u74b0\u5883\uff0c\u4ee5\u9a57\u8b49\u751f\u7522\u90e8\u7f72\u69cb\u5efa\u3002\u751f\u7522\u90e8\u7f72\u69cb\u5efa\u9075\u5faa\u4ee5\u4e0b\u6b65\u9a5f\uff1a- \u5c07 WordCount JAR \u6587\u4ef6\u5f9e\u6e2c\u8a66\u5b58\u5132\u5206\u5340\u8907\u88fd\u5230\u751f\u7522\u5b58\u5132\u5206\u5340\u3002\n- \u5c07\u751f\u7522\u5de5\u4f5c\u6d41\u7684 Cloud Composer \u8b8a\u91cf\u8a2d\u7f6e\u7232\u6307\u5411\u65b0\u63d0\u5347\u7684 JAR \u6587\u4ef6\u3002\n- \u5728 Cloud Composer \u74b0\u5883\u4e2d\u90e8\u7f72\u751f\u7522\u5de5\u4f5c\u6d41 DAG \u5b9a\u7fa9\u4e26\u904b\u884c\u8a72\u5de5\u4f5c\u6d41\u3002\n\u8b8a\u91cf\u66ff\u4ee3\u5167\u5bb9\u901a\u904e\u751f\u7522\u8655\u7406\u5de5\u4f5c\u6d41\u4f7f\u7528\u7684 Cloud Storage \u5b58\u5132\u5206\u5340\uff0c\u5b9a\u7fa9\u90e8\u7f72\u5230\u751f\u7522\u74b0\u5883\u4e2d\u7684\u6700\u65b0 JAR \u6587\u4ef6\u7684\u540d\u7a31\u3002\u5982\u9700\u5275\u5efa\u90e8\u7f72\u751f\u7522\u5de5\u4f5c\u6d41\u7684 Cloud Build \u6d41\u6c34\u7dda\uff0c\u8acb\u5b8c\u6210\u4ee5\u4e0b\u6b65\u9a5f\uff1a- \u5728 Cloud Shell \u4e2d\uff0c\u901a\u904e\u8f38\u51fa JAR \u6587\u4ef6\u540d\u7684 Cloud Composer \u8b8a\u91cf\u4f86\u8b80\u53d6\u6700\u65b0 JAR \u6587\u4ef6\u7684\u6587\u4ef6\u540d\uff1a```\nexport DATAFLOW_JAR_FILE_LATEST=$(gcloud composer environments run $COMPOSER_ENV_NAME \\\u00a0 \u00a0 --location $COMPOSER_REGION variables get -- \\\u00a0 \u00a0 dataflow_jar_file_test 2>&1 | grep -i '.jar')\n```\n- \u4f7f\u7528\u69cb\u5efa\u6d41\u6c34\u7dda\u914d\u7f6e\u6587\u4ef6 `deploy_prod.yaml,` \u5728 Cloud Build \u4e2d\u5275\u5efa\u6d41\u6c34\u7dda\uff1a```\ncd ~/ci-cd-for-data-processing-workflow/source-code/build-pipelinegcloud builds submit --config=deploy_prod.yaml --substitutions=\\REPO_NAME=$SOURCE_CODE_REPO,\\_DATAFLOW_JAR_BUCKET_TEST=$DATAFLOW_JAR_BUCKET_TEST,\\_DATAFLOW_JAR_FILE_LATEST=$DATAFLOW_JAR_FILE_LATEST,\\_DATAFLOW_JAR_BUCKET_PROD=$DATAFLOW_JAR_BUCKET_PROD,\\_COMPOSER_INPUT_BUCKET=$INPUT_BUCKET_PROD,\\_COMPOSER_ENV_NAME=$COMPOSER_ENV_NAME,\\_COMPOSER_REGION=$COMPOSER_REGION,\\_COMPOSER_DAG_BUCKET=$COMPOSER_DAG_BUCKET,\\_COMPOSER_DAG_NAME_PROD=$COMPOSER_DAG_NAME_PROD\n```\n### \u9a57\u8b49\u751f\u7522\u6d41\u6c34\u7dda\u5275\u5efa\u7684\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\n- \u7372\u53d6 Cloud Composer \u754c\u9762\u7684\u7db2\u5740\uff1a```\ngcloud composer environments describe $COMPOSER_ENV_NAME \\\u00a0 \u00a0 --location $COMPOSER_REGION \\\u00a0 \u00a0 --format=\"get(config.airflowUri)\"\n```\n- \u5982\u9700\u9a57\u8b49\u751f\u7522\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41 DAG \u662f\u5426\u5df2\u90e8\u7f72\uff0c\u8acb\u8f49\u5230\u5728\u4e0a\u4e00\u6b65\u4e2d\u6aa2\u7d22\u5230\u7684\u7db2\u5740\uff0c\u4e26\u9a57\u8b49 `prod_word_count` DAG \u662f\u5426\u5305\u542b\u5728 DAG \u5217\u8868\u4e2d\u3002- \u5728 **DAG** \u9801\u9762\u7684 **prod_word_count** \u884c\u4e2d\uff0c\u9ede\u64ca **Trigger DAG** \uff08\u89f8\u767c DAG\uff09\u3002 \n- \u9ede\u64ca Airflow \u5fbd\u6a19\u6216\u91cd\u65b0\u52a0\u8f09\u9801\u9762\u4ee5\u66f4\u65b0 DAG \u904b\u884c\u72c0\u614b\u3002 **\u904b\u884c** \u5217\u4e2d\u7684\u6dfa\u7da0\u8272\u5713\u5708\u8868\u793a DAG \u7576\u524d\u6b63\u5728\u904b\u884c\u3002\u5c07\u6307\u91dd\u61f8\u505c\u5728\u5713\u5708\u4e0a\uff0c\u4ee5\u67e5\u770b\u986f\u793a **\u6b63\u5728\u904b\u884c** \u7684\u63d0\u793a\u3002 \n- \u904b\u884c\u6210\u529f\u5f8c\uff0c\u5c07\u6307\u91dd\u61f8\u505c\u5728 **DAG \u904b\u884c** \u5217\u4e0b\u65b9\u7684\u6df1\u7da0\u8272\u5713\u5708\u4e0a\uff0c\u4e26\u9a57\u8b49\u5b83\u662f\u5426\u986f\u793a **\u6210\u529f** \u3002 \n- \u5728 Cloud Shell \u4e2d\uff0c\u5217\u51fa Cloud Storage \u5b58\u5132\u5206\u5340\u4e2d\u7684\u7d50\u679c\u6587\u4ef6\uff1a```\ngsutil ls gs://$RESULT_BUCKET_PROD\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\ngs://\u2026-composer-result-prod/output-00000-of-00003\ngs://\u2026-composer-result-prod/output-00001-of-00003\ngs://\u2026-composer-result-prod/output-00002-of-00003\n``` **\u6ce8\u610f** \uff1a\u901a\u5e38\uff0c\u7576\u751f\u7522\u6578\u64da\u5de5\u4f5c\u6d41\u4f5c\u696d\u57f7\u884c\u7531\u4e8b\u4ef6\u89f8\u767c\uff08\u4f8b\u5982\u767c\u4f48 Pub/Sub \u6d88\u606f\u3001\u5c07\u6587\u4ef6\u5b58\u5132\u5728\u5b58\u5132\u6876\u4e2d\uff09\u6216\u6309\u8a08\u5283\u5b9a\u671f\u904b\u884c\u6642\uff0c\u90e8\u7f72\u4f5c\u696d\u5728\u90e8\u7f72\u524d\u52d9\u5fc5\u78ba\u4fdd\u751f\u7522\u6578\u64da\u5de5\u4f5c\u6d41\u7576\u524d\u672a\u904b\u884c\u3002\u5728\u751f\u7522\u74b0\u5883\u4e2d\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 [Airflow CLI \u547d\u4ee4](https://cloud.google.com/composer/docs/how-to/accessing/airflow-cli?hl=zh-cn) \u7684 [dag_state](https://airflow.apache.org/docs/apache-airflow/stable/usage-cli.html) \u4f86\u6aa2\u7d22 DAG \u904b\u884c\u7684\u72c0\u614b\u3002\n## \u5275\u5efa Cloud Build \u89f8\u767c\u5668\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u5275\u5efa Cloud Build \u89f8\u767c\u5668\uff0c\u4ee5\u5c07\u6e90\u4ee3\u78bc\u66f4\u6539\u95dc\u806f\u5230\u6e2c\u8a66\u69cb\u5efa\u6d41\u7a0b\u4ee5\u53ca\u6e2c\u8a66\u6d41\u6c34\u7dda\u548c\u751f\u7522\u69cb\u5efa\u6d41\u6c34\u7dda\u4e4b\u9593\u3002\n### \u914d\u7f6e\u6e2c\u8a66\u69cb\u5efa\u6d41\u6c34\u7dda\u89f8\u767c\u5668\u60a8\u53ef\u4ee5\u8a2d\u7f6e [Cloud Build \u89f8\u767c\u5668](https://cloud.google.com/build/docs/running-builds/automate-builds?hl=zh-cn) \uff0c\u5728\u5c07\u66f4\u6539\u63a8\u9001\u5230\u6e90\u4ee3\u78bc\u5eab\u7684\u4e3b\u5206\u652f\u6642\u89f8\u767c\u65b0\u69cb\u5efa\u3002- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u9032\u5165 **\u69cb\u5efa\u89f8\u767c\u5668** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u69cb\u5efa\u89f8\u767c\u5668\u201d\u9801\u9762](https://console.cloud.google.com/cloud-build/triggers?hl=zh-cn) \n- \u9ede\u64ca **\u5275\u5efa\u89f8\u767c\u5668** \u3002\n- \u5982\u9700\u914d\u7f6e\u89f8\u767c\u5668\u8a2d\u7f6e\uff0c\u8acb\u5b8c\u6210\u4ee5\u4e0b\u6b65\u9a5f\uff1a- \u5728 **\u540d\u7a31** \u5b57\u6bb5\u4e2d\uff0c\u8f38\u5165`trigger-build-in-test-environment`\u3002\n- \u5728 **\u5340\u57df** \u4e0b\u62c9\u5217\u8868\u4e2d\uff0c\u9078\u64c7 **\u5168\u7403\uff08\u975e\u5340\u57df\u7d1a\uff09** \u3002\n- \u5c0d\u65bc **\u4e8b\u4ef6** \uff0c\u9ede\u64ca **\u63a8\u9001\u5230\u5206\u652f** \u3002\n- \u5c0d\u65bc **\u4f86\u6e90** \uff0c\u9078\u64c7`data-pipeline-source`\u3002\n- \u5728 **\u5206\u652f\u540d\u7a31** \u5b57\u6bb5\u4e2d\uff0c\u8f38\u5165`master`\u3002\n- \u5728 **\u914d\u7f6e** \u90e8\u5206\uff0c\u9ede\u64ca **Cloud Build \u914d\u7f6e\u6587\u4ef6\uff08yaml \u6216 json\uff09** \u3002\n- \u5c0d\u65bc **\u4f4d\u7f6e** \uff0c\u9ede\u64ca **\u4ee3\u78bc\u5eab** \u3002\n- \u5728 **Cloud Build \u914d\u7f6e\u6587\u4ef6\u4f4d\u7f6e** \u5b57\u6bb5\u4e2d\uff0c\u8f38\u5165`build-pipeline/build_deploy_test.yaml`\u3002\n- \u5728 Cloud Shell \u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u7372\u53d6\u9032\u884c\u69cb\u5efa\u6240\u9700\u7684\u6240\u6709\u66ff\u4ee3\u8b8a\u91cf\u3002\u8a18\u4e0b\u4e0b\u5217\u503c\uff0c\u56e0\u7232\u5728\u4ee5\u5f8c\u7684\u6b65\u9a5f\u4e2d\u9700\u8981\u7528\u5230\u3002```\necho \"_COMPOSER_DAG_BUCKET : ${COMPOSER_DAG_BUCKET}_COMPOSER_DAG_NAME_TEST : ${COMPOSER_DAG_NAME_TEST}_COMPOSER_ENV_NAME : ${COMPOSER_ENV_NAME}_COMPOSER_INPUT_BUCKET : ${INPUT_BUCKET_TEST}_COMPOSER_REF_BUCKET : ${REF_BUCKET_TEST}_COMPOSER_REGION : ${COMPOSER_REGION}_DATAFLOW_JAR_BUCKET : ${DATAFLOW_JAR_BUCKET_TEST}\"\n``` **\u6ce8\u610f** \uff1a\u8f38\u51fa\u540d\u7a31/\u503c\u5c0d\u7528\u65bc\u4ee5\u4e0b\u6b65\u9a5f\n- \u5728 **\u89f8\u767c\u5668\u8a2d\u7f6e** \u9801\u9762\u7684 **Advanced, Substitution variables** \uff08\u9ad8\u7d1a\u66ff\u4ee3\u8b8a\u91cf\uff09\u4e0b\uff0c\u5c07\u76f8\u61c9\u8b8a\u91cf\u66ff\u63db\u7232\u60a8\u5728\u4e0a\u4e00\u6b65\u5f9e\u74b0\u5883\u4e2d\u7372\u5f97\u7684\u503c\u3002\u4e00\u6b21\u6027\u6dfb\u52a0\u4ee5\u4e0b\u5167\u5bb9\uff0c\u7136\u5f8c\u9ede\u64ca\u6bcf\u500b\u540d\u7a31-\u503c\u5c0d\u5c0d\u61c9\u7684 **+ \u6dfb\u52a0\u9805** \u3002- `_COMPOSER_DAG_BUCKET`\n- `_COMPOSER_DAG_NAME_TEST`\n- `_COMPOSER_ENV_NAME`\n- `_COMPOSER_INPUT_BUCKET`\n- `_COMPOSER_REF_BUCKET`\n- `_COMPOSER_REGION`\n- `_DATAFLOW_JAR_BUCKET` \n- \u9ede\u64ca **\u5275\u5efa** \u3002\n### \u914d\u7f6e\u751f\u7522\u69cb\u5efa\u6d41\u6c34\u7dda\u89f8\u767c\u5668\u60a8\u53ef\u4ee5\u8a2d\u7f6e Cloud Build \u89f8\u767c\u5668\uff0c\u4ee5\u5728\u6e2c\u8a66\u74b0\u5883\u4e2d\u901a\u904e\u6e2c\u8a66\u4e14\u6d88\u606f\u767c\u4f48\u5230 `tests-complete` Pub/Sub \u4e3b\u984c\u5f8c\u89f8\u767c\u751f\u7522\u69cb\u5efa\u3002\u6b64\u89f8\u767c\u5668\u5305\u62ec\u4e00\u500b\u6279\u51c6\u6b65\u9a5f\uff0c\u5176\u4e2d\u5728\u904b\u884c\u751f\u7522\u6d41\u6c34\u7dda\u4e4b\u524d\u9700\u8981\u624b\u52d5\u6279\u51c6\u69cb\u5efa\u3002- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u9032\u5165 **\u69cb\u5efa\u89f8\u767c\u5668** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u69cb\u5efa\u89f8\u767c\u5668\u201d\u9801\u9762](https://console.cloud.google.com/cloud-build/triggers?hl=zh-cn) \n- \u9ede\u64ca **\u5275\u5efa\u89f8\u767c\u5668** \u3002\n- \u5982\u9700\u914d\u7f6e\u89f8\u767c\u5668\u8a2d\u7f6e\uff0c\u8acb\u5b8c\u6210\u4ee5\u4e0b\u6b65\u9a5f\uff1a- \u5728 **\u540d\u7a31** \u5b57\u6bb5\u4e2d\uff0c\u8f38\u5165`trigger-build-in-prod-environment`\u3002\n- \u5728 **\u5340\u57df** \u4e0b\u62c9\u5217\u8868\u4e2d\uff0c\u9078\u64c7 **\u5168\u7403\uff08\u975e\u5340\u57df\u7d1a\uff09** \u3002\n- \u5c0d\u65bc **\u4e8b\u4ef6** \uff0c\u9ede\u64ca **Pub/Sub \u6d88\u606f** \u3002\n- \u5c0d\u65bc **\u8a02\u95b1** \uff0c\u9078\u64c7 **integration-test-complete-topic** \u3002\n- \u5c0d\u65bc **\u4f86\u6e90** \uff0c\u9078\u64c7`data-pipeline-source`\u3002\n- \u5c0d\u65bc **\u4fee\u8a02\u7248\u672c** \uff0c\u9078\u64c7 **\u5206\u652f** \u3002\n- \u5728 **\u5206\u652f\u540d\u7a31** \u5b57\u6bb5\u4e2d\uff0c\u8f38\u5165`master`\u3002\n- \u5728 **\u914d\u7f6e** \u90e8\u5206\uff0c\u9ede\u64ca **Cloud Build \u914d\u7f6e\u6587\u4ef6\uff08yaml \u6216 json\uff09** \u3002\n- \u5c0d\u65bc **\u4f4d\u7f6e** \uff0c\u9ede\u64ca **\u4ee3\u78bc\u5eab** \u3002\n- \u5728 **Cloud Build \u914d\u7f6e\u6587\u4ef6\u4f4d\u7f6e** \u5b57\u6bb5\u4e2d\uff0c\u8f38\u5165`build-pipeline/deploy_prod.yaml`\u3002\n- \u5728 Cloud Shell \u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u7372\u53d6\u9032\u884c\u69cb\u5efa\u6240\u9700\u7684\u6240\u6709\u66ff\u4ee3\u8b8a\u91cf\u3002\u8a18\u4e0b\u4e0b\u5217\u503c\uff0c\u56e0\u7232\u5728\u4ee5\u5f8c\u7684\u6b65\u9a5f\u4e2d\u9700\u8981\u7528\u5230\u3002```\necho \"_COMPOSER_DAG_BUCKET : ${COMPOSER_DAG_BUCKET}_COMPOSER_DAG_NAME_PROD : ${COMPOSER_DAG_NAME_PROD}_COMPOSER_ENV_NAME : ${COMPOSER_ENV_NAME}_COMPOSER_INPUT_BUCKET : ${INPUT_BUCKET_PROD}_COMPOSER_REGION : ${COMPOSER_REGION}_DATAFLOW_JAR_BUCKET_PROD : ${DATAFLOW_JAR_BUCKET_PROD}_DATAFLOW_JAR_BUCKET_TEST : ${DATAFLOW_JAR_BUCKET_TEST}\"\n``` **\u6ce8\u610f** \uff1a\u8f38\u51fa\u540d\u7a31/\u503c\u5c0d\u7528\u65bc\u4ee5\u4e0b\u6b65\u9a5f\n- \u5728 **\u89f8\u767c\u5668\u8a2d\u7f6e** \u9801\u9762\u7684 **Advanced, Substitution variables** \uff08\u9ad8\u7d1a\u66ff\u4ee3\u8b8a\u91cf\uff09\u4e0b\uff0c\u5c07\u76f8\u61c9\u8b8a\u91cf\u66ff\u63db\u7232\u60a8\u5728\u4e0a\u4e00\u6b65\u5f9e\u74b0\u5883\u4e2d\u7372\u5f97\u7684\u503c\u3002\u4e00\u6b21\u6027\u6dfb\u52a0\u4ee5\u4e0b\u5167\u5bb9\uff0c\u7136\u5f8c\u9ede\u64ca\u6bcf\u500b\u540d\u7a31-\u503c\u5c0d\u5c0d\u61c9\u7684 **+ \u6dfb\u52a0\u9805** \u3002- `_COMPOSER_DAG_BUCKET`\n- `_COMPOSER_DAG_NAME_PROD`\n- `_COMPOSER_ENV_NAME`\n- `_COMPOSER_INPUT_BUCKET`\n- `_COMPOSER_REGION`\n- `_DATAFLOW_JAR_BUCKET_PROD`\n- `_DATAFLOW_JAR_BUCKET_TEST`\n- `_DATAFLOW_JAR_FILE_LATEST = $(body.message.data)` \n- \u5c0d\u65bc **\u6279\u51c6** \uff0c\u9078\u4e2d **\u69cb\u5efa\u57f7\u884c\u524d\u9700\u8981\u7372\u5f97\u6279\u51c6** \u3002\n- \u9ede\u64ca **\u5275\u5efa** \u3002\n### \u6e2c\u8a66\u89f8\u767c\u5668\u5982\u9700\u6e2c\u8a66\u89f8\u767c\u5668\uff0c\u8acb\u5728\u6e2c\u8a66\u8f38\u5165\u6587\u4ef6\u4e2d\u6dfb\u52a0\u4e00\u500b\u65b0\u55ae\u8a5e\uff0c\u4e26\u5c0d\u6e2c\u8a66\u53c3\u8003\u6587\u4ef6\u9032\u884c\u76f8\u61c9\u7684\u8abf\u6574\u3002\u60a8\u9a57\u8b49\u69cb\u5efa\u6d41\u6c34\u7dda\u662f\u5426\u5df2\u7531\u5411 Cloud Source Repositories \u4ee3\u78bc\u5eab\u9032\u884c\u7684\u63a8\u9001\u89f8\u767c\uff0c\u540c\u6642\u9a57\u8b49\u6578\u64da\u8655\u7406\u5de5\u4f5c\u6d41\u662f\u5426\u6b63\u96a8\u66f4\u65b0\u5f8c\u7684\u6e2c\u8a66\u6587\u4ef6\u6b63\u78ba\u904b\u884c\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u5728\u6e2c\u8a66\u6587\u4ef6\u672b\u5c3e\u6dfb\u52a0\u4e00\u500b\u6e2c\u8a66\u5b57\u8a5e\uff1a```\necho \"testword\" >> \u00a0~/$SOURCE_CODE_REPO/workflow-dag/support-files/input.txt\n```\n- \u66f4\u65b0\u6e2c\u8a66\u7d50\u679c\u53c3\u8003\u6587\u4ef6 `ref.txt` \uff0c\u4ee5\u5339\u914d\u6e2c\u8a66\u8f38\u5165\u6587\u4ef6\u4e2d\u5b8c\u6210\u7684\u66f4\u6539\uff1a```\necho \"testword: 1\" >> \u00a0~/$SOURCE_CODE_REPO/workflow-dag/support-files/ref.txt\n```\n- \u63d0\u4ea4\u4f75\u63a8\u9001\u66f4\u6539\u81f3 Cloud Source Repositories \u4ee3\u78bc\u5eab\uff1a```\ncd ~/$SOURCE_CODE_REPOgit add .git commit -m 'change in test files'git push google master\n```\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u9032\u5165 **\u6b77\u53f2\u8a18\u9304** \u9801\u9762\u3002 [\u9032\u5165\u201c\u6b77\u53f2\u8a18\u9304\u201d\u9801\u9762](https://console.cloud.google.com/cloud-build?hl=zh-cn) \n- \u5982\u9700\u9a57\u8b49\u65b0\u6e2c\u8a66\u69cb\u5efa\u662f\u5426\u662f\u7531\u4e0a\u4e00\u5411\u4e3b\u5206\u652f\u9032\u884c\u7684\u63a8\u9001\u89f8\u767c\u7684\uff0c\u8acb\u5728\u7576\u524d\u6b63\u5728\u904b\u884c\u7684\u69cb\u5efa\u4e2d\u67e5\u770b **\u53c3\u8003** \u5217\u662f\u5426\u986f\u793a\u7232 **\u4e3b** \u3002\n- \u5728 Cloud Shell \u4e2d\uff0c\u7372\u53d6 Cloud Composer \u7db2\u9801\u754c\u9762\u7684\u7db2\u5740\uff1a```\ngcloud composer environments describe $COMPOSER_ENV_NAME \\\u00a0 \u00a0 --location $COMPOSER_REGION --format=\"get(config.airflowUri)\"\n```\n- \u69cb\u5efa\u5b8c\u6210\u5f8c\uff0c\u8f49\u5230\u5f9e\u4e0a\u4e00\u547d\u4ee4\u7372\u5f97\u7684\u7db2\u5740\uff0c\u9a57\u8b49 `test_word_count` DAG \u662f\u5426\u6b63\u5728\u904b\u884c\u3002\u7b49 DAG \u904b\u884c\u5b8c\u7562\uff0c **DAG \u904b\u884c** \u5217\u4e2d\u7684\u6dfa\u7da0\u8272\u5713\u5708\u6d88\u5931\u6642\u5373\u8868\u793a\u904b\u884c\u5b8c\u7562\u3002\u6b64\u904e\u7a0b\u901a\u5e38\u9700\u8981\u4e09\u5230\u4e94\u5206\u9418\u624d\u80fd\u5b8c\u6210\u3002\n- \u5728 Cloud Shell \u4e2d\uff0c\u4e0b\u8f09\u6e2c\u8a66\u7d50\u679c\u6587\u4ef6\uff1a```\nmkdir ~/result-downloadcd ~/result-downloadgsutil cp gs://$RESULT_BUCKET_TEST/output* .\n```\n- \u9a57\u8b49\u65b0\u6dfb\u52a0\u7684\u5b57\u8a5e\u662f\u5426\u4f4d\u65bc\u5176\u4e2d\u4e00\u500b\u7d50\u679c\u6587\u4ef6\u4e2d\uff1a```\ngrep testword output*\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\noutput-00000-of-00003:testword: 1\n```\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u9032\u5165 **\u6b77\u53f2\u8a18\u9304** \u9801\u9762\u3002 [\u9032\u5165\u201c\u6b77\u53f2\u8a18\u9304\u201d\u9801\u9762](https://console.cloud.google.com/cloud-build?hl=zh-cn) \n- \u9a57\u8b49\u96c6\u6210\u6e2c\u8a66\u5b8c\u6210\u662f\u5426\u89f8\u767c\u4e86\u65b0\u751f\u7522\u69cb\u5efa\uff0c\u4ee5\u53ca\u8a72\u69cb\u5efa\u662f\u5426\u6b63\u5728\u7b49\u5f85\u6279\u51c6\u3002 \n- \u9078\u4e2d\u69cb\u5efa\u65c1\u908a\u7684\u8907\u9078\u6846\uff0c\u9ede\u64ca **\u6279\u51c6** \uff0c\u7136\u5f8c\u9ede\u64ca\u78ba\u8a8d\u6846\u4e2d\u7684 **\u6279\u51c6** \uff0c\u4ee5\u904b\u884c\u751f\u7522\u69cb\u5efa\u6d41\u6c34\u7dda\u3002\n- \u69cb\u5efa\u5b8c\u6210\u5f8c\uff0c\u524d\u5f80\u4e0a\u4e00\u500b\u547d\u4ee4\u8f38\u51fa\u7684\u7db2\u5740\u4e26\u624b\u52d5\u89f8\u767c `prod_word_count` DAG \u4ee5\u904b\u884c\u751f\u7522\u6d41\u6c34\u7dda\u3002 \n## \u6e05\u7406\u7232\u907f\u514d\u56e0\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528\u7684\u8cc7\u6e90\u5c0e\u81f4\u60a8\u7684 Google Cloud \u5e33\u865f\u7522\u751f\u8cbb\u7528\uff0c\u8acb\u522a\u9664\u5305\u542b\u9019\u4e9b\u8cc7\u6e90\u7684\u9805\u76ee\uff0c\u6216\u8005\u4fdd\u7559\u9805\u76ee\u4f46\u522a\u9664\u5404\u500b\u8cc7\u6e90\u3002\n### \u522a\u9664\u9805\u76ee- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- **\u8b66\u544a** \uff1a\u522a\u9664\u9805\u76ee\u6703\u7522\u751f\u4ee5\u4e0b\u5f71\u97ff- **\u9805\u76ee\u4e2d\u7684\u6240\u6709\u5167\u5bb9\u90fd\u6703\u88ab\u522a\u9664\u3002** \u5982\u679c\u60a8\u5c07\u73fe\u6709\u9805\u76ee\u7528\u65bc\u672c\u6587\u6a94\u4e2d\u7684\u4efb\u52d9\uff0c\u5247\u522a\u9664\u8a72\u9805\u76ee\u5f8c\uff0c\u9084\u5c07\u522a\u9664\u60a8\u5df2\u5728\u8a72\u9805\u76ee\u4e2d\u5b8c\u6210\u7684\u4efb\u4f55\u5176\u4ed6\u5de5\u4f5c\u3002\n- **\u81ea\u5b9a\u7fa9\u9805\u76ee ID \u4e1f\u5931\u3002** \u5275\u5efa\u6b64\u9805\u76ee\u6642\uff0c\u60a8\u53ef\u80fd\u5275\u5efa\u4e86\u8981\u5728\u5c07\u4f86\u4f7f\u7528\u7684\u81ea\u5b9a\u7fa9\u9805\u76ee ID\u3002\u8981\u4fdd\u7559\u4f7f\u7528\u8a72\u9805\u76ee ID \u7684\u7db2\u5740\uff08\u4f8b\u5982`appspot.com`\u7db2\u5740\uff09\uff0c\u8acb\u522a\u9664\u9805\u76ee\u5167\u7684\u6240\u9078\u8cc7\u6e90\uff0c\u800c\u4e0d\u662f\u522a\u9664\u6574\u500b\u9805\u76ee\u3002\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u9032\u5165 **\u7ba1\u7406\u8cc7\u6e90** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u7ba1\u7406\u8cc7\u6e90\u201d](https://console.cloud.google.com/iam-admin/projects?hl=zh-cn) \n- \u5728\u9805\u76ee\u5217\u8868\u4e2d\uff0c\u9078\u64c7\u8981\u522a\u9664\u7684\u9805\u76ee\uff0c\u7136\u5f8c\u9ede\u64ca **\u522a\u9664** \u3002\n- \u5728\u5c0d\u8a71\u6846\u4e2d\u8f38\u5165\u9805\u76ee ID\uff0c\u7136\u5f8c\u9ede\u64ca **\u95dc\u9589** \u4ee5\u522a\u9664\u9805\u76ee\u3002\n### \u9010\u500b\u522a\u9664\u8cc7\u6e90\u5982\u679c\u60a8\u5e0c\u671b\u4fdd\u7559\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528\u7684\u9805\u76ee\uff0c\u8acb\u6309\u7167\u4ee5\u4e0b\u6b65\u9a5f\u522a\u9664\u60a8\u5728\u672c\u6559\u7a0b\u4e2d\u5275\u5efa\u7684\u8cc7\u6e90\u3002- \u5982\u9700\u522a\u9664 Cloud Build \u89f8\u767c\u5668\uff0c\u8acb\u5b8c\u6210\u4ee5\u4e0b\u6b65\u9a5f\uff1a- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u8f49\u5230 **\u89f8\u767c\u5668** \u9801\u9762\u3002 [\u9032\u5165\u201c\u89f8\u767c\u5668\u201d\u9801\u9762](https://console.cloud.google.com/cloud-build/triggers?hl=zh-cn) \n- \u5728\u60a8\u5275\u5efa\u7684\u89f8\u767c\u5668\u65c1\u908a\uff0c\u9ede\u64ca **\u66f4\u591a** \uff0c\u7136\u5f8c\u9ede\u64ca **\u522a\u9664** \u3002\n- \u5728 Cloud Shell \u4e2d\uff0c\u522a\u9664 Cloud Composer \u74b0\u5883\uff1a```\ngcloud -q composer environments delete $COMPOSER_ENV_NAME \\\u00a0 \u00a0 --location $COMPOSER_REGION\n```\n- \u522a\u9664 Cloud Storage \u5b58\u5132\u5206\u5340\u53ca\u5176\u6587\u4ef6\uff1a```\ngsutil -m rm -r gs://$DATAFLOW_JAR_BUCKET_TEST \\\u00a0 \u00a0 gs://$INPUT_BUCKET_TEST \\\u00a0 \u00a0 gs://$REF_BUCKET_TEST \\\u00a0 \u00a0 gs://$RESULT_BUCKET_TEST \\\u00a0 \u00a0 gs://$DATAFLOW_STAGING_BUCKET_TEST \\\u00a0 \u00a0 gs://$DATAFLOW_JAR_BUCKET_PROD \\\u00a0 \u00a0 gs://$INPUT_BUCKET_PROD \\\u00a0 \u00a0 gs://$RESULT_BUCKET_PROD \\\u00a0 \u00a0 gs://$DATAFLOW_STAGING_BUCKET_PROD\n```\n- \u5982\u9700\u522a\u9664 Pub/Sub \u4e3b\u984c\u548c\u9ed8\u8a8d\u8a02\u95b1\uff0c\u8acb\u5728 Cloud Shell \u4e2d\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud pubsub topics delete integration-test-complete-topicgcloud pubsub subscriptions delete integration-test-complete-topic-sub\n```\n- \u522a\u9664\u4ee3\u78bc\u5eab\uff1a```\ngcloud -q source repos delete $SOURCE_CODE_REPO\n```\n- \u522a\u9664\u60a8\u5275\u5efa\u7684\u6587\u4ef6\u548c\u6587\u4ef6\u593e\uff1a```\nrm -rf ~/ci-cd-for-data-processing-workflowrm -rf ~/$SOURCE_CODE_REPOrm -rf ~/result-download\n```\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u8a73\u7d30\u77ad\u89e3 [\u5982\u4f55\u901a\u904e Cloud Build \u5be6\u73fe GitOps \u5f0f\u6301\u7e8c\u4ea4\u4ed8](https://cloud.google.com/kubernetes-engine/docs/tutorials/gitops-cloud-build?hl=zh-cn) \u3002\n- \u8a73\u7d30\u77ad\u89e3 [\u5982\u4f55\u4f7f\u7528 Cloud Composer \u5be6\u73fe\u57fa\u790e\u67b6\u69cb\u81ea\u52d5\u5316](https://cloud.google.com/solutions/automating-infrastructure-using-cloud-composer?hl=zh-cn) \u3002\n- \u8a73\u7d30\u77ad\u89e3 [Dataflow \u5e38\u898b\u4f7f\u7528\u5834\u666f](https://cloud.google.com/blog/products/gcp/guide-to-common-cloud-dataflow-use-case-patterns-part-1?hl=zh-cn) \u3002\n- \u8a73\u7d30\u77ad\u89e3 [\u767c\u4f48\u5de5\u7a0b](https://landing.google.com/sre/sre-book/chapters/release-engineering/?hl=zh-cn) \u3002\n- \u63a2\u7d22\u6709\u95dc Google Cloud \u7684\u53c3\u8003\u67b6\u69cb\u3001\u5716\u8868\u548c\u6700\u4f73\u505a\u6cd5\u3002\u67e5\u770b\u6211\u5011\u7684 [Cloud Architecture Center](https://cloud.google.com/architecture?hl=zh-cn) \u3002", "guide": "Docs"}