{"title": "Docs - \u5f9e\u908a\u7de3\u5230\u7db2\u683c\uff1a\u901a\u904e GKE Gateway \u90e8\u7f72\u670d\u52d9\u7db2\u683c\u61c9\u7528", "url": "https://cloud.google.com/architecture/exposing-service-mesh-apps-through-gke-ingress/deployment?hl=zh-cn", "abstract": "# Docs - \u5f9e\u908a\u7de3\u5230\u7db2\u683c\uff1a\u901a\u904e GKE Gateway \u90e8\u7f72\u670d\u52d9\u7db2\u683c\u61c9\u7528\nLast reviewed 2024-01-31 UTC\n\u672c\u90e8\u7f72\u4ecb\u7d39\u5982\u4f55\u5c07 [Anthos Service Mesh](https://cloud.google.com/service-mesh/docs/overview?hl=zh-cn) \u8207 [Cloud Load Balancing](https://cloud.google.com/load-balancing/docs/load-balancing-overview?hl=zh-cn) \u7d50\u5408\u4f7f\u7528\uff0c\u4ee5\u5c07\u670d\u52d9\u7db2\u683c\u4e2d\u7684\u61c9\u7528\u516c\u958b\u7d66\u4e92\u806f\u7db2\u5ba2\u6236\u7aef\u3002\n\u60a8\u53ef\u4ee5\u901a\u904e\u591a\u7a2e\u65b9\u5f0f\u5411\u5ba2\u6236\u7aef\u516c\u958b\u61c9\u7528\uff0c\u5177\u9ad4\u53d6\u6c7a\u65bc\u5ba2\u6236\u7aef\u6240\u5728\u7684\u4f4d\u7f6e\u3002\u672c\u90e8\u7f72\u4ecb\u7d39\u77ad\u5982\u4f55\u5c07 Cloud Load Balancing \u8207 Anthos Service Mesh \u7d50\u5408\u4f7f\u7528\u4ee5\u5411\u5ba2\u6236\u7aef\u516c\u958b\u61c9\u7528\uff0c\u4ee5\u5c07\u8ca0\u8f09\u5747\u8861\u5668\u8207\u670d\u52d9\u7db2\u683c\u96c6\u6210\u5728\u4e00\u8d77\u3002\u672c\u90e8\u7f72\u9762\u5411\u904b\u884c Anthos Service Mesh \u7684\u9ad8\u7d1a\u5f9e\u696d\u4eba\u54e1\uff0c\u4f46\u4e5f\u9069\u7528\u65bc Google Kubernetes Engine \u4e0a\u7684 Istio\u3002\n", "content": "## \u67b6\u69cb\n\u4e0b\u5716\u5c55\u793a\u77ad\u5982\u4f55\u4f7f\u7528\u7db2\u683c Ingress \u7db2\u95dc\u5c07\u8ca0\u8f09\u5747\u8861\u5668\u8207\u670d\u52d9\u7db2\u683c\u96c6\u6210\uff1a\n**\u6ce8\u610f** \uff1a\u5c0d\u65bc Anthos Service Mesh \u4e2d\u7684\u61c9\u7528\uff0c\u5916\u90e8 TCP/UDP \u8ca0\u8f09\u5747\u8861\u5668\u7684\u90e8\u7f72\u662f\u9ed8\u8a8d\u516c\u958b\u985e\u578b\u3002\u60a8\u53ef\u4ee5\u901a\u904e Kubernetes Service \u90e8\u7f72\u8ca0\u8f09\u5747\u8861\u5668\uff0c\u800c Kubernetes Service \u6703\u9078\u64c7\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u4ee3\u7406\u7684 Pod\u3002\n\u5728\u4e0a\u5716\u7684\u62d3\u64b2\u4e2d\uff0c\u901a\u904e GKE Gateway \u7de8\u7a0b\u7684 Cloud \u5165\u7ad9\u6d41\u91cf\u5c64\u5f9e\u670d\u52d9\u7db2\u683c\u5916\u90e8\u7372\u53d6\u6d41\u91cf\uff0c\u4e26\u5c07\u8a72\u6d41\u91cf\u5b9a\u5411\u5230\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u5c64\u3002\u7136\u5f8c\uff0c\u7db2\u683c Ingress \u5c64\u6703\u5c07\u6d41\u91cf\u5b9a\u5411\u5230\u7db2\u683c\u8a17\u7ba1\u7684\u61c9\u7528\u5f8c\u7aef\u3002\n\u4e0a\u8ff0\u62d3\u64b2\u6709\u4ee5\u4e0b\u6ce8\u610f\u4e8b\u9805\uff1a\n- **Cloud \u5165\u7ad9\u6d41\u91cf\uff1a** \u5728\u6b64\u53c3\u8003\u67b6\u69cb\u4e2d\uff0c\u901a\u904e GKE Gateway \u914d\u7f6e Google Cloud \u8ca0\u8f09\u5747\u8861\u5668\uff0c\u4ee5\u6aa2\u67e5\u6240\u516c\u958b\u5065\u5eb7\u6aa2\u67e5\u7aef\u53e3\u4e0a\u7684\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u4ee3\u7406\u7684\u5065\u5eb7\u72c0\u6cc1\u3002\n- **\u7db2\u683c Ingress\uff1a** \u5728\u7db2\u683c\u61c9\u7528\u4e2d\uff0c\u60a8\u53ef\u4ee5\u76f4\u63a5\u5c0d\u5f8c\u7aef\u57f7\u884c\u5065\u5eb7\u6aa2\u67e5\uff0c\u4ee5\u4fbf\u53ef\u4ee5\u5728\u672c\u5730\u904b\u884c\u8ca0\u8f09\u5747\u8861\u548c\u6d41\u91cf\u7ba1\u7406\u3002\u4e0a\u5716\u8aaa\u660e\u4e86\u5f9e\u5ba2\u6236\u7aef\u5230 Google Cloud \u8ca0\u8f09\u5747\u8861\u5668\u3001\u5f9e\u8ca0\u8f09\u5747\u8861\u5668\u5230\u7db2\u683c Ingress \u4ee3\u7406\u4ee5\u53ca\u5f9e Ingress \u4ee3\u7406\u5230\u908a\u8eca\u4ee3\u7406\u7684 HTTPS \u52a0\u5bc6\u3002\n## \u76ee\u6a19\n- \u5728 Google Cloud \u4e0a\u90e8\u7f72 Google Kubernetes Engine (GKE) \u96c6\u7fa3\u3002\n- \u5728 GKE \u96c6\u7fa3\u4e0a\u90e8\u7f72\u57fa\u65bc Istio \u7684 Anthos Service Mesh\u3002\n- \u914d\u7f6e GKE Gateway \u4ee5\u7d42\u7d50\u516c\u5171 HTTPS \u6d41\u91cf\uff0c\u4e26\u5c07\u8a72\u6d41\u91cf\u5b9a\u5411\u5230\u670d\u52d9\u7db2\u683c\u8a17\u7ba1\u7684\u61c9\u7528\u3002\n- \u5728\u60a8\u5411\u4e92\u806f\u7db2\u4e0a\u7684\u5ba2\u6236\u7aef\u516c\u958b\u7684 GKE \u96c6\u7fa3\u4e0a\u90e8\u7f72 Online Boutique \u61c9\u7528\u3002## \u8cbb\u7528\u512a\u5316\nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n\u5728\u672c\u6587\u6a94\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Google Cloud \u7684\u4ee5\u4e0b\u6536\u8cbb\u7d44\u4ef6\uff1a- [Google Kubernetes Engine](https://cloud.google.com/kubernetes-engine/pricing?hl=zh-cn) \n- [Compute Engine](https://cloud.google.com/compute/all-pricing%22?hl=zh-cn) \n- [Cloud Load Balancing](https://cloud.google.com/vpc/network-pricing?hl=zh-cn#lb) \n- [Certificate Manager](https://cloud.google.com/certificate-manager/pricing?hl=zh-cn) \n- [Anthos Service Mesh](https://cloud.google.com/service-mesh/pricing?hl=zh-cn) \n- [Google Cloud Armor](https://cloud.google.com/armor/pricing?hl=zh-cn) \n- [Cloud Endpoints](https://cloud.google.com/endpoints/pricing?hl=zh-cn) \n\u60a8\u53ef\u4f7f\u7528 [\u50f9\u683c\u8a08\u7b97\u5668](https://cloud.google.com/products/calculator?hl=zh-cn) \u6839\u64da\u60a8\u7684\u9810\u8a08\u4f7f\u7528\u60c5\u6cc1\u4f86\u4f30\u7b97\u8cbb\u7528\u3002\u5b8c\u6210\u672c\u6587\u6a94\u4e2d\u63cf\u8ff0\u7684\u4efb\u52d9\u5f8c\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u522a\u9664\u6240\u5275\u5efa\u7684\u8cc7\u6e90\u4f86\u907f\u514d\u7e7c\u7e8c\u8a08\u8cbb\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u6e05\u7406](#clean-up) \u3002\n## \u6e96\u5099\u5de5\u4f5c- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728 Google Cloud Console \u4e2d\u7684\u9805\u76ee\u9078\u64c7\u5668\u9801\u9762\u4e0a\uff0c\u9078\u64c7\u6216 [\u5275\u5efa\u4e00\u500b Google Cloud \u9805\u76ee](https://cloud.google.com/resource-manager/docs/creating-managing-projects?hl=zh-cn) \u3002 **\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u4e0d\u6253\u7b97\u4fdd\u7559\u5728\u6b64\u904e\u7a0b\u4e2d\u5275\u5efa\u7684\u8cc7\u6e90\uff0c\u8acb\u5275\u5efa\u65b0\u7684\u9805\u76ee\uff0c\u800c\u4e0d\u8981\u9078\u64c7\u73fe\u6709\u7684\u9805\u76ee\u3002\u5b8c\u6210\u672c\u6559\u7a0b\u4ecb\u7d39\u7684\u6b65\u9a5f\u5f8c\uff0c\u60a8\u53ef\u4ee5\u522a\u9664\u6240\u5275\u5efa\u7684\u9805\u76ee\uff0c\u4e26\u79fb\u9664\u8207\u8a72\u9805\u76ee\u95dc\u806f\u7684\u6240\u6709\u8cc7\u6e90\u3002 [\u8f49\u5230\u201c\u9805\u76ee\u9078\u64c7\u5668\u201d](https://console.cloud.google.com/projectselector2/home/dashboard?hl=zh-cn) \n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them [\u78ba\u4fdd\u60a8\u7684 Google Cloud \u9805\u76ee\u5df2\u5553\u7528\u7d50\u7b97\u529f\u80fd](https://cloud.google.com/billing/docs/how-to/verify-billing-enabled?hl=zh-cn#console) \u3002\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u6fc0\u6d3b Cloud Shell\u3002 [\u6fc0\u6d3b Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn) \u60a8\u5c07\u901a\u904e Cloud Shell \u904b\u884c\u6b64\u90e8\u7f72\u4e2d\u7684\u6240\u6709\u7d42\u7aef\u547d\u4ee4\u3002\n- \u5347\u7d1a\u5230\u6700\u65b0\u7248\u672c\u7684 Google Cloud CLI\uff1a```\ngcloud components update\n```\n- \u8a2d\u7f6e\u9ed8\u8a8d\u7684 Google Cloud \u9805\u76ee\uff1a```\nexport PROJECT=PROJECTexport PROJECT_NUMBER=$(gcloud projects describe ${PROJECT} --format=\"value(projectNumber)\")gcloud config set project ${PROJECT}\n```\u5c07 `` \u66ff\u63db\u7232\u60a8\u8981\u7528\u65bc\u6b64\u90e8\u7f72\u7684\u9805\u76ee ID\u3002\n- \u5275\u5efa\u5de5\u4f5c\u76ee\u9304\uff1a```\nmkdir -p ${HOME}/edge-to-meshcd ${HOME}/edge-to-meshexport WORKDIR=`pwd`\n```\u5b8c\u6210\u6b64\u90e8\u7f72\u5f8c\uff0c\u60a8\u53ef\u4ee5\u522a\u9664\u5de5\u4f5c\u76ee\u9304\u3002## \u5275\u5efa GKE \u96c6\u7fa3\n\u6b64\u90e8\u7f72\u4e2d\u4ecb\u7d39\u7684\u529f\u80fd\u9700\u8981\u4f7f\u7528 GKE \u96c6\u7fa3 1.16 \u6216\u66f4\u9ad8\u7248\u672c\u3002\n- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa\u4e00\u500b\u65b0\u7684 `kubeconfig` \u6587\u4ef6\u3002\u6b64\u6b65\u9a5f\u78ba\u4fdd\u4e0d\u6703\u5c0e\u81f4\u8207\u73fe\u6709\uff08\u9ed8\u8a8d\uff09 `kubeconfig` \u6587\u4ef6\u885d\u7a81\u3002```\ntouch edge2mesh_kubeconfigexport KUBECONFIG=${WORKDIR}/edge2mesh_kubeconfig\n```\n- \u7232 GKE \u96c6\u7fa3\u5b9a\u7fa9\u74b0\u5883\u8b8a\u91cf\uff1a```\nexport CLUSTER_NAME=edge-to-meshexport CLUSTER_LOCATION=us-central1\n```\n- \u5553\u7528 Google Kubernetes Engine API\uff1a```\ngcloud services enable container.googleapis.com\n```\n- \u5275\u5efa GKE [Autopilot \u96c6\u7fa3](https://cloud.google.com/kubernetes-engine/docs/concepts/autopilot-overview?hl=zh-cn) \uff1a```\ngcloud container --project ${PROJECT} clusters create-auto${CLUSTER_NAME} --region ${CLUSTER_LOCATION} --release-channel rapid\n```\n- \u78ba\u4fdd\u8a72\u96c6\u7fa3\u6b63\u5728\u904b\u884c\uff1a```\ngcloud container clusters list\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nNAME   LOCATION MASTER_VERSION MASTER_IP  MACHINE_TYPE NODE_VERSION  NUM_NODES STATUS\nedge-to-mesh us-central1 1.27.3-gke.1700 34.122.84.52 e2-medium 1.27.3-gke.1700 3   RUNNING\n```## \u5b89\u88dd\u670d\u52d9\u7db2\u683c\n\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u914d\u7f6e [\u4f7f\u7528\u968a\u5217 API \u7684\u4ee3\u7ba1\u5f0f Anthos Service Mesh](https://cloud.google.com/service-mesh/docs/managed/auto-control-plane-with-fleet?hl=zh-cn) \u3002\n- \u5728 Cloud Shell \u4e2d\uff0c\u5553\u7528\u6240\u9700\u7684 API\uff1a```\ngcloud services enable mesh.googleapis.com\n```\n- \u5728\u8266\u968a\u4e0a\u5553\u7528 Anthos Service Mesh\uff1a```\ngcloud container fleet mesh enable\n```\n- \u5c07\u96c6\u7fa3\u8a3b\u518a\u5230\u8266\u968a\uff1a```\ngcloud container fleet memberships register ${CLUSTER_NAME} \\\u00a0 --gke-cluster ${CLUSTER_LOCATION}/${CLUSTER_NAME\n```\n- \u5c07 `mesh_id` \u6a19\u7c64\u61c9\u7528\u65bc `edge-to-mesh` \u96c6\u7fa3\uff1a```\ngcloud container clusters update ${CLUSTER_NAME} --project ${PROJECT} --region ${CLUSTER_LOCATION} --update-labels mesh_id=proj-${PROJECT_NUMBER}\n```\n- \u5553\u7528\u81ea\u52d5\u63a7\u5236\u5e73\u9762\u7ba1\u7406\u548c\u4ee3\u7ba1\u5f0f\u6578\u64da\u5e73\u9762\uff1a```\ngcloud container fleet mesh update \\\u00a0 --management automatic \\\u00a0 --memberships ${CLUSTER_NAME}\n```\n- \u5e7e\u5206\u9418\u5f8c\uff0c\u9a57\u8b49\u63a7\u5236\u5e73\u9762\u72c0\u614b\u662f\u5426\u7232 `ACTIVE` \uff1a```\ngcloud container fleet mesh describe\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\n...\nmembershipSpecs:\n projects/892585880385/locations/us-central1/memberships/edge-to-mesh:\n mesh:\n  management: MANAGEMENT_AUTOMATIC\nmembershipStates:\n projects/892585880385/locations/us-central1/memberships/edge-to-mesh:\n servicemesh:\n  controlPlaneManagement:\n  details:\n  - code: REVISION_READY\n   details: 'Ready: asm-managed-rapid'\n  state: ACTIVE\n  dataPlaneManagement:\n  details:\n  - code: OK\n   details: Service is running.\n  state: ACTIVE\n state:\n  code: OK\n  description: 'Revision(s) ready for use: asm-managed-rapid.'\n  updateTime: '2023-08-04T02:54:39.495937877Z'\nname: projects/e2m-doc-01/locations/global/features/servicemesh\nresourceState:\n state: ACTIVE\n...\n```## \u90e8\u7f72 GKE Gateway\n\u5728\u4ee5\u4e0b\u6b65\u9a5f\u4e2d\uff0c\u60a8\u5c07\u901a\u904e GKE Gateway Controller \u90e8\u7f72\u5916\u90e8\u61c9\u7528\u8ca0\u8f09\u5747\u8861\u5668\u3002GKE Gateway \u8cc7\u6e90\u6703\u81ea\u52d5\u9810\u914d\u8ca0\u8f09\u5747\u8861\u5668\u548c\u5f8c\u7aef\u5065\u5eb7\u6aa2\u67e5\u3002\u6b64\u5916\uff0c\u60a8\u9084\u5c07\u4f7f\u7528 Certificate Manager \u9810\u914d\u548c\u7ba1\u7406 TLS \u8b49\u66f8\uff0c\u4e26\u4f7f\u7528 Endpoints \u81ea\u52d5\u7232\u61c9\u7528\u9810\u914d\u516c\u5171 DNS \u540d\u7a31\u3002\n### \u5b89\u88dd\u670d\u52d9\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u7db2\u95dc\n\u7232\u4fdd\u8b49\u5b89\u5168\u6027\uff0c\u6211\u5011\u5efa\u8b70\u5728\u8207\u63a7\u5236\u5c64\u9762\u4e0d\u540c\u7684\u547d\u540d\u7a7a\u9593\u4e2d\u90e8\u7f72\u5165\u7ad9\u6d41\u91cf\u7db2\u95dc\u3002\n- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa\u4e00\u500b\u5c08\u7528\u7684 `asm-ingress` \u547d\u540d\u7a7a\u9593\uff1a```\nkubectl create namespace asm-ingress\n```\n- \u5c07\u547d\u540d\u7a7a\u9593\u6a19\u7c64\u6dfb\u52a0\u5230 `asm-ingress` \u547d\u540d\u7a7a\u9593\uff1a```\nkubectl label namespace asm-ingress istio-injection=enabled\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nnamespace/asm-ingress labeled\n```\u4f7f\u7528 `istio-injection=enabled` \u7232 `asm-ingress` \u547d\u540d\u7a7a\u9593\u6dfb\u52a0\u6a19\u7c64\u6703\u6307\u793a Anthos Service Mesh \u5728\u90e8\u7f72\u61c9\u7528\u6642\u81ea\u52d5\u6ce8\u5165 Envoy \u908a\u8eca\u4ee3\u7406\u3002\n- \u5275\u5efa\u5165\u7ad9\u6d41\u91cf\u7db2\u95dc\u4f7f\u7528\u7684\u81ea\u7c3d\u540d\u8b49\u66f8\uff0c\u4ee5\u7d42\u7d50 Google Cloud \u8ca0\u8f09\u5747\u8861\u5668\uff08\u7a0d\u5f8c\u901a\u904e GKE Gateway Controller \u914d\u7f6e\uff09\u548c\u5165\u7ad9\u6d41\u91cf\u7db2\u95dc\u4e4b\u9593\u7684 TLS \u9023\u63a5\uff0c\u4e26\u5c07\u81ea\u7c3d\u540d\u8b49\u66f8\u5b58\u5132\u7232 Kubernetes Secret\uff1a```\nopenssl req -new -newkey rsa:4096 -days 365 -nodes -x509 \\\u00a0-subj \"/CN=frontend.endpoints.${PROJECT}.cloud.goog/O=Edge2Mesh Inc\" \\\u00a0-keyout frontend.endpoints.${PROJECT}.cloud.goog.key \\\u00a0-out frontend.endpoints.${PROJECT}.cloud.goog.crtkubectl -n asm-ingress create secret tls edge2mesh-credential \\\u00a0--key=frontend.endpoints.${PROJECT}.cloud.goog.key \\\u00a0--cert=frontend.endpoints.${PROJECT}.cloud.goog.crt\n```\u5982\u9700\u66f4\u8a73\u7d30\u5730\u77ad\u89e3\u5165\u7ad9\u6d41\u91cf\u7db2\u95dc\u8b49\u66f8\u7684\u8981\u6c42\uff0c\u8acb\u53c3\u95b1 [\u5b89\u5168\u5f8c\u7aef\u5354\u8b70\u6ce8\u610f\u4e8b\u9805\u6307\u5357](https://cloud.google.com/load-balancing/docs/ssl-certificates/encryption-to-the-backends?hl=zh-cn#secure_backend_protocol_considerations) \u3002\n- \u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u5275\u5efa\u5165\u7ad9\u6d41\u91cf\u7db2\u95dc\u8cc7\u6e90 YAML\uff1a```\nmkdir -p ${WORKDIR}/asm-ig/basecat <<EOF > ${WORKDIR}/asm-ig/base/kustomization.yamlresources:\u00a0 - github.com/GoogleCloudPlatform/anthos-service-mesh-samples/docs/ingress-gateway-asm-manifests/baseEOFmkdir ${WORKDIR}/asm-ig/variantcat <<EOF > ${WORKDIR}/asm-ig/variant/role.yamlapiVersion: rbac.authorization.k8s.io/v1kind: Rolemetadata:\u00a0 name: asm-ingressgateway\u00a0 namespace: asm-ingressrules:- apiGroups: [\"\"]\u00a0 resources: [\"secrets\"]\u00a0 verbs: [\"get\", \"watch\", \"list\"]EOFcat <<EOF > ${WORKDIR}/asm-ig/variant/rolebinding.yamlapiVersion: rbac.authorization.k8s.io/v1kind: RoleBindingmetadata:\u00a0 name: asm-ingressgateway\u00a0 namespace: asm-ingressroleRef:\u00a0 apiGroup: rbac.authorization.k8s.io\u00a0 kind: Role\u00a0 name: asm-ingressgatewaysubjects:\u00a0 - kind: ServiceAccount\u00a0 \u00a0 name: asm-ingressgatewayEOFcat <<EOF > ${WORKDIR}/asm-ig/variant/service-proto-type.yamlapiVersion: v1kind: Servicemetadata:\u00a0 name: asm-ingressgatewayspec:\u00a0 ports:\u00a0 - name: status-port\u00a0 \u00a0 port: 15021\u00a0 \u00a0 protocol: TCP\u00a0 \u00a0 targetPort: 15021\u00a0 - name: http\u00a0 \u00a0 port: 80\u00a0 \u00a0 targetPort: 8080\u00a0 - name: https\u00a0 \u00a0 port: 443\u00a0 \u00a0 targetPort: 8443\u00a0 \u00a0 appProtocol: HTTP2\u00a0 type: ClusterIPEOFcat <<EOF > ${WORKDIR}/asm-ig/variant/gateway.yamlapiVersion: networking.istio.io/v1beta1kind: Gatewaymetadata:\u00a0 name: asm-ingressgatewayspec:\u00a0 servers:\u00a0 - port:\u00a0 \u00a0 \u00a0 number: 443\u00a0 \u00a0 \u00a0 name: https\u00a0 \u00a0 \u00a0 protocol: HTTPS\u00a0 \u00a0 hosts:\u00a0 \u00a0 - \"*\" # IMPORTANT: Must use wildcard here when using SSL, see note below\u00a0 \u00a0 tls:\u00a0 \u00a0 \u00a0 mode: SIMPLE\u00a0 \u00a0 \u00a0 credentialName: edge2mesh-credentialEOFcat <<EOF > ${WORKDIR}/asm-ig/variant/kustomization.yamlnamespace: asm-ingressresources:- ../base- role.yaml- rolebinding.yamlpatches:- path: service-proto-type.yaml\u00a0 target:\u00a0 \u00a0 kind: Service- path: gateway.yaml\u00a0 target:\u00a0 \u00a0 kind: GatewayEOF\n```\n- \u61c9\u7528\u5165\u7ad9\u6d41\u91cf\u7db2\u95dc CRD\uff1a```\nkubectl apply -k ${WORKDIR}/asm-ig/variant\n```\n- \u78ba\u4fdd\u6240\u6709\u90e8\u7f72\u90fd\u5df2\u5553\u52d5\u4e26\u904b\u884c\uff1a```\nkubectl wait --for=condition=available --timeout=600s deployment --all -n asm-ingress\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\ndeployment.apps/asm-ingressgateway condition met\n```\n### \u61c9\u7528\u670d\u52d9\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u7db2\u95dc\u5065\u5eb7\u6aa2\u67e5\n\u5c07\u670d\u52d9\u7db2\u683c\u5165\u7ad9\u6d41\u91cf\u7db2\u95dc\u96c6\u6210\u5230 Google Cloud \u61c9\u7528\u8ca0\u8f09\u5747\u8861\u5668\u6642\uff0c\u5fc5\u9808\u5c07\u61c9\u7528\u8ca0\u8f09\u5747\u8861\u5668\u914d\u7f6e\u7232\u91dd\u5c0d\u5165\u7ad9\u6d41\u91cf\u7db2\u95dc Pod \u57f7\u884c\u5065\u5eb7\u6aa2\u67e5\u3002 `HealthCheckPolicy` CRD \u63d0\u4f9b\u4e86\u4e00\u500b\u7528\u65bc\u914d\u7f6e\u8a72\u5065\u5eb7\u6aa2\u67e5\u7684 API\u3002\n- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa `HealthCheckPolicy.yaml` \u6587\u4ef6\uff1a```\ncat <<EOF >${WORKDIR}/ingress-gateway-healthcheck.yamlapiVersion: networking.gke.io/v1kind: HealthCheckPolicymetadata:\u00a0 name: ingress-gateway-healthcheck\u00a0 namespace: asm-ingressspec:\u00a0 default:\u00a0 \u00a0 checkIntervalSec: 20\u00a0 \u00a0 timeoutSec: 5\u00a0 \u00a0 #healthyThreshold: HEALTHY_THRESHOLD\u00a0 \u00a0 #unhealthyThreshold: UNHEALTHY_THRESHOLD\u00a0 \u00a0 logConfig:\u00a0 \u00a0 \u00a0 enabled: True\u00a0 \u00a0 config:\u00a0 \u00a0 \u00a0 type: HTTP\u00a0 \u00a0 \u00a0 httpHealthCheck:\u00a0 \u00a0 \u00a0 \u00a0 #portSpecification: USE_NAMED_PORT\u00a0 \u00a0 \u00a0 \u00a0 port: 15021\u00a0 \u00a0 \u00a0 \u00a0 portName: status-port\u00a0 \u00a0 \u00a0 \u00a0 #host: HOST\u00a0 \u00a0 \u00a0 \u00a0 requestPath: /healthz/ready\u00a0 \u00a0 \u00a0 \u00a0 #response: RESPONSE\u00a0 \u00a0 \u00a0 \u00a0 #proxyHeader: PROXY_HEADER\u00a0 \u00a0 #requestPath: /healthz/ready\u00a0 \u00a0 #port: 15021\u00a0 targetRef:\u00a0 \u00a0 group: \"\"\u00a0 \u00a0 kind: Service\u00a0 \u00a0 name: asm-ingressgatewayEOF\n```\n- \u61c9\u7528 `HealthCheckPolicy:````\nkubectl apply -f ${WORKDIR}/ingress-gateway-healthcheck.yaml\n```\n### \u5b9a\u7fa9\u5b89\u5168\u653f\u7b56\n[Google Cloud Armor](https://cloud.google.com/armor?hl=zh-cn) \u63d0\u4f9b\u7684 DDoS \u9632\u79a6\u548c [\u53ef\u81ea\u5b9a\u7fa9\u7684\u5b89\u5168\u7b56\u7565](https://cloud.google.com/armor/docs/configure-security-policies?hl=zh-cn) \u53ef\u901a\u904e Ingress \u8cc7\u6e90\u95dc\u806f\u81f3\u8ca0\u8f09\u5747\u8861\u5668\u3002\u5728\u4ee5\u4e0b\u6b65\u9a5f\u4e2d\uff0c\u60a8\u5c07\u5275\u5efa\u5b89\u5168\u653f\u7b56\uff0c\u4ee5\u4f7f\u7528 [\u9810\u914d\u7f6e\u898f\u5247](https://cloud.google.com/armor/docs/rule-tuning?hl=zh-cn#preconfigured_rules) \u4f86\u963b\u6b62\u8de8\u7ad9\u8173\u672c\u653b\u64ca (XSS)\u3002\u6b64\u898f\u5247\u6709\u52a9\u65bc\u963b\u6b62\u8207\u5df2\u77e5\u653b\u64ca\u7c3d\u540d\u5339\u914d\u7684\u6d41\u91cf\uff0c\u4f46\u5141\u8a31\u6240\u6709\u5176\u4ed6\u6d41\u91cf\u3002\u60a8\u7684\u74b0\u5883\u53ef\u80fd\u6839\u64da\u5de5\u4f5c\u8ca0\u8f09\u4f7f\u7528\u4e0d\u540c\u7684\u898f\u5247\u3002\n- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa\u4e00\u500b\u540d\u7232 `edge-fw-policy` \u7684\u5b89\u5168\u653f\u7b56\uff1a```\ngcloud compute security-policies create edge-fw-policy \\\u00a0 --description \"Block XSS attacks\"\n```\n- \u5275\u5efa\u4f7f\u7528\u9810\u914d\u7f6e XSS \u904e\u6ffe\u689d\u4ef6\u7684\u5b89\u5168\u653f\u7b56\u898f\u5247\uff1a```\ngcloud compute security-policies rules create 1000 \\\u00a0 \u00a0 --security-policy edge-fw-policy \\\u00a0 \u00a0 --expression \"evaluatePreconfiguredExpr('xss-stable')\" \\\u00a0 \u00a0 --action \"deny-403\" \\\u00a0 \u00a0 --description \"XSS attack filtering\"\n```\n- \u5275\u5efa `GCPBackendPolicy.yaml` \u6587\u4ef6\u4ee5\u9644\u52a0\u5230\u5165\u7ad9\u6d41\u91cf\u7db2\u95dc\u670d\u52d9\uff1a```\ncat <<EOF > ${WORKDIR}/cloud-armor-backendpolicy.yamlapiVersion: networking.gke.io/v1kind: GCPBackendPolicymetadata:\u00a0 name: cloud-armor-backendpolicy\u00a0 namespace: asm-ingressspec:\u00a0 default:\u00a0 \u00a0 securityPolicy: edge-fw-policy\u00a0 targetRef:\u00a0 \u00a0 group: \"\"\u00a0 \u00a0 kind: Service\u00a0 \u00a0 name: asm-ingressgatewayEOF\n```\n- \u61c9\u7528 `GCPBackendPolicy.yaml` \u6587\u4ef6\uff1a```\nkubectl apply -f ${WORKDIR}/cloud-armor-backendpolicy.yaml\n```\n### \u914d\u7f6e IP \u5c0b\u5740\u548c DNS\n- \u5728 Cloud Shell \u4e2d\uff0c\u7232 Google Cloud \u8ca0\u8f09\u5747\u8861\u5668\u5275\u5efa\u5168\u7403\u975c\u614b IP \u5730\u5740\uff1a```\ngcloud compute addresses create e2m-gclb-ip --global\n```\u6b64\u975c\u614b IP \u5730\u5740\u7531 GKE Gateway \u8cc7\u6e90\u4f7f\u7528\uff0c\u5373\u4f7f\u5916\u90e8\u8ca0\u8f09\u5747\u8861\u5668\u767c\u751f\u66f4\u6539\uff0c\u8a72 IP \u5730\u5740\u4e5f\u53ef\u4ee5\u4fdd\u6301\u4e0d\u8b8a\u3002\n- \u7372\u53d6\u975c\u614b IP \u5730\u5740\uff1a```\nexport GCLB_IP=$(gcloud compute addresses describe e2m-gclb-ip--global --format \"value(address)\")echo ${GCLB_IP}\n```\u5982\u9700\u91dd\u5c0d\u61c9\u7528\u8ca0\u8f09\u5747\u8861\u5668\u7684\u975c\u614b IP \u5730\u5740\u5275\u5efa\u6613\u65bc\u4f7f\u7528\u7684\u7a69\u5b9a\u6620\u5c04\uff0c\u60a8\u5fc5\u9808\u5177\u6709\u516c\u5171 DNS \u8a18\u9304\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u6240\u9700\u7684\u4efb\u4f55 DNS \u63d0\u4f9b\u5546\u548c\u81ea\u52d5\u5316\u529f\u80fd\u3002\u672c\u90e8\u7f72\u4f7f\u7528 [Endpoints](https://cloud.google.com/endpoints/docs?hl=zh-cn) \u800c\u4e0d\u662f\u5275\u5efa\u8a17\u7ba1\u5f0f DNS \u5340\u57df\u3002Endpoints \u7232\u516c\u5171 IP \u5730\u5740\u63d0\u4f9b\u514d\u8cbb\u7684 [Google \u7ba1\u7406\u7684 DNS \u8a18\u9304](https://cloud.google.com/endpoints/docs/openapi/cloud-goog-dns-configure?hl=zh-cn) \u3002\n- \u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u5275\u5efa\u540d\u7232 `dns-spec.yaml` \u7684 YAML \u898f\u7bc4\u6587\u4ef6\uff1a```\ncat <<EOF > ${WORKDIR}/dns-spec.yamlswagger: \"2.0\"info:\u00a0 description: \"Cloud Endpoints DNS\"\u00a0 title: \"Cloud Endpoints DNS\"\u00a0 version: \"1.0.0\"paths: {}host: \"frontend.endpoints.${PROJECT}.cloud.goog\"x-google-endpoints:- name: \"frontend.endpoints.${PROJECT}.cloud.goog\"\u00a0 target: \"${GCLB_IP}\"EOF\n```YAML \u898f\u7bc4\u4ee5 `frontend.endpoints.${PROJECT}.cloud.goog` \u7684\u5f62\u5f0f\u5b9a\u7fa9\u516c\u5171 DNS \u8a18\u9304\uff0c\u5176\u4e2d `${PROJECT}` \u662f\u60a8\u7684\u552f\u4e00\u9805\u76ee\u6a19\u8b58\u7b26\u3002\n- \u5728 Google Cloud \u9805\u76ee\u4e2d\u90e8\u7f72 `dns-spec.yaml` \u6587\u4ef6\uff1a```\ngcloud endpoints services deploy ${WORKDIR}/dns-spec.yaml\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nproject [e2m-doc-01]...\nOperation \"operations/acat.p2-892585880385-fb4a01ad-821d-4e22-bfa1-a0df6e0bf589\" finished successfully.\nService Configuration [2023-08-04r0] uploaded for service [frontend.endpoints.e2m-doc-01.cloud.goog]\n```\u5728\u914d\u7f6e IP \u5730\u5740\u548c DNS \u5f8c\uff0c\u60a8\u53ef\u4ee5\u751f\u6210\u516c\u5171\u8b49\u66f8\u4f86\u4fdd\u8b77\u524d\u7aef\u3002\u5982\u9700\u8207 GKE \u7db2\u95dc\u96c6\u6210\uff0c\u8acb\u4f7f\u7528 [Certificate Manager](https://cloud.google.com/certificate-manager/docs/overview?hl=zh-cn) TLS \u8b49\u66f8\u3002\n### \u9810\u914d TLS \u8b49\u66f8\n\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 [Certificate Manager](https://cloud.google.com/certificate-manager/docs/overview?hl=zh-cn) \u5275\u5efa TLS \u8b49\u66f8\uff0c\u4e26\u901a\u904e\u8b49\u66f8\u6620\u5c04\u689d\u76ee\u5c07\u5176\u8207 [\u8b49\u66f8\u6620\u5c04](https://cloud.google.com/certificate-manager/docs/how-it-works?hl=zh-cn) \u95dc\u806f\u3002\u901a\u904e GKE Gateway \u914d\u7f6e\u7684\u61c9\u7528\u8ca0\u8f09\u5747\u8861\u5668\u4f7f\u7528\u8a72\u8b49\u66f8\u5728\u5ba2\u6236\u7aef\u548c Google Cloud \u4e4b\u9593\u63d0\u4f9b\u5b89\u5168\u901a\u4fe1\u3002\u5275\u5efa\u8b49\u66f8\u6620\u5c04\u689d\u76ee\u5f8c\uff0cGKE Gateway \u8cc7\u6e90\u6703\u5f15\u7528\u8a72\u689d\u76ee\u3002\n- \u5728 Cloud Shell \u4e2d\uff0c\u5553\u7528 Certificate Manager API\uff1a```\ngcloud services enable certificatemanager.googleapis.com --project=${PROJECT}\n```\n- \u5275\u5efa TLS \u8b49\u66f8\uff1a```\ngcloud --project=${PROJECT} certificate-manager certificates create edge2mesh-cert \\\u00a0 \u00a0 --domains=\"frontend.endpoints.${PROJECT}.cloud.goog\"\n```\n- \u5275\u5efa\u8b49\u66f8\u6620\u5c04\uff1a```\ngcloud --project=${PROJECT} certificate-manager maps create edge2mesh-cert-map\n```\n- \u4f7f\u7528\u8b49\u66f8\u6620\u5c04\u689d\u76ee\u5c07\u8b49\u66f8\u8207\u8b49\u66f8\u6620\u5c04\u95dc\u806f\uff1a```\ngcloud --project=${PROJECT} certificate-manager maps entries create edge2mesh-cert-map-entry \\\u00a0 \u00a0 --map=\"edge2mesh-cert-map\" \\\u00a0 \u00a0 --certificates=\"edge2mesh-cert\" \\\u00a0 \u00a0 --hostname=\"frontend.endpoints.${PROJECT}.cloud.goog\"\n```\n### \u90e8\u7f72 GKE Gateway \u548c HTTPRoute \u8cc7\u6e90\n\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u914d\u7f6e GKE Gateway \u8cc7\u6e90\uff0c\u8a72\u8cc7\u6e90\u4f7f\u7528 `gke-l7-global-external-managed` [gatewayClass](https://cloud.google.com/kubernetes-engine/docs/concepts/gateway-api?hl=zh-cn#gatewayclass) \u9810\u914d Google Cloud \u61c9\u7528\u8ca0\u8f09\u5747\u8861\u5668\u3002\u6b64\u5916\uff0c\u60a8\u9084\u5c07\u914d\u7f6e [HTTPRoute](https://cloud.google.com/kubernetes-engine/docs/concepts/gateway-api?hl=zh-cn#httproute) \u8cc7\u6e90\uff0c\u6b64\u8cc7\u6e90\u5c07\u8acb\u6c42\u8def\u7531\u5230\u61c9\u7528\uff0c\u4e26\u57f7\u884c\u5f9e HTTP \u5230 HTTP(S) \u7684\u91cd\u5b9a\u5411\u3002\n- \u5728 Cloud Shell \u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u5c07 `Gateway` \u6e05\u55ae\u5275\u5efa\u7232 `gke-gateway.yaml` \uff1a```\ncat <<EOF > ${WORKDIR}/gke-gateway.yamlkind: GatewayapiVersion: gateway.networking.k8s.io/v1beta1metadata:\u00a0 name: external-http\u00a0 namespace: asm-ingress\u00a0 annotations:\u00a0 \u00a0 networking.gke.io/certmap: edge2mesh-cert-mapspec:\u00a0 gatewayClassName: gke-l7-global-external-managed # gke-l7-gxlb\u00a0 listeners:\u00a0 - name: http # list the port only so we can redirect any incoming http requests to https\u00a0 \u00a0 protocol: HTTP\u00a0 \u00a0 port: 80\u00a0 - name: https\u00a0 \u00a0 protocol: HTTPS\u00a0 \u00a0 port: 443\u00a0 addresses:\u00a0 - type: NamedAddress\u00a0 \u00a0 value: e2m-gclb-ip # reference the static IP created earlierEOF\n```\n- \u61c9\u7528 `Gateway` \u6e05\u55ae\u4ee5\u5275\u5efa\u4e00\u500b\u540d\u7232 `external-http` \u7684 `Gateway` \uff1a```\nkubectl apply -f ${WORKDIR}/gke-gateway.yaml\n```\n- \u5275\u5efa\u9ed8\u8a8d `HTTPRoute.yaml` \u6587\u4ef6\uff1a```\ncat << EOF > ${WORKDIR}/default-httproute.yamlapiVersion: gateway.networking.k8s.io/v1beta1kind: HTTPRoutemetadata:\u00a0 name: default-httproute\u00a0 namespace: asm-ingressspec:\u00a0 parentRefs:\u00a0 - name: external-http\u00a0 \u00a0 namespace: asm-ingress\u00a0 \u00a0 sectionName: https\u00a0 rules:\u00a0 - matches:\u00a0 \u00a0 - path:\u00a0 \u00a0 \u00a0 \u00a0 value: /\u00a0 \u00a0 backendRefs:\u00a0 \u00a0 - name: asm-ingressgateway\u00a0 \u00a0 \u00a0 port: 443EOF\n```\n- \u61c9\u7528\u9ed8\u8a8d\u7684 `HTTPRoute` \uff1a```\nkubectl apply -f ${WORKDIR}/default-httproute.yaml\n```\n- \u5275\u5efa\u4e00\u500b\u984d\u5916\u7684 `HTTPRoute.yaml` \u6587\u4ef6\u4ee5\u57f7\u884c\u5f9e HTTP \u5230 HTTP(S) \u7684\u91cd\u5b9a\u5411\uff1a```\ncat << EOF > ${WORKDIR}/default-httproute-redirect.yamlkind: HTTPRouteapiVersion: gateway.networking.k8s.io/v1beta1metadata:\u00a0 name: http-to-https-redirect-httproute\u00a0 namespace: asm-ingressspec:\u00a0 parentRefs:\u00a0 - name: external-http\u00a0 \u00a0 namespace: asm-ingress\u00a0 \u00a0 sectionName: http\u00a0 rules:\u00a0 - filters:\u00a0 \u00a0 - type: RequestRedirect\u00a0 \u00a0 \u00a0 requestRedirect:\u00a0 \u00a0 \u00a0 \u00a0 scheme: https\u00a0 \u00a0 \u00a0 \u00a0 statusCode: 301EOF\n```\n- \u61c9\u7528\u91cd\u5b9a\u5411 `HTTPRoute` \uff1a```\nkubectl apply -f ${WORKDIR}/default-httproute-redirect.yaml\n```\u5354\u8abf\u9700\u8981\u4e00\u4e9b\u6642\u9593\u3002\u5728 `programmed=true` \u4e4b\u524d\uff0c\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a```\nkubectl get gateway external-http -n asm-ingress -w\n```## \u5b89\u88dd Online Boutique \u793a\u4f8b\u61c9\u7528\n- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa\u4e00\u500b\u5c08\u7528\u7684 `onlineboutique` \u547d\u540d\u7a7a\u9593\uff1a```\nkubectl create namespace onlineboutique\n```\n- \u5411 `onlineboutique` \u547d\u540d\u7a7a\u9593\u6dfb\u52a0\u6a19\u7c64\uff1a```\nkubectl label namespace onlineboutique istio-injection=enabled\n```\u4f7f\u7528 `istio-injection=enabled` \u7232 `onlineboutique` \u547d\u540d\u7a7a\u9593\u6dfb\u52a0\u6a19\u7c64\u6703\u6307\u793a Anthos Service Mesh \u5728\u90e8\u7f72\u61c9\u7528\u6642\u81ea\u52d5\u6ce8\u5165 Envoy \u908a\u8eca\u4ee3\u7406\u3002\n- \u4e0b\u8f09 Online Boutique \u793a\u4f8b\u61c9\u7528\u7684 Kubernetes YAML \u6587\u4ef6\uff1a```\ncurl -LO \\https://raw.githubusercontent.com/GoogleCloudPlatform/microservices-demo/main/release/kubernetes-manifests.yaml\n```\n- \u90e8\u7f72 Online Boutique \u61c9\u7528\uff1a```\nkubectl apply -f kubernetes-manifests.yaml -n onlineboutique\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff08\u5305\u62ec\u6709\u95dc GKE Autopilot [\u8a2d\u7f6e\u9ed8\u8a8d\u8cc7\u6e90\u8acb\u6c42\u548c\u9650\u5236](https://cloud.google.com/kubernetes-engine/docs/concepts/autopilot-resource-requests?hl=zh-cn#defaults) \u7684\u8b66\u544a\uff09\uff1a```\nWarning: autopilot-default-resources-mutator:Autopilot updated Deployment onlineboutique/emailservice: adjusted resources to meet requirements for containers [server] (see http://g.co/gke/autopilot-resources)deployment.apps/emailservice createdservice/emailservice createdWarning: autopilot-default-resources-mutator:Autopilot updated Deployment onlineboutique/checkoutservice: adjusted resources to meet requirements for containers [server] (see http://g.co/gke/autopilot-resources)deployment.apps/checkoutservice createdservice/checkoutservice createdWarning: autopilot-default-resources-mutator:Autopilot updated Deployment onlineboutique/recommendationservice: adjusted resources to meet requirements for containers [server] (see http://g.co/gke/autopilot-resources)deployment.apps/recommendationservice createdservice/recommendationservice created...\n```\n- \u78ba\u4fdd\u6240\u6709\u90e8\u7f72\u90fd\u5df2\u5553\u52d5\u4e26\u904b\u884c\uff1a```\nkubectl get pods -n onlineboutique\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nNAME \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 READY \u00a0 STATUS \u00a0 \u00a0RESTARTS \u00a0 AGEadservice-64d8dbcf59-krrj9 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 2/2 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a02m59scartservice-6b77b89c9b-9qptn \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 2/2 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a02m59scheckoutservice-7668b7fc99-5bnd9 \u00a0 \u00a0 \u00a0 \u00a0 2/2 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a02m58s...\n```\u7b49\u5f85\u5e7e\u5206\u9418\uff0c\u8b93 GKE Autopilot \u96c6\u7fa3\u9810\u914d\u5fc5\u8981\u7684\u8a08\u7b97\u57fa\u790e\u8a2d\u65bd\u4ee5\u652f\u6301\u61c9\u7528\u3002\n- \u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5c07 `VirtualService` \u6e05\u55ae\u5275\u5efa\u7232 `frontend-virtualservice.yaml` \uff1a```\ncat <<EOF > frontend-virtualservice.yamlapiVersion: networking.istio.io/v1beta1kind: VirtualServicemetadata:\u00a0 name: frontend-ingress\u00a0 namespace: onlineboutiquespec:\u00a0 hosts:\u00a0 - \"frontend.endpoints.${PROJECT}.cloud.goog\"\u00a0 gateways:\u00a0 - asm-ingress/asm-ingressgateway\u00a0 http:\u00a0 - route:\u00a0 \u00a0 - destination:\u00a0 \u00a0 \u00a0 \u00a0 host: frontend\u00a0 \u00a0 \u00a0 \u00a0 port:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 number: 80EOF\n````VirtualService` \u662f\u5728\u61c9\u7528\u547d\u540d\u7a7a\u9593 ( `onlineboutique` ) \u4e2d\u5275\u5efa\u7684\u3002\u901a\u5e38\uff0c\u61c9\u7528\u6240\u6709\u8005\u6703\u6c7a\u5b9a\u4e26\u914d\u7f6e\u5c07\u6d41\u91cf\u8def\u7531\u5230 `frontend` \u61c9\u7528\u7684\u65b9\u5f0f\u548c\u5167\u5bb9\uff0c\u4ee5\u4fbf\u61c9\u7528\u6240\u6709\u8005\u90e8\u7f72 `VirtualService` \u3002\n- \u5728\u60a8\u7684\u96c6\u7fa3\u4e2d\u90e8\u7f72 `frontend-virtualservice.yaml` \uff1a```\nkubectl apply -f frontend-virtualservice.yaml\n```\n- \u8a2a\u554f\u4ee5\u4e0b\u93c8\u63a5\uff1a```\necho \"https://frontend.endpoints.${PROJECT}.cloud.goog\"\n```\u7cfb\u7d71\u6703\u986f\u793a\u60a8\u7684 Online Boutique \u524d\u7aef\u3002 **\u6ce8\u610f** \uff1a\u60a8\u53ef\u80fd\u6703\u9047\u5230 `ERR_SSL_VERSION_OR_CIPHER_MISMATCH` \u932f\u8aa4\u3002\u5982\u679c\u8b49\u66f8\u5c1a\u672a\u50b3\u64ad\u5230\u5168\u7403\u6240\u6709 Google Front End (GFE)\uff0c\u5c31\u6703\u767c\u751f\u6b64\u932f\u8aa4\u3002\u7b49\u5f85\u5e7e\u5206\u9418\uff0c\u7136\u5f8c\u518d\u6b21\u5617\u8a66\u93c8\u63a5\u3002\n- \u5982\u9700\u986f\u793a\u8b49\u66f8\u7684\u8a73\u60c5\uff0c\u8acb\u5728\u700f\u89bd\u5668\u7684\u5730\u5740\u6b04\u4e2d\u9ede\u64ca lock **\u67e5\u770b\u7ad9\u9ede\u4fe1\u606f** \uff0c\u7136\u5f8c\u9ede\u64ca **\u8b49\u66f8\uff08\u6709\u6548\uff09** \u3002\u8b49\u66f8\u67e5\u770b\u5668\u6703\u986f\u793a\u4ee3\u7ba1\u8b49\u66f8\u7684\u8a73\u60c5\uff0c\u5305\u62ec\u5230\u671f\u65e5\u671f\u548c\u9812\u767c\u8b49\u66f8\u7684\u4eba\u3002\n\u73fe\u5728\uff0c\u60a8\u6709\u4e00\u500b\u5168\u7403 HTTPS \u8ca0\u8f09\u5747\u8861\u5668\uff0c\u4f5c\u7232\u670d\u52d9\u7db2\u683c\u8a17\u7ba1\u61c9\u7528\u7684\u524d\u7aef\u3002\n## \u6e05\u7406\n\u5b8c\u6210\u672c\u90e8\u7f72\u5f8c\uff0c\u60a8\u53ef\u4ee5\u6e05\u7406\u60a8\u5728 Google Cloud \u4e0a\u5275\u5efa\u7684\u8cc7\u6e90\uff0c\u4ee5\u514d\u9019\u4e9b\u8cc7\u6e90\u5c07\u4f86\u7522\u751f\u8cbb\u7528\u3002\u60a8\u53ef\u4ee5\u5fb9\u5e95\u522a\u9664\u9805\u76ee\uff0c\u4e5f\u53ef\u4ee5\u522a\u9664\u96c6\u7fa3\u8cc7\u6e90\uff0c\u7136\u5f8c\u522a\u9664\u96c6\u7fa3\u3002\n### \u522a\u9664\u9805\u76ee- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- **\u8b66\u544a** \uff1a\u522a\u9664\u9805\u76ee\u6703\u7522\u751f\u4ee5\u4e0b\u5f71\u97ff- **\u9805\u76ee\u4e2d\u7684\u6240\u6709\u5167\u5bb9\u90fd\u6703\u88ab\u522a\u9664\u3002** \u5982\u679c\u60a8\u5c07\u73fe\u6709\u9805\u76ee\u7528\u65bc\u672c\u6587\u6a94\u4e2d\u7684\u4efb\u52d9\uff0c\u5247\u522a\u9664\u8a72\u9805\u76ee\u5f8c\uff0c\u9084\u5c07\u522a\u9664\u60a8\u5df2\u5728\u8a72\u9805\u76ee\u4e2d\u5b8c\u6210\u7684\u4efb\u4f55\u5176\u4ed6\u5de5\u4f5c\u3002\n- **\u81ea\u5b9a\u7fa9\u9805\u76ee ID \u4e1f\u5931\u3002** \u5275\u5efa\u6b64\u9805\u76ee\u6642\uff0c\u60a8\u53ef\u80fd\u5275\u5efa\u4e86\u8981\u5728\u5c07\u4f86\u4f7f\u7528\u7684\u81ea\u5b9a\u7fa9\u9805\u76ee ID\u3002\u8981\u4fdd\u7559\u4f7f\u7528\u8a72\u9805\u76ee ID \u7684\u7db2\u5740\uff08\u4f8b\u5982`appspot.com`\u7db2\u5740\uff09\uff0c\u8acb\u522a\u9664\u9805\u76ee\u5167\u7684\u6240\u9078\u8cc7\u6e90\uff0c\u800c\u4e0d\u662f\u522a\u9664\u6574\u500b\u9805\u76ee\u3002\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u9032\u5165 **\u7ba1\u7406\u8cc7\u6e90** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u7ba1\u7406\u8cc7\u6e90\u201d](https://console.cloud.google.com/iam-admin/projects?hl=zh-cn) \n- \u5728\u9805\u76ee\u5217\u8868\u4e2d\uff0c\u9078\u64c7\u8981\u522a\u9664\u7684\u9805\u76ee\uff0c\u7136\u5f8c\u9ede\u64ca **\u522a\u9664** \u3002\n- \u5728\u5c0d\u8a71\u6846\u4e2d\u8f38\u5165\u9805\u76ee ID\uff0c\u7136\u5f8c\u9ede\u64ca **\u95dc\u9589** \u4ee5\u522a\u9664\u9805\u76ee\u3002### \u9010\u500b\u522a\u9664\u8cc7\u6e90\n\u5982\u679c\u60a8\u5e0c\u671b\u4fdd\u7559\u5728\u6b64\u90e8\u7f72\u4e2d\u4f7f\u7528\u7684 Google Cloud \u9805\u76ee\uff0c\u8acb\u522a\u9664\u55ae\u500b\u8cc7\u6e90\uff1a\n- \u5728 Cloud Shell \u4e2d\uff0c\u522a\u9664 `HTTPRoute` \u8cc7\u6e90\uff1a```\nkubectl delete -f ${WORKDIR}/default-httproute-redirect.yamlkubectl delete -f ${WORKDIR}/default-httproute.yaml\n```\n- \u522a\u9664 GKE Gateway \u8cc7\u6e90\uff1a```\nkubectl delete -f ${WORKDIR}/gke-gateway.yaml\n```\n- \u522a\u9664 TLS \u8b49\u66f8\u8cc7\u6e90\uff08\u5305\u62ec\u8b49\u66f8\u6620\u5c04\u689d\u76ee\u53ca\u5176\u7236\u8b49\u66f8\u6620\u5c04\uff09\uff1a```\ngcloud --project=${PROJECT} certificate-manager maps entries delete edge2mesh-cert-map-entry --map=\"edge2mesh-cert-map\" --quietgcloud --project=${PROJECT} certificate-manager maps delete edge2mesh-cert-map --quietgcloud --project=${PROJECT} certificate-manager certificates delete edge2mesh-cert --quiet\n```\n- \u522a\u9664 Endpoints DNS \u689d\u76ee\uff1a```\ngcloud endpoints services delete \"frontend.endpoints.${PROJECT}.cloud.goog\"\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nAre you sure? This will set the service configuration to be deleted, along\nwith all of the associated consumer information. Note: This does not\nimmediately delete the service configuration or data and can be undone using\nthe undelete command for 30 days. Only after 30 days will the service be\npurged from the system.\n```\n- \u7576\u7cfb\u7d71\u63d0\u793a\u60a8\u7e7c\u7e8c\u6642\uff0c\u8acb\u8f38\u5165 \u3002\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nWaiting for async operation operations/services.frontend.endpoints.edge2mesh.cloud.goog-5 to complete...\nOperation finished successfully. The following command can describe the Operation details:\n gcloud endpoints operations describe operations/services.frontend.endpoints.edge2mesh.cloud.goog-5\n```\n- \u522a\u9664\u975c\u614b IP \u5730\u5740\uff1a```\ngcloud compute addresses delete ingress-ip --global\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nThe following global addresses will be deleted:\n - [ingress-ip]\n```\n- \u7576\u7cfb\u7d71\u63d0\u793a\u60a8\u7e7c\u7e8c\u6642\uff0c\u8acb\u8f38\u5165 \u3002\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nDeleted\n[https://www.googleapis.com/compute/v1/projects/edge2mesh/global/addresses/ingress-ip].\n```\n- \u522a\u9664 GKE \u96c6\u7fa3\uff1a```\ngcloud container clusters delete $CLUSTER_NAME --zone $CLUSTER_LOCATION\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nThe following clusters will be deleted.- [edge-to-mesh] in [us-central1]\n```\n- \u7576\u7cfb\u7d71\u63d0\u793a\u60a8\u7e7c\u7e8c\u6642\uff0c\u8acb\u8f38\u5165 \u3002\u5e7e\u5206\u9418\u5f8c\uff0c\u8f38\u51fa\u5982\u4e0b\u5167\u5bb9\uff1a```\nDeleting cluster edge-to-mesh...done.Deleted[https://container.googleapis.com/v1/projects/e2m-doc-01/zones/us-central1/clusters/edge-to-mesh].\n```## \u5f8c\u7e8c\u6b65\u9a5f\n- \u77ad\u89e3 [GKE Ingress \u63d0\u4f9b\u7684\u53ef\u8207\u670d\u52d9\u7db2\u683c\u914d\u5408\u4f7f\u7528\u7684\u66f4\u591a\u529f\u80fd](https://cloud.google.com/kubernetes-engine/docs/how-to/ingress-configuration?hl=zh-cn) \u3002\n- \u77ad\u89e3 [\u9069\u7528\u65bc GKE \u7684\u4e0d\u540c\u985e\u578b\u7684 Cloud Load Balancing](https://cloud.google.com/blog/products/containers-kubernetes/exposing-services-on-gke?hl=zh-cn) \u3002\n- \u77ad\u89e3 [Anthos Service Mesh \u63d0\u4f9b\u7684\u529f\u80fd](https://cloud.google.com/service-mesh/docs/overview?hl=zh-cn) \u3002\n- \u77ad\u89e3\u5982\u4f55 [\u8de8\u591a\u500b GKE \u96c6\u7fa3\u90e8\u7f72 Ingress \u4ee5\u5be6\u73fe\u591a\u5730\u5340\u8ca0\u8f09\u5747\u8861](https://cloud.google.com/kubernetes-engine/docs/concepts/ingress-for-anthos?hl=zh-cn) \u3002\n- \u5982\u9700\u67e5\u770b\u66f4\u591a\u53c3\u8003\u67b6\u69cb\u3001\u5716\u8868\u548c\u6700\u4f73\u5be6\u8e10\uff0c\u8acb\u700f\u89bd [\u96f2\u67b6\u69cb\u4e2d\u5fc3](https://cloud.google.com/architecture?hl=zh-cn) \u3002", "guide": "Docs"}