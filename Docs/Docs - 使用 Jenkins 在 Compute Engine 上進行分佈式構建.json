{"title": "Docs - \u4f7f\u7528 Jenkins \u5728 Compute Engine \u4e0a\u9032\u884c\u5206\u4f48\u5f0f\u69cb\u5efa", "url": "https://cloud.google.com/architecture/using-jenkins-for-distributed-builds-on-compute-engine?hl=zh-cn", "abstract": "# Docs - \u4f7f\u7528 Jenkins \u5728 Compute Engine \u4e0a\u9032\u884c\u5206\u4f48\u5f0f\u69cb\u5efa\n\u672c\u6559\u7a0b\u5c07\u4ecb\u7d39\u5982\u4f55\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u5275\u5efa Jenkins \u6301\u7e8c\u96c6\u6210\u7cfb\u7d71\uff0c\u4ee5\u4f7f\u7528 Compute Engine \u4e2d\u7684\u6309\u9700 Jenkins \u4ee3\u7406\u904b\u884c\u69cb\u5efa\u3002\n- \u5c07\u69cb\u5efa\u5de5\u4ef6\u5b58\u5132\u5728 Cloud Storage \u4e2d\u3002\n- \u61c9\u7528\u751f\u547d\u9031\u671f\u653f\u7b56\uff0c\u5c07 Cloud Storage \u4e2d\u8f03\u820a\u7684\u69cb\u5efa\u5de5\u4ef6\u79fb\u52d5\u5230\u50f9\u683c\u8f03\u4f4e\u7684\u5b58\u5132\u65b9\u5f0f\u4e2d\u3002\n", "content": "## \u67b6\u69cb\u4e0b\u5716\u5c55\u793a\u4e86\u6559\u7a0b\u67b6\u69cb\u3002\u5728\u8a72\u5716\u4e2d\uff0cJenkins \u4e2d\u6dfb\u52a0\u4e86\u4e00\u500b\u670d\u52d9\u8cec\u865f\uff0cJenkins \u53ef\u901a\u904e\u8a72\u8cec\u865f\u5275\u5efa\u4ee3\u7406\u5be6\u4f8b\u4e26\u5c07\u5de5\u4ef6\u63a8\u9001\u5230 Cloud Storage \u9032\u884c\u9577\u671f\u5b58\u5132\u3002Jenkins \u5728\u904b\u884c\u69cb\u5efa\u6642\u5373\u6642\u9810\u914d\u5be6\u4f8b\u3002\u96a8\u7740\u69cb\u5efa\u5de5\u4ef6\u7684\u8001\u5316\uff0c\u5b83\u5011\u6703\u5728\u5404\u7a2e\u5b58\u5132\u985e\u5225\u4e4b\u9593\u79fb\u52d5\uff0c\u4ee5\u9650\u5236\u4fdd\u7559\u8cbb\u7528\u3002## \u76ee\u6a19\n- \u4f7f\u7528 [Packer](https://www.packer.io/docs) \u5275\u5efa\u57fa\u672c\u6620\u50cf\uff0c\u4ee5\u904b\u884c Jenkins \u69cb\u5efa\u3002\n- \u4f7f\u7528 [Cloud Marketplace](https://cloud.google.com/marketplace/docs?hl=zh-cn) \u9810\u914d Jenkins\u3002\n- \u914d\u7f6e Jenkins\uff0c\u4ee5\u90e8\u7f72\u81e8\u6642\u69cb\u5efa\u4ee3\u7406\u3002\n- \u5c07\u69cb\u5efa\u5de5\u4ef6\u4e0a\u50b3\u5230 Cloud Storage\u3002\n- \u914d\u7f6e\u751f\u547d\u9031\u671f\u653f\u7b56\uff0c\u4ee5\u512a\u5316 Cloud Storage \u8cbb\u7528\u3002\n## \u8cbb\u7528\nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728\u672c\u6587\u6a94\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Google Cloud \u7684\u4ee5\u4e0b\u6536\u8cbb\u7d44\u4ef6\uff1a- Compute Engine\n- Cloud Storage\n\u60a8\u53ef\u4f7f\u7528 [\u50f9\u683c\u8a08\u7b97\u5668](https://cloud.google.com/products/calculator?hl=zh-cn) \u6839\u64da\u60a8\u7684\u9810\u8a08\u4f7f\u7528\u60c5\u6cc1\u4f86\u4f30\u7b97\u8cbb\u7528\u3002 \n\u8acb\u4f7f\u7528 [\u50f9\u683c\u8a08\u7b97\u5668](https://cloud.google.com/products/calculator?hl=zh-cn) \u6839\u64da\u60a8\u7684\u9810\u8a08\u4f7f\u7528\u60c5\u6cc1\u4f86\u4f30\u7b97\u8cbb\u7528\u3002## \u6e96\u5099\u5de5\u4f5c\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them## \u8a2d\u7f6e\u74b0\u5883\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u914d\u7f6e\u5b8c\u6210\u672c\u6559\u7a0b\u6240\u9700\u7684\u57fa\u790e\u67b6\u69cb\u548c\u8eab\u4efd\u3002\u60a8\u53ef\u4ee5\u5f9e Cloud Shell \u5167\u90e8\u57f7\u884c\u672c\u6559\u7a0b\u7684\u5176\u9918\u6b65\u9a5f\u3002\n [\u6253\u958b Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn) \n### \u914d\u7f6e IAM\u5275\u5efa \u8eab\u4efd\u548c\u8a2a\u554f\u6b0a\u9650\u7ba1\u7406 (IAM) \u670d\u52d9\u8cec\u865f\u4ee5\u5c07\u6b0a\u9650\u59d4\u6d3e\u7d66 Jenkins\u3002\u901a\u904e\u6b64\u8cec\u865f\uff0cJenkins \u53ef\u4ee5\u5c07\u6578\u64da\u5b58\u5132\u5728 Cloud Storage \u4e2d\uff0c\u4e26\u5553\u52d5 Compute Engine \u4e2d\u7684\u5be6\u4f8b\u3002Jenkins \u5728\u81e8\u6642\u5be6\u4f8b\u4e2d\u904b\u884c\u69cb\u5efa\uff0c\u4e26\u5c07\u69cb\u5efa\u5de5\u4ef6\u5b58\u5132\u5728 Cloud Storage \u4e2d\u3002\n- \u5275\u5efa\u670d\u52d9\u8cec\u865f\uff1a```\ngcloud iam service-accounts create jenkins --display-name jenkins\n```\n- \u5c07\u670d\u52d9\u8cec\u865f\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\u548c\u60a8\u7684\u7576\u524d Google Cloud \u9805\u76ee ID \u5b58\u5132\u5728\u74b0\u5883\u8b8a\u91cf\u4e2d\uff0c\u4ee5\u4f9b\u5f8c\u7e8c\u547d\u4ee4\u4f7f\u7528\uff1a```\nexport SA_EMAIL=$(gcloud iam service-accounts list \\\n --filter=\"displayName:jenkins\" --format='value(email)')\nexport PROJECT=$(gcloud info --format='value(config.project)')\n```\n- \u5c07\u4ee5\u4e0b\u89d2\u8272\u8207\u60a8\u7684\u670d\u52d9\u8cec\u865f\u7d81\u5b9a\uff1a```\ngcloud projects add-iam-policy-binding $PROJECT \\\n --role roles/storage.admin --member serviceAccount:$SA_EMAIL\ngcloud projects add-iam-policy-binding $PROJECT --role roles/compute.instanceAdmin.v1 \\\n --member serviceAccount:$SA_EMAIL\ngcloud projects add-iam-policy-binding $PROJECT --role roles/compute.networkAdmin \\\n --member serviceAccount:$SA_EMAIL\ngcloud projects add-iam-policy-binding $PROJECT --role roles/compute.securityAdmin \\\n --member serviceAccount:$SA_EMAIL\ngcloud projects add-iam-policy-binding $PROJECT --role roles/iam.serviceAccountActor \\\n --member serviceAccount:$SA_EMAIL\n```\n\u73fe\u5728\uff0c\u60a8\u5df2\u7d93\u7232\u670d\u52d9\u8cec\u865f\u6388\u4e88\u4e86\u76f8\u61c9\u7684\u6b0a\u9650\uff0c\u63a5\u4e0b\u4f86\u9700\u8981\u5275\u5efa\u4e26\u4e0b\u8f09\u5176\u5bc6\u9470\u3002\u8acb\u5c07\u5bc6\u9470\u4fdd\u5b58\u5728\u5b89\u5168\u7684\u4f4d\u7f6e\u3002\u5728\u7a0d\u5f8c\u7684\u6b65\u9a5f\u4e2d\uff0c\u7576\u60a8\u914d\u7f6e JClouds \u63d2\u4ef6\u4ee5\u4f7f\u7528 Compute Engine API \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u6642\uff0c\u5c07\u7528\u5230\u6b64\u5bc6\u9470\u3002- \u5275\u5efa\u5bc6\u9470\u6587\u4ef6\uff1a```\ngcloud iam service-accounts keys create jenkins-sa.json --iam-account $SA_EMAIL\n```\n- \u5728 Cloud Shell \u4e2d\uff0c\u9ede\u64ca **\u66f4\u591a** \uff0c\u7136\u5f8c\u9ede\u64ca **\u4e0b\u8f09\u6587\u4ef6** \u3002\n- \u8f38\u5165 `jenkins-sa.json` \u3002\n- \u9ede\u64ca **\u4e0b\u8f09** \u4ee5\u5728\u672c\u5730\u4fdd\u5b58\u6587\u4ef6\u3002\n### \u5275\u5efa Jenkins \u4ee3\u7406\u6620\u50cf\u63a5\u4e0b\u4f86\uff0c\u60a8\u5c07\u5275\u5efa\u4e00\u500b\u53ef\u91cd\u8907\u4f7f\u7528\u7684 Compute Engine \u6620\u50cf\uff0c\u5b83\u5305\u542b\u4f5c\u7232 Jenkins \u57f7\u884c\u7a0b\u5e8f\u904b\u884c\u6240\u9700\u7684\u8edf\u4ef6\u548c\u5de5\u5177\u3002\u5728\u672c\u6559\u7a0b\u7684\u5f8c\u9762\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 [Packer](https://www.packer.io/intro#what-is-packer) \u69cb\u5efa\u6620\u50cf\uff0c\u6b64\u64cd\u4f5c\u9700\u8981\u4f7f\u7528 `ssh` \u547d\u4ee4\u8207\u69cb\u5efa\u5be6\u4f8b\u9032\u884c\u901a\u4fe1\u3002\u5982\u9700\u5553\u7528 SSH \u8a2a\u554f\u6b0a\u9650\uff0c\u8acb\u5728 Cloud Shell \u4e2d\u5275\u5efa\u4e26\u4e0a\u50b3 SSH \u5bc6\u9470\uff1a- \u5275\u5efa SSH \u5bc6\u9470\u5c0d\u3002\u5982\u679c\u5df2\u5b58\u5728\u4e00\u500b\u5bc6\u9470\u5c0d\uff0c\u5247\u6b64\u547d\u4ee4\u5c07\u4f7f\u7528\u8a72\u5bc6\u9470\u5c0d\uff1b\u5426\u5247\uff0c\u5b83\u6703\u5275\u5efa\u4e00\u500b\u65b0\u7684\u5bc6\u9470\u5c0d\uff1a```\nls ~/.ssh/id_rsa.pub || ssh-keygen -N \"\"\n```\n- \u5c07 Cloud Shell SSH \u516c\u9470\u6dfb\u52a0\u5230\u9805\u76ee\u7684 [\u5143\u6578\u64da](https://cloud.google.com/compute/docs/connect/add-ssh-keys?hl=zh-cn#add_ssh_keys_to_project_metadata) \u4e2d\uff1a```\ngcloud compute project-info describe \\\n --format=json | jq -r '.commonInstanceMetadata.items[] | select(.key == \"ssh-keys\") | .value' > sshKeys.pub\necho \"$USER:$(cat ~/.ssh/id_rsa.pub)\" >> sshKeys.pub\ngcloud compute project-info add-metadata --metadata-from-file ssh-keys=sshKeys.pub\n```\n\u4e0b\u4e00\u6b65\u662f\u4f7f\u7528 [Packer](http://packer.io) \u7232\u69cb\u5efa\u4ee3\u7406\u5275\u5efa\u57fa\u6e96\u865b\u64ec\u6a5f (VM) \u6620\u50cf\uff0c\u9019\u4e9b\u6620\u50cf\u5728 Jenkins \u4e2d\u5145\u7576\u81e8\u6642\u69cb\u5efa\u57f7\u884c\u7a0b\u5e8f\u3002\u6700\u57fa\u672c\u7684 Jenkins \u4ee3\u7406\u53ea\u9700\u8981\u5b89\u88dd Java\u3002\u60a8\u53ef\u4ee5\u81ea\u5b9a\u7fa9\u6620\u50cf\uff0c\u65b9\u6cd5\u662f\u5728 Packer \u914d\u7f6e\u7684 `provisioners` \u90e8\u5206\u4e2d\u6dfb\u52a0 shell \u547d\u4ee4\uff0c\u6216\u6dfb\u52a0\u5176\u4ed6 [Packer \u9810\u914d\u5de5\u5177](https://www.packer.io/docs/provisioners) \u3002- \u5728 Cloud Shell \u4e2d\uff0c\u4e0b\u8f09\u4e26\u89e3\u58d3\u7e2e Packer \u7684\u6700\u65b0\u7248\u672c\u3002\u4ee5\u4e0b\u793a\u4f8b\u4f7f\u7528\u7684\u662f Packer 1.7.10\u3002\u60a8\u53ef\u4ee5 [\u8a2a\u554f Hashicorp \u7db2\u7ad9](https://www.packer.io/downloads) \uff0c\u67e5\u770b\u662f\u5426\u6709\u8f03\u65b0\u7684\u7248\u672c\uff1a```\nwget https://releases.hashicorp.com/packer/1.7.10/packer_1.7.10_linux_amd64.zip\nunzip packer_1.7.10_linux_amd64.zip\n```\n- \u7232 Packer \u6620\u50cf\u69cb\u5efa\u5275\u5efa\u914d\u7f6e\u6587\u4ef6\uff1a```\nexport PROJECT=$(gcloud info --format='value(config.project)')\ncat > jenkins-agent.json <<EOF\n{\n \"builders\": [ {\n  \"type\": \"googlecompute\",\n  \"project_id\": \"$PROJECT\",\n  \"source_image_family\": \"ubuntu-2004-lts\",\n  \"source_image_project_id\": \"ubuntu-os-cloud\",\n  \"zone\": \"us-central1-a\",\n  \"disk_size\": \"50\",\n  \"image_name\": \"jenkins-agent-{{timestamp}}\",\n  \"image_family\": \"jenkins-agent\",\n  \"ssh_username\": \"ubuntu\"\n }\n ],\n \"provisioners\": [ {\n  \"type\": \"shell\",\n  \"inline\": [\"sudo apt-get update && sudo apt-get install -y default-jdk\"]\n }\n ]\n}\nEOF\n```\n- \u901a\u904e\u904b\u884c Packer \u69cb\u5efa\u6620\u50cf\uff1a```\n./packer build jenkins-agent.json\n```\u69cb\u5efa\u5b8c\u6210\u5f8c\uff0c\u78c1\u76e4\u6620\u50cf\u7684\u540d\u7a31\u5c07\u4ee5 `jenkins-agent-[TIMESTAMP]` \u683c\u5f0f\u986f\u793a\uff0c\u5176\u4e2d `[TIMESTAMP]` \u662f\u69cb\u5efa\u958b\u59cb\u7684\u7d00\u5143\u6642\u9593\u3002```\n==> Builds finished. The artifacts of successful builds are:\n--> googlecompute: A disk image was created: jenkins-agent-1612997575\n```\n## \u5b89\u88dd Jenkins\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 [Cloud Marketplace](https://cloud.google.com/marketplace?hl=zh-cn) \u9810\u914d Jenkins \u5be6\u4f8b\u3002\u60a8\u53ef\u4ee5\u81ea\u5b9a\u7fa9\u8a72\u5be6\u4f8b\uff0c\u4ee5\u4f7f\u7528\u60a8\u5728\u4e0a\u4e00\u90e8\u5206\u4e2d\u5275\u5efa\u7684\u4ee3\u7406\u6620\u50cf\u3002- \u8f49\u5230 [Jenkins \u7684 Cloud Marketplace \u89e3\u6c7a\u65b9\u6848](https://console.cloud.google.com/marketplace/details/bitnami-launchpad/jenkins?q=jenkins&hl=zh-cn) \u3002\n- \u9ede\u64ca **\u5553\u52d5** \u3002\n- \u5c07 **\u6a5f\u5668\u985e\u578b** \u5b57\u6bb5\u66f4\u6539\u7232 **4 vCPUs 15 GB Memory, n1-standard-4** \u3002 \n- \u9ede\u64ca **\u90e8\u7f72** \uff0c\u5f85 Jenkins \u5be6\u4f8b\u5b8c\u6210\u9810\u914d\u3002\u5b8c\u6210\u5f8c\uff0c\u60a8\u5c07\u770b\u5230\u5982\u4e0b\u5167\u5bb9\uff1a \n- \u9ede\u64ca **\u7db2\u5740** \u93c8\u63a5\uff0c\u5728\u700f\u89bd\u5668\u4e2d\u6253\u958b Jenkins \u5be6\u4f8b\u3002\n- \u4f7f\u7528\u8a73\u7d30\u4fe1\u606f\u7a97\u683c\u4e2d\u986f\u793a\u7684 **\u7ba1\u7406\u54e1\u7528\u6236** \u548c **\u7ba1\u7406\u54e1\u5bc6\u78bc** \u767b\u9304 Jenkins\u3002 \n\u73fe\u5728\uff0c\u60a8\u4fbf\u53ef\u4ee5\u4f7f\u7528\u60a8\u7684 Jenkins \u5be6\u4f8b\u3002## \u914d\u7f6e Jenkins \u63d2\u4ef6Jenkins \u8981\u6c42\u63d2\u4ef6\u5728 Compute Engine \u4e2d\u5275\u5efa\u6309\u9700\u4ee3\u7406\uff0c\u4e26\u5728 Cloud Storage \u4e2d\u5b58\u5132\u5de5\u4ef6\u3002\u60a8\u9700\u8981\u5b89\u88dd\u4e26\u914d\u7f6e\u9019\u4e9b\u63d2\u4ef6\u3002\n### \u5b89\u88dd\u63d2\u4ef6\n- \u5728 Jenkins \u754c\u9762\u4e2d\uff0c\u9078\u64c7 **Manage Jenkins** \u3002\n- \u9ede\u64ca **Manage Plugins** \u3002\n- \u9ede\u64ca **Available** \u6a19\u7c64\u9801\u3002\n- \u4f7f\u7528 **Filter** \u6b04\u627e\u5230\u4ee5\u4e0b\u63d2\u4ef6\uff0c\u7136\u5f8c\u52fe\u9078\u5176\u65c1\u908a\u7684\u8907\u9078\u6846\uff1a- Compute Engine \u63d2\u4ef6\n- Cloud Storage \u63d2\u4ef6\n\u5728\u4e0b\u5716\u4e2d\uff0cCloud Storage \u63d2\u4ef6\u8655\u65bc\u9078\u4e2d\u72c0\u614b\uff1a \n- \u9ede\u64ca **Download now and install after restart** \u3002\n- \u9ede\u64ca **Restart Jenkins when installation is complete and no jobs are running** \u8907\u9078\u6846\u3002Jenkins \u5c07\u6703\u91cd\u5553\u4e26\u5b8c\u6210\u63d2\u4ef6\u5b89\u88dd\u3002\n### \u5275\u5efa\u63d2\u4ef6\u6191\u64da\u60a8\u9700\u8981\u7232\u65b0\u63d2\u4ef6\u5275\u5efa `Google Credentials` \uff1a- \u518d\u6b21\u767b\u9304 Jenkins\uff0c\u7136\u5f8c\u9ede\u64ca **\u7ba1\u7406 Jenkins** \u3002\n- \u9ede\u64ca **Credentials** \u3002\n- \u9ede\u64ca **\u5b58\u5132** \u4e0b\u7684 **Jenkins** \u3002\n- \u5728\u754c\u9762\u7684\u4e3b\u7a97\u683c\u4e2d\uff0c\u9ede\u64ca **\u5168\u5c40\u6191\u64da\uff08\u4e0d\u53d7\u9650\u5236\uff09** \u3002\n- \u5275\u5efa Google \u6191\u64da\uff1a- \u9ede\u64ca **Add Credentials** \u3002\n- \u5c07 **Kind** \u8a2d\u7f6e\u7232 **Google Service Account from private key** \u3002\n- \u5728 **Project Name** \u5b57\u6bb5\u4e2d\uff0c\u8f38\u5165\u60a8\u7684 Google Cloud \u9805\u76ee ID\u3002\n- \u9ede\u64ca **Choose file** \u3002\n- \u9078\u64c7\u4e4b\u524d\u5f9e Cloud Shell \u4e0b\u8f09\u7684`jenkins-sa.json`\u6587\u4ef6\u3002\n- \u9ede\u64ca **OK** \u3002 \n- \u9ede\u64ca **Jenkins** \u3002\n### \u914d\u7f6e Compute Engine \u63d2\u4ef6\u60a8\u53ef\u4ee5\u4f7f\u7528\u7528\u65bc\u9810\u914d\u4ee3\u7406\u5be6\u4f8b\u7684\u6191\u64da\u4f86\u914d\u7f6e Compute Engine \u63d2\u4ef6\u3002- \u9ede\u64ca **Manage Jenkins** \u3002\n- \u9ede\u64ca **Manage Nodes and Clouds** \u3002\n- \u9ede\u64ca **Configure Clouds** \u3002\n- \u9ede\u64ca **Add a new Cloud** \u3002\n- \u9ede\u64ca **Compute Engine** \u3002\n- \u8a2d\u7f6e\u4ee5\u4e0b\u8a2d\u7f6e\uff0c\u4e26\u5c07 `[YOUR_PROJECT_ID]` \u66ff\u63db\u7232\u60a8\u7684 Google Cloud \u9805\u76ee ID\uff1a- **Name** \uff1a`gce`\n- **Project ID** \uff1a`[YOUR_PROJECT_ID]`\n- **Instance Cap** \uff1a`8`\n- \u5f9e **Service Account Credentials** \u4e0b\u62c9\u5217\u8868\u4e2d\u9078\u64c7\u76f8\u61c9\u670d\u52d9\u8cec\u865f\u3002\u8a72\u8cec\u865f\u4ee5 Google Cloud \u9805\u76ee ID \u7684\u5f62\u5f0f\u5217\u51fa\u3002\n### \u914d\u7f6e Jenkins \u5be6\u4f8b\u73fe\u5728\uff0cCompute Engine \u63d2\u4ef6\u5df2\u914d\u7f6e\u5b8c\u7562\uff0c\u63a5\u4e0b\u4f86\u60a8\u53ef\u4ee5\u91dd\u5c0d\u81ea\u5df1\u504f\u597d\u7684\u5404\u7a2e\u69cb\u5efa\u914d\u7f6e\u4f86\u9032\u884c Jenkins \u5be6\u4f8b\u7684\u914d\u7f6e\u3002- \u5728 **Configure Clouds** \u9801\u9762\u4e0a\uff0c\u91dd\u5c0d **Instance Configurations** \u9ede\u64ca **Add** \u3002\n- \u8f38\u5165\u4ee5\u4e0b **\u5e38\u898f** \u8a2d\u7f6e\uff1a- **Name** \uff1a`ubuntu-2004`\n- **Description** \uff1a`Ubuntu agent`\n- **Labels** \uff1a`ubuntu-2004`\n- \u5728 **Location** \u8a2d\u7f6e\u4e2d\uff0c\u8f38\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a- **Region<** \uff1a`us-central1`\n- **Zone** \uff1a`us-central1-f`\n- \u9ede\u64ca **Advanced** \u3002\n- \u5728 **Machine Configuration** \u7684 **Machine Type** \u90e8\u5206\uff0c\u9078\u64c7 **n1-standard-1** \u3002\n- \u5728 **Networking** \u4e0b\uff0c\u9078\u64c7\u4ee5\u4e0b\u8a2d\u7f6e\uff1a- **Network** \uff1a\u4fdd\u7559\u9ed8\u8a8d\u8a2d\u7f6e\u3002\n- **Subnetwork** \uff1a\u4fdd\u7559\u9ed8\u8a8d\u8a2d\u7f6e\u3002\n- \u9078\u64c7 **Attach External IP?** \u3002\n- \u5728 **Boot Disk** \u8a2d\u7f6e\u4e2d\uff0c\u9078\u64c7\u4ee5\u4e0b\u5167\u5bb9\uff1a- \u5c0d\u65bc **Image project** \uff0c\u8acb\u9078\u64c7\u60a8\u7684 Google Cloud \u9805\u76ee\u3002\n- \u5c0d\u65bc **Image name** \uff0c\u8acb\u9078\u64c7\u4e4b\u524d\u4f7f\u7528 Packer \u69cb\u5efa\u7684\u6620\u50cf\u3002\n- \u9ede\u64ca **Save** \u4ee5\u4fdd\u7559\u914d\u7f6e\u66f4\u6539\u3002 \n## \u5275\u5efa Jenkins \u4f5c\u696d\u4ee5\u6e2c\u8a66\u914d\u7f6e\u5c07 Jenkins \u914d\u7f6e\u7232\u5728\u89f8\u767c\u9700\u8981\u5177\u6709 `ubuntu-2004` \u6a19\u7c64\u7684\u4ee3\u7406\u7684\u4f5c\u696d\u6642\u81ea\u52d5\u5553\u52d5\u5be6\u4f8b\u3002\u5275\u5efa\u4e00\u500b\u53ef\u4ee5\u6e2c\u8a66\u914d\u7f6e\u662f\u5426\u6309\u9810\u671f\u5de5\u4f5c\u7684\u4f5c\u696d\u3002- \u9ede\u64ca Jenkins \u754c\u9762\u4e2d\u7684 **Create new job** \u3002\n- \u8f38\u5165`test`\u4f5c\u7232\u9805\u540d\u7a31\u3002\n- \u9ede\u64ca **Freestyle project** \uff0c\u7136\u5f8c\u9ede\u64ca **OK** \u3002\n- \u9078\u4e2d **Execute concurrent builds if necessary** \u548c **Restrict where this project can run** \u8907\u9078\u6846\u3002\n- \u5728 **Label Expression** \u5b57\u6bb5\u4e2d\uff0c\u8f38\u5165`ubuntu-2004`\u3002\n- \u5728 **\u69cb\u5efa** \u90e8\u5206\u4e2d\uff0c\u9ede\u64ca **\u6dfb\u52a0\u69cb\u5efa\u6b65\u9a5f** \u3002\n- \u9ede\u64ca **\u57f7\u884c Shell** \u3002\n- \u5728\u547d\u4ee4\u6846\u4e2d\uff0c\u8f38\u5165\u6e2c\u8a66\u5b57\u7b26\u4e32\uff1a```\necho \"Hello world!\"\n``` \n- \u9ede\u64ca **Save** \u3002\n- \u9ede\u64ca **Build Now** \u4ee5\u958b\u59cb\u69cb\u5efa\u3002 \n## \u5c07\u69cb\u5efa\u5de5\u4ef6\u4e0a\u50b3\u5230 Cloud Storage\u60a8\u53ef\u80fd\u9700\u8981\u5b58\u5132\u69cb\u5efa\u5de5\u4ef6\uff0c\u4ee5\u4f9b\u5c07\u4f86\u9032\u884c\u5206\u6790\u6216\u6e2c\u8a66\u3002 \u60a8\u53ef\u4ee5\u914d\u7f6e\u4e00\u9805 Jenkins \u4f5c\u696d\uff0c\u4ee5\u751f\u6210\u5de5\u4ef6\u4e26\u5c07\u5176\u4e0a\u50b3\u5230 Cloud Storage\u3002\u69cb\u5efa\u65e5\u8a8c\u6703\u4e0a\u50b3\u5230\u540c\u4e00\u500b\u5b58\u5132\u5206\u5340\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u7232\u5de5\u4ef6\u5275\u5efa\u5b58\u5132\u5206\u5340\uff1a```\nexport PROJECT=$(gcloud info --format='value(config.project)')\ngsutil mb gs://$PROJECT-jenkins-artifacts\n```\n- \u5728 Jenkins \u754c\u9762\u7684\u4f5c\u696d\u5217\u8868\u4e2d\uff0c\u9ede\u64ca **test** \u3002\n- \u9ede\u64ca **Configure** \u3002\n- \u5728 **Build** \u4e0b\uff0c\u5c07 **Command** \u6587\u672c\u5b57\u6bb5\u8a2d\u7f6e\u7232\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nenv > build_environment.txt\n```\n- \u5728 **Post-build Actions** \u4e0b\uff0c\u9ede\u64ca **Add post-build action** \u3002\n- \u9ede\u64ca **Cloud Storage Plugin** \u3002\n- \u5728 **Storage Location** \u5b57\u6bb5\u4e2d\uff0c\u8f38\u5165\u5de5\u4ef6\u8def\u5f91\uff0c\u4e26\u5c07 `[YOUR_PROJECT_ID]` \u66ff\u63db\u7232\u60a8\u7684 Google Cloud \u9805\u76ee ID\uff1a```\ngs://[YOUR_PROJECT_ID]-jenkins-artifacts/$JOB_NAME/$BUILD_NUMBER\n```\n- \u9ede\u64ca **Add Operation** \u3002\n- \u9ede\u64ca **Classic Upload** \u3002\n- \u5728 **File Pattern** \u5b57\u6bb5\u4e2d\uff0c\u8f38\u5165 `build_environment.txt` \u3002\n- \u5728 **Storage Location** \u5b57\u6bb5\u4e2d\uff0c\u8f38\u5165\u5b58\u5132\u8def\u5f91\uff0c\u4e26\u5c07 `[YOUR_PROJECT_ID]` \u66ff\u63db\u7232\u60a8\u7684 Google Cloud \u9805\u76ee ID\uff1a```\ngs://[YOUR_PROJECT_ID]-jenkins-artifacts/$JOB_NAME/$BUILD_NUMBER\n``` \n- \u9ede\u64ca **Save** \u3002\n- \u9ede\u64ca **Build Now** \u4ee5\u958b\u59cb\u65b0\u7684\u69cb\u5efa\u3002\u6b64\u69cb\u5efa\u6703\u5728\u60a8\u4e4b\u524d\u9810\u914d\u7684 Compute Engine \u5be6\u4f8b\u4e0a\u904b\u884c\u3002\u69cb\u5efa\u5b8c\u6210\u5f8c\uff0c\u5b83\u6703\u5c07\u5de5\u4ef6\u6587\u4ef6 `build_environment.txt` \u4e0a\u50b3\u5230\u5df2\u914d\u7f6e\u7684 Cloud Storage \u5b58\u5132\u5206\u5340\u3002\n- \u5728 Cloud Shell \u4e2d\uff0c\u4f7f\u7528 `gsutil` \u67e5\u770b\u69cb\u5efa\u5de5\u4ef6\uff1a```\nexport PROJECT=$(gcloud info --format='value(config.project)')\ngsutil cat gs://$PROJECT-jenkins-artifacts/test/2/build_environment.txt\n```\n## \u914d\u7f6e\u5c0d\u8c61\u751f\u547d\u9031\u671f\u7ba1\u7406\u60a8\u901a\u5e38\u6703\u8a2a\u554f\u6700\u8fd1\u7684\u69cb\u5efa\u5de5\u4ef6\u3002\u7232\u4e86\u7bc0\u7701\u4e0d\u5e38\u8a2a\u554f\u7684\u5c0d\u8c61\u7684\u8cbb\u7528\uff0c\u8acb\u4f7f\u7528 [\u5c0d\u8c61\u751f\u547d\u9031\u671f\u7ba1\u7406](https://cloud.google.com/storage/docs/lifecycle?hl=zh-cn) \u529f\u80fd\u5c07\u5de5\u4ef6\u5f9e\u9ad8\u6027\u80fd [\u5b58\u5132\u985e\u5225](https://cloud.google.com/storage/docs/storage-classes?hl=zh-cn) \u8f49\u79fb\u5230\u8cbb\u7528\u4f4e\u5ec9\u3001\u6975\u7232\u6301\u4e45\u7684\u5b58\u5132\u985e\u5225\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa [\u751f\u547d\u9031\u671f\u914d\u7f6e](https://cloud.google.com/storage/docs/lifecycle?hl=zh-cn#configuration) \u6587\u4ef6\uff0c\u4ee5\u4fbf\u5728 30 \u5929\u540e\u5c07\u6240\u6709\u5c0d\u8c61\u8f49\u79fb\u5230 [Nearline](https://cloud.google.com/storage/docs/storage-classes?hl=zh-cn#nearline) \u5b58\u5132\u7a7a\u9593\uff0c\u4e26\u5728 365 \u5929\u540e\u5c07 Nearline \u5c0d\u8c61\u8f49\u79fb\u5230 [Coldline](https://cloud.google.com/storage/docs/storage-classes?hl=zh-cn#coldline) \u5b58\u5132\u7a7a\u9593\u3002```\ncat > artifact-lifecycle.json <<EOF\n{\n\"lifecycle\": {\n \"rule\": [ {\n \"action\": {\n  \"type\": \"SetStorageClass\",\n  \"storageClass\": \"NEARLINE\"\n },\n \"condition\": {\n  \"age\": 30,\n  \"matchesStorageClass\": [\"MULTI_REGIONAL\", \"STANDARD\", \"DURABLE_REDUCED_AVAILABILITY\"]\n }\n },\n {\n \"action\": {\n  \"type\": \"SetStorageClass\",\n  \"storageClass\": \"COLDLINE\"\n },\n \"condition\": {\n  \"age\": 365,\n  \"matchesStorageClass\": [\"NEARLINE\"]\n }\n }\n]\n}\n}\nEOF\n```\n- \u5c07\u914d\u7f6e\u6587\u4ef6\u4e0a\u50b3\u5230\u5de5\u4ef6\u5b58\u5132\u5206\u5340\uff1a```\nexport PROJECT=$(gcloud info --format='value(config.project)')\ngsutil lifecycle set artifact-lifecycle.json gs://$PROJECT-jenkins-artifacts\n```\n## \u6e05\u9664\u6578\u64da\n- \u522a\u9664\u4ecd\u5728\u904b\u884c\u7684\u6240\u6709 Jenkins \u4ee3\u7406\uff1a```\ngcloud compute instances list --filter=metadata.jclouds-group=ubuntu-2004 --uri | xargs gcloud compute instances delete\n```\n- \u4f7f\u7528 Cloud Deployment Manager \u522a\u9664 Jenkins \u5be6\u4f8b\uff1a```\ngcloud deployment-manager deployments delete jenkins-1\n```\n- \u522a\u9664 Cloud Storage \u5b58\u5132\u5206\u5340\uff1a```\nexport PROJECT=$(gcloud info --format='value(config.project)')\ngsutil -m rm -r gs://$PROJECT-jenkins-artifacts\n```\n- \u522a\u9664\u670d\u52d9\u8cec\u865f\uff1a```\nexport SA_EMAIL=$(gcloud iam service-accounts list --filter=\"displayName:jenkins\" --format='value(email)')\ngcloud iam service-accounts delete $SA_EMAIL\n```\n## \u5f8c\u7e8c\u6b65\u9a5f\n- [\u77ad\u89e3\u5982\u4f55\u4f7f\u7528 Jenkins \u9032\u884c\u6301\u7e8c\u90e8\u7f72](https://cloud.google.com/solutions/continuous-delivery-jenkins-kubernetes-engine?hl=zh-cn) \n- [\u5c07 Jenkins \u90e8\u7f72\u5230 Kubernetes Engine](https://cloud.google.com/solutions/jenkins-on-kubernetes-engine-tutorial?hl=zh-cn) \n- \u63a2\u7d22\u6709\u95dc Google Cloud \u7684\u53c3\u8003\u67b6\u69cb\u3001\u5716\u8868\u548c\u6700\u4f73\u505a\u6cd5\u3002\u67e5\u770b\u6211\u5011\u7684 [Cloud Architecture Center](https://cloud.google.com/architecture?hl=zh-cn) \u3002", "guide": "Docs"}