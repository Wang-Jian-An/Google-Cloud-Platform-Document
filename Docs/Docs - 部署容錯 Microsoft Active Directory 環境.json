{"title": "Docs - \u90e8\u7f72\u5bb9\u932f Microsoft Active Directory \u74b0\u5883", "url": "https://cloud.google.com/compute/docs/tutorials/setup-active-directory?hl=zh-cn", "abstract": "# Docs - \u90e8\u7f72\u5bb9\u932f Microsoft Active Directory \u74b0\u5883\n\u672c\u6559\u7a0b\u662f\u7cfb\u5217\u6559\u7a0b\u4e2d\u7684\u7b2c\u4e00\u7bc7\uff0c\u53ef\u5e6b\u52a9\u60a8\u4f7f\u7528 Microsoft Active Directory\u3001SQL Server \u548c Internet Information Services (IIS) \u5728 Google Cloud \u4e0a\u90e8\u7f72\u9ad8\u53ef\u7528\u6027 Windows \u67b6\u69cb\u3002\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u901a\u904e Active Directory \u4f7f\u7528\u65b0\u7684 Virtual Private Cloud (VPC) \u7db2\u7d61\u548c\u591a\u500b\u5b50\u7db2\u8a2d\u7f6e\u5177\u5099\u5197\u9918\u6027\u7684\u4e00\u5c0d Windows \u7db2\u57df\u63a7\u5236\u5668\u3002\n\u672c\u7cfb\u5217\u6559\u7a0b\u5305\u542b\u4ee5\u4e0b\u5167\u5bb9\uff1a- \u90e8\u7f72\u5bb9\u932f Microsoft Active Directory \u74b0\u5883\uff08\u672c\u6587\u6a94\uff09\n- [\u90e8\u7f72\u591a\u5b50\u7db2 SQL Server](https://cloud.google.com/architecture/deploy-multi-subnet-sql-server?hl=zh-cn) \n- [\u90e8\u7f72\u8ca0\u8f09\u5e73\u8861 IIS \u7db2\u7d61\u670d\u52d9\u5668](https://cloud.google.com/architecture/deploy-load-balanced-iis-web-servers?hl=zh-cn) \n\u6bcf\u500b\u6559\u7a0b\u90fd\u57fa\u65bc\u60a8\u5728\u4e0a\u4e00\u500b\u6559\u7a0b\u4e2d\u5275\u5efa\u7684\u57fa\u790e\u67b6\u69cb\u3002\n\u60a8\u9084\u53ef\u4ee5\u4f7f\u7528\u672c\u6559\u7a0b\u5b78\u7fd2\u5982\u4f55\u8a2d\u7f6e Active Directory \u914d\u7f6e\uff0c\u4ee5\u5728\u5176\u4ed6\u67b6\u69cb\u4e2d\u4f7f\u7528\u3002\u672c\u6307\u5357\u672a\u4ecb\u7d39\u5982\u4f55\u5c07\u9060\u7a0b Active Directory \u74b0\u5883\u8907\u88fd\u5230\u65b0\u7684\u57fa\u65bc Google Cloud \u7684 Active Directory \u74b0\u5883\uff0c\u4e0d\u904e\u6b64\u64cd\u4f5c\u53ef\u4ee5\u901a\u904e Cloud VPN \u548c\u5176\u4ed6 Active Directory \u914d\u7f6e\u4f86\u5be6\u73fe\u3002\n#", "content": "## \u67b6\u69cb\n## \u76ee\u6a19\n- \u5275\u5efa\u5305\u542b\u5169\u500b\u5b50\u7db2\uff08\u8de8\u5169\u500b\u5730\u5340\uff09\u7684\u81ea\u5b9a\u7fa9\u6a21\u5f0f VPC \u7db2\u7d61\u3002\n- \u5275\u5efa Windows Server \u865b\u64ec\u5be6\u4f8b\u4e26\u5553\u7528 Active Directory \u7db2\u57df\u670d\u52d9\u3002\n- \u4f7f\u7528 Active Directory \u914d\u7f6e\u65b0\u7db2\u57df\u3002\n- \u5c07\u65b0\u7684 Windows Server \u5be6\u4f8b\u806f\u63a5\u5230\u65b0\u7db2\u57df\u3002\n- \u914d\u7f6e\u9632\u706b\u7246\u898f\u5247\uff0c\u4ee5\u5141\u8a31\u6d41\u91cf\u9032\u5165\u865b\u64ec\u6a5f\u3002\n- \u6e2c\u8a66\u8a72\u914d\u7f6e\u3002\n## \u8cbb\u7528\u672c\u6559\u7a0b\u4f7f\u7528 Google Cloud \u7684\u4ee5\u4e0b\u6536\u8cbb\u7d44\u4ef6\uff1a- [Compute Engine](https://cloud.google.com/compute?hl=zh-cn) \n- [Persistent Disk](https://cloud.google.com/persistent-disk?hl=zh-cn) \n\u7d93 [\u50f9\u683c\u8a08\u7b97\u5668](https://cloud.google.com/products/calculator?hl=zh-cn#id=f1e0652a-76e4-402d-8694-b73681607893) \u4f30\u7b97\uff0c\u8a72\u74b0\u5883\u7684\u8cbb\u7528\u7d04\u7232 $4/\u5929\u3002## \u6e96\u5099\u5de5\u4f5c\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728 Google Cloud Console \u4e2d\u7684\u9805\u76ee\u9078\u64c7\u5668\u9801\u9762\u4e0a\uff0c\u9078\u64c7\u6216 [\u5275\u5efa\u4e00\u500b Google Cloud \u9805\u76ee](https://cloud.google.com/resource-manager/docs/creating-managing-projects?hl=zh-cn) \u3002 **\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u4e0d\u6253\u7b97\u4fdd\u7559\u5728\u6b64\u904e\u7a0b\u4e2d\u5275\u5efa\u7684\u8cc7\u6e90\uff0c\u8acb\u5275\u5efa\u65b0\u7684\u9805\u76ee\uff0c\u800c\u4e0d\u8981\u9078\u64c7\u73fe\u6709\u7684\u9805\u76ee\u3002\u5b8c\u6210\u672c\u6559\u7a0b\u4ecb\u7d39\u7684\u6b65\u9a5f\u5f8c\uff0c\u60a8\u53ef\u4ee5\u522a\u9664\u6240\u5275\u5efa\u7684\u9805\u76ee\uff0c\u4e26\u79fb\u9664\u8207\u8a72\u9805\u76ee\u95dc\u806f\u7684\u6240\u6709\u8cc7\u6e90\u3002 [\u8f49\u5230\u201c\u9805\u76ee\u9078\u64c7\u5668\u201d](https://console.cloud.google.com/projectselector2/home/dashboard?hl=zh-cn) \n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them [\u78ba\u4fdd\u60a8\u7684 Google Cloud \u9805\u76ee\u5df2\u5553\u7528\u7d50\u7b97\u529f\u80fd](https://cloud.google.com/billing/docs/how-to/verify-billing-enabled?hl=zh-cn#console) \u3002\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5553\u7528 Compute Engine API\u3002 [\u5553\u7528 API](https://console.cloud.google.com/flows/enableapi?apiid=compute&hl=zh-cn) \n## \u521d\u59cb\u5316\u901a\u7528\u8b8a\u91cf\u60a8\u5fc5\u9808\u5b9a\u7fa9\u5e7e\u500b\u7528\u65bc\u63a7\u5236\u5728\u4f55\u8655\u90e8\u7f72\u57fa\u790e\u67b6\u69cb\u5143\u7d20\u7684\u74b0\u5883\u8b8a\u91cf\u3002- \u8f49\u81f3 Cloud Shell\u3002 [\u6253\u958b Cloud Shell](https://console.cloud.google.com/cloudshell?hl=zh-cn) \n- \u5728 Cloud Shell \u4e2d\u5275\u5efa\u4ee5\u4e0b\u74b0\u5883\u8b8a\u91cf\uff0c\u4ee5\u8a2d\u7f6e\u5728\u672c\u6559\u7a0b\u5f8c\u9762\u7684\u90e8\u5206\u9700\u8981\u4f7f\u7528\u7684\u503c\u3002\u9019\u4e9b\u547d\u4ee4\u5c07\u5730\u5340\u8a2d\u7f6e\u7232 `us-east-1` \u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u5176\u4ed6\u5730\u5340\uff0c\u4f46\u8acb\u8a18\u4f4f\u60a8\u4f7f\u7528\u7684\u5730\u5340\uff0c\u4ee5\u4fbf\u53ef\u4ee5\u5728\u5f8c\u7e8c\u6559\u7a0b\u4e2d\u4f7f\u7528\u6b64\u5730\u5340\u3002```\nexport region=us-east1\nexport zone_1=${region}-b\nexport zone_2=${region}-c\nexport vpc_name=webappnet\nexport project_id=your-project-id\n```\u5c07 \u66ff\u63db\u7232\u60a8\u6b63\u5728\u4f7f\u7528\u7684 Google Cloud \u9805\u76ee\u7684 ID\u3002\n- \u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u8a2d\u7f6e\u9ed8\u8a8d\u5340\u57df\u548c\u9805\u76ee ID\uff0c\u9019\u6a23\u60a8\u5c31\u4e0d\u5fc5\u5728\u6bcf\u500b\u5f8c\u7e8c\u547d\u4ee4\u4e2d\u6307\u5b9a\u9019\u4e9b\u503c\uff1a```\ngcloud config set compute/region ${region}\ngcloud config set project ${project_id}\n```\n## \u5275\u5efa\u7db2\u7d61\u57fa\u790e\u67b6\u69cb\u5b9a\u7fa9\u57fa\u790e\u67b6\u69cb\u8b8a\u91cf\u5f8c\uff0c\u5373\u53ef\u5275\u5efa Active Directory \u5c07\u4f7f\u7528\u7684\u7db2\u7d61\u548c\u5b50\u7db2\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u5275\u5efa VPC \u7db2\u7d61\uff1a```\ngcloud compute networks create ${vpc_name} \\\n --description \"VPC network to deploy Active Directory\" \\\n --subnet-mode custom\n```\u60a8\u5c07\u770b\u5230\u4ee5\u4e0b\u8b66\u544a\uff0c\u53ef\u4ee5\u5ffd\u7565\u8a72\u8b66\u544a\uff0c\u56e0\u7232\u60a8\u5c07\u5728\u5f8c\u7e8c\u6b65\u9a5f\u4e2d\u5275\u5efa\u9019\u4e9b\u9632\u706b\u7246\u898f\u5247\u3002```\nInstances on this network will not be reachable until firewall rules\nare created.\n```\n- \u5c07\u5169\u500b\u5b50\u7db2\u6dfb\u52a0\u5230 VPC \u7db2\u7d61\uff1a```\ngcloud compute networks subnets create private-ad-zone-1 \\\n --network ${vpc_name} \\\n --range 10.1.0.0/24\ngcloud compute networks subnets create private-ad-zone-2 \\\n --network ${vpc_name} \\\n --range 10.2.0.0/24\n```\n- \u5275\u5efa\u5167\u90e8\u9632\u706b\u7246\u898f\u5247\uff0c\u4ee5\u5141\u8a31\u5b50\u7db2\u4e4b\u9593\u50b3\u905e\u6d41\u91cf\uff1a```\ngcloud compute firewall-rules create allow-internal-ports-private-ad \\\n --network ${vpc_name} \\\n --allow tcp:1-65535,udp:1-65535,icmp \\\n --source-ranges 10.1.0.0/24,10.2.0.0/24\n``` **\u6ce8\u610f** \uff1a\u5728\u751f\u7522\u74b0\u5883\u4e2d\uff0c\u6700\u4f73\u505a\u6cd5\u662f\u4fdd\u8b77\u7cfb\u7d71\u7576\u524d\u672a\u4f7f\u7528\u7684\u6240\u6709\u7aef\u53e3\u3002\u4f7f\u7528 [\u5821\u58d8\u4e3b\u6a5f](https://cloud.google.com/solutions/connecting-securely?hl=zh-cn#bastion) \u4fdd\u8b77\u5c0d\u8a08\u7b97\u6a5f\u7684\u8a2a\u554f\u4e5f\u662f\u4e00\u7a2e\u6700\u4f73\u505a\u6cd5\u3002\n- \u5275\u5efa\u9632\u706b\u7246\u898f\u5247\uff0c\u4ee5\u5141\u8a31\u5f9e\u4efb\u610f\u4f4d\u7f6e\u5728\u7aef\u53e3 `3389` \u4e0a\u4f7f\u7528 RDP \u9023\u63a5\uff1a```\ngcloud compute firewall-rules create allow-rdp \\\n --network ${vpc_name} \\\n --allow tcp:3389 \\\n --source-ranges 0.0.0.0/0\n```\n## \u5275\u5efa\u7b2c\u4e00\u500b\u7db2\u57df\u63a7\u5236\u5668\u63a5\u4e0b\u4f86\uff0c\u60a8\u5c07\u5275\u5efa\u4e00\u500b\u5177\u6709\u4ee5\u4e0b\u5c6c\u6027\u7684\u7db2\u57df\u63a7\u5236\u5668\uff1a- \u540d\u7a31\uff1a`ad-dc1`\n- IP \u5730\u5740\uff1a`10.1.0.100`\n- \u5275\u5efa Windows Server 2016 \u7684 Compute Engine \u5be6\u4f8b\u4ee5\u7528\u4f5c\u7b2c\u4e00\u500b\u7db2\u57df\u63a7\u5236\u5668\uff1a```\ngcloud compute instances create ad-dc1 --machine-type n1-standard-2 \\\n --boot-disk-type pd-ssd \\\n --boot-disk-size 50GB \\\n --image-family windows-2016 --image-project windows-cloud \\\n --network ${vpc_name} \\\n --zone ${zone_1} --subnet private-ad-zone-1 \\\n --private-network-ip=10.1.0.100\n``` **\u6ce8\u610f** \uff1a\u60a8\u53ef\u4ee5\u6839\u64da\u9810\u671f\u7684\u9700\u6c42\u589e\u52a0\u5553\u52d5\u78c1\u76e4\u7684\u5927\u5c0f\u3002\n- \u8acb\u7b49\u5f85\u4e00\u5206\u9418\u5de6\u53f3\uff0c\u7136\u5f8c\u7232 Windows \u5be6\u4f8b `ad-dc1` \u5275\u5efa\u4e00\u500b\u5bc6\u78bc\uff1a```\ngcloud compute reset-windows-password ad-dc1 --zone ${zone_1} --quiet\n```\u7528\u6236\u540d\u662f\u60a8\u7684 Google \u5e33\u865f\u7528\u6236\u540d\u3002\u8acb\u8a18\u597d\u7528\u6236\u540d\u548c\u5bc6\u78bc\uff0c\u4ee5\u5099\u5c07\u4f86\u4f7f\u7528\u3002 **\u6ce8\u610f** \uff1a\u5982\u679c\u5be6\u4f8b\u672a\u6e96\u5099\u597d\u63a5\u53d7\u8acb\u6c42\uff0c\u60a8\u5c07\u770b\u5230\u4ee5\u4e0b\u932f\u8aa4\u6d88\u606f\u3002\u5982\u679c\u51fa\u73fe\u6b64\u60c5\u6cc1\uff0c\u8acb\u904e\u5e7e\u5206\u9418\u5f8c\u91cd\u8a66\u8a72\u547d\u4ee4\u3002 `ERROR: (gcloud.compute.reset-windows-password) The instance may not be ready for use. This can occur if the instance was recently created or if the instance is not running Windows. Please wait a few minutes and try again.`\n- \u4f7f\u7528\u60a8\u5728\u4e0a\u4e00\u6b65\u4e2d\u5275\u5efa\u7684\u6191\u64da\uff0c\u901a\u904e RDP \u9023\u63a5\u5230\u7db2\u57df\u63a7\u5236\u5668\u5be6\u4f8b\u3002\n- \u4ee5\u7ba1\u7406\u54e1\u8eab\u4efd\u6253\u958b PowerShell \u7d42\u7aef\u3002\uff08\u9ede\u64ca **\u958b\u59cb** \uff0c\u8f38\u5165 **PowerShell** \uff0c\u7136\u5f8c\u6309 \u3002\uff09\n- \u8a2d\u7f6e\u7ba1\u7406\u54e1\u5e33\u865f\u7684 Windows \u6191\u64da\uff1a```\nnet user Administrator *\n``` **\u6ce8\u610f** \uff1a\u8981\u5c07\u547d\u4ee4\u7c98\u8cbc\u5230 PowerShell \u7d42\u7aef\uff0c\u8acb\u6309 \u3002\u7cfb\u7d71\u6703\u63d0\u793a\u60a8\u5275\u5efa\u5bc6\u78bc\u3002\u8acb\u4f7f\u7528\u5b89\u5168\u4fc2\u6578\u9ad8\u7684\u5bc6\u78bc\uff0c\u4e26\u5c07\u5bc6\u78bc\u5b58\u5132\u5728\u5b89\u5168\u7684\u4f4d\u7f6e\u4ee5\u5099\u5c07\u4f86\u4f7f\u7528\u3002\u60a8\u4f7f\u7528\u7ba1\u7406\u54e1\u5e33\u865f\u5275\u5efa [Active Directory \u6797](https://technet.microsoft.com/en-us/library/cc759073(v=ws.10).aspx) \u5f8c\uff0c\u8a72\u5e33\u865f\u5c07\u6210\u7232\u7db2\u57df\u7ba1\u7406\u54e1\u5e33\u865f\u3002\n- \u5553\u7528\u5e33\u865f\uff1a```\nnet user Administrator /active:yes\n```\n- \u5b89\u88dd Active Directory \u7db2\u57df\u670d\u52d9\uff0c\u5305\u62ec\u7ba1\u7406\u5de5\u5177\uff1a```\nInstall-WindowsFeature -Name AD-Domain-Services -IncludeManagementTools\n```\n- \u8a2d\u7f6e\u4ee5\u4e0b\u8b8a\u91cf\uff1a```\n$DomainName = \"example-gcp.com\"\n$DomainMode = \"7\"\n$ForestMode = \"7\"\n$DatabasePath = \"C:\\Windows\\NTDS\"\n$SysvolPath = \"C:\\Windows\\SYSVOL\"\n$LogPath = \"C:\\Logs\"\n```\n- \u5728 Windows Server 2016 \u6a21\u5f0f\u4e0b\u5b89\u88dd\u65b0\u7684 Active Directory \u6797\u914d\u7f6e\uff1a```\nInstall-ADDSForest -CreateDnsDelegation:$false `\n -DatabasePath $DatabasePath `\n -LogPath $LogPath `\n -SysvolPath $SysvolPath `\n -DomainName $DomainName `\n -DomainMode $DomainMode `\n -ForestMode $ForestMode `\n -InstallDNS:$true `\n -NoRebootOnCompletion:$true `\n -Force:$true\n```\n- \u51fa\u73fe\u63d0\u793a\u6642\uff0c\u8f38\u5165\u201c\u5b89\u5168\u6a21\u5f0f\u7ba1\u7406\u54e1\u201d\u5bc6\u78bc\u3002\u5c07\u5bc6\u78bc\u5b58\u5132\u5728\u5b89\u5168\u7684\u4f4d\u7f6e\u4ee5\u5099\u5c07\u4f86\u4f7f\u7528\u3002\n- \u5ffd\u7565\u4ee5\u4e0b\u8b66\u544a\u3002\u6bcf\u500b\u8b66\u544a\u5c07\u51fa\u73fe\u5169\u6b21\uff0c\u4e00\u6b21\u662f\u5728\u524d\u63d0\u689d\u4ef6\u9a57\u8b49\u671f\u9593\uff0c\u53e6\u4e00\u6b21\u662f\u5728\u5b89\u88dd\u904e\u7a0b\u4e2d\u3002```\nWARNING: Windows Server 2016 domain controllers have a default for the\nsecurity setting named Allow cryptography algorithms compatible with\nWindows NT 4.0 that prevents weaker cryptography algorithms when\nestablishing security channel sessions.\nFor more information about this setting, see Knowledge Base article 942564\n(http://go.microsoft.com/fwlink/?LinkId=104751).\n``````\nWARNING: This computer has at least one physical network adapter that does\nnot have static IP address(es) assigned to its IP Properties. If both IPv4\nand IPv6 are enabled for a network adapter, both IPv4 and IPv6 static IP\naddresses should be assigned to both IPv4 and IPv6 Properties of the\nphysical network adapter. Such static IP address(es) assignment should be\ndone to all the physical network adapters for reliable Domain Name\nSystem (DNS) operation.\n``````\nWARNING: A delegation for this DNS server cannot be created because the\nauthoritative parent zone cannot be found or it does not run Windows DNS\nserver. If you are integrating with an existing DNS infrastructure, you\nshould manually create a delegation to this DNS server in the parent zone\nto ensure reliable name resolution from outside the domain \"example-gcp.com\".\nOtherwise, no action is required.\n```\n- \u91cd\u5553\u865b\u64ec\u6a5f\uff1a```\nRestart-Computer\n```\n- \u4f7f\u7528\u60a8\u5728 Active Directory \u6797\u5b89\u88dd\u671f\u9593\u5b9a\u7fa9\u7684\u7ba1\u7406\u54e1\u6191\u64da\uff0c\u901a\u904e RDP \u9023\u63a5\u5230\u7db2\u57df\u63a7\u5236\u5668 `ad-dc1` \u3002\u8acb\u52d9\u5fc5\u5c07\u57df\u540d\u6dfb\u52a0\u7232\u524d\u7db4\uff0c\u5982 `EXAMPLE-GCP\\Administrator` \u3002 **\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f Chrome RDP \u5ba2\u6236\u7aef\uff0c\u5247\u53ef\u80fd\u6703\u770b\u5230\u4ee5\u4e0b\u6709\u95dc\u8b49\u66f8\u7684\u8b66\u544a\u3002\u8acb\u6309\u7167\u8aaa\u660e\u9032\u884c\u9023\u63a5\u3002 `` `Someone could be trying to intercept your communication. To connect anyway select Chrome RDP Options, select the Certificates tab, select the <Your IP address>:3389 certificate listing and press the Delete Certificate button.`\n- \u4ee5\u7ba1\u7406\u54e1\u8eab\u4efd\u6253\u958b PowerShell \u7d42\u7aef\u3002\n- \u8a2d\u7f6e\u4ee5\u4e0b\u8b8a\u91cf\uff1a```\n$DNSPrimary = \"10.2.0.100\"\n$DNSSecondary = \"127.0.0.1\"\n$LocalStaticIp = \"10.1.0.100\"\n$DefaultGateway = \"10.1.0.1\"\n```\n- \u8a2d\u7f6e IP \u5730\u5740\u548c\u9ed8\u8a8d\u7db2\u95dc\uff1a```\nnetsh interface ip set address name=Ethernet static `\n $LocalStaticIp 255.255.255.0 $DefaultGateway 1\n``` **\u6ce8\u610f** \uff1aRDP \u7684\u9023\u63a5\u53ef\u80fd\u6703\u65b7\u958b\u5e7e\u79d2\u9418\uff0c\u6216\u8981\u6c42\u60a8\u91cd\u65b0\u9023\u63a5\u3002\n- \u914d\u7f6e\u4e3b DNS \u670d\u52d9\u5668\uff1a```\nnetsh interface ip set dns Ethernet static $DNSPrimary\n```DNS \u670d\u52d9\u5668 `ad-dc2` \u50c5\u5728\u90e8\u7f72\u7b2c\u4e8c\u500b\u7db2\u57df\u63a7\u5236\u5668\u5f8c\u7e94\u53ef\u7528\uff0c\u56e0\u6b64\u60a8\u53ef\u4ee5\u5ffd\u7565\u4ee5\u4e0b\u932f\u8aa4\u6d88\u606f\uff1a```\nThe configured DNS server is incorrect or does not exist.\n``` **\u6ce8\u610f** \uff1a\u60a8\u9700\u8981\u5728\u5b89\u88dd Active Directory \u6797\u4e4b\u5f8c\u914d\u7f6e DNS \u670d\u52d9\u5668\u3002\u5b89\u88dd\u6797\u6703\u4f7f\u7528\u7db2\u57df\u63a7\u5236\u5668 `ac-dc1` \u548c `ad-dc2` \u7684 IP \u5730\u5740\u8986\u84cb\u5b89\u88dd\u5f8c\u7684\u503c\u3002\u5728\u672c\u6559\u7a0b\u5f8c\u9762\u90e8\u5206\uff0c\u60a8\u5c07\u8a2d\u7f6e `ac-dc2` \u7db2\u57df\u63a7\u5236\u5668\u3002\n- \u914d\u7f6e\u8f14\u52a9 DNS \u670d\u52d9\u5668\uff1a```\nnetsh interface ip add dns Ethernet $DNSSecondary index=2\n```\u6b64\u7db2\u57df\u63a7\u5236\u5668\u7684 DNS \u670d\u52d9\u5668\u689d\u76ee `ad-dc1` \u61c9\u6392\u5728\u5217\u8868\u7684\u7b2c\u4e8c\u4f4d\uff0c\u4ee5\u9632\u6b62 Active Directory \u983b\u7e41\u4e1f\u5931\u8207\u5176\u4ed6\u63a7\u5236\u5668\u7684\u9023\u63a5\u3002\u8acb\u5c07\u7b2c\u4e8c\u500b\u7db2\u57df\u63a7\u5236\u5668 `ad-dc2` \u7528\u4f5c\u4e3b DNS \u670d\u52d9\u5668\u3002\u5728\u4e0b\u4e00\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u5275\u5efa `ad-dc2` \u7db2\u57df\u63a7\u5236\u5668\u3002\u5982\u679c\u4e0d\u9075\u5faa\u6b64\u6a21\u5f0f\uff0c\u5247 **\u670d\u52d9\u5668\u7ba1\u7406\u5668** > **Active Directory \u7db2\u57df\u670d\u52d9** \u4e0b\u5c07\u986f\u793a\u4ee5\u4e0b\u932f\u8aa4\uff1a```\nThe DFS Replication service failed to update configuration in Active\nDirectory Domain Services. The service will retry this operation\nperiodically.\n```\u5728\u5169\u81fa\u670d\u52d9\u5668\u5b8c\u5168\u914d\u7f6e\u59a5\u7576\u4e4b\u524d\uff0c `ad-dc1` \u670d\u52d9\u5668\u4e0a\u53ef\u80fd\u6703\u986f\u793a\u932f\u8aa4\u3002\u60a8\u53ef\u4ee5\u5ffd\u7565\u9019\u4e9b\u932f\u8aa4\u3002\n## \u5275\u5efa\u7b2c\u4e8c\u500b\u7db2\u57df\u63a7\u5236\u5668\u63a5\u4e0b\u4f86\uff0c\u60a8\u5c07\u5728\u5176\u4ed6\u5340\u57df\u5275\u5efa\u7b2c\u4e8c\u500b\u7db2\u57df\u63a7\u5236\u5668\u4ee5\u63d0\u4f9b\u5bb9\u932f\u80fd\u529b\u3002\u7b2c\u4e8c\u500b\u7db2\u57df\u63a7\u5236\u5668\u5177\u6709\u4ee5\u4e0b\u5c6c\u6027\uff1a- \u540d\u7a31\uff1a`ad-dc2`\n- IP \u5730\u5740\uff1a`10.2.0.100`\n- \u5982\u679c\u60a8\u7684 Cloud Shell \u7a97\u53e3\u5df2\u904e\u671f\uff0c\u8acb\u6253\u958b\u4e00\u500b\u65b0\u7684 Cloud Shell \u5be6\u4f8b\u4e26\u91cd\u7f6e\u60a8\u4e4b\u524d\u8a2d\u7f6e\u7684\u8b8a\u91cf\u3002\u7232\u6b64\uff0c\u8acb\u4fee\u6539\u4ee5\u4e0b\u8173\u672c\u4ee5\u6307\u5b9a\u5148\u524d\u4f7f\u7528\u7684\u9805\u76ee ID \u548c\u5730\u5340\u3002```\nregion=us-east1\nzone_2=${region}-c\nzone_1=${region}-b\nvpc_name=webappnet\nproject_id=your-project-id\ngcloud config set compute/region ${region}\ngcloud config set project ${project_id}\n```\u5c07 \u66ff\u63db\u7232\u60a8\u6b63\u5728\u4f7f\u7528\u7684 Google Cloud \u9805\u76ee\u7684 ID\u3002\n- \u5c07\u8173\u672c\u8907\u88fd\u5230 Cloud Shell \u7a97\u53e3\u4e26\u904b\u884c\u3002\n- \u4f7f\u7528 Cloud Shell \u5275\u5efa\u7b2c\u4e8c\u500b\u7db2\u57df\u63a7\u5236\u5668\u5be6\u4f8b\uff1a```\ngcloud compute instances create ad-dc2 --machine-type n1-standard-2 \\\n --boot-disk-size 50GB \\\n --boot-disk-type pd-ssd \\\n --image-family windows-2016 --image-project windows-cloud \\\n --can-ip-forward \\\n --network ${vpc_name} \\\n --zone ${zone_2} \\\n --subnet private-ad-zone-2 \\\n --private-network-ip=10.2.0.100\n```\n- \u8acb\u7b49\u5f85\u4e00\u5206\u9418\u5de6\u53f3\uff0c\u7136\u5f8c\u7232 Windows \u5be6\u4f8b `ad-dc2` \u5275\u5efa\u4e00\u500b\u5bc6\u78bc\uff1a```\ngcloud compute reset-windows-password ad-dc2 --zone ${zone_2} --quiet\n```\u7528\u6236\u540d\u662f\u60a8\u7684 Google \u5e33\u865f\u7528\u6236\u540d\u3002\u8acb\u8a18\u597d\u7528\u6236\u540d\u548c\u5bc6\u78bc\uff0c\u4ee5\u5099\u5c07\u4f86\u4f7f\u7528\u3002\n- \u4f7f\u7528\u60a8\u5728\u4e0a\u4e00\u6b65\u4e2d\u5275\u5efa\u7684\u6191\u64da\uff0c\u901a\u904e RDP \u9023\u63a5\u5230\u7db2\u57df\u63a7\u5236\u5668\u5be6\u4f8b\u3002\n- \u4ee5\u7ba1\u7406\u54e1\u8eab\u4efd\u6253\u958b PowerShell \u7d42\u7aef\u3002\n- \u5b89\u88dd Active Directory \u7db2\u57df\u670d\u52d9\uff0c\u5305\u62ec\u7ba1\u7406\u5de5\u5177\uff1a```\nInstall-WindowsFeature -Name AD-Domain-Services -IncludeManagementTools\n```\n- \u8a2d\u7f6e\u4ee5\u4e0b\u8b8a\u91cf\uff1a```\n$DomainName = \"example-gcp.com\"\n$DomainPrefix = \"EXAMPLE-GCP\"\n$DNSPrimary = \"10.1.0.100\"\n$DNSSecondary = \"127.0.0.1\"\n$LocalStaticIp = \"10.2.0.100\"\n$DefaultGateway = \"10.2.0.1\"\n$DatabasePath = \"C:\\Windows\\NTDS\"\n$SysvolPath = \"C:\\Windows\\SYSVOL\"\n$LogPath = \"C:\\Logs\"\n```\n- \u914d\u7f6e\u4e3b DNS \u670d\u52d9\u5668\uff1a```\nnetsh interface ip set dns Ethernet static $DNSPrimary\n```\n- \u914d\u7f6e\u7b2c\u4e8c\u500b\u670d\u52d9\u5668\uff0c\u4f7f\u5176\u5145\u7576\u81ea\u5df1\u7684\u8f14\u52a9 DNS \u670d\u52d9\u5668\uff1a```\nnetsh interface ip add dns Ethernet $DNSSecondary index=2\n```\u53ea\u6709\u5728 `ad-dc2` \u4f5c\u7232\u7db2\u57df\u63a7\u5236\u5668\u52a0\u5165\u7db2\u57df\u5f8c\uff0c `ad-dc2` DNS \u670d\u52d9\u5668\u7e94\u53ef\u7528\u3002\u7531\u65bc\u670d\u52d9\u5668\u5c1a\u672a\u52a0\u5165\uff0c\u60a8\u6703\u770b\u5230\u4ee5\u4e0b\u6d88\u606f\uff0c\u4f46\u53ef\u4ee5\u5ffd\u7565\u5b83\uff1a```\nThe configured DNS server is incorrect or does not exist.\n```\n- \u8a2d\u7f6e IP \u5730\u5740\u548c\u9ed8\u8a8d\u7db2\u95dc\uff1a```\nnetsh interface ip set address name=Ethernet static `\n $LocalStaticIp 255.255.255.0 $DefaultGateway 1\n``` **\u6ce8\u610f** \uff1aRDP \u7684\u9023\u63a5\u53ef\u80fd\u6703\u65b7\u958b\u5e7e\u79d2\u9418\uff0c\u6216\u8981\u6c42\u60a8\u91cd\u65b0\u9023\u63a5\u3002\n- \u904b\u884c\u4ee5\u4e0b PowerShell \u8173\u672c\uff0c\u8a72\u8173\u672c\u5c07\u5728\u7b2c\u4e00\u500b\u7db2\u57df\u63a7\u5236\u5668\u904b\u884c\u6642\u901a\u77e5\u60a8\u3002\u8acb\u7b49\u5f85\u986f\u793a `Domain controller is reachable` \u6d88\u606f\u3002```\n$DomainIsReady=$False\nFor ($i=0; $i -le 30; $i++) {\n nltest /dsgetdc:$DomainName\n if($LASTEXITCODE -ne 0) {\n  Write-Host \"Domain not ready, wait 1 more minute, then retry\"\n  Start-Sleep -s 60\n }\n else {\n  $DomainIsReady=$True\n  Write-Host \"Domain controller is reachable\"\n  break\n }\n}\nif($DomainIsReady -eq $False) {\n Write-Host \"Domain not ready. Check if it was deployed ok\"\n}\n```\n- \u5c07\u865b\u64ec\u6a5f\u4f5c\u7232\u7b2c\u4e8c\u500b\u7db2\u57df\u63a7\u5236\u5668\u6dfb\u52a0\u5230\u6797\uff1a```\nInstall-ADDSDomainController `\n -Credential (Get-Credential \"$DomainPrefix\\Administrator\") `\n -CreateDnsDelegation:$false `\n -DatabasePath $DatabasePath `\n -DomainName $DomainName `\n -InstallDns:$true `\n -LogPath $LogPath `\n -SysvolPath $SysvolPath `\n -NoGlobalCatalog:$false `\n -SiteName 'Default-First-Site-Name' `\n -NoRebootOnCompletion:$true `\n -Force:$true\n```\n- \u7576\u7cfb\u7d71\u63d0\u793a\u60a8\u7232\u7ba1\u7406\u54e1\u5e33\u865f\u63d0\u4f9b\u5bc6\u78bc\u6642\uff0c\u8acb\u4f7f\u7528\u60a8\u5728 Active Directory \u6797\u5b89\u88dd\u671f\u9593\u5b9a\u7fa9\u7684\u7ba1\u7406\u54e1\u6191\u64da\u3002\u8acb\u6dfb\u52a0\u57df\u540d\u4f5c\u7232\u524d\u7db4\uff0c\u5982 `EXAMPLE-GCP\\Administrator` \u3002\n- \u7576\u7cfb\u7d71\u63d0\u793a\u60a8\u8f38\u5165\u201c\u5b89\u5168\u6a21\u5f0f\u7ba1\u7406\u54e1\u201d\u5bc6\u78bc\u6642\uff0c\u8acb\u4f7f\u7528\u7528\u65bc\u7b2c\u4e00\u500b\u7db2\u57df\u63a7\u5236\u5668\u7684\u540c\u4e00\u5bc6\u78bc\u3002\n- \u5ffd\u7565\u4ee5\u4e0b\u8b66\u544a\u3002\u6bcf\u500b\u8b66\u544a\u5c07\u51fa\u73fe\u5169\u6b21\uff1a\u4e00\u6b21\u662f\u5728\u524d\u63d0\u689d\u4ef6\u9a57\u8b49\u671f\u9593\uff0c\u53e6\u4e00\u6b21\u662f\u5728\u5b89\u88dd\u904e\u7a0b\u4e2d\u3002```\nWARNING: Windows Server 2016 domain controllers have a default for the\nsecurity setting named \"Allow cryptography algorithms compatible with\nWindows NT 4.0\" that prevents weaker cryptography algorithms when\nestablishing security channel sessions.\nFor more information about this setting, see Knowledge Base article\n942564 (http://go.microsoft.com/fwlink/?LinkId=104751).\n``````\nWARNING: A delegation for this DNS server cannot be created because the\nauthoritative parent zone cannot be found or it does not run Windows DNS\nserver. If you are integrating with an existing DNS infrastructure, you\nshould manually create a delegation to this DNS server in the parent zone\nto ensure reliable name resolution from outside the domain\n\"example-gcp.com\". Otherwise, no action is required.\n```\n- \u91cd\u5553\u865b\u64ec\u6a5f\uff1a```\nRestart-Computer\n```\n## \u6e2c\u8a66\u5b89\u88dd\n- \u7b49\u5f85 5-10 \u5206\u9418\uff0c\u78ba\u4fdd\u5169\u500b\u7db2\u57df\u63a7\u5236\u5668\u90fd\u53ef\u4ee5\u6b63\u5e38\u904b\u884c\u4e26\u6b63\u5728\u8907\u88fd\u4fe1\u606f\u3002\n- \u4f7f\u7528\u60a8\u5728\u7b2c\u4e00\u500b\u7db2\u57df\u63a7\u5236\u5668\u5b89\u88dd\u671f\u9593\u5b9a\u7fa9\u7684\u7ba1\u7406\u54e1\u6191\u64da\uff0c\u901a\u904e RDP \u9023\u63a5\u5230\u7b2c\u4e00\u500b\u7db2\u57df\u63a7\u5236\u5668\u5be6\u4f8b\u3002\u8acb\u6dfb\u52a0\u57df\u540d\u4f5c\u7232\u524d\u7db4\uff0c\u5982 `EXAMPLE-GCP\\Administrator` \u3002\n- \u4ee5\u7ba1\u7406\u54e1\u8eab\u4efd\u6253\u958b PowerShell \u7d42\u7aef\u3002\n- \u6e2c\u8a66\u8907\u88fd\u64cd\u4f5c\u662f\u5426\u751f\u6548\uff1a```\nrepadmin /replsum\n``` **\u6ce8\u610f** \uff1a\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u95b1\u8b80 [Active Directory \u4e2d\u7684\u8907\u88fd\u548c\u62d3\u64b2\u7ba1\u7406](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/manage/powershell/advanced-active-directory-replication-and-topology-management-using-windows-powershell--level-200-#BKMK_Repl) \u3002\u8f38\u51fa\u61c9\u8207\u4ee5\u4e0b\u5167\u5bb9\u985e\u4f3c\uff0c\u6c92\u6709\u51fa\u932f\uff0c\u4e5f\u6c92\u6709\u5931\u6557\u3002\u5982\u679c\u7db2\u57df\u63a7\u5236\u5668\u4e0d\u53ef\u7528\uff0c\u60a8\u6703\u770b\u5230\u5982\u4e0b\u6240\u793a\u7684\u6d88\u606f\uff1a```\nBeginning data collection for replication summary, this may take awhile:\n ....\nSource DSA   largest delta fails/total %% error\nDestination DSA  largest delta fails/total %% error\n```\u5982\u679c\u770b\u5230\u6b64\u6d88\u606f\uff0c\u8acb\u7b49\u5f85\u5e7e\u5206\u9418\uff0c\u7136\u5f8c\u91cd\u8a66\u8a72\u547d\u4ee4\u3002\n## \u6e05\u9664\u6578\u64da\u5982\u679c\u60a8\u60f3\u7e7c\u7e8c\u5b78\u7fd2\u672c\u7cfb\u5217\u4e2d\u7684\u4e0b\u4e00\u500b\u6559\u7a0b\uff08 [\u90e8\u7f72\u591a\u5b50\u7db2 SQL Server](https://cloud.google.com/architecture/deploy-multi-subnet-sql-server?hl=zh-cn) \uff09\uff0c\u8acb\u4fdd\u7559\u60a8\u5728\u672c\u6559\u7a0b\u4e2d\u5275\u5efa\u7684\u8cc7\u6e90\u3002\u4f46\u662f\uff0c\u5982\u679c\u60a8\u4e0d\u6253\u7b97\u4f7f\u7528\u672c\u6559\u7a0b\u4e2d\u5275\u5efa\u7684 Active Directory \u74b0\u5883\uff0c\u8acb\u6e05\u7406\u60a8\u5728 Google Cloud \u4e0a\u5275\u5efa\u7684\u8cc7\u6e90\uff0c\u4ee5\u907f\u514d\u65e5\u5f8c\u7232\u9019\u4e9b\u8cc7\u6e90\u652f\u4ed8\u8cbb\u7528\u3002\u4ee5\u4e0b\u90e8\u5206\u4ecb\u7d39\u5982\u4f55\u522a\u9664\u6216\u95dc\u9589\u9019\u4e9b\u8cc7\u6e90\u3002\n### \u522a\u9664\u9805\u76ee\n\u7232\u4e86\u907f\u514d\u7522\u751f\u8cbb\u7528\uff0c\u6700\u7c21\u55ae\u7684\u65b9\u6cd5\u662f\u522a\u9664\u60a8\u7232\u672c\u6559\u7a0b\u5275\u5efa\u7684\u9805\u76ee\u3002\n\u5982\u9700\u522a\u9664\u9805\u76ee\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- **\u8b66\u544a** \uff1a\u522a\u9664\u9805\u76ee\u6703\u7522\u751f\u4ee5\u4e0b\u5f71\u97ff- **\u9805\u76ee\u4e2d\u7684\u6240\u6709\u5167\u5bb9\u90fd\u6703\u88ab\u522a\u9664\u3002** \u5982\u679c\u60a8\u5c07\u73fe\u6709\u9805\u76ee\u7528\u65bc\u672c\u6587\u6a94\u4e2d\u7684\u4efb\u52d9\uff0c\u5247\u522a\u9664\u8a72\u9805\u76ee\u5f8c\uff0c\u9084\u5c07\u522a\u9664\u60a8\u5df2\u5728\u8a72\u9805\u76ee\u4e2d\u5b8c\u6210\u7684\u4efb\u4f55\u5176\u4ed6\u5de5\u4f5c\u3002\n- **\u81ea\u5b9a\u7fa9\u9805\u76ee ID \u4e1f\u5931\u3002** \u5275\u5efa\u6b64\u9805\u76ee\u6642\uff0c\u60a8\u53ef\u80fd\u5275\u5efa\u4e86\u8981\u5728\u5c07\u4f86\u4f7f\u7528\u7684\u81ea\u5b9a\u7fa9\u9805\u76ee ID\u3002\u8981\u4fdd\u7559\u4f7f\u7528\u8a72\u9805\u76ee ID \u7684\u7db2\u5740\uff08\u4f8b\u5982`appspot.com`\u7db2\u5740\uff09\uff0c\u8acb\u522a\u9664\u9805\u76ee\u5167\u7684\u6240\u9078\u8cc7\u6e90\uff0c\u800c\u4e0d\u662f\u522a\u9664\u6574\u500b\u9805\u76ee\u3002\n\u5982\u679c\u60a8\u6253\u7b97\u63a2\u7d22\u591a\u500b\u67b6\u69cb\u3001\u6559\u7a0b\u6216\u5feb\u901f\u5165\u9580\uff0c\u5247\u91cd\u8907\u4f7f\u7528\u9805\u76ee\u53ef\u4ee5\u5e6b\u52a9\u60a8\u907f\u514d\u8d85\u51fa\u9805\u76ee\u914d\u984d\u9650\u5236\u3002\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u9032\u5165 **\u7ba1\u7406\u8cc7\u6e90** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u7ba1\u7406\u8cc7\u6e90\u201d](https://console.cloud.google.com/iam-admin/projects?hl=zh-cn) \n- \u5728\u9805\u76ee\u5217\u8868\u4e2d\uff0c\u9078\u64c7\u8981\u522a\u9664\u7684\u9805\u76ee\uff0c\u7136\u5f8c\u9ede\u64ca **\u522a\u9664** \u3002\n- \u5728\u5c0d\u8a71\u6846\u4e2d\u8f38\u5165\u9805\u76ee ID\uff0c\u7136\u5f8c\u9ede\u64ca **\u95dc\u9589** \u4ee5\u522a\u9664\u9805\u76ee\u3002\n### \u522a\u9664\u5be6\u4f8b\n\u5982\u9700\u522a\u9664 Compute Engine \u5be6\u4f8b\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u8f49\u5230 **\u865b\u64ec\u6a5f\u5be6\u4f8b** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u865b\u64ec\u6a5f\u5be6\u4f8b\u201d](https://console.cloud.google.com/compute/instances?hl=zh-cn) \n- \u9078\u4e2d\u8981\u522a\u9664\u7684\u5be6\u4f8b\u3002\n- \u5982\u9700\u522a\u9664\u5be6\u4f8b\uff0c\u8acb\u9ede\u64camore_vert **\u66f4\u591a\u64cd\u4f5c** \uff0c\u9ede\u64ca **\u522a\u9664** \uff0c\u7136\u5f8c\u6309\u7167\u8aaa\u660e\u64cd\u4f5c\u3002### \u522a\u9664 VPC \u7db2\u7d61\u8981\u522a\u9664 VPC \u7db2\u7d61\u3001\u5b50\u7db2\u548c\u9632\u706b\u7246\u898f\u5247\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u8f49\u5230\u201cVPC \u7db2\u7d61\u201d\u9801\u9762\u3002 [\u8f49\u5230\u201cVPC \u7db2\u7d61\u201d\u9801\u9762](https://console.cloud.google.com/networking/networks/list?hl=zh-cn) \n- \u9078\u64c7\u60a8\u5275\u5efa\u7684 VPC \u7db2\u7d61\u3002\n- \u9ede\u64ca\u9801\u9762\u9802\u90e8\u7684 **\u522a\u9664** \u6309\u9215\u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u7e7c\u7e8c\u95b1\u8b80\u672c\u7cfb\u5217\u7684\u4e0b\u4e00\u500b\u6559\u7a0b\uff1a\n- [\u90e8\u7f72\u591a\u5b50\u7db2 SQL Server](https://cloud.google.com/architecture/deploy-multi-subnet-sql-server?hl=zh-cn) \n- [\u90e8\u7f72\u8ca0\u8f09\u5e73\u8861 IIS \u7db2\u7d61\u670d\u52d9\u5668](https://cloud.google.com/architecture/deploy-load-balanced-iis-web-servers?hl=zh-cn) \n- \u8a73\u7d30\u77ad\u89e3 [\u5728\u6df7\u5408\u74b0\u5883\u4e2d\u4f7f\u7528 Active Directory \u7684\u6a21\u5f0f](https://cloud.google.com/architecture/patterns-for-using-active-directory-in-a-hybrid-environment?hl=zh-cn) \u3002\n- \u67e5\u770b [\u7ba1\u7406\u8eab\u4efd\u548c\u8a2a\u554f\u6b0a\u9650\u7684\u6700\u4f73\u5be6\u8e10](https://cloud.google.com/architecture/framework/security/identity-access?hl=zh-cn) \u3002\n- \u63a2\u7d22\u6709\u95dc Google Cloud \u7684\u53c3\u8003\u67b6\u69cb\u3001\u5716\u8868\u548c\u6700\u4f73\u5be6\u8e10\u3002\u67e5\u770b\u6211\u5011\u7684 [Cloud Architecture Center](https://cloud.google.com/architecture?hl=zh-cn) \u3002", "guide": "Docs"}