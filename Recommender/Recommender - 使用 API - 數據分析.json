{"title": "Recommender - \u4f7f\u7528 API - \u6578\u64da\u5206\u6790", "url": "https://cloud.google.com/recommender/docs/insights/use-api?hl=zh-cn", "abstract": "# Recommender - \u4f7f\u7528 API - \u6578\u64da\u5206\u6790\n# \u4f7f\u7528 API - \u6578\u64da\u5206\u6790\n\u672c\u9801\u9762\u4ecb\u7d39\u77ad\u5982\u4f55\u5728 Recommender \u4e2d\u4f7f\u7528 [gcloud \u547d\u4ee4](https://cloud.google.com/sdk/gcloud/reference/recommender?hl=zh-cn) \u6216 [REST API](https://cloud.google.com/recommender/docs/reference/rest/v1/projects.locations.insightTypes.insights?hl=zh-cn) \u67e5\u770b\u548c\u7ba1\u7406 [\u6578\u64da\u5206\u6790](https://cloud.google.com/recommender/docs/insights/using-insights?hl=zh-cn#insights) \u3002\n\u8207 Recommender API \u4ea4\u4e92\u7684\u5178\u578b\u6578\u64da\u5206\u6790\u662f\uff1a\n- \u5217\u51fa\u7576\u524d\u9069\u7528\u65bc\u7279\u5b9a\u6578\u64da\u5206\u6790\u985e\u578b\u7684 [\u6578\u64da\u5206\u6790](#list_insights) \n- \u5c07\u60f3\u8981\u57f7\u884c\u64cd\u4f5c\u7684\u6578\u64da\u5206\u6790\u6a19\u8a18\u7232 [\u5df2\u63a5\u53d7](#mark_an_insight_as_accepted) \n\u5982\u9700\u77ad\u89e3\u5982\u4f55\u5728 Google Cloud Console \u4e2d\u66f4\u6539\u6578\u64da\u5206\u6790\u72c0\u614b\uff0c\u8acb\u53c3\u95b1 [Recommendation Hub](https://cloud.google.com/recommender/docs/recommendation-hub/identify-configuration-problems?hl=zh-cn) \u7684\u6587\u6a94\uff0c\u6216\u76f8\u61c9\u7684 [\u6578\u64da\u5206\u6790\u985e\u578b](https://cloud.google.com/recommender/docs/insights/insight-types?hl=zh-cn) \u3002\n", "content": "## \u8a2d\u7f6e\u9ed8\u8a8d\u9805\u76ee\u3002\n\u8a2d\u7f6e\u9ed8\u8a8d\u9805\u76ee\uff08\u5982\u679c\u5c1a\u672a\u8a2d\u7f6e\uff09\uff1a\n```\ngcloud config set project PROJECT_ID\n```\n\u5176\u4e2d \u662f\u9805\u76ee ID\u3002\n## \u8a2d\u7f6e\u74b0\u5883\u8b8a\u91cf\n\u7232 Recommender \u4e92\u52d5\u8a2d\u7f6e\u74b0\u5883\u8b8a\u91cf\uff1a\n```\nPROJECT=TARGET_PROJECT_ID\nLOCATION=LOCATION_ID\nINSIGHT_TYPE=INSIGHT_TYPE_ID\n```\n\u5176\u4e2d\uff1a\n- \u662f\u60a8\u8981\u5217\u51fa\u5176\u5206\u6790\u6578\u64da\u7684\u9805\u76ee\u3002\u8a72\u9805\u76ee\u53ef\u4ee5\u662f\u7576\u524d\u9805\u76ee\u4ee5\u5916\u7684\u9805\u76ee\u3002- \u5c0d\u65bc`gcloud`\u547d\u4ee4\uff0c\u60a8\u5fc5\u9808\u4f7f\u7528\u9805\u76ee ID\n- \u5c0d\u65bc API \u8acb\u6c42\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u9805\u76ee\u7de8\u865f\u6216\u9805\u76ee ID\u3002\u5efa\u8b70\u4f7f\u7528\u9805\u76ee\u7de8\u865f\u3002\n\u9805\u76ee\u7de8\u865f\u5728 API \u548c `gcloud` \u547d\u4ee4\u8fd4\u56de\u7684\u97ff\u61c9\u4e2d\u8fd4\u56de\u3002\n- \u662f\u8207\u6578\u64da\u5206\u6790\u95dc\u806f\u7684\u8cc7\u6e90\u6240\u5728\u7684 Google Cloud [\u4f4d\u7f6e](https://cloud.google.com/compute/docs/regions-zones?hl=zh-cn) \uff08\u4f8b\u5982 `global` \u6216 `us-central1-a` \uff09\n- \u662f\u5b8c\u5168\u9650\u5b9a\u7684 [\u6578\u64da\u5206\u6790\u985e\u578b ID](https://cloud.google.com/recommender/docs/insights/insight-types?hl=zh-cn) \uff08\u4f8b\u5982 `google.iam.policy.Insight` \uff09\u3002\n\u8acb\u53c3\u95b1 [\u6578\u64da\u5206\u6790\u985e\u578b](https://cloud.google.com/recommender/docs/insights/insight-types?hl=zh-cn) \uff0c\u7372\u53d6\u6bcf\u7a2e\u6578\u64da\u5206\u6790\u985e\u578b\uff08\u5305\u62ec\u652f\u6301\u7684\u4f4d\u7f6e\u548c\u6578\u64da\u5206\u6790\u985e\u578b ID\uff09\u76f8\u95dc\u4fe1\u606f\u7684\u93c8\u63a5\u8868\u3002\n## \u8a2d\u7f6e\u6b0a\u9650\n\u60a8\u5fc5\u9808\u64c1\u6709\u8a2a\u554f\u76ee\u6a19\u9805\u76ee\u4e2d\u7684\u6578\u64da\u5206\u6790\u7684\u6b0a\u9650\u3002\n- \u5c0d\u65bc\u5728\u8acb\u6c42\u4e2d\u5305\u542b [\u7d50\u7b97\u9805\u76ee](https://cloud.google.com/sdk/gcloud/reference?hl=zh-cn#--billing-project) \u7684\u8acb\u6c42\u8005\u3002\u8acb\u6c42\u4e2d\u4f7f\u7528\u7684\u9805\u76ee\u5fc5\u9808\u4fe1\u8b7d\u826f\u597d\uff0c\u4e26\u4e14\u7528\u6236\u5728\u9805\u76ee\u4e2d\u5fc5\u9808\u5177\u6709\u89d2\u8272\uff0c\u6b64\u89d2\u8272\u5305\u542b`serviceusage.services.use`\u6b0a\u9650\u3002 **Service Usage Consumer** \u89d2\u8272\u5305\u542b\u6240\u9700\u7684\u6b0a\u9650\u3002\n- \u6bcf\u7a2e\u6578\u64da\u5206\u6790\u985e\u578b\u90fd\u9700\u8981\u7279\u5b9a\u6b0a\u9650\u3002\u8acb\u53c3\u95b1 [\u6578\u64da\u5206\u6790\u985e\u578b](https://cloud.google.com/recommender/docs/insights/insight-types?hl=zh-cn) \uff0c\u7372\u53d6\u6bcf\u7a2e\u6578\u64da\u5206\u6790\u985e\u578b\uff08\u5305\u62ec\u5fc5\u9808\u7684\u6b0a\u9650\uff09\u76f8\u95dc\u4fe1\u606f\u7684\u93c8\u63a5\u8868\u3002\n**\u6ce8\u610f** \uff1a\u5982\u8981\u5728\u8acb\u6c42\u4e2d\u4f7f\u7528 [x-goog-user-project \u6a19\u982d](https://cloud.google.com/storage/docs/xml-api/reference-headers?hl=zh-cn#xgooguserproject) \u6216 [userProject \u67e5\u8a62\u5b57\u7b26\u4e32\u53c3\u6578](https://cloud.google.com/storage/docs/xml-api/reference-headers?hl=zh-cn#userProject) \uff0c\u9664\u4e86\u767c\u51fa\u8acb\u6c42\u6240\u9700\u7684\u666e\u901a IAM \u6b0a\u9650\uff0c\u9084\u5fc5\u9808\u64c1\u6709\u6307\u5b9a\u9805\u76ee ID \u7684 `serviceusage.services.use` \u6b0a\u9650\u3002\n## \u5217\u51fa\u6578\u64da\u5206\u6790\n\u8981\u5217\u51fa\u76ee\u6a19\u9805\u76ee\u4e2d\u7684\u6578\u64da\u5206\u6790\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n\u8f38\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a\n```\ngcloud recommender insights list \\\n --project=${PROJECT} \\\n --location=${LOCATION} \\\n --insight-type=${INSIGHT_TYPE} \\\n --format=FORMAT\n```\n\u5176\u4e2d\uff0c \u662f\u53d7\u652f\u6301\u7684 `gcloud` [\u8f38\u51fa\u683c\u5f0f](https://cloud.google.com/sdk/gcloud/reference/topic/formats?hl=zh-cn) \uff08\u4f8b\u5982 `json` \uff09\u3002\n\u4f8b\u5982\uff1a\n```\ngcloud recommender insights list \\\n --project=example-project \\\n --location=global \\\n --insight-type=google.iam.policy.Insight \\\n --format=json\n```\n\u8f38\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a\n```\ncurl \\\n -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\\n -H \"x-goog-user-project: ${PROJECT}\" \\\n \"https://recommender.googleapis.com/v1/projects/${PROJECT}/locations/${LOCATION}/insightTypes/${INSIGHT_TYPE}/insights\"\n```\n\u4f8b\u5982\uff1a\n```\ncurl \\\n -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\\n -H \"x-goog-user-project: example-project\" \\\n \"https://recommender.googleapis.com/v1/projects/example-project/locations/us-central1-a/insightTypes/google.iam.policy.Insight/insights\"\n```\n\u6b64\u64cd\u4f5c\u6703\u5c07\u76ee\u6a19\u9805\u76ee\u4e2d\u7684\u7576\u524d IAM \u653f\u7b56\u6578\u64da\u5206\u6790\u8f38\u51fa\u7232\u63a1\u7528\u6307\u5b9a\u683c\u5f0f\u7684 [Insight](https://cloud.google.com/recommender/docs/reference/rest/v1/projects.locations.insightTypes.insights?hl=zh-cn#resource:-insight) \u5be6\u9ad4\u5217\u8868\u3002\n\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a\n```\n[ {\n \"category\": \"SECURITY\",\n \"content\": {\n  \"condition\": {\n  \"description\": \"\",\n  \"expression\": \"\",\n  \"location\": \"\",\n  \"title\": \"\"\n  },\n  \"exercisedPermissions\": [],\n  \"inferredPermissions\": [],\n  \"member\": \"user:my-service-account@example-project.iam.gserviceaccount.com\",\n  \"role\": \"roles/iam.securityReviewer\"\n },\n \"description\": \"0 permission checks were authorized by this policy binding tuple.\",\n \"etag\": \"\\\"45f4e2c63f6952e8\\\"\",\n \"insightSubtype\": \"PERMISSIONS_USAGE\",\n \"lastRefreshTime\": \"2020-03-06T08:00:00Z\",\n \"name\": \"projects/32428390823/locations/global/insightTypes/google.iam.policy.Insight/insights/a523ff7e-ed03-4143-a3a5-5b396b99cba9\",\n \"observationPeriod\": \"7776000s\",\n \"stateInfo\": {\n  \"state\": \"ACTIVE\",\n },\n \"targetResources\": [  \"//cloudresourcemanager.googleapis.com/projects/32428390823\"\n ],\n }\n]\n```\n\u8acb\u6ce8\u610f\uff0c\u8fd4\u56de\u7684\u6578\u64da\u5206\u6790\u5305\u62ec\u4ee5\u4e0b\u5b57\u6bb5\uff1a\n- \u63a1\u7528\u4ee5\u4e0b\u683c\u5f0f\u7684 `name` \u5b57\u6bb5\uff1a```\nprojects/PROJECT_ID/locations/LOCATION/insightTypes/INSIGHT_TYPE_ID/insights/INSIGHT_ID\n```\u5176\u4e2d\uff0c \u552f\u4e00\u6a19\u8b58\u6578\u64da\u5206\u6790\n- \u8207\u7576\u524d\u6578\u64da\u5206\u6790\u72c0\u614b\u95dc\u806f\u7684 `etag` \u5b57\u6bb5\u3002\n\u4f7f\u7528\u5f8c\u7e8c\u7684 `gcloud` \u547d\u4ee4\u6216 REST API \u8abf\u7528\u5f15\u7528\u6578\u64da\u5206\u6790\u6642\uff0c\u60a8\u53ef\u4ee5\u540c\u6642\u5f15\u7528\u6578\u64da\u5206\u6790 ID \u548c Etag\uff0c\u4ee5\u78ba\u4fdd\u53ea\u6709\u5728\u4e0a\u6b21\u6aa2\u7d22\u6578\u64da\u5206\u6790\u5f8c\u6c92\u6709\u4efb\u4f55\u66f4\u6539\u7684\u60c5\u6cc1\u4e0b\u57f7\u884c\u6240\u6709\u64cd\u4f5c\u3002\n## \u5c07\u6578\u64da\u5206\u6790\u6a19\u8a18\u7232\u5df2\u63a5\u53d7\n\u60a8\u53ef\u4ee5\u5c07\u6578\u64da\u5206\u6790\u6a19\u8a18\u7232\u201c\u5df2\u63a5\u53d7\u201d\uff0c\u4ee5\u8868\u793a\u60a8\u6253\u7b97\u6839\u64da\u6578\u64da\u5206\u6790\u4e2d\u63d0\u4f9b\u7684\u4fe1\u606f\u5728\u95dc\u806f\u8cc7\u6e90\u5167\u57f7\u884c\u64cd\u4f5c\u6216\u5df2\u57f7\u884c\u64cd\u4f5c\u3002\u63a5\u53d7\u6578\u64da\u5206\u6790\u5f8c\uff0c\u60a8\u7684\u7528\u6236\u540d\u5c07\u88ab\u6307\u5b9a\u7232\u6578\u64da\u5206\u6790\u7684\u57f7\u884c\u8005\uff0c\u4e14 Recommender \u5c07\u4e0d\u518d\u4f7f\u7528\u65b0\u5167\u5bb9\u66f4\u65b0\u6578\u64da\u5206\u6790\u3002\n\u8981\u5c07\u6578\u64da\u5206\u6790\u6a19\u8a18\u7232\u5df2\u63a5\u53d7\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n\u8f38\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a\n```\ngcloud recommender insights mark-accepted \\\n INSIGHT_ID \\\n --project=${PROJECT} \\\n --location=${LOCATION} \\\n --insight-type=${INSIGHT_TYPE} \\\n --etag=etag \\\n --state-metadata=STATE_METADATA\n --format=FORMAT\n```\n\u5176\u4e2d\uff1a- \u662f\u5f9e\u4e0a\u4e00\u6b21\u5217\u51fa\u6578\u64da\u5206\u6790\u8abf\u7528\u4e2d\u6aa2\u7d22\u7684\u6578\u64da\u5206\u6790 ID\n- \u662f\u8fd4\u56de\u7684\u8868\u793a\u6578\u64da\u6d1e\u5bdf\u72c0\u614b\u7684 Etag\n- \u662f\u8a72\u64cd\u4f5c\u7684\u53ef\u9078\u5143\u6578\u64da\u3002\u5c07\u5143\u6578\u64da\u6307\u5b9a\u7232\u4ee5\u82f1\u6587\u9017\u865f\u5206\u9694\u7684=\u5c0d\u5217\u8868\u3002\n\u4f8b\u5982\uff1a\n```\ngcloud recommender insights mark-accepted \\\n a523ff7e-ed03-4143-a3a5-5b396b99cba9 \\\n --project=example-project \\\n --location=global \\\n --insight-type=google.iam.policy.Insight \\\n --etag='\"280b34810bba8a1a\"' \\\n --state-metadata=priority=high,tracking_number=12345\n --format=json\n```\n\u8f38\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a\n```\ncurl -X POST \\\n -H \"Content-Type: application/json\" \\\n -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\\n -H \"x-goog-user-project: ${PROJECT}\" \\\n --data-binary @- \\\n https://recommender.googleapis.com/v1/projects/${PROJECT}/locations/${LOCATION}/insightTypes/${INSIGHT_TYPE}/insights/INSIGHT_ID:markAccepted \\\n<< EOM\n{\n \"etag\": \"etag\",\n \"stateMetadata\": STATE_METADATA\n}\nEOM\n```\n\u5176\u4e2d\uff1a- \u662f\u5f9e\u4e0a\u4e00\u6b21\u5217\u51fa\u6578\u64da\u5206\u6790\u8abf\u7528\u4e2d\u6aa2\u7d22\u7684\u6578\u64da\u5206\u6790 ID\n- \u662f\u8fd4\u56de\u7684\u8868\u793a\u6578\u64da\u6d1e\u5bdf\u72c0\u614b\u7684 Etag\n- \u662f\u95dc\u65bc\u64cd\u4f5c\u7684\u5176\u4ed6\u5143\u6578\u64da\u7684\u53ef\u9078\u5b57\u6bb5\u3002\u5c07\u5143\u6578\u64da\u6307\u5b9a\u7232`key:value`\u5c0d\u3002\n\u4f8b\u5982\uff1a\n```\ncurl -X POST \\\n -H \"Content-Type: application/json\" \\\n -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\\n -H \"x-goog-user-project: example-project\" \\\n --data-binary @- \\\n https://recommender.googleapis.com/v1/projects/example-project/locations/global/insightTypes/google.iam.policy.Insight/insights/a523ff7e-ed03-4143-a3a5-5b396b99cba9:markAccepted \\\n<< EOM\n{\n \"etag\": \"\\\"280b34810bba8a1a\\\"\"\n \"stateMetadata\": {\n \"priority\" : \"high\",\n \"tracking_number\": \"12345\"\n }\n}\nEOM\n```\n\u6b64\u64cd\u4f5c\u5b8c\u6210\u5f8c\uff0c\u6703\u4ee5\u6307\u5b9a\u7684\u683c\u5f0f\u8fd4\u56de [Insight](https://cloud.google.com/recommender/docs/reference/rest/v1/projects.locations.insightTypes.insights?hl=zh-cn#resource:-insight) \u5be6\u9ad4\u3002\n\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a\n```\n{\n \"category\": \"SECURITY\",\n \"content\": { ... },\n \"description\": \"0 permission checks were authorized by this policy binding tuple.\",\n \"etag\": \"\\\"356ae51165729f38\\\"\",\n \"insightSubtype\": \"PERMISSIONS_USAGE\",\n \"lastModifiedUser\": \"admin123@example-project.iam.gserviceaccount.com\",\n \"lastRefreshTime\": \"2020-03-06T08:00:00Z\",\n \"name\": \"projects/32428390823/locations/global/insightTypes/google.iam.policy.Insight/insights/a523ff7e-ed03-4143-a3a5-5b396b99cba9\",\n \"observationPeriod\": \"7776000s\",\n \"stateInfo\": {\n \"state\": \"ACCEPTED\",\n \"stateMetadata\": {\n  \"priority\" : \"high\",\n  \"tracking_number\": \"12345\"\n }\n },\n \"targetResources\": [ \"//cloudresourcemanager.googleapis.com/projects/32428390823\"\n ],\n \"userLastUpdateTime\": \"2020-03-31T20:57:50.509855Z\"\n}\n```\n\u8acb\u6ce8\u610f\uff0c `state` \u5b57\u6bb5\u7684\u503c\u5df2\u66f4\u6539\u7232 `ACCEPTED` \u3002", "guide": "Recommender"}