{"title": "IAM - Manage workload identity pools and providers", "url": "https://cloud.google.com/iam/docs/manage-workload-identity-pools-providers", "abstract": "# IAM - Manage workload identity pools and providers\nThis page explains how to manage your existing [workload identity pools](/iam/docs/workload-identity-federation) and their identity providers.\nYou can manage pools and providers using the Google Cloud console, the [Google Cloud CLI](/sdk/gcloud) , or the [REST API](/iam/docs/reference/rest) .\n", "content": "## Before you begin\nCreate a workload identity pool. See one of the following pages to learn how:\n- [Access resources from AWS](/iam/docs/access-resources-aws#create) \n- [Access resources from Microsoft Azure](/iam/docs/access-resources-azure#create) \n- [Access resources from an OIDC identity provider](/iam/docs/access-resources-oidc#create) \n- [Access resources from a SAML 2.0 identity provider](/iam/docs/configuring-workload-identity-federation#saml) \n### Required roles\nTo get the permissions that you need to manage workload identity pools and providers,   ask your administrator to grant you the  following IAM roles on the project:\n- To view pools and providers: [IAM Workload Identity Pool Viewer ](https://cloud.google.com/iam/docs/understanding-roles#iam.workloadIdentityPoolViewer) (`roles/iam.workloadIdentityPoolViewer`)\n- To view, create, update, and delete pools and providers: [IAM Workload Identity Pool Admin ](https://cloud.google.com/iam/docs/understanding-roles#iam.workloadIdentityPoolAdmin) (`roles/iam.workloadIdentityPoolAdmin`)\nFor more information about granting roles, see [Manage access](/iam/docs/granting-changing-revoking-access) .\nThese predefined roles contain     the permissions required to manage workload identity pools and providers. To see the exact permissions that are   required, expand the **Required permissions** section:\nYou might also be able to get   these permissions  with [custom roles](/iam/docs/creating-custom-roles) or  other [predefined roles](/iam/docs/understanding-roles) .\n## Manage workload identity pools\nThis section shows you how to manage workload identity pools.\n### Create pools\nTo create workload identity pools in a project, do the following:\n**Note:** The prefix `gcp-` is reserved and can't be used in a pool or provider ID.\nIn the Google Cloud console, go to the **Workload Identity Pools** page.\n [Go to Workload Identity Pools](https://console.cloud.google.com/iam-admin/workload-identity-pools) Execute the [gcloud iam workload-identity-pools create](/sdk/gcloud/reference/iam/workload-identity-pools/create) command.Call [projects.locations.workloadIdentityPools.create()](/iam/docs/reference/rest/v1/projects.locations.workloadIdentityPools/create) .\n### List pools\nTo list all the workload identity pools in a project, do the following:\nIn the Google Cloud console, go to the **Workload Identity Pools** page.\n [Go to Workload Identity Pools](https://console.cloud.google.com/iam-admin/workload-identity-pools) Execute the [gcloud iam workload-identity-pools list](/sdk/gcloud/reference/iam/workload-identity-pools/list) command.Call [projects.locations.workloadIdentityPools.list()](/iam/docs/reference/rest/v1/projects.locations.workloadIdentityPools/list) .\n### Get a pool\nTo get details for a specific workload identity pool, do the following:\n- In the Google Cloud console, go to the **Workload Identity Pools** page. [Go to Workload Identity Pools](https://console.cloud.google.com/iam-admin/workload-identity-pools) \n- Find the workload identity pool that you want to view, then click its edit **Edit** icon. The Google Cloud console shows details about the workload identity pool.\nExecute the [gcloud iam workload-identity-pools describe](/sdk/gcloud/reference/iam/workload-identity-pools/describe) command.Call [projects.locations.workloadIdentityPools.get()](/iam/docs/reference/rest/v1/projects.locations.workloadIdentityPools/get) .\n### Update a pool\nYou can enable or disable a workload identity pool. You can also change its display name or description.\nTo update an existing workload identity pool, do the following:\n- In the Google Cloud console, go to the **Workload Identity Pools** page. [Go to Workload Identity Pools](https://console.cloud.google.com/iam-admin/workload-identity-pools) \n- Find the workload identity pool that you want to edit, then click its edit **Edit** icon.To disable or enable the workload identity pool, click the **Status** toggle, then click **Disable** or **Enable** .To edit the display name, click edit **Edit** next to the display name. Update the name, then click **Save** .To edit the description, use the gcloud CLI or the REST API.\nExecute the [gcloud iam workload-identity-pools update](/sdk/gcloud/reference/iam/workload-identity-pools/update) command.Call [projects.locations.workloadIdentityPools.patch()](/iam/docs/reference/rest/v1/projects.locations.workloadIdentityPools/patch) .\n### Delete a pool\nWhen you delete a workload identity pool, you also delete its workload identity pool providers. As a result, the identities in the pool lose access to Google Cloud resources.\n**Caution:** Before you delete a workload identity pool, consider [disabling the pool](#update-pool) or [disabling its identity providers](#update-provider) . If one of your workloads loses access to Google Cloud resources as a result, you can re-enable the pool and its providers at any time. If your workloads don't lose access, then it is safe to delete the pool.\nYou can [undelete a pool](#undelete-pool) for up to 30 days after deletion. After 30 days, deletion is permanent. Until a pool is permanently deleted, you cannot reuse its name when creating a new workload identity pool.\nTo delete a workload identity pool and its identity providers, do the following:\n- In the Google Cloud console, go to the **Workload Identity Pools** page. [Go to Workload Identity Pools](https://console.cloud.google.com/iam-admin/workload-identity-pools) \n- Find the workload identity pool that you want to delete, then click its edit **Edit** icon.\n- Click delete **Delete pool** , then click **Delete** . The workload identity pool and its identity providers are deleted.\nExecute the [gcloud iam workload-identity-pools delete](/sdk/gcloud/reference/iam/workload-identity-pools/delete) command.Call [projects.locations.workloadIdentityPools.delete()](/iam/docs/reference/rest/v1/projects.locations.workloadIdentityPools/delete) .\n### Undelete a pool\nYou can recover a deleted workload identity pool for up to 30 days after deletion.\nTo undelete a pool, do the following:\n- In the Google Cloud console, go to the **Workload Identity Pools** page. [Go to Workload Identity Pools](https://console.cloud.google.com/iam-admin/workload-identity-pools) \n- Click the **Show deleted pools and providers** toggle.\n- Find the workload identity pool that you want to undelete, then click its undo **Restore** icon.\n- Click **Restore** . The pool and its providers are restored.\nExecute the [gcloud iam workload-identity-pools undelete](/sdk/gcloud/reference/iam/workload-identity-pools/undelete) command.Call [projects.locations.workloadIdentityPools.undelete()](/iam/docs/reference/rest/v1/projects.locations.workloadIdentityPools/undelete) .\n[](None)\n## Manage workload identity pool providers\nThis section shows you how to manage workload identity pool providers.\n### Create a provider\nTo create a workload identity pool provider in an existing workload identity pool, do the following:\n- In the Google Cloud console, go to the **Workload Identity Pools** page. [Go to Workload Identity Pools](https://console.cloud.google.com/iam-admin/workload-identity-pools) \n- Find the workload identity pool that you want to add a provider to, then click its edit **Edit** icon.\n- Click add_box **Add provider** .\n- Select the type of provider to create:- **AWS** : An Amazon Web Services (AWS) identity provider.\n- **OpenID Connect (OIDC)** : An OIDC-compatible identity provider. This includes Microsoft Azure.\n- Enter a name for the provider.The Google Cloud console uses the name to create a provider ID. To change the provider ID, click **Edit** . You cannot change the provider ID later.\n- Complete the remaining fields for your provider:- **AWS** : Enter your AWS account ID.\n- **OIDC** : Enter the issuer URL. For Azure, the issuer URL uses the format`https://sts.windows.net/` ``. For other providers, consult the provider's documentation.\nWhen you are done, click **Continue** .\n- To configure the attribute mapping, click **Edit mapping** . Attribute mapping lets you use information about external identities to grant access to a subset of those identities.- **AWS** : This step is optional; you can use the default mapping.For details, see [Identity provider settings for AWS](/iam/docs/access-resources-aws#settings) .\n- **OIDC** : We recommend mapping `google.subject` to `assertion.sub` . Other mappings are optional.For details, see [Identity provider settings for Azure](/iam/docs/access-resources-azure#settings) or [Identity provider settings for OIDC](/iam/docs/access-resources-oidc#settings) .\n- Optional: To provide an attribute condition, which specifies the identities that can authenticate, click **Add condition** and enter a valid Common Expression Language (CEL) expression. For details, see [Attribute conditions](/iam/docs/workload-identity-federation#conditions) .\n- Click **Save** . The workload identity pool provider is created.\nExecute the [gcloud iam workload-identity-pools providers create-aws](/sdk/gcloud/reference/iam/workload-identity-pools/providers/create-aws) command to create an AWS provider.\nExecute the [gcloud iam workload-identity-pools providers create-oidc](/sdk/gcloud/reference/iam/workload-identity-pools/providers/create-oidc) command to create an OIDC provider. This includes Microsoft Azure.Call [projects.locations.workloadIdentityPools.providers.create()](/iam/docs/reference/rest/v1/projects.locations.workloadIdentityPools.providers/create) .\n### List providers\nTo list the workload identity pool providers in a project, do the following:\n- In the Google Cloud console, go to the **Workload Identity Pools** page. [Go to Workload Identity Pools](https://console.cloud.google.com/iam-admin/workload-identity-pools) \n- To view the providers for a workload identity pool, click the arrow_right **Expand node** icon for the pool.\nExecute the [gcloud iam workload-identity-pools providers list](/sdk/gcloud/reference/iam/workload-identity-pools/providers/list) command.Call [projects.locations.workloadIdentityPools.providers.list()](/iam/docs/reference/rest/v1/projects.locations.workloadIdentityPools.providers/list) .\n### Get a provider\nTo get details for a specific workload identity pool provider, do the following:\n- In the Google Cloud console, go to the **Workload Identity Pools** page. [Go to Workload Identity Pools](https://console.cloud.google.com/iam-admin/workload-identity-pools) \n- Find the workload identity pool that contains the provider, then click the arrow_right **Expand node** icon for the pool.\n- Find the workload identity pool provider that you want to view, then click its edit **Edit** icon. The Google Cloud console shows detailed information about the provider.\nExecute the [gcloud iam workload-identity-pools providers describe](/sdk/gcloud/reference/iam/workload-identity-pools/providers/describe) command.Call [projects.locations.workloadIdentityPools.providers.get()](/iam/docs/reference/rest/v1/projects.locations.workloadIdentityPools.providers/get) .\n### Update a provider\nYou can enable or disable a workload identity pool provider. You can also update its account information and its attribute mapping, as well as its display name and description.\nTo update an existing workload identity pool provider, do the following:\n- In the Google Cloud console, go to the **Workload Identity Pools** page. [Go to Workload Identity Pools](https://console.cloud.google.com/iam-admin/workload-identity-pools) \n- Find the workload identity pool that contains the provider, then click the arrow_right **Expand node** icon for the pool.\n- Find the workload identity pool provider that you want to edit, then click its edit **Edit** icon.\n- Edit the provider's information, then click **Save** .\nExecute the [gcloud iam workload-identity-pools providers update-aws](/sdk/gcloud/reference/iam/workload-identity-pools/providers/update-aws) command to update an AWS provider.\nExecute the [gcloud iam workload-identity-pools providers update-oidc](/sdk/gcloud/reference/iam/workload-identity-pools/providers/update-oidc) command to update an OIDC provider. This includes Microsoft Azure.Call [projects.locations.workloadIdentityPools.providers.patch()](/iam/docs/reference/rest/v1/projects.locations.workloadIdentityPools.providers/patch) .\n### Delete a provider\nWhen you delete a workload identity pool provider, the provider's identities lose access to Google Cloud resources.\n**Caution:** Before you delete a workload identity pool provider, consider [disabling the provider](#update-provider) . If one of your workloads loses access to Google Cloud resources as a result, you can re-enable the provider at any time. If your workloads don't lose access, then it is safe to delete the provider.\nYou can [undelete a provider](#undelete-provider) for up to 30 days after deletion. After 30 days, deletion is permanent. Until a provider is permanently deleted, you cannot reuse its name when creating a new provider.\nTo delete a workload identity pool provider, do the following:\n- In the Google Cloud console, go to the **Workload Identity Pools** page. [Go to Workload Identity Pools](https://console.cloud.google.com/iam-admin/workload-identity-pools) \n- Find the workload identity pool that contains the provider, then click its edit **Edit** icon.\n- In the **Providers** pane, find the provider that you want to delete, then click its delete **Delete** icon.\n- Click **Delete** to delete the provider.\nExecute the [gcloud iam workload-identity-pools providers delete](/sdk/gcloud/reference/iam/workload-identity-pools/providers/delete) command.Call [projects.locations.workloadIdentityPools.providers.delete()](/iam/docs/reference/rest/v1/projects.locations.workloadIdentityPools.providers/delete) .\n### Undelete a provider\nYou can recover a deleted workload identity pool provider for up to 30 days after deletion. To undelete a provider:\n- In the Google Cloud console, go to the **Workload Identity Pools** page. [Go to Workload Identity Pools](https://console.cloud.google.com/iam-admin/workload-identity-pools) \n- Click the **Show deleted pools and providers** toggle.\n- Find the workload identity pool that contains the provider, then click the arrow_right **Expand node** icon for the pool.\n- Find the provider that you want to undelete, then click its undo **Restore** icon.\n- Click **Restore** . The provider is restored.\nExecute the [gcloud iam workload-identity-pools providers undelete](/sdk/gcloud/reference/iam/workload-identity-pools/providers/undelete) command.Call [projects.locations.workloadIdentityPools.providers.undelete()](/iam/docs/reference/rest/v1/projects.locations.workloadIdentityPools.providers/undelete) .\n## Manage constraints for workload identity federation\nYou can use [organization policy constraints](/resource-manager/docs/organization-policy/overview#constraints) to restrict how resources in your Google Cloud organization can be used.\nThis section describes constraints that are recommended when you use workload identity federation.\n### Restrict identity provider configuration\nAs an organization administrator, you can decide which identity providers your organization is allowed to federate with.\nTo manage which identity providers are allowed, enable the `constraints/iam.workloadIdentityPoolProviders` list constraint in the organization policy for your organization. This constraint specifies the issuer URIs of the allowed providers. You can use the [Google Cloud console](/resource-manager/docs/organization-policy/creating-managing-policies#list_constraints) or the [Google Cloud CLI](/resource-manager/docs/organization-policy/using-constraints#list-constraint) to enable this constraint.\n**Note:** This constraint only limits creating and updating identity providers. If an identity provider was configured before you enabled the constraint, that provider can still be used.\nTo only allow federation from AWS, create a single constraint with the URI `https://sts.amazonaws.com` . The following example shows how to create this constraint using the gcloud CLI:\n```\ngcloud resource-manager org-policies allow constraints/iam.workloadIdentityPoolProviders \\\u00a0 \u00a0 \u00a0https://sts.amazonaws.com --organization=ORGANIZATION_NUMBER\n```\nYou can also specify which AWS account IDs have access to your Google Cloud resources. To specify the account IDs, use the `constraints/iam.workloadIdentityPoolAwsAccounts` list constraint:\n```\ngcloud resource-manager org-policies allow constraints/iam.workloadIdentityPoolAwsAccounts \\\u00a0 \u00a0 ACCOUNT_ID --organization=ORGANIZATION_NUMBER\n```\nTo only allow federation from one OIDC provider, create a single constraint with the `issuer_uri` of the allowed provider. For example, the following only allows federation from a specific Azure tenant:\n```\ngcloud resource-manager org-policies allow constraints/iam.workloadIdentityPoolProviders \\\u00a0 \u00a0 \u00a0https://sts.windows.net/AZURE_TENANT_ID --organization=ORGANIZATION_NUMBER\n```\nFederation from a SAML identity provider is a special case because the public keys used to validate the assertion are provided at configuration time instead of fetched directly from the identity provider. It is therefore conceivable that a malicious user could try to upload a SAML metadata document with your organization's identity provider's entity ID but a public key for which they have access to the private key. Restricting federation by the entity ID in this scenario gives only an illusion of security. For this reason we strongly advise that you only allow the creation of a workload identity pool allowing SAML federation in a Google Cloud project that your organization centrally manages. You can then grant external identities in that workload identity pool access to resources across your organization.\nTo allow federation from from SAML identity providers, create a constraint allowing the special keyword `KEY_UPLOAD` .\n```\ngcloud resource-manager org-policies allow constraints/iam.workloadIdentityPoolProviders \\\u00a0 \u00a0 \u00a0KEY_UPLOAD --organization=ORGANIZATION_NUMBER\n```\nYou can repeat these commands to allow federation from additional providers.\nTo block federation from all providers:\n- Create a YAML file containing the following:```\nconstraint: constraints/iam.workloadIdentityPoolProviderslistPolicy:\u00a0 allValues: DENY\n```\n- Pass the file to the [gcloud resource-manager org-policies set-policy](/sdk/gcloud/reference/resource-manager/org-policies/set-policy) command:```\ngcloud resource-manager org-policies set-policy FILE_NAME.yaml \\\u00a0 \u00a0 --organization=ORGANIZATION_NUMBER\n```\n### Restrict service account key creation\nWorkload identity federation lets you access Google Cloud resources from outside of Google Cloud without using a service account key. If you never use service account keys to authenticate, you can help reduce risk by disabling key creation.\nTo disable the creation of service account keys, enforce the `iam.disableServiceAccountKeyCreation` boolean constraint in the organization policy for your organization. You can also enforce the `iam.disableServiceAccountKeyUpload` boolean constraint, which disables uploading of public keys for service accounts.\nYou can use the [Google Cloud console](/resource-manager/docs/organization-policy/creating-managing-policies#boolean_constraints) or the [gcloud CLI](/resource-manager/docs/organization-policy/using-constraints#boolean-constraint) to enable these constraints. For example, the following gcloud CLI commands enable both constraints:\n```\ngcloud resource-manager org-policies enable-enforce \\\u00a0 \u00a0 constraints/iam.disableServiceAccountKeyCreation \\\u00a0 \u00a0 --organization=ORGANIZATION_NUMBERgcloud resource-manager org-policies enable-enforce \\\u00a0 \u00a0 constraints/iam.disableServiceAccountKeyUpload \\\u00a0 \u00a0 --organization=ORGANIZATION_NUMBER\n```\n## Monitor workload identity federation\nYou can use [Cloud Monitoring](/monitoring/docs) metrics to monitor authentication events for your workload identity pools and providers. For a list of available metrics, see [IAM metrics](/monitoring/api/metrics_gcp#gcp-iam) .\n## What's next\nLearn more about [workload identity federation](/iam/docs/workload-identity-federation) .", "guide": "IAM"}