{"title": "IAM - \u9650\u5236\u6191\u64da\u7684 Cloud Storage \u6b0a\u9650", "url": "https://cloud.google.com/iam/docs/downscoping-short-lived-credentials?hl=zh-cn", "abstract": "# IAM - \u9650\u5236\u6191\u64da\u7684 Cloud Storage \u6b0a\u9650\n\u672c\u9801\u9762\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528\u6191\u64da\u8a2a\u554f\u908a\u754c\u4f86\u7e2e\u5c0f\u6216\u9650\u5236\u77ed\u671f\u6709\u6548\u7684\u6191\u64da\u53ef\u4ee5\u4f7f\u7528\u7684 Identity and Access Management (IAM) \u6b0a\u9650\u7bc4\u570d\u3002\n\u60a8\u53ef\u4ee5\u4f7f\u7528\u6191\u64da\u8a2a\u554f\u908a\u754c\u751f\u6210 OAuth 2.0 \u8a2a\u554f\u4ee4\u724c\uff0c\u9019\u4e9b\u4ee4\u724c\u4ee3\u8868\u670d\u52d9\u8cec\u865f\uff0c\u4f46\u5177\u6709\u7684\u6b0a\u9650\u5c11\u65bc\u670d\u52d9\u8cec\u865f\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u7684\u67d0\u500b\u5ba2\u6236\u9700\u8981\u8a2a\u554f\u60a8\u63a7\u5236\u7684 Cloud Storage \u6578\u64da\uff0c\u5247\u53ef\u4ee5\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u5275\u5efa\u4e00\u500b\u53ef\u8a2a\u554f\u60a8\u64c1\u6709\u7684\u6bcf\u500b Cloud Storage \u5b58\u5132\u6876\u7684\u670d\u52d9\u8cec\u865f\u3002\n- \u7232\u6b64\u670d\u52d9\u8cec\u865f\u751f\u6210 OAuth 2.0 \u8a2a\u554f\u4ee4\u724c\u3002\n- \u61c9\u7528\u6191\u64da\u8a2a\u554f\u908a\u754c\uff0c\u4ee5\u50c5\u5141\u8a31\u8a2a\u554f\u5305\u542b\u60a8\u7684\u5ba2\u6236\u6578\u64da\u7684\u5b58\u5132\u6876\u3002", "content": "## \u6191\u64da\u8a2a\u554f\u908a\u754c\u7684\u5de5\u4f5c\u539f\u7406\n\u8981\u7e2e\u5c0f\u6b0a\u9650\u7bc4\u570d\uff0c\u60a8\u9700\u8981\u5b9a\u7fa9\u6191\u64da\u8a2a\u554f\u908a\u754c\uff08\u7528\u4f86\u6307\u5b9a\u77ed\u671f\u6709\u6548\u7684\u6191\u64da\u53ef\u4ee5\u8a2a\u554f\u7684\u8cc7\u6e90\uff09\uff0c\u4ee5\u53ca\u5728\u5404\u8cc7\u6e90\u4e0a\u53ef\u7528\u6b0a\u9650\u7684\u4e0a\u9650\u3002\u7136\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5275\u5efa\u4e00\u500b\u77ed\u671f\u6709\u6548\u7684\u6191\u64da\uff0c\u4e26\u7528\u5176\u4ea4\u63db\u9075\u5faa\u6191\u64da\u8a2a\u554f\u908a\u754c\u7684\u65b0\u6191\u64da\u3002\n**\u6ce8\u610f** \uff1a\u53ea\u6709 Cloud Storage \u652f\u6301\u6191\u64da\u8a2a\u554f\u908a\u754c\u3002\u5176\u4ed6 Google Cloud \u670d\u52d9\u4e0d\u652f\u6301\u6b64\u529f\u80fd\u3002\n\u5982\u679c\u60a8\u9700\u8981\u91dd\u5c0d\u6bcf\u500b\u6703\u8a71\u7232\u4e3b\u8cec\u865f\u63d0\u4f9b\u4e00\u7d44\u4e0d\u540c\u7684\u6b0a\u9650\uff0c\u5247\u8207\u5275\u5efa\u591a\u500b\u4e0d\u540c\u7684\u670d\u52d9\u8cec\u865f\u4f75\u7232\u6bcf\u500b\u670d\u52d9\u8cec\u865f\u6388\u4e88\u4e00\u7d44\u4e0d\u540c\u7684\u89d2\u8272\u76f8\u6bd4\uff0c\u4f7f\u7528\u6191\u64da\u8a2a\u554f\u908a\u754c\u66f4\u9ad8\u6548\u3002\n## \u6191\u64da\u8a2a\u554f\u908a\u754c\u7684\u793a\u4f8b\n\u4ee5\u4e0b\u5404\u500b\u90e8\u5206\u5c55\u793a\u4e86\u5e38\u898b\u4f7f\u7528\u5834\u666f\u7684\u6191\u64da\u8a2a\u554f\u908a\u754c\u793a\u4f8b\u3002\u60a8\u5728 [\u4f7f\u7528 OAuth 2.0 \u8a2a\u554f\u4ee4\u724c\u63db\u53d6\u4f5c\u7528\u57df\u4ee4\u724c](#exchange-credential) \u6642\uff0c\u53ef\u4ee5\u4f7f\u7528\u6191\u64da\u8a2a\u554f\u908a\u754c\u3002\n### \u9650\u5236\u5b58\u5132\u5206\u5340\u7684\u6b0a\u9650\n\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u4e86\u4e00\u500b\u7c21\u55ae\u7684\u6191\u64da\u8a2a\u554f\u908a\u754c\u3002\u5b83\u61c9\u7528\u65bc Cloud Storage \u5b58\u5132\u5206\u5340 `example-bucket` \uff0c\u4e26\u4e14\u5c07\u6b0a\u9650\u4e0a\u9650\u8a2d\u7f6e\u7232 Storage Object Viewer \u89d2\u8272 ( `roles/storage.objectViewer` ) \u4e2d\u5305\u542b\u7684\u6b0a\u9650\uff1a\n```\n{\u00a0 \"accessBoundary\": {\u00a0 \u00a0 \"accessBoundaryRules\": [\u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \"availablePermissions\": [\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"inRole:roles/storage.objectViewer\"\u00a0 \u00a0 \u00a0 \u00a0 ],\u00a0 \u00a0 \u00a0 \u00a0 \"availableResource\": \"//storage.googleapis.com/projects/_/buckets/example-bucket\"\u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 ]\u00a0 }}\n```\n### \u9650\u5236\u591a\u500b\u5b58\u5132\u5206\u5340\u7684\u6b0a\u9650\n\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u4e86\u4e00\u500b\u6191\u64da\u8a2a\u554f\u908a\u754c\uff0c\u5176\u4e2d\u5305\u542b\u591a\u500b\u5b58\u5132\u5206\u5340\u7684\u898f\u5247\uff1a\n- Cloud Storage \u5b58\u5132\u5206\u5340`example-bucket-1`\uff1a\u5c0d\u65bc\u6b64\u5b58\u5132\u5206\u5340\uff0c\u53ea\u6709 Storage Object Viewer \u89d2\u8272 (`roles/storage.objectViewer`) \u4e2d\u7684\u6b0a\u9650\u53ef\u7528\u3002\n- Cloud Storage \u5b58\u5132\u5206\u5340`example-bucket-2`\uff1a\u5c0d\u65bc\u6b64\u5b58\u5132\u5206\u5340\uff0c\u53ea\u6709 Storage Object Creator \u89d2\u8272 (`roles/storage.objectCreator`) \u4e2d\u7684\u6b0a\u9650\u53ef\u7528\u3002\n```\n{\u00a0 \"accessBoundary\": {\u00a0 \u00a0 \"accessBoundaryRules\": [\u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \"availablePermissions\": [\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"inRole:roles/storage.objectViewer\"\u00a0 \u00a0 \u00a0 \u00a0 ],\u00a0 \u00a0 \u00a0 \u00a0 \"availableResource\": \"//storage.googleapis.com/projects/_/buckets/example-bucket-1\"\u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \"availablePermissions\": [\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"inRole:roles/storage.objectCreator\"\u00a0 \u00a0 \u00a0 \u00a0 ],\u00a0 \u00a0 \u00a0 \u00a0 \"availableResource\": \"//storage.googleapis.com/projects/_/buckets/example-bucket-2\"\u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 ]\u00a0 }}\n```\n### \u9650\u5236\u7279\u5b9a\u5c0d\u8c61\u7684\u6b0a\u9650\n\u60a8\u9084\u53ef\u4ee5\u4f7f\u7528 [IAM Conditions](https://cloud.google.com/iam/docs/conditions-overview?hl=zh-cn) \u6307\u5b9a\u4e3b\u8cec\u865f\u53ef\u4ee5\u8a2a\u554f\u54ea\u4e9b Cloud Storage \u5c0d\u8c61\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u6dfb\u52a0\u4e00\u500b\u689d\u4ef6\uff0c\u8a72\u689d\u4ef6\u4f7f\u6b0a\u9650\u53ef\u7528\u65bc\u540d\u7a31\u4ee5 `customer-a` \u958b\u982d\u7684\u5c0d\u8c61\uff1a\n```\n{\u00a0 \"accessBoundary\": {\u00a0 \u00a0 \"accessBoundaryRules\": [\u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \"availablePermissions\": [\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"inRole:roles/storage.objectViewer\"\u00a0 \u00a0 \u00a0 \u00a0 ],\u00a0 \u00a0 \u00a0 \u00a0 \"availableResource\": \"//storage.googleapis.com/projects/_/buckets/example-bucket\",\u00a0 \u00a0 \u00a0 \u00a0 \"availabilityCondition\": {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"expression\" : \"resource.name.startsWith('projects/_/buckets/example-bucket/objects/customer-a')\"\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 ]\u00a0 }}\n```\n### \u5217\u51fa\u5c0d\u8c61\u6642\u9650\u5236\u6b0a\u9650\n\u7576\u60a8 [\u5217\u51fa Cloud Storage \u5b58\u5132\u5206\u5340\u4e2d\u7684\u5c0d\u8c61](https://cloud.google.com/storage/docs/json_api/v1/objects/list?hl=zh-cn) \u6642\uff0c\u6703\u91dd\u5c0d\u5b58\u5132\u5206\u5340\u8cc7\u6e90\uff08\u800c\u4e0d\u662f\u5c0d\u8c61\u8cc7\u6e90\uff09\u8abf\u7528\u65b9\u6cd5\u3002\u56e0\u6b64\uff0c\u5982\u679c\u7cfb\u7d71\u7232\u5217\u51fa\u8acb\u6c42\u8a08\u7b97\u4e86\u689d\u4ef6\uff0c\u4e26\u4e14\u8a72\u689d\u4ef6\u5f15\u7528\u4e86 [\u8cc7\u6e90\u540d\u7a31](https://cloud.google.com/iam/docs/conditions-attribute-reference?hl=zh-cn#resource-name) \uff0c\u5247\u8cc7\u6e90\u540d\u7a31\u5c07\u6a19\u8b58\u5b58\u5132\u5206\u5340\uff0c\u800c\u4e0d\u662f\u8a72\u5b58\u5132\u5206\u5340\u4e2d\u7684\u5c0d\u8c61\u3002\u4f8b\u5982\uff0c\u7576\u60a8\u5217\u51fa `example-bucket` \u4e2d\u7684\u5c0d\u8c61\u6642\uff0c\u8cc7\u6e90\u540d\u7a31\u7232 `projects/_/buckets/example-bucket` \u3002\n\u7576\u60a8\u5217\u51fa\u5c0d\u8c61\u6642\uff0c\u6b64\u547d\u540d\u6163\u4f8b\u53ef\u80fd\u6703\u5c0e\u81f4\u610f\u5916\u884c\u7232\u3002\u4f8b\u5982\uff0c\u5047\u8a2d\u60a8\u9700\u8981\u4e00\u500b\u6191\u64da\u8a2a\u554f\u908a\u754c\uff0c\u7528\u65bc\u5141\u8a31\u67e5\u770b `example-bucket` \u4e2d\u524d\u7db4\u7232 `customer-a/invoices/` \u7684\u5c0d\u8c61\u3002\u60a8\u53ef\u4ee5\u5617\u8a66\u5728\u6191\u64da\u8a2a\u554f\u908a\u754c\u4e2d\u4f7f\u7528\u4ee5\u4e0b\u689d\u4ef6\uff1a\n\u4e0d\u5b8c\u6574\uff1a\u50c5\u6aa2\u67e5\u8cc7\u6e90\u540d\u7a31\u7684\u689d\u4ef6\n```\nresource.name.startsWith('projects/_/buckets/example-bucket/objects/customer-a/invoices/')\n```\n\u6b64\u689d\u4ef6\u9069\u7528\u65bc\u8b80\u53d6\u5c0d\u8c61\uff0c\u4f46\u4e0d\u9069\u7528\u65bc\u5217\u51fa\u5c0d\u8c61\uff1a\n- \u7576\u4e3b\u8cec\u865f\u5617\u8a66\u8b80\u53d6`example-bucket`\u4e2d\u524d\u7db4\u7232`customer-a/invoices/`\u7684\u5c0d\u8c61\u6642\uff0c\u8a72\u689d\u4ef6\u7684\u8a08\u7b97\u7d50\u679c\u7232`true`\u3002\n- \u7576\u4e3b\u8cec\u865f\u5617\u8a66\u5217\u51fa\u5177\u6709\u8a72\u524d\u7db4\u7684\u5c0d\u8c61\u6642\uff0c\u8a72\u689d\u4ef6\u7684\u8a08\u7b97\u7d50\u679c\u7232`false`\u3002`resource.name`\u7684\u503c\u7232`projects/_/buckets/example-bucket`\uff08\u6c92\u6709\u4ee5`projects/_/buckets/example-bucket/objects/customer-a/invoices/`\u958b\u982d\uff09\u3002\n\u7232\u4e86\u9632\u6b62\u6b64\u554f\u984c\uff0c\u9664\u4e86\u4f7f\u7528 `resource.name.startsWith()` \u4e4b\u5916\uff0c\u60a8\u7684\u689d\u4ef6\u9084\u53ef\u4ee5\u6aa2\u67e5\u540d\u7232 `storage.googleapis.com/objectListPrefix` \u7684 [API \u7279\u6027](https://cloud.google.com/iam/docs/conditions-attribute-reference?hl=zh-cn#api) \u3002\u6b64\u7279\u6027\u5305\u542b\u7528\u65bc\u904e\u6ffe\u5c0d\u8c61\u5217\u8868\u7684 `prefix` \u53c3\u6578\u7684\u503c\u3002\u56e0\u6b64\uff0c\u60a8\u53ef\u4ee5\u7de8\u5beb\u4e00\u500b\u5f15\u7528 `prefix` \u53c3\u6578\u7684\u503c\u7684\u689d\u4ef6\u3002\n**\u8b66\u544a** \uff1a\u53ea\u6709\u6191\u64da\u8a2a\u554f\u908a\u754c\u652f\u6301 Cloud Storage \u7684 API \u7279\u6027\u3002\u5982\u679c\u60a8\u5728\u689d\u4ef6\u89d2\u8272\u7d81\u5b9a\u4e2d\u4f7f\u7528 Cloud Storage API \u7279\u6027\uff0c\u5247 Cloud Storage \u65b9\u6cd5\u5c07\u7121\u6cd5\u6b63\u5e38\u904b\u4f5c\uff0c\u4e26\u4e14\u6703\u610f\u5916\u5931\u6557\u3002\u6b64\u5916\uff0c\u7576\u60a8\u8a2a\u554f Cloud Storage \u6642\uff0c\u6aa2\u67e5 IAM \u6b0a\u9650\u53ef\u80fd\u9700\u8981\u8f03\u9577\u7684\u6642\u9593\u3002\n\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u77ad\u5982\u4f55\u5728\u689d\u4ef6\u4e2d\u4f7f\u7528 API \u7279\u6027\u3002\u5b83\u5141\u8a31\u8b80\u53d6\u548c\u5217\u51fa `example-bucket` \u4e2d\u524d\u7db4\u7232 `customer-a/invoices/` \u7684\u5c0d\u8c61\uff1a\n\u5b8c\u6574\uff1a\u6aa2\u67e5\u8cc7\u6e90\u540d\u7a31\u548c\u524d\u7db4\u7684\u689d\u4ef6\n```\nresource.name.startsWith('projects/_/buckets/example-bucket/objects/customer-a/invoices/') ||\n api.getAttribute('storage.googleapis.com/objectListPrefix', '')\n      .startsWith('customer-a/invoices/')\n```\n\u73fe\u5728\uff0c\u60a8\u53ef\u4ee5\u5728\u6191\u64da\u8a2a\u554f\u908a\u754c\u4e2d\u4f7f\u7528\u6b64\u689d\u4ef6\uff1a\n```\n{\u00a0 \"accessBoundary\": {\u00a0 \u00a0 \"accessBoundaryRules\": [\u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \"availablePermissions\": [\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"inRole:roles/storage.objectViewer\"\u00a0 \u00a0 \u00a0 \u00a0 ],\u00a0 \u00a0 \u00a0 \u00a0 \"availableResource\": \"//storage.googleapis.com/projects/_/buckets/example-bucket\",\u00a0 \u00a0 \u00a0 \u00a0 \"availabilityCondition\": {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"expression\":\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"resource.name.startsWith('projects/_/buckets/example-bucket/objects/customer-a/invoices/') || api.getAttribute('storage.googleapis.com/objectListPrefix', '').startsWith('customer-a/invoices/')\"\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 ]\u00a0 }}\n```\n## \u6e96\u5099\u5de5\u4f5c\n\u5728\u4f7f\u7528\u6191\u64da\u8a2a\u554f\u908a\u754c\u4e4b\u524d\uff0c\u8acb\u78ba\u4fdd\u6eff\u8db3\u4ee5\u4e0b\u8981\u6c42\uff1a\n- \u60a8\u9700\u8981\u53ea\u91dd\u5c0d Cloud Storage \u7e2e\u5c0f\u6b0a\u9650\u7bc4\u570d\uff0c\u800c\u4e0d\u5c0d\u5176\u4ed6 Google Cloud \u670d\u52d9\u9019\u6a23\u505a\u3002\u5982\u679c\u60a8\u9700\u8981\u7e2e\u5c0f\u91dd\u5c0d\u5176\u4ed6 Google Cloud \u670d\u52d9\u7684\u6b0a\u9650\u7bc4\u570d\uff0c\u60a8\u53ef\u4ee5\u5275\u5efa\u591a\u500b [\u670d\u52d9\u8cec\u865f](https://cloud.google.com/iam/docs/service-accounts?hl=zh-cn) \u4f75\u7232\u6bcf\u500b\u670d\u52d9\u8cec\u865f\u6388\u4e88\u4e00\u7d44\u4e0d\u540c\u7684\u89d2\u8272\u3002\n- \u60a8\u53ef\u4ee5\u4f7f\u7528 [OAuth 2.0 \u8a2a\u554f\u4ee4\u724c](https://cloud.google.com/iam/docs/creating-short-lived-service-account-credentials?hl=zh-cn#sa-credentials-oauth) \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 \u5176\u4ed6\u985e\u578b\u7684\u77ed\u671f\u6709\u6548\u7684\u6191\u64da\u4e0d\u652f\u6301\u6191\u64da\u8a2a\u554f\u908a\u754c\u529f\u80fd\u3002\n\u6b64\u5916\uff0c\u60a8\u9084\u5fc5\u9808\u5553\u7528\u6240\u9700\u7684 API\uff1a\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5553\u7528 IAM and Security Token Service API\u3002 [\u5553\u7528 API](https://console.cloud.google.com/flows/enableapi?apiid=iam.googleapis.com%2Csts.googleapis.com&%3Bredirect=https%3A%2F%2Fconsole.cloud.google.com&hl=zh-cn) ## \u5275\u5efa\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u77ed\u671f\u6709\u6548\u7684\u6191\u64da\n\u8981\u5275\u5efa\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684 OAuth 2.0 \u8a2a\u554f\u4ee4\u724c\uff0c\u8acb\u6309\u4ee5\u4e0b\u6b65\u9a5f\u64cd\u4f5c\uff1a\n- \u5411\u7528\u6236\u6216\u670d\u52d9\u8cec\u865f [\u6388\u4e88\u76f8\u61c9\u7684 IAM \u89d2\u8272](#grant-roles) \u3002\n- [\u5b9a\u7fa9\u4e00\u500b\u6191\u64da\u8a2a\u554f\u908a\u754c](#define-boundary) \uff0c\u4ee5\u8a2d\u7f6e\u7528\u6236\u6216\u670d\u52d9\u8cec\u865f\u53ef\u7528\u6b0a\u9650\u7684\u4e0a\u9650\u3002\n- \u7232\u7528\u6236\u6216\u670d\u52d9\u8cec\u865f [\u5275\u5efa OAuth 2.0 \u8a2a\u554f\u4ee4\u724c](#create-credential) \u3002\n- \u7528 [OAuth 2.0 \u8a2a\u554f\u4ee4\u724c](#exchange-credential) \u4ea4\u63db\u9075\u5faa\u6191\u64da\u8a2a\u554f\u908a\u754c\u7684\u65b0\u4ee4\u724c\u3002\n\u7136\u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u65b0 OAuth 2.0 \u8a2a\u554f\u4ee4\u724c\uff0c\u9a57\u8b49\u91dd\u5c0d Cloud Storage \u7684\u8acb\u6c42\u7684\u8eab\u4efd\u3002\n### \u6388\u4e88 IAM \u89d2\u8272\n\u6191\u64da\u8a2a\u554f\u908a\u754c\u8a2d\u7f6e\u4e86\u53ef\u7528\u65bc\u7279\u5b9a\u8cc7\u6e90\u7684\u6b0a\u9650\u7684\u4e0a\u9650\u3002\u5b83\u53ef\u4ee5\u522a\u6e1b\u4e3b\u8cec\u865f\u5df2\u7372\u53d6\u7684\u6b0a\u9650\uff0c\u4f46\u7121\u6cd5\u6dfb\u52a0\u8a72\u4e3b\u8cec\u865f\u5c1a\u672a\u64c1\u6709\u7684\u6b0a\u9650\u3002\n\u56e0\u6b64\uff0c\u60a8\u9084\u5fc5\u9808 [\u5728 Cloud Storage \u5b58\u5132\u6876](https://cloud.google.com/storage/docs/access-control/using-iam-permissions?hl=zh-cn#bucket-add) \u4e0a\uff0c\u6216 [\u66f4\u9ad8\u7d1a\u5225\u7684\u8cc7\u6e90](https://cloud.google.com/iam/docs/granting-changing-revoking-access?hl=zh-cn) \uff08\u4f8b\u5982\u9805\u76ee\uff09\u4e0a\u5411\u4e3b\u8cec\u865f\u6388\u4e88\u63d0\u4f9b\u6240\u9700\u6b0a\u9650\u7684\u89d2\u8272\u3002\n\u4f8b\u5982\uff0c\u5047\u8a2d\u60a8\u9700\u8981\u5275\u5efa\u4e00\u500b\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u77ed\u671f\u6709\u6548\u7684\u6191\u64da\uff0c\u4ee5\u5141\u8a31\u670d\u52d9\u8cec\u865f\u5728\u5b58\u5132\u5206\u5340\u4e2d\u5275\u5efa\u5c0d\u8c61\uff1a\n- \u60a8\u5fc5\u9808\u81f3\u5c11\u5411\u670d\u52d9\u8cec\u865f\u6388\u4e88\u5305\u542b`storage.objects.create`\u6b0a\u9650\u7684\u89d2\u8272\uff0c\u4f8b\u5982 Storage Object Creator \u89d2\u8272 (`roles/storage.objectCreator`)\u3002\u6191\u64da\u8a2a\u554f\u908a\u754c\u4e5f\u5fc5\u9808\u5305\u542b\u6b64\u6b0a\u9650\u3002\n- \u60a8\u9084\u53ef\u4ee5\u6388\u4e88\u5176\u5305\u542b\u66f4\u591a\u6b0a\u9650\u7684\u89d2\u8272\uff0c\u4f8b\u5982 Storage Object Admin \u89d2\u8272 (`roles/storage.objectAdmin`)\u3002\u670d\u52d9\u8cec\u865f\u53ea\u80fd\u4f7f\u7528\u540c\u6642\u51fa\u73fe\u5728\u89d2\u8272\u6388\u6b0a\u548c\u6191\u64da\u8a2a\u554f\u908a\u754c\u4e2d\u7684\u6b0a\u9650\u3002\n\u5982\u9700\u77ad\u89e3 Cloud Storage \u7684\u9810\u5b9a\u7fa9\u89d2\u8272\uff0c\u8acb\u53c3\u95b1 [Cloud Storage \u89d2\u8272](https://cloud.google.com/iam/docs/understanding-roles?hl=zh-cn#cloud-storage-roles) \u3002\n### \u6191\u64da\u8a2a\u554f\u908a\u754c\u7684\u7d44\u6210\u90e8\u5206\n\u6191\u64da\u8a2a\u554f\u908a\u754c\u662f\u5305\u542b\u4e00\u7cfb\u5217\u8a2a\u554f\u908a\u754c\u898f\u5247 \u7684\u5c0d\u8c61\u3002\u6bcf\u689d\u898f\u5247\u90fd\u5305\u542b\u4ee5\u4e0b\u4fe1\u606f\uff1a\n- \u61c9\u7528\u8a72\u898f\u5247\u7684\u8cc7\u6e90\u3002\n- \u5728\u8a72\u8cc7\u6e90\u4e0a\u53ef\u7528\u7684\u6b0a\u9650\u4e0a\u9650\u3002\n- \u53ef\u9078\uff1a\u9032\u4e00\u6b65\u9650\u5236\u6b0a\u9650\u7684\u689d\u4ef6\u3002\u689d\u4ef6\u5305\u62ec\u4ee5\u4e0b\u5167\u5bb9\uff1a\n- \u8a08\u7b97\u7d50\u679c\u7232`true`\u6216`false`\u7684\u689d\u4ef6\u8868\u9054\u5f0f\u3002\u5982\u679c\u8a08\u7b97\u7d50\u679c\u7232`true`\uff0c\u5247\u5141\u8a31\u8a2a\u554f\uff1b\u5426\u5247\u62d2\u7d55\u8a2a\u554f\u3002\n- \u53ef\u9078\uff1a\u6a19\u8b58\u689d\u4ef6\u7684\u6a19\u984c\u3002\n- \u53ef\u9078\uff1a\u5305\u542b\u6709\u95dc\u689d\u4ef6\u7684\u66f4\u591a\u4fe1\u606f\u7684\u8aaa\u660e\u3002\u5982\u679c\u60a8\u5c07\u6191\u64da\u8a2a\u554f\u908a\u754c\u61c9\u7528\u65bc\u77ed\u671f\u6709\u6548\u7684\u6191\u64da\uff0c\u5247\u8a72\u6191\u64da\u53ea\u80fd\u8a2a\u554f\u6191\u64da\u8a2a\u554f\u908a\u754c\u4e2d\u7684\u8cc7\u6e90\uff0c\u4e0d\u80fd\u7372\u5f97\u5728\u5176\u4ed6\u8cc7\u6e90\u4e0a\u53ef\u7528\u7684\u6b0a\u9650\u3002\n\u6191\u8b49\u8a2a\u554f\u908a\u754c\u6700\u591a\u53ef\u4ee5\u5305\u542b 10 \u689d\u8a2a\u554f\u908a\u754c\u898f\u5247\u3002\u60a8\u53ea\u80fd\u7232\u6bcf\u500b\u77ed\u671f\u6709\u6548\u7684\u6191\u64da\u61c9\u7528\u4e00\u500b\u6191\u64da\u8a2a\u554f\u908a\u754c\u3002\n\u4ee5 JSON \u5c0d\u8c61\u7684\u5f62\u5f0f\u8868\u793a\u6642\uff0c\u6191\u64da\u8a2a\u554f\u908a\u754c\u5305\u542b\u4ee5\u4e0b\u5b57\u6bb5\uff1a\n| \u5b57\u6bb5                 | \u5b57\u6bb5.1                                                                                      |\n|:-----------------------------------------------------------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| accessBoundary               | object \u6191\u64da\u8a2a\u554f\u908a\u754c\u7684\u5c01\u88dd\u5bb9\u5668\u3002                                                                                |\n| accessBoundary.accessBoundaryRules[]         | object \u61c9\u7528\u65bc\u77ed\u671f\u6709\u6548\u7684\u6191\u64da\u7684\u8a2a\u554f\u908a\u754c\u898f\u5247\u7684\u5217\u8868\u3002                                                                           |\n| accessBoundary.accessBoundaryRules[].availablePermissions[]   | string \u7528\u65bc\u5b9a\u7fa9\u5c0d\u65bc\u8cc7\u6e90\u53ef\u7528\u7684\u6b0a\u9650\u4e0a\u9650\u7684\u5217\u8868\u3002 \u6bcf\u500b\u503c\u90fd\u662f\u4e00\u500b IAM \u9810\u5b9a\u7fa9\u89d2\u8272\u6216\u81ea\u5b9a\u7fa9\u89d2\u8272\u7684\u6a19\u8b58\u7b26\uff0c\u4e26\u4e14\u5e36\u6709\u524d\u7db4 inRole:\u3002\u4f8b\u5982\uff1ainRole:roles/storage.objectViewer\u3002\u53ea\u80fd\u4f7f\u7528\u9019\u4e9b\u89d2\u8272\u4e2d\u7684\u6b0a\u9650\u3002 \u6ce8\u610f\uff1a\u60a8\u4e0d\u80fd\u76f4\u63a5\u6307\u5b9a\u6b0a\u9650\u540d\u7a31\uff0c\u800c\u61c9\u6307\u5b9a\u5305\u542b\u76f8\u61c9\u6b0a\u9650\u7684\u89d2\u8272\u3002\u5982\u679c\u9700\u8981\uff0c\u60a8\u53ef\u4ee5\u5275\u5efa\u81ea\u5b9a\u7fa9\u89d2\u8272\uff0c\u4e26\u50c5\u5728\u5176\u4e2d\u5305\u542b\u60a8\u9700\u8981\u7684\u6b0a\u9650\u3002           |\n| accessBoundary.accessBoundaryRules[].availableResource     | string \u61c9\u7528\u898f\u5247\u7684 Cloud Storage \u5b58\u5132\u5206\u5340\u7684\u5b8c\u6574\u8cc7\u6e90\u540d\u7a31\u3002\u8acb\u4f7f\u7528\u6b64\u683c\u5f0f\uff1a//storage.googleapis.com/projects/_/buckets/bucket-name\u3002                                                        |\n| accessBoundary.accessBoundaryRules[].availabilityCondition    | object \u53ef\u9078\u3002\u9650\u5236\u5c0d\u7279\u5b9a Cloud Storage \u5c0d\u8c61\u7684\u6b0a\u9650\u53ef\u7528\u6027\u7684\u689d\u4ef6\u3002 \u5982\u679c\u8981\u4f7f\u6b0a\u9650\u53ef\u7528\u65bc\u7279\u5b9a\u7684\u5c0d\u8c61\uff08\u800c\u4e0d\u662f Cloud Storage \u5b58\u5132\u5206\u5340\u4e2d\u7684\u6240\u6709\u5c0d\u8c61\uff09\uff0c\u8acb\u4f7f\u7528\u6b64\u5b57\u6bb5\u3002                                                 |\n| accessBoundary.accessBoundaryRules[].availabilityCondition.expression | string \u4e00\u500b\u689d\u4ef6\u8868\u9054\u5f0f\uff0c\u7528\u65bc\u6307\u5b9a\u53ef\u4ee5\u4f7f\u7528\u6b0a\u9650\u7684 Cloud Storage \u5c0d\u8c61\u3002 \u5982\u9700\u77ad\u89e3\u5982\u4f55\u5728\u689d\u4ef6\u8868\u9054\u5f0f\u4e2d\u5f15\u7528\u7279\u5b9a\u7684\u5c0d\u8c61\uff0c\u8acb\u53c3\u95b1 resource.name \u7279\u6027\u3002 \u6ce8\u610f\uff1a\u5982\u679c\u60a8\u7684\u4efb\u4f55\u61c9\u7528\u6703\u5217\u51fa Cloud Storage \u5c0d\u8c61\u4e26\u4f7f\u7528 prefix \u53c3\u6578\u4f86\u904e\u6ffe\u97ff\u61c9\uff0c\u5247\u60a8\u5fc5\u9808\u57f7\u884c\u984d\u5916\u7684\u6b65\u9a5f\u4f86\u9632\u6b62 IAM \u689d\u4ef6\u8868\u9054\u5f0f\u8207 Cloud Storage \u904e\u6ffe\u689d\u4ef6\u4e4b\u9593\u767c\u751f\u885d\u7a81\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1\u672c\u9801\u9762\u4e0a\u7684\u5217\u51fa\u5c0d\u8c61\u6642\u9650\u5236\u6b0a\u9650\u3002 |\n| accessBoundary.accessBoundaryRules[].availabilityCondition.title  | string \u53ef\u9078\u3002\u6a19\u8b58\u689d\u4ef6\u76ee\u7684\u7684\u77ed\u5b57\u7b26\u4e32\u3002                                                                              |\n| accessBoundary.accessBoundaryRules[].availabilityCondition.description | string \u53ef\u9078\u3002\u6709\u95dc\u689d\u4ef6\u76ee\u7684\u7684\u8a73\u7d30\u4fe1\u606f\u3002                                                                              |\n\u5982\u9700\u67e5\u770b JSON \u683c\u5f0f\u7684\u793a\u4f8b\uff0c\u8acb\u53c3\u95b1\u672c\u9801\u9762\u4e0a\u7684 [\u6191\u64da\u8a2a\u554f\u908a\u754c\u793a\u4f8b](#examples) \u3002\n### \u5275\u5efa OAuth 2.0 \u8a2a\u554f\u4ee4\u724c\n\u8981\u5275\u5efa\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u77ed\u671f\u6709\u6548\u7684\u6191\u64da\uff0c\u60a8\u5fc5\u9808\u5148\u5275\u5efa\u4e00\u500b\u5e38\u898f\u7684 OAuth 2.0 \u8a2a\u554f\u4ee4\u724c\u3002\u7136\u5f8c\u5c07\u5e38\u898f\u6191\u64da\u4ea4\u63db\u7232\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u6191\u64da\u3002\u5728\u5275\u5efa\u8a2a\u554f\u4ee4\u724c\u6642\uff0c\u8acb\u4f7f\u7528 OAuth 2.0 \u7bc4\u570d `https://www.googleapis.com/auth/cloud-platform` \u3002\n\u8981\u7232\u670d\u52d9\u8cec\u865f\u5275\u5efa\u8a2a\u554f\u4ee4\u724c\uff0c\u60a8\u53ef\u4ee5 [\u5b8c\u6210\u670d\u52d9\u5668\u5230\u670d\u52d9\u5668\u7684 OAuth 2.0 \u6d41\u7a0b](https://developers.google.com/identity/protocols/OAuth2ServiceAccount?hl=zh-cn) \uff0c\u6216\u8005\u53ef\u4ee5\u4f7f\u7528 Service Account Credentials API [\u751f\u6210 OAuth 2.0 \u8a2a\u554f\u4ee4\u724c](https://cloud.google.com/iam/docs/creating-short-lived-service-account-credentials?hl=zh-cn#sa-credentials-oauth) \u3002\n\u5982\u9700\u7232\u7528\u6236\u5275\u5efa\u8a2a\u554f\u4ee4\u724c\uff0c\u8acb\u53c3\u95b1 [\u7372\u53d6 OAuth 2.0 \u8a2a\u554f\u4ee4\u724c](https://developers.google.com/identity/protocols/OAuth2WebServer?hl=zh-cn#obtainingaccesstokens) \u3002\u60a8\u9084\u53ef\u4ee5\u4f7f\u7528 [OAuth 2.0 Playground](https://developers.google.com/oauthplayground/?hl=zh-cn) \uff0c\u7232\u60a8\u81ea\u5df1\u7684 Google \u8cec\u865f\u5275\u5efa\u8a2a\u554f\u4ee4\u724c\u3002\n### \u4ea4\u63db OAuth 2.0 \u8a2a\u554f\u4ee4\u724c\n\u5275\u5efa OAuth 2.0 \u8a2a\u554f\u4ee4\u724c\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5c07\u8a2a\u554f\u4ee4\u724c\u4ea4\u63db\u7232\u7b26\u5408\u6191\u64da\u8a2a\u554f\u908a\u754c\u7684\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u4ee4\u724c\u3002\u6b64\u904e\u7a0b\u901a\u5e38\u6d89\u53ca\u4ee4\u724c\u4ee3\u7406 \u548c\u4ee4\u724c\u4f7f\u7528\u65b9 \uff1a\n- \u4ee4\u724c\u4ee3\u7406 \u8ca0\u8cac\u5b9a\u7fa9\u6191\u64da\u8a2a\u554f\u908a\u754c\u4ee5\u53ca\u5c07\u8a2a\u554f\u4ee4\u724c\u4ea4\u63db\u7232\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u4ee4\u724c\u3002\u4ee4\u724c\u4ee3\u7406\u53ef\u4ee5\u4f7f\u7528\u53d7\u652f\u6301\u7684\u8eab\u4efd\u9a57\u8b49\u5eab [\u81ea\u52d5\u4ea4\u63db\u8a2a\u554f\u4ee4\u724c](#exchange-credential-auto) \uff0c\u4e5f\u53ef\u4ee5\u8abf\u7528 Security Token Service \u4f86 [\u624b\u52d5\u4ea4\u63db\u4ee4\u724c](#exchange-credential-manual) \u3002\n- \u4ee4\u724c\u4f7f\u7528\u65b9 \u6703\u5f9e\u4ee4\u724c\u4ee3\u7406\u8acb\u6c42\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u8a2a\u554f\u4ee4\u724c\uff0c\u7136\u5f8c\u4f7f\u7528\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u8a2a\u554f\u4ee4\u724c\u4f86\u57f7\u884c\u5176\u4ed6\u64cd\u4f5c\u3002\u4ee4\u724c\u4f7f\u7528\u65b9\u53ef\u4ee5\u4f7f\u7528\u53d7\u652f\u6301\u7684\u8eab\u4efd\u9a57\u8b49\u5eab\u5728\u8a2a\u554f\u4ee4\u724c\u5230\u671f\u4e4b\u524d [\u81ea\u52d5\u5237\u65b0\u8a2a\u554f\u4ee4\u724c](#exchange-credential-auto) \u3002\u6216\u8005\uff0c\u4ee4\u724c\u4f7f\u7528\u65b9\u53ef\u4ee5 [\u624b\u52d5\u5237\u65b0\u4ee4\u724c](#exchange-credential-manual) \uff0c\u4e5f\u53ef\u4ee5\u5141\u8a31\u4ee4\u724c\u904e\u671f\uff0c\u800c\u7121\u9700\u5237\u65b0\u3002\u5982\u679c\u60a8\u4f7f\u7528\u4ee5\u4e0b\u67d0\u7a2e\u8a9e\u8a00\u5275\u5efa\u4ee4\u724c\u4ee3\u7406\u548c\u4ee4\u724c\u4f7f\u7528\u65b9\uff0c\u5247\u53ef\u4ee5\u4f7f\u7528 Google \u7684\u8eab\u4efd\u9a57\u8b49\u5eab\u81ea\u52d5\u4ea4\u63db\u548c\u5237\u65b0\u4ee4\u724c\uff1a\n\u5c0d\u65bc Go\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 [golang.org/x/oauth2 \u8edf\u4ef6\u5305](https://pkg.go.dev/golang.org/x/oauth2) v0.0.0-20210819190943-2bc19b11175f \u7248\u6216\u66f4\u9ad8\u7248\u672c\u81ea\u52d5\u4ea4\u63db\u548c\u5237\u65b0\u4ee4\u724c\u3002\n\u5982\u9700\u6aa2\u67e5\u6b63\u5728\u4f7f\u7528\u7684\u8edf\u4ef6\u5305\u7248\u672c\uff0c\u8acb\u5728\u61c9\u7528\u76ee\u9304\u4e2d\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ngo list -m golang.org/x/oauth2\n```\n\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u4e86\u4ee4\u724c\u4ee3\u7406\u5982\u4f55\u751f\u6210\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u4ee4\u724c\uff1a\n [  auth/downscoping/token_broker.go ](https://github.com/GoogleCloudPlatform/golang-samples/blob/HEAD/auth/downscoping/token_broker.go) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/golang-samples/blob/HEAD/auth/downscoping/token_broker.go) \n```\nimport (\u00a0 \u00a0 \u00a0 \u00a0 \"context\"\u00a0 \u00a0 \u00a0 \u00a0 \"fmt\"\u00a0 \u00a0 \u00a0 \u00a0 \"golang.org/x/oauth2\"\u00a0 \u00a0 \u00a0 \u00a0 \"golang.org/x/oauth2/google\"\u00a0 \u00a0 \u00a0 \u00a0 \"golang.org/x/oauth2/google/downscope\")// createDownscopedToken would be run on the token broker in order to generate// a downscoped access token that only grants access to objects whose name begins with prefix.// The token broker would then pass the newly created token to the requesting token consumer for use.func createDownscopedToken(bucketName string, prefix string) error {\u00a0 \u00a0 \u00a0 \u00a0 // bucketName := \"foo\"\u00a0 \u00a0 \u00a0 \u00a0 // prefix := \"profile-picture-\"\u00a0 \u00a0 \u00a0 \u00a0 ctx := context.Background()\u00a0 \u00a0 \u00a0 \u00a0 // A condition can optionally be provided to further restrict access permissions.\u00a0 \u00a0 \u00a0 \u00a0 condition := downscope.AvailabilityCondition{\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Expression: \u00a0\"resource.name.startsWith('projects/_/buckets/\" + bucketName + \"/objects/\" + prefix + \"')\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Title: \u00a0 \u00a0 \u00a0 prefix + \" Only\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Description: \"Restricts a token to only be able to access objects that start with `\" + prefix + \"`\",\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 // Initializes an accessBoundary with one Rule which restricts the downscoped\u00a0 \u00a0 \u00a0 \u00a0 // token to only be able to access the bucket \"bucketName\" and only grants it the\u00a0 \u00a0 \u00a0 \u00a0 // permission \"storage.objectViewer\".\u00a0 \u00a0 \u00a0 \u00a0 accessBoundary := []downscope.AccessBoundaryRule{\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 AvailableResource: \u00a0 \u00a0\"//storage.googleapis.com/projects/_/buckets/\" + bucketName,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 AvailablePermissions: []string{\"inRole:roles/storage.objectViewer\"},\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Condition: \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0&condition, // Optional\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 // This Source can be initialized in multiple ways; the following example uses\u00a0 \u00a0 \u00a0 \u00a0 // Application Default Credentials.\u00a0 \u00a0 \u00a0 \u00a0 var rootSource oauth2.TokenSource\u00a0 \u00a0 \u00a0 \u00a0 // You must provide the \"https://www.googleapis.com/auth/cloud-platform\" scope.\u00a0 \u00a0 \u00a0 \u00a0 rootSource, err := google.DefaultTokenSource(ctx, \"https://www.googleapis.com/auth/cloud-platform\")\u00a0 \u00a0 \u00a0 \u00a0 if err != nil {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 return fmt.Errorf(\"failed to generate rootSource: %w\", err)\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 // downscope.NewTokenSource constructs the token source with the configuration provided.\u00a0 \u00a0 \u00a0 \u00a0 dts, err := downscope.NewTokenSource(ctx, downscope.DownscopingConfig{RootSource: rootSource, Rules: accessBoundary})\u00a0 \u00a0 \u00a0 \u00a0 if err != nil {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 return fmt.Errorf(\"failed to generate downscoped token source: %w\", err)\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 // Token() uses the previously declared TokenSource to generate a downscoped token.\u00a0 \u00a0 \u00a0 \u00a0 tok, err := dts.Token()\u00a0 \u00a0 \u00a0 \u00a0 if err != nil {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 return fmt.Errorf(\"failed to generate token: %w\", err)\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 // Pass this token back to the token consumer.\u00a0 \u00a0 \u00a0 \u00a0 _ = tok\u00a0 \u00a0 \u00a0 \u00a0 return nil}\n```\n\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u4e86\u4ee4\u724c\u4f7f\u7528\u65b9\u5982\u4f55\u4f7f\u7528\u5237\u65b0\u8655\u7406\u7a0b\u5e8f\u81ea\u52d5\u7372\u53d6\u548c\u5237\u65b0\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u4ee4\u724c\uff1a\n [  auth/downscoping/token_consumer.go ](https://github.com/GoogleCloudPlatform/golang-samples/blob/HEAD/auth/downscoping/token_consumer.go) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/golang-samples/blob/HEAD/auth/downscoping/token_consumer.go) \n```\nimport (\u00a0 \u00a0 \u00a0 \u00a0 \"context\"\u00a0 \u00a0 \u00a0 \u00a0 \"fmt\"\u00a0 \u00a0 \u00a0 \u00a0 \"io\"\u00a0 \u00a0 \u00a0 \u00a0 \"io/ioutil\"\u00a0 \u00a0 \u00a0 \u00a0 \"golang.org/x/oauth2/google\"\u00a0 \u00a0 \u00a0 \u00a0 \"golang.org/x/oauth2/google/downscope\"\u00a0 \u00a0 \u00a0 \u00a0 \"cloud.google.com/go/storage\"\u00a0 \u00a0 \u00a0 \u00a0 \"golang.org/x/oauth2\"\u00a0 \u00a0 \u00a0 \u00a0 \"google.golang.org/api/option\")// A token consumer should define their own tokenSource. In the Token() method,// it should send a query to a token broker requesting a downscoped token.// The token broker holds the root credential that is used to generate the// downscoped token.type localTokenSource struct {\u00a0 \u00a0 \u00a0 \u00a0 ctx \u00a0 \u00a0 \u00a0 \u00a0context.Context\u00a0 \u00a0 \u00a0 \u00a0 bucketName string\u00a0 \u00a0 \u00a0 \u00a0 brokerURL \u00a0string}func (lts localTokenSource) Token() (*oauth2.Token, error) {\u00a0 \u00a0 \u00a0 \u00a0 var remoteToken *oauth2.Token\u00a0 \u00a0 \u00a0 \u00a0 // Usually you would now retrieve remoteToken, an oauth2.Token, from token broker.\u00a0 \u00a0 \u00a0 \u00a0 // This snippet performs the same functionality locally.\u00a0 \u00a0 \u00a0 \u00a0 accessBoundary := []downscope.AccessBoundaryRule{\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 AvailableResource: \u00a0 \u00a0\"//storage.googleapis.com/projects/_/buckets/\" + lts.bucketName,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 AvailablePermissions: []string{\"inRole:roles/storage.objectViewer\"},\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 rootSource, err := google.DefaultTokenSource(lts.ctx, \"https://www.googleapis.com/auth/cloud-platform\")\u00a0 \u00a0 \u00a0 \u00a0 if err != nil {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 return nil, fmt.Errorf(\"failed to generate rootSource: %w\", err)\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 dts, err := downscope.NewTokenSource(lts.ctx, downscope.DownscopingConfig{RootSource: rootSource, Rules: accessBoundary})\u00a0 \u00a0 \u00a0 \u00a0 if err != nil {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 return nil, fmt.Errorf(\"failed to generate downscoped token source: %w\", err)\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 // Token() uses the previously declared TokenSource to generate a downscoped token.\u00a0 \u00a0 \u00a0 \u00a0 remoteToken, err = dts.Token()\u00a0 \u00a0 \u00a0 \u00a0 if err != nil {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 return nil, fmt.Errorf(\"failed to generate token: %w\", err)\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 return remoteToken, nil}// getObjectContents will read the contents of an object in Google Storage// named objectName, contained in the bucket \"bucketName\".func getObjectContents(output io.Writer, bucketName string, objectName string) error {\u00a0 \u00a0 \u00a0 \u00a0 // bucketName := \"foo\"\u00a0 \u00a0 \u00a0 \u00a0 // prefix := \"profile-picture-\"\u00a0 \u00a0 \u00a0 \u00a0 ctx := context.Background()\u00a0 \u00a0 \u00a0 \u00a0 thisTokenSource := localTokenSource{\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ctx: \u00a0 \u00a0 \u00a0 \u00a0ctx,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 bucketName: bucketName,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 brokerURL: \u00a0\"yourURL.com/internal/broker\",\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 // Wrap the TokenSource in an oauth2.ReuseTokenSource to enable automatic refreshing.\u00a0 \u00a0 \u00a0 \u00a0 refreshableTS := oauth2.ReuseTokenSource(nil, thisTokenSource)\u00a0 \u00a0 \u00a0 \u00a0 // You can now use the token source to access Google Cloud Storage resources as follows.\u00a0 \u00a0 \u00a0 \u00a0 storageClient, err := storage.NewClient(ctx, option.WithTokenSource(refreshableTS))\u00a0 \u00a0 \u00a0 \u00a0 if err != nil {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 return fmt.Errorf(\"failed to create the storage client: %w\", err)\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 defer storageClient.Close()\u00a0 \u00a0 \u00a0 \u00a0 bkt := storageClient.Bucket(bucketName)\u00a0 \u00a0 \u00a0 \u00a0 obj := bkt.Object(objectName)\u00a0 \u00a0 \u00a0 \u00a0 rc, err := obj.NewReader(ctx)\u00a0 \u00a0 \u00a0 \u00a0 if err != nil {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 return fmt.Errorf(\"failed to retrieve the object: %w\", err)\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 defer rc.Close()\u00a0 \u00a0 \u00a0 \u00a0 data, err := ioutil.ReadAll(rc)\u00a0 \u00a0 \u00a0 \u00a0 if err != nil {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 return fmt.Errorf(\"could not read the object's contents: %w\", err)\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 // Data now contains the contents of the requested object.\u00a0 \u00a0 \u00a0 \u00a0 output.Write(data)\u00a0 \u00a0 \u00a0 \u00a0 return nil}\n```\u5c0d\u65bc Java\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 [com.google.auth:google-auth-library-oauth2-http \u5de5\u4ef6](https://search.maven.org/artifact/com.google.auth/google-auth-library-oauth2-http) 1.1.0 \u7248\u6216\u66f4\u9ad8\u7248\u672c\u81ea\u52d5\u4ea4\u63db\u548c\u5237\u65b0\u4ee4\u724c\u3002\n\u5982\u9700\u6aa2\u67e5\u60a8\u6b63\u5728\u4f7f\u7528\u7684\u5de5\u4ef6\u7684\u7248\u672c\uff0c\u8acb\u5728\u61c9\u7528\u76ee\u9304\u4e2d\u904b\u884c\u4ee5\u4e0b Maven \u547d\u4ee4\uff1a\n```\nmvn dependency:list -DincludeArtifactIds=google-auth-library-oauth2-http\n```\n\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u4e86\u4ee4\u724c\u4ee3\u7406\u5982\u4f55\u751f\u6210\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u4ee4\u724c\uff1a\n [  auth/src/main/java/com/google/cloud/auth/samples/DownscopingExample.java ](https://github.com/GoogleCloudPlatform/java-docs-samples/blob/HEAD/auth/src/main/java/com/google/cloud/auth/samples/DownscopingExample.java) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/java-docs-samples/blob/HEAD/auth/src/main/java/com/google/cloud/auth/samples/DownscopingExample.java) \n```\npublic static AccessToken getTokenFromBroker(String bucketName, String objectPrefix)\u00a0 \u00a0 throws IOException {\u00a0 // Retrieve the source credentials from ADC.\u00a0 GoogleCredentials sourceCredentials =\u00a0 \u00a0 \u00a0 GoogleCredentials.getApplicationDefault()\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .createScoped(\"https://www.googleapis.com/auth/cloud-platform\");\u00a0 // Initialize the Credential Access Boundary rules.\u00a0 String availableResource = \"//storage.googleapis.com/projects/_/buckets/\" + bucketName;\u00a0 // Downscoped credentials will have readonly access to the resource.\u00a0 String availablePermission = \"inRole:roles/storage.objectViewer\";\u00a0 // Only objects starting with the specified prefix string in the object name will be allowed\u00a0 // read access.\u00a0 String expression =\u00a0 \u00a0 \u00a0 \"resource.name.startsWith('projects/_/buckets/\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 + bucketName\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 + \"/objects/\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 + objectPrefix\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 + \"')\";\u00a0 // Build the AvailabilityCondition.\u00a0 CredentialAccessBoundary.AccessBoundaryRule.AvailabilityCondition availabilityCondition =\u00a0 \u00a0 \u00a0 CredentialAccessBoundary.AccessBoundaryRule.AvailabilityCondition.newBuilder()\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .setExpression(expression)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .build();\u00a0 // Define the single access boundary rule using the above properties.\u00a0 CredentialAccessBoundary.AccessBoundaryRule rule =\u00a0 \u00a0 \u00a0 CredentialAccessBoundary.AccessBoundaryRule.newBuilder()\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .setAvailableResource(availableResource)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .addAvailablePermission(availablePermission)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .setAvailabilityCondition(availabilityCondition)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .build();\u00a0 // Define the Credential Access Boundary with all the relevant rules.\u00a0 CredentialAccessBoundary credentialAccessBoundary =\u00a0 \u00a0 \u00a0 CredentialAccessBoundary.newBuilder().addRule(rule).build();\u00a0 // Create the downscoped credentials.\u00a0 DownscopedCredentials downscopedCredentials =\u00a0 \u00a0 \u00a0 DownscopedCredentials.newBuilder()\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .setSourceCredential(sourceCredentials)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .setCredentialAccessBoundary(credentialAccessBoundary)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .build();\u00a0 // Retrieve the token.\u00a0 // This will need to be passed to the Token Consumer.\u00a0 AccessToken accessToken = downscopedCredentials.refreshAccessToken();\u00a0 return accessToken;}\n```\n\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u4e86\u4ee4\u724c\u4f7f\u7528\u65b9\u5982\u4f55\u4f7f\u7528\u5237\u65b0\u8655\u7406\u7a0b\u5e8f\u81ea\u52d5\u7372\u53d6\u548c\u5237\u65b0\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u4ee4\u724c\uff1a\n [  auth/src/main/java/com/google/cloud/auth/samples/DownscopingExample.java ](https://github.com/GoogleCloudPlatform/java-docs-samples/blob/HEAD/auth/src/main/java/com/google/cloud/auth/samples/DownscopingExample.java) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/java-docs-samples/blob/HEAD/auth/src/main/java/com/google/cloud/auth/samples/DownscopingExample.java) \n```\npublic static void tokenConsumer(final String bucketName, final String objectName)\u00a0 \u00a0 throws IOException {\u00a0 // You can pass an `OAuth2RefreshHandler` to `OAuth2CredentialsWithRefresh` which will allow the\u00a0 // library to seamlessly handle downscoped token refreshes on expiration.\u00a0 OAuth2CredentialsWithRefresh.OAuth2RefreshHandler handler =\u00a0 \u00a0 \u00a0 new OAuth2CredentialsWithRefresh.OAuth2RefreshHandler() {\u00a0 \u00a0 \u00a0 \u00a0 @Override\u00a0 \u00a0 \u00a0 \u00a0 public AccessToken refreshAccessToken() throws IOException {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 // The common pattern of usage is to have a token broker pass the downscoped short-lived\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 // access tokens to a token consumer via some secure authenticated channel.\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 // For illustration purposes, we are generating the downscoped token locally.\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 // We want to test the ability to limit access to objects with a certain prefix string\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 // in the resource bucket. objectName.substring(0, 3) is the prefix here. This field is\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 // not required if access to all bucket resources are allowed. If access to limited\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 // resources in the bucket is needed, this mechanism can be used.\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 return getTokenFromBroker(bucketName, objectName.substring(0, 3));\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 };\u00a0 // Downscoped token retrieved from token broker.\u00a0 AccessToken downscopedToken = handler.refreshAccessToken();\u00a0 // Create the OAuth2CredentialsWithRefresh from the downscoped token and pass a refresh handler\u00a0 // which will handle token expiration.\u00a0 // This will allow the consumer to seamlessly obtain new downscoped tokens on demand every time\u00a0 // token expires.\u00a0 OAuth2CredentialsWithRefresh credentials =\u00a0 \u00a0 \u00a0 OAuth2CredentialsWithRefresh.newBuilder()\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .setAccessToken(downscopedToken)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .setRefreshHandler(handler)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .build();\u00a0 // Use the credentials with the Cloud Storage SDK.\u00a0 StorageOptions options = StorageOptions.newBuilder().setCredentials(credentials).build();\u00a0 Storage storage = options.getService();\u00a0 // Call Cloud Storage APIs.\u00a0 Blob blob = storage.get(bucketName, objectName);\u00a0 String content = new String(blob.getContent());\u00a0 System.out.println(\u00a0 \u00a0 \u00a0 \"Retrieved object, \"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 + objectName\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 + \", from bucket,\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 + bucketName\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 + \", with content: \"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 + content);}\n```\u5c0d\u65bc Node.js\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 [google-auth-library \u8edf\u4ef6\u5305](https://github.com/googleapis/google-auth-library-nodejs) 7.9.0 \u7248\u6216\u66f4\u9ad8\u7248\u672c\u81ea\u52d5\u4ea4\u63db\u548c\u5237\u65b0\u4ee4\u724c\u3002\n\u5982\u9700\u6aa2\u67e5\u6b63\u5728\u4f7f\u7528\u7684\u8edf\u4ef6\u5305\u7248\u672c\uff0c\u8acb\u5728\u61c9\u7528\u76ee\u9304\u4e2d\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\nnpm list google-auth-library\n```\n\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u4e86\u4ee4\u724c\u4ee3\u7406\u5982\u4f55\u751f\u6210\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u4ee4\u724c\uff1a\n [  auth/downscoping.js ](https://github.com/GoogleCloudPlatform/nodejs-docs-samples/blob/HEAD/auth/downscoping.js) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/nodejs-docs-samples/blob/HEAD/auth/downscoping.js) \n```\n// Imports the Google Auth libraries.const {GoogleAuth, DownscopedClient} = require('google-auth-library');/**\u00a0* Simulates token broker generating downscoped tokens for specified bucket.\u00a0*\u00a0* @param bucketName The name of the Cloud Storage bucket.\u00a0* @param objectPrefix The prefix string of the object name. This is used\u00a0* \u00a0 \u00a0 \u00a0 \u00a0to ensure access is restricted to only objects starting with this\u00a0* \u00a0 \u00a0 \u00a0 \u00a0prefix string.\u00a0*/async function getTokenFromBroker(bucketName, objectPrefix) {\u00a0 const googleAuth = new GoogleAuth({\u00a0 \u00a0 scopes: 'https://www.googleapis.com/auth/cloud-platform',\u00a0 });\u00a0 // Define the Credential Access Boundary object.\u00a0 const cab = {\u00a0 \u00a0 // Define the access boundary.\u00a0 \u00a0 accessBoundary: {\u00a0 \u00a0 \u00a0 // Define the single access boundary rule.\u00a0 \u00a0 \u00a0 accessBoundaryRules: [\u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 availableResource: `//storage.googleapis.com/projects/_/buckets/${bucketName}`,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 // Downscoped credentials will have readonly access to the resource.\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 availablePermissions: ['inRole:roles/storage.objectViewer'],\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 // Only objects starting with the specified prefix string in the object name\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 // will be allowed read access.\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 availabilityCondition: {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 expression:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"resource.name.startsWith('projects/_/buckets/\" +\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 `${bucketName}/objects/${objectPrefix}')`,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 ],\u00a0 \u00a0 },\u00a0 };\u00a0 // Obtain an authenticated client via ADC.\u00a0 const client = await googleAuth.getClient();\u00a0 // Use the client to create a DownscopedClient.\u00a0 const cabClient = new DownscopedClient(client, cab);\u00a0 // Refresh the tokens.\u00a0 const refreshedAccessToken = await cabClient.getAccessToken();\u00a0 // This will need to be passed to the token consumer.\u00a0 return refreshedAccessToken;}\n```\n\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u4e86\u4ee4\u724c\u4f7f\u7528\u65b9\u5982\u4f55\u63d0\u4f9b\u81ea\u52d5\u7372\u53d6\u548c\u5237\u65b0\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u4ee4\u724c\u7684\u5237\u65b0\u8655\u7406\u7a0b\u5e8f\uff1a\n [  auth/downscoping.js ](https://github.com/GoogleCloudPlatform/nodejs-docs-samples/blob/HEAD/auth/downscoping.js) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/nodejs-docs-samples/blob/HEAD/auth/downscoping.js) \n```\n// Imports the Google Auth and Google Cloud libraries.const {OAuth2Client} = require('google-auth-library');const {Storage} = require('@google-cloud/storage');/**\u00a0* Simulates token consumer generating calling GCS APIs using generated\u00a0* downscoped tokens for specified bucket.\u00a0*\u00a0* @param bucketName The name of the Cloud Storage bucket.\u00a0* @param objectName The name of the object in the Cloud Storage bucket\u00a0* \u00a0 \u00a0 \u00a0 \u00a0to read.\u00a0*/async function tokenConsumer(bucketName, objectName) {\u00a0 // Create the OAuth credentials (the consumer).\u00a0 const oauth2Client = new OAuth2Client();\u00a0 // We are defining a refresh handler instead of a one-time access\u00a0 // token/expiry pair.\u00a0 // This will allow the consumer to obtain new downscoped tokens on\u00a0 // demand every time a token is expired, without any additional code\u00a0 // changes.\u00a0 oauth2Client.refreshHandler = async () => {\u00a0 \u00a0 // The common pattern of usage is to have a token broker pass the\u00a0 \u00a0 // downscoped short-lived access tokens to a token consumer via some\u00a0 \u00a0 // secure authenticated channel. For illustration purposes, we are\u00a0 \u00a0 // generating the downscoped token locally. We want to test the ability\u00a0 \u00a0 // to limit access to objects with a certain prefix string in the\u00a0 \u00a0 // resource bucket. objectName.substring(0, 3) is the prefix here. This\u00a0 \u00a0 // field is not required if access to all bucket resources are allowed.\u00a0 \u00a0 // If access to limited resources in the bucket is needed, this mechanism\u00a0 \u00a0 // can be used.\u00a0 \u00a0 const refreshedAccessToken = await getTokenFromBroker(\u00a0 \u00a0 \u00a0 bucketName,\u00a0 \u00a0 \u00a0 objectName.substring(0, 3)\u00a0 \u00a0 );\u00a0 \u00a0 return {\u00a0 \u00a0 \u00a0 access_token: refreshedAccessToken.token,\u00a0 \u00a0 \u00a0 expiry_date: refreshedAccessToken.expirationTime,\u00a0 \u00a0 };\u00a0 };\u00a0 const storageOptions = {\u00a0 \u00a0 projectId: process.env.GOOGLE_CLOUD_PROJECT,\u00a0 \u00a0 authClient: oauth2Client,\u00a0 };\u00a0 const storage = new Storage(storageOptions);\u00a0 const downloadFile = await storage\u00a0 \u00a0 .bucket(bucketName)\u00a0 \u00a0 .file(objectName)\u00a0 \u00a0 .download();\u00a0 console.log(downloadFile.toString('utf8'));}\n```\u5c0d\u65bc Python\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 [google-auth \u8edf\u4ef6\u5305](https://github.com/googleapis/google-auth-library-python) 2.0.0 \u7248\u6216\u66f4\u9ad8\u7248\u672c\u81ea\u52d5\u4ea4\u63db\u548c\u5237\u65b0\u4ee4\u724c\u3002\n\u5982\u9700\u6aa2\u67e5\u6b63\u5728\u4f7f\u7528\u7684\u8edf\u4ef6\u5305\u7248\u672c\uff0c\u8acb\u5728\u5b89\u88dd\u8a72\u8edf\u4ef6\u5305\u7684\u74b0\u5883\u4e2d\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\npip show google-auth\n```\n\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u4e86\u4ee4\u724c\u4ee3\u7406\u5982\u4f55\u751f\u6210\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u4ee4\u724c\uff1a\n [  auth/downscoping/snippets.py ](https://github.com/GoogleCloudPlatform/python-docs-samples/blob/HEAD/auth/downscoping/snippets.py) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/python-docs-samples/blob/HEAD/auth/downscoping/snippets.py) \n```\nimport google.authfrom google.auth import downscopedfrom google.auth.transport import requestsdef get_token_from_broker(bucket_name, object_prefix):\u00a0 \u00a0 \"\"\"Simulates token broker generating downscoped tokens for specified bucket.\u00a0 \u00a0 Args:\u00a0 \u00a0 \u00a0 \u00a0 bucket_name (str): The name of the Cloud Storage bucket.\u00a0 \u00a0 \u00a0 \u00a0 object_prefix (str): The prefix string of the object name. This is used\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 to ensure access is restricted to only objects starting with this\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 prefix string.\u00a0 \u00a0 Returns:\u00a0 \u00a0 \u00a0 \u00a0 Tuple[str, datetime.datetime]: The downscoped access token and its expiry date.\u00a0 \u00a0 \"\"\"\u00a0 \u00a0 # Initialize the Credential Access Boundary rules.\u00a0 \u00a0 available_resource = f\"//storage.googleapis.com/projects/_/buckets/{bucket_name}\"\u00a0 \u00a0 # Downscoped credentials will have readonly access to the resource.\u00a0 \u00a0 available_permissions = [\"inRole:roles/storage.objectViewer\"]\u00a0 \u00a0 # Only objects starting with the specified prefix string in the object name\u00a0 \u00a0 # will be allowed read access.\u00a0 \u00a0 availability_expression = (\u00a0 \u00a0 \u00a0 \u00a0 \"resource.name.startsWith('projects/_/buckets/{}/objects/{}')\".format(\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 bucket_name, object_prefix\u00a0 \u00a0 \u00a0 \u00a0 )\u00a0 \u00a0 )\u00a0 \u00a0 availability_condition = downscoped.AvailabilityCondition(availability_expression)\u00a0 \u00a0 # Define the single access boundary rule using the above properties.\u00a0 \u00a0 rule = downscoped.AccessBoundaryRule(\u00a0 \u00a0 \u00a0 \u00a0 available_resource=available_resource,\u00a0 \u00a0 \u00a0 \u00a0 available_permissions=available_permissions,\u00a0 \u00a0 \u00a0 \u00a0 availability_condition=availability_condition,\u00a0 \u00a0 )\u00a0 \u00a0 # Define the Credential Access Boundary with all the relevant rules.\u00a0 \u00a0 credential_access_boundary = downscoped.CredentialAccessBoundary(rules=[rule])\u00a0 \u00a0 # Retrieve the source credentials via ADC.\u00a0 \u00a0 source_credentials, _ = google.auth.default()\u00a0 \u00a0 if source_credentials.requires_scopes:\u00a0 \u00a0 \u00a0 \u00a0 source_credentials = source_credentials.with_scopes(\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 [\"https://www.googleapis.com/auth/cloud-platform\"]\u00a0 \u00a0 \u00a0 \u00a0 )\u00a0 \u00a0 # Create the downscoped credentials.\u00a0 \u00a0 downscoped_credentials = downscoped.Credentials(\u00a0 \u00a0 \u00a0 \u00a0 source_credentials=source_credentials,\u00a0 \u00a0 \u00a0 \u00a0 credential_access_boundary=credential_access_boundary,\u00a0 \u00a0 )\u00a0 \u00a0 # Refresh the tokens.\u00a0 \u00a0 downscoped_credentials.refresh(requests.Request())\u00a0 \u00a0 # These values will need to be passed to the token consumer.\u00a0 \u00a0 access_token = downscoped_credentials.token\u00a0 \u00a0 expiry = downscoped_credentials.expiry\u00a0 \u00a0 return (access_token, expiry)\n```\n\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u4e86\u4ee4\u724c\u4f7f\u7528\u65b9\u5982\u4f55\u63d0\u4f9b\u81ea\u52d5\u7372\u53d6\u548c\u5237\u65b0\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u4ee4\u724c\u7684\u5237\u65b0\u8655\u7406\u7a0b\u5e8f\uff1a\n [  auth/downscoping/snippets.py ](https://github.com/GoogleCloudPlatform/python-docs-samples/blob/HEAD/auth/downscoping/snippets.py) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/python-docs-samples/blob/HEAD/auth/downscoping/snippets.py) \n```\nfrom google.cloud import storagefrom google.oauth2 import credentialsdef token_consumer(bucket_name, object_name):\u00a0 \u00a0 \"\"\"Tests token consumer readonly access to the specified object.\u00a0 \u00a0 Args:\u00a0 \u00a0 \u00a0 \u00a0 bucket_name (str): The name of the Cloud Storage bucket.\u00a0 \u00a0 \u00a0 \u00a0 object_name (str): The name of the object in the Cloud Storage bucket\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 to read.\u00a0 \u00a0 \"\"\"\u00a0 \u00a0 # Create the OAuth credentials from the downscoped token and pass a\u00a0 \u00a0 # refresh handler to handle token expiration. We are passing a\u00a0 \u00a0 # refresh_handler instead of a one-time access token/expiry pair.\u00a0 \u00a0 # This will allow the consumer to obtain new downscoped tokens on\u00a0 \u00a0 # demand every time a token is expired, without any additional code\u00a0 \u00a0 # changes.\u00a0 \u00a0 def refresh_handler(request, scopes=None):\u00a0 \u00a0 \u00a0 \u00a0 # The common pattern of usage is to have a token broker pass the\u00a0 \u00a0 \u00a0 \u00a0 # downscoped short-lived access tokens to a token consumer via some\u00a0 \u00a0 \u00a0 \u00a0 # secure authenticated channel.\u00a0 \u00a0 \u00a0 \u00a0 # For illustration purposes, we are generating the downscoped token\u00a0 \u00a0 \u00a0 \u00a0 # locally.\u00a0 \u00a0 \u00a0 \u00a0 # We want to test the ability to limit access to objects with a certain\u00a0 \u00a0 \u00a0 \u00a0 # prefix string in the resource bucket. object_name[0:3] is the prefix\u00a0 \u00a0 \u00a0 \u00a0 # here. This field is not required if access to all bucket resources are\u00a0 \u00a0 \u00a0 \u00a0 # allowed. If access to limited resources in the bucket is needed, this\u00a0 \u00a0 \u00a0 \u00a0 # mechanism can be used.\u00a0 \u00a0 \u00a0 \u00a0 return get_token_from_broker(bucket_name, object_prefix=object_name[0:3])\u00a0 \u00a0 creds = credentials.Credentials(\u00a0 \u00a0 \u00a0 \u00a0 None,\u00a0 \u00a0 \u00a0 \u00a0 scopes=[\"https://www.googleapis.com/auth/cloud-platform\"],\u00a0 \u00a0 \u00a0 \u00a0 refresh_handler=refresh_handler,\u00a0 \u00a0 )\u00a0 \u00a0 # Initialize a Cloud Storage client with the oauth2 credentials.\u00a0 \u00a0 storage_client = storage.Client(credentials=creds)\u00a0 \u00a0 # The token broker has readonly access to the specified bucket object.\u00a0 \u00a0 bucket = storage_client.bucket(bucket_name)\u00a0 \u00a0 blob = bucket.blob(object_name)\u00a0 \u00a0 print(blob.download_as_bytes().decode(\"utf-8\"))\n```\n\u4ee4\u724c\u4ee3\u7406\u53ef\u4ee5\u4f7f\u7528 Security Token Service API \u5c07\u8a2a\u554f\u4ee4\u724c\u4ea4\u63db\u7232\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u8a2a\u554f\u4ee4\u724c\u3002\u7136\u5f8c\uff0c\u4ee4\u724c\u4ee3\u7406\u53ef\u4ee5\u5411\u4ee4\u724c\u4f7f\u7528\u65b9\u63d0\u4f9b\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u4ee4\u724c\u3002\n\u8981\u4ea4\u63db\u8a2a\u554f\u4ee4\u724c\uff0c\u8acb\u4f7f\u7528\u4ee5\u4e0b HTTP \u65b9\u6cd5\u548c\u7db2\u5740\uff1a\n```\nPOST https://sts.googleapis.com/v1/token\n```\n\u5c07\u8acb\u6c42\u4e2d\u7684 `Content-Type` \u6a19\u982d\u8a2d\u7f6e\u7232 `application/x-www-form-urlencoded` \u3002\u5728\u8acb\u6c42\u6b63\u6587\u4e2d\u6dfb\u52a0\u4ee5\u4e0b\u5b57\u6bb5\uff1a\n| \u5b57\u6bb5     | \u5b57\u6bb5.1               |\n|:---------------------|:------------------------------------------------------------------|\n| grant_type   | string \u4f7f\u7528 urn:ietf:params:oauth:grant-type:token-exchange \u503c\u3002 |\n| options    | string JSON \u683c\u5f0f\u7684\u6191\u64da\u8a2a\u554f\u908a\u754c\uff0c\u63a1\u7528\u767e\u5206\u865f\u7de8\u78bc\u9032\u884c\u7de8\u78bc\u3002   |\n| requested_token_type | string \u4f7f\u7528 urn:ietf:params:oauth:token-type:access_token \u503c\u3002 |\n| subject_token  | string \u60a8\u60f3\u8981\u4ea4\u63db\u7684 OAuth 2.0 \u8a2a\u554f\u4ee4\u724c\u3002       |\n| subject_token_type | string \u4f7f\u7528 urn:ietf:params:oauth:token-type:access_token \u503c\u3002 |\n\u97ff\u61c9\u662f\u5305\u542b\u4ee5\u4e0b\u5b57\u6bb5\u7684 JSON \u5c0d\u8c61\uff1a\n| \u5b57\u6bb5    | \u5b57\u6bb5.1                                                |\n|:------------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| access_token  | string \u7b26\u5408\u6191\u64da\u8a2a\u554f\u908a\u754c\u7684\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684 OAuth 2.0 \u8a2a\u554f\u4ee4\u724c\u3002                                |\n| expires_in  | number \u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u4ee4\u724c\u5230\u671f\u524d\u7684\u6642\u9593\u91cf\uff08\u4ee5\u79d2\u7232\u55ae\u4f4d\uff09\u3002 \u50c5\u7576\u539f\u59cb\u8a2a\u554f\u4ee4\u724c\u4ee3\u8868\u670d\u52d9\u8cec\u865f\u6642\u7e94\u6703\u986f\u793a\u6b64\u5b57\u6bb5\u3002\u5982\u679c\u6b64\u5b57\u6bb5\u4e0d\u5b58\u5728\uff0c\u5247\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u4ee4\u724c\u7684\u5230\u671f\u6642\u9593\u8207\u539f\u59cb\u8a2a\u554f\u4ee4\u724c\u7684\u5230\u671f\u6642\u9593\u76f8\u540c\u3002 |\n| issued_token_type | string \u5305\u542b urn:ietf:params:oauth:token-type:access_token \u503c\u3002                                 |\n| token_type  | string \u5305\u542b Bearer \u503c\u3002                                           |\n\u4f8b\u5982\uff0c\u5982\u679c JSON \u683c\u5f0f\u7684\u6191\u64da\u8a2a\u554f\u908a\u754c\u5b58\u5132\u5728 `./access-boundary.json` \u6587\u4ef6\u4e2d\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b [curl](https://curl.haxx.se/) \u547d\u4ee4\u4ea4\u63db\u8a2a\u554f\u4ee4\u724c\u3002\u5c07 `` \u66ff\u63db\u7232\u539f\u59cb\u8a2a\u554f\u4ee4\u724c\uff1a\n```\ncurl -H \"Content-Type:application/x-www-form-urlencoded\" \\\u00a0 \u00a0 -X POST \\\u00a0 \u00a0 https://sts.googleapis.com/v1/token \\\u00a0 \u00a0 -d \"grant_type=urn:ietf:params:oauth:grant-type:token-exchange&subject_token_type=urn:ietf:params:oauth:token-type:access_token&requested_token_type=urn:ietf:params:oauth:token-type:access_token&subject_token=original-token\" \\\u00a0 \u00a0 --data-urlencode \"options=$(cat ./access-boundary.json)\"\n```\n\u97ff\u61c9\u985e\u4f3c\u65bc\u4ee5\u4e0b\u793a\u4f8b\uff1a\n```\n{\u00a0 \"access_token\": \"ya29.dr.AbCDeFg-123456...\",\u00a0 \"issued_token_type\": \"urn:ietf:params:oauth:token-type:access_token\",\u00a0 \"token_type\": \"Bearer\",\u00a0 \"expires_in\": 3600}\n```\n\u7576\u4ee4\u724c\u4f7f\u7528\u65b9\u8acb\u6c42\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u4ee4\u724c\u6642\uff0c\u4ee4\u724c\u4ee3\u7406\u61c9\u540c\u6642\u4ee5\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u4ee4\u724c\u548c\u4ee4\u724c\u5230\u671f\u524d\u7684\u79d2\u6578\u9032\u884c\u97ff\u61c9\u3002\u5982\u9700\u5237\u65b0\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u4ee4\u724c\uff0c\u4f7f\u7528\u65b9\u53ef\u4ee5\u5728\u73fe\u6709\u4ee4\u724c\u5230\u671f\u4e4b\u524d\u5f9e\u4ee3\u7406\u8acb\u6c42\u5177\u6709\u7e2e\u5c0f\u7684\u6b0a\u9650\u7bc4\u570d\u7684\u4ee4\u724c\u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u77ad\u89e3 [Cloud Storage \u7684\u8a2a\u554f\u6b0a\u9650\u63a7\u5236](https://cloud.google.com/storage/docs/access-control?hl=zh-cn) \u3002\n- \u5275\u5efa [\u77ed\u671f\u6709\u6548\u7684\u670d\u52d9\u8cec\u865f\u6191\u64da](https://cloud.google.com/iam/docs/creating-short-lived-service-account-credentials?hl=zh-cn) \u3002\n- \u4f7f\u7528 [\u670d\u52d9\u5668\u5230\u670d\u52d9\u5668 OAuth 2.0 \u6d41\u7a0b](https://developers.google.com/identity/protocols/OAuth2ServiceAccount?hl=zh-cn) \u6216 [Service Account Credentials API](https://cloud.google.com/iam/docs/creating-short-lived-service-account-credentials?hl=zh-cn#sa-credentials-oauth) \u7232\u670d\u52d9\u8cec\u865f\u5275\u5efa OAuth 2.0 \u8a2a\u554f\u4ee4\u724c\u3002\n- [\u7232\u7528\u6236](https://developers.google.com/identity/protocols/OAuth2WebServer?hl=zh-cn#obtainingaccesstokens) \u5275\u5efa OAuth 2.0 \u8a2a\u554f\u4ee4\u724c\u3002\n- \u67e5\u770b [\u6bcf\u500b\u9810\u5b9a\u7fa9\u89d2\u8272\u4e2d\u7684\u6b0a\u9650](https://cloud.google.com/iam/docs/understanding-roles?hl=zh-cn#predefined_roles) \u3002\n- \u77ad\u89e3 [\u81ea\u5b9a\u7fa9\u89d2\u8272](https://cloud.google.com/iam/docs/understanding-custom-roles?hl=zh-cn) \u3002", "guide": "IAM"}