{"title": "IAM - \u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u793a\u4f8b\u65e5\u8a8c", "url": "https://cloud.google.com/iam/docs/audit-logging/examples-workload-identity?hl=zh-cn", "abstract": "# IAM - \u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u793a\u4f8b\u65e5\u8a8c\n\u672c\u9801\u9762\u4ecb\u7d39\u4f7f\u7528 [\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408](https://cloud.google.com/iam/docs/workload-identity-federation?hl=zh-cn) \u6642\u751f\u6210\u7684\u5be9\u8988\u65e5\u8a8c\u793a\u4f8b\u3002\u85c9\u52a9\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u60a8\u53ef\u4ee5\u5141\u8a31\u672c\u5730\u6216\u591a\u96f2\u7aef\u5de5\u4f5c\u8ca0\u8f09\u8a2a\u554f Google Cloud \u8cc7\u6e90\uff0c\u800c\u7121\u9700\u4f7f\u7528\u670d\u52d9\u8cec\u865f\u5bc6\u9470\u3002\n**\u6ce8\u610f** \uff1a\u6bcf\u500b\u793a\u4f8b\u50c5\u5c55\u793a\u65e5\u8a8c\u689d\u76ee\u4e2d\u6700\u76f8\u95dc\u7684\u5b57\u6bb5\u3002\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u5553\u7528\u548c\u67e5\u770b\u5be9\u8988\u65e5\u8a8c\uff0c\u8acb\u53c3\u95b1 [IAM \u5be9\u8988\u65e5\u8a8c\u8a18\u9304](https://cloud.google.com/iam/docs/audit-logging?hl=zh-cn) \u3002\n", "content": "## \u7232\u806f\u5408\u4ee4\u724c\u4ea4\u63db IdP \u4ee4\u724c\u6642\u751f\u6210\u7684\u65e5\u8a8c\n[\u8a2d\u7f6e\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60](https://cloud.google.com/iam/docs/manage-workload-identity-pools-providers?hl=zh-cn) \u548c\u8eab\u4efd\u63d0\u4f9b\u5546 (IdP) \u5f8c\uff0c\u60a8\u53ef\u4ee5\u7232 IdP \u5275\u5efa\u4ee4\u724c\uff0c\u4e26\u5c07\u5176\u7528\u65bc\u4ea4\u63db\u806f\u5408\u4ee4\u724c\u3002\n\u7576\u4e3b\u8cec\u865f\u4ea4\u63db\u4ee4\u724c\u6642\uff0cIAM \u53ef\u4ee5\u751f\u6210\u5be9\u8988\u65e5\u8a8c\u3002\u5982\u9700\u63a5\u6536\u4ee4\u724c\u4ea4\u63db\u6d41\u7a0b\u6240\u6709\u6b65\u9a5f\u7684\u5be9\u8988\u65e5\u8a8c\uff0c\u60a8\u5fc5\u9808\u7232\u4ee5\u4e0b API [\u5553\u7528\u6578\u64da\u8a2a\u554f\u5be9\u8988\u65e5\u8a8c](https://cloud.google.com/iam/docs/audit-logging?hl=zh-cn#enabling_audit_logging) \uff1a\n- Identity and Access Management (IAM) API\uff08\u5553\u7528\u65e5\u8a8c\u985e\u578b\u201c\u7ba1\u7406\u54e1\u8b80\u53d6\u201d\uff09\n- Security Token Service API\uff08\u5553\u7528\u65e5\u8a8c\u985e\u578b\u201c\u7ba1\u7406\u54e1\u8b80\u53d6\u201d\uff09\n\u5553\u7528\u6578\u64da\u8a2a\u554f\u6d3b\u52d5\u7684\u5be9\u8988\u65e5\u8a8c\u5f8c\uff0cIAM \u6703\u5728\u4e3b\u8cec\u865f\u4ea4\u63db\u4ee4\u724c\u6642\u751f\u6210\u4e00\u500b\u5be9\u8988\u65e5\u8a8c\u689d\u76ee\u3002\u8a72\u65e5\u8a8c\u689d\u76ee\u5305\u542b\u4ee5\u4e0b\u5b57\u6bb5\uff1a\n- `protoPayload.authenticationInfo.principalSubject`\uff1aIdP \u4ee4\u724c\u7684\u4e3b\u984c\u3002- \u5728 Amazon Web Services (AWS) \u4e0a\uff0c\u6b64\u5b57\u6bb5\u5305\u542b\u60a8\u5df2\u901a\u904e\u8eab\u4efd\u9a57\u8b49\u7684\u4e3b\u8cec\u865f\u7684 Amazon \u8cc7\u6e90\u540d\u7a31 (ARN)\u3002\n- \u5728 Microsoft Azure \u4e0a\uff0c\u6b64\u5b57\u6bb5\u5305\u542b\u60a8\u6307\u5b9a\u7232 Azure \u4ee4\u724c\u4e3b\u984c\u7684\u8a17\u7ba1\u5f0f\u8eab\u4efd\u7684\u5c0d\u8c61 ID\u3002\n- \u5c0d\u65bc\u5176\u4ed6 OIDC IdP\uff0c\u6b64\u5b57\u6bb5\u5305\u542b OIDC \u4ee4\u724c\u4e2d\u7684`sub`\u503c\u6216\u4e3b\u984c\u8072\u660e\u3002\n- `protoPayload.metadata.mapped_principal` \uff1a\u4ee4\u724c\u7684\u4e3b\u984c\uff0c\u4f7f\u7528 IAM \u8a9e\u6cd5\u4f86\u6a19\u8b58\u4e3b\u8cec\u865f\uff1a```\nprincipal://iam.googleapis.com/projects/project-number/locations/global/workloadIdentityPools/pool-id/subject/identifier\n```\n- `protoPayload.resourceName` \uff1a\u8207\u4ee4\u724c\u95dc\u806f\u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u63d0\u4f9b\u7a0b\u5e8f\u3002\n\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u4e86\u7528\u65bc\u4ea4\u63db\u4ee4\u724c\u7684\u8acb\u6c42\u7684\u5be9\u8988\u65e5\u8a8c\u689d\u76ee\u3002\u4ee5\u4e0b\u793a\u4f8b\u4e2d\uff0c\u7528\u65bc\u4ea4\u63db\u806f\u5408\u4ee4\u724c\u7684 Microsoft Azure \u4ee4\u724c\u5982\u4e0b\u6240\u793a\uff1a\n```\n{\u00a0 \"logName\": \"projects/my-project/logs/cloudaudit.googleapis.com%2Fdata_access\",\u00a0 \"protoPayload\": {\u00a0 \u00a0 \"@type\": \"type.googleapis.com/google.cloud.audit.AuditLog\",\u00a0 \u00a0 \"authenticationInfo\": {\u00a0 \u00a0 \u00a0 \"principalSubject\": \"b6112abb-5791-4507-adb5-7e8cc306eb2e\"\u00a0 \u00a0 },\u00a0 \u00a0 \"metadata\": {\u00a0 \u00a0 \u00a0 \"mapped_principal\": \"principal://iam.googleapis.com/projects/1234567890123/locations/global/workloadIdentityPools/azure-pool/subject/a1234bcd-5678-9012-efa3-4b5cd678ef9a\"\u00a0 \u00a0 },\u00a0 \u00a0 \"methodName\": \"google.identity.sts.v1.SecurityTokenService.ExchangeToken\",\u00a0 \u00a0 \"resourceName\": \"projects/1234567890123/locations/global/workloadIdentityPools/azure-pool/providers/azure\",\u00a0 \u00a0 \"request\": {\u00a0 \u00a0 \u00a0 \"@type\": \"type.googleapis.com/google.identity.sts.v1.ExchangeTokenRequest\",\u00a0 \u00a0 \u00a0 \"grantType\": \"urn:ietf:params:oauth:grant-type:token-exchange\"\u00a0 \u00a0 }\u00a0 },\u00a0 \"resource\": {\u00a0 \u00a0 \"type\": \"audited_resource\"\u00a0 }}\n```\n## \u7c3d\u540d\u548c\u52a0\u5bc6 SAML \u65b7\u8a00\u7684\u65e5\u8a8c\n\u672c\u90e8\u5206\u4ecb\u7d39 Security Token Service \u5728\u5617\u8a66\u9a57\u8b49\u7c3d\u540d\u7684 SAML \u65b7\u8a00\u6216\u89e3\u5bc6\u5f9e IdP \u767c\u9001\u7684\u52a0\u5bc6\u65b7\u8a00\u6642\u5275\u5efa\u7684 Cloud Audit Logs \u65e5\u8a8c\u689d\u76ee\u3002\n\u5c0d\u65bc\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u76f8\u95dc\u65e5\u8a8c\u689d\u76ee\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a\n```\n\"keyInfo\": [ {\n \"use\": \"verify\"\n \"fingerprint\": \"3C:B2:47:F8:A5:9A:8A:52:BD:1C:BC:96:B5:45:C1:8D:A7:F1:73:2D\"\n },\n {\n \"use\": \"decrypt\"\n \"resourceName\": \"//iam.googleapis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/WORKLOAD_POOL_NAME/providers/PROVIDER_NAME/keys/KEY_NAME\"\n }\n]\n```\n\u6b64\u8f38\u51fa\u5305\u62ec\u4ee5\u4e0b\u503c\uff1a\n- `fingerprint`\uff1a\u7528\u65bc\u9a57\u8b49 SAML \u6191\u64da\u4e0a\u7684\u7c3d\u540d\u7684 X.509 \u8b49\u66f8\u7684 SHA-256 \u54c8\u5e0c\u7684\u5341\u516d\u9032\u5236\u8868\u793a\u5f62\u5f0f\u3002X.509 \u8b49\u66f8\u662f\u5f9e\u9644\u52a0\u5230\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u63d0\u4f9b\u65b9\u7684 SAML XML \u5143\u6578\u64da\u4e2d\u63d0\u53d6\u7684\u3002\n- `resourceName`\uff1a\u7528\u65bc\u89e3\u5bc6\u52a0\u5bc6 SAML \u65b7\u8a00\u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u63d0\u4f9b\u65b9\u5bc6\u9470\u7684\u8cc7\u6e90\u540d\u7a31\u3002\u50c5\u7576\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u6536\u5230\u4f86\u81ea IdP \u7684\u52a0\u5bc6 SAML \u97ff\u61c9\u6642\uff0c\u6b64\u5b57\u6bb5\u7e94\u6703\u986f\u793a\u3002## \u7232\u670d\u52d9\u8cec\u865f\u5275\u5efa\u77ed\u671f\u6709\u6548\u7684\u6191\u64da\u6642\u751f\u6210\u7684\u65e5\u8a8c\n\u5c07 IdP \u4ee4\u724c\u4ea4\u63db\u7232\u806f\u5408\u4ee4\u724c\u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u806f\u5408\u4ee4\u724c\u7232\u670d\u52d9\u8cec\u865f\u5275\u5efa\u77ed\u671f\u6709\u6548\u6191\u64da\u3002\u6240\u6709 Google \u670d\u52d9\u90fd\u5141\u8a31\u60a8\u4f7f\u7528\u9019\u4e9b\u77ed\u671f\u6709\u6548\u6191\u64da\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\n\u5553\u7528\u6578\u64da\u8a2a\u554f\u6d3b\u52d5\u7684 IAM \u5be9\u8988\u65e5\u8a8c\u5f8c\uff0c\u6bcf\u6b21\u4e3b\u8cec\u865f\u7232\u670d\u52d9\u8cec\u865f\u751f\u6210\u77ed\u671f\u6709\u6548\u6191\u64da\u6642\uff0cIAM \u90fd\u6703\u751f\u6210\u5be9\u8988\u65e5\u8a8c\u689d\u76ee\u3002\u8a72\u65e5\u8a8c\u689d\u76ee\u5305\u542b\u4ee5\u4e0b\u5b57\u6bb5\uff1a\n- `protoPayload.authenticationInfo.principalSubject`\uff1a\u806f\u5408\u4ee4\u724c\u7684\u4e3b\u984c\u3002\n- `resource.labels.email_id`\uff1a\u7232\u5176\u751f\u6210\u77ed\u671f\u6709\u6548\u6191\u64da\u7684\u670d\u52d9\u8cec\u865f\u3002\n\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u4e86\u7528\u65bc\u7232\u670d\u52d9\u8cec\u865f\u751f\u6210\u77ed\u671f OAuth 2.0 \u8a2a\u554f\u4ee4\u724c\u7684\u8acb\u6c42\u7684\u5be9\u8988\u65e5\u8a8c\u689d\u76ee\u3002\u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u7cfb\u7d71\u4f7f\u7528\u806f\u5408\u6191\u64da\u5c0d\u8acb\u6c42\u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u4f75\u7232\u670d\u52d9\u8cec\u865f `my-service-account@my-project.iam.gserviceaccount.com` \u5275\u5efa\u4e86\u77ed\u671f\u6191\u64da\uff1a\n```\n{\u00a0 \"logName\": \"projects/my-project/logs/cloudaudit.googleapis.com%2Fdata_access\",\u00a0 \"protoPayload\": {\u00a0 \u00a0 \"@type\": \"type.googleapis.com/google.cloud.audit.AuditLog\",\u00a0 \u00a0 \"authenticationInfo\": {\u00a0 \u00a0 \u00a0 \"principalSubject\": \"principal://iam.googleapis.com/projects/1234567890123/locations/global/workloadIdentityPools/aws-pool/subject/012345678901\"\u00a0 \u00a0 },\u00a0 \u00a0 \"methodName\": \"GenerateAccessToken\",\u00a0 \u00a0 \"request\": {\u00a0 \u00a0 \u00a0 \"@type\": \"type.googleapis.com/google.iam.credentials.v1.GenerateAccessTokenRequest\",\u00a0 \u00a0 \u00a0 \"name\": \"projects/-/serviceAccounts/my-service-account@my-project.iam.gserviceaccount.com\"\u00a0 \u00a0 },\u00a0 \u00a0 \"resourceName\": \"projects/-/serviceAccounts/123456789012345678901\"\u00a0 },\u00a0 \"resource\": {\u00a0 \u00a0 \"labels\": {\u00a0 \u00a0 \u00a0 \"email_id\": \"my-service-account@my-project.iam.gserviceaccount.com\",\u00a0 \u00a0 \u00a0 \"project_id\": \"my-project\",\u00a0 \u00a0 \u00a0 \"unique_id\": \"123456789012345678901\"\u00a0 \u00a0 },\u00a0 \u00a0 \"type\": \"service_account\"\u00a0 }}\n```\n## \u4f7f\u7528\u6a21\u64ec\u670d\u52d9\u8cec\u865f\u7684\u6191\u64da\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u6642\u751f\u6210\u7684\u65e5\u8a8c\n\u7232\u670d\u52d9\u8cec\u865f\u5275\u5efa\u77ed\u671f\u6709\u6548\u6191\u64da\u5f8c\uff0c\u60a8\u5c31\u53ef\u4ee5\u5728\u8abf\u7528 Google Cloud API \u6642\u4f7f\u7528\u9019\u4e9b\u6191\u64da\u4f86\u6a21\u64ec\u670d\u52d9\u8cec\u865f\u3002\n\u60a8\u8abf\u7528\u7684\u67d0\u4e9b\u65b9\u6cd5\u53ef\u80fd\u6703\u751f\u6210\u5be9\u8988\u65e5\u8a8c\u3002\u901a\u5e38\uff0c\u9019\u4e9b\u65e5\u8a8c\u689d\u76ee\u6703\u986f\u793a\u4ee5\u4e0b\u8eab\u4efd\uff1a- \u77ed\u671f\u6709\u6548\u6191\u64da\u6240\u8981\u6a21\u64ec\u7684\u670d\u52d9\u8cec\u865f\n- \u5275\u5efa\u77ed\u671f\u6709\u6548\u6191\u64da\u7684\u8eab\u4efd\n**\u6ce8\u610f** \uff1a\u67d0\u4e9b Google Cloud \u670d\u52d9\uff08\u5305\u62ec App Engine \u548c Google Kubernetes Engine\uff09\u4e0d\u6703\u8a18\u9304\u5275\u5efa\u77ed\u671f\u6709\u6548\u6191\u64da\u7684\u8eab\u4efd\u3002\n\u4f8b\u5982\uff0c\u5047\u8a2d\u7528\u6236 `jamie@example.com` \u7232\u4e3b\u984c `principal://iam.googleapis.com/projects/1234567890123/locations/global/workloadIdentityPools/aws-pool/subject/jamie@example.com` \u5275\u5efa\u4e86\u4e00\u500b\u806f\u5408\u4ee4\u724c\uff0c\u7136\u5f8c\u4f7f\u7528\u806f\u5408\u4ee4\u724c\u7232\u670d\u52d9\u8cec\u865f\u5275\u5efa\u77ed\u671f\u6191\u64da `my-service-account@my-project.iam.gserviceaccount.com` \u4e2d\u79fb\u9664\u3002\n\u96a8\u5f8c\uff0c\u8a72\u7528\u6236\u5275\u5efa\u4e86\u65b0\u7684 Pub/Sub \u4e3b\u984c\uff0c\u4e26\u4f7f\u7528\u77ed\u671f\u6709\u6548\u6191\u64da\u4f86\u6a21\u64ec\u670d\u52d9\u8cec\u865f\u3002Pub/Sub \u6703\u751f\u6210\u4e00\u500b\u65e5\u8a8c\u689d\u76ee\uff0c\u7528\u65bc\u6a19\u8b58\u670d\u52d9\u8cec\u865f\u4ee5\u53ca IdP \u7684\u4ee4\u724c\u4e3b\u984c\uff1a\n```\n{\u00a0 \"logName\": \"projects/my-project/logs/cloudaudit.googleapis.com%2Factivity\",\u00a0 \"protoPayload\": {\u00a0 \u00a0 \"@type\": \"type.googleapis.com/google.cloud.audit.AuditLog\",\u00a0 \u00a0 \"authenticationInfo\": {\u00a0 \u00a0 \u00a0 \"principalEmail\": \"my-service-account@my-project.iam.gserviceaccount.com\",\u00a0 \u00a0 \u00a0 \"serviceAccountDelegationInfo\": [\u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"principalSubject\": \"principal://iam.googleapis.com/projects/1234567890123/locations/global/workloadIdentityPools/aws-pool/subject/012345678901\"\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 ]\u00a0 \u00a0 },\u00a0 \u00a0 \"methodName\": \"google.pubsub.v1.Publisher.CreateTopic\",\u00a0 \u00a0 \"request\": {\u00a0 \u00a0 \u00a0 \"@type\": \"type.googleapis.com/google.pubsub.v1.Topic\",\u00a0 \u00a0 \u00a0 \"name\": \"projects/my-project/topics/my-topic\"\u00a0 \u00a0 },\u00a0 \u00a0 \"resourceName\": \"projects/my-project/topics/my-topic\"\u00a0 },\u00a0 \"resource\": {\u00a0 \u00a0 \"type\": \"pubsub_topic\"\u00a0 }}\n```\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u7232 IAM [\u914d\u7f6e\u548c\u67e5\u770b\u5be9\u8988\u65e5\u8a8c](https://cloud.google.com/iam/docs/audit-logging?hl=zh-cn) \u3002\n- \u8a73\u7d30\u77ad\u89e3 [Cloud Audit Logs](https://cloud.google.com/logging/docs/audit?hl=zh-cn) \u3002\n- \u4f7f\u7528\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u8a2d\u7f6e [\u8eab\u4efd\u806f\u5408](https://cloud.google.com/iam/docs/workload-identity-federation?hl=zh-cn) \u3002\n- \u77ad\u89e3 [\u670d\u52d9\u8cec\u865f](https://cloud.google.com/iam/docs/service-accounts?hl=zh-cn) \u3002", "guide": "IAM"}