{"title": "IAM - Example logs for workforce identity federation", "url": "https://cloud.google.com/iam/docs/audit-logging/examples-workforce-identity", "abstract": "# IAM - Example logs for workforce identity federation\nThis page shows examples of the audit logs that are generated when you use [workforce identity federation](/iam/docs/configuring-workforce-identity-federation) . With workforce identity federation, you can allow third-party identities to access Google Cloud resources, without using a service account key.\n**Note:** Each example shows only the most relevant fields in the log entries.\nFor more information about enabling and viewing audit logs, see [IAM audit logging](/iam/docs/audit-logging) .\nIAM can generate audit logs when you create and manage workforce pools. To enable audit logs when managing workforce pools, you must [enable audit logs for Data Access activity](/iam/docs/audit-logging#enabling_audit_logging) for the following API:\n- Identity and Access Management (IAM) API (enable log type \"Admin Read\")\nTo further configure audit logs for the token-exchange process or Google Cloud console (federated) sign in, you must also [enable audit logs for Data Access activity](/iam/docs/audit-logging#enabling_audit_logging) for the following API:\n- Security Token Service API (enable log type \"Admin Read\")\n**Note:** The audit logs are generated at organization level.\n", "content": "## Logs for creating a workforce pool\nThe following example shows a log entry for creating a workforce pool. In this example, the user `sam@example.com` created a workforce pool with the ID `my-pool` under the organization with the ID `123456789012` .\n```\n{\u00a0 \"logName\": \"organizations/123456789012/logs/cloudaudit.googleapis.com%2Factivity\",\u00a0 \"protoPayload\": {\u00a0 \u00a0 \"@type\": \"type.googleapis.com/google.cloud.audit.AuditLog\",\u00a0 \u00a0 \"authenticationInfo\": {\u00a0 \u00a0 \u00a0 \"principalEmail\": \"sam@example.com\",\u00a0 \u00a0 },\u00a0 \u00a0 \"methodName\": \"google.iam.admin.v1.WorkforcePools.CreateWorkforcePool\",\u00a0 \u00a0 \"resourceName\": \"locations/global/workforcePools/my-pool\",\u00a0 \u00a0 \"serviceName\": \"iam.googleapis.com\",\u00a0 \u00a0 \"request\": {\u00a0 \u00a0 \u00a0 \"@type\": \"type.googleapis.com/google.iam.admin.v1.CreateWorkforcePoolRequest\",\u00a0 \u00a0 \u00a0 \"workforcePool\": {\u00a0 \u00a0 \u00a0 \u00a0 \"parent\": \"organizations/123456789012\"\u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \"workforcePoolId\": \"my-pool\"\u00a0 \u00a0 }\u00a0 },\u00a0 \"resource\": {\u00a0 \u00a0 \"type\": \"audited_resource\"\u00a0 }}\n```\n## Logs for exchanging an IdP token for a federated token\nAfter you set up your workforce identity pool and workforce identity pool provider, you can create a token for your identity provider (IdP) and exchange it for a federated token.\nAfter you enable Cloud Audit Logs for Data Access activity, IAM generates an audit log entry each time a principal exchanges a token. The log entry includes the following fields:\n- `protoPayload.authenticationInfo.principalSubject`: The subject of the IdP token.- For OIDC IdPs, this field contains the value of the`sub`, or subject, claim from the OIDC token.\n- For SAML IdPs, this field contains the value of the`NameID`sub-attribute of the`Subject`attribute in the SAML assertion.\n- `protoPayload.metadata.mapped_principal` : The subject of the token, using IAM syntax to identify the principal:```\nprincipal://iam.googleapis.com/locations/global/workforcePools/POOL_ID/subject/IDENTIFIER\n```\n- `protoPayload.resourceName` : The workforce pool provider that the token is associated with.\nThe following example shows an audit log entry for a request to exchange a token. In this example, an OIDC token is exchanged for a federated token:\n```\n{\u00a0 \"logName\": \"organizations/123456789012/logs/cloudaudit.googleapis.com%2Fdata_access\",\u00a0 \"protoPayload\": {\u00a0 \u00a0 \"@type\": \"type.googleapis.com/google.cloud.audit.AuditLog\",\u00a0 \u00a0 \"authenticationInfo\": {\u00a0 \u00a0 \u00a0 \"principalSubject\": \"b6112abb-5791-4507-adb5-7e8cc306eb2e\"\u00a0 \u00a0 },\u00a0 \u00a0 \"metadata\": {\u00a0 \u00a0 \u00a0 \"mapped_principal\": \"principal://iam.googleapis.com/locations/global/workforcePools/oidc-pool/subject/a1234bcd-5678-9012-efa3-4b5cd678ef9a\"\u00a0 \u00a0 },\u00a0 \u00a0 \"methodName\": \"google.identity.sts.v1.SecurityTokenService.ExchangeToken\",\u00a0 \u00a0 \"resourceName\": \"locations/global/workforcePools/oidc-pool/providers/oidc-provider\",\u00a0 \u00a0 \"serviceName\": \"sts.googleapis.com\",\u00a0 \u00a0 \"request\": {\u00a0 \u00a0 \u00a0 \"@type\": \"type.googleapis.com/google.identity.sts.v1.ExchangeTokenRequest\",\u00a0 \u00a0 \u00a0 \"audience\": \"//iam.googleapis.com/locations/global/workforcePools/oidc-pool/providers/oidc-provider\",\u00a0 \u00a0 \u00a0 \"grantType\": \"urn:ietf:params:oauth:grant-type:token-exchange\",\u00a0 \u00a0 \u00a0 \"requestedTokenType\": \"urn:ietf:params:oauth:token-type:access_token\",\u00a0 \u00a0 \u00a0 \"subjectTokenType\": \"urn:ietf:params:oauth:token-type:id_token\"\u00a0 \u00a0 }\u00a0 },\u00a0 \"resource\": {\u00a0 \u00a0 \"type\": \"audited_resource\"\u00a0 }}\n```\n## Logs for signed and encrypted SAML assertions\nThis section describes the Cloud Audit Logs log entries that Security Token Service creates when it attempts to verify signed SAML assertions or decrypt encrypted assertions that are sent from your IdP.\nFor workforce identity federation, the pertinent log entry looks similar to the following:\n```\n\"keyInfo\": [ {\n \"use\": \"verify\"\n \"fingerprint\": \"3C:B2:47:F8:A5:9A:8A:52:BD:1C:BC:96:B5:45:C1:8D:A7:F1:73:2D\"\n },\n {\n \"use\": \"decrypt\"\n \"resourceName\": \"//iam.googleapis.com/locations/global/workforcePools/WORKFORCE_POOL_NAME/providers/PROVIDER_NAME/keys/KEY_NAME\"\n }\n]\n```\nThis output includes the following values:\n- `fingerprint`: the hexadecimal representation of the SHA-256 hash of the X.509 certificate that was used to verify the signature on the SAML credential. The X.509 certificate is extracted from the SAML XML metadata that is attached to the workforce identity pool provider.\n- `resourceName`: the resource name of the workforce identity pool provider key that was used to decrypt the encrypted SAML assertion. This field is present only if workforce identity federation receives an encrypted SAML response from your IdP.## Logs for calling Google Cloud APIs with the federated token\nAfter you exchange the IdP's token for a federated token, you can use the federated token to call Google Cloud APIs. Some of the methods you call might generate audit logs.\nThe following example shows an audit log entry for a request to list the Cloud Storage buckets in a project using a federated token.\n```\n{\u00a0 \"logName\": \"projects/my-project/logs/cloudaudit.googleapis.com%2Fdata_access\",\u00a0 \"protoPayload\": {\u00a0 \u00a0 \"@type\": \"type.googleapis.com/google.cloud.audit.AuditLog\",\u00a0 \u00a0 \"authenticationInfo\": {\u00a0 \u00a0 \u00a0 \"principalSubject\": \"principal://iam.googleapis.com/locations/global/workforcePools/oidc-pool/subject/012345678901\"\u00a0 \u00a0 },\u00a0 \u00a0 \"methodName\": \"storage.buckets.list\",\u00a0 \u00a0 \"serviceName\": \"storage.googleapis.com\",\u00a0 },\u00a0 \"resource\": {\u00a0 \u00a0 \"type\": \"gcs_bucket\"\u00a0 }}\n```\n## Logs for Google Cloud console (federated) sign in\nAfter you [set up your workforce identity pools](/iam/docs/manage-workforce-identity-pools-providers) and their IdPs, users can sign in to the Google Cloud using [single sign on](/iam/docs/workforce-console-sso) .\n[](None)\n### Logs for successful sign-in\nThis section provides an example Cloud Audit Logs entry that is logged as a result of a successful sign-in. In this example, the user, `user@example.com` , signs in using a provider `locations/global/workforcePools/my-pool/providers/my-provider` . In this case, the following Cloud Audit Logs entry is generated:\n```\n{\u00a0 \"logName\": \"organizations/my-organization-id/logs/cloudaudit.googleapis.com%2Fdata_access\",\u00a0 \"protoPayload\": {\u00a0 \u00a0 \"@type\": \"type.googleapis.com/google.cloud.audit.AuditLog\",\u00a0 \u00a0 \"authenticationInfo\": {\u00a0 \u00a0 \u00a0 \"principalSubject\": \"user@example.com\",\u00a0 \u00a0 },\u00a0 \u00a0 \"serviceName\": \"sts.googleapis.com\",\u00a0 \u00a0 \"methodName\": \"google.identity.sts.SecurityTokenService.WebSignIn\",\u00a0 \u00a0 \"resourceName\": \"locations/global/workforcePools/my-pool/providers/my-provider\",\u00a0 \u00a0 \"request\": {\u00a0 \u00a0 \u00a0 \"@type\": \"type.googleapis.com/google.identity.sts.SecurityTokenService.WebSignInRequest\",\u00a0 \u00a0 \u00a0 \"provider\": \"//iam.googleapis.com/locations/global/workforcePools/my-pool/providers/my-provider\",\u00a0 \u00a0 \u00a0 \"continueUrl\": \"https://console.cloud.google\",\u00a0 \u00a0 \u00a0 \"host\": \"http://auth.cloud.google\",\u00a0 \u00a0 },\u00a0 \u00a0 \"metadata\": {\u00a0 \u00a0 \u00a0 \u00a0\"mappedPrincipal\": \"principal://iam.googleapis.com/locations/global/workforcePools/my-pool/subject/user@example.com\",\u00a0 \u00a0 }\u00a0 },\u00a0 \"resource\": {\u00a0 \u00a0 \"type\": \"audited_resource\",\u00a0 \u00a0 \"labels\": {\u00a0 \u00a0 \u00a0 \"service\": \"sts.googleapis.com\",\u00a0 \u00a0 \u00a0 \"method\": \"google.identity.sts.SecurityTokenService.WebSignIn\",\u00a0 \u00a0 }\u00a0 },}\n```\nThe Cloud Audit Logs entry for SAML providers can additionally contain signing key information in the metadata field.\n```\n{\u00a0 \"metadata\": {\u00a0 \u00a0 \"mappedPrincipal\": \"principal://iam.googleapis.com/locations/global/workforcePools/my-pool/subject/user@example.com\",\u00a0 \u00a0 \"keyInfo\": [\u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \"use\": \"verify\",\u00a0 \u00a0 \u00a0 \u00a0 \"fingerprint\": \"AE:CK:LM:EF:LK:OG:EH:IJ:KN:AL:OM:AD:NO\",\u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 ],\u00a0 }}\n```\n[](None)\n### Logs for failed sign-in\nThis section provides an example Cloud Audit Logs entry that is logged as a result of a failed sign-in. In this example, the user, `user@example.com` attempts to sign-in using a provider `locations/global/workforcePools/my-pool/providers/my-provider` but is denied access due to an attribute condition not being satisfied. In this case, the following Cloud Audit Logs entry is generated:\n```\n{\u00a0 \"logName\": \"organizations/my-organization-id/logs/cloudaudit.googleapis.com%2Fdata_access\",\u00a0 \"protoPayload\": {\u00a0 \u00a0 \"@type\": \"type.googleapis.com/google.cloud.audit.AuditLog\",\u00a0 \u00a0 \"authenticationInfo\": {\u00a0 \u00a0 \u00a0 \"principalSubject\": \"user@example.com\",\u00a0 \u00a0 },\u00a0 \u00a0 \"status\": {\u00a0 \u00a0 \u00a0 \"code\": 3,\u00a0 \u00a0 \u00a0 \"message\": \"The given credential is rejected by the attribute condition.\",\u00a0 \u00a0 },\u00a0 \u00a0 \"serviceName\": \"sts.googleapis.com\",\u00a0 \u00a0 \"methodName\": \"google.identity.sts.SecurityTokenService.WebSignIn\",\u00a0 \u00a0 \"resourceName\": \"locations/global/workforcePools/my-pool/subject/user@example.com\",\u00a0 \u00a0 \"request\": {\u00a0 \u00a0 \u00a0 \"@type\": \"type.googleapis.com/google.identity.sts.SecurityTokenService.WebSignInRequest\",\u00a0 \u00a0 \u00a0 \"provider\": \"//iam.googleapis.com/locations/global/workforcePools/my-pool/providers/my-provider\",\u00a0 \u00a0 \u00a0 \"host\": \"http://auth.cloud.google\",\u00a0 \u00a0 },\u00a0 \u00a0 \"metadata\": {\u00a0 \u00a0 \u00a0 \"mappedPrincipal\": \"principal://iam.googleapis.com/locations/global/workforcePools/my-pool/subject/user@example.com\",\u00a0 \u00a0 }\u00a0 },\u00a0 \"resource\": {\u00a0 \u00a0 \"type\": \"audited_resource\",\u00a0 \u00a0 \"labels\": {\u00a0 \u00a0 \u00a0 \"service\": \"sts.googleapis.com\",\u00a0 \u00a0 \u00a0 \"method\": \"google.identity.sts.SecurityTokenService.WebSignIn\",\u00a0 \u00a0 }\u00a0 },}\n```\n**Note:** Failed sign-in attempts are logged only for the cases where we were able to parse your Identity provider's response.\n[](None)\n### Logs for sign-out\nThis section provides an example Cloud Audit Logs entry that is logged as a result of a sign-out event. In this example, the user, `user@example.com` , who is signed in using a provider `locations/global/workforcePools/my-pool/providers/my-provider` initiates a sign-out. In this case, the following Cloud Audit Logs entry is generated:\n**Note:** The Cloud Audit Logs entry is written only for the initiator of the sign-out action.\n```\n{\u00a0 \"logName\": \"organizations/my-organization-id/logs/cloudaudit.googleapis.com%2Fdata_access\",\u00a0 \"protoPayload\": {\u00a0 \u00a0 \"@type\": \"type.googleapis.com/google.cloud.audit.AuditLog\",\u00a0 \u00a0 \"authenticationInfo\": {\u00a0 \u00a0 \u00a0 \"principalSubject\": \"user@example.com\",\u00a0 \u00a0 },\u00a0 \u00a0 \"serviceName\": \"sts.googleapis.com\",\u00a0 \u00a0 \"methodName\": \"google.identity.sts.SecurityTokenService.WebSignOut\",\u00a0 \u00a0 \"resourceName\": \"locations/global/workforcePools/my-pool/providers/my-provider\",\u00a0 \u00a0 \"request\": {\u00a0 \u00a0 \u00a0 \"@type\": \"type.googleapis.com/google.identity.sts.SecurityTokenService.WebSignOutRequest\",\u00a0 \u00a0 \u00a0 \"provider\": \"//iam.googleapis.com/locations/global/workforcePools/my-pool/providers/my-provider\",\u00a0 \u00a0 \u00a0 \"host\": \"http://auth.cloud.google\"\u00a0 \u00a0 },\u00a0 \u00a0 \"metadata\": {\u00a0 \u00a0 \u00a0 \"mappedPrincipal\": \"principal://iam.googleapis.com/locations/global/workforcePools/my-pool/subject/user@example.com\",\u00a0 \u00a0 }\u00a0 },\u00a0 \"resource\": {\u00a0 \u00a0 \"type\": \"audited_resource\",\u00a0 \u00a0 \"labels\": {\u00a0 \u00a0 \u00a0 \"service\": \"sts.googleapis.com\",\u00a0 \u00a0 \u00a0 \"method\": \"google.identity.sts.SecurityTokenService.WebSignOut\"\u00a0 \u00a0 }\u00a0 },}\n```\n## What's next\n- [Configure and view the audit logs](/iam/docs/audit-logging) for IAM.\n- Get more information about [Cloud Audit Logs](/logging/docs/audit) .\n- Set up [identity federation](/iam/docs/configuring-workforce-identity-federation) using workforce identity pools.", "guide": "IAM"}