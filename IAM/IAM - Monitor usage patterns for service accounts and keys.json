{"title": "IAM - Monitor usage patterns for service accounts and keys", "url": "https://cloud.google.com/iam/docs/service-account-monitoring", "abstract": "# IAM - Monitor usage patterns for service accounts and keys\nThis page explains how to use Cloud Monitoring to view usage metrics for your service accounts and service account keys. These metrics let you view and track usage patterns, which can help you identify anomalies, either automatically or manually.\n**Note:** To quickly identify the dates of only the most recent service account and key usages, see [View recent usage for service accounts andkeys](/iam/docs/service-account-recent-usage) .\nService accounts and service account keys appear in these metrics if they are used to call any Google API, including APIs that are not part of Google Cloud. The metrics include both successful and failed API calls. For example, if an API call fails because the caller is not authorized to call that API, or because the request referred to a resource that does not exist, the service account or key that was used for that API call appears in the metrics.\nService account keys also appear in these metrics if a system lists the keys while attempting to authenticate a request, even if the system doesn't use the key to authenticate the request. This behavior is most common when using [signed URLs for Cloud Storage](/storage/docs/access-control/signed-urls) or when authenticating to third-party applications. As a result it is possible to see usage metrics for keys that have not been used for authentication.\n**Note:** Cloud Storage HMAC authentication keys do not appear in either service account or service account key metrics.\nMonitoring retains service account metrics for 6 weeks. If you need to access data for a longer time period, you can periodically export the results to BigQuery. For more information, see [Monitoring metric export](/solutions/stackdriver-monitoring-metric-export) in the Solutions documentation.\nAfter you use a service account or service account key, usage metrics are usually available within a few minutes.\n", "content": "## Before you begin\n- Enable the IAM and Cloud Monitoring APIs. [Enable the APIs](https://console.cloud.google.com/flows/enableapi?apiid=iam.googleapis.com,monitoring.googleapis.com&redirect=https://console.cloud.google.com) \n### Required roles\nTo get the permissions that you need to view recent usage for service accounts and keys,   ask your administrator to grant you the [Monitoring Viewer ](https://cloud.google.com/iam/docs/understanding-roles#monitoring.viewer) ( `roles/monitoring.viewer` ) IAM role on the project.    For more information about granting roles, see [Manage access](/iam/docs/granting-changing-revoking-access) .\nYou might also be able to get  the required permissions through [custom  roles](/iam/docs/creating-custom-roles) or other [predefined  roles](/iam/docs/understanding-roles) .\n## View usage metrics for all service accounts or keys\nTo view the usage metrics for your service accounts or service account keys, follow these steps:\nTo view the metrics for a monitored resource by using the Metrics Explorer, do the following:- In the navigation panel of the Google Cloud console, select **Monitoring** , and then select **Metrics explorer** : [Go to Metrics explorer](https://console.cloud.google.com/monitoring/metrics-explorer) \n- In the **Metric** element, expand the **Select a metric** menu,  enter`IAM Service Account`in the filter bar, and then use the submenus to select a specific resource type and metric:- In the **Active resources** menu, select **IAM Service Account** .\n- In the **Active metric categories** menu, select **Service_account** .\n- In the **Active metrics** menu, select a service account metric.     The following metrics are available within your selected time interval:- For service account usage metrics,  select **Service account authentication events** .\n- For service account key usage metrics,  select **Service account key authentication events** .\n- Click **Apply** .\n- To remove time series from the display, use the [Filter element](/monitoring/charts/metrics-selector#filter-option) .\n- To combine time series, use the menus on the [Aggregation element](/monitoring/charts/metrics-selector#select_display) .  For example, to display the CPU utilization for your VMs, based on their zone, set the  first menu to **Mean** and the second menu to **zone** .All time series are displayed when the first menu of the **Aggregation** element is set  to **Unaggregated** . The default settings for the **Aggregation** element  are determined by the metric type you selected.\n- For quota and other metrics that report one sample per day, do the following:- In the **Display** pane,   set the **Widget type** to **Stacked bar chart** .\n- Set the time period to at least one week.\n **Note:** Service account metrics include disabled service accounts. Service account key metrics include disabled service account keys, but they might include expired or deleted service account keys.The Cloud Monitoring API API's ` [timeSeries.list](/monitoring/api/ref_v3/rest/v3/projects.timeSeries/list) ` method allows you to access usage metrics programmatically.\nBefore using any of the request data, make the following replacements:- ``: Your Google Cloud project ID. Project IDs are alphanumeric strings, like`my-project`.\n- ``: The type of metric you want to check. Use one of the  following values:- For service account usage metrics, use`iam.googleapis.com%2Fservice_account%2Fauthn_events_count`.\n- For service account key usage metrics, use`iam.googleapis.com%2Fservice_account%2Fkey%2Fauthn_events_count`.\n- ``: The end of the time interval that you want to check, in percent-encoded [RFC 3339](https://tools.ietf.org/html/rfc3339) format. For example,`2020-06-12T00%3A00%3A00.00Z`.\n- ``: The start of the time interval that you want to check, in percent-encoded [RFC 3339](https://tools.ietf.org/html/rfc3339) format. For example,`2020-04-12T00%3A00%3A00.00Z`.\n- **Note:** If you are sending the request using the API Explorer, do not use percent-encoded  values.\nHTTP method and URL:\n```\nGET https://monitoring.googleapis.com/v3/projects/PROJECT_ID/timeSeries?filter=metric.type%3D%22METRIC_TYPE%22&interval.endTime=END_TIME&interval.startTime=START_TIME\n```\nTo send your request, expand one of these options:\nFor more information about programmatically reading usage metrics, see [Reading metric data](/monitoring/custom-metrics/reading-metrics) in the Monitoring documentation.\n **Note:** Service account metrics include disabled service accounts. Service account key metrics include disabled service account keys, but they might include expired or deleted service account keys.\n## View usage metrics for a single service account\nTo view usage metrics for a single service account, follow these steps:\n- In the Google Cloud console, go to the **Service Accounts** page. [Go to Service Accounts](https://console.cloud.google.com/iam-admin/serviceaccounts) \n- Select the project that contains your service account.\n- Click the email address of your service account.\n- Click the **Metrics** tab. The **Authentication traffic** chart shows the usage metrics for the service account.\n- Optional: To view the chart on the **Metrics explorer** page, which offers additional filtering and viewing options, click more_vert > **View in Metrics Explorer** .\nThe Cloud Monitoring API's ` [timeSeries.list](/monitoring/api/ref_v3/rest/v3/projects.timeSeries/list) ` method , when used with specific filters, allows you to get usage metrics for a single service account. You can then use those metrics to determine when the account was last used.\nBefore using any of the request data, make the following replacements:- ``: Your Google Cloud project ID. Project IDs are alphanumeric strings, like`my-project`.\n- ``: The unique numeric ID of your service account. To  find your service account's unique numeric ID, follow these steps:- In the Google Cloud console, go to the **Service Accounts** page. [Go to the   Service Accounts page](https://console.cloud.google.com/iam-admin/serviceaccounts) \n- Click the email address of your service account. Your service account's unique numeric ID   is the value in the **Unique ID** field.\n- ``: The end of the time interval that you want to check, in percent-encoded [RFC 3339](https://tools.ietf.org/html/rfc3339) format. For example,`2020-06-12T00%3A00%3A00.00Z`.\n- ``: The start of the time interval that you want to check, in percent-encoded [RFC 3339](https://tools.ietf.org/html/rfc3339) format. For example,`2020-04-12T00%3A00%3A00.00Z`.\n- **Note:** If you are sending the request using the API Explorer, do not use percent-encoded  values.\nHTTP method and URL:\n```\nGET https://monitoring.googleapis.com/v3/projects/PROJECT_ID/timeSeries?filter=metric.type%3D%22iam.googleapis.com%2Fservice_account%2Fauthn_events_count%22%20AND%20resource.labels.unique_id%3D%22SERVICE_ACCOUNT_ID%22&interval.endTime=END_TIME&interval.startTime=START_TIME\n```\nTo send your request, expand one of these options:\nThe response contains a [timeSeries object](/monitoring/api/ref_v3/rest/v3/TimeSeries) with all of the recent authentication events for the specified service account.\n## View usage metrics for a single service account key\nTo view usage metrics for a single service account key, follow these steps:\n- In the Google Cloud console, go to the **Service Accounts** page. [Go to Service Accounts](https://console.cloud.google.com/iam-admin/serviceaccounts) \n- Select the project that contains the service account associated with your key.\n- Click the email address of the service account associated with your key.\n- Click the **Metrics** tab. The **Authentication traffic per key** chart shows usage metrics for all keys associated with the service account.\n- In the chart legend, click the ID of the service account key that you want to view usage metrics for. The chart updates to show metrics for only that service account key.\n- Optional: To view the chart on the **Metrics explorer** page, which offers additional filtering and viewing options, click more_vert > **View in Metrics Explorer** .\n **First, get the service account key's ID.** - List the service account keys:The ` [projects.serviceAccounts.keys.list](/iam/docs/reference/rest/v1/projects.serviceAccounts.keys/list) ` method lists all of the service account keys for a service account.Before using any of the request data, make the following replacements:- ``: Your Google Cloud project ID. Project IDs are alphanumeric strings, like`my-project`.\n- ``: The name of the service account whose keys you want to list.\n- ``: Optional. A comma-separated list of key types that you want  to include in the response. The key type indicates whether a key is user-managed  (`USER_MANAGED`) or system-managed (`SYSTEM_MANAGED`). If left blank, all  keys are returned.\nHTTP method and URL:\n```\nGET https://iam.googleapis.com/v1/projects/PROJECT_ID/serviceAccounts/SA_NAME@PROJECT_ID.iam.gserviceaccount.com/keys?keyTypes=KEY_TYPES\n```\nTo send your request, expand one of these options:You should receive a JSON response similar to the following:\n```\n{\n \"keys\": [ {\n  \"name\": \"projects/my-project/serviceAccounts/my-service-account@my-project.iam.gserviceaccount.com/keys/90c48f61c65cd56224a12ab18e6ee9ca9c3aee7c\",\n  \"validAfterTime\": \"2020-03-04T17:39:47Z\",\n  \"validBeforeTime\": \"9999-12-31T23:59:59Z\",\n  \"keyAlgorithm\": \"KEY_ALG_RSA_2048\",\n  \"keyOrigin\": \"GOOGLE_PROVIDED\",\n  \"keyType\": \"USER_MANAGED\"\n },\n {\n  \"name\": \"projects/my-project/serviceAccounts/my-service-account@my-project.iam.gserviceaccount.com/keys/e5e3800831ac1adc8a5849da7d827b4724b1fce8\",\n  \"validAfterTime\": \"2020-03-31T23:50:09Z\",\n  \"validBeforeTime\": \"9999-12-31T23:59:59Z\",\n  \"keyAlgorithm\": \"KEY_ALG_RSA_2048\",\n  \"keyOrigin\": \"GOOGLE_PROVIDED\",\n  \"keyType\": \"USER_MANAGED\"\n },\n {\n  \"name\": \"projects/my-project/serviceAccounts/my-service-account@my-project.iam.gserviceaccount.com/keys/b97699f042b8eee6a846f4f96259fbcd13e2682e\",\n  \"validAfterTime\": \"2020-05-17T18:58:13Z\",\n  \"validBeforeTime\": \"9999-12-31T23:59:59Z\",\n  \"keyAlgorithm\": \"KEY_ALG_RSA_2048\",\n  \"keyOrigin\": \"GOOGLE_PROVIDED\",\n  \"keyType\": \"USER_MANAGED\",\n  \"disabled\": true\n }\n ]\n}\n```- Use the metadata in the response to identify the key you want to track. Then, copy the key's unique ID from the end of the `name` field.The `name` field has the following format:```\n\"name\": \"projects/PROJECT_ID/serviceAccounts/SERVICE_ACCOUNT_EMAIL/keys/KEY_ID\"\n```The key's unique ID is everything after `keys/` .For example, the unique ID in the following key name is `0f561cc41650ff521899de2fd653bd3de08e2da4` :```\n\"name\": \"projects/my-project/serviceAccounts/my-account@my-project.iam.gserviceaccount.com/keys/0f561cc41650ff521899de2fd653bd3de08e2da4\"\n```\n **Then, use the ID to view usage metrics for the service account key.** \nThe Cloud Monitoring API's ` [timeSeries.list](/monitoring/api/ref_v3/rest/v3/projects.timeSeries/list) ` method , when used with specific filters, allows you to get usage metrics for a single service account key. You can then use those metrics to determine when the key was last used.\nBefore using any of the request data, make the following replacements:- ``: Your Google Cloud project ID. Project IDs are alphanumeric strings, like`my-project`.\n- ``: The unique ID of your service account key.\n- ``: The end of the time interval that you want to check, in percent-encoded [RFC 3339](https://tools.ietf.org/html/rfc3339) format. For example,`2020-06-12T00%3A00%3A00.00Z`.\n- ``: The start of the time interval that you want to check, in percent-encoded [RFC 3339](https://tools.ietf.org/html/rfc3339) format. For example,`2020-04-12T00%3A00%3A00.00Z`.\n- **Note:** If you are sending the request using the API Explorer, do not use percent-encoded  values.\nHTTP method and URL:\n```\nGET https://monitoring.googleapis.com/v3/projects/PROJECT_ID/timeSeries?filter=metric.type%3D%22iam.googleapis.com%2Fservice_account%2Fkey%2Fauthn_events_count%22%20AND%20metric.labels.key_id%3D%22KEY_ID%22&interval.endTime=END_TIME&interval.startTime=START_TIME\n```\nTo send your request, expand one of these options:\nThe response contains a [timeSeries object](/monitoring/api/ref_v3/rest/v3/TimeSeries) with all of the recent authentication events for the specified service account key.\n## Export metrics\nYou can use Monitoring to export your metrics to BigQuery. Exporting metrics is useful for performing long-term analysis because Monitoring only retains metrics for a limited time.\nFor instructions, see [Monitoring metric export](/solutions/stackdriver-monitoring-metric-export) in the Solutions documentation.\n## What's next\n- Discover how to [export metric data](/solutions/stackdriver-monitoring-metric-export) to BigQuery.\n- Use Activity Analyzer to [view only the most recent authenticationevents](/iam/docs/service-account-recent-usage) for your service accounts and keys.\n- Use [service account insights](/iam/docs/manage-service-account-insights) to identify service accounts that have not been used in the past 90 days.\n- Learn how to [disable service accounts](/iam/docs/service-accounts-disable-enable#disabling) or [delete service accounts](/iam/docs/service-accounts-delete-undelete#deleting) .\n- Learn how to [delete service account keys](/iam/docs/keys-create-delete#deleting) .\n- Explore the features offered by [Monitoring](/monitoring/docs) .", "guide": "IAM"}