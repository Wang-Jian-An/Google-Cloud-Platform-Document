{"title": "IAM - Example logs for workload identity federation", "url": "https://cloud.google.com/iam/docs/audit-logging/examples-workload-identity", "abstract": "# IAM - Example logs for workload identity federation\nThis page shows examples of the audit logs that are generated when you use [workload identity federation](/iam/docs/workload-identity-federation) . With workload identity federation, you can allow an on-premise or multi-cloud workload to access Google Cloud resources, without using a service account key.\n**Note:** Each example shows only the most relevant fields in the log entries.\nFor more information about enabling and viewing audit logs, see [IAM audit logging](/iam/docs/audit-logging) .\n", "content": "## Logs for exchanging an IdP token for a federated token\nAfter you [set up your workload identity pools](/iam/docs/manage-workload-identity-pools-providers) and identity provider (IdP), you can create a token for your IdP and exchange it for a federated token.\nIAM can generate audit logs when principals exchange a token. To receive audit logs for all steps of the token-exchange process, you must [enable audit logs for Data Access activity](/iam/docs/audit-logging#enabling_audit_logging) for the following APIs:\n- Identity and Access Management (IAM) API (enable log type \"Admin Read\")\n- Security Token Service API (enable log type \"Admin Read\")\nAfter you enable audit logs for Data Access activity, IAM generates an audit log entry each time a principal exchanges a token. The log entry includes the following fields:\n- `protoPayload.authenticationInfo.principalSubject`: The subject of the IdP token.- On Amazon Web Services (AWS), this field contains the Amazon Resource Name (ARN) of the principal that you authenticated.\n- On Microsoft Azure, this field contains the object ID of the managed identity that you specified as the Azure token subject.\n- For other OIDC IdPs, this field contains the value of the`sub`, or subject, claim from the OIDC token.\n- `protoPayload.metadata.mapped_principal` : The subject of the token, using IAM syntax to identify the principal:```\nprincipal://iam.googleapis.com/projects/project-number/locations/global/workloadIdentityPools/pool-id/subject/identifier\n```\n- `protoPayload.resourceName` : The workload identity pool provider that the token is associated with.\nThe following example shows an audit log entry for a request to exchange a token. In this example, a Microsoft Azure token was exchanged for a federated token:\n```\n{\u00a0 \"logName\": \"projects/my-project/logs/cloudaudit.googleapis.com%2Fdata_access\",\u00a0 \"protoPayload\": {\u00a0 \u00a0 \"@type\": \"type.googleapis.com/google.cloud.audit.AuditLog\",\u00a0 \u00a0 \"authenticationInfo\": {\u00a0 \u00a0 \u00a0 \"principalSubject\": \"b6112abb-5791-4507-adb5-7e8cc306eb2e\"\u00a0 \u00a0 },\u00a0 \u00a0 \"metadata\": {\u00a0 \u00a0 \u00a0 \"mapped_principal\": \"principal://iam.googleapis.com/projects/1234567890123/locations/global/workloadIdentityPools/azure-pool/subject/a1234bcd-5678-9012-efa3-4b5cd678ef9a\"\u00a0 \u00a0 },\u00a0 \u00a0 \"methodName\": \"google.identity.sts.v1.SecurityTokenService.ExchangeToken\",\u00a0 \u00a0 \"resourceName\": \"projects/1234567890123/locations/global/workloadIdentityPools/azure-pool/providers/azure\",\u00a0 \u00a0 \"request\": {\u00a0 \u00a0 \u00a0 \"@type\": \"type.googleapis.com/google.identity.sts.v1.ExchangeTokenRequest\",\u00a0 \u00a0 \u00a0 \"grantType\": \"urn:ietf:params:oauth:grant-type:token-exchange\"\u00a0 \u00a0 }\u00a0 },\u00a0 \"resource\": {\u00a0 \u00a0 \"type\": \"audited_resource\"\u00a0 }}\n```\n## Logs for signed and encrypted SAML assertions\nThis section describes the Cloud Audit Logs log entries that Security Token Service creates when it attempts to verify signed SAML assertions or decrypt encrypted assertions that are sent from your IdP.\nFor workload identity federation, the pertinent log entry looks similar to the following:\n```\n\"keyInfo\": [ {\n \"use\": \"verify\"\n \"fingerprint\": \"3C:B2:47:F8:A5:9A:8A:52:BD:1C:BC:96:B5:45:C1:8D:A7:F1:73:2D\"\n },\n {\n \"use\": \"decrypt\"\n \"resourceName\": \"//iam.googleapis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/WORKLOAD_POOL_NAME/providers/PROVIDER_NAME/keys/KEY_NAME\"\n }\n]\n```\nThis output includes the following values:\n- `fingerprint`: the hexadecimal representation of the SHA-256 hash of the X.509 certificate that was used to verify the signature on the SAML credential. The X.509 certificate is extracted from the SAML XML metadata that is attached to the workload identity pool provider.\n- `resourceName`: the resource name of the workload identity pool provider key that was used to decrypt the encrypted SAML assertion. This field is present only if workload identity federation receives an encrypted SAML response from your IdP.## Logs for creating short-lived credentials for a service account\nAfter you exchange the IdP token for a federated token, you can use the federated token to create short-lived credentials for a service account. All Google services allow you to authenticate with these short-lived credentials.\nAfter you enable IAM audit logs for Data Access activity, IAM generates an audit log entry each time a principal generates short-lived credentials for a service account. The log entry includes the following fields:\n- `protoPayload.authenticationInfo.principalSubject`: The subject of the federated token.\n- `resource.labels.email_id`: The service account for which short-lived credentials were generated.\nThe following example shows an audit log entry for a request to generate a short-lived OAuth 2.0 access token for a service account. In this example, the request was authenticated with federated credentials, and the short-lived credentials were created for the service account `my-service-account@my-project.iam.gserviceaccount.com` :\n```\n{\u00a0 \"logName\": \"projects/my-project/logs/cloudaudit.googleapis.com%2Fdata_access\",\u00a0 \"protoPayload\": {\u00a0 \u00a0 \"@type\": \"type.googleapis.com/google.cloud.audit.AuditLog\",\u00a0 \u00a0 \"authenticationInfo\": {\u00a0 \u00a0 \u00a0 \"principalSubject\": \"principal://iam.googleapis.com/projects/1234567890123/locations/global/workloadIdentityPools/aws-pool/subject/012345678901\"\u00a0 \u00a0 },\u00a0 \u00a0 \"methodName\": \"GenerateAccessToken\",\u00a0 \u00a0 \"request\": {\u00a0 \u00a0 \u00a0 \"@type\": \"type.googleapis.com/google.iam.credentials.v1.GenerateAccessTokenRequest\",\u00a0 \u00a0 \u00a0 \"name\": \"projects/-/serviceAccounts/my-service-account@my-project.iam.gserviceaccount.com\"\u00a0 \u00a0 },\u00a0 \u00a0 \"resourceName\": \"projects/-/serviceAccounts/123456789012345678901\"\u00a0 },\u00a0 \"resource\": {\u00a0 \u00a0 \"labels\": {\u00a0 \u00a0 \u00a0 \"email_id\": \"my-service-account@my-project.iam.gserviceaccount.com\",\u00a0 \u00a0 \u00a0 \"project_id\": \"my-project\",\u00a0 \u00a0 \u00a0 \"unique_id\": \"123456789012345678901\"\u00a0 \u00a0 },\u00a0 \u00a0 \"type\": \"service_account\"\u00a0 }}\n```\n## Logs for authenticating with credentials for the impersonated service account\nAfter you create short-lived credentials for a service account, you can use the credentials to impersonate the service account when you call Google Cloud APIs.\nSome of the methods you call might generate audit logs. In general, these log entries show the following identities:- The service account that the short-lived credentials are impersonating\n- The identity that created the short-lived credentials\n**Note:** Some Google Cloud services, including App Engine and Google Kubernetes Engine, do not log the identity that created the short-lived credentials.\nFor example, suppose that the user `jamie@example.com` creates a federated token for the subject `principal://iam.googleapis.com/projects/1234567890123/locations/global/workloadIdentityPools/aws-pool/subject/jamie@example.com` , then uses the federated token to create short-lived credentials for the service account `my-service-account@my-project.iam.gserviceaccount.com` .\nThe user then creates a new Pub/Sub topic, using the short-lived credentials to impersonate the service account. Pub/Sub generates a log entry that identifies the service account, as well as the subject of the token from the IdP:\n```\n{\u00a0 \"logName\": \"projects/my-project/logs/cloudaudit.googleapis.com%2Factivity\",\u00a0 \"protoPayload\": {\u00a0 \u00a0 \"@type\": \"type.googleapis.com/google.cloud.audit.AuditLog\",\u00a0 \u00a0 \"authenticationInfo\": {\u00a0 \u00a0 \u00a0 \"principalEmail\": \"my-service-account@my-project.iam.gserviceaccount.com\",\u00a0 \u00a0 \u00a0 \"serviceAccountDelegationInfo\": [\u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"principalSubject\": \"principal://iam.googleapis.com/projects/1234567890123/locations/global/workloadIdentityPools/aws-pool/subject/012345678901\"\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 ]\u00a0 \u00a0 },\u00a0 \u00a0 \"methodName\": \"google.pubsub.v1.Publisher.CreateTopic\",\u00a0 \u00a0 \"request\": {\u00a0 \u00a0 \u00a0 \"@type\": \"type.googleapis.com/google.pubsub.v1.Topic\",\u00a0 \u00a0 \u00a0 \"name\": \"projects/my-project/topics/my-topic\"\u00a0 \u00a0 },\u00a0 \u00a0 \"resourceName\": \"projects/my-project/topics/my-topic\"\u00a0 },\u00a0 \"resource\": {\u00a0 \u00a0 \"type\": \"pubsub_topic\"\u00a0 }}\n```\n## What's next\n- [Configure and view the audit logs](/iam/docs/audit-logging) for IAM.\n- Get more information about [Cloud Audit Logs](/logging/docs/audit) .\n- Set up [identity federation](/iam/docs/workload-identity-federation) using workload identity pools.\n- Learn about [service accounts](/iam/docs/service-accounts) .", "guide": "IAM"}