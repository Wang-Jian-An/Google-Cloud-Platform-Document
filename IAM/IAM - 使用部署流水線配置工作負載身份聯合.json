{"title": "IAM - \u4f7f\u7528\u90e8\u7f72\u6d41\u6c34\u7dda\u914d\u7f6e\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408", "url": "https://cloud.google.com/iam/docs/workload-identity-federation-with-deployment-pipelines?hl=zh-cn", "abstract": "# IAM - \u4f7f\u7528\u90e8\u7f72\u6d41\u6c34\u7dda\u914d\u7f6e\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\n\u672c\u6307\u5357\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u8b93\u90e8\u7f72\u6d41\u6c34\u7dda\u5411 Google Cloud \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\n\u6839\u64da\u60a8\u4f7f\u7528\u7684 CI/CD \u7cfb\u7d71\uff0c\u60a8\u7684\u90e8\u7f72\u6d41\u6c34\u7dda\u53ef\u80fd\u6703\u8a2a\u554f\u7279\u5b9a\u65bc\u74b0\u5883\u7684\u74b0\u5883\u6191\u64da\u3002\u4f8b\u5982\uff1a\n- GitHub Actions \u5de5\u4f5c\u6d41\u53ef\u4ee5\u7372\u53d6 [GitHub OIDC \u4ee4\u724c](https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect) \u4ee5\u552f\u4e00\u6a19\u8b58\u5de5\u4f5c\u6d41\u53ca\u5176\u4ee3\u78bc\u5eab\u3002\n- GitLab SaaS \u5141\u8a31 CI/CD \u4f5c\u696d\u8a2a\u554f\u552f\u4e00\u6a19\u8b58\u4f5c\u696d\u53ca\u5176\u9805\u76ee\u3001\u74b0\u5883\u548c\u4ee3\u78bc\u5eab\u7684 [ID \u4ee4\u724c](https://docs.gitlab.com/ee/ci/secrets/id_token_authentication.html) \u3002\n- Terraform Cloud \u53ef\u4ee5\u5411\u60a8\u7684 Terraform \u914d\u7f6e\u63d0\u4f9b [OIDC \u4ee4\u724c](https://discuss.hashicorp.com/t/tfe-release-v202208-1-647/43164#httpswwwterraformioenterprisereleases2022v202208-1featuresfeatures-2) \u4ee5\u552f\u4e00\u6a19\u8b58\u5de5\u4f5c\u5340\u548c\u74b0\u5883\u3002\n\u60a8\u53ef\u4ee5\u901a\u904e\u4f7f\u7528\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u5c07\u90e8\u7f72\u6d41\u6c34\u7dda\u914d\u7f6e\u7232\u4f7f\u7528\u9019\u4e9b\u6191\u64da\u5411 Google Cloud \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u6b64\u65b9\u6cd5\u53ef\u6d88\u9664\u8207 [\u670d\u52d9\u8cec\u865f\u5bc6\u9470](https://cloud.google.com/iam/docs/service-account-creds?hl=zh-cn#key-types) \u76f8\u95dc\u7684\u7dad\u8b77\u548c\u5b89\u5168\u8ca0\u64d4\u3002\n", "content": "## \u6e96\u5099\u5916\u90e8 IdP\n\u60a8\u7121\u9700\u5728 GitHub \u8cec\u865f\u4e2d\u9032\u884c\u4efb\u4f55\u66f4\u6539\u3002\n\u5c07\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60 [\u914d\u7f6e](#configure) \u7232\u4fe1\u4efb\u60a8\u7684 GitHub \u4ee3\u78bc\u5eab\u5f8c\uff0c\u60a8\u53ef\u4ee5\u8b93\u8a72\u4ee3\u78bc\u5eab\u4e2d\u7684\u5de5\u4f5c\u6d41\u4f7f\u7528\u5176 GitHub OIDC \u4ee4\u724c\u4f86\u7372\u53d6\u77ed\u671f Google Cloud \u6191\u64da\u3002\n\u60a8\u7121\u9700\u5728 GitLab \u8cec\u865f\u4e2d\u9032\u884c\u4efb\u4f55\u66f4\u6539\u3002\n\u5c07\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60 [\u914d\u7f6e](#configure) \u7232\u4fe1\u4efb\u60a8\u7684 GitLab \u7d44\u5f8c\uff0c\u60a8\u53ef\u4ee5\u7232\u5404\u9805 CI/CD \u4f5c\u696d\u5553\u7528\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\n\u60a8\u7121\u9700\u5728 Terraform Cloud \u8cec\u865f\u4e2d\u9032\u884c\u4efb\u4f55\u66f4\u6539\u914d\u7f6e\u3002\n\u5c07\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60 [\u914d\u7f6e](#configure) \u7232\u4fe1\u4efb Terraform Cloud \u5f8c\uff0c\u60a8\u53ef\u4ee5\u7232\u5404\u500b\u5de5\u4f5c\u5340\u5553\u7528\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\n## \u914d\u7f6e\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\n\u60a8\u5fc5\u9808\u7232\u6bcf\u500b GitHub \u7d44\u7e54\u3001GitLab \u7fa3\u7d44\u6216 Terraform Cloud \u7d44\u7e54\u57f7\u884c\u9019\u4e9b\u6b65\u9a5f\u3002\n\u5982\u9700\u958b\u59cb\u914d\u7f6e\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- \u5728 Google Cloud Console \u4e2d\u7684\u9805\u76ee\u9078\u64c7\u5668\u9801\u9762\u4e0a\uff0c\u9078\u64c7\u6216 [\u5275\u5efa\u4e00\u500b Google Cloud \u9805\u76ee](https://cloud.google.com/resource-manager/docs/creating-managing-projects?hl=zh-cn) \u3002 [\u8f49\u5230\u201c\u9805\u76ee\u9078\u64c7\u5668\u201d](https://console.cloud.google.com/projectselector2/home/dashboard?hl=zh-cn) \n- \u6700\u597d\n- [\u4f7f\u7528\u5c08\u7528\u9805\u76ee\u4f86\u7ba1\u7406\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u548c\u63d0\u4f9b\u65b9](https://cloud.google.com/iam/docs/best-practices-for-using-workload-identity-federation?hl=zh-cn#dedicated-project) \n- \u3002\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- [\u78ba\u4fdd\u60a8\u7684 Google Cloud \u9805\u76ee\u5df2\u5553\u7528\u7d50\u7b97\u529f\u80fd](https://cloud.google.com/billing/docs/how-to/verify-billing-enabled?hl=zh-cn#console) \u3002\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- \u5553\u7528 IAM, Resource Manager, Service Account Credentials, and Security Token Service API\u3002\n- [\u5553\u7528 API](https://console.cloud.google.com/flows/enableapi?apiid=iam.googleapis.com%2Ccloudresourcemanager.googleapis.com%2Ciamcredentials.googleapis.com%2Csts.googleapis.com&%3Bredirect=https%3A%2F%2Fconsole.cloud.google.com&hl=zh-cn) \n### \u5b9a\u7fa9\u5c6c\u6027\u6620\u5c04\n\u90e8\u7f72\u6d41\u6c34\u7dda\u7684\u7279\u5b9a\u65bc\u74b0\u5883\u7684\u6191\u64da\u53ef\u4ee5\u5305\u542b\u591a\u500b\u5c6c\u6027\uff0c\u60a8\u5fc5\u9808\u6c7a\u5b9a\u8981\u5728 Google Cloud \u4e2d\u7528\u4f5c\u4e3b\u9ad4\u6a19\u8b58\u7b26 ( `google.subject` ) \u7684\u5c6c\u6027\u3002\n\u60a8\u4e5f\u53ef\u4ee5\u8996\u9700\u8981 [\u6620\u5c04\u5176\u4ed6\u7279\u6027](https://cloud.google.com/iam/docs/workload-identity-federation?hl=zh-cn#mapping) \u3002\u7136\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5728\u6388\u4e88\u5c0d\u8cc7\u6e90\u7684\u8a2a\u554f\u6b0a\u9650\u6642\u5f15\u7528\u9019\u4e9b\u9644\u52a0\u5c6c\u6027\u3002\n\u5c6c\u6027\u6620\u5c04\u53ef\u4ee5\u4f7f\u7528 [GitHub Actions OIDC \u4ee4\u724c\u4e2d\u7684\u4efb\u4f55\u8072\u660e](https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#understanding-the-oidc-token) \u3002\u9019\u4e9b\u4ee4\u724c\u8072\u660e\u5bc6\u9470\u53ca\u5176\u503c\u7531 GitHub \u63a7\u5236\u3002\u60a8\u81f3\u5c11\u61c9\u5c07 `google.subject` \u6620\u5c04\u5230 `assertion.sub` \uff0c\u8a72\u5c6c\u6027\u5c0d\u61c9\u65bc GitHub Actions OIDC \u4ee4\u724c\u4e3b\u984c\uff1a\n```\ngoogle.subject=assertion.sub\n```\nGitHub Actions OIDC \u4ee4\u724c\u4e3b\u984c\u7684\u503c [\u53ef\u80fd\u56e0\u4f86\u6e90\u4e8b\u4ef6\u800c\u7570](https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#example-subject-claims) \u3002\u5176\u4ed6\u8072\u660e\u5c6c\u6027\u53ef\u80fd\u5305\u62ec\uff1a- `repository` \uff1a\u5305\u542b\u6240\u6709\u8005\u548c\u4ee3\u78bc\u5eab\u540d\u7a31\uff0c\u4f8b\u5982 `\"google/guava\"` \u3002\n- `repository_id` \uff1a\u5305\u542b\u552f\u4e00\u4ee3\u78bc\u5eab ID\uff0c\u4f8b\u5982 `\"20300177\"` \u3002\n- `repository_owner` \uff1a\u5305\u542b\u6240\u6709\u8005\uff0c\u53ef\u4ee5\u662f\u7528\u6236\u540d\u6216 GitHub \u7d44\u7e54\u7684\u540d\u7a31\uff0c\u4f8b\u5982 `\"google\"` \u3002\n- `repository_owner_id` \uff1a\u5305\u542b\u552f\u4e00\u6240\u6709\u8005 ID\uff0c\u4f8b\u5982 `\"1342004\"` \u3002\n\u4e0a\u8ff0\u5217\u8868\u662f\u90e8\u5206\u53ef\u80fd\u7684\u8072\u660e\uff1b\u5982\u9700\u67e5\u770b\u5b8c\u6574\u5217\u8868\uff0c\u8acb\u53c3\u95b1 GitHub \u6587\u6a94\u4e2d\u6709\u95dc [\u793a\u4f8b\u8072\u660e](https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#understanding-the-oidc-token) \u7684\u90e8\u5206\u3002\u8acb\u52d9\u5fc5\u6620\u5c04\u60a8\u8a08\u5283\u7528\u4f5c\u5c6c\u6027\u689d\u4ef6\u6216\u7528\u4f5c\u672a\u4f86 `principalSet` \u689d\u4ef6\u4e00\u90e8\u5206\u7684\u6240\u6709\u8072\u660e\u3002\n **\u91cd\u8981\u63d0\u793a\uff1a** \u4f7f\u7528 `repository` \u548c `repository_owner` \u7b49\u201c\u540d\u7a31\u201d\u5b57\u6bb5\u6703\u589e\u52a0 [\u7db2\u7d61\u6436\u6ce8](https://en.wikipedia.org/wiki/Cybersquatting) \u548c [\u8aa4\u690d\u57df\u540d](https://en.wikipedia.org/wiki/Typosquatting) \u653b\u64ca\u7684\u53ef\u80fd\u6027\u3002\u5982\u679c\u60a8\u522a\u9664 GitHub \u4ee3\u78bc\u5eab\u6216 GitHub \u7d44\u7e54\uff0c\u5247\u67d0\u4eba\u53ef\u80fd\u53ef\u4ee5\u8072\u660e\u540c\u4e00\u540d\u7a31 \u4e26\u5efa\u7acb\u8eab\u4efd\u3002\u7232\u4e86\u9632\u6b62\u9019\u7a2e\u60c5\u6cc1\uff0c\u8acb\u6539\u7528\u6578\u5b57 `*_id` \u5b57\u6bb5\uff0c\u8a72\u5b57\u6bb5\u662f\u552f\u4e00\u7684\u4e14\u4e0d\u80fd\u91cd\u8907\u4f7f\u7528\u3002\n\u60a8\u7684\u5c6c\u6027\u6620\u5c04\u53ef\u4ee5\u4f7f\u7528 [\u5d4c\u5165\u5728 GitLab ID \u4ee4\u724c\u4e2d\u7684\u8072\u660e](https://docs.gitlab.com/ee/ci/secrets/id_token_authentication.html#token-payload) \u4f5c\u7232\u4f86\u6e90\u5c6c\u6027\uff0c\u5176\u4e2d\u5305\u62ec\uff1a- `sub`\uff1a\u9805\u76ee\u540d\u7a31\u548c Git \u5f15\u7528\uff0c\u4f8b\u5982`project_path:groupname/projectname:ref_type:branch:ref:main`\u3002\n- `namespace_id`\uff1a\u552f\u4e00\u7fa3\u7d44 ID\u3002\n- `project_id`\uff1a\u552f\u4e00\u9805\u76ee ID\u3002\n- `user_id`\uff1a\u552f\u4e00\u8eab\u4efd\u7528\u6236 ID\u3002\n- `environment`\uff1a\u4f5c\u696d\u9069\u7528\u7684\u74b0\u5883\u3002\n- `ref_path`\uff1aGit \u5f15\u7528\uff0c\u4f8b\u5982`refs/heads/main`\u3002\n\u4ee5\u4e0b\u5c6c\u6027\u6620\u5c04\u6703\u5c07 GitLab ID \u4ee4\u724c\u4e2d\u7684 `google.subject` \u8a2d\u7f6e\u7232 `sub` \u8072\u660e\u3002\u7531\u65bc `sub` \u8072\u660e\u540c\u6642\u5305\u542b\u9805\u76ee\u540d\u7a31\u548c Git \u5f15\u7528\uff0c\u56e0\u6b64\u8a72\u6620\u5c04\u53ef\u8b93\u60a8\u6309\u4ee3\u78bc\u5eab\u548c\u5206\u652f\u63a7\u5236\u8a2a\u554f\u6b0a\u9650\uff1a\n```\ngoogle.subject=assertion.sub\n```\n\u5982\u679c\u67d0\u4e9b\u5206\u652f\uff08\u4f8b\u5982 `main` \uff09\u9700\u8981\u8207\u5176\u4ed6\u5206\u652f\u4e0d\u540c\u7684\u8cc7\u6e90\u8a2a\u554f\u6b0a\u9650\uff08\u4f8b\u5982\u529f\u80fd\u5206\u652f\uff09\uff0c\u5247\u6309\u4ee3\u78bc\u5eab\u548c\u5206\u652f\u63a7\u5236\u8a2a\u554f\u6b0a\u9650\u975e\u5e38\u6709\u7528\u3002\n\u5728\u67d0\u4e9b\u60c5\u6cc1\u4e0b\uff0c\u50c5\u6309\u9805\u76ee\u6216\u7fa3\u7d44\u5340\u5206\u8a2a\u554f\u6b0a\u9650\u53ef\u80fd\u5c31\u8db3\u5920\u4e86\u3002\u56e0\u6b64\uff0c\u4ee5\u4e0b\u6620\u5c04\u5305\u542b\u53e6\u5916\u5169\u500b\u5305\u542b GitLab `project_id` \u548c `namespace_id` \u7684\u5c6c\u6027\uff1a\n```\ngoogle.subject=assertion.sub\nattribute.project_id=assertion.project_id\nattribute.namespace_id=assertion.namespace_id\n```\n\u60a8\u7684\u7279\u6027\u6620\u5c04\u53ef\u4ee5\u4f7f\u7528\u5728 Terraform Cloud OIDC \u4ee4\u724c\u4e2d\u5d4c\u5165\u7684\u8072\u660e\uff0c\u5305\u62ec\u4ee5\u4e0b\u5167\u5bb9\uff1a- `terraform_organization_id`\uff1a\u5305\u542b\u7d44\u7e54\u7684\u552f\u4e00 ID\uff0c\u4f8b\u5982`org-xxxxxxxxxxxxxxxx`\u3002\n- `terraform_workspace_id`\uff1a\u5305\u542b [\u5de5\u4f5c\u5340\u7684\u552f\u4e00 ID](https://developer.hashicorp.com/terraform/cloud-docs/workspaces/settings#id) \uff0c\u4f8b\u5982`ws-xxxxxxxxxxxxxxxx`\u3002\n- `terraform_workspace_name`\uff1a\u5305\u542b [\u5de5\u4f5c\u5340\u7684\u986f\u793a\u540d\u7a31](https://developer.hashicorp.com/terraform/cloud-docs/workspaces/settings#name) \u3002\n- `sub`\uff1a\u5305\u542b\u7d44\u7e54\u3001\u5de5\u4f5c\u5340\u548c\u968e\u6bb5\u7684\u986f\u793a\u540d\u7a31\uff0c\u4f8b\u5982`organization:example-org:workspace:example-workspace:run_phase:apply`\u3002\n\u4ee5\u4e0b\u7279\u6027\u6620\u5c04\u6703\u5c07 Terraform Cloud OIDC \u4ee4\u724c\u4e2d\u7684 `google.subject` \u8a2d\u7f6e\u7232 `terraform_workspace_id` \u8072\u660e\uff1a\n```\ngoogle.subject=assertion.terraform_workspace_id\n```\n\u901a\u904e\u6b64\u6620\u5c04\uff0c\u60a8\u53ef\u4ee5\u6309\u5de5\u4f5c\u5340\u63a7\u5236\u5c0d Google Cloud \u8cc7\u6e90\u7684\u8a2a\u554f\u6b0a\u9650\u3002\n### \u5b9a\u7fa9\u5c6c\u6027\u689d\u4ef6\n[\u5c6c\u6027\u689d\u4ef6](https://cloud.google.com/iam/docs/workload-identity-federation?hl=zh-cn#conditions) \u662f\u53ef\u4ee5\u6aa2\u67e5\u65b7\u8a00\u5c6c\u6027\u548c\u76ee\u6a19\u5c6c\u6027\u7684 CEL \u8868\u9054\u5f0f\u3002\u5982\u679c\u7d66\u5b9a\u6191\u64da\u7684\u5c6c\u6027\u689d\u4ef6\u8a55\u4f30\u7d50\u679c\u7232 `true` \uff0c\u5247\u7cfb\u7d71\u6703\u63a5\u53d7\u6191\u64da\u3002\u5426\u5247\uff0c\u6191\u64da\u6703\u88ab\u62d2\u7d55\u3002 \u60a8\u5fc5\u9808\u5c0d\u6240\u6709\u5c6c\u6027\u689d\u4ef6\u5b57\u6bb5\u4f7f\u7528\u5c6c\u6027\u6620\u5c04\u3002\n**\u8b66\u544a\uff1a** GitHub\u3001GitLab SaaS \u548c Terraform Cloud \u5728\u6240\u6709\u7d44\u7e54\u4e2d\u4f7f\u7528\u55ae\u500b\u9812\u767c\u8005\u7db2\u5740\uff0c\u4e26\u4e14 OIDC \u4ee4\u724c\u4e2d\u5d4c\u5165\u7684\u67d0\u4e9b\u8072\u660e\u5c0d\u65bc\u60a8\u7684\u7d44\u7e54\u53ef\u80fd\u4e0d\u662f\u552f\u4e00\u7684\u3002\u53ef\u5e6b\u52a9\u9632\u7bc4 [\u4eff\u5192\u5a01\u8105](https://cloud.google.com/iam/docs/best-practices-for-using-workload-identity-federation?hl=zh-cn#protecting_against_spoofing_threats) \uff0c\u60a8\u5fc5\u9808\u4f7f\u7528\u5c6c\u6027\u689d\u4ef6\u4f86\u9650\u5236\u5c0d GitHub \u7d44\u7e54\u3001GitLab \u7fa3\u7d44\u6216 Terraform Cloud \u7d44\u7e54\u9812\u767c\u7684\u4ee4\u724c\u7684\u8a2a\u554f\u6b0a\u9650\u3002\n\u4f7f\u7528\u4ee5\u4e0b\u5c6c\u6027\u689d\u4ef6\u4f86\u9650\u5236\u5c0d GitHub \u7d44\u7e54\u9812\u767c\u7684\u4ee4\u724c\u7684\u8a2a\u554f\u6b0a\u9650\uff1a\n```\nassertion.repository_owner=='ORGANIZATION'\n```\n\u5c07 `` \u66ff\u63db\u7232\u60a8\u7684 GitHub \u7d44\u7e54\u540d\u7a31\u3002\n\uff08\u53ef\u9078\uff09\u64f4\u5c55\u7279\u6027\u689d\u4ef6\uff0c\u4ee5\u9650\u5236\u5c0d\u90e8\u5206\u5de5\u4f5c\u6d41\u6216\u5206\u652f\u7684\u8a2a\u554f\u6b0a\u9650\u3002\u4f8b\u5982\uff0c\u4ee5\u4e0b\u689d\u4ef6\u9650\u5236\u4e86\u5c0d\u4f7f\u7528 Git \u5206\u652f `main` \u7684\u5de5\u4f5c\u6d41\u7684\u8a2a\u554f\u6b0a\u9650\uff1a\n```\nassertion.repository_owner=='ORGANIZATION' && assertion.ref=='refs/heads/main'\n```\n\u4f7f\u7528\u4ee5\u4e0b\u5c6c\u6027\u689d\u4ef6\u4f86\u9650\u5236\u5c0d GitLab [\u7fa3\u7d44](https://docs.gitlab.com/ee/user/namespace/) \u9812\u767c\u7684\u4ee4\u724c\u7684\u8a2a\u554f\u6b0a\u9650\n```\nassertion.namespace_id=='GROUP_ID'\n```\n\u5c07 `` \u66ff\u63db\u7232 GitLab \u7fa3\u7d44\u9996\u9801\u4e0a\u986f\u793a\u7684\u7fa3\u7d44 ID\u3002\n\uff08\u53ef\u9078\uff09\u64f4\u5c55\u5c6c\u6027\u689d\u4ef6\uff0c\u4ee5\u9650\u5236\u5c0d\u90e8\u5206\u9805\u76ee\u3001\u5206\u652f\u6216\u74b0\u5883\u7684\u8a2a\u554f\u6b0a\u9650\u3002\u4f8b\u5982\uff0c\u4ee5\u4e0b\u689d\u4ef6\u9650\u5236\u5c0d\u4f7f\u7528\u74b0\u5883 `production` \u7684\u4f5c\u696d\u7684\u8a2a\u554f\u6b0a\u9650\uff1a\n```\nassertion.namespace_id=='GROUP_ID' && assertion.environment=='production'\n```\n\u4f7f\u7528\u4ee5\u4e0b\u5c6c\u6027\u689d\u4ef6\u4f86\u9650\u5236\u5c0d Terraform Cloud \u7d44\u7e54\u9812\u767c\u7684\u4ee4\u724c\u7684\u8a2a\u554f\u6b0a\u9650\uff1a\n```\nassertion.terraform_organization_id=='ORGANIZATION_ID'\n```\n\u5c07 `` \u66ff\u63db\u7232\u60a8\u7684\u7d44\u7e54\u7684\u552f\u4e00 ID\uff0c\u4f8b\u5982 `org-xxxxxxxxxxxxxxxx` \u3002\uff08\u53ef\u9078\uff09\u64f4\u5c55\u7279\u6027\u689d\u4ef6\uff0c\u4ee5\u9650\u5236\u5c0d\u90e8\u5206\u5de5\u4f5c\u6d41\u6216\u5206\u652f\u7684\u8a2a\u554f\u6b0a\u9650\u3002\u4f8b\u5982\uff0c\u4ee5\u4e0b\u5c6c\u6027\u689d\u4ef6\u9650\u5236\u5c0d\u7279\u5b9a\u5de5\u4f5c\u5340\u7684\u8a2a\u554f\u6b0a\u9650\uff1a\n```\nassertion.terraform_organization_id=='ORGANIZATION_ID' && terraform_workspace_id=='WORKSPACE_ID'\n```\n### \u5275\u5efa\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u548c\u63d0\u4f9b\u65b9\n\u73fe\u5728\uff0c\u60a8\u5df2\u7d93\u6536\u96c6\u4e86\u5275\u5efa\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u548c\u63d0\u4f9b\u5546\u6240\u9700\u7684\u5168\u90e8\u4fe1\u606f\uff1a\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u524d\u5f80 **\u65b0\u5efa\u5de5\u4f5c\u8ca0\u8f09\u63d0\u4f9b\u65b9\u548c\u6c60** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u65b0\u5efa\u5de5\u4f5c\u8ca0\u8f09\u63d0\u4f9b\u5546\u548c\u6c60\u201d](https://console.cloud.google.com/iam-admin/workload-identity-pools/create?hl=zh-cn) \n- \u5728 **\u5275\u5efa\u8eab\u4efd\u6c60** \u4e0b\uff0c\u8f38\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a- **\u540d\u7a31** \uff1a\u6c60\u7684\u540d\u7a31\u3002\u8a72\u540d\u7a31\u9084\u7528\u4f5c\u6c60 ID\u3002\u6c60 ID \u5275\u5efa\u5f8c\u4fbf\u7121\u6cd5\u66f4\u6539\u3002\n- **\u8aaa\u660e** \uff1a\u63cf\u8ff0\u6c60\u7528\u9014\u7684\u6587\u672c\u3002\n- \u9ede\u64ca **\u7e7c\u7e8c** \u3002\n- \u914d\u7f6e\u63d0\u4f9b\u65b9\u8a2d\u7f6e\uff1a\n- **\u9078\u64c7\u63d0\u4f9b\u65b9** \uff1a **OpenID Connect (OIDC)** \u3002\n- **\u63d0\u4f9b\u65b9\u540d\u7a31** \uff1a\u63d0\u4f9b\u65b9\u7684\u540d\u7a31\u3002\u8a72\u540d\u7a31\u9084\u7528\u4f5c\u63d0\u4f9b\u65b9 ID\u3002\u63d0\u4f9b\u5546 ID \u5275\u5efa\u5f8c\u4fbf\u7121\u6cd5\u66f4\u6539\u3002\n- **\u9812\u767c\u8005\u7db2\u5740** \uff1a`https://token.actions.githubusercontent.com/`\n- **\u53d7\u8846\u7fa3\u9ad4** \uff1a **\u9ed8\u8a8d\u53d7\u8846\u7fa3\u9ad4** \n- **\u9078\u64c7\u63d0\u4f9b\u65b9** \uff1a **OpenID Connect (OIDC)** \u3002\n- **\u63d0\u4f9b\u65b9\u540d\u7a31** \uff1a\u63d0\u4f9b\u65b9\u7684\u540d\u7a31\u3002\u8a72\u540d\u7a31\u9084\u7528\u4f5c\u63d0\u4f9b\u65b9 ID\u3002\u63d0\u4f9b\u5546 ID \u5275\u5efa\u5f8c\u4fbf\u7121\u6cd5\u66f4\u6539\u3002\n- **\u9812\u767c\u8005\u7db2\u5740** \uff1a`https://gitlab.com`\n- **\u53d7\u8846\u7fa3\u9ad4** \uff1a **\u9ed8\u8a8d\u53d7\u8846\u7fa3\u9ad4** \n- **\u9078\u64c7\u63d0\u4f9b\u65b9** \uff1a **OpenID Connect (OIDC)** \u3002\n- **\u63d0\u4f9b\u65b9\u540d\u7a31** \uff1a\u63d0\u4f9b\u65b9\u7684\u540d\u7a31\u3002\u8a72\u540d\u7a31\u9084\u7528\u4f5c\u63d0\u4f9b\u65b9 ID\u3002\u63d0\u4f9b\u5546 ID \u5275\u5efa\u5f8c\u4fbf\u7121\u6cd5\u66f4\u6539\u3002\n- **\u9812\u767c\u8005\u7db2\u5740** \uff1a`https://app.terraform.io`\n- **\u53d7\u8846\u7fa3\u9ad4** \uff1a **\u9ed8\u8a8d\u53d7\u8846\u7fa3\u9ad4** - \u9ede\u64ca **\u7e7c\u7e8c** \u3002\n- \u5728 **\u914d\u7f6e\u63d0\u4f9b\u5546\u7279\u6027** \u4e0b\uff0c\u6dfb\u52a0 [\u60a8\u4e4b\u524d\u8b58\u5225\u7684\u7279\u6027\u6620\u5c04](#mappings-and-conditions) \u3002\n- \u5728 **\u5c6c\u6027\u689d\u4ef6** \u4e0b\uff0c\u8f38\u5165 [\u60a8\u4e4b\u524d\u78ba\u5b9a\u7684\u5c6c\u6027\u689d\u4ef6](#mappings-and-conditions) \u3002\n- \u9ede\u64ca **\u4fdd\u5b58** \u4ee5\u5275\u5efa\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u548c\u63d0\u4f9b\u65b9\u3002\n- \u5275\u5efa\u65b0\u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\uff1a```\ngcloud iam workload-identity-pools create POOL_ID \\\n --location=\"global\" \\\n --description=\"DESCRIPTION\" \\\n --display-name=\"DISPLAY_NAME\"\n```\u66ff\u63db\u4ee5\u4e0b\u503c\uff1a- ``\uff1a\u6c60\u7684\u552f\u4e00 ID\u3002\n- ``\uff1a\u6c60\u7684\u540d\u7a31\u3002\n- ``\uff1a\u6c60\u7684\u8aaa\u660e\u3002\u6388\u4e88\u5c0d\u6c60\u8eab\u4efd\u7684\u8a2a\u554f\u6b0a\u9650\u6642\uff0c\u7cfb\u7d71\u6703\u986f\u793a\u6b64\u8aaa\u660e\u3002\n- \u6dfb\u52a0\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u63d0\u4f9b\u5546\uff1a\n```\ngcloud iam workload-identity-pools providers create-oidc PROVIDER_ID \\\n --location=\"global\" \\\n --workload-identity-pool=\"POOL_ID\" \\\n --issuer-uri=\"https://token.actions.githubusercontent.com/\" \\\n --attribute-mapping=\"MAPPINGS\" \\\n --attribute-condition=\"CONDITIONS\"\n```\n\u66ff\u63db\u4ee5\u4e0b\u503c\uff1a- ``\uff1a\u63d0\u4f9b\u65b9\u7684\u552f\u4e00 ID\n- ``\uff1a\u6c60\u7684 ID\n- ``\uff1a [\u60a8\u4e4b\u524d\u8b58\u5225\u7684\u5c6c\u6027\u6620\u5c04](#mappings-and-conditions) \u7684\u9017\u865f\u5206\u9694\u5217\u8868\n- ``\uff1a [\u60a8\u4e4b\u524d\u78ba\u5b9a\u7684\u5c6c\u6027\u689d\u4ef6](#mappings-and-conditions) \n```\ngcloud iam workload-identity-pools providers create-oidc PROVIDER_ID \\\n --location=\"global\" \\\n --workload-identity-pool=\"POOL_ID\" \\\n --issuer-uri=\"https://gitlab.com\" \\\n --attribute-mapping=\"MAPPINGS\" \\\n --attribute-condition=\"CONDITIONS\"\n```\n\u66ff\u63db\u4ee5\u4e0b\u503c\uff1a- ``\uff1a\u63d0\u4f9b\u65b9\u7684\u552f\u4e00 ID\u3002\n- ``\uff1a\u6c60\u7684 ID\u3002\n- ``\uff1a [\u60a8\u4e4b\u524d\u8b58\u5225\u7684\u7279\u6027\u6620\u5c04](#mappings-and-conditions) \u7684\u9017\u865f\u5206\u9694\u5217\u8868\u3002\n- ``\uff1a [\u60a8\u4e4b\u524d\u78ba\u5b9a\u7684\u5c6c\u6027\u689d\u4ef6](#mappings-and-conditions) \u3002 \u5982\u679c\u60a8\u6c92\u6709\u7279\u6027\u689d\u4ef6\uff0c\u8acb\u79fb\u9664\u8a72\u53c3\u6578\u3002\n```\ngcloud iam workload-identity-pools providers create-oidc PROVIDER_ID \\\n --location=\"global\" \\\n --workload-identity-pool=\"POOL_ID\" \\\n --issuer-uri=\"https://app.terraform.io\" \\\n --attribute-mapping=\"MAPPINGS\" \\\n --attribute-condition=\"CONDITIONS\"\n```\n\u66ff\u63db\u4ee5\u4e0b\u503c\uff1a- ``\uff1a\u63d0\u4f9b\u65b9\u7684\u552f\u4e00 ID\u3002\n- ``\uff1a\u6c60\u7684 ID\u3002\n- ``\uff1a [\u60a8\u4e4b\u524d\u8b58\u5225\u7684\u7279\u6027\u6620\u5c04](#mappings-and-conditions) \u7684\u9017\u865f\u5206\u9694\u5217\u8868\u3002\n- ``\uff1a [\u60a8\u4e4b\u524d\u78ba\u5b9a\u7684\u7279\u6027\u689d\u4ef6](#mappings-and-conditions) \u3002\u5982\u679c\u60a8\u6c92\u6709\u7279\u6027\u689d\u4ef6\uff0c\u8acb\u79fb\u9664\u8a72\u53c3\u6578\u3002\n**\u6ce8\u610f** \uff1a\u524d\u7db4 `gcp-` \u5df2\u88ab\u4fdd\u7559\uff0c\u4e0d\u80fd\u5728\u6c60\u6216\u63d0\u4f9b\u5546 ID \u4e2d\u4f7f\u7528\u3002\n## \u5c0d\u90e8\u7f72\u6d41\u6c34\u7dda\u9032\u884c\u8eab\u4efd\u9a57\u8b49\n\u60a8\u5fc5\u9808\u7232\u6bcf\u500b GitHub Actions \u5de5\u4f5c\u6d41\u6216 Terraform Cloud \u5de5\u4f5c\u5340\u57f7\u884c\u9019\u4e9b\u6b65\u9a5f\u3002\n### \u7232\u90e8\u7f72\u6d41\u6c34\u7dda\u5275\u5efa\u670d\u52d9\u8cec\u865f\n-   Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them  \u5553\u7528 IAM, Security Token Service, and Service Account Credentials API\u3002 [\u5553\u7528 API](https://console.cloud.google.com/flows/enableapi?apiid=iam.googleapis.com%2Csts.googleapis.com%2Ciamcredentials.googleapis.com&%3Bredirect=https%3A%2F%2Fconsole.cloud.google.com&hl=zh-cn) \n- [\u5275\u5efa\u4e00\u500b\u670d\u52d9\u8cec\u865f](https://cloud.google.com/iam/docs/creating-managing-service-accounts?hl=zh-cn#creating) \u4ee5\u4ee3\u8868\u5de5\u4f5c\u8ca0\u8f09\u3002\u6211\u5011\u5efa\u8b70\u60a8 [\u7232\u6bcf\u500b\u90e8\u7f72\u6d41\u6c34\u7dda\u4f7f\u7528\u5c08\u7528\u670d\u52d9\u8cec\u865f](https://cloud.google.com/iam/docs/best-practices-for-using-service-accounts-in-deployment-pipelines?hl=zh-cn#use-dedicated-service-account) \u3002\u8a72\u670d\u52d9\u8cec\u865f\u4e0d\u9700\u8981\u8207\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u4f4d\u65bc\u540c\u4e00\u9805\u76ee\u4e2d\u3002\n- [\u5411\u670d\u52d9\u8cec\u865f\u6388\u4e88\u5c0d\u60a8\u5e0c\u671b\u5916\u90e8\u8eab\u4efd\u8a2a\u554f\u7684\u8cc7\u6e90\u7684\u8a2a\u554f\u6b0a\u9650](https://cloud.google.com/iam/docs/granting-changing-revoking-access?hl=zh-cn) \u3002\n### \u5141\u8a31\u90e8\u7f72\u6d41\u6c34\u7dda\u6a21\u64ec\u670d\u52d9\u8cec\u865f\n\u5982\u9700\u5141\u8a31\u5916\u90e8\u8eab\u4efd\u6a21\u64ec\u670d\u52d9\u8cec\u865f\uff0c\u8acb\u5411\u5176\u6388\u4e88\u670d\u52d9\u8cec\u865f\u7684 Workload Identity User \u89d2\u8272 ( `roles/iam.workloadIdentityUser` )\u3002\u60a8\u53ef\u4ee5\u5411\u7279\u5b9a\u5916\u90e8\u8eab\u4efd\u6216\u591a\u500b\u5916\u90e8\u8eab\u4efd\u6388\u4e88\u8a72\u89d2\u8272\uff1a\n- \u5c0d\u65bc\u7279\u5b9a\u7684\u5916\u90e8\u8eab\u4efd\uff0c\u8acb\u7de8\u5beb\u4e00\u500b\u6aa2\u67e5`google.subject`\u7279\u6027\u7684\u7279\u6027\u689d\u4ef6\u3002\n- \u5c0d\u65bc\u4e00\u7d44\u5916\u90e8\u8eab\u4efd\uff0c\u7de8\u5beb\u4e00\u500b\u6aa2\u67e5`google.groups`\u7279\u6027\u6216\u81ea\u5b9a\u7fa9\u5c6c\u6027`attribute.` ``\u7684\u7279\u6027\u689d\u4ef6\u3002\n**\u6ce8\u610f** \uff1a\u60a8\u53ea\u80fd\u6aa2\u67e5\u60a8\u5728 [\u7279\u6027\u6620\u5c04](#mappings-and-conditions) \u4e2d\u914d\u7f6e\u7684\u7279\u6027\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u63d0\u4f9b\u7a0b\u5e8f\u7684\u914d\u7f6e\u3002\n\u5982\u9700\u4f7f\u7528 Google Cloud \u63a7\u5236\u6aaf\u5141\u8a31\u5916\u90e8\u8eab\u4efd\u6a21\u64ec\u670d\u52d9\u8cec\u865f\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u8f49\u5230 **Workload Identity \u6c60** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u201d](https://console.cloud.google.com/iam-admin/workload-identity-pools?hl=zh-cn) \n- \u627e\u5230\u60a8\u8981\u66f4\u65b0\u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u4e26\u9078\u64c7\u5b83\u3002\n- \u5982\u9700\u6388\u4e88\u5c0d\u6240\u9078\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u7684\u8a2a\u554f\u6b0a\u9650\uff0c\u8acb\u9ede\u64ca add_box **\u6388\u4e88\u8a2a\u554f\u6b0a\u9650** \u3002\n- \u5728 **\u670d\u52d9\u8cec\u865f** \u5217\u8868\u4e2d\uff0c\u9078\u64c7\u60a8\u8981\u6a21\u64ec\u7684\u5916\u90e8\u8eab\u4efd\u7684\u670d\u52d9\u8cec\u865f\u3002\n- \u5982\u9700\u9078\u64c7\u6c60\u4e2d\u7684\u54ea\u4e9b\u8eab\u4efd\u53ef\u4ee5\u6a21\u64ec\u670d\u52d9\u8cec\u865f\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u67d0\u9805\u64cd\u4f5c\uff1a- \u5982\u9700\u50c5\u5141\u8a31\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u7684\u7279\u5b9a\u8eab\u4efd\u4f86\u6a21\u64ec\u670d\u52d9\u8cec\u865f\uff0c\u8acb\u9078\u64c7 **\u50c5\u9650\u8207\u904e\u6ffe\u689d\u4ef6\u5339\u914d\u7684\u8eab\u4efd** \u3002\u5728 **\u7279\u6027\u540d\u7a31** \u5217\u8868\u4e2d\uff0c\u9078\u64c7\u904e\u6ffe\u6839\u64da\u7684\u7279\u6027\u3002\u5728 **\u7279\u6027\u503c** \u5b57\u6bb5\u4e2d\uff0c\u8f38\u5165\u7279\u6027\u7684\u9810\u671f\u503c\uff1b\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u4f7f\u7528 [\u7279\u6027\u6620\u5c04](#mappings-and-conditions) `google.subject=assertion.sub` \uff0c\u8acb\u5c07 **\u7279\u6027** \u540d\u7a31\u8a2d\u7f6e\u7232 `subject` \uff0c\u4e26\u5c07 **\u7279\u6027\u503c** \u8a2d\u7f6e\u7232\u5916\u90e8\u8eab\u4efd\u63d0\u4f9b\u65b9\u9812\u767c\u7684\u4ee4\u724c\u4e2d `sub` \u8072\u660e\u7684\u503c\u3002\n- \u5982\u9700\u4fdd\u5b58\u914d\u7f6e\uff0c\u8acb\u9ede\u64ca **\u4fdd\u5b58** \uff0c\u7136\u5f8c\u9ede\u64ca **\u95dc\u9589** \u3002\n\u5982\u9700\u4f7f\u7528 gcloud CLI \u5141\u8a31\u5916\u90e8\u8eab\u4efd\u6a21\u64ec\u670d\u52d9\u8cec\u865f\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u5982\u9700\u7372\u53d6\u7576\u524d\u9805\u76ee\u7684\u7de8\u865f\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud projects describe $(gcloud config get-value core/project) --format=value\\(projectNumber\\)\n```\n- \u5982\u9700\u5411\u7b26\u5408\u7279\u5b9a\u689d\u4ef6\u7684\u5916\u90e8\u8eab\u4efd\u6388\u4e88 Workload Identity User \u89d2\u8272 ( `roles/iam.workloadIdentityUser` )\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ngcloud iam service-accounts add-iam-policy-binding SERVICE_ACCOUNT_EMAIL \\\n --role=roles/iam.workloadIdentityUser \\\n --member=\"principal://iam.googleapis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/subject/SUBJECT\"\n```\n```\ngcloud iam service-accounts add-iam-policy-binding SERVICE_ACCOUNT_EMAIL \\\n --role=roles/iam.workloadIdentityUser \\\n --member=\"principalSet://iam.googleapis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/group/GROUP\"\n```\n```\ngcloud iam service-accounts add-iam-policy-binding SERVICE_ACCOUNT_EMAIL \\\n --role=roles/iam.workloadIdentityUser \\\n --member=\"principalSet://iam.googleapis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/attribute.ATTRIBUTE_NAME/ATTRIBUTE_VALUE\"\n```\n\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u670d\u52d9\u8cec\u865f\u7684\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\n- ``\uff1a\u5305\u542b\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u7684\u9805\u76ee\u7684 [\u7de8\u865f](https://cloud.google.com/resource-manager/docs/creating-managing-projects?hl=zh-cn) \n- ``\uff1a\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u7684\u6c60 ID\n- ``\uff1a [\u5df2\u6620\u5c04](#mappings-and-conditions) \u5230`google.subject`\u7684\u7279\u6027\u7684\u9810\u671f\u503c\n- ``\uff1a [\u5df2\u6620\u5c04](#mappings-and-conditions) \u5230`google.groups`\u7684\u7279\u6027\u7684\u9810\u671f\u503c\n- ``\uff1a [\u7279\u6027\u6620\u5c04](#mappings-and-conditions) \u4e2d\u7684\u81ea\u5b9a\u7fa9\u7279\u6027\u7684\u540d\u7a31\n **\u6ce8\u610f** \uff1a\u60a8\u5fc5\u9808\u5728\u6210\u54e1\u6a19\u8b58\u7b26\u4e2d\u4f7f\u7528\u9805\u76ee\u7de8\u865f\u3002\u7cfb\u7d71\u4e0d\u652f\u6301\u4f7f\u7528\u9805\u76ee ID\u3002\n### \u914d\u7f6e\u90e8\u7f72\u6d41\u6c34\u7dda\n\u60a8\u73fe\u5728\u53ef\u4ee5\u5728\u90e8\u7f72\u6d41\u6c34\u7dda\u4e2d\u4f7f\u7528\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u4e86\u3002\n\u85c9\u52a9 [google-github-actions/auth](https://github.com/google-github-actions/auth) \u64cd\u4f5c\uff0c\u60a8\u53ef\u4ee5\u5728\u5de5\u4f5c\u6d41\u57f7\u884c\u671f\u9593\u81ea\u52d5\u751f\u6210\u6191\u64da\u914d\u7f6e\u6587\u4ef6\u3002\u7136\u5f8c\uff0c\u5ba2\u6236\u7aef\u5eab\u548c\u5de5\u5177\uff08\u4f8b\u5982 `terraform` \uff09\u53ef\u4ee5\u4f7f\u7528\u6b64\u6191\u64da\u914d\u7f6e\u6587\u4ef6\u81ea\u52d5\u7372\u53d6 Google \u6191\u64da\u3002\n\u4fee\u6539 GitHub Actions YAML \u6587\u4ef6\u4e26\u6dfb\u52a0\u4ee5\u4e0b\u5167\u5bb9\uff1a- \u901a\u904e\u6dfb\u52a0\u4ee5\u4e0b\u914d\u7f6e\uff0c\u5141\u8a31\u4f5c\u696d\u63d0\u53d6 GitHub ID \u4ee4\u724c\uff1a```\npermissions:\n id-token: write\n contents: read\n```\n- \u6dfb\u52a0\u6b65\u9a5f\u4ee5\u5275\u5efa\u6191\u64da\u914d\u7f6e\u6587\u4ef6\uff1a```\n- id: 'auth'\n name: 'Authenticate to Google Cloud'\n uses: 'google-github-actions/auth@v1'\n with:\n create_credentials_file: true\n workload_identity_provider: 'projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/providers/PROVIDER_ID'\n service_account: 'SERVICE_ACCOUNT_EMAIL'\n```\n\u66ff\u63db\u4ee5\u4e0b\u503c\uff1a- ``\uff1a\u5305\u542b\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u7684\u9805\u76ee\u7684\u7de8\u865f\n- ``\uff1a\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u7684 ID\n- ``\uff1a\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u63d0\u4f9b\u65b9\u7684 ID\n- ``\uff1a\u670d\u52d9\u8cec\u865f\u7684\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\n\u793a\u4f8b\uff1a\n```\njobs:\n build:\n # Allow the job to fetch a GitHub ID token\n permissions:\n  id-token: write\n  contents: read\n runs-on: ubuntu-latest\n steps:\n  - uses: actions/checkout@v3\n  - id: 'auth'\n  name: 'Authenticate to Google Cloud'\n  uses: 'google-github-actions/auth@v1'\n  with:\n   create_credentials_file: true\n   workload_identity_provider: 'projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/providers/PROVIDER_ID'\n   service_account: 'SERVICE_ACCOUNT_EMAIL'\n```\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u4f7f\u7528 `google-github-actions/auth` \u64cd\u4f5c\uff0c\u8acb\u53c3\u95b1 [\u8a2d\u7f6e\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408](https://github.com/google-github-actions/auth#setup) \u3002\n\u4fee\u6539 `.gitlab-ci.yml` \u6587\u4ef6\u4e26\u5c07\u4ee5\u4e0b\u5167\u5bb9\u6dfb\u52a0\u5230\u4f5c\u696d\u914d\u7f6e\u4e2d\uff1a\n```\njob:\n variables:\n WORKLOAD_IDENTITY_PROJECT_NUMBER: PROJECT_NUMBER\n WORKLOAD_IDENTITY_POOL: POOL_ID\n WORKLOAD_IDENTITY_PROVIDER: PROVIDER_ID\n SERVICE_ACCOUNT: SERVICE_ACCOUNT_EMAIL\n GOOGLE_APPLICATION_CREDENTIALS: $CI_BUILDS_DIR/.workload_identity.wlconfig\n id_tokens:\n WORKLOAD_IDENTITY_TOKEN:\n  aud: https://iam.googleapis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/providers/PROVIDER_ID\n script:\n - |  echo $WORKLOAD_IDENTITY_TOKEN > $CI_BUILDS_DIR/.workload_identity.jwt\n  cat << EOF > $GOOGLE_APPLICATION_CREDENTIALS\n  {\n  \"type\": \"external_account\",\n  \"audience\": \"//iam.googleapis.com/projects/$WORKLOAD_IDENTITY_PROJECT_NUMBER/locations/global/workloadIdentityPools/$WORKLOAD_IDENTITY_POOL/providers/$WORKLOAD_IDENTITY_PROVIDER\",\n  \"subject_token_type\": \"urn:ietf:params:oauth:token-type:jwt\",\n  \"token_url\": \"https://sts.googleapis.com/v1/token\",\n  \"credential_source\": {\n   \"file\": \"$CI_BUILDS_DIR/.workload_identity.jwt\"\n  },\n  \"service_account_impersonation_url\": \"https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/$SERVICE_ACCOUNT:generateAccessToken\"\n  }\n  EOF\n```\n\u66ff\u63db\u4ee5\u4e0b\u503c\uff1a- ``\uff1a\u5305\u542b\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u7684\u9805\u76ee\u7684\u7de8\u865f\n- ``\uff1a\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u7684 ID\n- ``\uff1a\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u63d0\u4f9b\u65b9\u7684 ID\n- ``\uff1a\u670d\u52d9\u8cec\u865f\u7684\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\n\u914d\u7f6e\u6703\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u6307\u793a GitLab \u9812\u767c ID \u4ee4\u724c\uff0c\u4e26\u5728\u540d\u7232`WORKLOAD_IDENTITY_TOKEN`\u7684\u74b0\u5883\u8b8a\u91cf\u4e2d\u63d0\u4f9b\u8a72\u4ee4\u724c\u3002ID \u4ee4\u724c\u4f7f\u7528\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u63d0\u4f9b\u65b9\u4f5c\u7232\u53d7\u8846\u7fa3\u9ad4\u3002\n- \u5c07 ID \u4ee4\u724c\u4fdd\u5b58\u5230\u540d\u7232`.workload_identity.jwt`\u7684\u81e8\u6642\u6587\u4ef6\u4e2d\u3002\n- \u5275\u5efa\u6191\u64da\u914d\u7f6e\u6587\u4ef6\uff0c\u7528\u65bc\u6307\u793a\u5ba2\u6236\u7aef\u5eab\u5f9e`.workload_identity.jwt`\u8b80\u53d6 ID \u4ee4\u724c\u4e26\u4f7f\u7528\u5b83\u4f86\u6a21\u64ec\u670d\u52d9\u8cec\u865f\u3002\n- \u8a2d\u7f6e\u74b0\u5883\u8b8a\u91cf`GOOGLE_APPLICATION_CREDENTIALS`\u4ee5\u6307\u5411\u6191\u64da\u914d\u7f6e\u6587\u4ef6\u3002\n\u914d\u7f6e Terraform Cloud \u5de5\u4f5c\u5340\uff0c\u4ee5\u4fbf\u5b83\u4f7f\u7528\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u5411 Google Cloud \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff1a- \u5728 Terraform Cloud \u4e2d\uff0c\u6253\u958b\u5de5\u4f5c\u5340\uff0c\u7136\u5f8c\u8f49\u81f3 **\u8b8a\u91cf** \u3002\n- \u6dfb\u52a0\u4ee5\u4e0b\u8b8a\u91cf\uff1a| \u8b8a\u91cf\u985e\u5225 | \u9375        | \u503c                   |\n|:-----------|:----------------------------------|:------------------------------------------------------------------------------|\n| \u74b0\u5883\u8b8a\u91cf | TFC_GCP_PROVIDER_AUTH    | true                   |\n| \u74b0\u5883\u8b8a\u91cf | TFC_GCP_RUN_SERVICE_ACCOUNT_EMAIL | \u670d\u52d9\u8cec\u865f\u7684\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\uff0c\u4f8b\u5982 terraform@my-project-123.iam.gserviceaccount.com |\n| \u74b0\u5883\u8b8a\u91cf | TFC_GCP_PROJECT_NUMBER   | \u5305\u542b\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u7684\u9805\u76ee\u7684\u7de8\u865f            |\n| \u74b0\u5883\u8b8a\u91cf | TFC_GCP_WORKLOAD_POOL_ID   | \u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u7684 ID               |\n| \u74b0\u5883\u8b8a\u91cf | TFC_GCP_WORKLOAD_PROVIDER_ID  | \u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u63d0\u4f9b\u65b9\u7684 ID              |\uff08\u53ef\u9078\uff09\u60a8\u53ef\u4ee5\u6dfb\u52a0\u5176\u4ed6\u74b0\u5883\u8b8a\u91cf\uff0c\u8b93 Terrform Cloud \u7232 `plan` \u548c `apply` \u968e\u6bb5\u4f7f\u7528\u4e0d\u540c\u7684\u670d\u52d9\u8cec\u865f\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u53ef\u9078\u74b0\u5883\u8b8a\u91cf](https://developer.hashicorp.com/terraform/cloud-docs/workspaces/dynamic-provider-credentials/gcp-configuration#optional-environment-variables) \u3002\n- \u5728\u8b8a\u91cf\u5217\u8868\u4e2d\uff0c\u9a57\u8b49\u60a8\u5728\u4e0a\u4e00\u6b65\u4e2d\u6dfb\u52a0\u7684\u4e94\u500b\u8b8a\u91cf\u7684 **\u985e\u5225** \u662f\u5426\u8a2d\u7f6e\u7232 `env` \u3002\n- \u9a57\u8b49 Terraform \u914d\u7f6e\u662f\u5426\u4f7f\u7528 `4.48.0` \u6216\u66f4\u9ad8\u7248\u672c\u7684 Google Cloud \u63d0\u4f9b\u7a0b\u5e8f\uff0c\u4e26\u6839\u64da\u9700\u8981\u9032\u884c\u66f4\u65b0\uff0c\u5982\u4e0b\u6240\u793a\uff1a```\nterraform {\n required_providers {\n google = {\n  source = \"hashicorp/google\"\n  version = \"~> 4.48.0\"\n }\n }\n}\n```\n- \u5c07\u66f4\u6539\u63d0\u4ea4\u5230\u6e90\u4ee3\u78bc\u5eab\u3002## \u5f8c\u7e8c\u6b65\u9a5f\n- \u8a73\u7d30\u77ad\u89e3 [\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408](https://cloud.google.com/iam/docs/workload-identity-federation?hl=zh-cn) \u3002\n- \u77ad\u89e3 [\u5728\u90e8\u7f72\u6d41\u6c34\u7dda\u4e2d\u4f7f\u7528\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u7684\u6700\u4f73\u505a\u6cd5](https://cloud.google.com/iam/docs/best-practices-for-using-service-accounts-in-deployment-pipelines?hl=zh-cn) \u3002\n- \u77ad\u89e3\u5982\u4f55 [\u7ba1\u7406\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u548c\u63d0\u4f9b\u5546](https://cloud.google.com/iam/docs/manage-workload-identity-pools-providers?hl=zh-cn) \u3002", "guide": "IAM"}