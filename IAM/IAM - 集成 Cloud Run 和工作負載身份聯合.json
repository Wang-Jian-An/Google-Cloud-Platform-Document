{"title": "IAM - \u96c6\u6210 Cloud Run \u548c\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408", "url": "https://cloud.google.com/iam/docs/tutorial-cloud-run-workload-id-federation?hl=zh-cn", "abstract": "# IAM - \u96c6\u6210 Cloud Run \u548c\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\n\u672c\u6559\u7a0b\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u5c0d Google Cloud \u5916\u90e8\u904b\u884c\u7684\u5de5\u4f5c\u8ca0\u8f09\u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u4ee5\u4fbf\u5176\u53ef\u4ee5\u8a2a\u554f\u7531 Cloud Run \u8a17\u7ba1\u7684\u5fae\u670d\u52d9\u3002\u672c\u6559\u7a0b\u9069\u7528\u65bc\u5e0c\u671b\u5c07\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u8207\u73fe\u6709\u8eab\u4efd\u63d0\u4f9b\u65b9 (IdP) \u96c6\u6210\u7684\u7ba1\u7406\u54e1\u3002\u85c9\u52a9 [\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408](https://cloud.google.com/iam/docs/workload-identity-federation?hl=zh-cn) \uff0c\u60a8\u53ef\u4ee5\u5c07\u5916\u90e8\u5de5\u4f5c\u8ca0\u8f09\u9023\u63a5\u5230 Google Cloud \u4e2d\u904b\u884c\u7684\u5de5\u4f5c\u8ca0\u8f09\u3002 [Cloud Run](https://cloud.google.com/run?hl=zh-cn) \u53ef\u8b93\u60a8\u904b\u884c\u7121\u72c0\u614b\u5bb9\u5668\u5316\u5fae\u670d\u52d9\u3002\n\u672c\u6559\u7a0b\u4ecb\u7d39\u5982\u4f55\u5c07 Jenkins \u914d\u7f6e\u7232\u5916\u90e8\u5de5\u4f5c\u8ca0\u8f09\uff0c\u5c07 Keycloak \u914d\u7f6e\u7232 IdP\u3001Cloud Run \u548c\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\u5b8c\u6210\u672c\u6559\u7a0b\u5f8c\uff0c\u60a8\u53ef\u4ee5\u77ad\u89e3\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u5982\u4f55\u4f7f\u7528 [OpenID Connect](https://openid.net/connect/) \u8eab\u4efd\u9a57\u8b49\u5411 Google Cloud \u9a57\u8b49\u60a8\u7684 Jenkins \u61c9\u7528\u3002\n **\u6ce8\u610f** \uff1a\u672c\u6559\u7a0b\u65e8\u5728\u6f14\u793a\u4e00\u500b\u6982\u5ff5\u3002\u4e0d\u5efa\u8b70\u5c07\u672c\u6559\u7a0b\u4e2d\u7684\u67d0\u4e9b\u6b65\u9a5f\u7528\u65bc\u751f\u7522\u74b0\u5883\u3002\u9019\u4e9b\u6b65\u9a5f\u5e36\u6709\u8aaa\u660e\uff0c\u4e26\u63d0\u4f9b\u4e86\u5efa\u8b70\u3002", "content": "## \u4f7f\u7528\u670d\u52d9\u8cec\u865f\u5bc6\u9470\u9032\u884c\u5916\u90e8\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u9a57\u8b49\u5982\u679c\u60a8\u7684\u5de5\u4f5c\u8ca0\u8f09\u5728 Google Cloud \u4e4b\u5916\u904b\u884c\uff0c\u5247\u5fc5\u9808\u5c0d\u8a72\u5de5\u4f5c\u8ca0\u8f09\u9032\u884c\u5b89\u5168\u8eab\u4efd\u9a57\u8b49\uff0c\u4ee5\u4fbf\u5b83\u53ef\u4ee5\u8207 Cloud Run \u8a17\u7ba1\u7684\u5fae\u670d\u52d9\u9032\u884c\u4ea4\u4e92\u3002\u50b3\u7d71\u4e0a\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 [Cloud \u5ba2\u6236\u7aef\u5eab](https://cloud.google.com/apis/docs/cloud-client-libraries?hl=zh-cn) \u7b49\u5de5\u5177\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u548c\u50b3\u905e\u670d\u52d9\u8cec\u865f\u5bc6\u9470\uff0c\u4ee5\u5c0d\u5916\u90e8\u5de5\u4f5c\u8ca0\u8f09\u57f7\u884c\u8eab\u4efd\u9a57\u8b49\u3002Cloud \u5ba2\u6236\u7aef\u5eab\u4f7f\u7528\u540d\u7232\u61c9\u7528\u9ed8\u8a8d\u6191\u64da (ADC) \u7684\u5eab\u4f86\u81ea\u52d5\u67e5\u627e\u60a8\u7684\u670d\u52d9\u8cec\u865f\u6191\u64da\u3002 \u6b64\u5eab\u8a2d\u7f6e\u540d\u7232 [GOOGLE_APPLICATION_CREDENTIALS](https://cloud.google.com/docs/authentication/application-default-credentials?hl=zh-cn) \u7684\u74b0\u5883\u8b8a\u91cf\u3002ADC \u4f7f\u7528\u8a72\u8b8a\u91cf\u6307\u5411\u7684\u670d\u52d9\u8cec\u865f\u5bc6\u9470\u6216\u914d\u7f6e\u6587\u4ef6\uff0c\u4ee5\u81ea\u52d5\u5c0d\u60a8\u7684\u8cec\u865f\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\n\u4f46\u662f\uff0c\u6b64\u65b9\u6cd5\u5177\u6709\u4ee5\u4e0b\u5b89\u5168\u98a8\u96aa\uff1a- \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u670d\u52d9\u8cec\u865f\u5bc6\u9470\u4e0d\u5305\u542b\u5931\u6548\u65e5\u671f\u3002\u5982\u679c\u4ee3\u78bc\u88ab\u6cc4\u9732\uff0c\u60a8\u9700\u8981\u516c\u958b\u9644\u52a0\u5230\u8a72\u5bc6\u9470\u7684\u6bcf\u9805\u6b0a\u9650\u3002\n- \u7531\u65bc\u670d\u52d9\u8cec\u865f\u5bc6\u9470\u662f\u975c\u614b\u7684\uff0c\u56e0\u6b64\u60a8\u5fc5\u9808\u69cb\u5efa\u4e00\u9805\u7b56\u7565\u4f86\u7ba1\u7406\u548c\u8f2a\u66ff\u9019\u4e9b\u5bc6\u9470\u3002\n\u96d6\u7136 [\u5275\u5efa\u670d\u52d9\u8cec\u865f\u5bc6\u9470](https://cloud.google.com/iam/docs/creating-managing-service-account-keys?hl=zh-cn) \u662f\u4e00\u500b\u76f8\u7576\u7c21\u55ae\u7684\u904e\u7a0b\uff0c\u4f46\u7232\u4e86\u7c21\u55ae\u8d77\u898b\uff0c\u60a8\u53ef\u4ee5\u72a7\u7272\u5b89\u5168\u6027\u3002## \u4f7f\u7528\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u9032\u884c\u5916\u90e8\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u9a57\u8b49\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u89e3\u6c7a\u4e86\u5275\u5efa\u548c\u4e0b\u8f09\u975c\u614b\u670d\u52d9\u8cec\u865f\u5bc6\u9470\u7522\u751f\u7684\u5b89\u5168\u98a8\u96aa\u3002\u85c9\u52a9\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u60a8\u7121\u9700\u4f7f\u7528\u975c\u614b\u670d\u52d9\u8cec\u865f\u5bc6\u9470\u5373\u53ef\u5c0d Google Cloud \u5916\u90e8\u7684\u5de5\u4f5c\u8ca0\u8f09\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u4efb\u4f55\u9700\u8981\u5728 Google Cloud \u4e2d\u4f7f\u7528\u670d\u52d9\u7684\u5916\u90e8\u5de5\u4f5c\u8ca0\u8f09\u90fd\u53ef\u4ee5\u53d7\u76ca\u65bc\u6b64\u529f\u80fd\u3002\n\u85c9\u52a9\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 IdP \u76f4\u63a5\u9032\u884c Google Cloud \u8eab\u4efd\u9a57\u8b49\u3002\u8981\u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u4f7f\u7528 [OpenID Connect](https://en.wikipedia.org/wiki/OpenID#OpenID_Connect_(OIDC)) \u3002Cloud Run \u63a5\u53d7\u4f86\u81ea IdP \u7684 OpenID Connect \u4ee4\u724c\u4ee5\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\n\u4f7f\u7528\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u6642\u7684\u8eab\u4efd\u9a57\u8b49\u904e\u7a0b\u5982\u4e0b\u6240\u793a\uff1a- \u60a8\u7684\u8eab\u4efd\u9a57\u8b49 (AUTHN) \u5eab\u6703\u5411 IdP \u767c\u9001 JSON Web \u4ee4\u724c (JWT) \u8acb\u6c42\u3002\n- IdP \u6703\u7232 JSON Web \u4ee4\u724c (JWT) \u7c3d\u540d\u3002AUTHN \u5eab\u5f9e\u8b8a\u91cf\u4e2d\u8b80\u53d6\u6b64\u6578\u64da\u3002\n- \u8a72\u5eab\u6703\u5411\u5305\u542b\u7c3d\u540d\u4ee4\u724c\u7684 [Security Token Service](https://cloud.google.com/iam/docs/reference/sts/rest?hl=zh-cn) \u767c\u9001 POST \u547d\u4ee4\u3002\n- Security Token Service \u6703\u67e5\u770b\u60a8\u914d\u7f6e\u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u63d0\u4f9b\u65b9\u4ee5\u5efa\u7acb\u4fe1\u4efb\u4e26\u9a57\u8b49\u6191\u64da\u4e0a\u7684\u8eab\u4efd\u3002\n- Security Token Service \u6703\u767c\u56de\u806f\u5408\u4ee4\u724c\u3002\n- \u5eab\u6703\u5c07\u4ee4\u724c\u767c\u9001\u5230 IAM\u3002\n- IAM \u5c07\u4ee4\u724c\u4ea4\u63db\u7232\u670d\u52d9\u8cec\u865f\u7684 OpenID Connect \u4ee4\u724c\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u751f\u6210 OpenID Connect ID \u4ee4\u724c](https://cloud.google.com/iam/docs/create-short-lived-credentials-direct?hl=zh-cn#sa-credentials-oidc) \u3002\n- \u8a72\u5eab\u7232 Jenkins \u63d0\u4f9b OpenID Connect \u4ee4\u724c\u3002\n- Jenkins \u4f7f\u7528\u6b64\u4ee4\u724c\u5411 Cloud Run \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\n\u4e0b\u5716\u5c55\u793a\u4e86\u8eab\u4efd\u9a57\u8b49\u6d41\u7a0b\uff1a## \u76ee\u6a19\n- \u5c07 Jenkins \u914d\u7f6e\u7232\u5916\u90e8\u5de5\u4f5c\u8ca0\u8f09\u3002\n- \u5c07 [Keycloak](https://www.keycloak.org/) \u914d\u7f6e\u7232\u8207 OpenID Connect \u517c\u5bb9\u7684 IdP\u3002\n- \u5c07 Jenkins \u8207 Keycloak \u9023\u63a5\u8d77\u4f86\u3002\n- \u5b89\u88dd Cloud \u5ba2\u6236\u7aef\u5eab\u4ee5\u7372\u53d6\u5f9e Keycloak \u5230 Google Cloud \u7684 JWT \u4ee4\u724c\u3002\n- \u5c07 Google Cloud \u9023\u63a5\u5230 Keycloak \u548c Jenkins\u3002\n- \u5f9e Keycloak \u7372\u53d6\u7d93\u904e\u8eab\u4efd\u9a57\u8b49\u7684\u7528\u6236\u7684 JWT\u3002\n\u96d6\u7136\u672c\u6559\u7a0b\u4f7f\u7528 Keycloak\uff0c\u4f46\u60a8\u53ef\u4ee5\u4f7f\u7528\u652f\u6301 OpenID Connect \u7684\u4efb\u4f55\u8eab\u4efd\u63d0\u4f9b\u65b9\uff0c\u4f8b\u5982 GitLab\u3001Okta \u6216 OneLogin\u3002## \u8cbb\u7528\nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728\u672c\u6587\u6a94\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Google Cloud \u7684\u4ee5\u4e0b\u6536\u8cbb\u7d44\u4ef6\uff1a- [Cloud Run](https://cloud.google.com/run/pricing?hl=zh-cn) \n\u60a8\u53ef\u4f7f\u7528 [\u50f9\u683c\u8a08\u7b97\u5668](https://cloud.google.com/products/calculator?hl=zh-cn) \u6839\u64da\u60a8\u7684\u9810\u8a08\u4f7f\u7528\u60c5\u6cc1\u4f86\u4f30\u7b97\u8cbb\u7528\u3002 \nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5b8c\u6210\u672c\u6587\u6a94\u4e2d\u63cf\u8ff0\u7684\u4efb\u52d9\u5f8c\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u522a\u9664\u6240\u5275\u5efa\u7684\u8cc7\u6e90\u4f86\u907f\u514d\u7e7c\u7e8c\u8a08\u8cbb\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u6e05\u7406](#clean-up) \u3002## \u6e96\u5099\u5de5\u4f5c- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- \u5728 Google Cloud Console \u4e2d\uff0c\u8f49\u5230\u9805\u76ee\u9078\u64c7\u5668\u9801\u9762\u3002 [\u8f49\u5230\u201c\u9805\u76ee\u9078\u64c7\u5668\u201d](https://console.cloud.google.com/projectselector2/home/dashboard?hl=zh-cn) \n- \u9078\u64c7\u6216\u5275\u5efa Google Cloud \u9805\u76ee\u3002 **\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u4e0d\u6253\u7b97\u4fdd\u7559\u5728\u6b64\u904e\u7a0b\u4e2d\u5275\u5efa\u7684\u8cc7\u6e90\uff0c\u8acb\u5275\u5efa\u65b0\u7684\u9805\u76ee\uff0c\u800c\u4e0d\u8981\u9078\u64c7\u73fe\u6709\u7684\u9805\u76ee\u3002\u5b8c\u6210\u672c\u6559\u7a0b\u4ecb\u7d39\u7684\u6b65\u9a5f\u5f8c\uff0c\u60a8\u53ef\u4ee5\u522a\u9664\u6240\u5275\u5efa\u7684\u9805\u76ee\uff0c\u4e26\u79fb\u9664\u8207\u8a72\u9805\u76ee\u95dc\u806f\u7684\u6240\u6709\u8cc7\u6e90\u3002\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- [\u78ba\u4fdd\u60a8\u7684 Google Cloud \u9805\u76ee\u5df2\u5553\u7528\u7d50\u7b97\u529f\u80fd](https://cloud.google.com/billing/docs/how-to/verify-billing-enabled?hl=zh-cn#console) \u3002\n- \u5728 Cloud Run \u4e0a\u8a2d\u7f6e\u5fae\u670d\u52d9\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u300a\u5feb\u901f\u5165\u9580\uff1a\u5c07\u5bb9\u5668\u90e8\u7f72\u5230 Cloud Run\u300b](https://cloud.google.com/run/docs/quickstarts/deploy-container?hl=zh-cn) \u3002\n## \u914d\u7f6e Jenkins\u5728\u975e Google Cloud \u74b0\u5883\uff08\u4f8b\u5982\u672c\u5730\u74b0\u5883\u6216\u5176\u4ed6\u96f2\uff09\u4e2d\u5b8c\u6210\u9019\u4e9b\u4efb\u52d9\u3002\n\u5982\u679c\u60a8\u5df2\u6709\u652f\u6301 OpenID Connect \u548c\u5916\u90e8\u5de5\u4f5c\u8ca0\u8f09\u7684\u8eab\u4efd\u63d0\u4f9b\u65b9\uff0c\u5247\u53ef\u4ee5\u8df3\u904e\u6b64\u6b65\u9a5f\u4e26\u8f49\u5230 [\u5b89\u88dd Cloud \u5ba2\u6236\u7aef\u5eab](#client_lib) \u3002\n\u5982\u9700\u6a21\u64ec\u5916\u90e8\u5de5\u4f5c\u8ca0\u8f09\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u5b89\u88dd\u4e86 [Jenkins](https://www.jenkins.io/doc/book/installing/linux/#debianubuntu) \u7684\u865b\u64ec\u6a5f\u3002\u60a8\u53ef\u4ee5\u5c07 Jenkins \u4f5c\u7232 Docker \u6620\u50cf\u904b\u884c\uff0c\u4e5f\u53ef\u4ee5\u5c07\u5176\u76f4\u63a5\u5b89\u88dd\u5230\u60a8\u7684\u670d\u52d9\u5668\u4e0a\u3002\u4ee5\u4e0b\u6b65\u9a5f\u6f14\u793a\u77ad\u5982\u4f55\u76f4\u63a5\u5728\u670d\u52d9\u5668\u4e0a\u5b89\u88dd\u5b83\u3002- \u5728\u60a8\u9078\u64c7\u7684\u865b\u64ec\u6a5f\u4e0a\uff0c\u6253\u958b\u547d\u4ee4\u884c\u3002\n- \u5b89\u88dd Java\uff1a```\n$ sudo apt update$ sudo apt install openjdk-11-jre$ java -version\n```\n- \u5b89\u88dd Jenkins\uff1a```\ncurl -fsSL https://pkg.jenkins.io/debian-stable/jenkins.io.key | sudo tee \\/usr/share/keyrings/jenkins-keyring.asc > /dev/nullecho deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc] \\https://pkg.jenkins.io/debian-stable binary/ | sudo tee \\/etc/apt/sources.list.d/jenkins.list > /dev/nullsudo apt-get updatesudo apt-get install jenkins\n```\n- \u9a57\u8b49\u60a8\u53ef\u4ee5\u901a\u904e\u7aef\u53e3 8080 \u8a2a\u554f Jenkins \u670d\u52d9\u5668\u3002\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f\u4f4d\u65bc\u9632\u706b\u7246\u5f8c\u7684\u865b\u64ec\u6a5f\uff0c\u8acb\u78ba\u4fdd\u76f8\u61c9\u7684\u7aef\u53e3\u5df2\u6253\u958b\u3002\n- \u7372\u53d6\u7ba1\u7406\u54e1\u5bc6\u78bc\u4e26\u8a2d\u7f6e Jenkins\u3002\u5982\u9700\u67e5\u770b\u8aaa\u660e\uff0c\u8acb\u53c3\u95b1 [\u5b89\u88dd\u5f8c\u8a2d\u7f6e\u56ae\u5c0e](https://www.jenkins.io/doc/book/installing/linux/#setup-wizard) \u3002\n- \u5b8c\u6210\u4ee5\u4e0b\u6b65\u9a5f\u4ee5\u8a2d\u7f6e SSL\uff1a- \u5982\u679c\u60a8\u6709\u7db2\u57df\u63d0\u4f9b\u65b9\uff0c\u5247\u53ef\u4ee5\u4f7f\u7528\u5176\u8b49\u66f8\u6388\u6b0a\u6a5f\u69cb (CA) \u8acb\u6c42\u7c64\u540d\u8b49\u66f8\u3002\u6216\u8005\uff0c\u60a8\u4e5f\u53ef\u4ee5\u5f9e [zerossl.com](http://www.zerossl.com) \u7372\u53d6\u6709\u6548\u671f\u7232 90 \u5929\u7684\u514d\u8cbb\u7c3d\u540d\u8b49\u66f8\u3002\n- \u4e0b\u8f09\u8b49\u66f8 zip \u6587\u4ef6\u4e26\u5c07\u5176\u8f49\u79fb\u5230\u904b\u884c Jenkins \u7684\u670d\u52d9\u5668\uff1a```\nscp -i CERTFILE.pem -r CERTFILE.zip VM_FQDN:/home/USERNAME\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- \u5c07``\u66ff\u63db\u7232\u5305\u542b\u516c\u9470\u7684\u8b49\u66f8\u6587\u4ef6\u7684\u540d\u7a31\u3002\n- \u5c07``\u66ff\u63db\u7232 Google Cloud \u5916\u90e8\u7684\u670d\u52d9\u5668\u7684 FQDN\u3002\n- \u5c07``\u66ff\u63db\u7232\u60a8\u7684\u7528\u6236\u540d\u3002\n- \u91cd\u547d\u540d\u9019\u4e9b\u6587\u4ef6\u4e26\u751f\u6210 Jenkins \u53ef\u4ee5\u4f7f\u7528\u7684 .pkcs12 \u6587\u4ef6\uff1a`openssl rsa -in` `` `.com.key -out` `` `.com.key`\u5c07 `` \u66ff\u63db\u7232\u8b49\u66f8\u6587\u4ef6\u7684\u540d\u7a31\u3002\n- \u66f4\u65b0 `/etc/sysconfig/jenkins` \u6587\u4ef6\u3002- \u5728\u6587\u672c\u7de8\u8f2f\u5668\u4e2d\u6253\u958b\u8a72\u6587\u4ef6\uff1a```\nvi /etc/sysconfig/jenkins\n```\n- \u5c07 `JENKINS_PORT` \u8a2d\u7f6e\u7232 `-1` \u3002\n- \u5c07 `JENKINS_HTTPS_PORT` \u8a2d\u7f6e\u7232 `8443` \u3002\n- \u5728\u6587\u4ef6\u7684\u5e95\u90e8\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u53c3\u6578\uff1a`JENKINS_ARGS=\"--httpsCertificate=/var/lib/jenkins/.ssl/` `` `.crt --httpsPrivateKeys=/var/lib/jenkins/.ssl/` `` `.pkcs1.key\"`\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- \u5c07``\u66ff\u63db\u7232\u63a1\u7528 .crt \u683c\u5f0f\u7684\u8b49\u66f8\u6587\u4ef6\u7684\u6587\u4ef6\u540d\u3002\n- \u5c07``\u66ff\u63db\u7232 PKCS \u5bc6\u9470\u7684\u6587\u4ef6\u540d\u3002\n- \u91cd\u5553 Jenkins \u670d\u52d9\u5668\u3002\n- \u9a57\u8b49\u60a8\u662f\u5426\u5728\u9632\u706b\u7246\u4e0a\u6253\u958b\u4e86\u7aef\u53e3 8443\uff0c\u4e26\u901a\u904e\u7aef\u53e3 8443 \u8a2a\u554f Jenkins\u3002\n- \u5b89\u88dd\u5c07 Keycloak \u8207 Jenkins \u96c6\u6210\u6240\u9700\u7684 Jenkins \u63d2\u4ef6\u3002\u60a8\u53ef\u4ee5\u901a\u904e\u4ee5\u4e0b\u4efb\u4e00\u65b9\u6cd5\u9078\u64c7\u4e00\u500b\u76ee\u6a19\uff1a- [OpenID Connect \u8eab\u4efd\u9a57\u8b49](https://plugins.jenkins.io/oic-auth/) \n- [Keyclak \u8eab\u4efd\u9a57\u8b49](https://plugins.jenkins.io/keycloak/) \n\u8981\u5b89\u88dd\u8a72\u63d2\u4ef6\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u5728 Jenkins \u4fe1\u606f\u4e2d\u5fc3\uff0c\u8f49\u5230 **\u7ba1\u7406 Jenkins > \u7ba1\u7406\u63d2\u4ef6** \u3002\n- \u9078\u64c7 **\u53ef\u7528** \uff0c\u7136\u5f8c\u641c\u7d22\u60a8\u9078\u64c7\u7684\u63d2\u4ef6\u3002\u4ee5\u4e0b\u5c4f\u5e55\u622a\u5716\u986f\u793a\u4e86\u5df2\u9078\u64c7 **Available** \u6a19\u7c64\u9801\u7684 Plugin Manager\u3002\n- \u5b89\u88dd\u63d2\u4ef6\u3002## \u914d\u7f6e Keycloak\u5728\u672c\u6559\u7a0b\u4e2d\uff0cKeycloak \u6703\u7ba1\u7406\u7528\u6236\u3001\u7fa3\u7d44\u548c\u89d2\u8272\u3002Keycloak \u4f7f\u7528 [\u5927\u5340](https://www.keycloak.org/docs/latest/server_admin/) \u4f86\u7ba1\u7406\u7528\u6236\u3002\n **\u6ce8\u610f** \uff1a\u672c\u6559\u7a0b\u4f7f\u7528\u540d\u7232 Master \u7684\u9ed8\u8a8d\u5927\u5340\uff0c\u8a72\u5927\u5340\u6703\u5728\u60a8\u5b89\u88dd Keycloak \u670d\u52d9\u5668\u6642\u81ea\u52d5\u5275\u5efa\u3002\u9ed8\u8a8d\u5927\u5340\u53ef\u4ee5\u8a2a\u554f\u60a8\u7cfb\u7d71\u4e2d\u7684\u6240\u6709\u5176\u4ed6\u5927\u5340\u3002\u5728\u751f\u7522\u74b0\u5883\u4e2d\uff0c\u5982\u679c\u60a8\u8981\u90e8\u7f72 Keycloak\uff0c\u6211\u5011\u5efa\u8b70\u60a8\u5275\u5efa\u4e00\u500b\u55ae\u7368\u7684\u5927\u5340\u3002\n- \u5728 Google Cloud \u5916\u90e8\u904b\u884c\u7684\u865b\u64ec\u6a5f\u4e0a\uff0c\u5b89\u88dd Keycloak \u670d\u52d9\u5668\u3002\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5efa\u8b70\u5f9e Docker \u5bb9\u5668 [\u5b89\u88dd Keycloak](https://www.keycloak.org/guides#getting-started) \u3002\n- \u6253\u958b Keycloak \u7ba1\u7406\u63a7\u5236\u6aaf\u3002\n- \u8f49\u5230 **\u5927\u5340\u8a2d\u7f6e** \u3002\n- \u5728 **\u5e38\u898f** \u6a19\u7c64\u9801\u4e2d\uff0c\u9a57\u8b49\u5b57\u6bb5\u662f\u5426\u6309\u5982\u4e0b\u65b9\u5f0f\u8a2d\u7f6e\uff1a- **\u5df2\u5553\u7528** \uff1a **\u958b\u5553** \n- **\u7528\u6236\u7ba1\u7406\u7684\u8a2a\u554f\u6b0a\u9650** \uff1a **\u95dc\u9589** \n- **\u7aef\u9ede** \uff1a **OpenID \u7aef\u9ede\u914d\u7f6e** \u548c **SAML 2.0 \u8eab\u4efd\u63d0\u4f9b\u65b9\u5143\u6578\u64da** \n\u4ee5\u4e0b\u5c4f\u5e55\u622a\u5716\u986f\u793a\u4e86\u60a8\u5fc5\u9808\u914d\u7f6e\u7684\u5b57\u6bb5\u3002\n- \u5275\u5efa\u4e00\u500b\u5ba2\u6236\u7aef\uff0c\u4ee5\u4fbf\u60a8\u6709\u4e00\u500b\u53ef\u4ee5\u8acb\u6c42 Keycloak \u5c0d\u7528\u6236\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u5be6\u9ad4\u3002\u901a\u5e38\uff0c\u5ba2\u6236\u7aef\u662f\u4f7f\u7528 Keycloak \u63d0\u4f9b\u55ae\u9ede\u767b\u9304 (SSO) \u89e3\u6c7a\u65b9\u6848\u7684\u61c9\u7528\u548c\u670d\u52d9\u3002- \u5728 Keycloak \u7ba1\u7406\u63a7\u5236\u6aaf\u4e2d\uff0c\u9ede\u64ca **\u5ba2\u6236\u7aef > \u5275\u5efa** \u3002\n- \u8f38\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a- **\u5ba2\u6236\u7aef ID** \uff1a **jenkins** \n- **\u5ba2\u6236\u7aef\u5354\u8b70** \uff1a **openid-connect** \n- **\u6839\u7db2\u5740** \uff1a **http://JENKINS_IP_ADDRESS:8080** \uff0c\u5176\u4e2d\u662f Jenkins \u670d\u52d9\u5668\u7684 IP \u5730\u5740\u3002\n\u4ee5\u4e0b\u5c4f\u5e55\u622a\u5716\u986f\u793a\u4e86\u60a8\u5fc5\u9808\u914d\u7f6e\u7684\u5b57\u6bb5\u3002\n- \u9ede\u64ca **\u4fdd\u5b58** \u3002\n- \u5728 **\u5b89\u88dd** \u6a19\u7c64\u9801\u4e2d\uff0c\u9a57\u8b49\u4ee4\u724c\u683c\u5f0f\u662f\u5426\u7232 Keycloak OIDC JSON \u3002\u8907\u88fd\u6b64\u4ee4\u724c\uff0c\u56e0\u7232\u60a8\u5c07\u9700\u8981\u5b83\u4f86\u5b8c\u6210 Jenkins \u8a2d\u7f6e\u3002\n- \u8981\u5275\u5efa\u6e2c\u8a66\u7fa3\u7d44\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u5728 Keycloak \u7ba1\u7406\u63a7\u5236\u6aaf\u4e2d\uff0c\u9ede\u64ca **\u7fa3\u7d44 > \u65b0\u5efa** \u3002\n- \u8f38\u5165\u7fa3\u7d44\u540d\u7a31\uff0c\u7136\u5f8c\u9ede\u64ca **\u4fdd\u5b58** \u3002\n- \u518d\u5275\u5efa\u4e00\u500b\u6e2c\u8a66\u7d44\u3002\u60a8\u53ef\u4ee5\u7232\u7fa3\u7d44\u5206\u914d\u89d2\u8272\uff0c\u4f46\u672c\u6559\u7a0b\u4e0d\u9700\u8981\u5b83\u5011\u3002\n- \u5982\u9700\u5275\u5efa\u8981\u6dfb\u52a0\u5230\u7fa3\u7d44\u7684\u6e2c\u8a66\u7528\u6236\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u5728 Keycloak \u7ba1\u7406\u63a7\u5236\u6aaf\u4e2d\uff0c\u9ede\u64ca **\u7ba1\u7406\u7528\u6236 > \u6dfb\u52a0\u7528\u6236** \u3002\n- \u586b\u5beb\u7528\u6236\u4fe1\u606f\uff0c\u7136\u5f8c\u9ede\u64ca **\u4fdd\u5b58** \u3002\u4ee5\u4e0b\u5c4f\u5e55\u622a\u5716\u986f\u793a\u4e86\u7528\u6236\u8cec\u865f\u7684\u793a\u4f8b\u4fe1\u606f\u3002\n- \u9ede\u64ca **\u6191\u64da** \u6a19\u7c64\u9801\uff0c\u4e26\u9a57\u8b49 **\u81e8\u6642** \u662f\u5426\u8a2d\u7f6e\u7232 **\u95dc\u9589** \u3002\n- \u91cd\u7f6e\u5bc6\u78bc\u3002\u7a0d\u5f8c\u60a8\u5c07\u5728 JWT \u4e2d\u4f7f\u7528\u6b64\u8cec\u865f\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u4ee5\u4e0b\u5c4f\u5e55\u622a\u5716\u986f\u793a\u4e86 **\u6191\u64da** \u6a19\u7c64\u9801\uff0c\u5176\u4e2d\u5305\u542b\u60a8\u5fc5\u9808\u914d\u7f6e\u7684\u5b57\u6bb5\u3002\n- \u9ede\u64ca **\u7fa3\u7d44** \u6a19\u7c64\u9801\uff0c\u7136\u5f8c\u9078\u64c7\u60a8\u4e4b\u524d\u5275\u5efa\u7684\u5176\u4e2d\u4e00\u500b\u7fa3\u7d44\u3002\n- \u9ede\u64ca **\u52a0\u5165** \u3002\n- \u91cd\u8907\u57f7\u884c\u6b64\u6b65\u9a5f\uff0c\u5275\u5efa\u66f4\u591a\u6e2c\u8a66\u7528\u6236\u3002## \u7232 OpenID Connect \u914d\u7f6e Jenkins\u672c\u90e8\u5206\u4ecb\u7d39\u5982\u4f55\u7232 Jenkins \u914d\u7f6e OpenID Connect \u63d2\u4ef6\u3002- \u5728 Jenkins \u670d\u52d9\u5668\u4e0a\uff0c\u8f49\u5230 **\u7ba1\u7406 Jenkins > \u914d\u7f6e\u5168\u5c40\u5b89\u5168** \u3002\n- \u5728\u201c\u5b89\u5168\u5927\u5340\u201d\u4e0b\uff0c\u9078\u64c7 **Keycloak \u8eab\u4efd\u9a57\u8b49\u63d2\u4ef6** \u3002\u9ede\u64ca **\u4fdd\u5b58** \u3002\n- \u9ede\u64ca **\u914d\u7f6e\u7cfb\u7d71** \u3002\n- \u5728 **\u5168\u5c40 Keycloak** \u8a2d\u7f6e\u4e0b\uff0c\u8907\u88fd\u60a8\u5728 [\u914d\u7f6e Keycloak](#configure-keycloak) \u4e2d\u5275\u5efa\u7684 Keycloak \u5b89\u88dd JSON\u3002\u5982\u679c\u60a8\u9700\u8981\u518d\u6b21\u7372\u53d6 JSON \u6578\u64da\uff0c\u8acb\u5b8c\u6210\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u5728 Keycloak \u7ba1\u7406\u63a7\u5236\u6aaf\u4e2d\uff0c\u8f49\u5230 **\u5ba2\u6236\u7aef** \u3002\n- \u9ede\u64ca\u60a8\u7684\u5ba2\u6236\u7aef\u540d\u7a31\u3002\n- \u5728 **\u5b89\u88dd** \u6a19\u7c64\u9801\u4e2d\uff0c\u9ede\u64ca **\u683c\u5f0f\u9078\u9805** \uff0c\u7136\u5f8c\u9078\u64c7 **Keyclak OIDC JSON** \u3002\n\u4ee5\u4e0b\u662f Keycloak JSON \u7684\u793a\u4f8b\uff1a```\n{\u00a0 \u00a0 \"realm\":\"master\"\u00a0 \u00a0 \"auth-server-url\":\"AUTHSERVERURL\"\u00a0 \u00a0 \"ssl-required\":\"none\"\u00a0 \u00a0 \"resource\":\"jenkins\"\u00a0 \u00a0 \"public-client\":true\u00a0 \u00a0 \"confidential-port\":0}\n``` \u662f\u60a8\u7684\u8eab\u4efd\u9a57\u8b49\u670d\u52d9\u5668\u7684\u7db2\u5740\u3002\n- \u5982\u9700\u4fdd\u5b58 OIDC \u914d\u7f6e\uff0c\u8acb\u9ede\u64ca **\u4fdd\u5b58** \u3002\nJenkins \u73fe\u5728\u53ef\u4ee5\u91cd\u5b9a\u5411\u5230 Keycloak \u4ee5\u7372\u53d6\u7528\u6236\u4fe1\u606f\u3002## \u5b89\u88dd Cloud \u5ba2\u6236\u7aef\u5eab\u5982\u9700\u5c07 JWT \u5f9e Keycloak \u767c\u9001\u5230 Google Cloud\uff0c\u60a8\u5fc5\u9808\u5728 Jenkins \u670d\u52d9\u5668\u4e0a\u5b89\u88dd Cloud \u5ba2\u6236\u7aef\u5eab\u3002\u672c\u6559\u7a0b\u4f7f\u7528 Python \u901a\u904e SDK \u8207 Google Cloud \u9032\u884c\u4ea4\u4e92\u3002- \u5728 Jenkins \u670d\u52d9\u5668\u4e0a\uff0c\u5b89\u88dd Python\u3002\u4ee5\u4e0b\u6b65\u9a5f\u5c55\u793a\u77ad\u5982\u4f55\u5b89\u88dd python3\uff1a```\nsudo apt updatesudo apt install software-properties-commonsudo add-apt-repository ppa:deadsnakes/ppasudo apt updatesudo apt install python3.8\n```\n- \u5b89\u88dd pip3\uff0c\u4ee5\u4fbf\u4e0b\u8f09\u548c\u5c0e\u5165 [Cloud \u5ba2\u6236\u7aef\u5eab](https://cloud.google.com/apis/docs/cloud-client-libraries?hl=zh-cn) \uff1a```\npip3 \u2013versionsudo apt updatesudo apt install python3-pippip3 \u2013version\n```\n- \u4f7f\u7528 pip3 \u5b89\u88dd [Python \u7248 Cloud \u5ba2\u6236\u7aef\u5eab](https://developers.google.com/docs/api/how-tos/libraries?hl=zh-cn#python) \uff1a```\npip3 install \u2013upgrade google-api-python-client google-auth-httplib2 google-auth-oauthlib\n```\u4f8b\u5982\uff1a```\npip3 install --upgrade google-api-python-client google-auth-httplib2 google-auth-oauthlibCollecting google-api-python-client\u00a0 \u00a0 Downloading google_api_python_client-2.42.0-py2.py3-none-any.whl (8.3 MB)\u00a0 \u00a0 \u00a0 \u00a0 USERNAME | 8.3 MB 19.9 MB/sCollecting google-auth-httplib2\u00a0 \u00a0 Downloading google_auth_httplib2-0.1.0-py2.py3-none-any.whl (9.3 MB)Collecting google-auth-oauthlibDownloading google_auth_oauthlib-0.5.1-py2.py3-non-any.whl (19 KB)\n```\u5c07 \u66ff\u63db\u7232\u60a8\u7684\u7528\u6236\u540d\u3002\n- \u5728 Jenkins \u670d\u52d9\u5668\u4e0a\u5b89\u88dd Google Cloud CLI\u3002\u5982\u9700\u67e5\u770b\u76f8\u95dc\u8aaa\u660e\uff0c\u8acb\u53c3\u95b1 [\u300a\u5feb\u901f\u5165\u9580\uff1a\u5b89\u88dd gcloud CLI\u300b](https://cloud.google.com/sdk/docs/install-sdk?hl=zh-cn#deb) \u3002\n## \u914d\u7f6e Google Cloud \u74b0\u5883\u672c\u90e8\u5206\u4ecb\u7d39\u78ba\u4fdd\u8a17\u7ba1\u7121\u670d\u52d9\u5668\u5bb9\u5668\u7684 Google Cloud \u74b0\u5883\u53ef\u4ee5\u8207 Jenkins \u548c Keycloak \u9023\u63a5\u5fc5\u9808\u5b8c\u6210\u7684\u6b65\u9a5f\u3002- \u5728 Google Cloud \u4e2d\uff0c\u5275\u5efa [\u670d\u52d9\u8cec\u865f](https://cloud.google.com/iam/docs/service-accounts?hl=zh-cn) \uff0c\u4ee5\u4fbf Cloud Run \u4e0a\u7684\u5fae\u670d\u52d9\u53ef\u4ee5\u8a2a\u554f\u8207\u5176\u95dc\u806f\u7684\u6b0a\u9650\u3002\u4f8b\u5982\uff0c\u8981\u4f7f\u7528 [gcloud CLI](https://cloud.google.com/sdk/docs/install-sdk?hl=zh-cn#deb) \u5275\u5efa\u670d\u52d9\u8cec\u865f\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a```\ngcloud iam service-accounts create cloudrun-oidc \\\u00a0 \u2013-description=\"cloud run oidc sa\" \u00a0\\\u00a0 \u2013-display-name=\"cloudrun-oidc\"\n```\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c [Cloud Run \u6703\u7232\u60a8\u5275\u5efa\u4e00\u500b\u9ed8\u8a8d\u670d\u52d9\u8cec\u865f](https://cloud.google.com/run/docs/securing/service-identity?hl=zh-cn#about_the_default_service_account) \u3002\u4f46\u662f\uff0c\u4f7f\u7528\u9ed8\u8a8d\u670d\u52d9\u8cec\u865f\u4e0d\u662f\u5b89\u5168\u65b9\u9762\u7684\u6700\u4f73\u5be6\u8e10\uff0c\u56e0\u7232\u8a72\u8cec\u865f\u5177\u6709\u4e00\u7d44\u5ee3\u6cdb\u7684\u6b0a\u9650\u3002\u56e0\u6b64\uff0c\u6211\u5011\u5efa\u8b70\u60a8\u7232\u5fae\u670d\u52d9\u5275\u5efa\u55ae\u7368\u7684\u670d\u52d9\u8cec\u865f\u3002\u5982\u9700\u77ad\u89e3\u5982\u4f55\u7232 Cloud Run \u5275\u5efa\u670d\u52d9\u8cec\u865f\uff0c\u8acb\u53c3\u95b1 [\u5275\u5efa\u548c\u7ba1\u7406\u670d\u52d9\u8cec\u865f](https://cloud.google.com/iam/docs/creating-managing-service-accounts?hl=zh-cn) \u3002\n- \u5275\u5efa [\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60](https://cloud.google.com/iam/docs/configuring-workload-identity-federation?hl=zh-cn#create_the_workload_identity_pool_and_provider) \u3002\u5982\u9700\u4f7f\u7528 [gcloud CLI](https://cloud.google.com/sdk/docs/install-sdk?hl=zh-cn#deb) \u5275\u5efa\u6c60\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud iam workload-identity-pools create cloudrun-oidc-pool \\\u00a0 --location=\"global\" \\\u00a0 \u2014-description=\"cloudrun-oidc\" \\\u00a0 \u2014-display-name=\"cloudrun-oidc\"\n```\n- \u7232 OpenID Connect \u5275\u5efa\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u63d0\u4f9b\u65b9\uff1a```\ngcloud iam workload-identity-pools providers create-oidc cloud-run-provider \\\u00a0 --workload-identity-pool=\"cloudrun-oidc-pool\" \\\u00a0 --issuer-uri=\"VAR_LINK_TO_ENDPOINT\" \\\u00a0 --location=\"global\" \\\u00a0 --attribute-mapping =\"google.subject=assertion.sub,attribute.isadmin-assertion.isadmin,attribute.aud=assertion.aud\" \\\u00a0 --attribute-condition=\"attribute.isadmin=='true'\"\n```\u5c07 `` \u66ff\u63db\u7232\u5305\u542b\u6307\u5411 Keycloak OIDC \u7aef\u9ede\u93c8\u63a5\u7684\u8b8a\u91cf\u3002\u5982\u9700\u67e5\u627e\u6b64\u93c8\u63a5\uff0c\u8acb\u5728 KeyCloud \u7ba1\u7406\u63a7\u5236\u6aaf\u7684 **\u5927\u5340** \u7a97\u53e3\u4e2d\u9ede\u64ca **\u5e38\u898f** \u6a19\u7c64\u9801\u3002\u7aef\u9ede\u5fc5\u9808\u662f HTTPS\uff0c\u9019\u610f\u5473\u7740\u60a8\u5fc5\u9808\u4f7f\u7528 HTTPS \u914d\u7f6e Keycloak \u670d\u52d9\u5668\u3002\n## \u5f9e Keycloak \u7372\u53d6\u7d93\u904e\u8eab\u4efd\u9a57\u8b49\u7684\u7528\u6236\u7684 JWT\n- \u5728\u904b\u884c Keycloak \u7684\u865b\u64ec\u6a5f\u4e0a\uff0c\u5c07\u4ee4\u724c\u4e0b\u8f09\u5230\u6587\u672c\u6587\u4ef6\u3002\u4f8b\u5982\uff0c\u5728 Linux \u4e0a\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ncurl -L -X POST 'https://IP_FOR_KEYCLOAK:8080/auth/realms/master/protocol/openid-connect/token' -H 'Content-Type: application/x-www-form-urlencoded' \\\u00a0 --data-urlencode 'client_id=jenks' \\\u00a0 --data-urlencode 'grant_type=password' \\\u00a0 --data-urlencode 'client_secret=CLIENT_SECRET \\\u00a0 --data-urlencode 'scope=openid' \\\u00a0 --data-urlencode 'username=USERNAME' \\\u00a0 --data-urlencode 'password=PASSWORD' | grep access_token | cut -c18-1490 > token.txt\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- \u5c07``\u66ff\u63db\u7232 Keycloak \u670d\u52d9\u5668 IP \u5730\u5740\u3002\n- \u5c07``\u66ff\u63db\u7232 Keycloak \u5ba2\u6236\u7aef\u5bc6\u9470\u3002\n- \u5c07``\u66ff\u63db\u7232 Keycloak \u7528\u6236\u3002\n- \u5c07``\u66ff\u63db\u7232 Keycloak \u7528\u6236\u7684\u5bc6\u78bc\u3002\n\u6b64\u547d\u4ee4\u5305\u542b\u5ba2\u6236\u7aef ID\u3001\u5ba2\u6236\u7aef\u5bc6\u9470\u3001\u7528\u6236\u540d\u548c\u5bc6\u78bc\u3002\u7232\u4fdd\u8b49\u5b89\u5168\u6027\uff0c\u6211\u5011\u5efa\u8b70\u60a8\u4f7f\u7528\u74b0\u5883\u8b8a\u91cf\u4f86\u906e\u84cb\u9019\u4e9b\u503c\uff0c\u800c\u4e0d\u662f\u4f7f\u7528\u547d\u4ee4\u884c\u3002\u793a\u4f8b\u547d\u4ee4\u5c07\u6191\u64da\u91cd\u5b9a\u5411\u5230\u540d\u7232 `token.txt` \u7684\u6587\u4ef6\u3002\uff08\u53ef\u9078\uff09\u5982\u9700\u81ea\u52d5\u57f7\u884c\u6b64\u6b65\u9a5f\uff0c\u60a8\u53ef\u4ee5\u5275\u5efa bash \u8173\u672c\u3002\n- \u5728 [jwt.io](https://jwt.io) \u9a57\u8b49\u4ee4\u724c\u3002\n- \u5728\u865b\u64ec\u6a5f\u4e0a\uff0c\u5275\u5efa\u6191\u64da\u6587\u4ef6\uff1a```\ngcloud iam workload-identity-pools create-cred config \\projects/$PROJECT_NUMBER/locations/global/workloadIdentityPools/cloudrun-oidc-pool/providers/cloud-run/provider \\\u00a0 --output-file=sts-creds.json \\\u00a0 --credential-source-file=token.txt\n```\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [gcloud iam workload-identity-pools create-cred-config](https://cloud.google.com/sdk/gcloud/reference/iam/workload-identity-pools/create-cred-config?hl=zh-cn#--credential-source-file) \u3002\u8f38\u51fa\u6587\u4ef6\u61c9\u5982\u4e0b\u6240\u793a\uff1a```\n{\u00a0 \u00a0 \"type\": \"external_account\",\u00a0 \u00a0 \"audience\": \"//iam.google.apis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/cloudrun-oidc-pool/subject/USER_EMAIL\",\u00a0 \u00a0 \"subject_token_type\": \"urn:ietf:params:oauth:token-type:jwt\",\u00a0 \u00a0 \"token_url\": \"https://sts.googleapis.com/v1/token\",\u00a0 \u00a0 \"credential_source\": {\u00a0 \u00a0 \u00a0 \u00a0 \"file\" \"token.txt\" }}\n````` \u662f\u60a8\u7684\u9805\u76ee\u7de8\u865f\u3002\n- \u5728\u865b\u64ec\u6a5f\u4e0a\uff0c\u5c07 `sts.creds.json` \u6587\u4ef6\u8a2d\u7f6e\u7232 ADC \u7684\u8b8a\u91cf\uff1a```\nexport GOOGLE_APPLICATION_CREDENTIALS=/Users/USERNAME/sts-creds.json\n```\u5c07 \u66ff\u63db\u7232\u60a8\u7684 UNIX \u7528\u6236\u540d\u3002\u5728\u5553\u52d5\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u4e4b\u524d\uff0c\u6b64\u503c\u662f\u670d\u52d9\u8cec\u865f\u5bc6\u9470\u3002\u4f7f\u7528\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u6642\uff0c\u6b64\u503c\u662f\u65b0\u5275\u5efa\u7684\u6191\u64da\u6587\u4ef6\u3002\n- \u7232\u7528\u6236\u5275\u5efa\u89d2\u8272\u7d81\u5b9a\uff0c\u4ee5\u6a21\u64ec\u670d\u52d9\u8cec\u865f\uff1a```\ngcloud iam service-accounts add-iam-policy-binding SERVICE_ACCOUNT \\\u00a0 \u00a0 --role roles/iam.workloadIdentityUser \\\u00a0 \u00a0 --member \"principal://iam.googleapis.com/projects/$PROJECT_NUMBER/locations/global/workloadIdentityPools/cloudrun-oidc-pool/subject/USER_EMAIL\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- \u5c07 `` \u66ff\u63db\u7232\u60a8\u5728 [\u914d\u7f6e Google Cloud \u74b0\u5883](#configure-your-google-cloud-environment) \u4e2d\u5275\u5efa\u7684\u670d\u52d9\u8cec\u865f\u7684\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [gcloud iam service-accounts add-iam-policy-binding](https://cloud.google.com/sdk/gcloud/reference/iam/service-accounts/add-iam-policy-binding?hl=zh-cn) \u3002\n- \u5c07 `` \u66ff\u63db\u7232\u60a8\u7684\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\u3002\n- \u5141\u8a31\u670d\u52d9\u8cec\u865f\u8a2a\u554f Cloud Run \u670d\u52d9\uff1a```\ngcloud run services add-iam-policy-binding SERVICE_NAME\u00a0 --member-\"serviceAccount:SERVICE_ACCOUNT\" \\\u00a0 --role=\"roles/run.invoker\"\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- \u5c07 `` \u66ff\u63db\u7232\u5728 Cloud Run \u4e0a\u904b\u884c\u7684\u5fae\u670d\u52d9\u7684\u540d\u7a31\u3002\n- \u5c07 `` \u66ff\u63db\u7232 Cloud Run \u670d\u52d9\u8cec\u865f\u7684\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\u3002\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [gcloud run services add-iam-policy-binding](https://cloud.google.com/sdk/gcloud/reference/run/services/add-iam-policy-binding?hl=zh-cn) \u3002\n- \u751f\u6210 ID \u4ee4\u724c\uff1a```\n#!/usr/bin/pythonfrom google.auth import credentialsfrom google.cloud import \u00a0iam_credentials_v1import google.authimport google.oauth2.credentialsfrom google.auth.transport.requests import AuthorizedSession, Requesturl = \"https://WORKLOAD_FQDN\"aud = \"https://WORKLOAD_FQDN\"service_account = 'SERVICE_ACCOUNT'name = \"projects/-/serviceAccounts/{}\".format(service_account)id_token = client.generate_id_token(name=name,audience=aud, include_email=True)print(id_token.token)creds = google.oauth2.credentials.Credentials(id_token.token)authed_session = AuthorizedSession(creds)r = authed_session.get(url)print(r.status_code)print(r.text)\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- \u5c07 `` \u66ff\u63db\u7232\u5de5\u4f5c\u8ca0\u8f09\u7684 FQDN\u3002\n- \u5c07 `` \u66ff\u63db\u7232 Cloud Run \u670d\u52d9\u8cec\u865f\u7684\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\u3002\n\u60a8\u4f7f\u7528\u7684\u4ee4\u724c\u53ef\u4ee5\u8abf\u7528 Identity and Access Management API\uff0c\u5b83\u5c07\u7232\u60a8\u63d0\u4f9b\u8abf\u7528 Cloud Run \u670d\u52d9\u6240\u9700\u7684\u65b0 JWT\u3002\n\u60a8\u53ef\u4ee5\u4f7f\u7528 Jenkins \u6d41\u6c34\u7dda\u4e2d\u7684\u4ee4\u724c\u8abf\u7528\u60a8\u5728 Cloud Run \u4e2d\u904b\u884c\u7684\u7121\u670d\u52d9\u5668\u5bb9\u5668\u3002\u4f46\u662f\uff0c\u9019\u4e9b\u6b65\u9a5f\u4e0d\u5728\u672c\u6559\u7a0b\u7684\u63a2\u8a0e\u7bc4\u570d\u5167\u3002## \u6e05\u7406\u7232\u907f\u514d\u7cfb\u7d71\u56e0\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528\u7684\u8cc7\u6e90\u5411\u60a8\u7684 Google Cloud \u8cec\u865f\u6536\u53d6\u8cbb\u7528\uff0c\u60a8\u53ef\u4ee5\u522a\u9664\u60a8\u7684\u9805\u76ee\u3002\n### \u522a\u9664\u9805\u76ee- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- **\u8b66\u544a** \uff1a\u522a\u9664\u9805\u76ee\u6703\u7522\u751f\u4ee5\u4e0b\u5f71\u97ff- **\u9805\u76ee\u4e2d\u7684\u6240\u6709\u5167\u5bb9\u90fd\u6703\u88ab\u522a\u9664\u3002** \u5982\u679c\u60a8\u5c07\u73fe\u6709\u9805\u76ee\u7528\u65bc\u672c\u6587\u6a94\u4e2d\u7684\u4efb\u52d9\uff0c\u5247\u522a\u9664\u8a72\u9805\u76ee\u5f8c\uff0c\u9084\u5c07\u522a\u9664\u60a8\u5df2\u5728\u8a72\u9805\u76ee\u4e2d\u5b8c\u6210\u7684\u4efb\u4f55\u5176\u4ed6\u5de5\u4f5c\u3002\n- **\u81ea\u5b9a\u7fa9\u9805\u76ee ID \u4e1f\u5931\u3002** \u5275\u5efa\u6b64\u9805\u76ee\u6642\uff0c\u60a8\u53ef\u80fd\u5275\u5efa\u4e86\u8981\u5728\u5c07\u4f86\u4f7f\u7528\u7684\u81ea\u5b9a\u7fa9\u9805\u76ee ID\u3002\u8981\u4fdd\u7559\u4f7f\u7528\u8a72\u9805\u76ee ID \u7684\u7db2\u5740\uff08\u4f8b\u5982`appspot.com`\u7db2\u5740\uff09\uff0c\u8acb\u522a\u9664\u9805\u76ee\u5167\u7684\u6240\u9078\u8cc7\u6e90\uff0c\u800c\u4e0d\u662f\u522a\u9664\u6574\u500b\u9805\u76ee\u3002\n\u5982\u679c\u60a8\u6253\u7b97\u63a2\u7d22\u591a\u500b\u67b6\u69cb\u3001\u6559\u7a0b\u6216\u5feb\u901f\u5165\u9580\uff0c\u5247\u91cd\u8907\u4f7f\u7528\u9805\u76ee\u53ef\u4ee5\u5e6b\u52a9\u60a8\u907f\u514d\u8d85\u51fa\u9805\u76ee\u914d\u984d\u9650\u5236\u3002\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u9032\u5165 **\u7ba1\u7406\u8cc7\u6e90** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u7ba1\u7406\u8cc7\u6e90\u201d](https://console.cloud.google.com/iam-admin/projects?hl=zh-cn) \n- \u5728\u9805\u76ee\u5217\u8868\u4e2d\uff0c\u9078\u64c7\u8981\u522a\u9664\u7684\u9805\u76ee\uff0c\u7136\u5f8c\u9ede\u64ca **\u522a\u9664** \u3002\n- \u5728\u5c0d\u8a71\u6846\u4e2d\u8f38\u5165\u9805\u76ee ID\uff0c\u7136\u5f8c\u9ede\u64ca **\u95dc\u9589** \u4ee5\u522a\u9664\u9805\u76ee\u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u8a73\u7d30\u77ad\u89e3 [\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408](https://cloud.google.com/iam/docs/configuring-workload-identity-federation?hl=zh-cn) \u3002\n- \u5982\u9700\u67e5\u770b\u66f4\u591a\u53c3\u8003\u67b6\u69cb\u3001\u5716\u8868\u548c\u6700\u4f73\u5be6\u8e10\uff0c\u8acb\u700f\u89bd [\u96f2\u67b6\u69cb\u4e2d\u5fc3](https://cloud.google.com/architecture?hl=zh-cn) \u3002", "guide": "IAM"}