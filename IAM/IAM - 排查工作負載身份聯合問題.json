{"title": "IAM - \u6392\u67e5\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u554f\u984c", "url": "https://cloud.google.com/iam/docs/troubleshooting-workload-identity-federation?hl=zh-cn", "abstract": "# IAM - \u6392\u67e5\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u554f\u984c\n\u672c\u9801\u9762\u4ecb\u7d39\u4e86\u5e38\u898b\u7684 [\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408](https://cloud.google.com/iam/docs/workload-identity-federation?hl=zh-cn) \u932f\u8aa4\u7684\u89e3\u6c7a\u65b9\u6cd5\u3002\n", "content": "## Google Cloud API \u4e0d\u63a5\u53d7\u4f86\u81ea SecurityTokenService \u7684\u6191\u64da\n\u5982\u679c\u60a8\u9047\u5230\u4ee5\u4e0b\u932f\u8aa4\uff0c\u53ef\u80fd\u662f\u56e0\u7232\u60a8\u6b63\u5728\u5617\u8a66\u4f7f\u7528\u4f86\u81ea `SecurityTokenService` \u7684\u6191\u64da\uff08\u800c\u4e0d\u662f\u5148\u5c07\u5176\u4ea4\u63db\u7232\u670d\u52d9\u8cec\u865f\u6191\u64da\uff09\u76f4\u63a5\u8a2a\u554f Google Cloud API\u3002\n```\n{\u00a0 \"error\": {\u00a0 \u00a0 \"code\": 401,\u00a0 \u00a0 \"message\": \"Request had invalid authentication credentials. Expected OAuth 2 access token, login cookie or other valid authentication credential. See https://developers.google.com/identity/sign-in/web/devconsole-project.\",\u00a0 \u00a0 \"status\": \"UNAUTHENTICATED\",\u00a0 }}\n```\n\u5982\u9700\u6d88\u9664\u6b64\u932f\u8aa4\uff0c\u8acb\u901a\u904e\u8abf\u7528 [GenerateAccessToken](https://cloud.google.com/iam/docs/reference/credentials/rest/v1/projects.serviceAccounts/generateAccessToken?hl=zh-cn) \u5c07\u5f9e `SecurityTokenService` \u751f\u6210\u7684\u6191\u64da\u4ea4\u63db\u7232\u670d\u52d9\u8cec\u865f\u4ee4\u724c\u3002 \u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u901a\u904e\u8eab\u4efd\u806f\u5408\u7372\u53d6\u77ed\u671f\u6191\u64da](https://cloud.google.com/iam/docs/using-workload-identity-federation?hl=zh-cn) \u3002\n## \u5c07\u8eab\u4efd\u63d0\u4f9b\u5546\u5217\u5165\u8a31\u53ef\u540d\u55ae\uff0c\u4ee5\u4fbf\u8207\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u642d\u914d\u4f7f\u7528\n\u5982\u679c\u60a8\u5617\u8a66\u5c07\u4e0d\u5141\u8a31\u7684\u8eab\u4efd\u63d0\u4f9b\u5546\u914d\u7f6e\u7232\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u63d0\u4f9b\u5546\uff0c\u5247\u6703\u9047\u5230\u4ee5\u4e0b\u932f\u8aa4\uff1a\n```\nFAILED_PRECONDITION: Precondition check failed.- '@type': type.googleapis.com/google.rpc.PreconditionFailure\u00a0 violations:\u00a0 - description: \"Org Policy violated for value: '{PROVIDER}'.\"\u00a0 \u00a0 subject: orgpolicy:projects/{PROJECT}/locations/global/workloadIdentityPools/{POOL}\u00a0 \u00a0 type: constraints/iam.workloadIdentityPoolProviders\n```\n\u5982\u9700\u89e3\u6c7a\u6b64\u554f\u984c\uff0c\u8acb\u6309\u7167 [\u9650\u5236\u8eab\u4efd\u63d0\u4f9b\u5546\u914d\u7f6e](https://cloud.google.com/iam/docs/manage-workload-identity-pools-providers?hl=zh-cn#restrict) \u4e2d\u7684\u8aaa\u660e\uff0c\u5c07\u8eab\u4efd\u63d0\u4f9b\u5546\u5217\u5165\u8a31\u53ef\u540d\u55ae\uff0c\u4ee5\u4fbf\u8207\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u642d\u914d\u4f7f\u7528\u3002\n## \u9023\u63a5\u5230\u7d66\u5b9a\u6191\u64da\u7684\u9812\u767c\u8005\u6642\u51fa\u932f\n\u5982\u679c\u60a8\u6536\u5230\u4ee5\u4e0b\u932f\u8aa4\uff0c\u53ef\u80fd\u662f\u56e0\u7232 Google Cloud \u7121\u6cd5\u63d0\u53d6 IdP \u7684 OIDC \u5143\u6578\u64da\u6587\u6a94\u6216 JWKS\uff1a\n```\n{\u00a0 \"error\": \"invalid_grant\",\u00a0 \"error_description\":\"Error connecting to the given credential's issuer.\"\u00a0}\n```\n\u6b64\u932f\u8aa4\u901a\u5e38\u662f\u56e0\u7232\u7aef\u9ede\u672a\u914d\u7f6e\u7232\u53ef\u901a\u904e\u516c\u5171\u4e92\u806f\u7db2\u8a2a\u554f\u3002\u5982\u9700\u6d88\u9664\u6b64\u932f\u8aa4\uff0c\u8acb\u6aa2\u67e5 OIDC \u7aef\u9ede\u662f\u5426\u516c\u958b\u53ef\u7528\u4e26\u4e14\u7b26\u5408 OIDC \u898f\u7bc4\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u6e96\u5099\u5916\u90e8\u8eab\u4efd\u63d0\u4f9b\u65b9](https://cloud.google.com/iam/docs/configuring-workload-identity-federation?hl=zh-cn#oidc) \u3002\n\u5982\u679c\u60a8\u4ecd\u7136\u9047\u5230\u932f\u8aa4\uff0c\u8acb\u6aa2\u67e5\u4ee4\u724c\u9812\u767c\u8005\uff08\u4ee4\u724c\u7684 `iss` \u8072\u660e\uff09\u662f\u5426\u6b63\u78ba\u3002", "guide": "IAM"}