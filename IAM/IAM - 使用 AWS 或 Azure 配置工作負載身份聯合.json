{"title": "IAM - \u4f7f\u7528 AWS \u6216 Azure \u914d\u7f6e\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408", "url": "https://cloud.google.com/iam/docs/workload-identity-federation-with-other-clouds?hl=zh-cn", "abstract": "# IAM - \u4f7f\u7528 AWS \u6216 Azure \u914d\u7f6e\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\n\u672c\u6307\u5357\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u4f86\u8b93 AWS \u548c Azure \u5de5\u4f5c\u8ca0\u8f09\u7121\u9700 [\u670d\u52d9\u8cec\u865f\u5bc6\u9470](https://cloud.google.com/iam/docs/service-account-creds?hl=zh-cn#key-types) \u5373\u53ef\u5411 Google Cloud \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\n\u85c9\u52a9\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u5728 AWS EC2 \u548c Azure \u4e0a\u904b\u884c\u7684\u5de5\u4f5c\u8ca0\u8f09\u53ef\u4ee5\u4f7f\u7528\u5176\u7279\u5b9a\u65bc\u74b0\u5883\u7684\u6191\u64da\u4ea4\u63db\u77ed\u671f\u6709\u6548\u7684 Google Cloud Security Token Service \u4ee4\u724c\u3002\n\u7279\u5b9a\u65bc\u74b0\u5883\u7684\u6191\u64da\u5305\u62ec\uff1a\n- AWS EC2 \u5be6\u4f8b\u53ef\u4ee5\u4f7f\u7528\u5be6\u4f8b\u914d\u7f6e\u6587\u4ef6\u4f86\u8acb\u6c42 [\u81e8\u6642\u6191\u64da](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp_request.html) \u3002\n- Azure \u865b\u64ec\u6a5f\u53ef\u4ee5\u4f7f\u7528 [\u4ee3\u7ba1\u5f0f\u8eab\u4efd](https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview) \u4f86\u7372\u53d6 Azure \u8a2a\u554f\u4ee4\u724c\u3002\n\u901a\u904e\u8a2d\u7f6e\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u60a8\u53ef\u4ee5\u8b93\u9019\u4e9b\u5de5\u4f5c\u8ca0\u8f09\u5c07\u7279\u5b9a\u65bc\u74b0\u5883\u7684\u6191\u64da\u4ea4\u63db\u7232\u77ed\u671f\u6709\u6548\u7684 Google Cloud \u6191\u64da\u3002\u5de5\u4f5c\u8ca0\u8f09\u53ef\u4ee5\u4f7f\u7528\u9019\u4e9b\u77ed\u671f\u6709\u6548\u7684\u6191\u64da\u8a2a\u554f Google Cloud API\u3002\n", "content": "## \u6e96\u5099\u5de5\u4f5c\n- \u8a2d\u7f6e\u8eab\u4efd\u9a57\u8b49\u3002  Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them   \u9078\u64c7\u6a19\u7c64\u9801\u4ee5\u77ad\u89e3\u60a8\u6253\u7b97\u5982\u4f55\u4f7f\u7528\u672c\u9801\u9762\u4e0a\u7684\u793a\u4f8b\uff1a\n\u7576\u60a8\u4f7f\u7528 Google Cloud \u63a7\u5236\u6aaf\u8a2a\u554f Google Cloud \u670d\u52d9\u548c API \u6642\uff0c\u7121\u9700\u8a2d\u7f6e\u8eab\u4efd\u9a57\u8b49\u3002\u60a8\u53ef\u4ee5\u5f9e\u4ee5\u4e0b\u4efb\u4e00\u958b\u767c\u74b0\u5883\u4f7f\u7528\u672c\u9801\u9762\u4e0a\u7684 gcloud CLI \u793a\u4f8b\uff1a- **Cloud Shell** \uff1a\u5982\u9700\u4f7f\u7528\u5df2\u8a2d\u7f6e gcloud CLI \u7684\u5728\u7dda\u7d42\u7aef\uff0c\u8acb\u6fc0\u6d3b Cloud Shell\u3002Cloud Shell \u6703\u8a71\u6703\u5728\u9801\u9762\u5e95\u90e8\u5553\u52d5\uff0c\u4e26\u986f\u793a\u547d\u4ee4\u884c\u63d0\u793a\u7b26\u3002\u8a72\u6703\u8a71\u53ef\u80fd\u9700\u8981\u5e7e\u79d2\u9418\u4f86\u5b8c\u6210\u521d\u59cb\u5316\u3002\n- **\u672c\u5730 shell** \uff1a\u5982\u9700\u5728\u672c\u5730\u958b\u767c\u74b0\u5883\u4e2d\u4f7f\u7528 gcloud CLI\uff0c\u8acb [\u5b89\u88dd](https://cloud.google.com/sdk/docs/install?hl=zh-cn) \u4e26 [\u521d\u59cb\u5316](https://cloud.google.com/sdk/docs/initializing?hl=zh-cn) gcloud CLI\u3002\n\u5982\u9700\u5f9e\u672c\u5730\u958b\u767c\u74b0\u5883\u4f7f\u7528\u672c\u9801\u9762\u4e0a\u7684 Python \u793a\u4f8b\uff0c\u8acb\u5b89\u88dd\u4e26\u521d\u59cb\u5316 gcloud CLI\uff0c\u7136\u5f8c\u4f7f\u7528\u7528\u6236\u6191\u64da\u8a2d\u7f6e\u61c9\u7528\u9ed8\u8a8d\u6191\u64da\u3002- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- [\u5b89\u88dd](https://cloud.google.com/sdk/docs/install?hl=zh-cn) Google Cloud CLI\u3002\n- \u5982\u9700 [\u521d\u59cb\u5316](https://cloud.google.com/sdk/docs/initializing?hl=zh-cn) gcloud CLI\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud init\n```\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- \u7232\u60a8\u7684 Google \u8cec\u865f\u5275\u5efa\u672c\u5730\u8eab\u4efd\u9a57\u8b49\u6191\u64da\uff1a```\ngcloud auth application-default login\n```\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 Google Cloud \u8eab\u4efd\u9a57\u8b49\u6587\u6a94\u4e2d\u7684 [\u7232\u672c\u5730\u958b\u767c\u74b0\u5883\u8a2d\u7f6e\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/docs/authentication/provide-credentials-adc?hl=zh-cn#local-dev) \u3002\n## \u6e96\u5099\u5916\u90e8\u8eab\u4efd\u63d0\u4f9b\u65b9\n\u60a8\u53ea\u9700\u7232\u6bcf\u500b Azure AD \u79df\u6236\u6216 AWS \u8cec\u865f\u57f7\u884c\u4e00\u6b21\u9019\u4e9b\u6b65\u9a5f\u3002\n\u60a8\u7121\u9700\u5728 AWS \u8cec\u865f\u4e2d\u66f4\u6539\u4efb\u4f55\u914d\u7f6e\u3002\n\u5c07\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60 [\u914d\u7f6e](#configure) \u7232\u4fe1\u4efb\u60a8\u7684 AWS \u8cec\u865f\u5f8c\uff0c\u60a8\u53ef\u4ee5\u8b93 [AWS \u7528\u6236](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users) \u548c [AWS \u89d2\u8272](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles) \u4f7f\u7528\u6c38\u4e45\u6027\u6216\u81e8\u6642 AWS \u5b89\u5168\u6191\u64da\u4f86\u7372\u53d6\u77ed\u671f\u6709\u6548\u7684 Google Cloud \u6191\u64da\u3002\n\u60a8\u5fc5\u9808\u5728 Azure AD \u79df\u6236\u4e2d\u5275\u5efa\u65b0\u7684 [Azure AD \u61c9\u7528](https://docs.microsoft.com/en-us/azure/active-directory/develop/app-objects-and-service-principals#application-object) \u4e26\u5c0d\u5176\u9032\u884c\u914d\u7f6e\uff0c\u4ee5\u4fbf\u5c07\u5176\u7528\u65bc\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\n\u5c07\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60 [\u914d\u7f6e](#configure) \u7232\u4fe1\u4efb\u61c9\u7528\u5f8c\uff0cAzure \u7528\u6236\u548c\u670d\u52d9\u4e3b\u8cec\u865f\u53ef\u4ee5\u8acb\u6c42\u6b64\u61c9\u7528\u7684\u8a2a\u554f\u4ee4\u724c\uff0c\u4e26\u5c07\u9019\u4e9b\u8a2a\u554f\u4ee4\u724c\u4ea4\u63db\u7232\u77ed\u671f\u6709\u6548\u7684 Google Cloud \u6191\u64da\u3002\n\u5982\u9700\u5275\u5efa\u61c9\u7528\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- [\u5275\u5efa\u4e00\u500b Azure AD \u61c9\u7528\u548c\u670d\u52d9\u4e3b\u8cec\u865f](https://docs.microsoft.com/en-au/azure/active-directory/develop/howto-create-service-principal-portal#register-an-application-with-azure-ad-and-create-a-service-principal) \u3002\n- \u8a2d\u7f6e\u61c9\u7528\u7684 **\u61c9\u7528 ID URI** \u3002 \u60a8\u53ef\u4ee5\u4f7f\u7528\u9ed8\u8a8d\u61c9\u7528 ID URI ( `api://` `` ) \u6216\u6307\u5b9a\u81ea\u5b9a\u7fa9 URI\u3002\u7a0d\u5f8c\u914d\u7f6e\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u63d0\u4f9b\u65b9\u6642\uff0c\u60a8\u9700\u8981\u61c9\u7528 ID URI\u3002\n\u5982\u9700\u8b93\u61c9\u7528\u7372\u53d6 Azure AD \u61c9\u7528\u7684\u8a2a\u554f\u4ee4\u724c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 [\u4ee3\u7ba1\u5f0f\u8eab\u4efd](https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview) \uff1a- [\u5275\u5efa\u4ee3\u7ba1\u5f0f\u8eab\u4efd](https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/how-to-manage-ua-identity-portal) \u3002\u8a18\u4e0b\u8a17\u7ba1\u8eab\u4efd\u7684\u5c0d\u8c61 ID\u3002\u7a0d\u5f8c\u60a8\u5728\u914d\u7f6e\u6a21\u64ec\u6642\u9700\u8981\u7528\u5230\u5b83\u3002\n- [\u5c07\u4ee3\u7ba1\u5f0f\u8eab\u4efd\u5206\u914d](https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/qs-configure-portal-windows-vm#user-assigned-managed-identity) \u5230\u904b\u884c\u61c9\u7528\u7684\u865b\u64ec\u6a5f\u6216\u5176\u4ed6\u8cc7\u6e90\u3002\n **\u6ce8\u610f** \uff1a\u5982\u679c\u4f7f\u7528 Azure \u7684\u9ed8\u8a8d\u8a2d\u7f6e\uff0c\u5247\u65b0\u61c9\u7528\u6703\u5411 Azure AD \u79df\u6236\u4e2d\u7684\u6240\u6709\u7528\u6236\u6388\u4e88\u6388\u4e88\u8a2a\u554f\u4ee4\u724c\u7684\u6b0a\u9650\u3002\u4f7f\u7528 [\u61c9\u7528\u89d2\u8272\u5206\u914d](https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-assign-app-role-managed-identity-powershell#assign-a-managed-identity-access-to-another-applications-app-role) \u4f86\u9650\u5236\u54ea\u4e9b\u8eab\u4efd\u53ef\u4ee5\u7372\u53d6\u61c9\u7528\u7684\u8a2a\u554f\u4ee4\u724c\u3002\n## \u914d\u7f6e\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\n\u60a8\u53ea\u9700\u7232\u6bcf\u500b AWS \u8cec\u865f\u6216 Azure AD \u79df\u6236\u57f7\u884c\u4e00\u6b21\u9019\u4e9b\u6b65\u9a5f\u3002\u7136\u5f8c\uff0c\u60a8\u53ef\u4ee5\u7232\u591a\u500b\u5de5\u4f5c\u8ca0\u8f09\u4ee5\u53ca\u591a\u500b Google Cloud \u9805\u76ee\u4f7f\u7528\u76f8\u540c\u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u548c\u63d0\u4f9b\u65b9\u3002\n\u5982\u9700\u958b\u59cb\u914d\u7f6e\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- \u5728 Google Cloud Console \u4e2d\u7684\u9805\u76ee\u9078\u64c7\u5668\u9801\u9762\u4e0a\uff0c\u9078\u64c7\u6216 [\u5275\u5efa\u4e00\u500b Google Cloud \u9805\u76ee](https://cloud.google.com/resource-manager/docs/creating-managing-projects?hl=zh-cn) \u3002 [\u8f49\u5230\u201c\u9805\u76ee\u9078\u64c7\u5668\u201d](https://console.cloud.google.com/projectselector2/home/dashboard?hl=zh-cn) \n- \u6700\u597d\n- [\u4f7f\u7528\u5c08\u7528\u9805\u76ee\u4f86\u7ba1\u7406\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u548c\u63d0\u4f9b\u65b9](https://cloud.google.com/iam/docs/best-practices-for-using-workload-identity-federation?hl=zh-cn#dedicated-project) \n- \u3002\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- [\u78ba\u4fdd\u60a8\u7684 Google Cloud \u9805\u76ee\u5df2\u5553\u7528\u7d50\u7b97\u529f\u80fd](https://cloud.google.com/billing/docs/how-to/verify-billing-enabled?hl=zh-cn#console) \u3002\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- \u5553\u7528 IAM, Resource Manager, Service Account Credentials, and Security Token Service API\u3002\n- [\u5553\u7528 API](https://console.cloud.google.com/flows/enableapi?apiid=iam.googleapis.com%2Ccloudresourcemanager.googleapis.com%2Ciamcredentials.googleapis.com%2Csts.googleapis.com&%3Bredirect=https%3A%2F%2Fconsole.cloud.google.com&hl=zh-cn) \n### \u5b9a\u7fa9\u7279\u6027\u6620\u5c04\u548c\u689d\u4ef6\nAWS \u6216 Azure \u5de5\u4f5c\u8ca0\u8f09\u7684\u7279\u5b9a\u65bc\u74b0\u5883\u7684\u6191\u64da\u5305\u542b\u591a\u500b\u7279\u6027\uff0c\u60a8\u5fc5\u9808\u6c7a\u5b9a\u8981\u5728 Google Cloud \u4e2d\u7528\u4f5c\u4e3b\u9ad4\u6a19\u8b58\u7b26 ( `google.subject` ) \u7684\u7279\u6027\u3002\nGoogle Cloud \u5728 Cloud Audit Logs \u548c [\u4e3b\u8cec\u865f\u6a19\u8b58\u7b26](https://cloud.google.com/iam/docs/principal-identifiers?hl=zh-cn) \u4e2d\u4f7f\u7528\u4e3b\u9ad4\u6a19\u8b58\u7b26\u4f86\u552f\u4e00\u6a19\u8b58 AWS \u6216 Azure \u7528\u6236\u6216\u89d2\u8272\u3002\n\u60a8\u4e5f\u53ef\u4ee5\u8996\u9700\u8981 [\u6620\u5c04\u5176\u4ed6\u7279\u6027](https://cloud.google.com/iam/docs/workload-identity-federation?hl=zh-cn#mapping) \u3002\u7136\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5728\u6388\u4e88\u5c0d\u8cc7\u6e90\u7684\u8a2a\u554f\u6b0a\u9650\u6642\u5f15\u7528\u9019\u4e9b\u9644\u52a0\u7279\u6027\u3002\n\u60a8\u7684\u7279\u6027\u6620\u5c04\u53ef\u4ee5\u4f7f\u7528 [GetCallerIdentity \u7684\u97ff\u61c9\u5b57\u6bb5](https://docs.aws.amazon.com/STS/latest/APIReference/API_GetCallerIdentity.html) \u4f5c\u7232\u4f86\u6e90\u7279\u6027\u3002\u9019\u4e9b\u5b57\u6bb5\u5305\u62ec\uff1a- `account`\uff1aAWS \u8cec\u865f\u3002\n- `arn`\uff1a\u5305\u542b\u5916\u90e8\u5be6\u9ad4\u7684 AWS ARN\u3002\n- `userid`\uff1a\u8abf\u7528\u5be6\u9ad4\u7684\u552f\u4e00\u6a19\u8b58\u7b26\u3002\n\u5982\u679c\u60a8\u7684\u61c9\u7528\u5728 [\u9644\u52a0\u89d2\u8272\u7684 Amazon Elastic Compute Cloud (EC2) \u5be6\u4f8b](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html) \u4e0a\u904b\u884c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u7279\u6027\u6620\u5c04\uff1a\n```\ngoogle.subject=assertion.arn\nattribute.account=assertion.account\nattribute.aws_role=assertion.arn.extract('assumed-role/{role}/')\nattribute.aws_ec2_instance=assertion.arn.extract('assumed-role/{role_and_session}').extract('/{session}')\n```\n\u6620\u5c04\u6703\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u4f7f\u7528 ARN \u4f5c\u7232\u4e3b\u9ad4\u6a19\u8b58\u7b26\uff08\u793a\u4f8b\uff1a`\"arn:aws:sts::000000000000:assumed-role/ec2-my-role/i-00000000000000000`\uff09\n- \u5f15\u5165\u81ea\u5b9a\u7fa9\u7279\u6027`account`\u4f75\u7232\u5176\u5206\u914d AWS \u8cec\u865f ID\n- \u5f15\u5165\u81ea\u5b9a\u7fa9\u7279\u6027`aws_role`\u4f75\u7232\u5176\u5206\u914d AWS \u89d2\u8272\u540d\u7a31\uff08\u793a\u4f8b\uff1a`ec2-my-role`\uff09\n- \u5f15\u5165\u81ea\u5b9a\u7fa9\u7279\u6027`aws_ec2_instance`\u4f75\u7232\u5176\u5206\u914d EC2 \u5be6\u4f8b ID\uff08\u793a\u4f8b\uff1a`i-00000000000000000`\uff09\n\u4f7f\u7528\u6b64\u6620\u5c04\u6642\uff0c\u60a8\u53ef\u5411\u4ee5\u4e0b\u5c0d\u8c61\u6388\u4e88\u8a2a\u554f\u6b0a\u9650\uff1a- \u7279\u5b9a\u7684 EC2 \u5be6\u4f8b\uff1a```\nprincipalSet://iam.googleapis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/attribute.aws_ec2_instance/EC2_INSTANCE_ID\n```\n- \u4e00\u500b\u89d2\u8272\u4e2d\u7684\u6240\u6709\u7528\u6236\u548c\u5be6\u4f8b\uff1a```\nprincipalSet://iam.googleapis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/attribute.aws_role/ROLE_NAME\n```\n\u60a8\u7684\u7279\u6027\u6620\u5c04\u53ef\u4ee5\u4f7f\u7528 [\u5d4c\u5165\u5728 Azure \u8a2a\u554f\u4ee4\u724c\u4e2d\u7684\u8072\u660e](https://docs.microsoft.com/en-us/azure/active-directory/develop/access-tokens#claims-in-access-tokens) \uff08\u5305\u62ec\u81ea\u5b9a\u7fa9\u8072\u660e\uff09\u4f5c\u7232\u4f86\u6e90\u7279\u6027\u3002 \u5728\u5927\u591a\u6578\u60c5\u6cc1\u4e0b\uff0c\u6700\u597d\u4f7f\u7528 `sub` \u8072\u660e\u4f5c\u7232\u4e3b\u9ad4\u6a19\u8b58\u7b26\uff1a\n```\ngoogle.subject=assertion.sub\n```\n\u5c0d\u65bc\u767c\u4f48\u5230 [\u4ee3\u7ba1\u5f0f\u8eab\u4efd](https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/qs-configure-portal-windows-vm#user-assigned-managed-identity) \u7684\u8a2a\u554f\u4ee4\u724c\uff0c `sub` \u8072\u660e\u5305\u542b\u4ee3\u7ba1\u5f0f\u8eab\u4efd\u7684\u5c0d\u8c61 ID\u3002\u5982\u679c\u60a8\u4f7f\u7528\u5176\u4ed6\u8072\u660e\uff0c\u8acb\u78ba\u4fdd\u8a72\u8072\u660e\u662f\u552f\u4e00\u7684\uff0c\u4e26\u4e14\u7121\u6cd5\u91cd\u65b0\u5206\u914d\u3002\n\u5982\u679c\u60a8\u4e0d\u78ba\u5b9a\u53ef\u4ee5\u5f15\u7528\u7684\u8072\u660e\u5217\u8868\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u9023\u63a5\u5230\u5177\u6709\u5df2\u5206\u914d\u7684\u4ee3\u7ba1\u5f0f\u8eab\u4efd\u7684 Azure \u865b\u64ec\u6a5f\u3002\n- \u5f9e [Azure Instance Metadata Service (IMDS)](https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-use-vm-token#get-a-token-using-http) \u7372\u53d6\u8a2a\u554f\u4ee4\u724c\uff1a\u6b64\u547d\u4ee4\u4f7f\u7528 [jq \u5de5\u5177](https://stedolan.github.io/jq/) \u3002 `jq` \u9ed8\u8a8d\u5728 Cloud Shell \u4e2d\u53ef\u7528\u3002\u5c07 `` \u66ff\u63db\u7232\u60a8\u5df2 [\u7232\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u914d\u7f6e](#prepare) \u7684\u61c9\u7528\u7684 **\u61c9\u7528 ID URI** \u3002\n- \u5728\u7db2\u7d61\u700f\u89bd\u5668\u4e2d\uff0c\u8f49\u5230 [https://jwt.ms/](https://jwt.ms/) \u4e26\u5c07\u8a2a\u554f\u4ee4\u724c\u7c98\u8cbc\u5230\u6587\u672c\u6846\u4e2d\u3002\n- \u9ede\u64ca **\u8072\u660e** \u67e5\u770b\u5d4c\u5165\u5728\u8a2a\u554f\u4ee4\u724c\u4e2d\u7684\u8072\u660e\u5217\u8868\u3002\n\u5c0d\u65bc\u670d\u52d9\u8eab\u4efd\uff0c\u901a\u5e38\u4e0d\u9700\u8981\u7232 `google.groups` \u6216\u4efb\u4f55\u81ea\u5b9a\u7fa9\u7279\u6027\u5275\u5efa\u6620\u5c04\u3002\n\u60a8\u53ef\u4ee5\u8996\u9700\u8981\u5b9a\u7fa9 [\u7279\u6027\u689d\u4ef6](https://cloud.google.com/iam/docs/workload-identity-federation?hl=zh-cn#conditions) \u3002\u7279\u6027\u689d\u4ef6\u662f\u53ef\u4ee5\u6aa2\u67e5\u65b7\u8a00\u7279\u6027\u548c\u76ee\u6a19\u7279\u6027\u7684 CEL \u8868\u9054\u5f0f\u3002\u5982\u679c\u7d66\u5b9a\u6191\u64da\u7684\u7279\u6027\u689d\u4ef6\u8a55\u4f30\u7d50\u679c\u7232 `true` \uff0c\u5247\u63a5\u53d7\u6191\u64da\u3002\u5426\u5247\uff0c\u6191\u64da\u6703\u88ab\u62d2\u7d55\u3002\n\u60a8\u53ef\u4ee5\u4f7f\u7528\u7279\u6027\u689d\u4ef6\u4f86\u9650\u5236\u54ea\u4e9b IAM \u7528\u6236\u548c\u89d2\u8272\u53ef\u4ee5\u4f7f\u7528\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u4f86\u7372\u53d6\u77ed\u671f\u6709\u6548\u7684 Google Cloud \u4ee4\u724c\u3002\n\u4f8b\u5982\uff0c\u4ee5\u4e0b\u689d\u4ef6\u5c07\u50c5\u9650 AWS \u89d2\u8272\u53ef\u4ee5\u8a2a\u554f\uff0c\u4e0d\u5141\u8a31 [\u5176\u4ed6 IAM \u6a19\u8b58\u7b26](https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_identifiers.html) \uff1a\n```\nassertion.arn.startsWith('arn:aws:sts::AWS_ACCOUNT_ID:assumed-role/')\n```\n\u60a8\u53ef\u4ee5\u4f7f\u7528\u7279\u6027\u689d\u4ef6\u4f86\u9650\u5236\u54ea\u4e9b\u7528\u6236\u548c\u670d\u52d9\u4e3b\u8cec\u865f\u53ef\u4ee5\u4f7f\u7528\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u7372\u53d6\u77ed\u671f\u6709\u6548\u7684 Google Cloud \u4ee4\u724c\u3002\u6216\u8005\uff0c\u60a8\u4e5f\u53ef\u4ee5\u5c07 Azure AD \u61c9\u7528\u914d\u7f6e\u7232\u4f7f\u7528 [\u61c9\u7528\u89d2\u8272\u5206\u914d](https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-assign-app-role-managed-identity-powershell#assign-a-managed-identity-access-to-another-applications-app-role) \u3002\n### \u5275\u5efa\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u548c\u63d0\u4f9b\u65b9\n\u73fe\u5728\uff0c\u60a8\u5df2\u7d93\u6536\u96c6\u4e86\u5275\u5efa\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u548c\u63d0\u4f9b\u65b9\u6240\u9700\u7684\u5168\u90e8\u4fe1\u606f\uff1a\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u524d\u5f80 **\u65b0\u5efa\u5de5\u4f5c\u8ca0\u8f09\u63d0\u4f9b\u65b9\u548c\u6c60** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u65b0\u5efa\u5de5\u4f5c\u8ca0\u8f09\u63d0\u4f9b\u65b9\u548c\u6c60\u201d](https://console.cloud.google.com/iam-admin/workload-identity-pools/create?hl=zh-cn) \n- \u5728 **\u5275\u5efa\u8eab\u4efd\u6c60** \u90e8\u5206\u4e2d\uff0c\u8f38\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a- **\u540d\u7a31** \uff1a\u6c60\u7684\u540d\u7a31\u3002\u8a72\u540d\u7a31\u9084\u7528\u4f5c\u6c60 ID\u3002\u6c60 ID \u5275\u5efa\u5f8c\u4fbf\u7121\u6cd5\u66f4\u6539\u3002\n- **\u8aaa\u660e** \uff1a\u63cf\u8ff0\u6c60\u7528\u9014\u7684\u6587\u672c\u3002\n- \u9ede\u64ca **\u7e7c\u7e8c** \u3002\n- \u914d\u7f6e\u63d0\u4f9b\u65b9\u8a2d\u7f6e\uff1a\n\u914d\u7f6e\u4ee5\u4e0b\u63d0\u4f9b\u65b9\u8a2d\u7f6e\uff1a- **\u9078\u64c7\u63d0\u4f9b\u65b9** \uff1a **AWS** \u3002\n- **\u63d0\u4f9b\u65b9\u540d\u7a31** \uff1a\u63d0\u4f9b\u65b9\u7684\u540d\u7a31\u3002\u8a72\u540d\u7a31\u9084\u7528\u4f5c\u63d0\u4f9b\u65b9 ID\u3002\u63d0\u4f9b\u65b9 ID \u5275\u5efa\u5f8c\u4fbf\u7121\u6cd5\u66f4\u6539\u3002\n\u914d\u7f6e\u4ee5\u4e0b\u63d0\u4f9b\u65b9\u8a2d\u7f6e\uff1a- **\u9078\u64c7\u63d0\u4f9b\u65b9** \uff1a **OpenID Connect (OIDC)** \u3002\n- **\u63d0\u4f9b\u65b9\u540d\u7a31** \uff1a\u63d0\u4f9b\u65b9\u7684\u540d\u7a31\u3002\u8a72\u540d\u7a31\u9084\u7528\u4f5c\u63d0\u4f9b\u65b9 ID\u3002\u63d0\u4f9b\u65b9 ID \u5275\u5efa\u5f8c\u4fbf\u7121\u6cd5\u66f4\u6539\u3002\n- **\u9812\u767c\u8005 URL** \uff1a`https://sts.windows.net/` ``\u3002 \u5c07``\u66ff\u63db\u7232 Azure AD \u79df\u6236\u7684 [ID](https://learn.microsoft.com/en-us/azure/azure-portal/get-subscription-tenant-id) (GUID)\u3002\n- **\u5141\u8a31\u7684\u76ee\u6a19\u8a2d\u5099** \uff1a\u60a8\u5728 Azure AD \u4e2d [\u8a3b\u518a\u61c9\u7528](#prepare) \u6642\u4f7f\u7528\u7684 **\u61c9\u7528 ID URI** \u3002- \u9ede\u64ca **\u7e7c\u7e8c** \u3002\n- \u5728 **\u914d\u7f6e\u63d0\u4f9b\u65b9\u7279\u6027** \u90e8\u5206\u4e2d\uff0c\u6dfb\u52a0 [\u60a8\u4e4b\u524d\u8b58\u5225\u7684\u7279\u6027\u6620\u5c04](#mappings-and-conditions) \u3002\n- \u5728 **\u7279\u6027\u689d\u4ef6** \u90e8\u5206\u4e2d\uff0c\u8f38\u5165\u60a8\u4e4b\u524d\u78ba\u5b9a\u7684 [\u7279\u6027\u689d\u4ef6](#mappings-and-conditions) \u3002\u5982\u679c\u60a8\u6c92\u6709\u7279\u6027\u689d\u4ef6\uff0c\u8acb\u5c07\u8a72\u5b57\u6bb5\u7559\u7a7a\u3002\n- \u9ede\u64ca **\u4fdd\u5b58** \u4ee5\u5275\u5efa\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u548c\u63d0\u4f9b\u65b9\u3002\n- \u5275\u5efa\u65b0\u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\uff1a```\ngcloud iam workload-identity-pools create POOL_ID \\\n --location=\"global\" \\\n --description=\"DESCRIPTION\" \\\n --display-name=\"DISPLAY_NAME\"\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u6c60\u7684\u552f\u4e00 ID\u3002\n- ``\uff1a\u6c60\u7684\u540d\u7a31\u3002\n- ``\uff1a\u6c60\u7684\u8aaa\u660e\u3002\u6388\u4e88\u5c0d\u6c60\u8eab\u4efd\u7684\u8a2a\u554f\u6b0a\u9650\u6642\uff0c\u7cfb\u7d71\u6703\u986f\u793a\u6b64\u8aaa\u660e\u3002\n- \u6dfb\u52a0\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u63d0\u4f9b\u5546\uff1a\n\u5982\u9700\u7232 AWS \u5275\u5efa\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u63d0\u4f9b\u65b9\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ngcloud iam workload-identity-pools providers create-aws PROVIDER_ID \\\n --location=\"global\" \\\n --workload-identity-pool=\"POOL_ID\" \\\n --account-id=\"ACCOUNT_ID\" \\\n --attribute-mapping=\"MAPPINGS\" \\\n --attribute-condition=\"CONDITIONS\"\n```\n\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u63d0\u4f9b\u65b9\u7684\u552f\u4e00 ID\u3002\n- ``\uff1a\u6c60\u7684 ID\u3002\n- ``\uff1a [\u7528\u65bc\u6a19\u8b58\u60a8\u7684 AWS \u8cec\u865f](https://docs.aws.amazon.com/general/latest/gr/acct-identifiers.html) \u7684 12 \u4f4d\u6578\u5b57\u3002\n- ``\uff1a [\u60a8\u4e4b\u524d\u8b58\u5225\u7684\u7279\u6027\u6620\u5c04](#mappings-and-conditions) \u7684\u9017\u865f\u5206\u9694\u5217\u8868\u3002\n- ``\uff1a [\u60a8\u4e4b\u524d\u78ba\u5b9a\u7684\u7279\u6027\u689d\u4ef6](#mappings-and-conditions) \u3002\u5982\u679c\u60a8\u6c92\u6709\u7279\u6027\u689d\u4ef6\uff0c\u8acb\u79fb\u9664\u8a72\u53c3\u6578\u3002\n\u4f8b\u5982\uff1a\n```\ngcloud iam workload-identity-pools providers create-aws example-provider \\\u00a0 --location=\"global\" \u00a0\\\u00a0 --workload-identity-pool=\"pool-1\" \\\u00a0 --account-id=\"123456789000\" \\\u00a0 --attribute-mapping=\"google.subject=assertion.arn\"\n```\n\u5982\u9700\u7232 Azure \u5275\u5efa\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u63d0\u4f9b\u65b9\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ngcloud iam workload-identity-pools providers create-oidc PROVIDER_ID \\\n --location=\"global\" \\\n --workload-identity-pool=\"POOL_ID\" \\\n --issuer-uri=\"ISSUER_URI\" \\\n --allowed-audiences=\"APPLICATION_ID_URI\" \\\n --attribute-mapping=\"MAPPINGS\" \\\n --attribute-condition=\"CONDITIONS\"\n```\n\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u63d0\u4f9b\u65b9\u7684\u552f\u4e00 ID\u3002\n- ``\uff1a\u6c60\u7684 ID\u3002\n- ``\uff1aAzure AD \u79df\u6236\u7684 [ID](https://learn.microsoft.com/en-us/azure/azure-portal/get-subscription-tenant-id) (GUID)\uff0c\u6709\u6642\u683c\u5f0f\u8a2d\u7f6e\u7232`https://sts.windows.net/` ``\u3002\u9812\u767c\u8005 URI \u53ef\u80fd\u6709\u6240\u4e0d\u540c\uff0c\u5982\u9700\u67e5\u627e\u9812\u767c\u8005 URI\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 [JWT.io](http://jwt.io) \u8abf\u8a66 JWT\u3002\n- ``\uff1a\u60a8\u5728 Azure AD \u4e2d [\u8a3b\u518a\u61c9\u7528](#prepare) \u6642\u4f7f\u7528\u7684 **\u61c9\u7528 ID URI** \u3002\n- ``\uff1a\u60a8\u4e4b\u524d\u78ba\u5b9a\u7684\u4ee5\u82f1\u6587\u9017\u865f\u5206\u9694\u7684 [\u5c6c\u6027\u6620\u5c04](#mappings-and-conditions) \u5217\u8868\u3002\n- ``\uff1a\uff08\u53ef\u9078\uff09\u60a8\u4e4b\u524d\u78ba\u5b9a\u7684 [\u5c6c\u6027\u689d\u4ef6](#mappings-and-conditions) \u3002\n\u793a\u4f8b\uff1a\n```\ngcloud iam workload-identity-pools providers create-oidc example-provider \\\u00a0 \u00a0 --location=\"global\" \\\u00a0 \u00a0 --workload-identity-pool=\"pool-1\" \\\u00a0 \u00a0 --issuer-uri=\"https://sts.windows.net/00000000-1111-2222-3333-444444444444\" \\\u00a0 \u00a0 --allowed-audiences=\"api://my-app\" \\\u00a0 \u00a0 --attribute-mapping=\"google.subject=assertion.sub,google.groups=assertion.groups\"\n```\n**\u6ce8\u610f** \uff1a\u524d\u7db4 `gcp-` \u5df2\u88ab\u4fdd\u7559\uff0c\u4e0d\u80fd\u5728\u6c60\u6216\u63d0\u4f9b\u65b9 ID \u4e2d\u4f7f\u7528\u3002\n## \u5c0d\u5de5\u4f5c\u8ca0\u8f09\u9032\u884c\u8eab\u4efd\u9a57\u8b49\n\u60a8\u5fc5\u9808\u7232\u6bcf\u500b\u5de5\u4f5c\u8ca0\u8f09\u57f7\u884c\u4e00\u6b21\u9019\u4e9b\u6b65\u9a5f\u3002\n### \u7232\u5916\u90e8\u5de5\u4f5c\u8ca0\u8f09\u5275\u5efa\u670d\u52d9\u8cec\u865f\n-   Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them  \u5553\u7528 IAM, Security Token Service, and Service Account Credentials API\u3002 [\u5553\u7528 API](https://console.cloud.google.com/flows/enableapi?apiid=iam.googleapis.com%2Csts.googleapis.com%2Ciamcredentials.googleapis.com&%3Bredirect=https%3A%2F%2Fconsole.cloud.google.com&hl=zh-cn) \n- [\u5275\u5efa\u4e00\u500b\u670d\u52d9\u8cec\u865f](https://cloud.google.com/iam/docs/creating-managing-service-accounts?hl=zh-cn#creating) \u4ee5\u4ee3\u8868\u5de5\u4f5c\u8ca0\u8f09\u3002\u6700\u597d [\u7232\u6bcf\u500b\u5de5\u4f5c\u8ca0\u8f09\u4f7f\u7528\u5c08\u7528\u670d\u52d9\u8cec\u865f](https://cloud.google.com/iam/docs/best-practices-for-using-workload-identity-federation?hl=zh-cn#use-dedicated-service-accounts) \u3002\u8a72\u670d\u52d9\u8cec\u865f\u4e0d\u9700\u8981\u8207\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u4f4d\u65bc\u540c\u4e00\u9805\u76ee\u4e2d\u3002\n- [\u5411\u670d\u52d9\u8cec\u865f\u6388\u4e88\u5c0d\u60a8\u5e0c\u671b\u5916\u90e8\u8eab\u4efd\u8a2a\u554f\u7684\u8cc7\u6e90\u7684\u8a2a\u554f\u6b0a\u9650](https://cloud.google.com/iam/docs/granting-changing-revoking-access?hl=zh-cn) \u3002\n### \u5141\u8a31\u5916\u90e8\u5de5\u4f5c\u8ca0\u8f09\u6a21\u64ec\u670d\u52d9\u8cec\u865f\n\u5982\u9700\u5141\u8a31\u5916\u90e8\u8eab\u4efd\u6a21\u64ec\u670d\u52d9\u8cec\u865f\uff0c\u8acb\u5411\u5176\u6388\u4e88\u670d\u52d9\u8cec\u865f\u7684 Workload Identity User \u89d2\u8272 ( `roles/iam.workloadIdentityUser` )\u3002\u60a8\u53ef\u4ee5\u5411\u7279\u5b9a\u5916\u90e8\u8eab\u4efd\u6216\u591a\u500b\u5916\u90e8\u8eab\u4efd\u6388\u4e88\u8a72\u89d2\u8272\uff1a\n- \u5c0d\u65bc\u7279\u5b9a\u7684\u5916\u90e8\u8eab\u4efd\uff0c\u8acb\u7de8\u5beb\u4e00\u500b\u6aa2\u67e5`google.subject`\u7279\u6027\u7684\u7279\u6027\u689d\u4ef6\u3002\n- \u5c0d\u65bc\u4e00\u7d44\u5916\u90e8\u8eab\u4efd\uff0c\u7de8\u5beb\u4e00\u500b\u6aa2\u67e5`google.groups`\u7279\u6027\u6216\u81ea\u5b9a\u7fa9\u5c6c\u6027`attribute.` ``\u7684\u7279\u6027\u689d\u4ef6\u3002\n**\u6ce8\u610f** \uff1a\u60a8\u53ea\u80fd\u6aa2\u67e5\u60a8\u5728 [\u7279\u6027\u6620\u5c04](#mappings-and-conditions) \u4e2d\u914d\u7f6e\u7684\u7279\u6027\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u63d0\u4f9b\u7a0b\u5e8f\u7684\u914d\u7f6e\u3002\n\u5982\u9700\u4f7f\u7528 Google Cloud \u63a7\u5236\u6aaf\u5141\u8a31\u5916\u90e8\u8eab\u4efd\u6a21\u64ec\u670d\u52d9\u8cec\u865f\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u8f49\u5230 **Workload Identity \u6c60** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u201d](https://console.cloud.google.com/iam-admin/workload-identity-pools?hl=zh-cn) \n- \u627e\u5230\u60a8\u8981\u66f4\u65b0\u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u4e26\u9078\u64c7\u5b83\u3002\n- \u5982\u9700\u6388\u4e88\u5c0d\u6240\u9078\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u7684\u8a2a\u554f\u6b0a\u9650\uff0c\u8acb\u9ede\u64ca add_box **\u6388\u4e88\u8a2a\u554f\u6b0a\u9650** \u3002\n- \u5728 **\u670d\u52d9\u8cec\u865f** \u5217\u8868\u4e2d\uff0c\u9078\u64c7\u60a8\u8981\u6a21\u64ec\u7684\u5916\u90e8\u8eab\u4efd\u7684\u670d\u52d9\u8cec\u865f\u3002\n- \u5982\u9700\u9078\u64c7\u6c60\u4e2d\u7684\u54ea\u4e9b\u8eab\u4efd\u53ef\u4ee5\u6a21\u64ec\u670d\u52d9\u8cec\u865f\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u67d0\u9805\u64cd\u4f5c\uff1a- \u5982\u9700\u50c5\u5141\u8a31\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u7684\u7279\u5b9a\u8eab\u4efd\u4f86\u6a21\u64ec\u670d\u52d9\u8cec\u865f\uff0c\u8acb\u9078\u64c7 **\u50c5\u9650\u8207\u904e\u6ffe\u689d\u4ef6\u5339\u914d\u7684\u8eab\u4efd** \u3002\u5728 **\u7279\u6027\u540d\u7a31** \u5217\u8868\u4e2d\uff0c\u9078\u64c7\u904e\u6ffe\u6839\u64da\u7684\u7279\u6027\u3002\u5728 **\u7279\u6027\u503c** \u5b57\u6bb5\u4e2d\uff0c\u8f38\u5165\u7279\u6027\u7684\u9810\u671f\u503c\uff1b\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u4f7f\u7528 [\u7279\u6027\u6620\u5c04](#mappings-and-conditions) `google.subject=assertion.sub` \uff0c\u8acb\u5c07 **\u7279\u6027** \u540d\u7a31\u8a2d\u7f6e\u7232 `subject` \uff0c\u4e26\u5c07 **\u7279\u6027\u503c** \u8a2d\u7f6e\u7232\u5916\u90e8\u8eab\u4efd\u63d0\u4f9b\u65b9\u9812\u767c\u7684\u4ee4\u724c\u4e2d `sub` \u8072\u660e\u7684\u503c\u3002\n- \u5982\u9700\u4fdd\u5b58\u914d\u7f6e\uff0c\u8acb\u9ede\u64ca **\u4fdd\u5b58** \uff0c\u7136\u5f8c\u9ede\u64ca **\u95dc\u9589** \u3002\n\u5982\u9700\u4f7f\u7528 gcloud CLI \u5141\u8a31\u5916\u90e8\u8eab\u4efd\u6a21\u64ec\u670d\u52d9\u8cec\u865f\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u5982\u9700\u7372\u53d6\u7576\u524d\u9805\u76ee\u7684\u7de8\u865f\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud projects describe $(gcloud config get-value core/project) --format=value\\(projectNumber\\)\n```\n- \u5982\u9700\u5411\u7b26\u5408\u7279\u5b9a\u689d\u4ef6\u7684\u5916\u90e8\u8eab\u4efd\u6388\u4e88 Workload Identity User \u89d2\u8272 ( `roles/iam.workloadIdentityUser` )\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ngcloud iam service-accounts add-iam-policy-binding SERVICE_ACCOUNT_EMAIL \\\n --role=roles/iam.workloadIdentityUser \\\n --member=\"principal://iam.googleapis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/subject/SUBJECT\"\n```\n```\ngcloud iam service-accounts add-iam-policy-binding SERVICE_ACCOUNT_EMAIL \\\n --role=roles/iam.workloadIdentityUser \\\n --member=\"principalSet://iam.googleapis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/group/GROUP\"\n```\n```\ngcloud iam service-accounts add-iam-policy-binding SERVICE_ACCOUNT_EMAIL \\\n --role=roles/iam.workloadIdentityUser \\\n --member=\"principalSet://iam.googleapis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/attribute.ATTRIBUTE_NAME/ATTRIBUTE_VALUE\"\n```\n\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u670d\u52d9\u8cec\u865f\u7684\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\n- ``\uff1a\u5305\u542b\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u7684\u9805\u76ee\u7684 [\u7de8\u865f](https://cloud.google.com/resource-manager/docs/creating-managing-projects?hl=zh-cn) \n- ``\uff1a\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u7684\u6c60 ID\n- ``\uff1a [\u5df2\u6620\u5c04](#mappings-and-conditions) \u5230`google.subject`\u7684\u7279\u6027\u7684\u9810\u671f\u503c\n- ``\uff1a [\u5df2\u6620\u5c04](#mappings-and-conditions) \u5230`google.groups`\u7684\u7279\u6027\u7684\u9810\u671f\u503c\n- ``\uff1a [\u7279\u6027\u6620\u5c04](#mappings-and-conditions) \u4e2d\u7684\u81ea\u5b9a\u7fa9\u7279\u6027\u7684\u540d\u7a31\n **\u6ce8\u610f** \uff1a\u60a8\u5fc5\u9808\u5728\u6210\u54e1\u6a19\u8b58\u7b26\u4e2d\u4f7f\u7528\u9805\u76ee\u7de8\u865f\u3002\u7cfb\u7d71\u4e0d\u652f\u6301\u4f7f\u7528\u9805\u76ee ID\u3002\n### \u5275\u5efa\u6191\u64da\u914d\u7f6e\n[Cloud \u5ba2\u6236\u7aef\u5eab](https://cloud.google.com/apis/docs/cloud-client-libraries?hl=zh-cn) \u3001gcloud CLI \u548c Terraform \u53ef\u4ee5\u81ea\u52d5\u7372\u53d6\u5916\u90e8\u6191\u64da\uff0c\u4e26\u4f7f\u7528\u9019\u4e9b\u6191\u64da\u4f86\u6a21\u64ec\u670d\u52d9\u8cec\u865f\u3002\u5982\u8981\u8b93\u5eab\u548c\u5de5\u5177\u5b8c\u6210\u6b64\u904e\u7a0b\uff0c\u60a8\u5fc5\u9808\u63d0\u4f9b\u6191\u64da\u914d\u7f6e\u6587\u4ef6\u3002\u6b64\u6587\u4ef6\u5b9a\u7fa9\u4e86\u4ee5\u4e0b\u5167\u5bb9\uff1a\n- \u5f9e\u4f55\u8655\u7372\u53d6\u5916\u90e8\u6191\u64da\n- \u8981\u4f7f\u7528\u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u548c\u63d0\u4f9b\u5546\n- \u9700\u8981\u6a21\u64ec\u7684\u670d\u52d9\u8cec\u865f\n**\u6ce8\u610f** \uff1a\u8207 [\u670d\u52d9\u8cec\u865f\u5bc6\u9470](https://cloud.google.com/iam/docs/creating-managing-service-account-keys?hl=zh-cn#creating_service_account_keys) \u4e0d\u540c\uff0c\u6191\u64da\u914d\u7f6e\u6587\u4ef6\u4e0d\u5305\u542b\u79c1\u9470\uff0c\u4e0d\u9700\u8981\u4fdd\u5bc6\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u6191\u64da\u914d\u7f6e\u6587\u4ef6\uff0c\u8acb\u8a2a\u554f [https://google.aip.dev/auth/4117](https://google.aip.dev/auth/4117) \u3002\n\u5982\u9700\u5275\u5efa\u6191\u64da\u914d\u7f6e\u6587\u4ef6\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u4e0b\u8f09\u6191\u64da\u914d\u7f6e\u6587\u4ef6\uff1a- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u8f49\u5230 **Workload Identity \u6c60** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u201d](https://console.cloud.google.com/iam-admin/workload-identity-pools?hl=zh-cn) \n- \u627e\u5230\u5305\u542b\u60a8\u8981\u4f7f\u7528\u7684 IdP \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\uff0c\u7136\u5f8c\u9ede\u64ca\u5b83\u3002\n- \u9078\u64c7 **\u95dc\u806f\u7684\u670d\u52d9\u8cec\u865f** \u3002\n- \u627e\u5230\u60a8\u8981\u4f7f\u7528\u7684\u670d\u52d9\u8cec\u865f\uff0c\u7136\u5f8c\u9ede\u64ca file_download **\u4e0b\u8f09** \u3002\n- \u5728 **\u914d\u7f6e\u60a8\u7684\u61c9\u7528** \u5c0d\u8a71\u6846\u4e2d\uff0c\u9078\u64c7\u5c07\u6a21\u64ec\u670d\u52d9\u8cec\u865f\u7684\u5916\u90e8\u8eab\u4efd\u7684\u63d0\u4f9b\u5546\u3002\n- \u8acb\u63d0\u4f9b\u4ee5\u4e0b\u984d\u5916\u8a2d\u7f6e\uff1a\n\u7121\u9700\u9032\u884c\u5176\u4ed6\u8a2d\u7f6e\u3002\n **\u61c9\u7528 ID \u7db2\u5740** \uff1aAzure \u61c9\u7528\u7684\u61c9\u7528 ID URI\n- \u9078\u64c7 file_download **\u4e0b\u8f09\u914d\u7f6e** \u4ee5\u4e0b\u8f09\u6191\u64da\u914d\u7f6e\u6587\u4ef6\uff0c\u7136\u5f8c\u9ede\u64ca **\u95dc\u9589** \u3002\n\u5982\u9700\u4f7f\u7528 [gcloud iam workload-identity-pools create-cred-config](https://cloud.google.com/sdk/gcloud/reference/iam/workload-identity-pools/create-cred-config?hl=zh-cn) \u5275\u5efa\u6191\u64da\u914d\u7f6e\u6587\u4ef6\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n\u5982\u9700\u5275\u5efa\u5141\u8a31\u5eab\u5f9e EC2 \u5be6\u4f8b\u5143\u6578\u64da\u4e2d\u7372\u53d6\u8a2a\u554f\u4ee4\u724c\u7684\u6191\u64da\u5eab\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n```\ngcloud iam workload-identity-pools create-cred-config \\\n projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/providers/PROVIDER_ID \\\n --service-account=SERVICE_ACCOUNT_EMAIL \\\n --service-account-token-lifetime-seconds=SERVICE_ACCOUNT_TOKEN_LIFETIME \\\n --aws \\\n --output-file=FILEPATH.json\n```\n\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u5305\u542b\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u7684\u9805\u76ee\u7684\u7de8\u865f\n- ``\uff1a\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u7684 ID\n- ``\uff1a\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u63d0\u4f9b\u65b9\u7684 ID\n- ``\uff1a\u670d\u52d9\u8cec\u865f\u7684\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\n- ``\uff1a\u670d\u52d9\u8cec\u865f\u8a2a\u554f\u4ee4\u724c\u7684\u751f\u547d\u9031\u671f\uff08\u4ee5\u79d2\u7232\u55ae\u4f4d\uff09\uff1b\u5982\u679c\u672a\u63d0\u4f9b\uff0c\u5247\u9ed8\u8a8d\u7232 1 \u5c0f\u6642\u3002\u5982\u9700\u6307\u5b9a\u8d85\u904e\u4e00\u5c0f\u6642\u7684\u751f\u547d\u9031\u671f\uff0c\u60a8\u5fc5\u9808\u914d\u7f6e`constraints/iam.allowServiceAccountCredentialLifetimeExtension` [\u7d44\u7e54\u653f\u7b56\u9650\u5236\u689d\u4ef6](https://cloud.google.com/resource-manager/docs/organization-policy/creating-managing-policies?hl=zh-cn) \u3002\n- ``\uff1a\u7528\u65bc\u4fdd\u5b58\u914d\u7f6e\u7684\u6587\u4ef6\n\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f [AWS IMDSv2](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html) \uff0c\u5247\u9700\u8981\u5411 [gcloud iam workload-identity-pools create-cred-config](https://cloud.google.com/sdk/gcloud/reference/iam/workload-identity-pools/create-cred-config?hl=zh-cn) \u547d\u4ee4\u6dfb\u52a0\u4e00\u500b\u984d\u5916\u7684\u6a19\u8a8c `--enable-imdsv2` \uff1a\n```\ngcloud iam workload-identity-pools create-cred-config \\\n projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/providers/PROVIDER_ID \\\n --service-account=SERVICE_ACCOUNT_EMAIL \\\n --aws \\\n --enable-imdsv2 \\\n --output-file=FILEPATH.json\n```\n\u5982\u679c\u7121\u6cd5\u9078\u64c7\u4f7f\u7528 AWS \u5143\u6578\u64da\u670d\u52d9\u5668\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u4ee5\u4e0b AWS \u74b0\u5883\u8b8a\u91cf\u63d0\u4f9b AWS \u5b89\u5168\u6191\u64da\uff1a- `AWS_ACCESS_KEY_ID`\n- `AWS_SECRET_ACCESS_KEY`\n- `AWS_REGION`\u6216`AWS_DEFAULT_REGION`\u3002\n- \u53ef\u9078\uff1a`AWS_SESSION_TOKEN`\u3002\ngcloud CLI \u548c\u5eab\u6703\u5728 AWS \u5143\u6578\u64da\u670d\u52d9\u5668\u4e0d\u53ef\u7528\u6642\u4f7f\u7528\u9019\u4e9b AWS \u74b0\u5883\u8b8a\u91cf\u3002\n\u5275\u5efa\u6191\u64da\u914d\u7f6e\u6587\u4ef6\uff0c\u8b93\u5eab\u5f9e Azure Instance Metadata Service (IMDS) \u7372\u53d6\u8a2a\u554f\u4ee4\u724c\uff1a\n```\ngcloud iam workload-identity-pools create-cred-config \\\n projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/providers/PROVIDER_ID \\\n --service-account=SERVICE_ACCOUNT_EMAIL \\\n --service-account-token-lifetime-seconds=SERVICE_ACCOUNT_TOKEN_LIFETIME \\\n --azure \\\n --app-id-uri APPLICATION_ID_URI \\\n --output-file=FILEPATH.json\n```\n\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u5305\u542b\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u7684\u9805\u76ee\u7684\u7de8\u865f\n- ``\uff1a\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u7684 ID\n- ``\uff1a\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u63d0\u4f9b\u65b9\u7684 ID\n- ``\uff1a\u670d\u52d9\u8cec\u865f\u7684\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\n- ``\uff1aAzure \u61c9\u7528\u7684\u61c9\u7528 ID URI\n- ``\uff1a\u670d\u52d9\u8cec\u865f\u8a2a\u554f\u4ee4\u724c\u7684\u751f\u547d\u9031\u671f\uff08\u4ee5\u79d2\u7232\u55ae\u4f4d\uff09\uff1b\u5982\u679c\u672a\u63d0\u4f9b\uff0c\u5247\u9ed8\u8a8d\u7232 1 \u5c0f\u6642\u3002\u5982\u9700\u6307\u5b9a\u8d85\u904e\u4e00\u5c0f\u6642\u7684\u751f\u547d\u9031\u671f\uff0c\u60a8\u5fc5\u9808\u914d\u7f6e`constraints/iam.allowServiceAccountCredentialLifetimeExtension` [\u7d44\u7e54\u653f\u7b56\u9650\u5236\u689d\u4ef6](https://cloud.google.com/resource-manager/docs/organization-policy/creating-managing-policies?hl=zh-cn) \u3002\n- ``\uff1a\u7528\u65bc\u4fdd\u5b58\u914d\u7f6e\u7684\u6587\u4ef6\n### \u4f7f\u7528\u6191\u64da\u914d\u7f6e\u8a2a\u554f Google Cloud\n\u5982\u9700\u4f7f\u5de5\u5177\u548c\u5ba2\u6236\u7aef\u5eab\u4f7f\u7528\u60a8\u7684\u6191\u64da\u914d\u7f6e\uff0c\u8acb\u5728 AWS \u6216 Azure \u74b0\u5883\u4e2d\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u521d\u59cb\u5316\u74b0\u5883\u8b8a\u91cf `GOOGLE_APPLICATION_CREDENTIALS` \u4e26\u5c07\u5176\u6307\u5411\u6191\u64da\u914d\u7f6e\u6587\u4ef6\uff1a\n- \u4f7f\u7528\u652f\u6301\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u4e26\u4e14\u53ef\u4ee5 [\u81ea\u52d5\u67e5\u627e\u6191\u64da](https://cloud.google.com/docs/authentication/application-default-credentials?hl=zh-cn) \u7684\u5ba2\u6236\u7aef\u5eab\u6216\u5de5\u5177\uff1a\n\u5f9e [v2.6.0](https://github.com/googleapis/google-cloud-cpp/releases/tag/v2.6.0) \u7248\u958b\u59cb\uff0c [C++ \u7248 Google Cloud \u5ba2\u6236\u7aef\u5eab](https://cloud.google.com/cpp/docs?hl=zh-cn) \u652f\u6301\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\u5982\u9700\u4f7f\u7528\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u60a8\u5fc5\u9808\u4f7f\u7528 gRPC 1.36.0 \u7248\u6216\u66f4\u9ad8\u7248\u672c\u69cb\u5efa\u5ba2\u6236\u7aef\u5eab\u3002\n\u5982\u679c Go \u5ba2\u6236\u7aef\u5eab\u4f7f\u7528 `golang.org/x/oauth2` \u6a21\u584a\u7684 v0.0.0-20210218202405-ba52d332ba99 \u7248\u672c\u6216\u66f4\u9ad8\u7248\u672c\uff0c\u5247\u5ba2\u6236\u7aef\u5eab\u652f\u6301\u8eab\u4efd\u806f\u5408\u3002\n\u5982\u8981\u67e5\u770b\u5ba2\u6236\u7aef\u5eab\u4f7f\u7528\u7684\u6a21\u584a\u7248\u672c\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ncd $GOPATH/src/cloud.google.com/gogo list -m golang.org/x/oauth2\n```\n\u5982\u679c Java \u5ba2\u6236\u7aef\u5eab\u4f7f\u7528 [com.google.auth:google-auth-library-oauth2-http \u5de5\u4ef6](https://search.maven.org/artifact/com.google.auth/google-auth-library-oauth2-http) \u7684 0.24.0 \u7248\u6216\u66f4\u9ad8\u7248\u672c\uff0c\u5247\u5ba2\u6236\u7aef\u652f\u6301\u8eab\u4efd\u806f\u5408\u3002\n\u5982\u9700\u67e5\u770b\u8a72\u5ba2\u6236\u7aef\u5eab\u4f7f\u7528\u7684\u5de5\u4ef6\u7248\u672c\uff0c\u8acb\u5728\u61c9\u7528\u76ee\u9304\u4e2d\u904b\u884c\u4ee5\u4e0b Maven \u547d\u4ee4\uff1a\n```\nmvn dependency:list -DincludeArtifactIds=google-auth-library-oauth2-http\n```\n\u5982\u679c Node.js \u7248\u5ba2\u6236\u7aef\u5eab\u4f7f\u7528 7.0.2 \u7248\u6216\u66f4\u9ad8\u7248\u672c\u7684 [google-auth-library \u8edf\u4ef6\u5305](https://github.com/googleapis/google-auth-library-nodejs) \uff0c\u5247\u8a72\u5ba2\u6236\u7aef\u5eab\u652f\u6301\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\n\u5982\u8981\u67e5\u770b\u5ba2\u6236\u7aef\u5eab\u4f7f\u7528\u7684\u8edf\u4ef6\u5305\u7248\u672c\uff0c\u8acb\u5728\u61c9\u7528\u76ee\u9304\u4e2d\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\nnpm list google-auth-library\n```\n\u5275\u5efa `GoogleAuth` \u5c0d\u8c61\u6642\uff0c\u60a8\u53ef\u4ee5\u6307\u5b9a\u9805\u76ee ID\uff0c\u4e5f\u53ef\u4ee5\u5141\u8a31 `GoogleAuth` \u81ea\u52d5\u67e5\u627e\u9805\u76ee ID\u3002\u5982\u8981\u81ea\u52d5\u67e5\u627e\u9805\u76ee ID\uff0c\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u670d\u52d9\u8cec\u865f\u5fc5\u9808\u5177\u6709\u9805\u76ee\u7684 Browser \u89d2\u8272 ( `roles/browser` ) \u6216\u5177\u6709\u540c\u7b49\u6b0a\u9650\u7684\u89d2\u8272\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [google-auth-library \u8edf\u4ef6\u5305\u7684 README](https://github.com/googleapis/google-auth-library-nodejs#using-external-identities) \u3002\n\u5982\u679c Python \u5ba2\u6236\u7aef\u5eab\u4f7f\u7528 [google-auth \u8edf\u4ef6\u5305](https://github.com/googleapis/google-auth-library-python) \u7684 1.27.0 \u7248\u672c\u6216\u66f4\u9ad8\u7248\u672c\uff0c\u5247\u5ba2\u6236\u7aef\u652f\u6301\u8eab\u4efd\u806f\u5408\u3002\n\u5982\u8981\u6aa2\u67e5\u5ba2\u6236\u7aef\u5eab\u4f7f\u7528\u7684\u8edf\u4ef6\u5305\u7248\u672c\uff0c\u8acb\u5728\u5df2\u5b89\u88dd\u8a72\u8edf\u4ef6\u5305\u7684\u74b0\u5883\u4e2d\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\npip show google-auth\n```\n\u5982\u8981\u7232\u8eab\u4efd\u9a57\u8b49\u5ba2\u6236\u7aef\u6307\u5b9a\u9805\u76ee ID\uff0c\u60a8\u53ef\u4ee5\u8a2d\u7f6e `GOOGLE_CLOUD_PROJECT` \u74b0\u5883\u8b8a\u91cf\uff0c\u4e5f\u53ef\u4ee5\u5141\u8a31\u5ba2\u6236\u7aef\u81ea\u52d5\u67e5\u627e\u9805\u76ee ID\u3002\u5982\u8981\u81ea\u52d5\u67e5\u627e\u9805\u76ee ID\uff0c\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u670d\u52d9\u8cec\u865f\u5fc5\u9808\u5177\u6709\u9805\u76ee\u7684 Browser \u89d2\u8272 ( `roles/browser` ) \u6216\u5177\u6709\u540c\u7b49\u6b0a\u9650\u7684\u89d2\u8272\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [google-auth \u8edf\u4ef6\u5305\u7528\u6236\u6307\u5357](https://github.com/googleapis/google-auth-library-python/blob/master/docs/user-guide.rst#using-external-identities) \u3002\n\u5982\u9700\u4f7f\u7528\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u4f7f\u7528 [gcloud auth login](https://cloud.google.com/sdk/gcloud/reference/auth/login?hl=zh-cn) \u547d\u4ee4\uff1a\n```\ngcloud auth login --cred-file=FILEPATH.json\n```\n\u5c07 `` \u66ff\u63db\u7232\u6191\u64da\u914d\u7f6e\u6587\u4ef6\u7684\u6587\u4ef6\u8def\u5f91\u3002\n [\u7248\u672c 363.0.0 \u53ca\u66f4\u9ad8\u7248\u672c\u7684 gcloud CLI](https://cloud.google.com/sdk/docs/components?hl=zh-cn#updating_components) \u652f\u6301 gcloud CLI \u4e2d\u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\n\u5982\u679c\u60a8\u4f7f\u7528 3.61.0 \u7248\u6216\u66f4\u9ad8\u7248\u672c\uff0c\u5247 [Google Cloud \u63d0\u4f9b\u65b9](https://registry.terraform.io/providers/hashicorp/google/latest/docs) \u652f\u6301\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff1a\n```\nterraform {\n required_providers {\n google = {\n  source = \"hashicorp/google\"\n  version = \"~> 3.61.0\"\n }\n }\n}\n```\n\u5982\u9700\u4f7f\u7528\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u4f7f\u7528\u4ee5\u4e0b\u65b9\u6cd5\u4e4b\u4e00\uff1a\n\u5c07 gsutil \u8207 gcloud \u7d50\u5408\u4f7f\u7528\u6642\uff0c\u8acb\u6309\u6b63\u5e38\u65b9\u5f0f\u767b\u9304\uff1a\n```\ngcloud auth login --cred-file=FILEPATH.json\n```\n\u5c07 gsutil \u7528\u4f5c\u7368\u7acb\u7684\u547d\u4ee4\u884c\u61c9\u7528\u6642\uff0c\u8acb\u4fee\u6539 .boto \u6587\u4ef6\u4ee5\u5305\u542b\u4ee5\u4e0b\u90e8\u5206\uff1a\n```\n[Credentials]\ngs_external_account_file = FILEPATH\n```\n\u5728\u9019\u5169\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u8acb\u5c07 `` \u66ff\u63db\u7232\u6191\u64da\u914d\u7f6e\u6587\u4ef6\u7684\u6587\u4ef6\u8def\u5f91\u3002\n [379.0.0 \u7248\u53ca\u66f4\u9ad8\u7248\u672c\u7684 gcloud CLI](https://cloud.google.com/sdk/docs/components?hl=zh-cn#updating_components) \u652f\u6301 gsutil \u4e2d\u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\n\u5982\u9700\u4f7f\u7528\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u4f7f\u7528 [gcloud auth login](https://cloud.google.com/sdk/gcloud/reference/auth/login?hl=zh-cn) \u547d\u4ee4\uff0c\u5982\u4e0b\u6240\u793a\uff1a\n```\ngcloud auth login --cred-file=FILEPATH.json\n```\n\u5c07 `` \u66ff\u63db\u7232\u6191\u64da\u914d\u7f6e\u6587\u4ef6\u7684\u6587\u4ef6\u8def\u5f91\u3002\n [390.0.0 \u7248\u53ca\u66f4\u9ad8\u7248\u672c\u7684 gcloud CLI](https://cloud.google.com/sdk/docs/components?hl=zh-cn#updating_components) \u652f\u6301 bq \u4e2d\u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\n\u5982\u679c\u60a8\u7121\u6cd5\u4f7f\u7528\u652f\u6301\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u7684\u5ba2\u6236\u7aef\u5eab\uff0c\u53ef\u4ee5 [\u4f7f\u7528 REST API \u4ee5\u7de8\u7a0b\u65b9\u5f0f\u9032\u884c\u8eab\u4efd\u9a57\u8b49](#rest) \u3002## \u9ad8\u7d1a\u5834\u666f\n### \u4f7f\u7528 REST API \u5c0d\u5de5\u4f5c\u8ca0\u8f09\u9032\u884c\u8eab\u4efd\u9a57\u8b49\n\u5982\u679c\u60a8\u7121\u6cd5\u4f7f\u7528\u5ba2\u6236\u7aef\u5eab\uff0c\u53ef\u4ee5\u6309\u7167\u4ee5\u4e0b\u6b65\u9a5f\u8b93\u5916\u90e8\u5de5\u4f5c\u8ca0\u8f09\u4f7f\u7528 REST API \u7372\u53d6\u77ed\u671f\u6709\u6548\u7684\u8a2a\u554f\u4ee4\u724c\uff1a\n- \u5f9e\u5916\u90e8 IdP \u7372\u53d6\u6191\u64da\uff1a\n\u5275\u5efa\u4e00\u500b JSON \u6587\u6a94\uff0c\u5176\u4e2d\u5305\u542b\u60a8\u901a\u5e38\u5728\u5411 AWS [GetCallerIdentity()](https://docs.aws.amazon.com/STS/latest/APIReference/API_GetCallerIdentity) \u7aef\u9ede\u767c\u51fa\u7684\u8acb\u6c42\u4e2d\u5305\u542b\u7684\u4fe1\u606f\uff0c\u5305\u62ec\u6709\u6548\u7684 [\u8acb\u6c42\u7c64\u540d](https://docs.aws.amazon.com/general/latest/gr/signature-version-4.html) \u3002\n\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u5c07\u6b64 JSON \u6587\u6a94\u7a31\u7232 `GetCallerIdentity` \u4ee4\u724c\u3002\u8a72\u4ee4\u724c\u5141\u8a31\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u9a57\u8b49\u8eab\u4efd\uff0c\u800c\u7121\u9700\u986f\u793a AWS \u79c1\u6709\u8a2a\u554f\u5bc6\u9470\u3002\n`GetCallerIdentity` \u4ee4\u724c\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a\n```\n{\u00a0 \"url\": \"https://sts.amazonaws.com?Action=GetCallerIdentity&Version=2011-06-15\",\u00a0 \"method\": \"POST\",\u00a0 \"headers\": [\u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \"key\": \"Authorization\",\u00a0 \u00a0 \u00a0 \"value\" : \"AWS4-HMAC-SHA256 Credential=AKIASOZTBDV4D7ABCDEDF/20200228/us-east-1/sts/aws4_request, SignedHeaders=host;x-amz-date,Signature=abcedefdfedfd\"\u00a0 \u00a0 },\u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \"key\": \"host\",\u00a0 \u00a0 \u00a0 \"value\": \"sts.amazonaws.com\"\u00a0 \u00a0 },\u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \"key\": \"x-amz-date\",\u00a0 \u00a0 \u00a0 \"value\": \"20200228T225005Z\"\u00a0 \u00a0 },\u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \"key\": \"x-goog-cloud-target-resource\",\u00a0 \u00a0 \u00a0 \"value\": \"//iam.googleapis.com/projects/12345678/locations/global/workloadIdentityPools/my-pool/providers/my-aws-provider\"\u00a0 \u00a0 },\u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \"key\": \"x-amz-security-token\",\u00a0 \u00a0 \u00a0 \"value\": \"GizFWJTqYX...xJ55YoJ8E9HNU=\"\u00a0 \u00a0 }\u00a0 ]}\n```\n\u8a72\u4ee4\u724c\u5305\u542b\u4ee5\u4e0b\u5b57\u6bb5\uff1a- `url`\uff1a`GetCallerIdentity()`\u7684 AWS STS \u7aef\u9ede\u7684\u7db2\u5740\uff0c\u9644\u52a0\u4e00\u500b\u6a19\u6e96`GetCallerIdentity()`\u8acb\u6c42\u6b63\u6587\u4f5c\u7232\u67e5\u8a62\u53c3\u6578\u3002\u4f8b\u5982\uff1a`https://sts.amazonaws.com?Action=GetCallerIdentity&Version=2011-06-15`\u3002\u6211\u5011\u5efa\u8b70\u60a8\u4f7f\u7528\u5340\u57df\u7d1a STS \u7aef\u9ede\u4e26 [\u7232\u5de5\u4f5c\u8ca0\u8f09\u8a2d\u8a08\u53ef\u9760\u7684\u57fa\u790e\u8a2d\u65bd](https://cloud.google.com/architecture/infra-reliability-guide/design?hl=zh-cn) \u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5340\u57df\u7d1a AWS STS \u7aef\u9ede](https://docs.aws.amazon.com/STS/latest/APIReference/welcome.html#sts-endpoints) \u3002\n- `method`\uff1aHTTP \u8acb\u6c42\u65b9\u6cd5\uff1a`POST`\u3002\n- `headers`\uff1aHTTP \u8acb\u6c42\u6a19\u982d\uff0c\u5176\u4e2d\u5fc5\u9808\u5305\u542b\u4ee5\u4e0b\u5167\u5bb9\uff1a\n- `Authorization`\uff1a\u8acb\u6c42\u7c64\u540d\u3002\n- `host`\uff1a`url`\u5b57\u6bb5\u7684\u4e3b\u6a5f\u540d\uff0c\u4f8b\u5982`sts.amazonaws.com`\u3002\n- `x-amz-date`\uff1a\u60a8\u5c07\u767c\u9001\u8acb\u6c42\u7684\u6642\u9593\uff0c\u683c\u5f0f\u7232 [ISO 8601 Basic](https://docs.aws.amazon.com/general/latest/gr/sigv4_elements.html#sigv4_elements_date) \u5b57\u7b26\u4e32\u3002\u6b64\u503c\u901a\u5e38\u8a2d\u7f6e\u7232\u7576\u524d\u6642\u9593\uff0c\u4e26\u53ef\u5e6b\u52a9\u9632\u6b62\u91cd\u653e\u653b\u64ca\u3002\n- `x-goog-cloud-target-resource`\uff1a\u8eab\u4efd\u63d0\u4f9b\u5546\u7684\u5b8c\u6574\u8cc7\u6e90\u540d\u7a31\uff0c\u4e0d\u542b`https:`\u524d\u7db4\u3002\u4f8b\u5982\uff1a```\n//iam.googleapis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL_ID/providers/PROVIDER_ID\n```\n- `x-amz-security-token`\uff1a\u6703\u8a71\u4ee4\u724c\u3002\u50c5\u5728\u4f7f\u7528 [\u81e8\u6642\u5b89\u5168\u6191\u64da](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp_use-resources.html) \u6642\u624d\u9700\u8981\u3002\n\u4ee5\u4e0b\u793a\u4f8b\u6703\u5275\u5efa\u4e00\u500b\u7db2\u5740\u7de8\u78bc\u7684 `GetCallerIdentity` \u4ee4\u724c\u3002\u63d0\u53d6\u7db2\u5740\u7de8\u78bc\u4ee4\u724c\u4ee5\u5099\u5f8c\u7528\u3002\u6b64\u5916\uff0c\u5b83\u5c08\u9580\u7232\u60a8\u7684\u53c3\u8003\u5275\u5efa\u4e86\u4e00\u500b\u4eba\u985e\u53ef\u8b80\u7684\u4ee4\u724c\uff1a\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/python-docs-samples/blob/HEAD/iam/api-client/workload_identity_federation.py) \n```\nimport jsonimport urllibimport boto3from botocore.auth import SigV4Authfrom botocore.awsrequest import AWSRequestdef create_token_aws(project_number: str, pool_id: str, provider_id: str) -> None:\u00a0 \u00a0 # Prepare a GetCallerIdentity request.\u00a0 \u00a0 request = AWSRequest(\u00a0 \u00a0 \u00a0 \u00a0 method=\"POST\",\u00a0 \u00a0 \u00a0 \u00a0 url=\"https://sts.amazonaws.com/?Action=GetCallerIdentity&Version=2011-06-15\",\u00a0 \u00a0 \u00a0 \u00a0 headers={\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"Host\": \"sts.amazonaws.com\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"x-goog-cloud-target-resource\": f\"//iam.googleapis.com/projects/{project_number}/locations/global/workloadIdentityPools/{pool_id}/providers/{provider_id}\",\u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 )\u00a0 \u00a0 # Set the session credentials and Sign the request.\u00a0 \u00a0 # get_credentials loads the required credentials as environment variables.\u00a0 \u00a0 # Refer:\u00a0 \u00a0 # https://boto3.amazonaws.com/v1/documentation/api/latest/guide/credentials.html\u00a0 \u00a0 SigV4Auth(boto3.Session().get_credentials(), \"sts\", \"us-east-1\").add_auth(request)\u00a0 \u00a0 # Create token from signed request.\u00a0 \u00a0 token = {\"url\": request.url, \"method\": request.method, \"headers\": []}\u00a0 \u00a0 for key, value in request.headers.items():\u00a0 \u00a0 \u00a0 \u00a0 token[\"headers\"].append({\"key\": key, \"value\": value})\u00a0 \u00a0 # The token lets workload identity federation verify the identity without revealing the AWS secret access key.\u00a0 \u00a0 print(\"Token:\\n%s\" % json.dumps(token, indent=2, sort_keys=True))\u00a0 \u00a0 print(\"URL encoded token:\\n%s\" % urllib.parse.quote(json.dumps(token)))def main() -> None:\u00a0 \u00a0 # TODO(Developer): Replace the below credentials.\u00a0 \u00a0 # project_number: Google Project number (not the project id)\u00a0 \u00a0 project_number = \"my-project-number\"\u00a0 \u00a0 pool_id = \"my-pool-id\"\u00a0 \u00a0 provider_id = \"my-provider-id\"\u00a0 \u00a0 create_token_aws(project_number, pool_id, provider_id)if __name__ == \"__main__\":\u00a0 \u00a0 main()\n```\n\u521d\u59cb\u5316\u4ee5\u4e0b\u8b8a\u91cf\uff1a\u5176\u4e2d `` \u662f\u7531\u4e0a\u8ff0\u8173\u672c\u751f\u6210\u7684 [\u7db2\u5740\u7de8\u78bc](https://en.wikipedia.org/wiki/Percent-encoding) `GetCallerIdentity` \u4ee4\u724c\u3002\n\u9023\u63a5\u5230\u5177\u6709 [\u5df2\u5206\u914d\u7684\u4ee3\u7ba1\u5f0f\u8eab\u4efd](https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/qs-configure-portal-windows-vm#user-assigned-managed-identity) \u7684 Azure \u865b\u64ec\u6a5f\uff0c\u4e26\u5f9e Azure Instance Metadata Service (IMDS) [\u7372\u53d6\u8a2a\u554f\u4ee4\u724c](https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/qs-configure-portal-windows-vm#user-assigned-managed-identity) \uff1a\u6b64\u547d\u4ee4\u4f7f\u7528 [jq \u5de5\u5177](https://stedolan.github.io/jq/) \u3002 `jq` \u9ed8\u8a8d\u5728 Cloud Shell \u4e2d\u53ef\u7528\u3002\u5176\u4e2d\uff0c `` \u662f\u60a8\u5df2 [\u7232\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u914d\u7f6e](https://cloud.google.com/iam/docs/configuring-workload-identity-federation?hl=zh-cn#prepare) \u7684\u61c9\u7528\u7684 **\u61c9\u7528 ID URI** \u3002\n- \u4f7f\u7528 [Security Token Service API](https://cloud.google.com/iam/docs/reference/sts/rest?hl=zh-cn) \u5c07\u6191\u64da\u4ea4\u63db\u7232\u77ed\u671f\u6709\u6548\u7684\u8a2a\u554f\u4ee4\u724c\uff1a\u66ff\u63db\u4ee5\u4e0b\u503c\uff1a- ``\uff1a\u5305\u542b\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u7684\u9805\u76ee\u7684\u9805\u76ee\u7de8\u865f\n- ``\uff1a\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u7684 ID\n- ``\uff1a\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u63d0\u4f9b\u65b9\u7684 ID\n **\u6ce8\u610f** \uff1a\u53d7\u8846\u7fa3\u9ad4\u4e0d\u5f97\u5305\u542b `https:` \u65b9\u6848\u3002\n- \u4f7f\u7528 Security Token Service \u4e2d\u7684\u4ee4\u724c\u8abf\u7528 [IAM Service Account Credentials API](https://cloud.google.com/iam/docs/reference/credentials/rest?hl=zh-cn) \u7684 [generateAccessToken \u65b9\u6cd5](https://cloud.google.com/iam/docs/reference/credentials/rest/v1/projects.serviceAccounts/generateAccessToken?hl=zh-cn) \u4f86\u7372\u53d6\u8a2a\u554f\u6b0a\u9650\u4ee4\u724c\uff1a\n\u5c07 `` \u66ff\u63db\u7232\u670d\u52d9\u8cec\u865f\u7684\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u8a73\u7d30\u77ad\u89e3 [\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408](https://cloud.google.com/iam/docs/workload-identity-federation?hl=zh-cn) \u3002\n- \u77ad\u89e3 [\u4f7f\u7528\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u7684\u6700\u4f73\u5be6\u8e10](https://cloud.google.com/iam/docs/best-practices-for-using-workload-identity-federation?hl=zh-cn) \u3002\n- \u77ad\u89e3\u5982\u4f55 [\u7ba1\u7406\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\u548c\u63d0\u4f9b\u65b9](https://cloud.google.com/iam/docs/manage-workload-identity-pools-providers?hl=zh-cn) \u3002", "guide": "IAM"}