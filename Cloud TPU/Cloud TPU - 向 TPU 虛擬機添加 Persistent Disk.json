{"title": "Cloud TPU - \u5411 TPU \u865b\u64ec\u6a5f\u6dfb\u52a0 Persistent Disk", "url": "https://cloud.google.com/tpu/docs/setup-persistent-disk?hl=zh-cn", "abstract": "# Cloud TPU - \u5411 TPU \u865b\u64ec\u6a5f\u6dfb\u52a0 Persistent Disk\n# \u5411 TPU \u865b\u64ec\u6a5f\u6dfb\u52a0 Persistent Disk\nTPU \u865b\u64ec\u6a5f\u5305\u542b\u4e00\u500b 100GB \u7684\u5553\u52d5\u78c1\u76e4\u3002\u5728\u67d0\u4e9b\u60c5\u6cc1\u4e0b\uff0c\u60a8\u7684 TPU \u865b\u64ec\u6a5f\u53ef\u80fd\u9700\u8981\u984d\u5916\u7684\u5b58\u5132\u7a7a\u9593\u4f86\u9032\u884c\u8a13\u7df4\u6216\u9810\u8655\u7406\u3002\u60a8\u53ef\u4ee5\u6dfb\u52a0 [\u6c38\u4e45\u6027\u78c1\u76e4](https://cloud.google.com/compute/docs/disks?hl=zh-cn#pdspecs) \u4f86\u64f4\u5c55\u672c\u5730\u78c1\u76e4\u5bb9\u91cf\u3002\n", "content": "## \u6982\u89bd\n\u639b\u63a5\u5230\u55ae\u8a2d\u5099 TPU\uff08v2-8\u3001v3-8\u3001v4-8 \u7b49\uff09\u7684 Persistent Disk \u53ef\u4ee5\u914d\u7f6e\u7232 `read-write` \u6216 `read-only` \u3002\u7576\u60a8\u5c07 Persistent Disk \u639b\u63a5\u5230\u5c6c\u65bc TPU Pod \u7684 TPU \u865b\u64ec\u6a5f\u6642\uff0c\u8a72\u78c1\u76e4\u6703\u639b\u63a5\u5230\u8a72 Pod \u4e2d\u7684\u6bcf\u500b TPU \u865b\u64ec\u6a5f\u3002\u7232\u9632\u6b62\u4e00\u500b Pod \u4e2d\u7684\u5169\u500b\u6216\u591a\u500b TPU \u865b\u64ec\u6a5f\u540c\u6642\u5411\u4e00\u500b Persistent Disk \u5beb\u5165\u6578\u64da\uff0c\u639b\u63a5\u5230 Pod \u4e2d\u67d0\u500b TPU \u865b\u64ec\u6a5f\u7684\u6240\u6709\u6c38\u4e45\u6027\u78c1\u76e4\u90fd\u5fc5\u9808\u914d\u7f6e\u7232 `read-only` \u3002 `read-only` \u78c1\u76e4\u9069\u5408\u5b58\u5132\u8981\u5728 TPU Pod \u4e0a\u9032\u884c\u8655\u7406\u7684\u6578\u64da\u96c6\u3002\n\u5275\u5efa Persistent Disk \u4e26\u5c07\u5176\u639b\u63a5\u5230 TPU \u865b\u64ec\u6a5f\u5f8c\uff0c\u60a8\u5fc5\u9808\u88dd\u8f09\u8a72 Persistent Disk\uff0c\u4e26\u6307\u5b9a\u53ef\u4ee5\u5728\u6587\u4ef6\u7cfb\u7d71\u4e2d\u7684\u54ea\u500b\u4f4d\u7f6e\u8a2a\u554f\u8a72 Persistent Disk\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u88dd\u8f09\u78c1\u76e4](https://cloud.google.com/compute/docs/disks/format-mount-disk-linux?hl=zh-cn#mounting) \u3002\n## \u524d\u63d0\u689d\u4ef6\n\u5728\u57f7\u884c\u4ee5\u4e0b\u6b65\u9a5f\u4e4b\u524d\uff0c\u60a8\u9700\u8981\u5148\u8a2d\u7f6e Google Cloud \u5e33\u865f\u548c\u9805\u76ee\u3002\u5982\u679c\u60a8\u5c1a\u672a\u8a2d\u7f6e Cloud TPU \u9805\u76ee\uff0c\u8acb\u5148\u6309\u7167 [\u8a2d\u7f6e\u5e33\u865f\u548c Cloud TPU \u9805\u76ee](https://cloud.google.com/tpu/docs/setup-gcp-account?hl=zh-cn) \u4e2d\u7684\u6b65\u9a5f\u9032\u884c\u64cd\u4f5c\uff0c\u7136\u5f8c\u518d\u7e7c\u7e8c\u64cd\u4f5c\u3002\n## \u7c21\u8981\u6b65\u9a5f\n\u8a2d\u7f6e Persistent Disk \u7684\u7c21\u8981\u6b65\u9a5f\uff1a\n- [\u5275\u5efa Persistent Disk](#create-pd) \n- [\u5c07 Persistent Disk \u9023\u63a5\u5230 TPU \u865b\u64ec\u6a5f](#attach-pd) \n- [\u88dd\u8f09\u6c38\u4e45\u6027\u78c1\u76e4](#mount-pd) \n- [\u6e05\u7406 TPU \u865b\u64ec\u6a5f\u548c Persistent Disk \u8cc7\u6e90](#cleanup) ## \u8a2d\u7f6e TPU \u865b\u64ec\u6a5f\u548c Persistent Disk\n\u60a8\u53ef\u4ee5\u5728\u5275\u5efa TPU \u865b\u64ec\u6a5f\u6642\u5c07 Persistent Disk \u639b\u63a5\u5230 TPU \u865b\u64ec\u6a5f\u3002\u60a8\u9084\u53ef\u4ee5\u5c07 Persistent Disk \u639b\u63a5\u5230\u73fe\u6709\u7684 TPU \u865b\u64ec\u6a5f\u3002\n### \u5275\u5efa Persistent Disk\n\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5275\u5efa Persistent Disk\uff1a\n```\n\u00a0 $ gcloud compute disks create disk-name \\\u00a0 \u00a0 --size disk-size \u00a0\\\u00a0 \u00a0 --zone zone \\\u00a0 \u00a0 --type pd-balanced\n```### \u639b\u63a5 Persistent Disk\n\u60a8\u53ef\u4ee5\u5728\u5275\u5efa TPU \u865b\u64ec\u6a5f\u6642\u5c07 Persistent Disk \u639b\u63a5\u5230\u60a8\u7684 TPU \u865b\u64ec\u6a5f\uff0c\u4e5f\u53ef\u4ee5\u5728\u5275\u5efa TPU \u865b\u64ec\u6a5f\u5f8c\u6dfb\u52a0\u4e00\u500b\u6c38\u4e45\u6027\u78c1\u76e4\u3002\n**\u6ce8\u610f** \uff1a\u5553\u52d5 TPU \u865b\u64ec\u6a5f\u6642\u6307\u5b9a\u7684 TPU \u8edf\u4ef6\u7248\u672c\u53d6\u6c7a\u65bc\u60a8\u4f7f\u7528\u7684\u6846\u67b6\uff08TensorFlow\u3001PyTorch \u6216 JAX\uff09\u3002\u5982\u9700\u78ba\u5b9a\u8981\u6307\u5b9a\u7684 TPU \u8edf\u4ef6\u7248\u672c\uff0c\u8acb\u53c3\u95b1 [Cloud TPU \u8edf\u4ef6\u7248\u672c](https://cloud.google.com/tpu/docs/supported-tpu-versions?hl=zh-cn#tpu_software_versions) \u3002\n\u5275\u5efa TPU \u865b\u64ec\u6a5f\u6642\uff0c\u4f7f\u7528 `--data-disk` \u6a19\u8a8c\u639b\u63a5 Persistent Disk\u3002\u5982\u679c\u8981\u5275\u5efa TPU Pod\uff0c\u5247\u5fc5\u9808\u6307\u5b9a `mode=read-only` \u3002\u5982\u679c\u60a8\u8981\u5275\u5efa\u55ae\u500b TPU \u8a2d\u5099\uff0c\u5247\u53ef\u4ee5\u6307\u5b9a `mode=read-only` \u6216 `mode=read-write` \u3002\u4ee5\u4e0b\u547d\u4ee4\u6703\u5275\u5efa\u55ae\u500b TPU \u4e26\u5c07 Persistent Disk \u6a21\u5f0f\u8a2d\u7f6e\u7232 `read-write` \uff1a\n```\n\u00a0 $ gcloud compute tpus tpu-vm create tpu-name \\\u00a0 \u00a0 --project project-id \\\u00a0 \u00a0 --zone=zone \\\u00a0 \u00a0 --accelerator-type=v3-8 \\\u00a0 \u00a0 --version=Cloud TPU software version \\\u00a0 \u00a0 --data-disk source=projects/project-id/zones/zone/disks/disk-name,mode=read-write\n```\n**\u6ce8\u610f** \uff1a\u5982\u9700\u5275\u5efa TPU Pod\uff0c\u8acb\u5c07 `--accelerator-type` \u8a2d\u7f6e\u7232 TPU Pod \u985e\u578b\uff0c\u4f8b\u5982 `v4-32`\uff1a\n\u4f7f\u7528 `gcloud alpha compute tpus tpu-vm attach-disk` \u547d\u4ee4\u5c07 Persistent Disk \u639b\u63a5\u5230\u73fe\u6709 TPU \u865b\u64ec\u6a5f\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\u548c\u67e5\u770b\u793a\u4f8b\uff0c\u8acb\u53c3\u95b1 [gcloud](https://cloud.google.com/sdk/gcloud/reference/alpha/compute/tpus/tpu-vm/attach-disk?hl=zh-cn) \u6587\u6a94\u3002\n```\n\u00a0 $ gcloud alpha compute tpus tpu-vm attach-disk tpu-name \\\u00a0 \u00a0 --zone=zone \\\u00a0 \u00a0 --disk=disk-name \\\u00a0 \u00a0 --mode=disk-mode\n```\n\u5982\u679c\u8981\u5728\u522a\u9664 TPU \u865b\u64ec\u6a5f\u6642\u522a\u9664 Persistent Disk\uff0c\u5247\u9700\u8981\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u8a2d\u7f6e Persistent Disk \u7684\u81ea\u52d5\u522a\u9664\u72c0\u614b\uff1a\n**\u91cd\u8981\u63d0\u793a** \uff1a\u60a8\u5fc5\u9808\u5f9e\u672c\u5730 Cloud Shell\uff08\u800c\u4e0d\u662f\u5728 TPU \u865b\u64ec\u6a5f\u4e2d\uff09\u904b\u884c `gcloud compute instances set-disk-auto-delete` \u547d\u4ee4\u3002\n```\n$ gcloud compute instances set-disk-auto-delete vm-instance \\\u00a0 --zone=zone \\\u00a0 --auto-delete \\\u00a0 --disk=disk-name\n```\u5982\u679c\u60a8\u7684\u865b\u64ec\u6a5f\u7531\u65bc\u4efb\u4f55\u539f\u56e0\u95dc\u9589\uff0c\u5247 Persistent Disk \u53ef\u80fd\u6703\u65b7\u958b\u9023\u63a5\u3002\u8acb\u53c3\u95b1 [\u914d\u7f6e\u7cfb\u7d71\u91cd\u5553\u6642\u81ea\u52d5\u88dd\u8f09](https://cloud.google.com/compute/docs/disks/format-mount-disk-linux?hl=zh-cn#configure_automatic_mounting_on_vm_restart) \uff0c\u4ee5\u4fbf\u5728\u865b\u64ec\u6a5f\u91cd\u5553\u6642\u81ea\u52d5\u88dd\u8f09 Persistent Disk\u3002\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u81ea\u52d5\u522a\u9664 Persistent Disk\uff0c\u8acb\u53c3\u95b1 [\u4fee\u6539\u6c38\u4e45\u6027\u78c1\u76e4](https://cloud.google.com/compute/docs/disks/modify-persistent-disk?hl=zh-cn) \u3002\n### \u88dd\u8f09 Persistent Disk\n\u7232\u4e86\u5f9e TPU \u865b\u64ec\u6a5f\u8a2a\u554f Persistent Disk\uff0c\u60a8\u5fc5\u9808\u88dd\u8f09\u78c1\u76e4\u3002\u6b64\u5b57\u6bb5\u6307\u5b9a TPU \u865b\u64ec\u6a5f\u6587\u4ef6\u7cfb\u7d71\u4e2d\u53ef\u4ee5\u8a2a\u554f Persistent Disk \u7684\u4f4d\u7f6e\u3002\n- \u4f7f\u7528 SSH \u9023\u63a5\u5230\u60a8\u7684 TPU \u865b\u64ec\u6a5f\uff1a```\n$ gcloud compute tpus tpu-vm ssh tpu-name --zone zone\n```\u4f7f\u7528 TPU Pod \u6642\uff0cPod \u4e2d\u7684\u6bcf\u500b TPU \u90fd\u6709\u4e00\u500b TPU \u865b\u64ec\u6a5f\u3002\u4e0a\u8ff0\u547d\u4ee4\u5c07\u540c\u6642\u9069\u7528\u65bc TPU \u8a2d\u5099\u548c TPU Pod\u3002\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f TPU Pod\uff0c\u5247\u6b64\u547d\u4ee4\u6703\u5c07\u60a8\u9023\u63a5\u5230 Pod \u4e2d\u7684\u7b2c\u4e00\u500b TPU\uff08\u4e5f\u7a31\u7232\u5de5\u4f5c\u5668 0\uff09\u3002\n- \u5728 TPU \u865b\u64ec\u6a5f\u4e2d\uff0c\u5217\u51fa\u639b\u63a5\u5230 TPU \u865b\u64ec\u6a5f\u7684\u78c1\u76e4\uff1a```\n(vm)$ sudo lsblk\n````lsblk` \u547d\u4ee4\u7684\u8f38\u51fa\u61c9\u5982\u4e0b\u6240\u793a\uff1a```\nNAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT\nloop0  7:0 0 55.5M 1 loop /snap/core18/1997\nloop1  7:1 0 67.6M 1 loop /snap/lxd/20326\nloop2  7:2 0 32.3M 1 loop /snap/snapd/11588\nloop3  7:3 0 32.1M 1 loop /snap/snapd/11841\nloop4  7:4 0 55.4M 1 loop /snap/core18/2066\nsda  8:0 0 300G 0 disk\n\u251c\u2500sda1 8:1 0 299.9G 0 part /\n\u251c\u2500sda14 8:14 0  4M 0 part\n\u2514\u2500sda15 8:15 0 106M 0 part /boot/efi\nsdb  8:16 0 10G 0 disk <== Persistent Disk\n```\u5728\u6b64\u793a\u4f8b\u4e2d\uff0c `sda` \u662f\u5553\u52d5\u78c1\u76e4\uff0c `sdb` \u662f\u65b0\u639b\u63a5\u7684 Persistent Disk \u7684\u540d\u7a31\u3002\u639b\u63a5\u7684 Persistent Disk \u7684\u540d\u7a31\u53d6\u6c7a\u65bc\u639b\u63a5\u5230\u865b\u64ec\u6a5f\u7684\u6c38\u4e45\u6027\u78c1\u76e4\u7684\u6578\u91cf\u3002\u4f7f\u7528 TPU Pod \u6642\uff0c\u60a8\u9700\u8981\u5728 Pod \u4e2d\u7684\u6240\u6709 TPU \u865b\u64ec\u6a5f\u4e0a\u88dd\u8f09 Persistent Disk\u3002\u6240\u6709 TPU \u865b\u64ec\u6a5f\u7684 Persistent Disk \u540d\u7a31\u90fd\u61c9\u76f8\u540c\uff0c\u4f46\u4e0d\u4fdd\u8b49\u4e00\u5b9a\u5982\u6b64\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u5206\u96e2\u7136\u5f8c\u91cd\u65b0\u639b\u63a5 Persistent Disk\uff0c\u8a2d\u5099\u540d\u7a31\u5c07\u905e\u589e\uff0c\u5f9e `sdb` \u66f4\u6539\u7232 `sdc` \uff0c\u4f9d\u6b64\u985e\u63a8\u3002\n- \u5982\u679c\u78c1\u76e4\u5c1a\u672a\u683c\u5f0f\u5316\uff0c\u8acb\u7acb\u5373\u683c\u5f0f\u5316\u639b\u63a5\u7684 Persistent Disk\uff1a **\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u5c07 Persistent Disk \u639b\u63a5\u5230 TPU Pod\uff0c\u5247\u8a72\u78c1\u76e4\u5fc5\u9808\u5df2\u9032\u884c\u683c\u5f0f\u5316\uff0c\u56e0\u7232\u5b83\u4ee5\u53ea\u8b80\u5377\u7684\u5f62\u5f0f\u639b\u63a5\u3002```\n(vm)$ sudo mkfs.ext4 -m 0 -E lazy_itable_init=0,lazy_journal_init=0,discard /dev/sdb\n```\n- \u5275\u5efa\u4e00\u500b\u7528\u65bc\u88dd\u8f09 Persistent Disk \u7684\u76ee\u9304\uff1a\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f TPU \u8a2d\u5099\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u5275\u5efa\u4e00\u500b\u76ee\u9304\u4f86\u88dd\u8f09 Persistent Disk\uff1a```\n(vm)$ sudo mkdir -p /mnt/disks/persist\n```\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f TPU Pod\uff0c\u8acb\u5728 TPU \u865b\u64ec\u6a5f\u5916\u90e8\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u3002\u9019\u5c07\u5728 Pod \u4e2d\u7684\u6240\u6709 TPU \u865b\u64ec\u6a5f\u4e0a\u5275\u5efa\u76ee\u9304\u3002```\n(vm)$ gcloud compute tpus tpu-vm ssh $TPU_NAME --worker=all --command=\"sudo mkdir -p /mnt/disks/persist\"\n```\n- \u88dd\u8f09 Persistent Disk\uff1a\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f TPU \u8a2d\u5099\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5728 TPU \u865b\u64ec\u6a5f\u4e0a\u88dd\u8f09 Persistent Disk\u3002```\n(vm)$ sudo mount -o discard,defaults /dev/sdb /mnt/disks/persist\n```\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f TPU Pod\uff0c\u8acb\u5728 TPU \u865b\u64ec\u6a5f\u5916\u90e8\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u3002\u5b83\u6703\u5728\u60a8\u7684 Pod \u4e2d\u7684\u6240\u6709 TPU \u865b\u64ec\u6a5f\u4e0a\u88dd\u8f09 Persistent Disk\u3002```\n(vm)$ gcloud compute tpus tpu-vm ssh $TPU_NAME --worker=all --command=\"sudo mount -o discard,defaults /dev/sdb /mnt/disks/persist\"\n```## \u6e05\u7406\n\u4f7f\u7528\u5b8c TPU \u8cc7\u6e90\u5f8c\u5c07\u5176\u522a\u9664\u3002\n- \u65b7\u958b\u8207 Compute Engine \u5be6\u4f8b\u7684\u9023\u63a5\uff08\u5982\u679c\u60a8\u5c1a\u672a\u9019\u6a23\u505a\uff09\uff1a```\n(vm)$ exit\n```\u60a8\u7684\u63d0\u793a\u7b26\u73fe\u5728\u61c9\u7232 `username@projectname` \uff0c\u8868\u660e\u60a8\u4f4d\u65bc Cloud Shell \u4e2d\u3002\n- \u522a\u9664\u60a8\u7684 Cloud TPU \u548c Compute Engine \u8cc7\u6e90\u3002```\n$ gcloud compute tpus tpu-vm delete tpu-name \\\u00a0--zone=zone\n```\n- \u901a\u904e\u904b\u884c `gcloud list` \u9a57\u8b49\u8cc7\u6e90\u662f\u5426\u5df2\u522a\u9664\u3002\u522a\u9664\u64cd\u4f5c\u53ef\u80fd\u9700\u8981\u5e7e\u5206\u9418\u6642\u9593\u624d\u80fd\u5b8c\u6210\u3002 `gcloud list` \u7684\u8f38\u51fa\u4e0d\u61c9\u986f\u793a\u6b64\u904e\u7a0b\u5275\u5efa\u7684\u4efb\u4f55 TPU \u865b\u64ec\u6a5f\u8cc7\u6e90\u3002\n```\n$ gcloud compute tpus tpu-vm list --zone=zone\n```\n```\n$ gcloud compute tpus execution-groups list --zone zone\n```\n- \u901a\u904e\u5217\u51fa\u60a8\u5275\u5efa Persistent Disk \u7684\u5730\u5340\u4e2d\u7684\u6240\u6709\u78c1\u76e4\uff0c\u9a57\u8b49\u5728\u522a\u9664 TPU \u865b\u64ec\u6a5f\u6642\u662f\u5426\u81ea\u52d5\u522a\u9664\u4e86 Persistent Disk\uff1a```\n$ gcloud compute disks list --filter=\"zone:( us-central1-b )\"\n```\u5982\u679c\u5728\u522a\u9664 TPU \u865b\u64ec\u6a5f\u6642\u672a\u522a\u9664 Persistent Disk\uff0c\u8acb\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5c07\u5176\u522a\u9664\uff1a```\n$ gcloud compute disks delete disk-name \\--zone zone\n```", "guide": "Cloud TPU"}