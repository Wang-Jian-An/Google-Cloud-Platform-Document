{"title": "Cloud TPU - \u5c07 TPU \u9023\u63a5\u5230\u5171\u4eab VPC \u7db2\u7d61", "url": "https://cloud.google.com/tpu/docs/shared-vpc-networks?hl=zh-cn", "abstract": "# Cloud TPU - \u5c07 TPU \u9023\u63a5\u5230\u5171\u4eab VPC \u7db2\u7d61\n# \u5c07 TPU \u9023\u63a5\u5230\u5171\u4eab VPC \u7db2\u7d61\n**\u91cd\u8981\u63d0\u793a** \uff1a\u672c\u6307\u5357\u4ecb\u7d39\u5982\u4f55\u8a2d\u7f6e\u4f7f\u7528\u96c6\u4e2d\u7ba1\u7406\u7684 [\u5171\u4eab VPC \u7db2\u7d61](https://cloud.google.com/vpc/docs/overview?hl=zh-cn) \u7684 Cloud TPU\u3002\u672c\u6587\u6a94\u5047\u5b9a\u60a8\u719f\u6089 VPC \u4e26\u5df2\u5275\u5efa\u4e00\u500b\u5171\u4eab VPC\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u5275\u5efa\u548c\u7ba1\u7406\u5171\u4eab VPC \u7db2\u7d61\uff0c\u8acb\u53c3\u95b1 [\u5275\u5efa\u548c\u4fee\u6539 VPC \u7db2\u7d61](https://cloud.google.com/vpc/docs/create-modify-vpc-networks?hl=zh-cn) \u3002\n\u5c07 TPU \u4e3b\u6a5f\u9023\u63a5\u5230\u5171\u4eab VPC \u7684\u65b9\u5f0f\u53d6\u6c7a\u65bc\u60a8\u4f7f\u7528\u7684 TPU \u67b6\u69cb\uff08TPU \u865b\u64ec\u6a5f\u6216 TPU \u7bc0\u9ede\uff09\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3 TPU \u67b6\u69cb\uff0c\u8acb\u53c3\u95b1 [TPU \u7cfb\u7d71\u67b6\u69cb](https://cloud.google.com/tpu/docs/system-architecture-tpu-vm?hl=zh-cn) \u3002\n", "content": "## \u5c07 TPU \u865b\u64ec\u6a5f\u9023\u63a5\u5230\u5171\u4eab VPC \u7db2\u7d61\n### \u914d\u7f6e VPC \u5bbf\u4e3b\u9805\u76ee\n\u4f7f\u7528 TPU \u865b\u64ec\u6a5f\u67b6\u69cb\u6642\uff0c\u60a8\u9700\u8981\u5411 [\u670d\u52d9\u9805\u76ee](https://cloud.google.com/vpc/docs/shared-vpc?hl=zh-cn#concepts_and_terminology) \u4e2d\u7684 TPU \u670d\u52d9\u5e33\u865f\u6388\u4e88\u7ba1\u7406 [\u5bbf\u4e3b\u9805\u76ee](https://cloud.google.com/vpc/docs/shared-vpc?hl=zh-cn#concepts_and_terminology) \u4e2d\u7684\u8cc7\u6e90\u7684\u6b0a\u9650\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u201cTPU \u5171\u4eab VPC \u4ee3\u7406\u201d( `roles/tpu.xpnAgent` ) \u89d2\u8272\u57f7\u884c\u6b64\u64cd\u4f5c\u3002\u904b\u884c\u4ee5\u4e0b gcloud \u547d\u4ee4\u4ee5\u6388\u4e88\u6b64\u89d2\u8272\u7d81\u5b9a\u3002\n```\ngcloud projects add-iam-policy-binding host-project-id \\--member=serviceAccount:service-your-service-project-number@gcp-sa-tpu.iam.gserviceaccount.com \\--role=roles/tpu.xpnAgent\n```\n**\u6ce8\u610f** \uff1a\u60a8\u53ef\u4ee5\u5728 [Google Cloud \u63a7\u5236\u6aaf](https://console.cloud.google.com/?hl=zh-cn) \u4fe1\u606f\u4e2d\u5fc3\u7684\u9805\u76ee\u4fe1\u606f\u90e8\u5206\u627e\u5230\u60a8\u7684\u670d\u52d9\u9805\u76ee\u7de8\u865f\u3002\n### \u5275\u5efa\u9023\u63a5\u5230\u5171\u4eab VPC \u7db2\u7d61\u7684 TPU \u865b\u64ec\u6a5f\n\u9996\u5148\u78ba\u5b9a\u53ef\u7528\u5340\u4e2d\u53ef\u7528\u7684\u52a0\u901f\u5668\u985e\u578b\u548c\u7248\u672c\n```\ngcloud compute tpus accelerator-types list --zone zone\n```\n```\ngcloud compute tpus versions list --zone zone\n```\n\u5275\u5efa TPU \u6642\uff0c\u60a8\u9700\u8981\u5c07 TPU \u865b\u64ec\u6a5f\u9023\u63a5\u5230\u5171\u4eab VPC \u7db2\u7d61\u3002\u8acb\u4f7f\u7528 `--network` \u6a19\u8a18\u6307\u5b9a\u60a8\u7684\u5171\u4eab VPC\uff1a\n```\ngcloud compute tpus tpu-vm create tpu-name \\--zone zone \\--accelerator-type accelerator-type \\--network projects/host-project-id/global/networks/host-network \\--version runtime-version \\--project your-service-project-id\n```\n**\u6ce8\u610f** \uff1a `--network` \u6a19\u8a18\u5fc5\u9808\u8a2d\u7f6e\u7232\u5b8c\u5168\u9650\u5b9a\u7684\u7db2\u7d61\u540d\u7a31\u3002\u4f8b\u5982 `projects/&lt;my-host-project-id&gt;/global/networks/&lt;my-network&gt;` \u3002\n\u60a8\u53ef\u4ee5\u4f7f\u7528 `gcloud compute tpus tpu-vm describe` \u547d\u4ee4\u9a57\u8b49\u60a8\u7684 TPU \u865b\u64ec\u6a5f\u662f\u5426\u5df2\u9023\u63a5\u5230\u60a8\u7684\u5171\u4eab VPC\uff1a\n```\n$ gcloud compute tpus tpu-vm describe tpu-name --zone zone\n```\n\u97ff\u61c9\u5305\u542b\u60a8\u7684 TPU \u865b\u64ec\u6a5f\u9023\u63a5\u5230\u7684\u7db2\u7d61\uff1a\n```\nacceleratorType: v3-8\napiVersion: V2\ncidrBlock: 10.128.0.0/20\ncreateTime: '2022-06-17T21:32:13.859274143Z'\nhealth: HEALTHY\nid: '0000000000000000000'\nname: projects/my-project/locations/us-central1-b/nodes/my-tpu\nnetworkConfig:\n enableExternalIps: true\n network: projects/my-project/global/networks/default\n subnetwork: projects/my-project/regions/us-central1/subnetworks/default\nnetworkEndpoints:\n- accessConfig:\n externalIp: 000.000.000.000\n ipAddress: 10.128.0.104\n port: 8470\nruntimeVersion: tpu-vm-tf-2.8.0\nschedulingConfig: {}\nserviceAccount:\n email: 00000000000-compute@developer.gserviceaccount.com\n scope:\n - https://www.googleapis.com/auth/devstorage.read_write\n - https://www.googleapis.com/auth/logging.write\n - https://www.googleapis.com/auth/service.management\n - https://www.googleapis.com/auth/servicecontrol\n - https://www.googleapis.com/auth/cloud-platform\n - https://www.googleapis.com/auth/pubsub\nshieldedInstanceConfig: {}\nstate: READY\n```\n### \u522a\u9664 TPU \u865b\u64ec\u6a5f\n\u4f7f\u7528\u5b8c TPU \u865b\u64ec\u6a5f\u5f8c\uff0c\u8acb\u52d9\u5fc5\u5c07\u5176\u522a\u9664\u3002\n```\ngcloud compute tpus tpu-vm delete tpu-name \\--zone zone \\\n```\n## \u5c07 TPU \u7bc0\u9ede\u9023\u63a5\u5230\u5171\u4eab VPC\n### \u914d\u7f6e Private Services Access\n\u5728\u5c07 TPU \u7bc0\u9ede\u8207\u5171\u4eab VPC \u914d\u5408\u4f7f\u7528\u4e4b\u524d\uff0c\u60a8\u9700\u8981 [\u5efa\u7acb\u5c08\u7528\u670d\u52d9\u8a2a\u554f\u901a\u9053\u9023\u63a5](https://cloud.google.com/vpc/docs/configure-private-services-access?hl=zh-cn) \u3002\n- \u4f7f\u7528\u4ee5\u4e0b Google Cloud CLI \u547d\u4ee4\u5553\u7528 Service Networking API\u3002\u6bcf\u500b Cloud Platform \u9805\u76ee\u53ea\u9700\u57f7\u884c\u4e00\u6b21\u6b64\u64cd\u4f5c\u3002```\ngcloud services enable servicenetworking.googleapis.com\n```\n- [\u5206\u914d\u4e00\u500b\u9810\u7559\u5730\u5740\u7bc4\u570d](https://cloud.google.com/sdk/gcloud/reference/compute/addresses/create?hl=zh-cn) \uff0c\u4ee5\u4f9b Service Networking \u4f7f\u7528\u3002 `prefix-length` \u4e0d\u5f97\u8d85\u904e 24\u3002\u4f8b\u5982\uff1a```\ngcloud compute addresses create sn-range-1 --global \\--addresses=10.110.0.0 \\--prefix-length=16 \\--purpose=VPC_PEERING \\--network=network-name\n```\n- \u5efa\u7acb\u5c08\u7528\u670d\u52d9\u8a2a\u554f\u9023\u63a5\u3002```\n$ gcloud services vpc-peerings connect --service=servicenetworking.googleapis.com \\--ranges=sn-range-1 \\--network=network-name\n```\n- \u9a57\u8b49\u5df2\u5275\u5efa VPC \u5c0d\u7b49\u4e92\u9023\u3002\u4ee5\u4e0b\u547d\u4ee4\u53ef\u4ee5\u5217\u51fa\u6307\u5b9a\u7db2\u7d61\u7684\u6240\u6709 VPC \u5c0d\u7b49\u4e92\u9023\u3002```\ngcloud services vpc-peerings list --network=network-name\n```\n### \u5c07 TPU \u7bc0\u9ede\u9023\u63a5\u5230\u5171\u4eab VPC \u7db2\u7d61\n\u5275\u5efa TPU \u6642\uff0c\u60a8\u9700\u8981\u5c07 TPU \u7bc0\u9ede\u9023\u63a5\u5230\u5171\u4eab VPC \u7db2\u7d61\u3002\u8acb\u4f7f\u7528 `--network` \u6a19\u8a18\u6307\u5b9a\u60a8\u7684\u5171\u4eab VPC\uff1a\n```\n$ gcloud compute tpus execution-groups create \\\u00a0 --name=tpu-name \\\u00a0 --zone=zone \\\u00a0 --tf-version=2.12.0 \\\u00a0 --machine-type=n1-standard-1 \\\u00a0 --accelerator-type=v3-8 \\\u00a0 --network=network-name\n```\n**\u6ce8\u610f** \uff1a `--network` \u6a19\u8a18\u5fc5\u9808\u8a2d\u7f6e\u7232\u5b8c\u5168\u9650\u5b9a\u7684\u7db2\u7d61\u540d\u7a31\u3002\u4f8b\u5982 `projects/my-host-project-id/global/networks/my-network` \u3002\n### \u6aa2\u7d22\u7279\u5b9a TPU \u7bc0\u9ede\u7684\u76f8\u95dc\u4fe1\u606f\n```\n$ gcloud compute tpus describe tpu-name --zone zone\n```\n**\u6ce8\u610f** \uff1a\u5c07 `--zone` \u8a2d\u7f6e\u7232\u60a8\u5275\u5efa TPU \u865b\u64ec\u6a5f\u7684\u5730\u5340\u3002\n\u97ff\u61c9\u5305\u542b\u4ee5\u4e0b\u4fe1\u606f\uff1a\n```\nacceleratorType: v3-8\napiVersion: V1\ncidrBlock: 00.0.000.000/29\ncreateTime: '2022-11-30T18:59:20.655858097Z'\nhealth: HEALTHY\nipAddress: 00.000.0.000\nname: projects/ml-writers/locations/us-central1-a/nodes/mikegre-vcp\nnetwork: global/networks/mikegre-vpc\nnetworkEndpoints:\n- ipAddress: 00.0.000.000\n port: 8470\nport: '8470'\nschedulingConfig: {}\nserviceAccount: service-00000000000@cloud-tpu.iam.gserviceaccount.com\nstate: READY\ntensorflowVersion: 2.10.0\n```\n### \u522a\u9664 TPU \u7bc0\u9ede\n\u4f7f\u7528\u5b8c TPU \u7bc0\u9ede\u5f8c\uff0c\u8acb\u52d9\u5fc5\u5c07\u5176\u522a\u9664\u3002\n```\n$ gcloud compute tpus execution-groups delete tpu-name \\\u00a0 --zone=zone\n```\n```\n\u00a0 \u00a0$ gcloud compute networks peerings list --network=network-name\u00a0 \u00a0\n```\n- \u522a\u9664 VPC \u5c0d\u7b49\u4e92\u9023\u3002```\n$ gcloud compute networks peerings delete peering-name --network=network-name\n```", "guide": "Cloud TPU"}