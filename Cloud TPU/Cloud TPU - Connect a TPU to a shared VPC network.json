{"title": "Cloud TPU - Connect a TPU to a shared VPC network", "url": "https://cloud.google.com/tpu/docs/shared-vpc-networks", "abstract": "# Cloud TPU - Connect a TPU to a shared VPC network\n# Connect a TPU to a shared VPC network\n**Important:** This guide explains how to set up Cloud TPUs that use a centrally managed [Shared VPC network](https://cloud.google.com/vpc/docs/overview) . This document assumes you are familiar with VPCs and have created a shared VPC. For more information on how to create and manage Shared VPC networks, see [Create and modify VPC networks](https://cloud.google.com/vpc/docs/create-modify-vpc-networks) .\nHow you connect a TPU host to a Shared VPC depends upon which TPU architecture (TPU VM or TPU Node) you are using. For more information about TPU architectures, see [TPU System Architecture](/tpu/docs/system-architecture-tpu-vm) .\n", "content": "## Connect a TPU VM to a Shared VPC Network\n### Configure a VPC host project\nWhen you use the TPU VM architecture, you need to grant the TPU Service Account in your [service project](/vpc/docs/shared-vpc#concepts_and_terminology) permissions to manage resources in the [host project](/vpc/docs/shared-vpc#concepts_and_terminology) . You do this using the \"TPU Shared VPC Agent\" ( `roles/tpu.xpnAgent` ) role. Run the following gcloud commands to grant this role binding.\n```\ngcloud projects add-iam-policy-binding host-project-id \\--member=serviceAccount:service-your-service-project-number@gcp-sa-tpu.iam.gserviceaccount.com \\--role=roles/tpu.xpnAgent \n```\n**Note:** You can find your service project number in the project info section of the [Google Cloud console](https://console.cloud.google.com/) dashboard.\n### Create a TPU VM connected to a Shared VPC Network\nFirst determine which accelerator types and versions are available in the zone\n```\ngcloud compute tpus accelerator-types list --zone zone\n```\n```\ngcloud compute tpus versions list --zone zone\n```\nYou connect a TPU VM to a shared VPC network when you create your TPU. Specify your shared VPC using the `--network` tag:\n```\ngcloud compute tpus tpu-vm create tpu-name \\--zone zone \\--accelerator-type accelerator-type \\--network projects/host-project-id/global/networks/host-network \\--version runtime-version \\--project your-service-project-id\n```\n**Note:** The `--network` tag must be set to the fully qualified network name. For example, `projects/&lt;my-host-project-id&gt;/global/networks/&lt;my-network&gt;` .\nYou can verify your TPU VM is connected to your shared VPC using the `gcloud compute tpus tpu-vm describe` command:\n```\n$ gcloud compute tpus tpu-vm describe tpu-name --zone zone\n```\nThe response includes the network to which your TPU VM is attached:\n```\nacceleratorType: v3-8\napiVersion: V2\ncidrBlock: 10.128.0.0/20\ncreateTime: '2022-06-17T21:32:13.859274143Z'\nhealth: HEALTHY\nid: '0000000000000000000'\nname: projects/my-project/locations/us-central1-b/nodes/my-tpu\nnetworkConfig:\n enableExternalIps: true\n network: projects/my-project/global/networks/default\n subnetwork: projects/my-project/regions/us-central1/subnetworks/default\nnetworkEndpoints:\n- accessConfig:\n externalIp: 000.000.000.000\n ipAddress: 10.128.0.104\n port: 8470\nruntimeVersion: tpu-vm-tf-2.8.0\nschedulingConfig: {}\nserviceAccount:\n email: 00000000000-compute@developer.gserviceaccount.com\n scope:\n - https://www.googleapis.com/auth/devstorage.read_write\n - https://www.googleapis.com/auth/logging.write\n - https://www.googleapis.com/auth/service.management\n - https://www.googleapis.com/auth/servicecontrol\n - https://www.googleapis.com/auth/cloud-platform\n - https://www.googleapis.com/auth/pubsub\nshieldedInstanceConfig: {}\nstate: READY\n```\n### Delete the TPU VM\nWhen you are done with the TPU VM, make sure to delete it.\n```\ngcloud compute tpus tpu-vm delete tpu-name \\--zone zone \\\n```\n## Connecting a TPU Node to a Shared VPC\n### Configure Private Service Access\nBefore you use TPU Nodes with Shared VPCs, you need to [establish a private service access connection](https://cloud.google.com/vpc/docs/configure-private-services-access) .\n- Enable the Service Networking API using the following Google Cloud CLI command. This only needs to be done once per Cloud Platform Project.```\ngcloud services enable servicenetworking.googleapis.com\n```\n- [Allocate a reserved address range](https://cloud.google.com/sdk/gcloud/reference/compute/addresses/create) for use by Service Networking. The `prefix-length` needs to be 24 or less. For example:```\ngcloud compute addresses create sn-range-1 --global \\--addresses=10.110.0.0 \\--prefix-length=16 \\--purpose=VPC_PEERING \\--network=network-name\n```\n- Establish a private service access connection.```\n$ gcloud services vpc-peerings connect --service=servicenetworking.googleapis.com \\--ranges=sn-range-1 \\--network=network-name\n```\n- Verify the VPC peering has been created. The following command lists all VPC peerings for the specified network.```\ngcloud services vpc-peerings list --network=network-name\n```\n### Connect a TPU Node with a Shared VPC Network\nYou connect a TPU Node to a shared VPC network when you create your TPU. Specify your shared VPC using the `--network` tag:\n```\n$ gcloud compute tpus execution-groups create \\\u00a0 --name=tpu-name \\\u00a0 --zone=zone \\\u00a0 --tf-version=2.12.0 \\\u00a0 --machine-type=n1-standard-1 \\\u00a0 --accelerator-type=v3-8 \\\u00a0 --network=network-name \n```\n**Note:** The `--network` tag must be set to the fully qualified network name. For example, `projects/my-host-project-id/global/networks/my-network` .\n### Retrieve information about a specific TPU Node\n```\n$ gcloud compute tpus describe tpu-name --zone zone\n```\n**Note:** Set `--zone` to the zone where you created the TPU VM.\nThe response contains the following information:\n```\nacceleratorType: v3-8\napiVersion: V1\ncidrBlock: 00.0.000.000/29\ncreateTime: '2022-11-30T18:59:20.655858097Z'\nhealth: HEALTHY\nipAddress: 00.000.0.000\nname: projects/ml-writers/locations/us-central1-a/nodes/mikegre-vcp\nnetwork: global/networks/mikegre-vpc\nnetworkEndpoints:\n- ipAddress: 00.0.000.000\n port: 8470\nport: '8470'\nschedulingConfig: {}\nserviceAccount: service-00000000000@cloud-tpu.iam.gserviceaccount.com\nstate: READY\ntensorflowVersion: 2.10.0\n```\n### Delete the TPU Node\nWhen you are done with the TPU Node, make sure to delete it.\n```\n$ gcloud compute tpus execution-groups delete tpu-name \\\u00a0 --zone=zone \n```\n```\n\u00a0 \u00a0$ gcloud compute networks peerings list --network=network-name\u00a0 \u00a0\n```\n- Delete a VPC peering.```\n$ gcloud compute networks peerings delete peering-name --network=network-name\n```", "guide": "Cloud TPU"}