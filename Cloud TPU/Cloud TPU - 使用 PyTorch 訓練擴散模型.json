{"title": "Cloud TPU - \u4f7f\u7528 PyTorch \u8a13\u7df4\u64f4\u6563\u6a21\u578b", "url": "https://cloud.google.com/tpu/docs/tutorials/diffusion-pytorch?hl=zh-cn", "abstract": "# Cloud TPU - \u4f7f\u7528 PyTorch \u8a13\u7df4\u64f4\u6563\u6a21\u578b\n\u672c\u6559\u7a0b\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528 PyTorch Lightning \u548c Pytorch XLA \u5728 TPU \u4e0a\u8a13\u7df4\u64f4\u6563\u6a21\u578b\u3002\n **\u8b66\u544a** \uff1a\u672c\u6a21\u578b\u4f7f\u7528\u7b2c\u4e09\u65b9\u6578\u64da\u96c6\u3002Google \u4e0d\u5c0d\u6b64\u6578\u64da\u96c6\u7684\u6709\u6548\u6027\u6216\u4efb\u4f55\u5176\u4ed6\u65b9\u9762\u63d0\u4f9b\u4efb\u4f55\u4ee3\u7406\u3001\u64d4\u4fdd\u6216\u5176\u4ed6\u4fdd\u8b49\u3002", "content": "## \u76ee\u6a19\n- \u5275\u5efa Cloud TPU\n- \u5b89\u88dd PyTorch Lightning\n- \u514b\u9686\u64f4\u6563\u4ee3\u78bc\u5eab\n- \u6e96\u5099 Imagenette \u6578\u64da\u96c6\n- \u904b\u884c\u8a13\u7df4\u8173\u672c\n## \u8cbb\u7528\nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728\u672c\u6587\u6a94\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Google Cloud \u7684\u4ee5\u4e0b\u6536\u8cbb\u7d44\u4ef6\uff1a- Compute Engine\n- Cloud TPU\n\u60a8\u53ef\u4f7f\u7528 [\u50f9\u683c\u8a08\u7b97\u5668](https://cloud.google.com/products/calculator?hl=zh-cn) \u6839\u64da\u60a8\u7684\u9810\u8a08\u4f7f\u7528\u60c5\u6cc1\u4f86\u4f30\u7b97\u8cbb\u7528\u3002 ## \u6e96\u5099\u5de5\u4f5c\u5728\u958b\u59cb\u5b78\u7fd2\u672c\u6559\u7a0b\u4e4b\u524d\uff0c\u8acb\u6aa2\u67e5\u60a8\u7684 Google Cloud \u9805\u76ee\u662f\u5426\u5df2\u6b63\u78ba\u8a2d\u7f6e\u3002- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- \u672c\u6f14\u793a\u4f7f\u7528 Google Cloud \u7684\u6536\u8cbb\u7d44\u4ef6\u3002\u8acb\u67e5\u770b [Cloud TPU \u50f9\u683c\u9801\u9762](https://cloud.google.com/tpu/docs/pricing?hl=zh-cn) \u4f30\u7b97\u60a8\u7684\u8cbb\u7528\u3002\u8acb\u52d9\u5fc5\u5728\u4f7f\u7528\u5b8c\u60a8\u5275\u5efa\u7684\u8cc7\u6e90\u4ee5\u5f8c [\u6e05\u7406](#clean_up) \u9019\u4e9b\u8cc7\u6e90\uff0c\u4ee5\u514d\u7522\u751f\u4e0d\u5fc5\u8981\u7684\u8cbb\u7528\u3002\n## \u5275\u5efa Cloud TPU\u4ee5\u4e0b\u8aaa\u660e\u9069\u7528\u65bc\u55ae\u4e3b\u6a5f\u548c\u591a\u4e3b\u6a5f TPU\u3002\u672c\u6559\u7a0b\u4f7f\u7528\u7684\u662f v4-128\uff0c\u4f46\u5b83\u9069\u7528\u65bc\u6240\u6709\u52a0\u901f\u5668\u5927\u5c0f\u3002\n\u8a2d\u7f6e\u4e00\u4e9b\u74b0\u5883\u8b8a\u91cf\uff0c\u4ee5\u4f7f\u547d\u4ee4\u66f4\u6613\u65bc\u4f7f\u7528\u3002\n```\nexport ZONE=us-central2-bexport PROJECT_ID=your-project-idexport ACCELERATOR_TYPE=v4-128export RUNTIME_VERSION=tpu-ubuntu2204-baseexport TPU_NAME=your_tpu_name\n```\n\u5275\u5efa Cloud TPU\u3002\n **\u6ce8\u610f** \uff1a\u5982\u679c\u7576\u524d\u6c92\u6709\u8db3\u5920\u7684\u5bb9\u91cf\u4f86\u5275\u5efa TPU Pod\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u5df2\u52a0\u5165\u968a\u5217\u7684\u8cc7\u6e90\u5c07\u8acb\u6c42\u52a0\u5165\u968a\u5217\u3002\u5df2\u52a0\u5165\u968a\u5217\u7684\u8cc7\u6e90\u53ef\u8b93\u60a8\u5728\u53ef\u7528\u6642\u7372\u5f97\u5bb9\u91cf\u3002\u5982\u9700\u4ee5\u6392\u968a\u8cc7\u6e90\u7684\u5f62\u5f0f\u8acb\u6c42 Cloud TPU \u8cc7\u6e90\uff0c\u8acb\u6539\u7528`gcloud alpha compute tpus queued-resources create`\u547d\u4ee4\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7ba1\u7406\u5df2\u52a0\u5165\u968a\u5217\u7684\u8cc7\u6e90](https://cloud.google.com/tpu/docs/queued-resources?hl=zh-cn) \u3002\n```\ngcloud compute tpus tpu-vm create ${TPU_NAME} \\--zone=${ZONE} \\--accelerator-type=${ACCELERATOR_TYPE} \\--version=${RUNTIME_VERSION} \\--subnetwork=tpusubnet\n```\n **\u6ce8\u610f** \uff1a\u4ee5\u4e0b\u547d\u4ee4\u6703\u540c\u6642\u5728\u6240\u6709 TPU \u865b\u64ec\u6a5f\u4e0a\u904b\u884c\u3002## \u5b89\u88dd\u6240\u9700\u7684\u8edf\u4ef6\n- \u5b89\u88dd\u6240\u9700\u7684\u8edf\u4ef6\u5305\u4ee5\u53ca PyTorch/XLA \u6700\u65b0\u7248\u672c v2.2.0\u3002```\ngcloud compute tpus tpu-vm ssh ${TPU_NAME} \\--zone=us-central2-b \\--worker=all \\--command=\"sudo apt-get update -y && sudo apt-get install libgl1 -ygit clone https://github.com/pytorch-tpu/stable-diffusion.gitcd stable-diffusionpip install -e .pip install https://github.com/Lightning-AI/lightning/archive/refs/heads/master.zip -Upip install clippip install torch~=2.2.0 torch_xla[tpu]~=2.2.0 torchvision -f https://storage.googleapis.com/libtpu-releases/index.html\"\n```\n- \u4fee\u5fa9\u4e86\u6e90\u6587\u4ef6\uff0c\u4ee5\u4fbf\u8207 Torch 2.2 \u53ca\u66f4\u9ad8\u7248\u672c\u517c\u5bb9\u3002```\ngcloud compute tpus tpu-vm ssh ${TPU_NAME} \\--zone=us-central2-b \\--worker=all \\--command=\"cd ~/stable-diffusion/sed -i \\'s/from torch._six import string_classes/string_classes = (str, bytes)/g\\' src/taming-transformers/taming/data/utils.pysed -i \\'s/trainer_kwargs\\\\[\\\"callbacks\\\"\\\\]/# trainer_kwargs\\\\[\\\"callbacks\\\"\\\\]/g\\' main_tpu.py\"\n```\n- \u4e0b\u8f09 Imagenette\uff08\u8f03\u5c0f\u7248\u672c\u7684 [Imagenet \u6578\u64da\u96c6](https://www.image-net.org/) \uff09\u4e26\u5c07\u5176\u79fb\u81f3\u9069\u7576\u7684\u76ee\u9304\u3002```\ngcloud compute tpus tpu-vm ssh ${TPU_NAME} \\--zone us-central2-b \\--worker=all \\--command=\"wget -nv https://s3.amazonaws.com/fast-ai-imageclas/imagenette2.tgztar -xf \u00a0imagenette2.tgzmkdir -p ~/.cache/autoencoders/data/ILSVRC2012_train/datamkdir -p ~/.cache/autoencoders/data/ILSVRC2012_validation/datamv imagenette2/train/* \u00a0~/.cache/autoencoders/data/ILSVRC2012_train/datamv imagenette2/val/* ~/.cache/autoencoders/data/ILSVRC2012_validation/data\"\n```\n- \u4e0b\u8f09\u7b2c\u4e00\u968e\u6bb5\u7684\u9810\u8a13\u7df4\u6a21\u578b\u3002```\ngcloud compute tpus tpu-vm ssh ${TPU_NAME} \\--zone us-central2-b \\--worker=all \\--command=\"cd ~/stable-diffusion/wget -nv -O models/first_stage_models/vq-f8/model.zip https://ommer-lab.com/files/latent-diffusion/vq-f8.zipcd \u00a0models/first_stage_models/vq-f8/unzip -o model.zip\"\n```\n## \u8a13\u7df4\u6a21\u578b\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u904b\u884c\u8a13\u7df4\uff1a\n```\ngcloud compute tpus tpu-vm ssh ${TPU_NAME} \\--zone us-central2-b \\--worker=all \\--command=\"python3 stable-diffusion/main_tpu.py --train --no-test --base=stable-diffusion/configs/latent-diffusion/cin-ldm-vq-f8-ss.yaml -- data.params.batch_size=32 lightning.trainer.max_epochs=5 model.params.first_stage_config.params.ckpt_path=stable-diffusion/models/first_stage_models/vq-f8/model.ckpt lightning.trainer.enable_checkpointing=False lightning.strategy.sync_module_states=False\"\n```\n## \u6e05\u7406\u4f7f\u7528\u60a8\u5275\u5efa\u7684\u8cc7\u6e90\u5f8c\uff0c\u8acb\u9032\u884c\u6e05\u7406\uff0c\u4ee5\u514d\u60a8\u7684\u8cec\u865f\u7522\u751f\u4e0d\u5fc5\u8981\u7684\u8cbb\u7528\uff1a\n\u4f7f\u7528 Google Cloud CLI \u522a\u9664 Cloud TPU \u8cc7\u6e90\u3002\n```\n\u00a0 $ \u00a0gcloud compute tpus delete diffusion-tutorial --zone=us-central2-b\u00a0 \n```## \u5f8c\u7e8c\u6b65\u9a5f\u8a66\u7528 PyTorch Colab\uff1a- [\u5728 Cloud TPU \u4e0a\u958b\u59cb\u4f7f\u7528 PyTorch](https://colab.sandbox.google.com/github/pytorch/xla/blob/master/contrib/colab/getting-started.ipynb?hl=zh-cn) \n- [\u5728 TPU \u4e0a\u8a13\u7df4 MNIST](https://colab.sandbox.google.com/github/pytorch/xla/blob/master/contrib/colab/mnist-training.ipynb?hl=zh-cn) \n- [\u4f7f\u7528 Cifar10 \u6578\u64da\u96c6\u5728 TPU \u4e0a\u8a13\u7df4 ResNet18](https://colab.sandbox.google.com/github/pytorch/xla/blob/master/contrib/colab/resnet18-training.ipynb?hl=zh-cn) \n- [\u4f7f\u7528\u9810\u8a13\u7df4\u7684 ResNet50 \u6a21\u578b\u9032\u884c\u63a8\u7406](https://colab.sandbox.google.com/github/pytorch/xla/blob/master/contrib/colab/resnet50-inference.ipynb?hl=zh-cn) \n- [\u5feb\u901f\u795e\u7d93\u98a8\u683c\u8f49\u79fb](https://colab.sandbox.google.com/github/pytorch/xla/blob/master/contrib/colab/style_transfer_inference.ipynb?hl=zh-cn) \n- [\u5728 Fashion MNIST \u4e0a\u4f7f\u7528\u591a\u6838\u5fc3\u8a13\u7df4 AlexNet](https://colab.sandbox.google.com/github/pytorch/xla/blob/master/contrib/colab/multi-core-alexnet-fashion-mnist.ipynb?hl=zh-cn) \n- [\u5728 Fashion MNIST \u4e0a\u4f7f\u7528\u55ae\u6838\u5fc3\u8a13\u7df4 AlexNet](https://colab.sandbox.google.com/github/pytorch/xla/blob/master/contrib/colab/single-core-alexnet-fashion-mnist.ipynb?hl=zh-cn)", "guide": "Cloud TPU"}