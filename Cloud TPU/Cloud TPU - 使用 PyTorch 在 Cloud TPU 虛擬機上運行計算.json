{"title": "Cloud TPU - \u4f7f\u7528 PyTorch \u5728 Cloud TPU \u865b\u64ec\u6a5f\u4e0a\u904b\u884c\u8a08\u7b97", "url": "https://cloud.google.com/tpu/docs/run-calculation-pytorch?hl=zh-cn", "abstract": "# Cloud TPU - \u4f7f\u7528 PyTorch \u5728 Cloud TPU \u865b\u64ec\u6a5f\u4e0a\u904b\u884c\u8a08\u7b97\n# \u4f7f\u7528 PyTorch \u5728 Cloud TPU \u865b\u64ec\u6a5f\u4e0a\u904b\u884c\u8a08\u7b97\n\u672c\u5feb\u901f\u5165\u9580\u4ecb\u7d39\u5982\u4f55\u5275\u5efa Cloud TPU\u3001\u5982\u4f55\u5b89\u88dd PyTorch\uff0c\u4ee5\u53ca\u5982\u4f55\u5728 Cloud TPU \u4e0a\u904b\u884c\u7c21\u55ae\u7684\u8a08\u7b97\u3002\u5982\u9700\u67e5\u770b\u6709\u95dc\u5982\u4f55\u5728 Cloud TPU \u4e0a\u8a13\u7df4\u6a21\u578b\u7684\u66f4\u6df1\u5165\u6559\u7a0b\uff0c\u8acb\u53c3\u95b1 [Cloud TPU PyTorch \u6559\u7a0b](https://cloud.google.com/tpu/docs/tutorials/pytorch-pod?hl=zh-cn) \u4e4b\u4e00\u3002\n", "content": "## \u6e96\u5099\u5de5\u4f5c\u5728\u6309\u7167\u672c\u5feb\u901f\u5165\u9580\u4e4b\u524d\uff0c\u60a8\u5fc5\u9808\u5275\u5efa Google Cloud Platform \u5e33\u865f\u3001\u5b89\u88dd Google Cloud CLI \u4e26\u914d\u7f6e `gcloud` \u547d\u4ee4\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u8a2d\u7f6e\u5e33\u865f\u548c Cloud TPU \u9805\u76ee](https://cloud.google.com/tpu/docs/setup-gcp-account?hl=zh-cn) \u3002## \u4f7f\u7528 gcloud \u5275\u5efa Cloud TPU **\u6ce8\u610f** \uff1a\u5982\u9700\u78ba\u5b9a\u5728\u5553\u52d5 TPU \u865b\u64ec\u6a5f\u6642\u8981\u6307\u5b9a\u54ea\u500b TPU \u8edf\u4ef6\u7248\u672c\uff0c\u8acb\u53c3\u95b1 [Cloud TPU \u8edf\u4ef6\u7248\u672c\u3002](https://cloud.google.com/tpu/docs/supported-tpu-versions?hl=zh-cn#tpu_software_versions) \n\u5982\u9700\u5728\u9ed8\u8a8d\u7528\u6236\u9805\u76ee\u3001\u7db2\u7d61\u548c\u8a08\u7b97/\u53ef\u7528\u5340\u4e2d\u5275\u5efa TPU \u865b\u64ec\u6a5f\uff0c\u8acb\u904b\u884c\uff1a\n```\n$ gcloud compute tpus tpu-vm create tpu-name \\\u00a0 \u00a0--zone=us-central1-b \\\u00a0 \u00a0--accelerator-type=v3-8 \\\u00a0 \u00a0--version=tpu-ubuntu2204-base\n```\u5275\u5efa TPU \u6642\uff0c\u5982\u679c\u8981\u6307\u5b9a\u9ed8\u8a8d\u7db2\u7d61\u548c\u5b50\u7db2\uff0c\u53ef\u4ee5\u50b3\u905e\u984d\u5916\u7684 `--network` \u548c `--subnetwork` \u6a19\u8a8c\u3002\u5982\u679c\u60a8\u4e0d\u60f3\u4f7f\u7528\u9ed8\u8a8d\u7db2\u7d61\uff0c\u5247\u5fc5\u9808\u50b3\u905e `--network` \u6a19\u8a8c\u3002 `--subnetwork` \u6a19\u8a8c\u662f\u53ef\u9078\u7684\uff0c\u53ef\u7528\u65bc\u7232\u60a8\u4f7f\u7528\u7684\u4efb\u4f55\u7db2\u7d61\uff08\u9ed8\u8a8d\u6216\u7528\u6236\u6307\u5b9a\u7684\u7db2\u7d61\uff09\u6307\u5b9a\u9ed8\u8a8d\u5b50\u7db2\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u9019\u4e9b\u6a19\u8a8c\uff0c\u8acb\u53c3\u95b1 `gcloud` [API \u53c3\u8003\u6587\u6a94](https://cloud.google.com/sdk/gcloud/reference/compute/tpus/tpu-vm/create?hl=zh-cn) \u3002\n **\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u6709\u591a\u500b\u9805\u76ee\uff0c\u5247\u5fc5\u9808\u4f7f\u7528 `--project` \u6a19\u8a8c\u6307\u5b9a\u9805\u76ee ID\u3002\n## \u9023\u63a5\u5230 Cloud TPU \u865b\u64ec\u6a5f\n```\n\u00a0 \u00a0$ gcloud compute tpus tpu-vm ssh tpu-name --zone=us-central1-b\n```\n## \u5728 TPU \u865b\u64ec\u6a5f\u4e0a\u5b89\u88dd PyTorch/XLA\n```\n\u00a0 \u00a0(vm)$ pip install torch~=2.2.0 torch_xla[tpu]~=2.2.0 torchvision -f https://storage.googleapis.com/libtpu-releases/index.html\u00a0 \u00a0\n```\n## \u8a2d\u7f6e TPU \u904b\u884c\u6642\u914d\u7f6e\u78ba\u4fdd PyTorch/XLA \u904b\u884c\u6642\u4f7f\u7528 TPU\u3002\n```\n\u00a0 \u00a0(vm) $ export PJRT_DEVICE=TPU\n```\n## \u57f7\u884c\u7c21\u55ae\u7684\u8a08\u7b97\uff1a\n- \u5728\u7576\u524d\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u7232 `tpu-test.py` \u7684\u6587\u4ef6\uff0c\u4e26\u5c07\u4ee5\u4e0b\u8173\u672c\u8907\u88fd\u7c98\u8cbc\u5230\u5176\u4e2d\u3002```\nimport torchimport torch_xla.core.xla_model as xmdev = xm.xla_device()t1 = torch.randn(3,3,device=dev)t2 = torch.randn(3,3,device=dev)print(t1 + t2)\n```\n- \u904b\u884c\u8173\u672c\uff1a```\n\u00a0 (vm)$ python3 tpu-test.py\n```\u8173\u672c\u7684\u8f38\u51fa\u986f\u793a\u8a08\u7b97\u7d50\u679c\uff1a```\ntensor([[-0.2121, \u00a01.5589, -0.6951],\u00a0 \u00a0 \u00a0 \u00a0 [-0.7886, -0.2022, \u00a00.9242],\u00a0 \u00a0 \u00a0 \u00a0 [ 0.8555, -1.8698, \u00a01.4333]], device='xla:1')\n```\n## \u6e05\u7406\u7232\u907f\u514d\u56e0\u672c\u9801\u4e2d\u4f7f\u7528\u7684\u8cc7\u6e90\u5c0e\u81f4\u60a8\u7684 Google Cloud \u8cec\u865f\u7522\u751f\u8cbb\u7528\uff0c\u8acb\u6309\u7167\u4ee5\u4e0b\u6b65\u9a5f\u64cd\u4f5c\u3002- \u65b7\u958b\u8207 Compute Engine \u5be6\u4f8b\u7684\u9023\u63a5\uff08\u5982\u679c\u60a8\u5c1a\u672a\u9019\u6a23\u505a\uff09\uff1a```\n(vm)$ exit\n```\u60a8\u7684\u63d0\u793a\u7b26\u73fe\u5728\u61c9\u7232 `username@projectname` \uff0c\u8868\u660e\u60a8\u4f4d\u65bc Cloud Shell \u4e2d\u3002\n- \u522a\u9664\u60a8\u7684 Cloud TPU\u3002```\n$ gcloud compute tpus tpu-vm delete tpu-name \\\u00a0 --zone=us-central1-b\n```\n\u6b64\u547d\u4ee4\u7684\u8f38\u51fa\u61c9\u78ba\u8a8d TPU \u5df2\u88ab\u522a\u9664\u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\u8a73\u7d30\u77ad\u89e3 Cloud TPU \u865b\u64ec\u6a5f\uff1a- [\u5728 TPU Pod \u5207\u7247\u4e0a\u904b\u884c PyTorch \u4ee3\u78bc](https://cloud.google.com/tpu/docs/pytorch-pods?hl=zh-cn) \n- [\u7ba1\u7406 TPU](https://cloud.google.com/tpu/docs/managing-tpus-tpu-vm?hl=zh-cn) \n- [Cloud TPU \u7cfb\u7d71\u67b6\u69cb](https://cloud.google.com/tpu/docs/system-architecture-tpu-vm?hl=zh-cn) \n- [PyTorch/XLA \u6587\u6a94](https://pytorch.org/xla/release/1.7/index.html)", "guide": "Cloud TPU"}