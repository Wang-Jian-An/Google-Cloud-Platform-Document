{"title": "Cloud TPU - \u5728 Cloud TPU \u4e0a\u8a13\u7df4 DLRM \u548c DCN (TF 2.x)", "url": "https://cloud.google.com/tpu/docs/tutorials/dlrm-dcn-2.x?hl=zh-cn", "abstract": "# Cloud TPU - \u5728 Cloud TPU \u4e0a\u8a13\u7df4 DLRM \u548c DCN (TF 2.x)\n\u672c\u6559\u7a0b\u4ecb\u7d39\u5982\u4f55\u8a13\u7df4 DLRM \u548c DCN v2 \u6392\u540d\u6a21\u578b\uff0c\u8a72\u6a21\u578b\u53ef\u7528\u65bc\u9ede\u64ca\u7387 (CTR) \u9810\u6e2c\u7b49\u4efb\u52d9\u3002\u8acb\u53c3\u95b1 [\u9032\u884c\u8a2d\u7f6e\u4ee5\u904b\u884c DLRM \u6216 DCN \u6a21\u578b](#run-model) \u4e2d\u7684\u8aaa\u660e\uff0c\u77ad\u89e3\u5982\u4f55\u8a2d\u7f6e\u53c3\u6578\u4ee5\u8a13\u7df4 DLRM \u6216 DCN v2 \u6392\u540d\u6a21\u578b\u3002\n\u6a21\u578b\u8f38\u5165\u662f\u6578\u503c\u7279\u5fb5\u548c\u5206\u985e\u7279\u5fb5\uff0c\u800c\u8f38\u51fa\u662f\u6a19\u91cf\uff08\u4f8b\u5982\u9ede\u64ca\u6982\u7387\uff09\u3002\u60a8\u53ef\u4ee5\u5728 Cloud TPU \u4e0a\u8a13\u7df4\u548c\u8a55\u4f30\u8a72\u6a21\u578b\u3002\u5c0d\u6df1\u5ea6\u7db2\u7d61 (MLP) \u800c\u8a00\uff0c\u6df1\u5ea6\u6392\u540d\u6a21\u578b\u5177\u6709\u5167\u5b58\u5bc6\u96c6\uff08\u5d4c\u5165\u8868/\u67e5\u8a62\uff09\u548c\u8a08\u7b97\u5bc6\u96c6\u7684\u7279\u5fb5\u3002TPU \u662f\u5c08\u9580\u91dd\u5c0d\u9019\u5169\u500b\u7279\u5fb5\u8a2d\u8a08\u7684\u3002\n\u8a72\u6a21\u578b\u5c07 TPUembedding \u5c64\u7528\u65bc\u5206\u985e\u7279\u5fb5\u3002TPU \u5d4c\u5165\u652f\u6301\u53ef\u5feb\u901f\u67e5\u8a62\u7684\u5927\u578b\u5d4c\u5165\u8868\uff0c\u5d4c\u5165\u8868\u7684\u5927\u5c0f\u96a8 TPU pod \u7684\u5927\u5c0f\u7dda\u6027\u64f4\u7e2e\u3002TPU v3-8 \u53ef\u4f7f\u7528\u591a\u9054 90 GB \u7684\u5d4c\u5165\u8868\uff0cv3-512 Pod \u53ef\u4f7f\u7528 5.6 TB\uff0cv3-2048 TPU Pod \u53ef\u4f7f\u7528 22.4 TB\u3002\n\u6a21\u578b\u4ee3\u78bc\u4f4d\u65bc [TensorFlow Recommenders \u5eab](https://github.com/tensorflow/recommenders/tree/main/tensorflow_recommenders/experimental/models) \u4e2d\uff0c\u800c\u8f38\u5165\u6d41\u6c34\u7dda\u3001\u914d\u7f6e\u548c\u8a13\u7df4\u5faa\u74b0\u4f4d\u65bc [TensorFlow Model Garden](https://github.com/tensorflow/models/tree/master/official/recommendation/ranking) \u4e2d\u3002\n", "content": "## \u76ee\u6a19\n- \u8a2d\u7f6e\u8a13\u7df4\u74b0\u5883\n- \u4f7f\u7528\u5408\u6210\u6578\u64da\u904b\u884c\u8a13\u7df4\u4f5c\u696d\n- \u9a57\u8b49\u8f38\u51fa\u7d50\u679c\n## \u8cbb\u7528\nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728\u672c\u6587\u6a94\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Google Cloud \u7684\u4ee5\u4e0b\u6536\u8cbb\u7d44\u4ef6\uff1a- Compute Engine\n- Cloud TPU\n- Cloud Storage\n\u60a8\u53ef\u4f7f\u7528 [\u50f9\u683c\u8a08\u7b97\u5668](https://cloud.google.com/products/calculator?hl=zh-cn) \u6839\u64da\u60a8\u7684\u9810\u8a08\u4f7f\u7528\u60c5\u6cc1\u4f86\u4f30\u7b97\u8cbb\u7528\u3002 ## \u6e96\u5099\u5de5\u4f5c **\u91cd\u8981\u63d0\u793a** \uff1a\u60a8\u53ef\u4ee5\u5c07\u672c\u6559\u7a0b\u8207 TPU \u865b\u64ec\u6a5f\u6216 TPU \u7bc0\u9ede\u914d\u7f6e\u642d\u914d\u4f7f\u7528\u3002 [\u7cfb\u7d71\u67b6\u69cb](https://cloud.google.com/tpu/docs/system-architecture-tpu-vm?hl=zh-cn) \u4e2d\u4ecb\u7d39\u4e86\u9019\u5169\u7a2e\u865b\u64ec\u6a5f\u67b6\u69cb\u3002\u60a8\u4f7f\u7528\u7684 gcloud \u547d\u4ee4\u53d6\u6c7a\u65bc\u60a8\u4f7f\u7528\u7684 TPU \u914d\u7f6e\u3002\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u6bcf\u500b gcloud \u547d\u4ee4\u90fd\u986f\u793a\u5728\u6a19\u7c64\u5f0f\u90e8\u5206\u4e2d\u3002\u9078\u64c7\u60a8\u8981\u4f7f\u7528\u7684 TPU \u914d\u7f6e\u7684\u6a19\u7c64\u9801\uff0c\u7db2\u9801\u6703\u986f\u793a\u76f8\u61c9\u7684 gcloud \u547d\u4ee4\u3002\u9664\u975e\u60a8\u77e5\u9053\u9700\u8981\u4f7f\u7528 TPU \u7bc0\u9ede\uff0c\u5426\u5247\u6211\u5011\u5efa\u8b70\u60a8\u4f7f\u7528 TPU \u865b\u64ec\u6a5f\u3002\n\u5728\u958b\u59cb\u5b78\u7fd2\u672c\u6559\u7a0b\u4e4b\u524d\uff0c\u8acb\u6aa2\u67e5\u60a8\u7684 Google Cloud \u9805\u76ee\u662f\u5426\u5df2\u6b63\u78ba\u8a2d\u7f6e\u3002- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- \u672c\u6f14\u793a\u4f7f\u7528 Google Cloud \u7684\u6536\u8cbb\u7d44\u4ef6\u3002\u8acb\u67e5\u770b [Cloud TPU \u50f9\u683c\u9801\u9762](https://cloud.google.com/tpu/docs/pricing?hl=zh-cn) \u4f30\u7b97\u60a8\u7684\u8cbb\u7528\u3002\u8acb\u52d9\u5fc5\u5728\u4f7f\u7528\u5b8c\u60a8\u5275\u5efa\u7684\u8cc7\u6e90\u4ee5\u5f8c [\u6e05\u7406](#clean-up) \u9019\u4e9b\u8cc7\u6e90\uff0c\u4ee5\u514d\u7522\u751f\u4e0d\u5fc5\u8981\u7684\u8cbb\u7528\u3002\n## \u8a2d\u7f6e\u8cc7\u6e90\u672c\u90e8\u5206\u4ecb\u7d39\u5982\u4f55\u8a2d\u7f6e\u672c\u6559\u7a0b\u4f7f\u7528\u7684 Cloud Storage \u5b58\u5132\u6876\u3001\u865b\u64ec\u6a5f\u548c Cloud TPU \u8cc7\u6e90\u3002\n **\u91cd\u8981\u63d0\u793a ** \uff1a\u8acb\u5728\u540c\u4e00\u5340\u57df\u6216\u53ef\u7528\u5340\u4e2d\u8a2d\u7f6e\u6240\u6709\u8cc7\u6e90\uff08Compute Engine \u865b\u64ec\u6a5f\u3001Cloud TPU \u548c Cloud Storage \u5b58\u5132\u6876\uff09\uff0c\u4ee5\u6e1b\u5c11\u7db2\u7d61\u5ef6\u9072\u548c\u7db2\u7d61\u8cbb\u7528\u3002\u865b\u64ec\u6a5f\u548c TPU \u7bc0\u9ede\u4f4d\u65bc [\u7279\u5b9a\u5730\u5340](https://cloud.google.com/tpu/docs/types-zones?hl=zh-cn#types) \uff0c\u5373\u5340\u57df\u5167\u7684\u7d30\u5206\u3002- \u6253\u958b\u4e00\u500b Cloud Shell \u7a97\u53e3\u3002 [\u6253\u958b Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn) \n- \u7232\u9805\u76ee ID \u5275\u5efa\u4e00\u500b\u8b8a\u91cf\u3002```\nexport PROJECT_ID=project-id\n```\n- \u914d\u7f6e Google Cloud CLI \u4ee5\u4f7f\u7528\u8981\u5728\u5176\u4e2d\u5275\u5efa Cloud TPU \u7684\u9805\u76ee\u3002 **\u6ce8\u610f ** \uff1a\u5982\u9700\u8a73\u7d30\u77ad\u89e3`gcloud`\u547d\u4ee4\uff0c\u8acb\u53c3\u95b1 [Google Cloud CLI \u53c3\u8003\u6587\u6a94](https://cloud.google.com/sdk/gcloud/reference?hl=zh-cn) \u3002```\ngcloud config set project ${PROJECT_ID}\n```\u7576\u60a8\u7b2c\u4e00\u6b21\u5728\u65b0\u7684 Cloud Shell \u865b\u64ec\u6a5f\u4e2d\u904b\u884c\u6b64\u547d\u4ee4\u6642\uff0c\u7cfb\u7d71\u6703\u986f\u793a `Authorize Cloud Shell` \u9801\u9762\u3002\u9ede\u64ca\u9801\u9762\u5e95\u90e8\u7684 `Authorize` \uff0c\u4ee5\u5141\u8a31 `gcloud` \u4f7f\u7528\u60a8\u7684\u6191\u64da\u9032\u884c API \u8abf\u7528\u3002\n- \u7232 Cloud TPU \u9805\u76ee\u5275\u5efa\u670d\u52d9\u8cec\u865f\u3002```\ngcloud beta services identity create --service tpu.googleapis.com --project $PROJECT_ID\n```\u8a72\u547d\u4ee4\u5c07\u8fd4\u56de\u4ee5\u4e0b\u683c\u5f0f\u7684 Cloud TPU \u670d\u52d9\u8cec\u865f\uff1a```\nservice-PROJECT_NUMBER@cloud-tpu.iam.gserviceaccount.com\n```\n- \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5275\u5efa Cloud Storage \u5b58\u5132\u6876\uff0c\u5176\u4e2d `-l` \u9078\u9805\u6307\u5b9a\u61c9\u5275\u5efa\u5b58\u5132\u6876\u7684\u5340\u57df\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u53ef\u7528\u5340\u548c\u5340\u57df\uff0c\u8acb\u53c3\u95b1 [\u985e\u578b\u548c\u53ef\u7528\u5340](https://cloud.google.com/tpu/docs/types-zones?hl=zh-cn) \uff1a```\ngsutil mb -p ${PROJECT_ID} -c standard -l europe-west4 gs://bucket-name\n```\u6b64 Cloud Storage \u5b58\u5132\u6876\u5b58\u5132\u60a8\u7528\u65bc\u8a13\u7df4\u6a21\u578b\u7684\u6578\u64da\u548c\u8a13\u7df4\u7d50\u679c\u3002\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528\u7684 `gcloud compute tpus execution-groups` \u5de5\u5177\u6703\u7232\u60a8\u5728\u4e0a\u4e00\u6b65\u4e2d\u8a2d\u7f6e\u7684 Cloud TPU \u670d\u52d9\u8cec\u865f\u8a2d\u7f6e\u9ed8\u8a8d\u6b0a\u9650\u3002\u5982\u679c\u60a8\u9700\u8981\u66f4\u7cbe\u7d30\u7684\u6b0a\u9650\uff0c\u8acb\u67e5\u770b [\u8a2a\u554f\u7d1a\u5c64\u6b0a\u9650](https://cloud.google.com/tpu/docs/storage-buckets?hl=zh-cn) \u3002\u5b58\u5132\u6876\u4f4d\u7f6e\u5fc5\u9808\u8981\u8207 Compute Engine\uff08\u865b\u64ec\u6a5f\uff09\u548c Cloud TPU \u7bc0\u9ede\u4f4d\u65bc\u540c\u4e00\u5340\u57df\u3002\n- \u4f7f\u7528 `gcloud` \u547d\u4ee4\u5553\u52d5 Compute Engine \u865b\u64ec\u6a5f\u548c Cloud TPU\u3002 \u4f7f\u7528\u7684\u547d\u4ee4\u53d6\u6c7a\u65bc\u60a8\u4f7f\u7528\u7684\u662f TPU \u865b\u64ec\u6a5f\u9084\u662f TPU \u7bc0\u9ede\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u9019\u5169\u7a2e\u865b\u64ec\u6a5f\u67b6\u69cb\uff0c\u8acb\u53c3\u95b1 [\u7cfb\u7d71\u67b6\u69cb](https://cloud.google.com/tpu/docs/system-architecture-tpu-vm?hl=zh-cn) \u3002 \u5982\u9700\u8a73\u7d30\u77ad\u89e3 `gcloud` \u547d\u4ee4\uff0c\u8acb\u53c3\u95b1 [gcloud \u53c3\u8003\u6587\u6a94](https://cloud.google.com/sdk/gcloud/reference?hl=zh-cn) \u3002\n```\n$ gcloud compute tpus tpu-vm create dlrm-dcn-tutorial \\--zone=europe-west4-a \\--accelerator-type=v3-8 \\--version=tpu-vm-tf-2.15.0-se\n``````\n$ gcloud compute tpus execution-groups create \\--name=dlrm-dcn-tutorial \\--zone=europe-west4-a \\--disk-size=300 \\--machine-type=n1-standard-8 \\--tf-version=2.12.0\n``` **\u6ce8\u610f** \uff1a\u9996\u6b21\u5728\u9805\u76ee\u4e0a\u904b\u884c `gcloud compute tpus execution-groups` \u6642\uff0c\u7cfb\u7d71\u53ef\u80fd\u9700\u8981\u5e7e\u5206\u9418\u6642\u9593\u4f86\u57f7\u884c\u4e00\u4e9b\u5553\u52d5\u4efb\u52d9\uff0c\u4f8b\u5982 SSH \u5bc6\u9470\u50b3\u64ad\u548c API \u5553\u52d5\u3002\n- \u5982\u679c\u60a8\u672a\u81ea\u52d5\u767b\u9304 Compute Engine \u5be6\u4f8b\uff0c\u8acb\u901a\u904e\u904b\u884c\u4ee5\u4e0b `ssh` \u547d\u4ee4\u9032\u884c\u767b\u9304\u3002\u767b\u9304\u865b\u64ec\u6a5f\u5f8c\uff0cshell \u63d0\u793a\u7b26\u6703\u5f9e `username@projectname` \u66f4\u6539\u7232 `username@vm-name` \uff1a\n```\ngcloud compute tpus tpu-vm ssh dlrm-dcn-tutorial --zone=europe-west4-a\n```\n```\ngcloud compute ssh dlrm-dcn-tutorial --zone=europe-west4-a\n```\n\u5728\u60a8\u7e7c\u7e8c\u6309\u7167\u9019\u4e9b\u8aaa\u660e\u64cd\u4f5c\u6642\uff0c\u8acb\u5728\u865b\u64ec\u6a5f\u6703\u8a71\u7a97\u53e3\u4e2d\u904b\u884c\u4ee5 `(vm)$` \u958b\u982d\u7684\u6bcf\u500b\u547d\u4ee4\u3002\n## \u8a2d\u7f6e Cloud Storage \u5b58\u5132\u6876\u8b8a\u91cf\u8a2d\u7f6e\u4ee5\u4e0b\u74b0\u5883\u8b8a\u91cf\uff0c\u5c07 \u66ff\u63db\u7232 Cloud Storage \u5b58\u5132\u6876\u7684\u540d\u7a31\uff1a\n```\n(vm)$ export STORAGE_BUCKET=gs://bucket-name(vm)$ export PYTHONPATH=\"/usr/share/tpu/models/:${PYTHONPATH}\"(vm)$ export EXPERIMENT_NAME=dlrm-exp\n```\n\u7232 TPU \u540d\u7a31\u8a2d\u7f6e\u74b0\u5883\u8b8a\u91cf\u3002\n```\n(vm)$ export TPU_NAME=local\n```\n```\n(vm)$ export TPU_NAME=dlrm-dcn-tutorial\n```\u8a13\u7df4\u61c9\u7528\u9810\u671f\u80fd\u5920\u8a2a\u554f\u60a8\u5728 Cloud Storage \u4e2d\u7684\u8a13\u7df4\u6578\u64da\u3002\u5728\u8a13\u7df4\u671f\u9593\uff0c\u8a13\u7df4\u61c9\u7528\u9084\u6703\u4f7f\u7528\u60a8\u7684 Cloud Storage \u5b58\u5132\u6876\u4f86\u5b58\u5132\u6aa2\u67e5\u9ede\u3002## \u9032\u884c\u8a2d\u7f6e\u4ee5\u4f7f\u7528\u5408\u6210\u6578\u64da\u904b\u884c DLRM \u6216 DCN \u6a21\u578b\u8a72\u6a21\u578b\u53ef\u4ee5\u4f7f\u7528\u5404\u7a2e\u6578\u64da\u96c6\u9032\u884c\u8a13\u7df4\u3002\u6700\u5e38\u7528\u7684\u5169\u500b\u6578\u64da\u96c6\u662f [Criteo TB](https://labs.criteo.com/2013/12/download-terabyte-click-logs/) \u548c [Criteo Kaggle](https://labs.criteo.com/2014/02/kaggle-display-advertising-challenge-dataset/) \u3002\u672c\u6559\u7a0b\u901a\u904e\u8a2d\u7f6e\u6a19\u8a8c `use_synthetic_data=True` \u4f7f\u7528\u5408\u6210\u6578\u64da\u9032\u884c\u8a13\u7df4\u3002\n\u5408\u6210\u6578\u64da\u96c6\u50c5\u7528\u65bc\u77ad\u89e3\u5982\u4f55\u4f7f\u7528 Cloud TPU \u548c\u9a57\u8b49\u7aef\u5230\u7aef\u6027\u80fd\u3002\u6e96\u78ba\u7387\u6578\u5b57\u548c\u4fdd\u5b58\u7684\u6a21\u578b\u6c92\u6709\u610f\u7fa9\u3002\n\u8acb\u8a2a\u554f [Criteo Terabyte](https://labs.criteo.com/2013/12/download-terabyte-click-logs/) \u548c [Criteo Kaggle](https://labs.criteo.com/2014/02/kaggle-display-advertising-challenge-dataset/) \u7db2\u7ad9\uff0c\u77ad\u89e3\u5982\u4f55\u4e0b\u8f09\u548c [\u9810\u8655\u7406](https://github.com/tensorflow/models/tree/master/official/recommendation/ranking#preprocess-the-data) \u9019\u4e9b\u6578\u64da\u96c6\u3002\n **\u6ce8\u610f** \uff1a\u5982\u679c\u8981\u76e3\u63a7\u6a21\u578b\u7684\u8f38\u51fa\u548c\u6027\u80fd\uff0c\u8acb\u6309\u7167 [\u8a2d\u7f6e TensorBoard](https://cloud.google.com/tpu/docs/tensorboard-setup?hl=zh-cn) \u6307\u5357\u64cd\u4f5c\u3002\n- \u5b89\u88dd\u5fc5\u9700\u7684\u8edf\u4ef6\u5305\u3002```\n(vm)$ pip3 install tensorflow-recommenders(vm)$ pip3 install -r /usr/share/tpu/models/official/requirements.txt\n```\n- \u5207\u63db\u5230\u8173\u672c\u76ee\u9304\u3002\n```\n(vm)$ cd /usr/share/tpu/models/official/recommendation/ranking\n```\n```\n(vm)$ cd /usr/share/models/official/recommendation/ranking\n```\n- \u904b\u884c\u8a13\u7df4\u8173\u672c\u3002\u6b64\u8173\u672c\u4f7f\u7528\u985e\u4f3c\u65bc Criteo \u7684\u865b\u69cb\u6578\u64da\u96c6\u4f86\u8a13\u7df4 DLRM \u6a21\u578b\u3002\u8a13\u7df4\u5927\u7d04\u9700\u8981 20 \u5206\u9418\u3002 **\u6ce8\u610f** \uff1a\u5982\u9700\u8a13\u7df4 DLRM \u6a21\u578b\uff0c\u8acb\u4f7f\u7528\u9ede\u7a4d\u7279\u5fb5\u4ea4\u4e92\uff0c\u5373\u4ea4\u4e92\uff1a\u201c\u9ede\u201d\u3002\u5982\u9700\u8a13\u7df4 DCN v2 \u6a21\u578b\uff0c\u8acb\u4f7f\u7528\u201cInteraction\u201d\uff1a'cross'```\nexport EMBEDDING_DIM=32python3 train.py --mode=train_and_eval \\\u00a0 \u00a0 \u00a0--model_dir=${STORAGE_BUCKET}/model_dirs/${EXPERIMENT_NAME} --params_override=\"\u00a0 \u00a0 \u00a0runtime:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0distribution_strategy: 'tpu'\u00a0 \u00a0 \u00a0task:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0use_synthetic_data: true\u00a0 \u00a0 \u00a0 \u00a0 \u00a0train_data:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0input_path: '${DATA_DIR}/train/*'\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0global_batch_size: 16384\u00a0 \u00a0 \u00a0 \u00a0 \u00a0validation_data:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0input_path: '${DATA_DIR}/eval/*'\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0global_batch_size: 16384\u00a0 \u00a0 \u00a0 \u00a0 \u00a0model:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0num_dense_features: 13\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0bottom_mlp: [512,256,${EMBEDDING_DIM}]\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0embedding_dim: ${EMBEDDING_DIM}\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0top_mlp: [1024,1024,512,256,1]\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0interaction: 'dot'\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0vocab_sizes: [39884406, 39043, 17289, 7420, 20263, 3, 7120, 1543, 63,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a038532951, 2953546, 403346, 10, 2208, 11938, 155, 4, 976, 14,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a039979771, 25641295, 39664984, 585935, 12972, 108, 36]\u00a0 \u00a0 \u00a0trainer:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0use_orbit: false\u00a0 \u00a0 \u00a0 \u00a0 \u00a0validation_interval: 1000\u00a0 \u00a0 \u00a0 \u00a0 \u00a0checkpoint_interval: 1000\u00a0 \u00a0 \u00a0 \u00a0 \u00a0validation_steps: 500\u00a0 \u00a0 \u00a0 \u00a0 \u00a0train_steps: 1000\u00a0 \u00a0 \u00a0 \u00a0 \u00a0steps_per_loop: 1000\u00a0 \u00a0 \u00a0\"\n```\n\u6b64\u8a13\u7df4\u5728 v3-8 TPU \u4e0a\u904b\u884c\u5927\u7d04 10 \u5206\u9418\u3002\u5b8c\u6210\u5f8c\uff0c\u60a8\u5c07\u770b\u5230\u5982\u4e0b\u6240\u793a\u7684\u6d88\u606f\uff1a\n```\nI0621 21:32:58.519792 139675269142336 tpu_embedding_v2_utils.py:907] Done with log of TPUEmbeddingConfiguration.\nI0621 21:32:58.540874 139675269142336 tpu_embedding_v2.py:389] Done initializing TPU Embedding engine.\n1000/1000 [==============================] - 335s 335ms/step - auc: 0.7360 - accuracy: 0.6709 - prediction_mean: 0.4984\n- label_mean: 0.4976 - loss: 0.0734 - regularization_loss: 0.0000e+00 - total_loss: 0.0734 - val_auc: 0.7403\n- val_accuracy: 0.6745 - val_prediction_mean: 0.5065 - val_label_mean: 0.4976 - val_loss: 0.0749\n- val_regularization_loss: 0.0000e+00 - val_total_loss: 0.0749\nModel: \"ranking\"\n_________________________________________________________________\nLayer (type)     Output Shape    Param #\n=================================================================\ntpu_embedding (TPUEmbedding) multiple     1\n_________________________________________________________________\nmlp (MLP)     multiple     154944\n_________________________________________________________________\nmlp_1 (MLP)     multiple     2131969\n_________________________________________________________________\ndot_interaction (DotInteract multiple     0\n_________________________________________________________________\nranking_1 (Ranking)   multiple     0\n=================================================================\nTotal params: 2,286,914\nTrainable params: 2,286,914\nNon-trainable params: 0\n_________________________________________________________________\nI0621 21:43:54.977140 139675269142336 train.py:177] Train history: {'auc': [0.7359596490859985],\n'accuracy': [0.67094486951828], 'prediction_mean': [0.4983849823474884], 'label_mean': [0.4975697994232178],\n'loss': [0.07338511198759079], 'regularization_loss': [0], 'total_loss': [0.07338511198759079],\n'val_auc': [0.7402724623680115], 'val_accuracy': [0.6744520664215088], 'val_prediction_mean': [0.5064718723297119],\n'val_label_mean': [0.4975748658180237], 'val_loss': [0.07486172765493393],\n'val_regularization_loss': [0], 'val_total_loss': [0.07486172765493393]}\n```\n## \u6e05\u7406\u7232\u907f\u514d\u56e0\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528\u7684\u8cc7\u6e90\u5c0e\u81f4\u60a8\u7684 Google Cloud \u8cec\u865f\u7522\u751f\u8cbb\u7528\uff0c\u8acb\u522a\u9664\u5305\u542b\u9019\u4e9b\u8cc7\u6e90\u7684\u9805\u76ee\uff0c\u6216\u8005\u4fdd\u7559\u9805\u76ee\u4f46\u522a\u9664\u5404\u500b\u8cc7\u6e90\u3002- \u65b7\u958b\u8207 Compute Engine \u5be6\u4f8b\u7684\u9023\u63a5\uff08\u5982\u679c\u60a8\u5c1a\u672a\u9019\u6a23\u505a\uff09\uff1a```\n(vm)$ exit\n```\u60a8\u7684\u63d0\u793a\u7b26\u73fe\u5728\u61c9\u7232 `username@projectname` \uff0c\u8868\u660e\u60a8\u4f4d\u65bc Cloud Shell \u4e2d\u3002\n- \u522a\u9664\u60a8\u7684 Cloud TPU \u548c Compute Engine \u8cc7\u6e90\u3002 \u7528\u65bc\u522a\u9664\u8cc7\u6e90\u7684\u547d\u4ee4\u53d6\u6c7a\u65bc\u60a8\u4f7f\u7528\u7684\u662f TPU \u865b\u64ec\u6a5f\u9084\u662f TPU \u7bc0\u9ede\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7cfb\u7d71\u67b6\u69cb](https://cloud.google.com/tpu/docs/system-architecture-tpu-vm?hl=zh-cn) \u3002\n```\n$ gcloud compute tpus tpu-vm delete dlrm-dcn-tutorial \\--zone=europe-west4-a\n```\n```\n$ gcloud compute tpus execution-groups delete dlrm-dcn-tutorial \\--zone=europe-west4-a\n```\n- \u901a\u904e\u904b\u884c `gcloud compute tpus execution-groups list` \u9a57\u8b49\u8cc7\u6e90\u662f\u5426\u5df2\u522a\u9664\u3002\u522a\u9664\u64cd\u4f5c\u53ef\u80fd\u9700\u8981\u5e7e\u5206\u9418\u6642\u9593\u624d\u80fd\u5b8c\u6210\u3002\u4ee5\u4e0b\u547d\u4ee4\u7684\u8f38\u51fa\u4e0d\u61c9\u5305\u542b\u672c\u6559\u7a0b\u4e2d\u5275\u5efa\u7684\u4efb\u4f55\u8cc7\u6e90\uff1a\n```\n$ gcloud compute tpus tpu-vm list --zone=europe-west4-a\n```\n```\n$ gcloud compute tpus execution-groups list --zone=europe-west4-a\n```\n- \u4f7f\u7528 `gsutil` \u522a\u9664 Cloud Storage \u5b58\u5132\u6876\u3002\u5c07 \u66ff\u63db\u7232\u60a8\u7684 Cloud Storage \u5b58\u5132\u6876\u7684\u540d\u7a31\u3002```\n$ gsutil rm -r gs://bucket-name\n```\n## \u5f8c\u7e8c\u6b65\u9a5fTensorFlow Cloud TPU \u6559\u7a0b\u901a\u5e38\u4f7f\u7528\u793a\u4f8b\u6578\u64da\u96c6\u4f86\u8a13\u7df4\u6a21\u578b\u3002\u6b64\u8a13\u7df4\u7684\u7d50\u679c\u7121\u6cd5\u7528\u65bc\u63a8\u7406\u3002\u5982\u9700\u4f7f\u7528\u6a21\u578b\u9032\u884c\u63a8\u7406\uff0c\u60a8\u53ef\u4ee5\u5728\u516c\u958b\u6578\u64da\u96c6\u6216\u60a8\u81ea\u5df1\u7684\u6578\u64da\u96c6\u4e0a\u8a13\u7df4\u6a21\u578b\u3002\u5728 Cloud TPU \u4e0a\u8a13\u7df4\u7684 TensorFlow \u6a21\u578b\u901a\u5e38\u9700\u8981\u6578\u64da\u96c6\u63a1\u7528 [TFRecord](https://www.tensorflow.org/tutorials/load_data/tfrecord?hl=zh-cn) \u683c\u5f0f\u3002\n\u60a8\u53ef\u4ee5\u4f7f\u7528 [\u6578\u64da\u96c6\u8f49\u63db\u5de5\u5177\u793a\u4f8b](https://cloud.google.com/tpu/docs/classification-data-conversion?hl=zh-cn) \u5c07\u5716\u7247\u5206\u985e\u6578\u64da\u96c6\u8f49\u63db\u7232 TFRecord \u683c\u5f0f\u3002\u5982\u679c\u60a8\u4f7f\u7528\u7684\u4e0d\u662f\u5716\u7247\u5206\u985e\u6a21\u578b\uff0c\u5247\u5fc5\u9808\u81ea\u884c\u5c07\u6578\u64da\u96c6\u8f49\u63db\u7232 [TFRecord](https://www.tensorflow.org/tutorials/load_data/tfrecord?hl=zh-cn) \u683c\u5f0f\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [TFRecord \u548c tf.Example](https://www.tensorflow.org/tutorials/load_data/tfrecord?hl=zh-cn) \u3002\n### \u8d85\u53c3\u6578\u8abf\u512a\u5982\u9700\u4f7f\u7528\u6578\u64da\u96c6\u63d0\u9ad8\u6a21\u578b\u7684\u6027\u80fd\uff0c\u60a8\u53ef\u4ee5\u8abf\u6574\u6a21\u578b\u7684\u8d85\u53c3\u6578\u3002\u60a8\u53ef\u4ee5\u5728 [GitHub](https://github.com/tensorflow/tpu/tree/master/models/hyperparameters) \u4e0a\u627e\u5230\u6240\u6709 TPU \u652f\u6301\u6a21\u578b\u901a\u7528\u7684\u8d85\u53c3\u6578\u4fe1\u606f\u3002\u60a8\u53ef\u4ee5\u5728\u6bcf\u500b\u6a21\u578b\u7684 [\u6e90\u4ee3\u78bc](https://github.com/tensorflow/tpu/tree/master/models/official) \u4e2d\u627e\u5230\u6709\u95dc\u6a21\u578b\u7279\u6709\u8d85\u53c3\u6578\u7684\u4fe1\u606f\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u8d85\u53c3\u6578\u8abf\u7bc0\uff0c\u8acb\u53c3\u95b1 [\u8d85\u53c3\u6578\u8abf\u7bc0\u6982\u89bd](https://cloud.google.com/vertex-ai/docs/training/hyperparameter-tuning-overview?hl=zh-cn) \u548c [\u8abf\u7bc0\u8d85\u53c3\u6578](https://developers.google.com/machine-learning/guides/text-classification/step-5?hl=zh-cn) \u3002\n### \u63a8\u65b7\u8a13\u7df4\u5b8c\u6a21\u578b\u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u5b83\u9032\u884c\u63a8\u7406\uff08\u4e5f\u7a31\u7232\u9810\u6e2c\uff09\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528 [Cloud TPU \u63a8\u7406\u8f49\u63db\u5668\u5de5\u5177](https://cloud.google.com/tpu/docs/v5e-inference-converter?hl=zh-cn) \u6e96\u5099\u548c\u512a\u5316 TensorFlow \u6a21\u578b\uff0c\u4ee5\u5728 Cloud TPU v5e \u4e0a\u9032\u884c\u63a8\u65b7\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3 Cloud TPU v5e \u4e0a\u7684\u63a8\u65b7\uff0c\u8acb\u53c3\u95b1 [Cloud TPU v5e \u63a8\u65b7\u7c21\u4ecb](https://cloud.google.com/tpu/docs/v5e-inference?hl=zh-cn) \u3002", "guide": "Cloud TPU"}