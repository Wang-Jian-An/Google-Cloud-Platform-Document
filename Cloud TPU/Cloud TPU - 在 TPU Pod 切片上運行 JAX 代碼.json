{"title": "Cloud TPU - \u5728 TPU Pod \u5207\u7247\u4e0a\u904b\u884c JAX \u4ee3\u78bc", "url": "https://cloud.google.com/tpu/docs/jax-pods?hl=zh-cn", "abstract": "# Cloud TPU - \u5728 TPU Pod \u5207\u7247\u4e0a\u904b\u884c JAX \u4ee3\u78bc\n# \u5728 TPU Pod \u5207\u7247\u4e0a\u904b\u884c JAX \u4ee3\u78bc\n\u5728\u55ae\u500b TPU \u677f\u4e0a\u904b\u884c JAX \u4ee3\u78bc\u5f8c\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u5728 [TPU Pod \u5207\u7247](https://cloud.google.com/tpu/docs/system-architecture-tpu-vm?hl=zh-cn#tpu_slices) \u4e0a\u904b\u884c\u4ee3\u78bc\u4f86\u64f4\u5bb9\u4ee3\u78bc\u3002 TPU Pod \u5207\u7247\u662f\u901a\u904e\u5c08\u7528\u9ad8\u901f\u7db2\u7d61\u9023\u63a5\u76f8\u4e92\u9023\u63a5\u7684\u591a\u500b TPU \u677f\u3002\u672c\u6587\u6a94\u4ecb\u7d39\u77ad\u5982\u4f55\u5728 TPU Pod \u5207\u7247\u4e0a\u904b\u884c JAX \u4ee3\u78bc\uff1b\u5982\u9700\u77ad\u89e3\u66f4\u6df1\u5165\u7684\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 [\u5728\u591a\u4e3b\u6a5f\u548c\u591a\u9032\u7a0b\u74b0\u5883\u4e2d\u4f7f\u7528 JAX](https://jax.readthedocs.io/en/latest/multi_process.html) \u3002\n", "content": "## \u5275\u5efa TPU Pod \u5207\u7247\n\u5728\u904b\u884c\u672c\u6587\u6a94\u4e2d\u7684\u547d\u4ee4\u4e4b\u524d\uff0c\u8acb\u78ba\u4fdd\u60a8\u5df2\u6309\u7167 [\u8a2d\u7f6e\u5e33\u865f\u548c Cloud TPU \u9805\u76ee](https://cloud.google.com/tpu/docs/setup-gcp-account?hl=zh-cn) \u4e2d\u7684\u8aaa\u660e\u64cd\u4f5c\u3002\u5728\u672c\u5730\u6a5f\u5668\u4e0a\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u3002\n\u4f7f\u7528 `gcloud` \u547d\u4ee4\u53ef\u4ee5\u5275\u5efa TPU Pod \u5207\u7247\u3002\u4f8b\u5982\uff0c\u5982\u9700\u5275\u5efa v4-32 Pod \u5207\u7247\uff0c\u8acb\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\n$ gcloud compute tpus tpu-vm create tpu-name \u00a0\\\u00a0 --zone=us-central2-b \\\u00a0 --accelerator-type=v4-32 \u00a0\\\u00a0 --version=tpu-ubuntu2204-base \n```\n## \u5728 Pod \u5207\u7247\u4e0a\u5b89\u88dd JAX\n\u5275\u5efa TPU Pod \u5207\u7247\u4e4b\u5f8c\uff0c\u60a8\u5fc5\u9808\u5728 TPU Pod \u5207\u7247\u4e2d\u7684\u6240\u6709\u4e3b\u6a5f\u4e0a\u5b89\u88dd JAX\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528 `--worker=all` \u9078\u9805\u901a\u904e\u4e00\u500b\u547d\u4ee4\u5728\u6240\u6709\u4e3b\u6a5f\u4e0a\u5b89\u88dd JAX\uff1a\n```\n\u00a0 gcloud compute tpus tpu-vm ssh tpu-name \\\u00a0 --zone=us-central2-b --worker=all --command=\"pip install \\\u00a0 --upgrade 'jax[tpu]>0.3.0' \\\u00a0 -f https://storage.googleapis.com/jax-releases/libtpu_releases.html\"\n```\n## \u5728 Pod \u5207\u7247\u4e0a\u904b\u884c JAX \u4ee3\u78bc\n\u8981\u5728 TPU Pod \u5207\u7247\u4e0a\u904b\u884c JAX \u4ee3\u78bc\uff0c\u60a8\u5fc5\u9808 **\u5728 TPU Pod \u5207\u7247\u4e2d\u7684\u6bcf\u500b\u4e3b\u6a5f\u4e0a\u904b\u884c\u4ee3\u78bc** \u3002 `jax.device_count()` \u8abf\u7528\u6703\u505c\u6b62\u97ff\u61c9\uff0c\u76f4\u5230\u5728 Pod \u5207\u7247\u4e2d\u7684\u6bcf\u500b\u4e3b\u6a5f\u4e0a\u8abf\u7528\u5b83\u3002\u4ee5\u4e0b\u793a\u4f8b\u8aaa\u660e\u4e86\u5982\u4f55\u5728 TPU Pod \u5207\u7247\u4e0a\u904b\u884c\u7c21\u55ae\u7684 JAX \u8a08\u7b97\u3002\n### \u6e96\u5099\u4ee3\u78bc\n\u60a8\u9700\u8981\u4f7f\u7528 344.0.0 \u6216\u66f4\u9ad8\u7248\u672c\u7684 `gcloud` \uff08\u5c0d\u65bc ` [scp](https://cloud.google.com/sdk/gcloud/reference/alpha/compute/tpus/tpu-vm/scp?hl=zh-cn) ` \u547d\u4ee4\uff09\u3002\u4f7f\u7528 `gcloud --version` \u6aa2\u67e5\u60a8\u7684 `gcloud` \u7248\u672c\uff0c\u4e26\u6839\u64da\u9700\u8981\u904b\u884c `gcloud components upgrade` \u3002\n\u4f7f\u7528\u4ee5\u4e0b\u4ee3\u78bc\u5275\u5efa\u4e00\u500b\u540d\u7232 `example.py` \u7684\u6587\u4ef6\uff1a\n```\n# The following code snippet will be run on all TPU hostsimport jax# The total number of TPU cores in the Poddevice_count = jax.device_count()# The number of TPU cores attached to this hostlocal_device_count = jax.local_device_count()# The psum is performed over all mapped devices across the Podxs = jax.numpy.ones(jax.local_device_count())r = jax.pmap(lambda x: jax.lax.psum(x, 'i'), axis_name='i')(xs)# Print from a single host to avoid duplicated outputif jax.process_index() == 0:\u00a0 \u00a0 print('global device count:', jax.device_count())\u00a0 \u00a0 print('local device count:', jax.local_device_count())\u00a0 \u00a0 print('pmap result:', r)\n```\n### \u5c07 example.py \u8907\u88fd\u5230 Pod \u5207\u7247\u4e2d\u7684\u6240\u6709 TPU \u5de5\u4f5c\u5668\u865b\u64ec\u6a5f\n```\n$ gcloud compute tpus tpu-vm scp example.py tpu-name: \\\u00a0 --worker=all \\\u00a0 --zone=us-central2-b\n```\n\u5982\u679c\u60a8\u4e4b\u524d\u672a\u4f7f\u7528\u904e `scp` \u547d\u4ee4\uff0c\u5247\u53ef\u80fd\u6703\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\u7684\u932f\u8aa4\uff1a\n```\nERROR: (gcloud.alpha.compute.tpus.tpu-vm.scp) SSH Key is not present in the SSH\nagent. Please run `ssh-add /.../.ssh/google_compute_engine` to add it, and try\nagain.\n```\n\u5982\u9700\u89e3\u6c7a\u8a72\u932f\u8aa4\uff0c\u8acb\u6309\u7167\u932f\u8aa4\u6d88\u606f\u4e2d\u986f\u793a\u7684\u5167\u5bb9\u904b\u884c `ssh-add` \u547d\u4ee4\uff0c\u7136\u5f8c\u91cd\u65b0\u904b\u884c\u8a72\u547d\u4ee4\u3002\n### \u5728 Pod \u5207\u7247\u4e0a\u904b\u884c\u4ee3\u78bc\n\u5728\u6bcf\u500b\u865b\u64ec\u6a5f\u4e0a\u5553\u52d5 `example.py` \u7a0b\u5e8f\uff1a\n```\n$ gcloud compute tpus tpu-vm ssh tpu-name \\\u00a0 --zone=us-central2-b \\\u00a0 --worker=all \\\u00a0 --command=\"python3 example.py\"\n```\n### \u8f38\u51fa\uff08\u4f7f\u7528 v4-32 Pod \u5207\u7247\u751f\u6210\uff09\uff1a\n```\nglobal device count: 16local device count: 4pmap result: [16. 16. 16. 16.]\n```\n## \u6e05\u7406\n\u5b8c\u6210\u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 `gcloud` \u547d\u4ee4\u91cb\u653e TPU \u865b\u64ec\u6a5f\u8cc7\u6e90\uff1a\n```\n$ gcloud compute tpus tpu-vm delete tpu-name \\\u00a0 --zone=us-central2-b\n```", "guide": "Cloud TPU"}