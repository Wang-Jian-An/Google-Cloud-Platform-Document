{"title": "Cloud TPU - \u4f7f\u7528 JAX \u5728 Cloud TPU \u865b\u64ec\u6a5f\u4e0a\u904b\u884c\u8a08\u7b97", "url": "https://cloud.google.com/tpu/docs/run-calculation-jax?hl=zh-cn", "abstract": "# Cloud TPU - \u4f7f\u7528 JAX \u5728 Cloud TPU \u865b\u64ec\u6a5f\u4e0a\u904b\u884c\u8a08\u7b97\n# \u4f7f\u7528 JAX \u5728 Cloud TPU \u865b\u64ec\u6a5f\u4e0a\u904b\u884c\u8a08\u7b97\n\u672c\u6587\u6a94\u7c21\u8981\u4ecb\u7d39\u77ad\u5982\u4f55\u4f7f\u7528 JAX \u548c Cloud TPU\u3002\n\u5728\u6309\u7167\u672c\u5feb\u901f\u5165\u9580\u9032\u884c\u64cd\u4f5c\u4e4b\u524d\uff0c\u60a8\u5fc5\u9808\u5275\u5efa Google Cloud Platform \u5e33\u865f\u3001\u5b89\u88dd Google Cloud CLI \u4e26\u914d\u7f6e `gcloud` \u547d\u4ee4\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u8a2d\u7f6e\u8cec\u865f\u548c Cloud TPU \u9805\u76ee](https://cloud.google.com/tpu/docs/setup-gcp-account?hl=zh-cn)\n", "content": "## \u5b89\u88dd Google Cloud CLI\nGoogle Cloud CLI \u5305\u542b\u7528\u65bc\u8207 Google Cloud \u7522\u54c1\u548c\u670d\u52d9\u4ea4\u4e92\u7684\u5de5\u5177\u548c\u5eab\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5b89\u88dd Google Cloud CLI](https://cloud.google.com/sdk/docs/install?hl=zh-cn) \u3002\n## \u914d\u7f6e gcloud \u547d\u4ee4\n\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5c07 `gcloud` \u914d\u7f6e\u7232\u4f7f\u7528\u60a8\u7684 Google Cloud \u9805\u76ee\u4e26\u5b89\u88dd TPU \u865b\u64ec\u6a5f\u9810\u89bd\u6240\u9700\u7684\u7d44\u4ef6\u3002\n```\n\u00a0 $ gcloud config set account your-email-account\u00a0 $ gcloud config set project your-project-id\n```\n## \u5553\u7528 Cloud TPU API\n- \u5728 [Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn) \u4e2d\u4f7f\u7528\u4ee5\u4e0b `gcloud` \u547d\u4ee4\u5553\u7528 Cloud TPU API\u3002\uff08\u60a8\u4e5f\u53ef\u4ee5\u901a\u904e [Google Cloud \u63a7\u5236\u6aaf](https://console.cloud.google.com/?hl=zh-cn) \u5c07\u5176\u5553\u7528\uff09\u3002```\n$ gcloud services enable tpu.googleapis.com\n```\n- \u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u5275\u5efa\u670d\u52d9\u8eab\u4efd\u3002```\n$ gcloud beta services identity create --service tpu.googleapis.com\n```## \u4f7f\u7528 gcloud \u5275\u5efa Cloud TPU \u865b\u64ec\u6a5f\n\u85c9\u52a9 Cloud TPU \u865b\u64ec\u6a5f\uff0c\u60a8\u7684\u6a21\u578b\u548c\u4ee3\u78bc\u76f4\u63a5\u5728 TPU \u4e3b\u6a5f\u4e0a\u904b\u884c\u3002\u60a8\u901a\u904e SSH \u76f4\u63a5\u9023\u63a5\u5230 TPU \u4e3b\u6a5f\u3002\u60a8\u53ef\u4ee5\u76f4\u63a5\u5728 TPU \u4e3b\u6a5f\u4e0a\u904b\u884c\u4efb\u610f\u4ee3\u78bc\u3001\u5b89\u88dd\u8edf\u4ef6\u5305\u3001\u67e5\u770b\u65e5\u8a8c\u548c\u8abf\u8a66\u4ee3\u78bc\u3002\n- \u5f9e Google Cloud Shell \u6216\u5b89\u88dd\u4e86 [Google Cloud CLI](https://cloud.google.com/sdk/docs/install?hl=zh-cn) \u7684\u8a08\u7b97\u6a5f\u7d42\u7aef\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5275\u5efa TPU \u865b\u64ec\u6a5f\u3002```\n(vm)$ gcloud compute tpus tpu-vm create tpu-name \\--zone=us-central2-b \\--accelerator-type=v4-8 \\--version=tpu-ubuntu2204-base\n```## \u9023\u63a5\u5230 Cloud TPU \u865b\u64ec\u6a5f\n\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u901a\u904e SSH \u9023\u63a5\u5230 TPU \u865b\u64ec\u6a5f\uff1a\n```\n$ gcloud compute tpus tpu-vm ssh tpu-name --zone=us-central2-b\n```## \u5728 Cloud TPU \u865b\u64ec\u6a5f\u4e0a\u5b89\u88dd JAX\n```\n(vm)$ pip install jax[tpu] -f https://storage.googleapis.com/jax-releases/libtpu_releases.html\n```\n## \u7cfb\u7d71\u6aa2\u67e5\n\u9a57\u8b49 JAX \u662f\u5426\u53ef\u4ee5\u8a2a\u554f TPU \u4e26\u53ef\u4ee5\u904b\u884c\u57fa\u672c\u64cd\u4f5c\uff1a\n### \u5553\u52d5 Python 3 \u89e3\u91cb\u5668\uff1a\n```\n(vm)$ python3\n```\n```\n>>> import jax\n```\n### \u986f\u793a\u53ef\u7528\u7684 TPU \u6838\u5fc3\u6578\uff1a\n```\n>>> jax.device_count()\n```\n\u7cfb\u7d71\u6703\u986f\u793a TPU \u6838\u5fc3\u7684\u6578\u91cf\u3002\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f v4 TPU\uff0c\u5247\u6b64\u53c3\u6578\u61c9\u7232 `4` \u3002\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f v2 \u6216 v3 TPU\uff0c\u5247\u6b64\u53c3\u6578\u61c9\u7232 `8` \u3002\n### \u57f7\u884c\u7c21\u55ae\u7684\u8a08\u7b97\uff1a\n```\n>>> jax.numpy.add(1, 1)\n```\n\u5c07\u986f\u793a numpy add \u7684\u7d50\u679c\uff1a\n\u547d\u4ee4\u7684\u8f38\u51fa\u7232\uff1a\n```\nArray(2, dtype=int32, weak_type=true)\n```### \u9000\u51fa Python \u89e3\u91cb\u5668\uff1a\n```\n>>> exit()\n```\n## \u5728 TPU \u865b\u64ec\u6a5f\u4e0a\u904b\u884c JAX \u4ee3\u78bc\n\u73fe\u5728\uff0c\u60a8\u53ef\u4ee5\u904b\u884c\u4efb\u4f55 JAX \u4ee3\u78bc\u3002\u8981\u904b\u884c JAX \u4e2d\u7684\u6a19\u6e96\u6a5f\u5668\u5b78\u7fd2\u6a21\u578b\uff0c [Flax \u793a\u4f8b](https://github.com/google/flax/tree/master/examples) \u662f\u4e00\u500b\u5f88\u597d\u7684\u8d77\u9ede\u3002\u4f8b\u5982\uff0c\u5982\u9700\u8a13\u7df4\u57fa\u672c MNIST \u5377\u7a4d\u7db2\u7d61\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u5b89\u88dd Flax \u793a\u4f8b\u4f9d\u8cf4\u9805```\n(vm)$ pip install --upgrade clu(vm)$ pip install tensorflow(vm)$ pip install tensorflow_datasets\n```\n- \u5b89\u88dd FLAX```\n(vm)$ git clone https://github.com/google/flax.git(vm)$ pip install --user flax\n```\n- \u904b\u884c FLAX MNIST \u8a13\u7df4\u8173\u672c```\n(vm)$ cd flax/examples/mnist(vm)$ python3 main.py --workdir=/tmp/mnist \\--config=configs/default.py \\--config.learning_rate=0.05 \\--config.num_epochs=5\n```\n\u8a72\u8173\u672c\u6703\u4e0b\u8f09\u6578\u64da\u96c6\u4e26\u958b\u59cb\u8a13\u7df4\u3002\u8173\u672c\u8f38\u51fa\u61c9\u5982\u4e0b\u6240\u793a\uff1a\n```\n\u00a0 0214 18:00:50.660087 140369022753856 train.py:146] epoch: \u00a01, train_loss: 0.2421, train_accuracy: 92.97, test_loss: 0.0615, test_accuracy: 97.88\u00a0 I0214 18:00:52.015867 140369022753856 train.py:146] epoch: \u00a02, train_loss: 0.0594, train_accuracy: 98.16, test_loss: 0.0412, test_accuracy: 98.72\u00a0 I0214 18:00:53.377511 140369022753856 train.py:146] epoch: \u00a03, train_loss: 0.0418, train_accuracy: 98.72, test_loss: 0.0296, test_accuracy: 99.04\u00a0 I0214 18:00:54.727168 140369022753856 train.py:146] epoch: \u00a04, train_loss: 0.0305, train_accuracy: 99.06, test_loss: 0.0257, test_accuracy: 99.15\u00a0 I0214 18:00:56.082807 140369022753856 train.py:146] epoch: \u00a05, train_loss: 0.0252, train_accuracy: 99.20, test_loss: 0.0263, test_accuracy: 99.18\n```\n## \u6e05\u7406\n\u5b8c\u6210 TPU \u865b\u64ec\u6a5f\u7684\u64cd\u4f5c\u5f8c\uff0c\u8acb\u6309\u7167\u4ee5\u4e0b\u6b65\u9a5f\u6e05\u7406\u8cc7\u6e90\u3002\n- \u65b7\u958b\u8207 Compute Engine \u5be6\u4f8b\u7684\u9023\u63a5\uff08\u5982\u679c\u60a8\u5c1a\u672a\u9019\u6a23\u505a\uff09\uff1a```\n(vm)$ exit\n```\n- \u522a\u9664\u60a8\u7684 Cloud TPU\u3002```\n$ gcloud compute tpus tpu-vm deletetpu-name \\\u00a0 --zone=us-central2-b\n```\n- \u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4f86\u9a57\u8b49\u8cc7\u6e90\u5df2\u522a\u9664\u3002\u78ba\u4fdd\u60a8\u7684 TPU \u4e0d\u518d\u5217\u51fa\u3002\u522a\u9664\u64cd\u4f5c\u53ef\u80fd\u9700\u8981\u5e7e\u5206\u9418\u6642\u9593\u624d\u80fd\u5b8c\u6210\u3002```\n$ gcloud compute tpus tpu-vm list \\\u00a0 --zone=us-central2-b\n```## \u6027\u80fd\u8aaa\u660e\n\u4ee5\u4e0b\u662f\u5c0d\u65bc\u5728 JAX \u4e2d\u4f7f\u7528 TPU \u5c24\u5176\u91cd\u8981\u7684\u4e00\u4e9b\u7d30\u7bc0\u3002\n### \u586b\u5145\nTPU \u6027\u80fd\u4e0b\u964d\u7684\u6700\u5e38\u898b\u539f\u56e0\u4e4b\u4e00\u662f\u5f15\u5165\u4e86\u610f\u5916\u586b\u5145\uff1a\n- Cloud TPU \u4e2d\u6703\u5e73\u92ea\u6578\u7d44\u3002\u9019\u9700\u8981\u5c07\u5176\u4e2d\u4e00\u500b\u7dad\u5ea6\u586b\u5145\u7232 8 \u7684\u500d\u6578\uff0c\u4e26\u5c07\u53e6\u4e00\u500b\u7dad\u5ea6\u586b\u5145\u7232 128 \u7684\u500d\u6578\u3002\n- \u77e9\u9663\u4e58\u6cd5\u55ae\u5143\u5728\u7528\u65bc\u5927\u578b\u77e9\u9663\u5c0d\u6642\u6027\u80fd\u6700\u4f73\uff0c\u5927\u578b\u77e9\u9663\u5c0d\u53ef\u6700\u5927\u9650\u5ea6\u5730\u6e1b\u5c11\u586b\u5145\u9700\u6c42\u3002\n### bfloat16 dtype\n\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cTPU \u4e0a\u7684 JAX \u77e9\u9663\u4e58\u6cd5\u4f7f\u7528 [bfloat16](https://cloud.google.com/tpu/docs/bfloat16?hl=zh-cn) \u548c float32 \u7d2f\u52a0\u3002\u9019\u53ef\u4ee5\u901a\u904e\u76f8\u95dc jax.numpy \u51fd\u6578\u8abf\u7528\uff08matmul\u3001dot\u3001einsum \u7b49\uff09\u4e2d\u7684\u7cbe\u5ea6\u53c3\u6578\u4f86\u63a7\u5236\u3002\u7279\u5225\u662f\uff1a\n- `precision=jax.lax.Precision.DEFAULT`\uff1a\u4f7f\u7528\u6df7\u5408 bfloat16 \u7cbe\u5ea6\uff08\u6700\u5feb\uff09\n- `precision=jax.lax.Precision.HIGH`\uff1a\u4f7f\u7528\u591a\u500b MXU \u50b3\u905e\u4ee5\u5be6\u73fe\u66f4\u9ad8\u7684\u7cbe\u78ba\u5ea6\n- `precision=jax.lax.Precision.HIGHEST`\uff1a\u4f7f\u7528\u66f4\u591a MXU \u50b3\u905e\u4ee5\u5be6\u73fe float32 \u5b8c\u5168\u7cbe\u5ea6\nJAX \u9084\u6dfb\u52a0\u4e86 bfloat16 dtype\uff0c\u60a8\u53ef\u4ee5\u5229\u7528\u5b83\u5c07\u6578\u7d44\u986f\u5f0f\u8f49\u63db\u7232 `bfloat16` \uff0c\u4f8b\u5982 `jax.numpy.array(x, dtype=jax.numpy.bfloat16)` \u3002\n## \u5728 Colab \u4e2d\u904b\u884c JAX\n\u7576\u60a8\u5728 Colab \u7b46\u8a18\u672c\u4e2d\u904b\u884c JAX \u4ee3\u78bc\u6642\uff0cColab \u6703\u81ea\u52d5\u5275\u5efa\u820a\u7248 TPU \u7bc0\u9ede\u3002TPU \u7bc0\u9ede\u5177\u6709\u4e0d\u540c\u7684\u67b6\u69cb\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7cfb\u7d71\u67b6\u69cb](https://cloud.google.com/tpu/docs/system-architecture-tpu-vm?hl=zh-cn) \u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3 Cloud TPU\uff0c\u8acb\u53c3\u95b1\uff1a\n- [\u5728 TPU Pod \u5207\u7247\u4e0a\u904b\u884c JAX \u4ee3\u78bc](https://cloud.google.com/tpu/docs/jax-pods?hl=zh-cn) \n- [\u7ba1\u7406 TPU](https://cloud.google.com/tpu/docs/managing-tpus-tpu-vm?hl=zh-cn) \n- [Cloud TPU \u7cfb\u7d71\u67b6\u69cb](https://cloud.google.com/tpu/docs/system-architecture-tpu-vm?hl=zh-cn)", "guide": "Cloud TPU"}