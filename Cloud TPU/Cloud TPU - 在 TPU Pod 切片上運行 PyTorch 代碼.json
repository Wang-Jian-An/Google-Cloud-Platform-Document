{"title": "Cloud TPU - \u5728 TPU Pod \u5207\u7247\u4e0a\u904b\u884c PyTorch \u4ee3\u78bc", "url": "https://cloud.google.com/tpu/docs/pytorch-pods?hl=zh-cn", "abstract": "# Cloud TPU - \u5728 TPU Pod \u5207\u7247\u4e0a\u904b\u884c PyTorch \u4ee3\u78bc\n# \u5728 TPU Pod \u5207\u7247\u4e0a\u904b\u884c PyTorch \u4ee3\u78bc\nPyTorch/XLA \u8981\u6c42\u6240\u6709 TPU \u865b\u64ec\u6a5f\u90fd\u80fd\u5920\u8a2a\u554f\u6a21\u578b\u4ee3\u78bc\u548c\u6578\u64da\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528 [\u5553\u52d5\u8173\u672c](#create-tpu-vm) \u4e0b\u8f09\u5c07\u6a21\u578b\u6578\u64da\u5206\u767c\u5230\u6240\u6709 TPU \u865b\u64ec\u6a5f\u6240\u9700\u7684\u8edf\u4ef6\u3002\n\u5982\u679c\u8981\u5c07 TPU \u865b\u64ec\u6a5f\u9023\u63a5\u5230 [\u865b\u64ec\u79c1\u6709\u4e91](https://cloud.google.com/vpc/docs/vpc?hl=zh-cn) (VPC)\uff0c\u60a8\u5fc5\u9808\u5728\u9805\u76ee\u4e2d\u6dfb\u52a0\u9632\u706b\u7246\u898f\u5247\uff0c\u4ee5\u5141\u8a31\u7aef\u53e3 8470 - 8479 \u50b3\u5165\u5165\u7ad9\u6d41\u91cf\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u6dfb\u52a0\u9632\u706b\u7246\u898f\u5247\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528\u9632\u706b\u7246\u898f\u5247](https://cloud.google.com/firewall/docs/using-firewalls?hl=zh-cn)\n", "content": "## \u8a2d\u7f6e\u60a8\u7684\u74b0\u5883\n- \u5728 Cloud Shell \u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u78ba\u4fdd\u60a8\u904b\u884c\u7684\u662f\u7576\u524d\u7248\u672c\u7684 `gcloud` \uff1a```\n$ gcloud components update\n```\u5982\u679c\u60a8\u9700\u8981\u5b89\u88dd `gcloud` \uff0c\u8acb\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a```\n$ sudo apt install -y google-cloud-sdk\n```\n- \u5275\u5efa\u4e00\u4e9b\u74b0\u5883\u8b8a\u91cf\uff1a```\n$ export PROJECT_ID=project-id$ export TPU_NAME=tpu-name$ export ZONE=us-central2-b$ export RUNTIME_VERSION=tpu-ubuntu2204-base$ export ACCELERATOR_TYPE=v4-32\n```## \u5275\u5efa TPU \u865b\u64ec\u6a5f\n```\n$ gcloud compute tpus tpu-vm create ${TPU_NAME} \\--zone=${ZONE} \\--project=${PROJECT_ID} \\--accelerator-type=${ACCELERATOR_TYPE} \\--version ${RUNTIME_VERSION}\n```\n## \u914d\u7f6e\u4e26\u904b\u884c\u8a13\u7df4\u8173\u672c\n- \u5c07\u60a8\u7684 SSH \u8b49\u66f8\u6dfb\u52a0\u5230\u60a8\u7684\u9805\u76ee\u4e2d\uff1a```\nssh-add ~/.ssh/google_compute_engine\n```\n- \u5728\u6240\u6709 TPU \u865b\u64ec\u6a5f\u5de5\u4f5c\u5668\u4e0a\u5b89\u88dd PyTorch/XLA```\ngcloud compute tpus tpu-vm ssh ${TPU_NAME} \\\u00a0 --zone=${ZONE} \\\u00a0 --project=${PROJECT_ID} \\\u00a0 --worker=all --command=\"\u00a0 pip install torch~=2.2.0 torch_xla[tpu]~=2.2.0 torchvision -f https://storage.googleapis.com/libtpu-releases/index.html\"\n```\n- \u5728\u6240\u6709 TPU \u865b\u64ec\u6a5f\u5de5\u4f5c\u5668\u4e0a\u514b\u9686 XLA```\ngcloud compute tpus tpu-vm ssh ${TPU_NAME} \\\u00a0 --zone=${ZONE} \\\u00a0 --project=${PROJECT_ID} \\\u00a0 --worker=all --command=\"git clone -b r2.2 https://github.com/pytorch/xla.git\"\n```\n- \u5728\u6240\u6709\u5de5\u4f5c\u5668\u4e0a\u904b\u884c\u8a13\u7df4\u8173\u672c```\ngcloud compute tpus tpu-vm ssh ${TPU_NAME} \\\u00a0 --zone=${ZONE} \\\u00a0 --project=${PROJECT_ID} \\\u00a0 --worker=all \\\u00a0 --command=\"PJRT_DEVICE=TPU python3 ~/xla/test/test_train_mp_imagenet.py \u00a0\\\u00a0 --fake_data \\\u00a0 --model=resnet50 \u00a0\\\u00a0 --num_epochs=1 2>&1 | tee ~/logs.txt\"\u00a0 \n```\u8a13\u7df4\u5927\u7d04\u9700\u8981 5 \u5206\u9418\u3002\u5b8c\u6210\u5f8c\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230\u985e\u4f3c\u65bc\u4e0b\u9762\u9019\u6a23\u7684\u6d88\u606f\uff1a```\nEpoch 1 test end 23:49:15, Accuracy=100.00\n10.164.0.11 [0] Max Accuracy: 100.00%\n```## \u6e05\u7406\n\u5b8c\u6210 TPU \u865b\u64ec\u6a5f\u7684\u64cd\u4f5c\u5f8c\uff0c\u8acb\u6309\u7167\u4ee5\u4e0b\u6b65\u9a5f\u6e05\u7406\u8cc7\u6e90\u3002\n- \u65b7\u958b\u8207 Compute Engine \u7684\u9023\u63a5\uff1a```\n(vm)$ exit\n```\n- \u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4f86\u9a57\u8b49\u8cc7\u6e90\u5df2\u522a\u9664\u3002\u78ba\u4fdd\u60a8\u7684 TPU \u4e0d\u518d\u5217\u51fa\u3002\u522a\u9664\u64cd\u4f5c\u53ef\u80fd\u9700\u8981\u5e7e\u5206\u9418\u6642\u9593\u624d\u80fd\u5b8c\u6210\u3002```\n$ gcloud compute tpus tpu-vm list \\\u00a0 --zone europe-west4-a\n```", "guide": "Cloud TPU"}