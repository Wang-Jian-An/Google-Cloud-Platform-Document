{"title": "Cloud TPU - \u7cfb\u7d71\u67b6\u69cb", "url": "https://cloud.google.com/tpu/docs/system-architecture-tpu-vm?hl=zh-cn", "abstract": "# Cloud TPU - \u7cfb\u7d71\u67b6\u69cb\n# \u7cfb\u7d71\u67b6\u69cb\n\u5f35\u91cf\u8655\u7406\u55ae\u5143 (TPU) \u662f Google \u8a2d\u8a08\u7684\u61c9\u7528\u5c08\u7528\u96c6\u6210\u96fb\u8def (ASIC)\uff0c\u7528\u65bc\u52a0\u901f\u6a5f\u5668\u5b78\u7fd2\u5de5\u4f5c\u8ca0\u8f09\u3002Cloud TPU \u662f\u4e00\u9805 Google Cloud \u670d\u52d9\uff0c\u5b83\u53ef\u5c07 TPU \u4f5c\u7232\u53ef\u4f38\u7e2e\u8cc7\u6e90\u63d0\u4f9b\u3002\nTPU \u65e8\u5728\u5feb\u901f\u57f7\u884c\u77e9\u9663\u64cd\u4f5c\uff0c\u56e0\u6b64\u975e\u5e38\u9069\u5408\u6a5f\u5668\u5b78\u7fd2\u5de5\u4f5c\u8ca0\u8f09\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528 [TensorFlow](https://www.tensorflow.org/?hl=zh-cn) \u3001 [Pytorch](https://cloud.google.com/tpu/docs/tutorials/pytorch-pod?hl=zh-cn) \u548c [JAX](https://jax.readthedocs.io/en/latest/) \u7b49\u6846\u67b6\u5728 TPU \u4e0a\u904b\u884c\u6a5f\u5668\u5b78\u7fd2\u5de5\u4f5c\u8ca0\u8f09\u3002\n", "content": "## Cloud TPU \u8853\u8a9e\n\u5982\u679c\u60a8\u525b\u958b\u59cb\u63a5\u89f8 Cloud TPU\uff0c\u8acb\u67e5\u770b [TPU \u6587\u6a94\u9996\u9801](https://cloud.google.com/tpu/docs?hl=zh-cn) \u3002 \u4ee5\u4e0b\u90e8\u5206\u4ecb\u7d39\u4e86\u672c\u6587\u6a94\u4e2d\u4f7f\u7528\u7684\u8853\u8a9e\u548c\u76f8\u95dc\u6982\u5ff5\u3002\n### \u6279\u91cf\u63a8\u7406\n\u6279\u91cf\u6216\u96e2\u7dda\u63a8\u7406\u662f\u6307\u5728\u751f\u7522\u6d41\u6c34\u7dda\u4e4b\u5916\u9032\u884c\u63a8\u7406\uff0c\u901a\u5e38\u5c0d\u5927\u91cf\u8f38\u5165\u9032\u884c\u63a8\u7406\u3002\u6279\u91cf\u63a8\u7406\u53ef\u7528\u65bc\u96e2\u7dda\u4efb\u52d9\uff08\u5982\u7232\u6578\u64da\u6dfb\u52a0\u6a19\u7c64\uff09\u4ee5\u53ca\u8a55\u4f30\u7d93\u904e\u8a13\u7df4\u7684\u6a21\u578b\u3002\u5ef6\u9072\u6642\u9593 SLO \u4e0d\u662f\u6279\u91cf\u63a8\u7406\u7684\u512a\u5148\u7d1a\u3002\n### TPU \u82af\u7247\nTPU \u82af\u7247\u5305\u542b\u4e00\u500b\u6216\u591a\u500b TensorCore\u3002TensorCore \u7684\u6578\u91cf\u53d6\u6c7a\u65bc TPU \u82af\u7247\u7684\u7248\u672c\u3002\u6bcf\u500b TensorCore \u7531\u4e00\u500b\u6216\u591a\u500b\u77e9\u9663\u4e58\u6cd5\u55ae\u5143 (MXU)\u3001\u4e00\u500b\u77e2\u91cf\u55ae\u5143\u548c\u4e00\u500b\u6a19\u91cf\u55ae\u5143\u7d44\u6210\u3002\nMXU \u7531 [\u8108\u52d5\u9663\u5217](https://en.wikipedia.org/wiki/Systolic_array) \u4e2d\u7684 128 x 128 \u4e58\u6cd5\u7d2f\u52a0\u5668\u7d44\u6210\u3002 MXU \u5728 TensorCore \u4e2d\u63d0\u4f9b\u5927\u90e8\u5206\u8a08\u7b97\u80fd\u529b\u3002\u6bcf\u500b MXU \u80fd\u5920\u5728\u6bcf\u500b\u9031\u671f\u57f7\u884c 16K \u4e58\u6cd5\u7d2f\u52a0\u64cd\u4f5c\u3002\u6240\u6709\u4e58\u6cd5\u5747\u63a5\u53d7 [bfloat16](https://cloud.google.com/tpu/docs/bfloat16?hl=zh-cn) \u8f38\u5165\uff0c\u4f46\u6240\u6709\u7d2f\u52a0\u5747\u4ee5 FP32 \u6578\u5b57\u683c\u5f0f\u57f7\u884c\u3002\n\u8a72\u77e2\u91cf\u55ae\u4f4d\u7528\u65bc\u4e00\u822c\u8a08\u7b97\uff0c\u4f8b\u5982\u6fc0\u6d3b\u548c softmax\u3002\u6a19\u91cf\u55ae\u4f4d\u7528\u65bc\u63a7\u5236\u6d41\u3001\u8a08\u7b97\u5167\u5b58\u5730\u5740\u548c\u5176\u4ed6\u7dad\u8b77\u64cd\u4f5c\u3002\n### TPU \u7acb\u65b9\u9ad4\n4x4x4 \u62d3\u64b2\u3002\u9019\u50c5\u9069\u7528\u65bc 3D \u62d3\u64b2\uff08\u5f9e v4 TPU \u7248\u672c\u958b\u59cb\uff09\u3002\n### \u63a8\u65b7\n\u63a8\u65b7\u662f\u4f7f\u7528\u8a13\u7df4\u597d\u7684\u6a21\u578b\u5c0d\u65b0\u6578\u64da\u9032\u884c\u9810\u6e2c\u7684\u904e\u7a0b\u3002\u4f9b [\u50b3\u9001](#serving) \u9032\u7a0b\u4f7f\u7528\u3002\n### \u591a\u5207\u7247\u8207\u55ae\u5207\u7247\n\u591a\u5207\u7247\u662f\u4e00\u7d44\u5207\u7247\uff0c\u5c07 TPU \u9023\u63a5\u64f4\u5c55\u5230\u82af\u7247\u9593\u4e92\u9023 (ICI) \u9023\u63a5\u4e4b\u5916\uff0c\u4e26\u5229\u7528\u6578\u64da\u4e2d\u5fc3\u7db2\u7d61 (DCN) \u5728\u5207\u7247\u4e4b\u5916\u50b3\u8f38\u6578\u64da\u3002\u6bcf\u500b\u5207\u7247\u4e2d\u7684\u6578\u64da\u4ecd\u7136\u7531 ICI \u50b3\u8f38\u3002\u5229\u7528\u9019\u7a2e\u6df7\u5408\u9023\u63a5\uff0cMultislice \u53ef\u5be6\u73fe\u591a\u500b\u5207\u7247\u7684\u4e26\u884c\u6027\uff0c\u4e26\u4e14\u5141\u8a31\u60a8\u7232\u55ae\u500b\u4f5c\u696d\u4f7f\u7528\u7684 TPU \u6838\u5fc3\u6578\u91cf\u8d85\u51fa\u55ae\u500b\u5207\u7247\u80fd\u5920\u5bb9\u7d0d\u7684 TPU \u6838\u5fc3\u6578\u91cf\u3002\nTPU \u53ef\u7528\u65bc\u5728\u55ae\u500b\u5207\u7247\u6216\u591a\u500b\u5207\u7247\u4e0a\u904b\u884c\u4f5c\u696d\u3002 \u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u591a\u5207\u7247\u7c21\u4ecb](https://cloud.google.com/tpu/docs/multislice-introduction?hl=zh-cn) \u3002\n### Cloud TPU ICI \u5f48\u6027\nICI \u5f48\u6027\u6709\u52a9\u65bc\u63d0\u9ad8\u5728 [\u7acb\u65b9\u9ad4](#cube) \u4e4b\u9593\u9023\u63a5 TPU \u7684\u5149\u93c8\u8def\u548c\u5149\u5b78\u96fb\u8def\u958b\u95dc (OCS) \u7684\u5bb9\u932f\u80fd\u529b\u3002\uff08\u7acb\u65b9\u9ad4\u5167\u7684 II \u9023\u63a5\u4f7f\u7528\u4e0d\u53d7\u5f71\u97ff\u7684\u9285\u8272\u93c8\u63a5\uff09\u3002 ICI \u5f48\u6027\u5141\u8a31 ICI \u9023\u63a5\u570d\u7e5e OCS \u548c\u5149\u5b78 ICI \u6545\u969c\u9032\u884c\u8def\u7531\u3002\u56e0\u6b64\uff0c\u5b83\u63d0\u9ad8\u4e86 TPU \u5207\u7247\u7684\u8abf\u5ea6\u53ef\u7528\u6027\uff0c\u4f46\u4ee5\u66ab\u6642\u964d\u4f4e ICI \u6027\u80fd\u7232\u4ee3\u50f9\u3002\n\u8207 Cloud TPU v4 \u985e\u4f3c\uff0c\u5c0d\u65bc\u662f\u4e00\u500b\u7acb\u65b9\u9ad4\u6216\u66f4\u5927\u7684 v5p \u5207\u7247\uff0c\u7cfb\u7d71\u6703\u9ed8\u8a8d\u5553\u7528 ICI \u5f48\u6027\uff1a\n- \u6307\u5b9a\u52a0\u901f\u5668\u985e\u578b\u6642\u7232 v5p-128\n- \u6307\u5b9a\u52a0\u901f\u5668\u914d\u7f6e\u6642\u7232 4x4x4\n### \u5df2\u52a0\u5165\u968a\u5217\u7684\u8cc7\u6e90\nTPU \u8cc7\u6e90\u7684\u8868\u793a\u5f62\u5f0f\uff0c\u7528\u65bc\u5c07\u91dd\u5c0d\u55ae\u5207\u7247\u6216\u591a\u5207\u7247 TPU \u74b0\u5883\u7684\u8acb\u6c42\u52a0\u5165\u968a\u5217\u548c\u7ba1\u7406\u8acb\u6c42\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5df2\u52a0\u5165\u968a\u5217\u7684\u8cc7\u6e90\u7528\u6236\u6307\u5357](https://cloud.google.com/tpu/docs/queued-resources?hl=zh-cn) \u3002\n### \u63d0\u4f9b\u670d\u52d9\n\u670d\u52d9\u662f\u5c07\u7d93\u904e\u8a13\u7df4\u7684\u6a5f\u5668\u5b78\u7fd2\u6a21\u578b\u90e8\u7f72\u5230\u751f\u7522\u74b0\u5883\u7684\u904e\u7a0b\uff0c\u5728\u8a72\u74b0\u5883\u4e2d\uff0c\u6a21\u578b\u53ef\u7528\u65bc\u9032\u884c\u9810\u6e2c\u6216\u6c7a\u7b56\u3002\u5ef6\u9072\u6642\u9593\u548c\u670d\u52d9\u7d1a\u53ef\u7528\u6027\u5c0d\u65bc\u670d\u52d9\u5f88\u91cd\u8981\u3002\n### \u55ae\u500b\u4e3b\u6a5f\u548c\u591a\u4e3b\u6a5f\nTPU \u4e3b\u6a5f\u662f\u5728\u9023\u63a5\u5230 TPU \u786c\u4ef6\u7684\u5be6\u9ad4\u8a08\u7b97\u6a5f\u4e0a\u904b\u884c\u7684\u865b\u64ec\u6a5f\u3002TPU \u5de5\u4f5c\u8ca0\u8f09\u53ef\u4ee5\u4f7f\u7528\u4e00\u500b\u6216\u591a\u500b\u4e3b\u6a5f\u3002\n\u55ae\u4e3b\u6a5f\u5de5\u4f5c\u8ca0\u8f09\u50c5\u9650\u4e00\u500b TPU \u865b\u64ec\u6a5f\uff0c\u53ef\u4ee5\u8a2a\u554f 1 \u500b\u30014 \u500b\u6216 8 \u500b TPU \u82af\u7247\u3002\u591a\u4e3b\u6a5f TPU v5e \u5de5\u4f5c\u8ca0\u8f09\u53ef\u4ee5\u8a2a\u554f 8\u300112\u300116\u300132\u300164\u3001128 \u6216 256 \u500b TPU \u82af\u7247\uff0c\u6bcf\u56db\u500b TPU \u82af\u7247\u90fd\u6709\u4e00\u500b TPU \u865b\u64ec\u6a5f\u3002\u591a\u4e3b\u6a5f\u5de5\u4f5c\u8ca0\u8f09\u5728\u591a\u500b TPU \u865b\u64ec\u6a5f\u4e0a\u5206\u4f48\u8a13\u7df4\u3002\nTPU v5e \u652f\u6301\u55ae\u4e3b\u6a5f\u548c\u591a\u4e3b\u6a5f\u8a13\u7df4\u4ee5\u53ca\u55ae\u4e3b\u6a5f\u63a8\u7406\u3002\u4f7f\u7528 [Sax](https://github.com/google/saxml) \u652f\u6301\u591a\u4e3b\u6a5f\u63a8\u65b7\u3002 \u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5927\u8a9e\u8a00\u6a21\u578b\u670d\u52d9](https://cloud.google.com/tpu/docs/v5e-inference?hl=zh-cn#large_language_model_serving) \u3002\n### \u5207\u7247\nPod \u5207\u7247\u662f\u4f4d\u65bc\u540c\u4e00 TPU Pod \u5167\u7684\u4e00\u7cfb\u5217\u82af\u7247\uff0c\u9019\u4e9b\u82af\u7247\u7531\u9ad8\u901f\u82af\u7247\u9593\u4e92\u9023 (ICI) \u9023\u63a5\u3002\nv5p \u5177\u6709 3D \u5207\u7247\u5f62\u72c0\u3002\u5982\u9700\u67e5\u770b\u652f\u6301\u7684\u5207\u7247\u5f62\u72c0\u7684\u5217\u8868\uff0c\u8acb\u53c3\u95b1 [\u52a0\u901f\u5668\u985e\u578b](https://cloud.google.com/tpu/docs/supported-tpu-configurations?hl=zh-cn#tpu-v5p-config) \u90e8\u5206\u4e2d\u7684\u8868\u683c\u3002\nv5e \u5207\u7247\u7528 2D \u5207\u7247\u5f62\u72c0\u9032\u884c\u63cf\u8ff0\u3002\u5207\u7247\u5f62\u72c0\u4e2d\u7684\u6bcf\u500b\u6578\u5b57\u90fd\u5c0d\u61c9\u65bc\u4e00\u500b\u7dad\u5ea6\u4e2d\u7684 v5e \u6578\u91cf\u3002\u4f8b\u5982\uff0c `4x2` \u63cf\u8ff0\u5728 4 x 2 \u7db2\u683c\u4e2d\u6392\u5217 8 \u500b v5e \u82af\u7247\u3002\u5982\u9700\u67e5\u770b v5e \u652f\u6301\u7684\u5207\u7247\u5f62\u72c0\u5217\u8868\uff0c\u8acb\u53c3\u95b1 [\u52a0\u901f\u5668\u985e\u578b](https://cloud.google.com/tpu/docs/supported-tpu-configurations?hl=zh-cn#tpu-v5e-config) \u90e8\u5206\u4e2d\u7684\u8868\u683c\u3002\nTPU v4 \u548c [v5p \u5207\u7247](https://cloud.google.com/tpu/docs/system-architecture-tpu-vm?hl=zh-cn#v5p-configuration) \u53ef\u4ee5\u7528 v4 \u6216 v5p \u82af\u7247\u4f86\u63cf\u8ff0\u3002v4 \u6216 v5p \u5207\u7247\u7528 3D \u5f62\u72c0\u9032\u884c\u63cf\u8ff0\u3002\u5207\u7247\u5f62\u72c0\u4e2d\u7684\u6bcf\u500b\u6578\u5b57\u5747\u5c0d\u61c9\u65bc\u4e00\u500b\u7dad\u5ea6\u4e2d\u7684 v4 \u6216 v5p \u7684\u6578\u91cf\u3002\u4f8b\u5982\uff0c `4x4x8` \u63cf\u8ff0\u5728 4 x 4 x 8 \u7acb\u65b9\u9ad4\u4e2d\u6392\u5217 128 \u500b\u82af\u7247\u3002\nv4 \u548c v5p \u5207\u7247\u4e5f\u53ef\u4ee5\u7528\u5207\u7247\u4e2d\u7684 \u6578\u91cf\u4f86\u63cf\u8ff0\u3002\u4f8b\u5982\uff0c `v4-128` \u63cf\u8ff0\u4e86\u4e00\u500b\u5305\u542b 128 \u500b TensorCore \u7684 v4 \u5207\u7247\u3002v4 \u5207\u7247\u5177\u6709 16\u300132\u300164\u3001128\u3001256\u3001512\u30011024\u30012048 \u6216 4096 \u500b TensorCore\u3002 [v5p slices](https://cloud.google.com/tpu/docs/supported-tpu-configurations?hl=zh-cn#accelerator-types) \u90e8\u5206\u986f\u793a\u4e86 v5p \u5207\u7247\u7684\u5217\u8868\u4ee5\u53ca\u6bcf\u500b\u5207\u7247\u4e2d\u7684 TensorCore \u6578\u91cf\u3002\nTPU v3 \u5207\u7247\u4ee5 TensorCore \u7232\u7279\u5fb5\uff0c\u53ef\u901a\u904e 32\u3001128\u3001512\u30011024 \u6216 2048 \u500b TensorCore \u4f7f\u7528\u3002TPU v2 \u5207\u7247\u4e5f\u5f9e TensorCore \u7684\u89d2\u5ea6\u9032\u884c\u63cf\u8ff0\uff0c\u4e26\u4e14\u53ef\u7528\u65bc 32\u3001128\u3001256 \u6216 512 \u500b TensorCore\u3002\n\u548c \u4e5f\u662f\u6307\u5207\u7247\u5f62\u72c0\u3002\n### SparseCore\nv5p \u5728\u6bcf\u500b\u82af\u7247\u4e2d\u5305\u542b\u56db\u500b SparseCore\uff0c\u9019\u4e9b\u6838\u5fc3\u662f Dataflow \u8655\u7406\u5668\uff0c\u80fd\u5920\u7232\u4f9d\u8cf4\u65bc\u63a8\u85a6\u6a21\u578b\u4e2d\u7684\u5d4c\u5165\u7684\u6a21\u578b\u52a0\u901f\u6a21\u578b\u3002\n### TPU Pod\nTPU Pod \u662f\u901a\u904e\u5c08\u7528\u7db2\u7d61\u5206\u7d44\u7684\u4e00\u7d44\u9023\u7e8c\u7684 TPU\u3002TPU Pod \u4e2d\u7684 TPU \u82af\u7247\u7684\u6578\u91cf\u53d6\u6c7a\u65bc TPU \u7248\u672c\u3002\n### TPU \u865b\u64ec\u6a5f\u6216\u5de5\u4f5c\u5668\n\u904b\u884c Linux \u7684\u865b\u64ec\u6a5f\uff0c\u80fd\u5920\u8a2a\u554f\u5e95\u5c64 TPU\u3002\u5c0d\u65bc v5e TPU\uff0c\u6bcf\u500b TPU \u865b\u64ec\u6a5f\u53ef\u4ee5\u76f4\u63a5\u8a2a\u554f 1\u30014 \u6216 8 \u500b\u82af\u7247\uff0c\u5177\u9ad4\u53d6\u6c7a\u65bc\u7528\u6236\u6307\u5b9a\u7684\u52a0\u901f\u5668\u985e\u578b\u3002\u5c0d\u65bc v4 \u53ca\u66f4\u4f4e\u7248\u672c\uff0c\u6bcf\u500b TPU \u865b\u64ec\u6a5f\u53ef\u4ee5\u8a2a\u554f 4 \u500b TPU \u82af\u7247\u3002TPU \u865b\u64ec\u6a5f\u4e5f\u7a31\u7232\u201c\u5de5\u4f5c\u5668\u201d\u3002\n### TensorCores\nTPU \u82af\u7247\u5177\u6709\u4e00\u500b\u6216\u5169\u500b TensorCore\uff0c\u7528\u65bc\u904b\u884c\u77e9\u9663\u4e58\u6cd5\u3002TPU v5e \u7684\u6bcf\u500b\u82af\u7247\u4e0a\u6709\u4e00\u500b TensorCore\u3002TPU v2\u3001v3\u3001v4 \u548c v5p \u7684\u6bcf\u500b\u82af\u7247\u4e0a\u6709\u5169\u500b TensorCore\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3 TensorCore\uff0c\u8acb\u53c3\u95b1\u9019\u7bc7 [ACM \u6587\u7ae0](https://dl.acm.org/doi/pdf/10.1145/3360307) \u3002\n### \u5de5\u4f5c\u5668\n\u8acb\u53c3\u95b1 [TPU \u865b\u64ec\u6a5f](#tpu-vm) \u3002\n## TPU \u7248\u672c\nTPU \u7684\u78ba\u5207\u4f48\u5c40\u53d6\u6c7a\u65bc\u60a8\u6240\u4f7f\u7528\u7684 [TPU \u7248\u672c](https://cloud.google.com/tpu/docs/supported-tpu-versions?hl=zh-cn) \u3002\u5982\u9700\u77ad\u89e3 TPU v2 \u548c v3 \u7684\u67b6\u69cb\u8a73\u60c5\u548c\u6027\u80fd\u7279\u5fb5\uff0c\u8acb\u53c3\u95b1 [\u7528\u65bc\u8a13\u7df4\u6df1\u5ea6\u795e\u7d93\u7db2\u7d61\u7684\u9818\u57df\u7279\u5b9a\u8d85\u7d1a\u8a08\u7b97\u6a5f](https://dl.acm.org/doi/pdf/10.1145/3360307) \u3002\u4ee5\u4e0b\u90e8\u5206\u4ecb\u7d39\u4e86\u5176\u4ed6 TPU \u7248\u672c\u7684\u67b6\u69cb\u8a73\u60c5\u3002\n### TPU v5p \u67b6\u69cb\n\u672c\u7bc0\u4ecb\u7d39\u7279\u5b9a\u65bc v5p \u7248\u672c\u7684\u7cfb\u7d71\u67b6\u69cb\u3002\n\u6bcf\u500b TensorCore \u90fd\u6709\u56db\u500b\u77e9\u9663\u4e58\u6cd5\u55ae\u5143 (MXU)\u3001\u4e00\u500b\u77e2\u91cf\u55ae\u4f4d\u548c\u4e00\u500b\u6a19\u91cf\u55ae\u4f4d\u3002\n\u55ae\u500b v5p Pod \u4e2d\u6709 8960 \u500b\u82af\u7247\u3002\u53ef\u4ee5\u8abf\u5ea6\u7684\u6700\u5927\u4f5c\u696d\u662f 96 \u500b\u7acb\u65b9\u9ad4\uff086144 \u500b\u82af\u7247\uff09\u4f5c\u696d\u3002\n\u4e0b\u8868\u986f\u793a\u4e86 v5p \u7684\u4e3b\u8981\u898f\u7bc4\u3002\n| \u5bc6\u9470\u898f\u7bc4     | v5p \u503c   |\n|:--------------------------|:----------------|\n| \u6bcf\u500b\u82af\u7247\u7684\u5cef\u503c\u8a08\u7b97 (bf16) | 459 \u500b TFLOP |\n| HBM2e \u5bb9\u91cf\u548c\u5e36\u5bec   | 95GB\u30012765 GBps |\n| TPU Pod \u5927\u5c0f    | 8960 \u82af\u7247  |\n| \u4e92\u9023\u62d3\u64b2     | 3D \u74b0   |\n| \u82af\u7247\u9593\u4e92\u9023 BW    | 4800 Gbps  |\n### TPU v5e\n\u6bcf\u500b v5e \u82af\u7247\u5305\u542b\u4e00\u500b TensorCore\u3002\u6bcf\u500b TensorCore \u5747\u6709 4 \u500b\u77e9\u9663\u4e58\u6cd5\u55ae\u5143 (MXU)\u3001\u4e00\u500b\u77e2\u91cf\u55ae\u5143\u548c\u4e00\u500b\u6a19\u91cf\u55ae\u5143\u3002\n\u4e0b\u5716\u5c55\u793a\u4e86 TPU v5e \u82af\u7247\u3002\n\u4e0b\u8868\u986f\u793a\u4e86 v5e \u7684\u5bc6\u9470\u82af\u7247\u898f\u683c\u53ca\u5176\u503c\u3002\n| 0       | 1    |\n|:--------------------------|:----------------|\n| \u5bc6\u9470\u82af\u7247\u898f\u683c    | v5e \u503c   |\n| \u6bcf\u500b\u82af\u7247\u7684\u5cef\u503c\u8a08\u7b97 (bf16) | 197 \u500b TFLOP |\n| \u6bcf\u500b\u82af\u7247\u7684\u5cef\u503c\u8a08\u7b97 (Int8) | 393 \u500b TFLOP |\n| HBM2 \u5bb9\u91cf\u548c\u5e36\u5bec   | 16 GB\u3001819 GBps |\n| \u82af\u7247\u9593\u4e92\u9023\u9ed1\u767d   | 1600 Gbps  |\n\u4e0b\u8868\u986f\u793a\u4e86 v5e \u7684 Pod \u898f\u7bc4\u53ca\u5176\u503c\u3002\n| 0       | 1     |\n|:----------------------------|:------------------|\n| \u95dc\u9375 Pod \u898f\u7bc4    | v5e \u503c   |\n| TPU Pod \u5927\u5c0f    | 256 \u500b\u82af\u7247  |\n| \u4e92\u9023\u62d3\u64b2     | 2D \u74b0    |\n| \u6bcf\u500b Pod \u7684\u8a08\u7b97\u5cef\u503c   | 100 PetaOps(Int8) |\n| \u6bcf\u500b Pod \u7684\u5168\u6e1b\u5c11\u5e36\u5bec  | 51.2 TB/\u79d2  |\n| \u6bcf\u500b Pod \u7684\u5c0d\u5206\u5e36\u5bec   | 1.6 TB/\u79d2   |\n| \u6bcf\u500b Pod \u7684\u6578\u64da\u4e2d\u5fc3\u7db2\u7d61\u5e36\u5bec | 6.4 Tbps   |\n### TPU v4\n\u6bcf\u500b TPU v4 \u82af\u7247\u5305\u542b\u5169\u500b TensorCore\u3002\u6bcf\u500b TensorCore \u5747\u6709\u56db\u500b MXU\u3001\u4e00\u500b\u77e2\u91cf\u55ae\u5143\u548c\u4e00\u500b\u6a19\u91cf\u55ae\u5143\u3002\u4e0b\u8868\u986f\u793a\u4e86 v4 TPU Pod \u7684\u5bc6\u9470\u898f\u7bc4\u3002\n| \u95dc\u9375\u898f\u7bc4     | v4 Pod \u503c        |\n|:-------------------------|:----------------------------------------|\n| \u6bcf\u500b\u82af\u7247\u7684\u5cef\u503c\u8a08\u7b97  | \u6bcf\u79d2 275 \u842c\u5104\u6b21\u6d6e\u9ede\u904b\u7b97\uff08bf16 \u6216 int8\uff09 |\n| HBM2 \u5bb9\u91cf\u548c\u5e36\u5bec   | 32 GiB\u30011200 GBps      |\n| \u6e2c\u91cf\u7684\u6700\u5c0f/\u5e73\u5747/\u6700\u5927\u529f\u7387 | 90/170/192 W       |\n| TPU Pod \u5927\u5c0f    | 4096 \u82af\u7247        |\n| \u4e92\u9023\u62d3\u64b2     | 3D \u7db2\u683c         |\n| \u6bcf\u500b Pod \u7684\u8a08\u7b97\u5cef\u503c  | 1.1 exaflop\uff08bf16 \u6216 int8\uff09    |\n| \u6bcf\u500b Pod \u7684\u5168\u6e1b\u5c11\u5e36\u5bec | 1.1 PB/\u79d2        |\n| \u6bcf\u500b Pod \u7684\u5c0d\u5206\u5e36\u5bec  | 24 TB/\u79d2        |\n\u4e0b\u5716\u5c55\u793a\u4e86 TPU v4 \u82af\u7247\u3002\nv4 TPU \u5728 3 \u7dad\u7a7a\u9593\u5167\u76f4\u63a5\u9023\u63a5\u5230\u6700\u8fd1\u7684\u9130\u8fd1\u82af\u7247\uff0c\u5f9e\u800c\u5f62\u6210 3D \u7db2\u7d61\u9023\u63a5\u7db2\u683c\u3002\u7576\u5207\u7247\u7b49\u65bc\u6216\u5927\u65bc\u55ae\u500b\u7acb\u65b9\u9ad4\u6642\uff0c\u53ef\u5c07\u9023\u63a5\u914d\u7f6e\u7232 3D \u74b0\u9762\u3002\u4e00\u822c\u4f86\u8aaa\uff0c3D \u914d\u7f6e\u7684\u6027\u80fd\u8981\u512a\u65bc 3D \u7db2\u683c\u914d\u7f6e\u3002\n### TPU v3\n\u6bcf\u500b v3 TPU \u82af\u7247\u5305\u542b\u5169\u500b TensorCore\u3002\u6bcf\u500b TensorCore \u6709\u5169\u500b MXU\u3001\u4e00\u500b\u77e2\u91cf\u55ae\u5143\u548c\u4e00\u500b\u6a19\u91cf\u55ae\u5143\u3002\u4e0b\u8868\u986f\u793a\u4e86 v3 TPU Pod \u7684\u5bc6\u9470\u898f\u7bc4\u53ca\u5176\u503c\u3002\n| \u95dc\u9375\u898f\u7bc4     | v3 Pod \u503c      |\n|:-------------------------|:---------------------------------|\n| \u6bcf\u500b\u82af\u7247\u7684\u5cef\u503c\u8a08\u7b97  | \u6bcf\u79d2 123 \u842c\u5104\u6b21\u6d6e\u9ede\u904b\u7b97 (bf16) |\n| HBM2 \u5bb9\u91cf\u548c\u5e36\u5bec   | 32 GiB\u3001900 GBps     |\n| \u6e2c\u91cf\u7684\u6700\u5c0f/\u5e73\u5747/\u6700\u5927\u529f\u7387 | 123/220/262 W     |\n| TPU Pod \u5927\u5c0f    | 1024 \u500b\u82af\u7247      |\n| \u4e92\u9023\u62d3\u64b2     | 2D \u74b0\u9762       |\n| \u6bcf\u500b Pod \u7684\u8a08\u7b97\u5cef\u503c  | \u6bcf\u79d2 126 \u5343\u842c\u5104\u6b21\u6d6e\u9ede\u904b\u7b97 (bf16) |\n| \u6bcf\u500b Pod \u7684\u5168\u6e1b\u5c11\u5e36\u5bec | 340 TB/\u79d2      |\n| \u6bcf\u500b Pod \u7684\u5c0d\u5206\u5e36\u5bec  | 6.4 TB/\u79d2      |\n\u4e0b\u5716\u5c55\u793a\u4e86 TPU v3 \u82af\u7247\u3002### TPU v4 \u8207 v3 \u76f8\u6bd4\u7684\u6027\u80fd\u512a\u52e2\n\u672c\u90e8\u5206\u4ecb\u7d39 TPU v4 \u7684\u6027\u80fd\u512a\u52e2\n\u975e\u7d71\u4e00\u5167\u5b58\u8a2a\u554f (NUMA) \u662f\u4e00\u7a2e\u9069\u7528\u65bc\u5177\u6709\u591a\u500b CPU \u7684\u6a5f\u5668\u7684\u8a08\u7b97\u6a5f\u5167\u5b58\u67b6\u69cb\u3002\u6bcf\u500b CPU \u90fd\u53ef\u4ee5\u76f4\u63a5\u8a2a\u554f\u4e00\u584a\u9ad8\u901f\u5167\u5b58\u3002\u4e00\u500b CPU \u53ca\u5176\u5167\u5b58\u7a31\u7232 NUMA \u7bc0\u9ede\u3002NUMA \u7bc0\u9ede\u9023\u63a5\u5230\u76f4\u63a5\u76f8\u9130\u7684 NUMA \u7bc0\u9ede\u3002\u4e00\u500b NUMA \u7bc0\u9ede\u4e2d\u7684 CPU \u53ef\u4ee5\u8a2a\u554f\u53e6\u4e00\u500b NUMA \u7bc0\u9ede\u4e2d\u7684\u5167\u5b58\uff0c\u4f46\u9019\u7a2e\u8a2a\u554f\u6bd4\u8a2a\u554f NUMA \u7bc0\u9ede\u4e2d\u7684\u5167\u5b58\u8981\u6162\u3002\n\u5728\u591a CPU \u6a5f\u5668\u4e0a\u904b\u884c\u7684\u8edf\u4ef6\u53ef\u4ee5\u5c07 CPU \u6240\u9700\u7684\u6578\u64da\u5b58\u5132\u5728\u5176 NUMA \u7bc0\u9ede\u4e2d\uff0c\u5f9e\u800c\u63d0\u9ad8\u5167\u5b58\u541e\u5410\u91cf\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3 NUMA\uff0c\u8acb\u53c3\u95b1\u7dad\u57fa\u767e\u79d1\u4e0a\u7684 [\u975e\u7d71\u4e00\u5167\u5b58\u8a2a\u554f](https://en.wikipedia.org/wiki/Non-uniform_memory_access) \u3002\n\u60a8\u53ef\u4ee5\u901a\u904e\u5c07\u8a13\u7df4\u8173\u672c\u7d81\u5b9a\u5230 NUMA Node 0 \u4f86\u5229\u7528 NUMA \u4f4d\u7f6e\u512a\u52e2\u3002\n\u8981\u5553\u7528 NUMA \u7bc0\u9ede\u7d81\u5b9a\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u5b89\u88dd numactl \u547d\u4ee4\u884c\u5de5\u5177\u3002```\n\u00a0$ sudo apt-get update\u00a0$ sudo apt-get install numactl\n```\n- \u5553\u52d5\u8a13\u7df4\u8173\u672c\u6642\u4f7f\u7528 `numactl --cpunodebind=0` \u3002\u9019\u6703\u5c07\u60a8\u7684\u8173\u672c\u4ee3\u78bc\u7d81\u5b9a\u5230 NUMA Node 0\u3002```\n\u00a0$ numactl --cpunodebind=0 python3 your-training-script\n```\n\u5728\u4ee5\u4e0b\u60c5\u6cc1\u4e0b\uff0c\u8acb\u5553\u7528 NUMA \u7bc0\u9ede\u7d81\u5b9a\uff1a\n- \u5982\u679c\u60a8\u7684\u5de5\u4f5c\u8ca0\u8f09\u56b4\u91cd\u4f9d\u8cf4 CPU \u5de5\u4f5c\u8ca0\u8f09\uff08\u4f8b\u5982\uff0c\u6620\u50cf\u5206\u985e\u3001\u63a8\u85a6\u5de5\u4f5c\u8ca0\u8f09\uff09\uff0c\u800c\u4e0d\u8003\u616e\u6846\u67b6\u3002\n- \u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f\u4e0d\u5e36 -pod \u5f8c\u7db4\u7684 TPU \u904b\u884c\u6642\u7248\u672c\uff08\u4f8b\u5982`tpu-vm-tf-2.10.0-v4`\uff09\uff0c\n\u5176\u4ed6\u5167\u5b58\u7cfb\u7d71\u5dee\u7570\uff1a\n- v4 TPU \u82af\u7247\u5728\u6574\u500b\u82af\u7247\u4e0a\u64c1\u6709\u7d71\u4e00\u7684 32 GiB HBM \u5167\u5b58\u7a7a\u9593\uff0c\u6709\u52a9\u65bc\u5728\u5169\u500b\u82af\u7247\u4e0a TensorCore \u4e4b\u9593\u66f4\u597d\u5730\u5354\u8abf\u3002\n- \u4f7f\u7528\u6700\u65b0\u7684\u5167\u5b58\u6a19\u6e96\u548c\u901f\u5ea6\u6539\u9032\u4e86 HBM \u6027\u80fd\u3002\n- \u6539\u9032\u4e86 DMA \u6027\u80fd\u914d\u7f6e\u6587\u4ef6\uff0c\u4e26\u4e14\u5167\u7f6e\u5c0d 512B \u7c92\u5ea6\u7684\u9ad8\u6027\u80fd\u6b65\u9032\u652f\u6301\u3002- MXU \u7684\u6578\u91cf\u7ffb\u500d\uff0c\u6642\u9418\u983b\u7387\u63d0\u9ad8\uff0c\u6700\u591a\u53ef\u63d0\u4f9b 275 TFLOPS\u3002\n- 2 \u500d\u8f49\u7f6e\u548c\u6392\u5217\u5e36\u5bec\u3002\n- \u901a\u7528\u5167\u5b58 (Cmem) \u7684\u52a0\u8f09\u548c\u5b58\u5132\u5167\u5b58\u8a2a\u554f\u6a21\u578b\u3002\n- \u66f4\u5feb\u7684 MXU \u6b0a\u91cd\u52a0\u8f09\u5e36\u5bec\u548c 8 \u4f4d\u6a21\u5f0f\u652f\u6301\uff0c\u53ef\u4ee5\u964d\u4f4e\u6279\u6b21\u5927\u5c0f\u4e26\u7e2e\u77ed\u63a8\u65b7\u5ef6\u9072\u6642\u9593\u3002\u6bcf\u500b\u82af\u7247\u6709\u516d\u500b\u4e92\u9023\u93c8\u8def\uff0c\u53ef\u5be6\u73fe\u7db2\u7d61\u76f4\u5f91\u66f4\u5c0f\u7684\u7db2\u7d61\u62d3\u64b2\u3002- x16 PCIE gen3 \u63a5\u53e3\u5230\u4e3b\u6a5f\uff08\u76f4\u63a5\u9023\u63a5\uff09\u3002\n- \u6539\u9032\u4e86\u5b89\u5168\u6a21\u578b\u3002\n- \u63d0\u9ad8\u4e86\u80fd\u6e90\u6548\u7387\u3002\n### TPU v3 \u76f8\u5c0d\u65bc v2 \u7684\u6027\u80fd\u512a\u52e2\nTPU v3 \u914d\u7f6e\u4e2d\u589e\u52a0\u7684\u6bcf\u500b TensorCore \u7684 FLOPS \u548c\u5167\u5b58\u5bb9\u91cf\u53ef\u4ee5\u901a\u904e\u4ee5\u4e0b\u65b9\u5f0f\u63d0\u9ad8\u6a21\u578b\u7684\u6027\u80fd\uff1a\n- \u5c0d\u65bc\u53d7\u9650\u65bc\u8a08\u7b97\u7684\u6a21\u578b\uff0cTPU v3 \u914d\u7f6e\u7232\u6bcf\u500b TensorCore \u63d0\u4f9b\u4e86\u986f\u8457\u7684\u6027\u80fd\u512a\u52e2\u3002\u5982\u679c TPU v2 \u914d\u7f6e\u4e0a\u7684\u5167\u5b58\u53d7\u9650\u6a21\u578b\u5728 TPU v3 \u914d\u7f6e\u4e0a\u4e5f\u53d7\u9650\u65bc\u5167\u5b58\uff0c\u53ef\u80fd\u7121\u6cd5\u5be6\u73fe\u76f8\u540c\u7684\u6027\u80fd\u63d0\u5347\u3002\n- \u5728 TPU v2 \u914d\u7f6e\u4e0b\uff0c\u5982\u679c\u5167\u5b58\u7121\u6cd5\u5bb9\u7d0d\u6578\u64da\uff0c\u5247 TPU v3 \u53ef\u4ee5\u63d0\u4f9b\u66f4\u9ad8\u7684\u6027\u80fd\u4e26\u6e1b\u5c11\u4e2d\u9593\u503c\u7684\u91cd\u65b0\u8a08\u7b97\uff08\u518d\u5177\u9ad4\u5316\uff09\u3002\n- TPU v3 \u914d\u7f6e\u53ef\u4ee5\u904b\u884c\u6279\u6b21\u5927\u5c0f\u4e0d\u9069\u5408 TPU v2 \u914d\u7f6e\u7684\u65b0\u6a21\u578b\u3002\u4f8b\u5982\uff0cTPU v3 \u53ef\u80fd\u5141\u8a31\u66f4\u6df1\u7684 ResNet \u548c\u4f7f\u7528 RetinaNet \u7684\u8f03\u5927\u5716\u7247\u3002\n\u56e0\u8a13\u7df4\u6b65\u9a5f\u7b49\u5f85\u8f38\u5165\u800c\u5728 TPU v2 \u4e0a\u5e7e\u4e4e\u6210\u7232\u53d7\u9650\u65bc\u8f38\u5165\uff08\u201c\u994b\u5165\u201d\uff09\u7684\u6a21\u578b\uff0c\u5728 Cloud TPU v3 \u4e2d\u4e5f\u53ef\u80fd\u6703\u53d7\u9650\u65bc\u8f38\u5165\u3002\u6d41\u6c34\u7dda\u6027\u80fd\u6307\u5357\u53ef\u5e6b\u52a9\u60a8\u89e3\u6c7a\u994b\u5165\u554f\u984c\u3002\n## Cloud TPU \u865b\u64ec\u6a5f\u67b6\u69cb\n\u60a8\u8207 TPU \u4e3b\u6a5f\uff08\u548c TPU \u677f\uff09\u7684\u4ea4\u4e92\u65b9\u5f0f\u53d6\u6c7a\u65bc\u60a8\u4f7f\u7528\u7684 TPU \u865b\u64ec\u6a5f\u67b6\u69cb\uff1aTPU \u7bc0\u9ede\u6216 TPU \u865b\u64ec\u6a5f\u3002\n### TPU \u7bc0\u9ede\u67b6\u69cb\n**\u91cd\u8981\u63d0\u793a** \uff1aTPU \u7bc0\u9ede\u67b6\u69cb\u4e0d\u652f\u6301 TPU v4\u3002\nTPU \u7bc0\u9ede\u67b6\u69cb\u7531\u901a\u904e gRPC \u8207 TPU \u4e3b\u6a5f\u901a\u4fe1\u7684\u7528\u6236\u865b\u64ec\u6a5f\u7d44\u6210\u3002\u4f7f\u7528\u6b64\u67b6\u69cb\u6642\uff0c\u60a8\u7121\u6cd5\u76f4\u63a5\u8a2a\u554f TPU \u4e3b\u6a5f\uff0c\u56e0\u6b64\u5f88\u96e3\u8abf\u8a66\u8a13\u7df4\u548c TPU \u932f\u8aa4\u3002### TPU \u865b\u64ec\u6a5f\u67b6\u69cb\n\u85c9\u52a9 TPU \u865b\u64ec\u6a5f\u67b6\u69cb\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 SSH \u76f4\u63a5\u9023\u63a5\u5230\u7269\u7406\u9023\u63a5\u5230 TPU \u8a2d\u5099\u7684\u865b\u64ec\u6a5f\u3002\u60a8\u64c1\u6709\u865b\u64ec\u6a5f\u7684 root \u8a2a\u554f\u6b0a\u9650\uff0c\u56e0\u6b64\u53ef\u4ee5\u904b\u884c\u4efb\u610f\u4ee3\u78bc\u3002\u60a8\u53ef\u4ee5\u8a2a\u554f\u7de8\u8b6f\u5668\u548c\u904b\u884c\u6642\u8abf\u8a66\u65e5\u8a8c\u4ee5\u53ca\u932f\u8aa4\u6d88\u606f\u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n- [\u5feb\u901f\u5165\u9580](https://cloud.google.com/tpus/docs/quick-starts?hl=zh-cn) \n- [\u6559\u7a0b](https://cloud.google.com/tpus/docs/tutorials?hl=zh-cn)", "guide": "Cloud TPU"}