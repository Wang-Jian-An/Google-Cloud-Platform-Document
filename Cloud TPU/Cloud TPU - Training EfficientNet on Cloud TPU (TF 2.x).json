{"title": "Cloud TPU - Training EfficientNet on Cloud TPU (TF 2.x)", "url": "https://cloud.google.com/tpu/docs/tutorials/efficientnet-2.x", "abstract": "# Cloud TPU - Training EfficientNet on Cloud TPU (TF 2.x)\nThis tutorial shows you how to train a Keras EfficientNet model on Cloud TPU using `tf.distribute.TPUStrategy` .\nIf you are not familiar with Cloud TPU, it is strongly recommended that you go through the [quickstart](https://cloud.google.com/tpu/docs/quickstart) to learn how to create a Cloud TPU and Compute Engine VM.\n **Warning:** This tutorial uses a third-party dataset. Google provides no representation, warranty, or other guarantees about the validity, or any other aspects of this dataset.\n", "content": "## Objectives\n- Create a Cloud Storage bucket to hold your dataset and model output.\n- Prepare a fake imagenet dataset that is similar to the ImageNet dataset.\n- Run the training job.\n- Verify the output results.\n## CostsIn this document, you use the following billable components of Google Cloud:- Compute Engine\n- Cloud TPU\n- Cloud Storage\nTo generate a cost estimate based on your projected usage,  use the [pricing calculator](/products/calculator) . \n## Before you begin **Important:** You can use this tutorial with either the TPU VM or the TPU Node configuration. The two VM architectures are described in [System Architecture](/tpu/docs/system-architecture-tpu-vm) . The `gcloud` commands you use depend on the TPU configuration you are using. In this tutorial, each `gcloud` command is shown in a tabbed section. Choose the tab for the TPU configuration you want to use and the web page shows the appropriate `gcloud` command. Unless you know you need to use TPU Nodes, we recommend using TPU VMs.\nBefore starting this tutorial, check that your Google Cloud project is correctly set up.- This walkthrough uses billable components of Google Cloud. Check the [Cloud TPU pricing page](/tpu/docs/pricing) to  estimate your costs. Be sure to [clean up](#clean-up) resources you create when you've finished with them to avoid unnecessary  charges.\n## Cloud TPU single device training **Note:** Do you want to train the model using a Cloud TPU pod? See [ TPU Pod training.](#pod-training) \nThis section describes how to configure Cloud TPU resources and train the EfficientNet model using a single Cloud TPU device.\n **Important: ** Set up all resources (Compute Engine VM, Cloud TPU, and Cloud Storage bucket) in the same region/zone to reduce network latency and network costs. VMs and Cloud TPU nodes are located in [specific zones](/tpu/docs/types-zones#types) , which are subdivisions within a region.- Open a Cloud Shell window. [Open Cloud Shell](https://console.cloud.google.com/?cloudshell=true) \n- Create a variable for your project's ID.```\nexport PROJECT_ID=project-id\n```\n- Configure Google Cloud CLI to use the project where you want to create Cloud TPU.```\ngcloud config set project ${PROJECT_ID}\n```The first time you run this command in a new Cloud Shell VM, an `Authorize Cloud Shell` page is displayed. Click `Authorize` at the bottom of the page to allow `gcloud` to make API calls with your credentials.For more information on the `gcloud` command, see the [gcloud Reference](/sdk/gcloud/reference) .\n- Create a Service Account for the Cloud TPU project.Service accounts allow the Cloud TPU service to access other Google Cloud services.```\ngcloud beta services identity create --service tpu.googleapis.com --project $PROJECT_ID\n```The command returns a Cloud TPU Service Account with following format:```\nservice-PROJECT_NUMBER@cloud-tpu.iam.gserviceaccount.com\n```\n- Export TPU setup variablesSet the zone where you will train the model and store any training-related data.```\n$ export ZONE=europe-west4-a\n```\n- Create a Cloud Storage bucket using the following command:```\ngsutil mb -p ${PROJECT_ID} -c standard -l europe-west4 gs://bucket-name/\n```This Cloud Storage bucket stores the data you use to train your model and the training results. The `gcloud compute tpus execution-groups` command used in this tutorial sets up default permissions for the Cloud TPU Service Account you set up in the previous step. If you want finer-grain permissions, review the [access level permissions](/tpu/docs/storage-buckets) .The bucket location must be in the same region as your Compute Engine (VM) and your Cloud TPU node.\n- Prepare your dataset or use ImageNet is an image database. The images in the database are organized into a hierarchy, with each node of the hierarchy depicted by hundreds and thousands of images.This tutorial uses a demonstration version of the full ImageNet dataset, referred to as . This demonstration version allows you to test the tutorial, while reducing the storage and time requirements typically associated with running a model against the full ImageNet database.The fake_imagenet dataset is at this location on Cloud Storage:```\ngs://cloud-tpu-test-datasets/fake_imagenet\n```The fake_imagenet dataset is only useful for understanding how to use a Cloud TPU and validating end-to-end performance. The accuracy numbers and saved model will not be meaningful.If you want to use the full ImageNet dataset, see [Downloading, preprocessing, and uploading the ImageNet dataset](/tpu/docs/imagenet-setup) . **Caution:** For this tutorial, make sure you **do not** set the `STORAGE_BUCKET` environment variable to the path of the fake_imagenet dataset. You can read from `gs://cloud-tpu-test-datasets` but you cannot write to it. As a result, you cannot use it to write out training logs. Make sure the `STORAGE_BUCKET` environment variable is set to your own Cloud Storage bucket, as shown above.\n- Launch TPU resources using the `gcloud` command. The command you use depends on whether you are using TPU VMs or TPU nodes. For more information on the two VM architecture, see [System Architecture](/tpu/docs/system-architecture-tpu-vm) .\n```\n$ gcloud compute tpus tpu-vm create efficientnet-tutorial \\--zone=${ZONE} \\--accelerator-type=v3-8 \\--version=tpu-vm-tf-2.16.1-pjrt\n``````\ngcloud compute tpus execution-groups create \\--name=efficientnet-tutorial \\--zone=${ZONE} \\--disk-size=300 \\--machine-type=n1-standard-16 \\--tf-version=2.12.0 \\--accelerator-type=v3-8\n``` **Note:** If you have more than one project, you must specify the project ID with the `--project` flag.For more information on the `gcloud` command, see the [gcloud Reference](/sdk/gcloud/reference) . **Note:** The first time you run gcloud compute tpus tpu-vm or gcloud compute tpus execution-groups on a project it takes approximately 5 minutes to perform startup tasks such as SSH key propagation and API turnup.\n- If you are not automatically logged in to the Compute Engine instance, log in by running the following `ssh` command. When you are logged into the VM, your shell prompt changes from `username@projectname` to `username@vm-name` :\n```\ngcloud compute tpus tpu-vm ssh efficientnet-tutorial --zone=${ZONE}\n```\n```\ngcloud compute ssh efficientnet-tutorial --zone=${ZONE}\n```\n **Key Point:** From this point on, a prefix of **(vm) $** means you should run the command on the Compute Engine VM instance.\n- Set the Cloud TPU name variable.\n```\n(vm)$ export TPU_NAME=local\n```\n```\n(vm)$ export TPU_NAME=efficientnet-tutorial\n```\n- Set Cloud Storage bucket variablesReplace with the name of your Cloud Storage bucket:```\n(vm)$ export STORAGE_BUCKET=gs://bucket-name\n``````\n(vm)$ export MODEL_DIR=${STORAGE_BUCKET}/efficientnet-2x(vm)$ export DATA_DIR=gs://cloud-tpu-test-datasets/fake_imagenet\n```The training application expects your training data to be accessible in Cloud Storage. The training application also uses your Cloud Storage bucket to store checkpoints during training.\n- When creating your TPU, if you set the `--version` parameter to a version ending with `-pjrt` , set the following environment variables to enable the PJRT runtime:```\n\u00a0 (vm)$ export NEXT_PLUGGABLE_DEVICE_USE_C_API=true\u00a0 (vm)$ export TF_PLUGGABLE_DEVICE_LIBRARY_PATH=/lib/libtpu.so\n```\n- Install TensorFlow requirements.The command you use depends on whether you are using TPU VMs or TPU Nodes.\n```\n(vm)$ pip3 install -r /usr/share/tpu/models/official/requirements.txt\n```\n```\n(vm)$ pip3 install --user -r /usr/share/models/official/requirements.txt\n```\n- The EfficientNet training script requires extra packages (TPU VM only). Install them now:\n```\n(vm)$ sudo pip3 install tensorflow-addons(vm)$ sudo pip3 install tensorflow-model-optimization>=0.1.3\n```\n- Set some required environment variables:\n```\n(vm)$ export PYTHONPATH=\"${PYTHONPATH}:/usr/share/tpu/models\"\n```\n```\n(vm)$ export PYTHONPATH=\"${PYTHONPATH}:/usr/share/models\"\n```\nThe EfficientNet model is pre-installed on your Compute Engine VM.\n- Change to directory that stores the model:\n```\n(vm)$ cd /usr/share/tpu/models/official/legacy/image_classification\n```\n```\n(vm)$ cd /usr/share/models/official/legacy/image_classification\n```\n- Train the model. This uses a fake_imagenet dataset and trains EfficientNet for one epoch.```\n(vm)$ python3 classifier_trainer.py \\\u00a0 --mode=train_and_eval \\\u00a0 --model_type=efficientnet \\\u00a0 --dataset=imagenet \\\u00a0 --tpu=${TPU_NAME} \\\u00a0 --data_dir=${DATA_DIR} \\\u00a0 --model_dir=${MODEL_DIR} \\\u00a0 --config_file=configs/examples/efficientnet/imagenet/efficientnet-b0-tpu.yaml \\\u00a0 --params_override=\"train.epochs=1, train_dataset.builder=records, validation_dataset.builder=records\"\n```This will train EfficientNet for 1 epoch and will complete on a v3-8 Cloud TPU node in approximately 40 minutes. When the training script completes, output similar to the following appears:```\nRun stats:\n{\n 'accuracy_top_1': 0.0010172526817768812,\n 'eval_loss': 7.104171276092529,\n 'loss': 7.113735675811768,\n 'training_accuracy_top_1': 0.0009773431811481714,\n 'step_timestamp_log': [ 'BatchTimestamp<batch_index: 0,\n timestamp: 1604960724.2224622>',\n 'BatchTimestamp<batch_index: 1251,\n timestamp: 1604961281.3745298>'\n ],\n 'train_finish_time': 1604961342.6359076,\n 'avg_exp_per_second': 2071.493269569079\n}\n```To train the EfficientNet to convergence on the ImageNet dataset, run it for 90 epochs as shown in the following script. Training and evaluation are done together. Each epoch has 1251 steps for a total of 112590 training steps and 48 evaluation steps.```\n(vm)$ python3 classifier_trainer.py \\\u00a0 \u00a0 \u00a0--mode=train_and_eval \\\u00a0 \u00a0 \u00a0--model_type=efficientnet \\\u00a0 \u00a0 \u00a0--dataset=imagenet \\\u00a0 \u00a0 \u00a0--tpu=${TPU_NAME} \\\u00a0 \u00a0 \u00a0--data_dir=${DATA_DIR} \\\u00a0 \u00a0 \u00a0--model_dir=${MODEL_DIR} \\\u00a0 \u00a0 \u00a0--config_file=configs/examples/efficientnet/imagenet/efficientnet-b0-tpu.yaml \\\u00a0 \u00a0 \u00a0--params_override=\"train_dataset.builder=records, validation_dataset.builder=records\"\n```Since the training was done on the fake_imagenet dataset, the output results do not reflect actual output that would appear if the training was performed on a real dataset.You have now completed single-device training. Use the following steps to delete the current single-device TPU resources.\n- Disconnect from the Compute Engine instance:```\n(vm)$ exit\n```Your prompt should now be `username@projectname` , showing you are in the Cloud Shell.\n- Delete the TPU resource.\n```\n$ gcloud compute tpus tpu-vm delete efficientnet-tutorial \\--zone=${ZONE}\n``````\n$ gcloud compute tpus execution-groups delete efficientnet-tutorial \\--tpu-only \\--zone=${ZONE}\n```\nAt this point, you can either conclude this tutorial and [clean up](#cleanup) , or you can continue and explore running the model on Cloud TPU Pods.## Scale your model with Cloud TPU Pods **Important:** You can scale your model with either the TPU VM or the TPU Node configuration. The two VM architectures are described in [System Architecture](/tpu/docs/system-architecture-tpu-vm) . For Pod training, you only need to follow the instructions for your TPU configuration, TPU VM or TPU Node.\nTraining your model on Cloud TPU Pods may require some changes to your training script. For information, see [Training on TPU Pods](/tpu/docs/training-on-tpu-pods) .## Cloud TPU Pod training **Important:** If you have already set up a Cloud TPU project, Service Account, storage bucket, and dataset for single device training, you can skip to [launching TPU resources](#launch-resources) .\nThis section provides information on setting up a Cloud Storage bucket and Cloud TPU resources for Pod training.\n **Important: ** Set up your Cloud TPU resources and your Cloud Storage bucket in the same region/zone to reduce network latency and network costs. Cloud TPUs are located in [specific zones](/tpu/docs/types-zones#types) , which are subdivisions within a region.- Open a Cloud Shell window. [Open Cloud Shell](https://console.cloud.google.com/?cloudshell=true) \n- Create a variable for your project's ID.```\nexport PROJECT_ID=project-id\n```\n- Configure Google Cloud CLI to use the project where you want to create Cloud TPU.```\ngcloud config set project ${PROJECT_ID}\n```The first time you run this command in a new Cloud Shell VM, an `Authorize Cloud Shell` page is displayed. Click `Authorize` at the bottom of the page to allow `gcloud` to make Google Cloud API calls with your credentials.\n- Create a Service Account for the Cloud TPU project.Service accounts allow the Cloud TPU service to access other Google Cloud services.```\ngcloud beta services identity create --service tpu.googleapis.com --project $PROJECT_ID\n```The command returns a Cloud TPU Service Account with following format:```\nservice-PROJECT_NUMBER@cloud-tpu.iam.gserviceaccount.com\n```\n- Create a Cloud Storage bucket using the following command or use a bucket you created earlier for your project:```\ngsutil mb -p ${PROJECT_ID} -c standard -l europe-west4 gs://bucket-name\n```This Cloud Storage bucket stores the data you use to train your model and the training results. The `gcloud` command used in this tutorial sets up default permissions for the Cloud TPU Service Account you set up in the previous step. If you want finer-grain permissions, review the [access level permissions](/tpu/docs/storage-buckets) .The bucket location must be in the same region as your TPU VM.\n- Export TPU setup variablesSet the zone where you will train the model and store any training-related data.```\n$ export ZONE=europe-west4-a\n```\n- Prepare your dataset or use ImageNet is an image database. The images in the database are organized into a hierarchy, with each node of the hierarchy depicted by hundreds and thousands of images.The default Pod training accesses a demonstration version of the full ImageNet dataset, referred to as . This demonstration version allows you to test Pod training, while reducing the storage and time requirements typically associated with training a model against the full ImageNet database.The fake_imagenet dataset is only useful for understanding how to use a Cloud TPU and validating end-to-end performance. The accuracy numbers and saved model will not be meaningful.If you want to use the full ImageNet dataset, see [Downloading, preprocessing, and uploading the ImageNet dataset](/tpu/docs/imagenet-setup) . **Caution:** Make sure you **do not** set the `STORAGE_BUCKET` environment variable to the path of the fake_imagenet dataset. You can read from `gs://cloud-tpu-test-datasets` but you can't write to it. As a result, you can't use it to write out training logs. Make sure the `STORAGE_BUCKET` environment variable is set to your own Cloud Storage bucket.\n- Launch your Cloud TPU resources using the `gcloud` command.The command you use depends on whether you are using a TPU VM or a TPU node. For more information on the two VM architecture, see [System Architecture](/tpu/docs/system-architecture-tpu-vm) . For more information on the `gcloud` command, see the [gcloud Reference](/sdk/gcloud/reference) . This tutorial specifies a v3-32 Pod. For other Pod options, see the [available TPU types page](/tpu/docs/supported-tpu-configurations) .\n **Note:** If there is not enough capacity currently available to create the TPU Pod, you can queue your request using queued resources. Queued resources allow you to receive capacity once it becomes available. To request your Cloud TPU resources as queued resources, use the`gcloud alpha compute tpus queued-resources create`command instead. For more information, see [Manage Queued Resources](/tpu/docs/queued-resources) .\n```\n$ gcloud compute tpus tpu-vm create efficientnet-tutorial \\\u00a0 --zone=${ZONE} \\\u00a0 --accelerator-type=v3-32 \\\u00a0 --version=tpu-vm-tf-2.16.1-pod-pjrt\n``` **Note:** The first time you run `gcloud` on a project it takes about 5 minutes to perform startup tasks such as SSH key propagation and API turnup.\n```\n(vm)$ gcloud compute tpus execution-groups \u00a0create --name=efficientnet-tutorial \\\u00a0--accelerator-type=v3-32 \u00a0\\\u00a0--zone=${ZONE} \\\u00a0--tf-version=2.12.0\n``` **Note:** The first time you run `gcloud` on a project it takes about 5 minutes to perform startup tasks such as SSH key propagation and API turnup.\n- If you are not automatically logged in to the Compute Engine instance, log in by running the following `ssh` command. When you are logged into the VM, your shell prompt changes from `username@projectname` to `username@vm-name` :\n```\n$ gcloud compute tpus tpu-vm ssh efficientnet-tutorial --zone=${ZONE}\n```\n```\n$ gcloud compute ssh efficientnet-tutorial --zone=${ZONE}\n```\n **Key Point:** From this point on, a prefix of **(vm) $** means you should run the command on the Compute Engine VM instance.As you continue these instructions, run each command that begins with `(vm)$` in your VM session window.\n- Export TPU setup variables:```\n(vm)$ export STORAGE_BUCKET=gs://bucket-name\n``````\n(vm)$ export TPU_NAME=efficientnet-tutorial(vm)$ export DATA_DIR=gs://cloud-tpu-test-datasets/fake_imagenet(vm)$ export MODEL_DIR=${STORAGE_BUCKET}/efficientnet-2x-pod\n```The training application expects your training data to be accessible in Cloud Storage. The training application also uses your Cloud Storage bucket to store checkpoints during training.\n- Install TensorFlow requirements.\n```\n(vm)$ pip3 install -r /usr/share/tpu/models/official/requirements.txt\n```\n```\n(vm)$ pip3 install -r /usr/share/models/official/requirements.txt\n```\n- Set some required environment variables:\n```\n(vm)$ export PYTHONPATH=\"/usr/share/tpu/models:${PYTHONPATH}\"(vm)$ export TPU_LOAD_LIBRARY=0\n```\n```\n(vm)$ export PYTHONPATH=\"${PYTHONPATH}:/usr/share/models\"\n```\nThe EfficientNet model is pre-installed on your Compute Engine VM.\n- Change to directory that stores the model:\n```\n(vm)$ cd /usr/share/tpu/models/official/legacy/image_classification/\n```\n```\n(vm)$ cd /usr/share/models/official/legacy/image_classification/\n```\n- Train the model.```\n(vm)$ python3 classifier_trainer.py \\--mode=train_and_eval \\--model_type=efficientnet \\--dataset=imagenet \\--tpu=${TPU_NAME} \\--data_dir=${DATA_DIR} \\--model_dir=${MODEL_DIR} \\--config_file=configs/examples/efficientnet/imagenet/efficientnet-b0-tpu.yaml \\--params_override=\"train.epochs=1, train_dataset.builder=records, validation_dataset.builder=records\"\n```\nThe procedure trains the model on the fake_imagenet dataset to 1 epoch (312 total training steps and 12 evaluation steps). This training takes approximately 2 minutes on a v3-32 Cloud TPU. When the training and evaluation complete, a message similar to the following appears:\n```\nRun stats:\n{\n 'accuracy_top_1': 0.0009969075908884406,\n 'eval_loss': 7.105168342590332,\n 'loss': 7.114983081817627,\n 'training_accuracy_top_1': 0.0010031675919890404,\n 'step_timestamp_log': [ 'BatchTimestamp<batch_index: 0,\n timestamp: 1605041621.4997303>',\n 'BatchTimestamp<batch_index: 312,\n timestamp: 1605041970.8633356>'\n ],\n 'train_finish_time': 1605042032.2274444,\n 'avg_exp_per_second': 3111.5120716536226\n}\n```\n## Clean upTo avoid incurring charges to your Google Cloud account for the resources used in this   tutorial, either delete the project that contains the resources, or keep the project and   delete the individual resources.- Disconnect from the Compute Engine instance, if you have not already done so:```\n(vm)$ exit\n```Your prompt should now be `username@projectname` , showing you are in the Cloud Shell.\n- Delete your Cloud TPU and Compute Engine resources.\n```\n$ gcloud compute tpus tpu-vm delete efficientnet-tutorial \\--zone=${ZONE}\n```\n```\n$ gcloud compute tpus execution-groups delete efficientnet-tutorial \\--zone=${ZONE}\n```\n- Verify the resources have been deleted by running `gcloud compute tpus execution-groups list` . The deletion might take several minutes. The output from the following command should not include any of the TPU resources created in this tutorial:```\n$ gcloud compute tpus execution-groups list --zone=${ZONE}\n```\n- Delete your Cloud Storage bucket using `gsutil` as shown below. Replace with the name of your Cloud Storage bucket.```\n$ gsutil rm -r gs://bucket-name\n``` **Note:** For free storage limits and other pricing information, see the [Cloud Storage pricing guide](/storage/pricing) .\n## What's nextThe TensorFlow Cloud TPU tutorials generally train the model using a sample dataset. The results of this training are not usable for inference. To use a model for inference, you can train the data on a publicly available dataset or your own dataset. TensorFlow models trained on Cloud TPUs generally require datasets to be in [TFRecord](https://www.tensorflow.org/tutorials/load_data/tfrecord) format.\nYou can use the [dataset conversion toolsample](/tpu/docs/classification-data-conversion) to convert an image classification dataset into TFRecord format. If you are not using an image classification model, you will have to convert your dataset to [TFRecord](https://www.tensorflow.org/tutorials/load_data/tfrecord) format yourself. For more information, see [TFRecord andtf.Example](https://www.tensorflow.org/tutorials/load_data/tfrecord) .\n### Hyperparameter tuningTo improve the model's performance with your dataset, you can tune the model's hyperparameters. You can find information about hyperparameters common to all TPU supported models on [GitHub](https://github.com/tensorflow/tpu/tree/master/models/hyperparameters) . Information about model-specific hyperparameters can be found in the [sourcecode](https://github.com/tensorflow/tpu/tree/master/models/official) for each model. For more information on hyperparameter tuning, see [Overview ofhyperparameter tuning](/vertex-ai/docs/training/hyperparameter-tuning-overview) and [Tunehyperparameters](https://developers.google.com/machine-learning/guides/text-classification/step-5) .\n### InferenceOnce you have trained your model, you can use it for inference (also called prediction). You can use the [Cloud TPU inference convertertool](/tpu/docs/v5e-inference-converter) to prepare and optimize a TensorFlow model for inference on Cloud TPU v5e. For more information about inference on Cloud TPU v5e, see [Cloud TPU v5e inferenceintroduction](/tpu/docs/v5e-inference) .- Learn how to train and evaluate using your own data in place of the fake_imagenet or ImageNet datasets by following the [dataset conversion tutorial](/tpu/docs/classification-data-conversion) . The tutorial explains how to use the image classification data converter example script to convert a raw dataset for image classification into TFRecords usable by Cloud TPU Tensorflow models.\n- Run a Cloud TPU [colab](https://colab.sandbox.google.com/github/GoogleCloudPlatform/training-data-analyst/blob/master/courses/fast-and-lean-data-science/03_Flower_pictures_to_TFRecords.ipynb) that demonstrates how to run an image classification model using your own image data.\n- Explore the other [Cloud TPU tutorials](/tpu/docs/tutorials) .\n- Learn to use the [TPU monitoring tools inTensorBoard](/tpu/docs/cloud-tpu-tools) .", "guide": "Cloud TPU"}