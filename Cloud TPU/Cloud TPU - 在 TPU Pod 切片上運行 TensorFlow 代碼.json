{"title": "Cloud TPU - \u5728 TPU Pod \u5207\u7247\u4e0a\u904b\u884c TensorFlow \u4ee3\u78bc", "url": "https://cloud.google.com/tpu/docs/tensorflow-pods?hl=zh-cn", "abstract": "# Cloud TPU - \u5728 TPU Pod \u5207\u7247\u4e0a\u904b\u884c TensorFlow \u4ee3\u78bc\n# \u5728 TPU Pod \u5207\u7247\u4e0a\u904b\u884c TensorFlow \u4ee3\u78bc\n\u672c\u6587\u6a94\u4ecb\u7d39\u77ad\u5982\u4f55\u5728 TPU Pod \u4e0a\u4f7f\u7528 TensorFlow \u57f7\u884c\u7c21\u55ae\u7684\u8a08\u7b97\u3002\u60a8\u5c07\u57f7\u884c\u4ee5\u4e0b\u6b65\u9a5f\uff1a\n- \u4f7f\u7528 TensorFlow \u8edf\u4ef6\u5275\u5efa TPU Pod \u5207\u7247\n- \u4f7f\u7528 SSH \u9023\u63a5\u5230 TPU \u865b\u64ec\u6a5f\n- \u5275\u5efa\u4e26\u904b\u884c\u7c21\u55ae\u7684\u8173\u672c\nTPU \u865b\u64ec\u6a5f\u4f9d\u8cf4\u65bc [\u670d\u52d9\u5e33\u865f](https://cloud.google.com/compute/docs/access/service-accounts?hl=zh-cn#serviceaccount) \u4f86\u8abf\u7528 Cloud TPU API\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u60a8\u7684 TPU \u865b\u64ec\u6a5f\u5c07\u4f7f\u7528\u9ed8\u8a8d\u7684 Compute Engine [\u670d\u52d9\u5e33\u865f](https://cloud.google.com/compute/docs/access/service-accounts?hl=zh-cn) \uff0c\u8a72\u5e33\u865f\u5305\u542b\u6240\u9700\u7684\u6240\u6709 Cloud TPU \u6b0a\u9650\u3002\u5982\u679c\u60a8\u4f7f\u7528\u81ea\u5df1\u7684\u670d\u52d9\u5e33\u865f\uff0c\u5247\u9700\u8981\u7232\u670d\u52d9\u5e33\u865f\u6dfb\u52a0 [TPU Viewer](https://cloud.google.com/iam/docs/understanding-roles?hl=zh-cn#tpu.viewer) \u89d2\u8272\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3 Google Cloud \u89d2\u8272\uff0c\u8acb\u53c3\u95b1 [\u77ad\u89e3\u89d2\u8272](https://cloud.google.com/iam/docs/understanding-roles?hl=zh-cn) \u3002 \u60a8\u53ef\u4ee5\u5728\u5275\u5efa TPU \u865b\u64ec\u6a5f\u6642\u4f7f\u7528 `--service-account` \u6a19\u8a8c\u6307\u5b9a\u81ea\u5df1\u7684\u670d\u52d9\u5e33\u865f\u3002\n", "content": "## \u4f7f\u7528 TensorFlow \u904b\u884c\u6642\u5275\u5efa v3-32 TPU Pod \u5207\u7247\n**\u6ce8\u610f** \uff1a\u5553\u52d5 TPU \u865b\u64ec\u6a5f\u6642\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u547d\u4ee4\u4e2d\u986f\u793a\u7684 TPU \u8edf\u4ef6\u7248\u672c\uff0c\u4e5f\u53ef\u4ee5\u53c3\u95b1 [Cloud TPU \u8edf\u4ef6\u7248\u672c](https://cloud.google.com/tpu/docs/supported-tpu-versions?hl=zh-cn#tpu_software_versions) \u4f86\u6307\u5b9a\u5176\u4ed6\u53d7\u652f\u6301\u7684 TPU \u8edf\u4ef6\u7248\u672c\u3002\n```\n$ gcloud compute tpus tpu-vm create tpu-name \\\u00a0 --zone=europe-west4-a \\\u00a0 --accelerator-type=v3-32 \\\u00a0 --version=tpu-vm-tf-2.15.0-pod-pjrt\n```\n## \u4f7f\u7528 SSH \u9023\u63a5\u5230\u60a8\u7684 Cloud TPU \u865b\u64ec\u6a5f\n```\n$ gcloud compute tpus tpu-vm ssh tpu-name \\\u00a0 \u00a0 \u00a0 --zone europe-west4-a\n```\n## \u5275\u5efa\u4e26\u904b\u884c\u7c21\u55ae\u7684\u8a08\u7b97\u8173\u672c\n- \u8a2d\u7f6e\u4ee5\u4e0b\u74b0\u5883\u8b8a\u91cf\u3002```\n(vm)$ export TPU_NAME=tpu-name(vm)$ export TPU_LOAD_LIBRARY=0\n```\n- \u5728\u7576\u524d\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u7232 `tpu-test.py` \u7684\u6587\u4ef6\uff0c\u4e26\u5c07\u4ee5\u4e0b\u8173\u672c\u8907\u88fd\u7c98\u8cbc\u5230\u5176\u4e2d\u3002```\nimport tensorflow as tfprint(\"Tensorflow version \" + tf.__version__)cluster_resolver = tf.distribute.cluster_resolver.TPUClusterResolver()print('Running on TPU ', cluster_resolver.cluster_spec().as_dict()['worker'])tf.config.experimental_connect_to_cluster(cluster_resolver)tf.tpu.experimental.initialize_tpu_system(cluster_resolver)strategy = tf.distribute.experimental.TPUStrategy(cluster_resolver)@tf.functiondef add_fn(x,y):z = x + yreturn zx = tf.constant(1.)y = tf.constant(1.)z = strategy.run(add_fn, args=(x,y))print(z)\n```\n- \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u904b\u884c\u6b64\u8173\u672c\uff1a```\n(vm)$ python3 tpu-test.py\n```\u6b64\u8173\u672c\u6703\u5728 TPU \u7684\u6bcf\u500b TensorCore \u4e0a\u57f7\u884c\u7c21\u55ae\u7684\u8a08\u7b97\u3002\u8f38\u51fa\u5c07\u5982\u4e0b\u6240\u793a\uff1a```\nPerReplica:{\n0: tf.Tensor(2.0, shape=(), dtype=float32),\n1: tf.Tensor(2.0, shape=(), dtype=float32),\n2: tf.Tensor(2.0, shape=(), dtype=float32),\n3: tf.Tensor(2.0, shape=(), dtype=float32),\n4: tf.Tensor(2.0, shape=(), dtype=float32),\n5: tf.Tensor(2.0, shape=(), dtype=float32),\n6: tf.Tensor(2.0, shape=(), dtype=float32),\n7: tf.Tensor(2.0, shape=(), dtype=float32),\n8: tf.Tensor(2.0, shape=(), dtype=float32),\n9: tf.Tensor(2.0, shape=(), dtype=float32),\n10: tf.Tensor(2.0, shape=(), dtype=float32),\n11: tf.Tensor(2.0, shape=(), dtype=float32),\n12: tf.Tensor(2.0, shape=(), dtype=float32),\n13: tf.Tensor(2.0, shape=(), dtype=float32),\n14: tf.Tensor(2.0, shape=(), dtype=float32),\n15: tf.Tensor(2.0, shape=(), dtype=float32),\n16: tf.Tensor(2.0, shape=(), dtype=float32),\n17: tf.Tensor(2.0, shape=(), dtype=float32),\n18: tf.Tensor(2.0, shape=(), dtype=float32),\n19: tf.Tensor(2.0, shape=(), dtype=float32),\n20: tf.Tensor(2.0, shape=(), dtype=float32),\n21: tf.Tensor(2.0, shape=(), dtype=float32),\n22: tf.Tensor(2.0, shape=(), dtype=float32),\n23: tf.Tensor(2.0, shape=(), dtype=float32),\n24: tf.Tensor(2.0, shape=(), dtype=float32),\n25: tf.Tensor(2.0, shape=(), dtype=float32),\n26: tf.Tensor(2.0, shape=(), dtype=float32),\n27: tf.Tensor(2.0, shape=(), dtype=float32),\n28: tf.Tensor(2.0, shape=(), dtype=float32),\n29: tf.Tensor(2.0, shape=(), dtype=float32),\n30: tf.Tensor(2.0, shape=(), dtype=float32),\n31: tf.Tensor(2.0, shape=(), dtype=float32)\n}\n```## \u6e05\u7406\n\u5b8c\u6210 TPU \u865b\u64ec\u6a5f\u7684\u64cd\u4f5c\u5f8c\uff0c\u8acb\u6309\u7167\u4ee5\u4e0b\u6b65\u9a5f\u6e05\u7406\u8cc7\u6e90\u3002\n- \u65b7\u958b\u8207 Compute Engine \u7684\u9023\u63a5\uff1a```\n(vm)$ exit\n```\n- \u522a\u9664\u60a8\u7684 Cloud TPU\u3002```\n$ gcloud compute tpus tpu-vm delete tpu-name \\\u00a0 --zone europe-west4-a\n```\n- \u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4f86\u9a57\u8b49\u8cc7\u6e90\u5df2\u522a\u9664\u3002\u78ba\u4fdd\u60a8\u7684 TPU \u4e0d\u518d\u5217\u51fa\u3002\u522a\u9664\u64cd\u4f5c\u53ef\u80fd\u9700\u8981\u5e7e\u5206\u9418\u6642\u9593\u624d\u80fd\u5b8c\u6210\u3002```\n$ gcloud compute tpus tpu-vm list \\\u00a0 --zone europe-west4-a\n```", "guide": "Cloud TPU"}