{"title": "Cloud TPU - Queued resources user guide", "url": "https://cloud.google.com/tpu/docs/queued-resources", "abstract": "# Cloud TPU - Queued resources user guide\n# Queued resources user guide\nQueued resources enable you to request Cloud TPU resources in a queued manner. When you request queued resources, the request is added to a queue maintained by the Cloud TPU service. When the requested resource becomes available, it's assigned to your Google Cloud project for your immediate exclusive use. It will remain assigned to your project unless you delete it or it's preempted. Only preemptible TPUs are eligible for preemption.\n**Note:** Queued resources are only available with the [TPU VM architecture](/tpu/docs/system-architecture-tpu-vm#tpu-vm) .\nYou can specify an optional [start and end time](#request-queued-specified-time) in a queued resource request. The start time specifies the earliest time in which to fill the request. If a request has not been filled by the specified end time, the request expires. The request remains in the queue after it has expired.\nQueued resource requests can be in one the following states:\n", "content": "## Prerequisites\nBefore running the commands in this guide, make sure you:\n- Install the [Google Cloud CLI alpha components](https://cloud.google.com/sdk/gcloud/reference/components/install) \n- Enable the [Cloud TPU API](https://console.cloud.google.com/apis/library/tpu.googleapis.com?_ga=2.174913505.2116185568.1664815833-671377895.1662479582&_gac=1.184538452.1663874535.Cj0KCQjwj7CZBhDHARIsAPPWv3diPfi1d-VcluDdaKlKf4CZnZ1K9DUABPC1VeRRurakgONsiLWUVMoaAmANEALw_wcB) ## Request an on-demand queued resource\nYou can request an on-demand queued resource using the `gcloud alpha compute tpus queued-resources create` command. For more information about on-demand resources, see [Quota types](/tpu/docs/quota#quota_types) .\n```\ngcloud alpha compute tpus queued-resources create your-queued-resource-id \\--node-id your-node-id \\--project your-project \\--zone us-central2-b \\--accelerator-type v4-8 \\--runtime-version tpu-vm-tf-2.16.1-pjrt\n```\n```\ncurl -X POST -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\-H \"Content-Type: application/json\" \\-d \"{'tpu': {\u00a0 'node_spec': {\u00a0 \u00a0 'parent': 'projects/your-project-number/locations/us-central2-b',\u00a0 \u00a0 'node_id': 'your-node-id',\u00a0 \u00a0 'node': {\u00a0 \u00a0 \u00a0 'accelerator_type': 'v4-8',\u00a0 \u00a0 \u00a0 'runtime_version': 'tpu-vm-tf-2.16.1-pjrt',\u00a0 \u00a0 }\u00a0 }}}\" \\https://tpu.googleapis.com/v2alpha1/projects/your-project-id/locations/us-central2-b/queuedResources?queued_resource_id=your-queued-resource-id\n```### Default slice sizes for on-demand queued resources\nWhen you use on-demand quota, you must request a slice size less than the default limit for the accelerator type you are using. Requests that exceed the default limits are declined by the system.\nThe following table shows the TPU types and their associated default limits.\n| 0    | 1          |\n|:-----------------|:-----------------------------------------|\n| Accelerator type | Default limit (in number of TensorCores) |\n| v2    | 128          |\n| v3    | 128          |\n| v4    | 384          |\n| v5    | 32          |\nIf you require larger slice sizes, contact Cloud TPU support for additional information.\n## Request a queued resource using reserved quota\nYou can request a queued resource using reserved quota by specifying the `--reserved` flag in your `gcloud` command or `guaranteed.reserved=true` in your curl request. For more information about reserved quota, see [Quotatypes](/tpu/docs/quota#quota_types) .\n```\ngcloud alpha compute tpus queued-resources create your-queued-resource-id \\--node-id your-node-id \\--project your-project \\--zone us-central2-b \\--accelerator-type v4-8 \\--runtime-version tpu-vm-tf-2.16.1-pjrt \\--reserved\n```\n```\ncurl -X POST -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\-H \"Content-Type: application/json\" \\-d \"{'tpu': {\u00a0 'node_spec': {\u00a0 \u00a0 'parent': 'projects/your-project-number/locations/us-central2-b',\u00a0 \u00a0 'node_id': 'your-node-id',\u00a0 \u00a0 'node': {\u00a0 \u00a0 \u00a0 'accelerator_type': 'v4-8',\u00a0 \u00a0 \u00a0 'runtime_version': 'tpu-vm-tf-2.16.1-pjrt',\u00a0 \u00a0 }\u00a0 }},'guaranteed': {\u00a0 'reserved': true,}}\" \\https://tpu.googleapis.com/v2alpha1/projects/your-project-id/locations/us-central2-b/queuedResources?queued_resource_id=your-queued-resource-id\n```\n## Request a preemptible queued resource\nYou can request a preemptible queued resource. A [preemptibleresource](/tpu/docs/preemptible) is a resource that may be assigned to another workload if extra resources are needed by other workloads. Preemptible resources cost less and you may get access to resources sooner compared to a non-preemptible request. For more information about preemptible quota, see [Quota types](/tpu/docs/quota#quota_types) .\n```\ngcloud alpha compute tpus queued-resources create your-queued-resource-id \\--node-id your-node-id \\--project your-project-id \\--zone us-central2-b \\--accelerator-type v4-8 \\--runtime-version tpu-vm-tf-2.16.1-pjrt \\--best-effort\n```\n```\ncurl -X POST -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\-H \"Content-Type: application/json\" \\-d \"{'tpu': {\u00a0 'node_spec': {\u00a0 \u00a0 'parent': 'projects/your-project-number/locations/us-central2-b',\u00a0 \u00a0 'node_id': 'your-node-id',\u00a0 \u00a0 'node': {\u00a0 \u00a0 \u00a0 'accelerator_type': 'v4-8',\u00a0 \u00a0 \u00a0 'runtime_version': 'tpu-vm-tf-2.16.1-pjrt',\u00a0 \u00a0 }\u00a0 }},'best_effort': {}}\" \\https://tpu.googleapis.com/v2alpha1/projects/your-project-id/locations/us-central2-b/queuedResources?queued_resource_id=your-queued-resource-id\n```\n## Request a queued resource to be allocated before or after a specified time\nYou can specify an optional [start time](#request-queued-after-time) , [endtime](#request-queued-until-time) , [startduration](#request-queued-after-duration) , or [endduration](#request-queued-until-duration) in a queued resource request. The start time or start duration specifies the earliest time in which to fill the request. If a request has not been filled by the specified end time or within the specified duration, the request expires. After the request has expired, it remains in the queue but is no longer eligible for allocation.\nYou can also specify an [allocation interval](#request-queued-interval) by specifying a start time or duration and an end time or duration.\nSee [Datetime](https://cloud.google.com/sdk/gcloud/reference/topic/datetimes) for a list of supported timestamp and duration formats.\n### Request a queued resource after a specified duration\nYou can specify a duration after which a resource should be allocated using the `--valid-after-duration` flag. The following example requests a v4-32 to be allocated after six hours.\n```\ngcloud alpha compute tpus queued-resources create your-queued-resource-id \\--node-id your-node-id \\--project your-project-id \\--zone us-central2-b \\--accelerator-type v4-32 \\--runtime-version tpu-vm-tf-2.16.1-pod-pjrt \\--valid-after-duration 6h\n```\n```\ncurl -X POST -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\-H \"Content-Type: application/json\" \\-d \"{'tpu': {\u00a0 'node_spec': {\u00a0 \u00a0 'parent': 'projects/your-project-number/locations/us-central2-b',\u00a0 \u00a0 'node_id': 'your-node-id',\u00a0 \u00a0 'node': {\u00a0 \u00a0 \u00a0 'accelerator_type': 'v4-32',\u00a0 \u00a0 \u00a0 'runtime_version': 'tpu-vm-tf-2.16.1-pod-pjrt',\u00a0 \u00a0 }\u00a0 }},'queueing_policy': {\u00a0 'valid_after_duration': {\u00a0 \u00a0 'seconds': 21600\u00a0 }}\" \\https://tpu.googleapis.com/v2alpha1/projects/your-project-id/locations/us-central2-b/queuedResources?queued_resource_id=your-queued-resource-id\n```### Request a queued resource that expires after a specified duration\nYou can specify how long a queued resource request remains valid using the `--valid-until-duration` flag. The following example requests a v4-32 that expires if not filled in six hours.\n```\ngcloud alpha compute tpus queued-resources create your-queued-resource-id \\--node-id your-node-id \\--project your-project-id \\--zone us-central2-b \\--accelerator-type v4-32 \\--runtime-version tpu-vm-tf-2.16.1-pod-pjrt \\--valid-until-duration 6h\n```\n```\ncurl -X POST -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\-H \"Content-Type: application/json\" \\-d \"{'tpu': {\u00a0 'node_spec': {\u00a0 \u00a0 'parent': 'projects/your-project-number/locations/us-central2-b',\u00a0 \u00a0 'node_id': 'your-node-id',\u00a0 \u00a0 'node': {\u00a0 \u00a0 \u00a0 'accelerator_type': 'v4-32',\u00a0 \u00a0 \u00a0 'runtime_version': 'tpu-vm-tf-2.16.1-pod-pjrt',\u00a0 \u00a0 }\u00a0 }},'queueing_policy': {\u00a0 'valid_until_duration': {\u00a0 \u00a0 'seconds': 21600\u00a0 }}\" \\https://tpu.googleapis.com/v2alpha1/projects/your-project-id/locations/us-central2-b/queuedResources?queued_resource_id=your-queued-resource-id\n```### Request a queued resource after a specified time\nYou can specify a time after which a resource should be allocated using the `--valid-after-time` flag.\nThe following command requests a v4-4096 TPU with runtime version `tpu-vm-tf-2.16.1-pjrt` to be allocated after 9AM on December 14, 2022.\n```\ngcloud alpha compute tpus queued-resources create your-queued-resource-id \\--node-id your-node-id \\--project your-project-id \\--zone us-central2-b \\--accelerator-type v4-4096 \\--runtime-version tpu-vm-tf-2.16.1-pod-pjrt \\--valid-after-time 2022-12-14T09:00:00Z\n```\n```\ncurl -X POST -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\-H \"Content-Type: application/json\" \\-d \"{'tpu': {\u00a0 'node_spec': {\u00a0 \u00a0 'parent': 'projects/your-project-number/locations/us-central2-b',\u00a0 \u00a0 'node_id': 'your-node-id',\u00a0 \u00a0 'node': {\u00a0 \u00a0 \u00a0 'accelerator_type': 'v4-4096',\u00a0 \u00a0 \u00a0 'runtime_version': 'tpu-vm-tf-2.16.1-pod-pjrt',\u00a0 \u00a0 }\u00a0 }},'queueing_policy': {\u00a0 'valid_after_time': {\u00a0 \u00a0 'seconds': 2022-12-14T09:00:00Z\u00a0 }}}\" \\https://tpu.googleapis.com/v2alpha1/projects/your-project-id/locations/us-central2-b/queuedResources?queued_resource_id=your-queued-resource-id\n```### Request a queued resource before a specified time\nYou can specify a time before which the resource should be allocated using the `--valid-until-time` flag.\nThe following command requests a v4-4096 TPU node with runtime version `tpu-vm-tf-2.10.0-pod` to be created no later than December 14, 2022 at 9:00 AM.\n```\ngcloud alpha compute tpus queued-resources create your-queued-resource-id \\--node-id your-node-id \\--project your-project-id \\--zone us-central2-b \\--accelerator-type v4-4096 \\--runtime-version tpu-vm-tf-2.16.1-pod-pjrt \\--valid-until-time 2022-12-14T09:00:00Z\n```\n```\ncurl -X POST -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\-H \"Content-Type: application/json\" \\-d \"{'tpu': {\u00a0 'node_spec': {\u00a0 \u00a0 'parent': 'projects/your-project-number/locations/us-central2-b',\u00a0 \u00a0 'node_id': 'your-node-id',\u00a0 \u00a0 'node': {\u00a0 \u00a0 \u00a0 'accelerator_type': 'v4-4096',\u00a0 \u00a0 \u00a0 'runtime_version': 'tpu-vm-tf-2.16.1-pod-pjrt',\u00a0 \u00a0 }\u00a0 }},'queueing_policy': {\u00a0 'valid_until_time': {\u00a0 \u00a0 'seconds': 1655197200\u00a0 }}}\" \\https://tpu.googleapis.com/v2alpha1/projects/your-project-id/locations/us-central2-b/queuedResources?queued_resource_id=your-queued-resource-id\n```### Request a queued resource to be allocated within a specified interval\nYou can specify an allocation interval using any pair of the `--valid-after-time` , `--valid-after-duration` , `--valid-until-duration` , and `--valid-until-time` flags, provided one flag specifies the beginning of the allocation interval and the other specifies the end of the allocation interval.\nThe following command requests a v4-32 in 5 hours and 30 minutes from the current time, to be created no later than December 14, 2022 at 9:00 AM.\n```\ngcloud alpha compute tpus queued-resources create your-queued-resource-id \\--node-id your-node-id \\--project your-project-id \\--zone us-central2-b \\--accelerator-type v4-32 \\--runtime-version tpu-vm-tf-2.16.1-pod-pjrt \\--valid-after-duration 5h30m \\--valid-until-time 2022-12-14T09:00:00Z\n```\n```\ncurl -X POST -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\-H \"Content-Type: application/json\" \\-d \"{'tpu': {\u00a0 'node_spec': {\u00a0 \u00a0 'parent': 'projects/your-project-number/locations/us-central2-b',\u00a0 \u00a0 'node_id': 'your-node-id',\u00a0 \u00a0 'node': {\u00a0 \u00a0 \u00a0 'accelerator_type': 'v4-32',\u00a0 \u00a0 \u00a0 'runtime_version': 'tpu-vm-tf-2.16.1-pod-pjrt',\u00a0 \u00a0 }\u00a0 }},'queueing_policy': {\u00a0 'validInterval': {\u00a0 \u00a0 'startTime': '2022-12-10T14:30:00Z',\u00a0 \u00a0 'endTime': '2022-12-14T09:00:00Z'\u00a0 }},}\" \\https://tpu.googleapis.com/v2alpha1/projects/your-project-id/locations/us-central2-b/queuedResources?queued_resource_id=your-queued-resource-id\n```\n## Request a queued resource with a startup script\nYou can specify a script to be run on a queued resource after it has been provisioned. When using the `gcloud` command, you can use either the `--metadata` or `--metadata-from-file` flag to specify a script command or a file containing the script code, respectively. When using `curl` , you must include the script code in the JSON content. The following example creates a queued resource request that will run the script contained in `startup-script.sh` . The `curl` example shows an inline script in the JSON body.\n```\ngcloud alpha compute tpus queued-resources create your-queued-resource-id \\--node-id your-node-id \\--project your-project \\--zone us-central2-b \\--accelerator-type v4-8 \\--runtime-version tpu-vm-tf-2.12.0 \\--reserved \\--metadata-from-file='startup-script=startup-script.sh'\n```\n```\ncurl -X POST -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\-H \"Content-Type: application/json\" \\-d \"{tpu: {\u00a0 \u00a0 node_spec: {\u00a0 \u00a0 \u00a0 parent: 'projects/your-project-number/locations/us-central2-b',\u00a0 \u00a0 \u00a0 node_id: 'your-node-id',\u00a0 \u00a0 \u00a0 node: {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 accelerator_type: 'v2-8',\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 runtime_version: 'tpu-vm-tf-2.16.1-pjrt',\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 metadata: {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"startup-script\": \"#! /bin/bash\\npwd > /tmp/out.txt\\nwhoami >> /tmp/out.txt\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 }},'queueing_policy': {\u00a0 'validInterval': {\u00a0 \u00a0 'startTime': '2022-12-10T14:30:00Z',\u00a0 \u00a0 'endTime': '2022-12-14T09:00:00Z'\u00a0 }},}\" \\https://tpu.googleapis.com/v2alpha1/projects/your-project-id/locations/us-central2-b/queuedResources?queued_resource_id=your-queued-resource-id\n```\n## Request a queued resources with a specified network and subnetwork\nYou can request a queued resource specifying the network and subnetwork that you want to connect your TPU to.\n```\ngcloud alpha compute tpus queued-resources create your-queued-resource-id \\--node-id your-node-id \\--project your-project \\--zone us-central2-b \\--accelerator-type v4-8 \\--runtime-version tpu-vm-tf-2.16.1-pjrt \\--network network-name \\--subnetwork subnetwork-name\n```\n```\ncurl -X POST -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\-H \"Content-Type: application/json\" \\-d \"{'tpu': {\u00a0 'node_spec': {\u00a0 \u00a0 'parent': 'projects/your-project-number/locations/us-central2-b',\u00a0 \u00a0 'node_id': 'your-node-id',\u00a0 \u00a0 'node': {\u00a0 \u00a0 \u00a0 'accelerator_type': 'v4-8',\u00a0 \u00a0 \u00a0 'runtime_version': 'tpu-vm-tf-2.16.1-pjrt',\u00a0 \u00a0 \u00a0 \u00a0'network_config': {\u00a0 \u00a0 \u00a0 \u00a0 'network': 'network-name',\u00a0 \u00a0 \u00a0 \u00a0 'subnetwork': 'subnetwork-name',\u00a0 \u00a0 \u00a0 \u00a0 'enable_external_ips': true\u00a0 \u00a0 }\u00a0 }},'guaranteed': {\u00a0 'reserved': true,}}\" \\https://tpu.googleapis.com/v2alpha1/projects/your-project-id/locations/us-central2-b/queuedResources?queued_resource_id=your-queued-resource-id\n```\n## Delete a queued resource request\nYou can delete a queued resource request and the TPU VM created by the request by passing the `--force` flag to the `queued-resource delete` command. Otherwise, you must delete the TPU VM before deleting the queued resource request. When you delete the TPU VM, the queued resource request transitions to the `SUSPENDED` state, after which the queued resource request may be deleted.\nThe following commands delete the queued resource request named \"my-queued-resource\" in the \"my-project\" project in zone \"us-central2-b\". It uses the `--force` flag to delete both the TPU VM and the queued resource request.\n**Note:** The command can take two to five minutes to complete. You can run the command aynchronously by passing the `--async` flag to the `gcloud` command as shown in the following command.\n```\ngcloud alpha compute tpus queued-resources delete my-queued-resource \\--project my-project \\--zone us-central2-b \\--force \\--async\n```\n```\ncurl -X DELETE -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\-H \"Content-Type: application/json\" \\https://tpu.googleapis.com/v2alpha1/projects/my-project/locations/us-central2-b/queuedResources/my-queued-resource?force=true\n```\nThe following commands delete the queued resource request named \"my-queued-resource\" in the \"my-project\" project in zone \"us-central2-b\".\n**Note:** If you don't use the `--force` flag described previously, you must delete the TPU VM before deleting the queued resource. For more information, see the [gcloud reference documentation](/sdk/gcloud/reference/alpha/compute/tpus/tpu-vm/delete) .\n```\ngcloud alpha compute tpus queued-resources delete your-queued-resource-id \\--project your-project-id \\--zone us-central2-b\n```\n```\ncurl -X DELETE -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\-H \"Content-Type: application/json\" \\https://tpu.googleapis.com/v2alpha1/projects/your-project-id/locations/us-central2-b/queuedResources/your-queued-resource-id\n```\n## Retrieve state and diagnostic information about a queued resource request\nRetrieve the state and diagnostic information about a queued resource request:\n```\ngcloud alpha compute tpus queued-resources describe queued-resource-request-id \\--project your-project-id \\--zone us-central2-b\n```\n```\ncurl -X GET -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\-H \"Content-Type: application/json\" \\https://tpu.googleapis.com/v2alpha1/projects/your-project-id/locations/us-central2-b/queuedResources/your-queued-resource-id\n```\nIf the request fails, the response will contain error information. For a request that is waiting for resources, the output will look similar to the following:\n```\nname: projects/your-project-id/locations/us-central2-b/queuedResources/your-queued-resource-idstate:\u00a0 state: WAITING_FOR_RESOURCEStpu:\u00a0 nodeSpec:\u00a0 - node:\u00a0 \u00a0 \u00a0 acceleratorType: v4-8\u00a0 \u00a0 \u00a0 bootDisk: {}\u00a0 \u00a0 \u00a0 networkConfig:\u00a0 \u00a0 \u00a0 \u00a0 enableExternalIps: true\u00a0 \u00a0 \u00a0 queuedResource: projects/your-project-number/locations/us-central2-b/queuedResources/your-queued-resource-id\u00a0 \u00a0 \u00a0 runtimeVersion: tpu-vm-tf-2.10.0\u00a0 \u00a0 \u00a0 schedulingConfig: {}\u00a0 \u00a0 \u00a0 serviceAccount: {}\u00a0 \u00a0 \u00a0 shieldedInstanceConfig: {}\u00a0 \u00a0 \u00a0 useTpuVm: true\u00a0 \u00a0 nodeId: your-node-id\u00a0 \u00a0 parent: projects/your-project-number/locations/us-central2-b\n```\n## List queued resource requests in your project\nThe following command lists the queued resource requests in project \"your-project-id\":\n```\ngcloud alpha compute tpus queued-resources list --project your-project-id \\--zone us-central2-b\n```\n```\ncurl -X GET -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\-H \"Content-Type: application/json\" \\https://tpu.googleapis.com/v2alpha1/projects/your-project-id/locations/us-central2-b/queuedResources\n```", "guide": "Cloud TPU"}