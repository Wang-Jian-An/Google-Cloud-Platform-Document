{"title": "Cloud TPU - \u8f49\u63db\u5716\u7247\u5206\u985e\u6578\u64da\u96c6\uff0c\u4ee5\u4fbf\u8207 Cloud TPU \u642d\u914d\u4f7f\u7528", "url": "https://cloud.google.com/tpu/docs/classification-data-conversion?hl=zh-cn", "abstract": "# Cloud TPU - \u8f49\u63db\u5716\u7247\u5206\u985e\u6578\u64da\u96c6\uff0c\u4ee5\u4fbf\u8207 Cloud TPU \u642d\u914d\u4f7f\u7528\n\u672c\u6559\u7a0b\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528 [\u5716\u7247\u5206\u985e\u6578\u64da\u8f49\u63db\u5668\u793a\u4f8b](https://github.com/tensorflow/tpu/tree/master/tools/data_converter/image_classification) \u8173\u672c\u5c07\u539f\u59cb\u5716\u7247\u5206\u985e\u6578\u64da\u96c6\u8f49\u63db\u7232\u7528\u65bc\u8a13\u7df4 Cloud TPU \u6a21\u578b\u7684 [TFRecord](https://www.tensorflow.org/tutorials/load_data/tfrecord?hl=zh-cn) \u683c\u5f0f\u3002\n\u8207\u5c07\u6bcf\u500b\u5716\u7247\u4f5c\u7232\u55ae\u500b\u6587\u4ef6\u8b80\u53d6\u76f8\u6bd4\uff0c [TFRecord](https://www.tensorflow.org/tutorials/load_data/tfrecord?hl=zh-cn) \u5f9e Google Cloud Storage \u4e2d\u8b80\u53d6\u5927\u578b\u6587\u4ef6\u6703\u66f4\u52a0\u9ad8\u6548\u3002\u60a8\u53ef\u4ee5\u5728\u4f7f\u7528 `tf.data.Dataset` \u6d41\u6c34\u7dda\u7684\u4efb\u4f55\u4f4d\u7f6e\u4f7f\u7528 TFRecord\u3002\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u4f7f\u7528 TFRecord\uff0c\u8acb\u53c3\u95b1\u4ee5\u4e0b TensorFlow \u6587\u6a94\uff1a- [TFRecord \u548c tf.train.Example](https://www.tensorflow.org/tutorials/load_data/tfrecord?hl=zh-cn) \n- [tf.data.Dataset](https://www.tensorflow.org/api_docs/python/tf/data/Dataset?hl=zh-cn) \n- [tf.data: Build TensorFlow \u8f38\u5165\u6d41\u6c34\u7dda](https://www.tensorflow.org/guide/data?hl=zh-cn) \n- [PyTorch TFRecord \u8b80\u53d6\u5668\u548c\u5beb\u5165\u5668](https://github.com/vahidk/tfrecord) \n\u5982\u679c\u60a8\u4f7f\u7528 PyTorch \u6216 JAX \u6846\u67b6\uff0c\u4e26\u4e14\u6c92\u6709\u5c07 Google Cloud \u5b58\u5132\u7a7a\u9593\u7528\u65bc\u6578\u64da\u96c6\u5b58\u5132\uff0c\u5247\u53ef\u80fd\u7121\u6cd5\u5f9e TFRecord \u53d7\u76ca\u3002", "content": "## \u8f49\u63db\u6982\u89bdGitHub \u4e0a\u7684 [\u6578\u64da\u8f49\u63db\u5668\u4ee3\u78bc\u5eab\u4e2d\u7684\u5716\u7247\u5206\u985e\u6587\u4ef6\u593e](https://github.com/tensorflow/tpu/tree/master/tools/data_converter) \u5305\u542b `converter` \u8173\u672c `image_classification_data.py` \u4ee5\u53ca\u5be6\u73fe\u793a\u4f8b `simple_example.py` \uff0c\u60a8\u53ef\u4ee5\u8907\u88fd\u4e26\u9032\u884c\u4fee\u6539\u4ee5\u57f7\u884c\u81ea\u5df1\u7684\u6578\u64da\u8f49\u63db\u3002\n\u5716\u7247\u5206\u985e\u6578\u64da\u8f49\u63db\u5668\u793a\u4f8b\u5b9a\u7fa9\u4e86\u5169\u500b\u985e\uff1a `ImageClassificationConfig` \u548c `ImageClassificationBuilder` \u3002\u9019\u4e9b\u985e\u5728 `tpu/tools/data_converter/image_classification_data.py` \u4e2d\u5b9a\u7fa9\u3002\n`ImageClassificationConfig` \u662f\u4e00\u500b\u62bd\u8c61\u57fa\u985e\u3002\u60a8\u53ef\u7232 `ImageClassificationConfig` \u8a2d\u7f6e\u5b50\u985e\uff0c\u4ee5\u5b9a\u7fa9\u5be6\u4f8b\u5316 `ImageClassificationBuilder` \u6240\u9700\u7684\u914d\u7f6e\u3002\n`ImageClassificationBuilder` \u662f\u7528\u65bc\u5716\u7247\u5206\u985e\u6578\u64da\u96c6\u7684 [TensorFlow \u6578\u64da\u96c6\u69cb\u5efa\u5668](https://www.tensorflow.org/datasets/api_docs/python/tfds/builder?hl=zh-cn) \u3002\u5b83\u662f [tdfs.core.GeneratorBasedBuilder](https://www.tensorflow.org/datasets/api_docs/python/tfds/core/DatasetBuilder?hl=zh-cn) \u7684\u5b50\u985e\u3002 \u5b83\u6703\u5f9e\u6578\u64da\u96c6\u4e2d\u6aa2\u7d22\u6578\u64da\u793a\u4f8b\uff0c\u4e26\u5c07\u5176\u8f49\u63db\u7232 TFRecord\u3002\u7cfb\u7d71\u6703\u5c07 TFRecord \u5beb\u5165\u7531 `ImageClassificationBuilder` \u7684 `__init__` \u65b9\u6cd5\u7684 `data_dir` \u53c3\u6578\u6307\u5b9a\u7684\u8def\u5f91\u3002\n\u5728 [simple_example.py](https://github.com/tensorflow/tpu/blob/master/tools/data_converter/image_classification/simple_example.py) \u4e2d\uff0c `SimpleDatasetConfig` \u7232 `ImageClassificationConfig` \u8a2d\u7f6e\u5b50\u985e\uff0c\u5be6\u73fe\u7528\u65bc\u5b9a\u7fa9\u652f\u6301\u7684\u6a21\u5f0f\u3001\u5716\u7247\u985e\u6578\u91cf\u7684\u5c6c\u6027\uff0c\u4ee5\u53ca\u751f\u6210\u5305\u542b\u5716\u7247\u6578\u64da\u548c\u5716\u7247\u985e\u7684\u5b57\u5178\u7684\u793a\u4f8b\u751f\u6210\u5668\uff0c\u7528\u65bc\u6578\u64da\u96c6\u5167\u7684\u6bcf\u500b\u793a\u4f8b\u3002\n`main()` \u51fd\u6578\u5275\u5efa\u96a8\u6a5f\u751f\u6210\u7684\u5716\u7247\u6578\u64da\u7684\u6578\u64da\u96c6\uff0c\u4e26\u5be6\u4f8b\u5316\u4e00\u500b `SimpleDatasetConfig` \u5c0d\u8c61\uff0c\u6307\u5b9a\u985e\u6578\u548c\u6578\u64da\u96c6\u5728\u78c1\u76e4\u4e0a\u7684\u8def\u5f91\u3002\u63a5\u4e0b\u4f86\uff0c `main()` \u5be6\u4f8b\u5316\u4e00\u500b `ImageClassificationBuilder` \u5c0d\u8c61\uff0c\u4e26\u50b3\u5165 `SimpleDatasetConfig` \u5be6\u4f8b\u3002\u6700\u5f8c\uff0c `main()` \u8abf\u7528 `download_and_prepare()` \u3002\u8abf\u7528\u6b64\u65b9\u6cd5\u6642\uff0c `ImageClassificationBuilder` \u5be6\u4f8b\u4f7f\u7528\u7531 `SimpleDatasetConfig` \u5be6\u73fe\u7684\u6578\u64da\u793a\u4f8b\u751f\u6210\u5668\u4f86\u52a0\u8f09\u6bcf\u500b\u793a\u4f8b\uff0c\u4e26\u5c07\u5176\u4fdd\u5b58\u5230\u4e00\u7cfb\u5217 TFRecord \u6587\u4ef6\u4e2d\u3002\n\u5982\u9700\u66f4\u8a73\u7d30\u7684\u8aaa\u660e\uff0c\u8acb\u53c3\u95b1 [\u5206\u985e\u8f49\u63db\u5668\u7b46\u8a18\u672c](https://github.com/tensorflow/tpu/blob/master/tools/colab/image_classification_converter.ipynb) \u3002\n## \u6e96\u5099\u5de5\u4f5c## \u4fee\u6539\u6578\u64da\u8f49\u63db\u793a\u4f8b\u4ee5\u8f09\u5165\u6578\u64da\u96c6\u8981\u5c07\u6578\u64da\u96c6\u8f49\u63db\u7232 TFRecord \u683c\u5f0f\uff0c\u8acb\u7232\u5b9a\u7fa9\u4ee5\u4e0b\u5c6c\u6027\u7684 `ImageClassificationConfig` \u985e\u8a2d\u7f6e\u5b50\u985e\uff1a- num_labels - \u8fd4\u56de\u5716\u7247\u985e\u7684\u6578\u91cf\n- supported_modes - \u8fd4\u56de\u6578\u64da\u96c6\u652f\u6301\u7684\u6a21\u5f0f\u5217\u8868\uff08\u4f8b\u5982\uff1atest\u3001train \u548c validate\uff09\n- text_label_map - \u8fd4\u56de\u7528\u65bc\u5c0d\u6587\u672c\u985e\u6a19\u7c64\u548c\u6574\u6578\u985e\u6a19\u7c64\u4e4b\u9593\u7684\u6620\u5c04\u9032\u884c\u5efa\u6a21\u7684\u5b57\u5178\uff08SimpleDatasetConfig \u4e0d\u4f7f\u7528\u6b64\u5c6c\u6027\uff0c\u56e0\u7232\u5b83\u4e0d\u9700\u8981\u6620\u5c04\uff09\n- download_path - \u4e0b\u8f09\u6578\u64da\u96c6\u7684\u8def\u5f91\uff08SimpleDatasetConfig \u4e0d\u4f7f\u7528\u6b64\u5c6c\u6027\uff0cexample_generator \u5f9e\u78c1\u76e4\u52a0\u8f09\u6578\u64da\uff09\n\u5be6\u73fe example_generator \u751f\u6210\u5668\u51fd\u6578\u3002\u6b64\u65b9\u6cd5\u5fc5\u9808\u751f\u6210\u5305\u542b\u6bcf\u500b\u793a\u4f8b\u7684\u5716\u7247\u6578\u64da\u548c\u5716\u7247\u985e\u540d\u7a31\u7684\u5b57\u5178\u3002 `ImageClassificationBuilder` \u4f7f\u7528 `example_generator()` \u51fd\u6578\u6aa2\u7d22\u6bcf\u500b\u793a\u4f8b\u4e26\u5c07\u5176\u5beb\u5165 TFRecord \u683c\u5f0f\u7684\u78c1\u76e4\u3002## \u904b\u884c\u6578\u64da\u8f49\u5316\u793a\u4f8b\n- \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5275\u5efa Cloud Storage \u5b58\u5132\u6876\uff1a **\u6ce8\u610f** \uff1a\u5728\u4ee5\u4e0b\u547d\u4ee4\u4e2d\uff0c\u5c07 \u66ff\u63db\u7232\u60a8\u8981\u5206\u914d\u7d66\u5b58\u5132\u6876\u7684\u540d\u7a31\u3002```\ngsutil mb -p ${PROJECT_ID} -c standard -l us-central1 gs://bucket-name\n```\n- \u4f7f\u7528 `gcloud` \u547d\u4ee4\u5553\u52d5 Compute Engine \u865b\u64ec\u6a5f\u3002```\n$ gcloud compute tpus execution-groups create \\\u00a0--vm-only \\\u00a0--zone=us-central1-b \\\u00a0--name=imageclassificationconverter \\\u00a0--tf-version=2.5.0\n``` **\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u672a\u9023\u63a5\u5230 Compute Engine \u5be6\u4f8b\uff0c\u5247\u53ef\u4ee5\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u9032\u884c\u9023\u63a5\uff1a```\ngcloud compute ssh imageclassificationconverter --zone=us-central1-b \n```\u5f9e\u73fe\u5728\u958b\u59cb\uff0c\u524d\u7db4 `(vm)$` \u8868\u793a\u60a8\u61c9\u8a72\u5728 Compute Engine \u865b\u64ec\u6a5f\u5be6\u4f8b\u4e0a\u904b\u884c\u8a72\u547d\u4ee4\u3002\n- \u5b89\u88dd\u5fc5\u9700\u7684\u8edf\u4ef6\u5305\u3002```\n(vm)$ pip3 install opencv-python-headless pillow\n```\n- \u5275\u5efa\u8173\u672c\u4f7f\u7528\u7684\u4ee5\u4e0b\u74b0\u5883\u8b8a\u91cf\u3002```\n(vm)$ export STORAGE_BUCKET=gs://bucket-name\n``````\n(vm)$ export CONVERTED_DIR=$HOME/tfrecords(vm)$ export GENERATED_DATA=$HOME/data(vm)$ export GCS_CONVERTED=$STORAGE_BUCKET/data_converter/image_classification/tfrecords(vm)$ export GCS_RAW=$STORAGE_BUCKET/image_classification/raw(vm)$ export PYTHONPATH=\"$PYTHONPATH:/usr/share/tpu/models\"\n```\n- \u5207\u63db\u5230 `data_converter` \u76ee\u9304\u3002```\n(vm)$ cd /usr/share/tpu/tools/data_converter\n```\n## \u5c0d\u50de\u9020\u7684\u6578\u64da\u96c6\u904b\u884c\u6578\u64da\u8f49\u63db\u5668`simple_example.py` \u8173\u672c\u4f4d\u65bc\u6578\u64da\u8f49\u63db\u5668\u793a\u4f8b\u7684 `image_classification` \u6587\u4ef6\u593e\u4e2d\u3002\u4f7f\u7528\u4ee5\u4e0b\u53c3\u6578\u904b\u884c\u8173\u672c\u6703\u751f\u6210\u4e00\u7d44\u865b\u69cb\u5716\u7247\uff0c\u4e26\u5c07\u5176\u8f49\u63db\u7232 TFRecord\u3002\n```\n(vm)$ python3 image_classification/simple_example.py \\\u00a0 --num_classes=1000 \\\u00a0 --data_path=$GENERATED_DATA \\\u00a0 --generate=True \\\u00a0 --num_examples_per_class_low=10 \\\u00a0 --num_examples_per_class_high=11 \\\u00a0 --save_dir=$CONVERTED_DIR\n```## \u5728\u6211\u5011\u7684\u67d0\u500b\u539f\u59cb\u6578\u64da\u96c6\u4e0a\u904b\u884c\u6578\u64da\u8f49\u63db\u5668\n- \u7232\u539f\u59cb\u6578\u64da\u7684\u4f4d\u7f6e\u5275\u5efa\u4e00\u500b\u74b0\u5883\u8b8a\u91cf\u3002```\n(vm)$ export GCS_RAW=gs://cloud-tpu-test-datasets/data_converter/raw_image_classification\n```\n- \u904b\u884c `simple_example.py` \u8173\u672c\u3002```\n(vm)$ python3 image_classification/simple_example.py \\--num_classes=1000 \\--data_path=$GCS_RAW \\--generate=False \\--save_dir=$CONVERTED_DIR\n```\n`simple_example.py` \u8173\u672c\u63a1\u7528\u4ee5\u4e0b\u53c3\u6578\uff1a- `num_classes`\u8868\u793a\u6578\u64da\u96c6\u4e2d\u7684\u985e\u6578\u3002\u7232\u4e86\u8207 ImageNet \u683c\u5f0f\u4e00\u81f4\uff0c\u6211\u5011\u5728\u9019\u88cf\u4f7f\u7528 1000\u3002\n- `generate`\u78ba\u5b9a\u662f\u5426\u8981\u751f\u6210\u539f\u59cb\u6578\u64da\u3002\n- `data_path`\u662f\u6307\u61c9\u751f\u6210\u6578\u64da\u7684\u8def\u5f91\uff08\u5982\u679c`generate=True`\uff09\uff0c\u6216\u5b58\u5132\u539f\u59cb\u6578\u64da\u7684\u8def\u5f91\uff08\u5982\u679c`generate=False`\uff09\u3002\n- `num_examples_per_class_low`\u548c`num_examples_per_class_high`\u7528\u65bc\u78ba\u5b9a\u8981\u7232\u6bcf\u500b\u985e\u751f\u6210\u591a\u5c11\u500b\u793a\u4f8b\u3002\u8173\u672c\u6703\u7232\u6b64\u7bc4\u570d\u5167\u7684\u793a\u4f8b\u751f\u6210\u4e00\u500b\u96a8\u6a5f\u6578\u3002\n- `save_dir`\u662f\u6307\u5df2\u4fdd\u5b58 TFRecord \u7684\u4fdd\u5b58\u4f4d\u7f6e\u3002\u8981\u5728 Cloud TPU \u4e0a\u8a13\u7df4\u6a21\u578b\uff0c\u6578\u64da\u5fc5\u9808\u5b58\u5132\u5728 Cloud Storage \u4e0a\u3002 \u9019\u53ef\u4ee5\u4f4d\u65bc Cloud Storage \u6216\u865b\u64ec\u6a5f\u4e0a\u3002\n## \u91cd\u547d\u540d TFRecord \u4e26\u5c07\u5176\u79fb\u52d5\u5230 Cloud Storage\u4ee5\u4e0b\u793a\u4f8b\u5c07\u8f49\u63db\u5f8c\u7684\u6578\u64da\u7528\u65bc ResNet \u6a21\u578b\u3002- \u5c07 TFRecord \u91cd\u547d\u540d\u7232\u8207 ImageNet TFRecord \u76f8\u540c\u7684\u683c\u5f0f\uff1a```\n(vm)$ cd $CONVERTED_DIR/image_classification_builder/Simple/0.1.0/(vm)$ sudo apt install rename\n``````\n(vm)$ rename -v 's/image_classification_builder-(\\w+)\\.tfrecord/$1/g' *\n```\n- \u5c07 TFRecord \u8907\u88fd\u5230 Cloud Storage\uff1a```\n(vm)$ gsutil -m cp train* $GCS_CONVERTED(vm)$ gsutil -m cp validation* $GCS_CONVERTED\n```", "guide": "Cloud TPU"}