{"title": "Apigee - Cassandra backup and recovery", "url": "https://cloud.google.com/apigee/docs/api-platform/get-started/what-apigee", "abstract": "# Apigee - Cassandra backup and recovery\nYou are currently viewing version 1.1 of the Apigee hybrid documentation. **This version is end of life.** You should upgrade to a newer version. For more information, see [Supported versions](/apigee/docs/hybrid/supported-platforms#supported-versions) .\nThis section discusses how to configure data backup and recovery for the Apache Cassandra database ring installed in the Apigee hybrid runtime plane. See also [Cassandra database](/apigee/docs/hybrid/v1.1/what-is-hybrid#cassandra-datastore) .\n", "content": "## \n What you need to know about Cassandra backups\nCassandra is a replicated database that is configured to have at least 3 copies of your data in each region or data center. Cassandra uses streaming replication and read repairs to maintain the data replicas in each region or data center at any given point.\nIn hybrid, Cassandra backups are **not** enabled by default. It's a good practice, however, to enable Cassandra backups in case your data is accidentally deleted.\n## \n What is backed up?\nThe backup configuration described in this topic backs up the following entities:\n- Cassandra schema including the user schema (Apigee keyspace definitions)\n- Cassandra partition token information per node\n- A snapshot of the Cassandra data## \n Where is backup data stored?\nBacked up data is stored in a Google Cloud Storage (GCS) bucket that you must create. Bucket creation and configuration is covered in this topic.\n## \n Scheduling Cassandra backups\nBackups are scheduled as cron jobs in the runtime plane. To schedule Cassandra backups:\n- Run the following`create-service-account`command to create a GCP service account (SA) with the standard [roles/storage.objectAdmin](https://cloud.google.com/storage/docs/access-control/iam-roles) role. This SA role allows you to write backup data to Google Cloud Storage (GCS). Execute the following command in the hybrid installation root directory:```\n./tools/create-service-account apigee-cassandra output-dir\n```For example:```\n./tools/create-service-account apigee-cassandra ./service-accounts\n```For more information about GCP service accounts, see [Creating and managing service accounts](https://cloud.google.com/iam/docs/creating-managing-service-accounts) .\n- The`create-service-account`command saves a JSON file containing the  service account private key. The file is saved in the same directory  where the command executes. You will need the path to this file  in the following steps.\n- [Create a GCS bucket](https://cloud.google.com/storage/docs/creating-buckets) .  Specify a reasonable data [retention policy](https://cloud.google.com/storage/docs/bucket-lock#retention-policy) for the bucket. Apigee recommends a data retention  policy of 15 days.\n- Open your`overrides.yaml`file.\n- Add the following`cassandra.backup`properties to enable backup. Do not  remove any of the properties that are already configured.```\ncassandra:\u00a0 ...\u00a0 backup:\u00a0 \u00a0 enabled: true\u00a0 \u00a0 serviceAccountPath: sa_json_file_path\u00a0 \u00a0 dbStorageBucket: gcs_bucket_path\u00a0 \u00a0 schedule: backup_schedule_code\u00a0 ...\n```Where:| Property   | Description                                                                                              |\n|:-------------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| enabled   | Backup is disabled by default. You must set this property to true                                                                                 |\n| serviceAccountPath | The path on your filesystem to the service account JSON file that was downloaded when you ran ./tools/create-service-account                                                                  |\n| dbStorageBucket | GCS storage bucket path in this format: gs://bucket_name. The gs:// is required.                                                                             |\n| schedule   | The time when the backup starts, specified in standard crontab syntax. Default: 0 2 * * * Note: Avoid scheduling a backup that starts a short time after you apply the backup configuration to your cluster. When you apply the backup configuration, Kubernetes recreates the Cassandra nodes. If the backup starts before the nodes restart (possibly several minutes) the backup will fail. |For example:```\n...cassandra:\u00a0 storage:\u00a0 \u00a0 type: gcepd\u00a0 \u00a0 capacity: 50Gi\u00a0 \u00a0 gcepd:\u00a0 \u00a0 \u00a0 replicationType: regional-pd\u00a0 sslRootCAPath: \"/Users/myhome/ssh/cassandra.crt\"\u00a0 sslCertPath: \"/Users/myhome/ssh/cassandra.crt\"\u00a0 sslKeyPath: \"/Users/myhome/ssh/cassandra.key\"\u00a0 auth:\u00a0 \u00a0 default:\u00a0 \u00a0 \u00a0 password: \"abc123\"\u00a0 \u00a0 admin:\u00a0 \u00a0 \u00a0 password: \"abc234\"\u00a0 \u00a0 ddl:\u00a0 \u00a0 \u00a0 password: \"abc345\"\u00a0 \u00a0 dml:\u00a0 \u00a0 \u00a0 password: \"abc456\"\u00a0 nodeSelector:\u00a0 \u00a0 key: cloud.google.com/gke-nodepool\u00a0 \u00a0 value: apigee-data\u00a0 backup:\u00a0 \u00a0 enabled: true\u00a0 \u00a0 serviceAccountPath: \"/Users/myhome/.ssh/my_cassandra_backup.json\"\u00a0 \u00a0 dbStorageBucket: \"gs://myname-cassandra-backup\"\u00a0 \u00a0 schedule: \"45 23 * * 6\"\u00a0 ... \n```\n- Apply the configuration changes to the new cluster. For example:```\n./apigeectl apply -c 2_cassandra -v beta2\n```## \n Restoring backups\nRestoration takes the data from the backup location and restores it into a new Cassandra cluster with the same number of pods. The new cluster must have a namespace that is different than your runtime plane cluster.\nTo restore Cassandra backups:\n- Create a new Kubernetes cluster with a new namespace. You cannot use the same cluster/namespace that you used for the original hybrid installation.\n- In the root hybrid installation directory, create a new`overrides-restore.yaml`file.\n- Copy the complete Cassandra configuration from your original`overrides.yaml`file into the new one.\n- Add a namespace element. Do not use the same namespace you used for your original cluster.\n- ```\nnamespace: your-restore-namespacecassandra:\u00a0 storage:\u00a0 \u00a0 type: gcepd\u00a0 \u00a0 capacity: 50Gi\u00a0 \u00a0 gcepd:\u00a0 \u00a0 \u00a0 replicationType: regional-pd\u00a0 nodeSelector:\u00a0 \u00a0 key: cloud.google.com/gke-nodepool\u00a0 \u00a0 value: apigee-data\u00a0 sslRootCAPath: path_to_root_ca_file\u00a0 sslCertPath: path_to_ssl_cert_file\u00a0 sslKeyPath: path_to_ssl_key_file\u00a0 auth:\u00a0 \u00a0 default:\u00a0 \u00a0 \u00a0 password: your_cassandra_password\u00a0 \u00a0 admin:\u00a0 \u00a0 \u00a0 password: admin_password\u00a0 \u00a0 ddl:\u00a0 \u00a0 \u00a0 password: ddl_password\u00a0 \u00a0 dml:\u00a0 \u00a0 \u00a0 password: dml_password\u00a0 restore:\u00a0 \u00a0 \u00a0 enabled: true\u00a0 \u00a0 \u00a0 snapshotTimestamp: timestamp\u00a0 \u00a0 \u00a0 serviceAccountPath: sa_json_file_path\u00a0 \u00a0 \u00a0 dbStorageBucket: gcs_bucket_path\u00a0 \u00a0 \u00a0 image:\u00a0 \u00a0 \u00a0 \u00a0 pullPolicy: Always\n```\n- Where:\n- | Property   | Description                          |\n|:-------------------|:----------------------------------------------------------------------------------------------------------------|\n| ssl*Path, auth.* | Use the same TLS auth credentials you used to create the original Cassandra database.       |\n| snapshotTimestamp | The timestamp of the backup snapshot to restore.                |\n| serviceAccountPath | The path on your filesystem to the service account you created for the backup.         |\n| dbStorageBucket | GCS storage bucket path where your backup is stored, in this format: gs://bucket_name. The gs:// is required. |\n- For example:\n- ```\nnamespace: cassandra-restorecassandra:\u00a0 storage:\u00a0 \u00a0 type: gcepd\u00a0 \u00a0 capacity: 50Gi\u00a0 \u00a0 gcepd:\u00a0 \u00a0 \u00a0 replicationType: regional-pd\u00a0 sslRootCAPath: \"/Users/myhome/ssh/cassandra.crt\"\u00a0 sslCertPath: \"/Users/myhome/ssh/cassandra.crt\"\u00a0 sslKeyPath: \"/Users/myhome/ssh/cassandra.key\"\u00a0 auth:\u00a0 \u00a0 default:\u00a0 \u00a0 \u00a0 password: \"abc123\"\u00a0 \u00a0 admin:\u00a0 \u00a0 \u00a0 password: \"abc234\"\u00a0 \u00a0 ddl:\u00a0 \u00a0 \u00a0 password: \"abc345\"\u00a0 \u00a0 dml:\u00a0 \u00a0 \u00a0 password: \"abc456\"\u00a0 nodeSelector:\u00a0 \u00a0 key: cloud.google.com/gke-nodepool\u00a0 \u00a0 value: apigee-data\u00a0 restore:\u00a0 \u00a0 enabled: true\u00a0 \u00a0 snapshotTimestamp: \"20190417002207\"\u00a0 \u00a0 serviceAccountPath: \"/Users/myhome/.ssh/my_cassandra_backup.json\"\u00a0 \u00a0 dbStorageBucket: \"gs://myname-cassandra-backup\"\u00a0 \u00a0 image:\u00a0 \u00a0 \u00a0 pullPolicy: Always\n```\n- Where `snapshotTimestamp` is the timestamp associated with the  backup you are restoring.\n- Create the new Cassandra cluster:When you apply a new or modified backup configuration to your cluster, the existing Cassandra nodes will be restarted.```\n\u00a0 ./apigeectl apply -c 2_cassandra -v beta2 -f ./overrides-restore.yaml\u00a0 ./apigeectl apply -c 2_cassandra-role -v beta2 \n```## \n Viewing the restore logs\nYou can check the restore job logs and grep for `error` to make sure the restore log has no errors.\n### \n Verify the restore completed\nTo check if the restore operation completed:\n```\nkubectl get pods\nNAME       READY  STATUS  RESTARTS AGE\napigee-cassandra-0    1/1  Running  0   1h\napigee-cassandra-1    1/1  Running  0   1h\napigee-cassandra-2    1/1  Running  0   59m\napigee-cassandra-restore-b4lgf 0/1  Completed 0   51m\n```\n### \n View the restore logs\nTo view the restore logs:\n```\nkubectl logs -f apigee-cassandra-restore-b4lgf\nRestore Logs:\nActivated service account credentials for: [apigee-cassandra-backup-svc@gce-myusername.iam.gserviceaccount.com]\nto download file gs://gce-myusername-apigee-cassandra-backup/apigeecluster/dc-1/backup_20190405011309_schema.tgz\nINFO: download sucessfully extracted the backup files from gs://gce-myusername-apigee-cassandra-backup/apigeecluster/dc-1\nfinished downloading schema.cql\nto create schema from 10.32.0.28\nWarnings :\ndclocal_read_repair_chance table option has been deprecated and will be removed in version 4.0\ndclocal_read_repair_chance table option has been deprecated and will be removed in version 4.0\nWarnings :\ndclocal_read_repair_chance table option has been deprecated and will be removed in version 4.0\ndclocal_read_repair_chance table option has been deprecated and will be removed in version 4.0\nINFO: the schema has been restored\nstarting apigee-cassandra-0 in default\nstarting apigee-cassandra-1 in default\nstarting apigee-cassandra-2 in default\n84 95 106\nwaiting on waiting nodes $pid to finish 84\nActivated service account credentials for: [apigee-cassandra-backup-svc@gce-myusername.iam.gserviceaccount.com]\nActivated service account credentials for: [apigee-cassandra-backup-svc@gce-myusername.iam.gserviceaccount.com]\nActivated service account credentials for: [apigee-cassandra-backup-svc@gce-myusername.iam.gserviceaccount.com]\nINFO: restore downloaded tarball and extracted the file from gs://gce-myusername-apigee-cassandra-backup/apigeecluster/dc-1\nINFO: restore downloaded tarball and extracted the file from gs://gce-myusername-apigee-cassandra-backup/apigeecluster/dc-1\nINFO: restore downloaded tarball and extracted the file from gs://gce-myusername-apigee-cassandra-backup/apigeecluster/dc-1\nINFO 12:02:28 Configuration location: file:/etc/cassandra/cassandra.yaml\n\u2026...\nINFO 12:02:41 [Stream #e013ee80-5863-11e9-8458-353e9e3cb7f9] All sessions completed\nSummary statistics:\n Connections per host : 3\n Total files transferred : 2\n Total bytes transferred : 0.378KiB\n Total duration   : 5048 ms\n Average transfer rate : 0.074KiB/s\n Peak transfer rate  : 0.075KiB/s\nprogress: [/10.32.1.155]0:1/1 100% 1:1/1 100% [/10.32.0.28]1:1/1 100% 0:1/1 100% [/10.32.3.220]0:1/1 100% 1:1/1 100% total: 100% 0.000KiB/s (avg: 0.074KiB/s)\nINFO 12:02:41 [Stream #e013ee80-5863-11e9-8458-353e9e3cb7f9] All sessions completed\nprogress: [/10.32.1.155]0:1/1 100% 1:1/1 100% [/10.32.0.28]1:1/1 100% 0:1/1 100% [/10.32.3.220]0:1/1 100% 1:1/1 100% total: 100% 0.000KiB/s (avg: 0.074KiB/s)\nINFO 12:02:41 [Stream #e013ee80-5863-11e9-8458-353e9e3cb7f9] All sessions completed\nINFO 12:02:41 [Stream #e013ee80-5863-11e9-8458-353e9e3cb7f9] All sessions completed\nINFO: ./apigee/data/cassandra/data/ks1/user-9fbae960571411e99652c7b15b2db6cc restored successfully\nINFO: Restore 20190405011309 completed\nINFO: ./apigee/data/cassandra/data/ks1/user-9fbae960571411e99652c7b15b2db6cc restored successfully\nINFO: Restore 20190405011309 completed\nwaiting on waiting nodes $pid to finish 106\nRestore finished\n```\n### \n Verify backup job\nYou can also verify your backup job after your backup cronjob is scheduled. After the cronjob has been scheduled, you should see something like this:\n```\nkubectl get pods\nNAME      READY  STATUS  RESTARTS AGE\napigee-cassandra-0   1/1  Running  0   2h\napigee-cassandra-1   1/1  Running  0   2h\napigee-cassandra-2   1/1  Running  0   2h\napigee-cassandra-backup-1554515580-pff6s 0/1  Running  0   54s\n```\n### \n Check the backup logs\nThe backup job:\n- Creates a`schema.cql`file.\n- Uploads it to your storage bucket.\n- Echoes the node to backup the data and uploads it at the same time.\n- Waits until all of the data is uploaded.\n```\nkubectl logs -f apigee-cassandra-backup-1554515580-pff6s\nmyusername-macbookpro:cassandra-backup-utility myusername$ kubectl logs -f apigee-cassandra-backup-1554577680-f9sc4\nstarting apigee-cassandra-0 in default\nstarting apigee-cassandra-1 in default\nstarting apigee-cassandra-2 in default\n35 46 57\nwaiting on process 35\nActivated service account credentials for: [apigee-cassandra-backup-svc@gce-myusername.iam.gserviceaccount.com]\nActivated service account credentials for: [apigee-cassandra-backup-svc@gce-myusername.iam.gserviceaccount.com]\nActivated service account credentials for: [apigee-cassandra-backup-svc@gce-myusername.iam.gserviceaccount.com]\nRequested creating snapshot(s) for [all keyspaces] with snapshot name [20190406190808] and options {skipFlush=false}\nSnapshot directory: 20190406190808\nINFO: backup created cassandra snapshot 20190406190808\ntar: Removing leading `/' from member names\n/apigee/data/cassandra/data/ks1/mytest3-37bc2df0587811e98e8d875b0ed64754/snapshots/\n/apigee/data/cassandra/data/ks1/mytest3-37bc2df0587811e98e8d875b0ed64754/snapshots/20190406190808/\n/apigee/data/cassandra/data/ks1/mytest3-37bc2df0587811e98e8d875b0ed64754/snapshots/20190406190808/mc-1-big-Data.db\nRequested creating snapshot(s) for [all keyspaces] with snapshot name [20190406190808] and options {skipFlush=false}\nRequested creating snapshot(s) for [all keyspaces] with snapshot name [20190406190808] and options {skipFlush=false}\nSnapshot directory: 20190406190808\nINFO: backup created cassandra snapshot 20190406190808\ntar: Removing leading `/' from member names\n/apigee/data/cassandra/data/system/hints-2666e20573ef38b390fefecf96e8f0c7/snapshots/\n/apigee/data/cassandra/data/system/hints-2666e20573ef38b390fefecf96e8f0c7/snapshots/20190406190808/\n/apigee/data/cassandra/data/system/hints-2666e20573ef38b390fefecf96e8f0c7/snapshots/20190406190808/manifest.json\n/apigee/data/cassandra/data/system/prepared_statements-18a9c2576a0c3841ba718cd529849fef/snapshots/\n/apigee/data/cassandra/data/system/prepared_statements-18a9c2576a0c3841ba718cd529849fef/snapshots/20190406190808/\n/apigee/data/cassandra/data/system/prepared_statements-18a9c2576a0c3841ba718cd529849fef/snapshots/20190406190808/manifest.json\n/apigee/data/cassandra/data/system/range_xfers-55d764384e553f8b9f6e676d4af3976d/snapshots/\n/apigee/data/cassandra/data/system/range_xfers-55d764384e553f8b9f6e676d4af3976d/snapshots/20190406190808/\n/apigee/data/cassandra/data/system/range_xfers-55d764384e553f8b9f6e676d4af3976d/snapshots/20190406190808/manifest.json\n/apigee/data/cassandra/data/system/peer_events-59dfeaea8db2334191ef109974d81484/snapshots/\n/apigee/data/cassandra/data/system/peer_events-59dfeaea8db2334191ef109974d81484/snapshots/20190406190808/\n/apigee/data/cassandra/data/system/peer_events-59dfeaea8db2334191ef109974d81484/snapshots/20190406190808/manifest.json\n/apigee/data/cassandra/data/system/built_views-4b3c50a9ea873d7691016dbc9c38494a/snapshots/\n/apigee/data/cassandra/data/system/built_views-4b3c50a9ea873d7691016dbc9c38494a/snapshots/20190406190808/\n/apigee/data/cassandra/data/system/built_views-4b3c50a9ea873d7691016dbc9c38494a/snapshots/20190406190808/manifest.json\n\u2026\u2026\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-3-big-Filter.db\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-2-big-CompressionInfo.db\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-2-big-Index.db\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-3-big-Statistics.db\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-2-big-Data.db\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-1-big-Index.db\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-1-big-Statistics.db\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-2-big-TOC.txt\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-2-big-Statistics.db\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-1-big-Summary.db\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-1-big-Filter.db\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-2-big-Summary.db\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-3-big-Index.db\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/manifest.json\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-2-big-Filter.db\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-2-big-Digest.crc32\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-3-big-Summary.db\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-3-big-Data.db\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-1-big-TOC.txt\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/schema.cql\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-3-big-CompressionInfo.db\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-1-big-Digest.crc32\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-3-big-TOC.txt\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-1-big-Data.db\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-3-big-Digest.crc32\n/apigee/data/cassandra/data/ks2/user-d6d39d70586311e98e8d875b0ed64754/snapshots/20190406190808/mc-1-big-CompressionInfo.db\n\u2026\u2026\n/tmp/tokens.txt\n/ [1 files][ 0.0 B/ 0.0 B]\nOperation completed over 1 objects.\n/ [1 files][ 0.0 B/ 0.0 B]\nOperation completed over 1 objects.\nINFO: backup created tarball and transfered the file to gs://gce-myusername-apigee-cassandra-backup/apigeecluster/dc-1\nINFO: removing cassandra snapshot\nINFO: backup created tarball and transfered the file to gs://gce-myusername-apigee-cassandra-backup/apigeecluster/dc-1\nINFO: removing cassandra snapshot\nRequested clearing snapshot(s) for [all keyspaces]\nINFO: Backup 20190406190808 completed\nwaiting on process 46\nRequested clearing snapshot(s) for [all keyspaces]\nINFO: Backup 20190406190808 completed\nRequested clearing snapshot(s) for [all keyspaces]\nwaiting on process 57\nINFO: Backup 20190406190808 completed\nwaiting result\nto get schema from 10.32.0.28\nINFO: /tmp/schema.cql has been generated\nActivated service account credentials for: [apigee-cassandra-backup-svc@gce-myusername.iam.gserviceaccount.com]\ntar: removing leading '/' from member names\ntmp/schema.cql\nCopying from ...\n/ [1 files][ 0.0 B/ 0.0 B]\nOperation completed over 1 objects.\nINFO: backup created tarball and transfered the file to gs://gce-myusername-apigee-cassandra-backup/apigeecluster/dc-1\nfinished uploading schema.cql\n```", "guide": "Apigee"}