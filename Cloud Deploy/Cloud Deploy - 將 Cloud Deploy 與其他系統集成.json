{"title": "Cloud Deploy - \u5c07 Cloud Deploy \u8207\u5176\u4ed6\u7cfb\u7d71\u96c6\u6210", "url": "https://cloud.google.com/deploy/docs/integrating?hl=zh-cn", "abstract": "# Cloud Deploy - \u5c07 Cloud Deploy \u8207\u5176\u4ed6\u7cfb\u7d71\u96c6\u6210\n\u60a8\u53ef\u4ee5\u5c07 Cloud Deploy \u8207\u60a8\u7528\u65bc\u8edf\u4ef6\u4ea4\u4ed8\u7684\u4e00\u4e9b\u5176\u4ed6\u7cfb\u7d71\u96c6\u6210\u3002\u672c\u9801\u9762\u4ecb\u7d39\u5982\u4f55\u5c07 Cloud Deploy \u8207\u4ee5\u4e0b\u5404\u9805\u96c6\u6210\uff1a\n- \u6e2c\u8a66\u5de5\u5177\n- \u5de5\u4f5c\u6d41\u7ba1\u7406\n\u8acb\u53c3\u95b1 [\u8207 CI \u7cfb\u7d71\u96c6\u6210](https://cloud.google.com/deploy/docs/integrating-ci?hl=zh-cn) \uff0c\u77ad\u89e3\u5982\u4f55\u5f9e CI \u6d41\u6c34\u7dda\u8abf\u7528 Cloud Deploy\u3002\n", "content": "## \u6e96\u5099\u5de5\u4f5c\n\u672c\u9801\u9762\u4e2d\u7684\u8aaa\u660e\u5047\u5b9a\u60a8\u5df2\u6eff\u8db3\u4ee5\u4e0b\u689d\u4ef6\uff1a\n- \u60a8\u5df2 [\u5553\u7528\u9069\u7528\u7684 API](https://console.cloud.google.com/flows/enableapi?apiid=clouddeploy.googleapis.com%2Ccloudbuild.googleapis.com%2Cstorage-component.googleapis.com%2Ccontainer.googleapis.com&%3Bredirect=https%3A%2F%2Fcloud.google.com%2Fdeploy%2Fdocs%2Fdeploy-app-gke&%3B_ga=2.88599711.504283000.1626992575-1788689322.1622287630&hl=zh-cn) \n- \u60a8\u81f3\u5c11\u5df2\u5728 Cloud Deploy \u4e2d [\u5b9a\u7fa9](https://cloud.google.com/deploy/docs/config-file?hl=zh-cn) \u4e26 [\u8a3b\u518a](https://cloud.google.com/deploy/docs/create-pipeline-targets?hl=zh-cn#register_the_delivery_pipeline_and_targets) \u4e00\u689d\u4ea4\u4ed8\u6d41\u6c34\u7dda\u3002\n- \u60a8\u5b9a\u7fa9\u4e86\u81f3\u5c11\u4e00\u500b [\u76ee\u6a19](https://cloud.google.com/deploy/docs/config-files?hl=zh-cn#target_definitions) \uff0c\u4e26\u4e14\u4ea4\u4ed8\u6d41\u6c34\u7dda\u5f15\u7528\u4e86\u8a72\u76ee\u6a19\u3002\n- \u60a8\u5df2 [\u8a2d\u7f6e Pub/Sub \u901a\u77e5](https://cloud.google.com/deploy/docs/subscribe-deploy-notifications?hl=zh-cn) \uff0c\u4ee5\u63a5\u6536\u4f86\u81ea\u4ee5\u4e0b\u4e3b\u984c\u7684\u901a\u77e5\uff1a- `clouddeploy-operations`\n- `clouddeploy-approvals`\n## \u8207\u81ea\u52d5\u5316\u6e2c\u8a66\u96c6\u6210\n\u60a8\u53ef\u4ee5\u5c07 Cloud Deploy \u8207 Pub/Sub \u642d\u914d\u4f7f\u7528\uff0c\u5c07\u6e2c\u8a66\u8207\u4ea4\u4ed8\u6d41\u6c34\u7dda\u96c6\u6210\u5728\u4e00\u8d77\uff0c\u4ee5\u4fbf\u81ea\u52d5\u63d0\u5347\u7248\u672c\u4ee5\u5be6\u73fe\u6301\u7e8c\u4ea4\u4ed8\u3002\n\u60a8\u9084\u53ef\u4ee5\u5728\u767c\u4f48\u4e2d\u4f7f\u7528\u8a3b\u91cb\u4f86\u63d0\u4f9b\u6e2c\u8a66\u7d50\u679c\u7684\u93c8\u63a5\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5728 Cloud Deploy \u4e2d\u4f7f\u7528\u6a19\u7c64\u548c\u8a3b\u91cb](https://cloud.google.com/deploy/docs/labels-annotations?hl=zh-cn) \u3002\n### \u4f7f\u7528 Pub/Sub \u81ea\u52d5\u57f7\u884c\u63d0\u5347\n- \u5075\u807d\u4f86\u81ea `clouddeploy-operations` \u4e3b\u984c\u7684 [Pub/Sub \u6d88\u606f](https://cloud.google.com/deploy/docs/subscribe-deploy-notifications?hl=zh-cn) \u3002\u8a72\u6d88\u606f\u5305\u542b\u4ee5\u4e0b\u7279\u6027\uff1a- `Action: SUCCEED`\n- `ResourceType: Rollout`\n- `Resource: projects/.../locations/.../deliveryPipelines/.../releases/.../rollouts/...`\n- \u7576\u60a8\u6536\u5230\u90e8\u7f72\u6210\u529f\u7684\u901a\u77e5\u6642\uff0c\u8acb\u5728\u5df2\u90e8\u7f72\u7684\u61c9\u7528\u4e0a\u904b\u884c\u6e2c\u8a66\u3002\n- \u6e2c\u8a66\u6210\u529f\u5f8c\uff0c\u8abf\u7528 Cloud Deploy \u4ee5\u81ea\u52d5\u63d0\u5347\u5230\u4e0b\u4e00\u968e\u6bb5\uff1a```\ngcloud deploy releases promote RELEASE_NAME \\--delivery-pipeline=PIPELINE_NAME \\--region=REGION \\--annotations=KEY=VALUE,...\n```\u5176\u4e2d\uff1a- \u662f\u7248\u672c\u7684\u540d\u7a31\u3002\u5fc5\u9808\u63d0\u4f9b\u6b64\u503c\u3002\n- \u662f\u7ba1\u7406\u6b64\u7248\u672c\u7684\u4ea4\u4ed8\u6d41\u6c34\u7dda\u7684\u540d\u7a31\u3002\u6b64\u503c\u7232\u5fc5\u586b\u9805\u3002\n- \u662f\u6d41\u6c34\u7dda\u5728\u5176\u4e2d\u904b\u884c\u7684\u5340\u57df\u3002\u5982\u679c\u60a8\u5df2\u8a2d\u7f6e `deploy/region` \u5c6c\u6027\uff0c\u5247\u53ef\u4ee5\u7701\u7565\u6b64\u6a19\u8a8c\u3002\n- \u662f\u4e00\u500b\u7531\u4e00\u500b\u6216\u591a\u500b\u4ee5\u9017\u865f\u5206\u9694\u7684\u9375\u503c\u5c0d\u5b57\u7b26\u4e32\u5c0d\u7d44\u6210\u7684\u5217\u8868\uff0c\u5176\u4e2d\u5305\u542b\u6709\u95dc\u6e2c\u8a66\u7d50\u679c\u7684\u4fe1\u606f\u548c\u5176\u4ed6\u6e2c\u8a66\u4fe1\u606f\u3002\u793a\u4f8b\u5982\u4e0b\uff1a`gcloud deploy releases promote --annotations=\"from_target=test,status=stable\"`\u767c\u4f48\u7684\u8a3b\u89e3\u662f\u4e0d\u53ef\u8b8a\u7684\uff0c\u56e0\u6b64\uff0c\u5982\u679c\u60a8\u6dfb\u52a0\u72c0\u614b\u8a3b\u89e3\uff0c\u5247\u7121\u6cd5\u5728\u540c\u4e00\u6b21\u767c\u4f48\u4e2d\u66f4\u65b0\u8a72\u72c0\u614b\u3002\n### \u4f7f\u7528\u8a3b\u91cb\u63d0\u4f9b\u5c0d\u6e2c\u8a66\u7d50\u679c\u7684\u8a2a\u554f\u6b0a\u9650\n\u5982\u679c\u60a8\u7684\u7db2\u5740\u6307\u5411\u53ef\u8a2a\u554f\u6e2c\u8a66\u7d50\u679c\u7684\u4f4d\u7f6e\uff0c\u5247\u53ef\u4ee5\u4f7f\u7528 `--annotations` \u6a19\u8a8c\u4ee5\u767c\u4f48\u7684\u8a3b\u89e3\u5f62\u5f0f\u63d0\u4f9b\u8a72\u7db2\u5740\u3002\u793a\u4f8b\u5982\u4e0b\uff1a\n```\ngcloud deploy releases promote --delivery-pipeline=my-demo-app-1 --region=us-central1 --project=my-demo-app-1-project --release=test-release-001 --annotations=\"test_results_url=https://example.com/results/my-demo-app-test-results-dev\"\n```\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5728 Cloud Deploy \u4e2d\u4f7f\u7528\u6a19\u7c64\u548c\u8a3b\u91cb](https://cloud.google.com/deploy/docs/labels-annotations?hl=zh-cn) \u3002\n## \u96c6\u6210\u7b2c\u4e09\u65b9\u5de5\u4f5c\u6d41\u7ba1\u7406\nCloud Deploy \u5c07\u64cd\u4f5c\u6d88\u606f\u767c\u4f48\u5230 Pub/Sub\u3002 \u60a8\u7684\u5de5\u4f5c\u6d41\u7ba1\u7406\u5de5\u5177\u53ef\u4ee5\u8a02\u95b1\u9019\u4e9b Pub/Sub \u4e3b\u984c\uff0c\u4e26\u4f7f\u7528\u5b83\u5011\u4f86\u89f8\u767c\u7279\u5b9a\u5de5\u4f5c\u6d41\u3002\n### \u5c0d\u65bc\u6279\u51c6\n`clouddeploy-approvals` \u4e3b\u984c\u6703\u5728\u767c\u4f48\u9700\u8981\u6279\u51c6\u6642\u901a\u77e5\u60a8\u7cfb\u7d71\u3002\u7136\u5f8c\uff0c\u60a8\u7684\u5916\u90e8\u5de5\u4f5c\u6d41\u7cfb\u7d71\u53ef\u4ee5\u767c\u63ee\u5b83\u7684\u80fd\u529b\u4f86\u7372\u53d6\u6279\u51c6\uff0c\u7136\u5f8c\u8abf\u7528 `gcloud deploy rollouts approve` \u3002\n\u767c\u51fa `rollouts approve` \u547d\u4ee4\u7684\u8cec\u865f\u5fc5\u9808\u5177\u6709\u9810\u5b9a\u7fa9\u7684 IAM \u89d2\u8272 `roles/clouddeploy.approver` \u3002\n\u5982\u9700\u8a2d\u7f6e\u5916\u90e8\u6279\u51c6\u5de5\u4f5c\u6d41\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- [\u9700\u8981\u6279\u51c6\u76ee\u6a19](https://cloud.google.com/deploy/docs/promote-release?hl=zh-cn#manage_approvals_for_a_delivery_pipeline) \u3002\u5728\u8a72\u76ee\u6a19\u7684\u5b9a\u7fa9\u4e2d\uff0c\u6dfb\u52a0 `requireApproval: true` \u3002\n- \u5982\u9700\u4f7f\u7528\u9019\u4e9b\u6d88\u606f\uff0c\u8acb\u8a02\u95b1 `clouddeploy-approvals` Pub/Sub \u4e3b\u984c\u4e26\u8a2d\u7f6e\u5de5\u4f5c\u6d41\u7ba1\u7406\u7cfb\u7d71\u3002\n- \u7576\u60a8\u7684\u5de5\u4f5c\u6d41\u7ba1\u7406\u7cfb\u7d71\u6536\u5230\u4f86\u81ea `clouddeploy-approvals` \u4e3b\u984c\u5305\u542b `\"Action\": \"Required\"` \u7684\u6d88\u606f\u6642\uff0c\u6703\u5553\u52d5\u6839\u64da\u7d44\u7e54\u8981\u6c42\u914d\u7f6e\u7684\u5be9\u6279\u5de5\u4f5c\u6d41\u3002\u8a72\u6d88\u606f\u9084\u5305\u542b\u5c0d\u8981\u6279\u51c6\u7684\u767c\u4f48\u7684\u5f15\u7528\uff0c\u683c\u5f0f\u5982\u4e0b\uff1a`Resource: projects/.../locations/.../deliveryPipelines/.../releases/.../rollouts/...`\u6279\u51c6\u5de5\u4f5c\u6d41\u7684\u8f38\u51fa\u662f [\u6279\u51c6\u6216\u62d2\u7d55](https://cloud.google.com/deploy/docs/promote-release?hl=zh-cn#manage_approvals_for_a_delivery_pipeline) \u767c\u4f48\u3002\n- \u60a8\u7684\u5de5\u4f5c\u6d41\u7ba1\u7406\u7cfb\u7d71\u4ee5\u4ee5\u4e0b\u547d\u4ee4\u7684\u5f62\u5f0f\u5c07\u6279\u51c6\u6216\u62d2\u7d55\u7d50\u679c\u8fd4\u56de\u7d66 Cloud Deploy\uff1a\u7528\u65bc\u6279\u51c6\u767c\u4f48\u7684\u547d\u4ee4\u5982\u4e0b\u6240\u793a\uff1a```\ngcloud deploy rollouts approve ROLLOUT \\--delivery-pipeline=PIPELINE_NAME \\--region=REGION \\--release=RELEASE_NAME\n```\u7528\u65bc\u62d2\u7d55\u767c\u4f48\u7684\u547d\u4ee4\u5982\u4e0b\u6240\u793a\uff1a```\ngcloud deploy rollouts reject ROLLOUT \\--delivery-pipeline=PIPELINE_NAME \\--region=REGION \\--release=RELEASE_NAME\n```\u5176\u4e2d\uff1a- \u662f\u7232\u5176\u8acb\u6c42\u6279\u51c6\u7684\u767c\u4f48\u7684\u540d\u7a31\u3002\n- \u662f\u7ba1\u7406\u61c9\u7528\u90e8\u7f72\u7684\u4ea4\u4ed8\u6d41\u6c34\u7dda\u3002\n- \u662f\u8207\u6b64\u767c\u4f48\u95dc\u806f\u7684\u7248\u672c\u7684\u540d\u7a31\u3002\n- \u662f\u5728\u5176\u4e2d\u904b\u884c\u4ea4\u4ed8\u6d41\u6c34\u7dda\u7684\u5340\u57df\u3002\u4ee5\u4e0b\u662f\u4e00\u500b\u793a\u4f8b\uff1a\n`gcloud deploy rollouts approve test-rollout --delivery-pipeline=web-app --release=test-release --region=us-central1`", "guide": "Cloud Deploy"}