{"title": "Cloud Deploy - \u4f7f\u7528 Cloud Deploy \u901a\u77e5", "url": "https://cloud.google.com/deploy/docs/subscribe-deploy-notifications?hl=zh-cn", "abstract": "# Cloud Deploy - \u4f7f\u7528 Cloud Deploy \u901a\u77e5\n\u672c\u9801\u9762\u4ecb\u7d39\u77ad\u5982\u4f55\u4f7f\u7528 Cloud Deploy \u670d\u52d9\u901a\u77e5\uff0c\u5305\u62ec\u5982\u4f55\u8a02\u95b1\u5b83\u5011\u3002\nCloud Deploy \u4f7f\u7528 Pub/Sub \u51fa\u65bc\u5169\u500b\u76ee\u7684\u767c\u4f48\u901a\u77e5\uff1a\n- \u5141\u8a31\u60a8\u5c07 Cloud Deploy \u8207\u7b2c\u4e09\u65b9\u5de5\u5177\u548c\u5176\u4ed6 Google \u5de5\u5177\uff08\u4f8b\u5982\u5de5\u4f5c\u6d41\u5de5\u55ae\u5de5\u5177\u6216\u6e2c\u8a66\u57fa\u790e\u67b6\u69cb\u5de5\u5177\uff09\u96c6\u6210\u3002\n- \u4f7f\u7528\u88dc\u5145\u696d\u52d9\u908f\u8f2f\u64f4\u5c55 Cloud Deploy\u3002", "content": "## \u53ef\u7528\u4e3b\u984c\nCloud Deploy \u5c07\u6d88\u606f\u767c\u4f48\u5230\u4ee5\u4e0b\u4e00\u7d44 [Google Pub/Sub](https://cloud.google.com/pubsub?hl=zh-cn) \u4e3b\u984c\uff1a\n- `clouddeploy-resources`\u5c0d\u4efb\u4f55 Cloud Deploy \u6838\u5fc3\u8cc7\u6e90\uff08\u81ea\u52d5\u5316\u3001\u81ea\u5b9a\u7fa9\u76ee\u6a19\u985e\u578b\u3001\u4ea4\u4ed8\u6d41\u6c34\u7dda\u3001\u4f5c\u696d\u904b\u884c\u3001\u767c\u4f48\u3001\u767c\u4f48\u3001\u76ee\u6a19\uff09\u57f7\u884c\u64cd\u4f5c\uff08\u5275\u5efa\u3001\u66f4\u65b0\u3001\u522a\u9664\uff09\u6642\u3002\n- `clouddeploy-operations`- \u7576 Cloud Deploy \u6e32\u67d3 Skaffold \u914d\u7f6e\u6642\u3002\n- Cloud Deploy \u90e8\u7f72\u5230\u76ee\u6a19\uff08`Start`\u3001`Succeed`\u3001`Failure`\u3001`Terminated`\uff08\u4f5c\u696d\u904b\u884c\uff09\u3001`Cancelled`\uff08\u767c\u4f48\uff09\u6642\uff09\u3002\n- `clouddeploy-approvals`- \u7576 Cloud Deploy \u9700\u8981\u6279\u51c6\uff08\u6216\u62d2\u7d55\uff09\u767c\u4f48\u6642\u3002\n- \u767c\u4f48\u88ab\u6279\u51c6\u6216\u62d2\u7d55\u6642\u3002\n- `clouddeploy-advances`- Cloud Deploy \u767c\u4f48\u5f9e\u4e00\u500b\u968e\u6bb5\u63a8\u9032\u5230\u4e0b\u4e00\u500b\u968e\u6bb5\u3002\n- \u7576\u767c\u4f48\u53ef\u4ee5\u63a8\u9032\u6642\u3002\u60a8\u53ef\u4ee5\u5c07 [\u63a8\u9001\u6216\u62c9\u53d6\u6a21\u578b](https://cloud.google.com/pubsub/docs/subscriber?hl=zh-cn#push_pull) \u7528\u65bc Pub/Sub \u8a02\u95b1\u3002\n## \u63a5\u6536 Cloud Deploy \u670d\u52d9\u901a\u77e5\n\u5982\u9700\u63a5\u6536 Cloud Deploy \u670d\u52d9\u901a\u77e5\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u5553\u7528 Cloud Deploy API\uff1a [\u5553\u7528 Cloud Deploy API](https://console.cloud.google.com/apis/library/clouddeploy.googleapis.com?hl=zh-cn) \u7576\u60a8\u9996\u6b21\u8abf\u7528 Cloud Deploy API \u6642\uff0c\u7cfb\u7d71\u6703\u81ea\u52d5\u5c07 **Cloud Deploy Service Agent** \u670d\u52d9\u5e33\u865f\u6dfb\u52a0\u5230\u60a8\u7684\u9805\u76ee\u4e2d\u3002\u901a\u904e\u6b64\u670d\u52d9\u5e33\u865f\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 Pub/Sub \u63a5\u6536 Cloud Deploy \u670d\u52d9\u901a\u77e5\u3002\u670d\u52d9\u8cec\u865f\u540d\u7a31\u63a1\u7528\u4ee5\u4e0b\u683c\u5f0f\uff0c\u5176\u4e2d \u662f\u60a8\u7684\u9805\u76ee\u7de8\u865f\uff1a```\n\u00a0service-project-number@gcp-sa-clouddeploy.iam.gserviceaccount.com\n``` **\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u6c92\u6709\u770b\u5230\u5217\u51fa\u8a72\u670d\u52d9\u8cec\u865f\uff0c\u8acb\u9078\u4e2d\u9802\u90e8\u7684 **\u5305\u62ec Google \u63d0\u4f9b\u7684\u89d2\u8272\u6388\u6b0a** \u8907\u9078\u6846\u5217\u8868\u3002\u5982\u679c\u60a8\u4ecd\u672a\u5728 IAM \u9801\u9762\u4e0a\u770b\u5230 **Cloud Deploy Service Agent** \u670d\u52d9\u5e33\u865f\uff0c\u6216\u8005\u60a8\u7121\u6cd5\u63a5\u6536 Pub/Sub \u901a\u77e5\uff0c\u8acb\u5c07\u4ee5\u4e0b\u670d\u52d9\u5e33\u865f\u6dfb\u52a0\u5230\u60a8\u7684\u9805\u76ee\u4e2d\uff1a- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u6253\u958b **IAM** \u9801\u9762\uff1a [\u6253\u958b IAM \u9801\u9762](https://console.cloud.google.com/iam-admin/iam?hl=zh-cn) \n- \u9ede\u64ca **\u6dfb\u52a0** \u3002\n- \u6dfb\u52a0\u4ee5\u4e0b\u4e3b\u8cec\u865f\uff0c\u5176\u4e2d \u662f\u60a8\u7684\u9805\u76ee\u7de8\u865f\uff1a```\nservice-project-number@gcp-sa-clouddeploy.iam.gserviceaccount.com\n```\n- \u9078\u64c7 **\u670d\u52d9\u7ba1\u7406** > **Cloud Build Service Agent** \u4f5c\u7232\u60a8\u7684\u89d2\u8272\u3002\n- \u9ede\u64ca **\u4fdd\u5b58** \u3002\n- \u5553\u7528 Pub/Sub API\uff1a [\u5553\u7528 Pub/Sub API](https://console.cloud.google.com/apis/library/pubsub.googleapis.com?hl=zh-cn) \n- \u6839\u64da\u8981\u63a5\u6536\u7684\u901a\u77e5\u985e\u578b\u5275\u5efa Pub/Sub \u4e3b\u984c\uff1a```\ngcloud pubsub topics create clouddeploy-resourcesgcloud pubsub topics create clouddeploy-operationsgcloud pubsub topics create clouddeploy-approvalsgcloud pubsub topics create clouddeploy-advances\n```\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u7ba1\u7406 Pub/Sub \u4e3b\u984c\uff0c\u8acb\u53c3\u95b1 [\u7ba1\u7406\u4e3b\u984c\u548c\u8a02\u95b1](https://cloud.google.com/../pubsub/docs/admin?hl=zh-cn) \u3002\n**\u6ce8\u610f** \uff1aCloud Deploy \u751f\u6210\u7684 Pub/Sub \u901a\u77e5\u53d7 [Pub/Sub \u670d\u52d9\u7b49\u7d1a\u5354\u8b70 (SLA)](https://cloud.google.com/../pubsub/sla?hl=zh-cn) \u7684\u4fdd\u8b77\u3002\n## \u8a02\u95b1 Cloud Deploy \u670d\u52d9\u901a\u77e5\n\u60a8\u53ef\u4ee5\u901a\u904e\u591a\u7a2e\u65b9\u5f0f\u8a02\u95b1\u901a\u77e5\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5 [\u5c07\u6d88\u606f\u63a8\u9001\u5230\u7aef\u9ede](https://cloud.google.com/pubsub/docs/push?hl=zh-cn#configuring-http-endpoints) \u6216 [\u7de8\u5beb Python \u61c9\u7528\u4f86\u8f2a\u8a62\u8a02\u95b1](https://cloud.google.com/pubsub/docs/pull?hl=zh-cn#pubsub-pull-python) \u3002\n\u5982\u9700\u77ad\u89e3\u5982\u4f55\u7232 Cloud Deploy \u670d\u52d9\u901a\u77e5\u8a2d\u7f6e Pub/Sub \u8a02\u95b1\uff0c\u8acb\u53c3\u95b1 [Pub/Sub \u8a02\u95b1\u8005\u6307\u5357](https://cloud.google.com/pubsub/docs/subscriber?hl=zh-cn) \u3002\u60a8\u9084\u53ef\u4ee5\u77ad\u89e3 [Pub/Sub \u5ba2\u6236\u7aef\u5eab](https://cloud.google.com/pubsub/docs/reference/libraries?hl=zh-cn) \u4ee5\u4f7f\u958b\u767c\u8a02\u95b1\u8005\u61c9\u7528\u66f4\u52a0\u7c21\u55ae\u3002\n## \u5b57\u6bb5\u503c\n\u672c\u90e8\u5206\u5217\u51fa\u4e86 Cloud Deploy Pub/Sub \u6d88\u606f\u4e2d\u5b57\u6bb5\u7684\u53ef\u80fd\u503c\u3002\n### \u5c0d\u65bc Action\n\u5728\u9019\u4e9b\u901a\u77e5\u4e2d\uff0c `Action` \u7684\u53ef\u80fd\u503c\u5982\u4e0b\u3002\n- \u5c0d\u65bc\u8cc7\u6e90- `Create`\n- `Update`\n- `Delete`\n- \u5c0d\u65bc\u64cd\u4f5c\uff1a- `Start`\n- `Succeed`\n- `Failure`\n- `Terminated`\n- `Cancelled`\n- \u5c0d\u65bc\u6279\u51c6\uff1a- `Required`\n- `Approved`\n- `Rejected`\n- \u5c0d\u65bc\u9810\u4ed8\u6b3e\uff1a- `Required`\n- `Advanced`\n### \u5c0d\u65bc ResourceType\n`ResourceType` \u53ef\u80fd\u7684\u503c\u5982\u4e0b\uff1a\n- `DeliveryPipeline`\n- `Target`\n- `Release`\n- `Rollout`\n- `JobRun`## \u793a\u4f8b\u6d88\u606f\n\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u4e86\u4f86\u81ea Cloud Deploy \u4e3b\u984c\u7684\u5e7e\u7a2e\u985e\u578b\u7684 Pub/Sub \u6d88\u606f\u3002\n### \u5275\u5efa\u4ea4\u4ed8\u6d41\u6c34\u7dda\n\u4ee5\u4e0b\u662f\u4f5c\u7232\u5275\u5efa\u65b0 `deliveryPipeline` \u7684\u97ff\u61c9\u800c\u767c\u4f48\u5230 `clouddeploy-resources` \u7684 Pub/Sub \u6d88\u606f\u793a\u4f8b\uff1a\n```\n{\u00a0 \"ackId\": \u00a0 \"RFAGFixdRkhRNxkIaFEOT14jPzUgKEUQBQgUBXx9cEFMdVhddmhRDRlyfWByY11AAgVMVnldURsHaE5tdR_Wg6LHS0NVaF4TBgpGVX5fXx0IYVtedi_m7r_2wPXOXkAvOYXL6Mtpe735h9xvZiM9XxJLLD5-IzRFQV5AEkwoAURJUytDCypYEU4EISE-MD5FUw\",\u00a0 \"message\": {\u00a0 \u00a0 \"attributes\": {\u00a0 \u00a0 \u00a0 \"Action\": \"Create\",\u00a0 \u00a0 \u00a0 \"Resource\": \"projects/120123456789/locations/us-central1/deliveryPipelines/etest\",\u00a0 \u00a0 \u00a0 \"ResourceType\": \"DeliveryPipeline\",\u00a0 \u00a0 \u00a0 \"Location\": \"us-central1\",\u00a0 \u00a0 \u00a0 \"DeliveryPipelineId\": \"etest\",\u00a0 \u00a0 \u00a0 \"ProjectNumber\": \"120123456789\",\u00a0 \u00a0 },\u00a0 \u00a0 \"messageId\": \"2407836004659723\",\u00a0 \u00a0 \"publishTime\": \"2021-05-17T21:24:48.204Z\"\u00a0 }}\n```\n### \u6e32\u67d3\u958b\u59cb\n\u4ee5\u4e0b\u662f\u767c\u4f48\u5230 `clouddeploy-operations` \u4ee5\u901a\u77e5\u7248\u672c\u5df2\u6e32\u67d3\u7684 Pub/Sub \u6d88\u606f\u793a\u4f8b\uff1a\n```\n{\u00a0 \"ackId\": \"U0RQBhYsXUZIUTcZCGhRDk9eIz81IChFFwYIFAV8fXBBTHVeXHRoUQ0Zcn1gcmNfR1MLFlN5WFEaB2hObXUfioKix0tDVWheEwYKRVZ3W1kdBGFVXH0v_qD5rMP1zl5AKDnZyujLaXudkqxfZiM9XxJLLD5-PTNFQV5AEkw2BkRJUytDCypYEU4EISE-MD5F\",\u00a0 \"message\": {\u00a0 \u00a0 \"attributes\": {\u00a0 \u00a0 \u00a0 \"Action\": \"Start\",\u00a0 \u00a0 \u00a0 \"Resource\": \"projects/120123456789/locations/us-central1/deliveryPipelines/etest/releases/f2\",\u00a0 \u00a0 \u00a0 \"ResourceType\": \"Release\"\u00a0 \u00a0 \u00a0 \"Location\": \"us-central1\",\u00a0 \u00a0 \u00a0 \"DeliveryPipelineId\": \"etest\",\u00a0 \u00a0 \u00a0 \"ProjectNumber\": \"120123456789\",\u00a0 \u00a0 \u00a0 \"ReleaseId\": \"f2\",\u00a0 \u00a0 },\u00a0 \u00a0 \"messageId\": \"2407805942699908\",\u00a0 \u00a0 \"publishTime\": \"2021-05-17T21:28:04.201Z\"\u00a0 }}\n```\n### \u9700\u8981\u7372\u5f97\u6279\u51c6\n\u4ee5\u4e0b\u662f\u767c\u4f48\u5230 `clouddeploy-approvals` \u4ee5\u901a\u77e5\u767c\u4f48\u9700\u8981\u6279\u51c6\u7684 Pub/Sub \u6d88\u606f\u793a\u4f8b\uff1a\n```\n{\u00a0 \u00a0\"ackId\": \"RVNEUAYWLF1GSFE3GQhoUQ5PXiM_NSAoRRILUxNRXHQBWhBpWF8aB1ENGXJ8ZnxtCRBVU0FWf1VbEQ16bVxti6C2rERfQXduWhQJBkBXd11aHQhoXF9dotnkpeTv2kFwYSuN8_7mSH_Mo6AYZiA9XBJLLD5-IzZFQV5AEkwoA0RJUytDCypYEU4EISE-MD4\",\u00a0 \u00a0\"message\": {\u00a0 \u00a0 \u00a0\"attributes\": {\u00a0 \u00a0 \u00a0 \u00a0\"Action\": \"Required\",\u00a0 \u00a0 \u00a0 \u00a0\"Rollout\": \"projects/120123456789/locations/us-central1/deliveryPipelines/etest/releases/f2/rollouts/rollout-123\"\u00a0 \u00a0 \u00a0 \u00a0\"ReleaseId\": \"f2\",\u00a0 \u00a0 \u00a0 \u00a0\"RolloutId\": \"rollout-123\",\u00a0 \u00a0 \u00a0 \u00a0\"TargetId\": \"prod\",\u00a0 \u00a0 \u00a0 \u00a0\"Location\": \"us-central1\",\u00a0 \u00a0 \u00a0 \u00a0\"ProjectNumber\": \"120123456789\",\u00a0 \u00a0 \u00a0},\u00a0 \u00a0 \u00a0\"messageId\": \"2407845492165003\",\u00a0 \u00a0 \u00a0\"publishTime\": \"2021-05-17T21:31:25.143Z\"\u00a0 \u00a0}\u00a0}\n```\n### \u63d0\u524d\u767c\u4f48\n\u4ee5\u4e0b\u662f\u767c\u4f48\u5230 `clouddeploy-advances` \u7684 Pub/Sub \u6d88\u606f\u793a\u4f8b\uff0c\u8a72\u6d88\u606f\u7528\u65bc\u901a\u77e5\u767c\u4f48\u5df2\u5f9e\u4e00\u500b\u968e\u6bb5\u63a8\u9032\u5230\u4e0b\u4e00\u968e\u6bb5\uff1a\n```\n{\u00a0 \"ackId\": \"RFAGFixdRkhRNxkIaFEOT14jPzUgKEUSAwVPAihdeTFXKkFZdWhRDRlyfWB9bV4UUFZMV38OURoHaE5tdR_z4ILjS0NVbVkQBApEUHldXhkEa1RcfC-a0fmv1OzMV0AvOaCoyO9pe77r3NluZiM9XhJLLD5-Jz1FQV5AEkwsCERJUytDCypYEU4EISE-MD5FUw\",\u00a0 \"message\": {\u00a0 \u00a0 \"attributes\": {\u00a0 \u00a0 \u00a0 \"Action\": \"Advanced\",\u00a0 \u00a0 \u00a0 \"Location\": \"us-central1\",\u00a0 \u00a0 \u00a0 \"PhaseId\": \"stable\",\u00a0 \u00a0 \u00a0 \"ProjectNumber\": \"120123456789\",\u00a0 \u00a0 \u00a0 \"ReleaseId\": \"rollout-123\",\u00a0 \u00a0 \u00a0 \"Rollout\": \"projects/120123456789/locations/us-central1/deliveryPipelines/etest/releases/f2/rollouts/rollout-123\",\u00a0 \u00a0 \u00a0 \"RolloutId\": \"rollout-123\",\u00a0 \u00a0 \u00a0 \"TargetId\": \"prod\"\u00a0 \u00a0 },\u00a0 \u00a0 \"messageId\": \"7335813725293809\",\u00a0 \u00a0 \"publishTime\": \"2023-04-03T15:16:30.425Z\"\u00a0 }}\n```\n\u5728\u6b64\u6d88\u606f\u4e2d\uff0c `PhaseId` \u6a19\u8b58\u4e86\u767c\u4f48\u5df2\u63a8\u9032\u5230\u7684\u968e\u6bb5\u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n- [\u8a73\u7d30\u77ad\u89e3 Pub/Sub](https://cloud.google.com/pubsub/docs?hl=zh-cn) \u3002", "guide": "Cloud Deploy"}