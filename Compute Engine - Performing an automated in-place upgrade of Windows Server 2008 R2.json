{"title": "Compute Engine - Performing an automated in-place upgrade of Windows\u00a0Server 2008 R2", "url": "https://cloud.google.com/compute/docs/instances", "abstract": "# Compute Engine - Performing an automated in-place upgrade of Windows\u00a0Server 2008 R2\n**    Beta     ** This product or feature is subject to the \"Pre-GA Offerings Terms\" in the General Service Terms section   of the [Service Specific Terms](/terms/service-terms#1) .     Pre-GA products and features are available \"as is\" and might have limited support.    For more information, see the [launch stage descriptions](/products#product-launch-stages) .\nIf you have virtual machine (VM) instances running Windows Server 2008 R2, you can use the gcloud CLI to automatically upgrade them to Windows Server 2012 R2.\n **Warning:** Windows Server 2012 R2 is no longer supported. If you follow the procedure in this document to upgrade Windows Server 2008 R2 to Windows Server 2012 R2, you must then [upgrade to a supported version of Windows Server](/compute/docs/tutorials/performing-in-place-upgrade-windows-server) .\nUsing the gcloud CLI to perform an in-place upgrade is an alternative to [performing a manual upgrade](/compute/docs/tutorials/performing-in-place-upgrade-windows-server) . By automating the upgrade process, the gcloud CLI lets you reduce the effort required for each VM that you need to upgrade.\nDuring an in-place upgrade of a VM, the gcloud CLI performs the following steps:- Stops the VM.\n- Creates a [standard Persistent Disk snapshot](/compute/docs/disks/create-snapshots) as a backup.\n- Creates a copy of the boot disk, keeping the original boot disk as a backup.\n- Attaches an installation disk containing the [Windows 2012 R2 install media](/compute/docs/tutorials/performing-in-place-upgrade-windows-server#attaching_the_install_media) .\n- Launches Windows Setup (`setup.exe`) from the installation disk to perform an upgrade in [unattended mode](/compute/docs/tutorials/performing-in-place-upgrade-windows-server#starting_the_upgrade) .\n- Applies [post-upgrade configuration](/compute/docs/tutorials/performing-in-place-upgrade-windows-server#performing_post-upgrade_steps) .\n- Detaches the installation disk.\n- Stops the VM.\n", "content": "## LimitationsYou can use the gcloud CLI to perform upgrades from Windows Server 2008 R2 to Windows Server 2012 R2. This approach only supports VM instances that are based on a [public operating system image](/compute/docs/images#windows_server) provided by Google. To upgrade other configurations of Windows Server, or to upgrade VM instances for which you [bring your own license](/compute/docs/nodes/bringing-your-own-licenses) , see [Performing an in-place upgrade of Windows Server](/compute/docs/tutorials/performing-in-place-upgrade-windows-server?auto_signin=false#2019) .## CostsThere is no charge for performing an in-place upgrade of Windows Server. You are only charged for the resources consumed during the upgrade, including:- [Compute Engine](/compute) \nUse the [pricing calculator](/products/calculator#id=beb5326f-90c3-4842-9c3f-%0Aa3761b40fbe3) to generate a cost estimate based on your projected usage.## Before you begin\n- Make sure you understand the [limitations and potential alternatives](/compute/docs/tutorials/performing-in-place-upgrade-windows-server#alternatives_to_consider) to performing in-place upgrades of Windows Server.\n- Verify that Windows Server is up to date [by using Windows Update](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc731322(v=ws.11)#downloading-and-installing-updates) .\n- Disable or uninstall antivirus, antispyware, and other agents that can interfere with the upgrade or are incompatible with the Windows Server version that you're upgrading to.\n- Review the Microsoft documentation about prerequisites and potential limitations of Windows Server 2012 R2:- Verify that your VM instance meets the [system requirements for Windows Server 2012](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj134246(v%3Dws.11)#system-requirements) and has [sufficient free disk space](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj134246(v%3Dws.11)#disk-space-requirements) .\n- Review [recommendations for upgrading server roles](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ff972408(v=ws.10)#upgrading-server-roles) , [known issues](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ff972310(v=ws.10)) , and the [upgrade process](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ff972309(v=ws.10)) for Windows Server 2012 R2.\n- Review the [recommendations for planning an in-place upgrade](https://www.microsoft.com/upgradecenter/scenario/WS2008R2-on-prem-to-WS2012) .\n- Verify that you aren't affected by [features removed or deprecated](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn303411(v=ws.11)) in Windows Server 2012 R2.\n- Verify that any of your custom or third-party software is compatible with Windows Server 2012 R2.\n- Make sure you are granted one of the following Cloud IAM roles before proceeding:- [Compute Admin](/iam/docs/understanding-roles#compute-engine-roles) \n- [Compute Instance Admin](/iam/docs/understanding-roles#compute-engine-roles) \n- This guide uses [Cloud Shell](/shell/docs/starting-cloud-shell) to run the gcloud CLI. If you want to run the gcloud CLI on your local computer instead, make sure to [download and install the latest gcloud CLI](/sdk/docs#install_the_latest_cloud_sdk_version) first.\n## Starting the upgradeThe following sections guide you through the process of upgrading your VM instance.- In the Google Cloud console, open [Cloud Shell](/shell/docs/starting-cloud-shell) by clicking the **Activate Cloud Shell** button. [Go to the Google Cloud console](https://console.cloud.google.com/) \n- Set the default project ID. Replace `` with the name of your Compute Engine project:```\ngcloud config set project PROJECT_ID\n```\n- Run the following command to start the upgrade:```\ngcloud beta compute os-config os-upgrade VM_NAME \\\n --zone=ZONE \\\n --source-os=windows-2008r2 \\\n --target-os=windows-2012r2 \\\n --async \\\n --auto-rollback\n```Replace the following:- ``: the name of the VM instance to upgrade\n- ``: the zone the VM instance is running in\n **Note:** You might see a warning indicating that the Resource Manager API is not enabled in your project. In this case, press `y` to enable the API.The `--async` flag tells the gcloud CLI to run the upgrade in the background by using [Cloud Build](/build/docs) . Running the upgrade in the background lets you upgrade multiple VM instances in parallel and also ensures that the process continues even if you close your Cloud Shell session. You can find a link to the Cloud Build job in the command output:```\nCreated [https://cloudbuild.googleapis.com/v1/projects/...].\n...\nlogUrl: https://console.cloud.google.com/build/builds/...\n...\nstatus: QUEUED\n...\n``` **Warning:** Do not make changes to the VM instance or perform any action during the upgrade process.\n## Observing the upgrade processDepending on the configuration of your VM instance, the upgrade might take between 40 and 90 minutes to complete. You can check the status of the upgrade process by opening the Cloud Build log:- Click the URL shown next to`logUrl`in the command output of the gcloud CLI.\n- Under **Build log** , you can see the current status of the upgrade process.\nWhen the upgrade finishes successfully, the build is marked as **Successful** and you can see the following output in the build log:\n```\nSuccessfully upgraded instance 'projects/...!'\n```\nIf the gcloud CLI encounters a problem during the upgrade, it marks the build as **Failed** . If the `--auto-rollback` option is specified, the gcloud CLI also initiates an automatic rollback. You can find further details about the problem encountered in the build log.\nIf the upgrade is still running after 90 minutes and you suspect that the upgrade is not progressing, use one of the approaches described in [Troubleshooting the in-place upgrade](/compute/docs/tutorials/performing-in-place-upgrade-windows-server#troubleshooting_the_in-place_upgrade) to find out whether the upgrade process failed or is stalled.## Completing the upgradeAfter the upgrade is complete, start the VM instance and run Windows Update to download and install the latest security updates:- Start the VM instance:```\ngcloud compute instances start VM_NAME --zone=ZONE\n```Replace the following:- ``: the name of the VM instance\n- ``: the zone the VM instance is running in\n- Connect to the machine by using an RDP client. For more information, see [Connecting to instances](/compute/docs/instances/connecting-to-windows) .\n- Use Windows Update to [install the latest Windows updates](https://support.microsoft.com/en-us/help/12373/windows-update-faq) . You might have to restart the VM instance multiple times during this process.\n- Verify that all your applications work as expected.\n## Rolling back an upgradeIf the upgrade fails, the gcloud CLI automatically initiates a roll-back. If the upgrade succeeds, you might still find that one of your applications does not work as expected. In that case, roll back the upgrade by changing the VM instance to use the original boot disk again:- Stop the VM instance:```\ngcloud compute instances stop VM_NAME --zone=ZONE\n```Replace the following:- ``: the name of the VM instance\n- ``: the zone the VM instance is running in\n- In the build log, find the lines indicating the name of the original boot disk and the name of the attachment:```\n4. Original boot disk: ORIGINAL_DISK_NAME\n - Device name of the attachment: DEVICE_NAME\n```\n- Detach the disk containing the malfunctioning operating system from your instance:```\ngcloud compute instances detach-disk VM_NAME \\\n --device-name=DEVICE_NAME \\\n --zone=ZONE\n```Replace the following:- ``: the name of the VM instance\n- ``: the device name as indicated by the build log\n- ``: the zone the VM instance is running in\n- Reattach the original boot disk:```\ngcloud compute instances attach-disk VM_NAME \\\n --disk=ORIGINAL_DISK_NAME \\\n --device-name=DEVICE_NAME \\\n --zone=ZONE\n```Replace the following:- : the name of the VM instance\n- ``: the name of the original boot disk as indicated by the build log\n- ``: the device name as indicated by the build log\n- ``: the zone the VM instance is running in\n- Start the VM instance:```\ngcloud compute instances start VM_NAME --zone=ZONE\n```Replace the following:- ``: the name of the VM instance\n- ``: the zone the VM instance is running in## Clean upTo avoid incurring additional charges, remove the backups that the gcloud CLI automatically created before the upgrade:- In the build log, find the line indicating the name of the disk snapshot and the original boot disk:```\n3. Snapshot for original boot disk: SNAPSHOT_NAME\n4. Original boot disk: DISK_NAME\n - Device name of the attachment: ...\n - AutoDelete setting of the attachment: true\n5. Name of the new boot disk: ...\n```\n- Return to Cloud Shell and delete the disk snapshot:```\ngcloud compute snapshots delete SNAPSHOT_NAME\n```\n- Delete the original boot disk, replacing `` with the zone the VM is deployed in:```\ngcloud compute disks delete DISK_NAME --zone=ZONE\n```\n## What's next\n- Read about [manually performing in-place upgrades of Windows Server](/compute/docs/tutorials/performing-in-place-upgrade-windows-server) .\n- Find out how you can [troubleshoot an in-place upgrade](/compute/docs/tutorials/performing-in-place-upgrade-windows-server#troubleshooting_the_in-place_upgrade) .\n- Learn more about [persistent disk snapshots](/compute/docs/disks/create-snapshots) .", "guide": "Compute Engine"}