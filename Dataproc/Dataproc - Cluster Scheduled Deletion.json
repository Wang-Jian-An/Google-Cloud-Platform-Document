{"title": "Dataproc - Cluster Scheduled Deletion", "url": "https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/scheduled-deletion", "abstract": "# Dataproc - Cluster Scheduled Deletion\nTo help avoid incurring [Google Cloud charges](/dataproc/docs/resources/pricing) for an inactive cluster, use Dataproc's Cluster Scheduled Deletion feature when you create a cluster. This feature provides options to delete a cluster:\n- after a specified cluster idle period\n- at a specified future time\n- after a specified period that starts from the time of submission of the cluster creation request\n**Restrictions** :\n- You cannot change a cluster to a scheduled deletion cluster. However, you can update a scheduled deletion cluster to remove previously set scheduled deletion values.\n- The following actions disable the scheduled deletion of clusters. If you  perform any of these actions, you must revert the action to reenable cluster  scheduled deletion.- Removing IAM binding of [\"Control plane identity\"](/dataproc/docs/concepts/iam/dataproc-principals#service_agent_control_plane_identity) on the Dataproc Service Agent role\n- Disabling the Dataproc API while scheduled deletion clusters are running\n- Enabling Compute Engine VM deletion protection on any of the scheduled deletion cluster's VMs\n- Enabling [VPC-Service Controls](/vpc-service-controls/docs) if the [\"Control plane identity\"](/dataproc/docs/concepts/iam/dataproc-principals#service_agent_control_plane_identity) is not within the perimeter boundary\n", "content": "## Using Cluster Scheduled Deletion\n**Note:** The `dataproc:dataproc.cluster-ttl.consider-yarn-activity` [cluster property](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/cluster-properties#service_properties) is set to `true` by default for **image versions 1.4.64+, 1.5.39+, and 2.0.13+** . With this setting, with clusters created with these image versions, Cluster Scheduled Deletion by default will consider YARN activity, in addition to Dataproc Jobs API activity, when determining cluster idle time . This setting does not affect clusters with images with lower version numbers: cluster idle time for those clusters will continue to be computed based on Dataproc Jobs API activity only. When using image versions 1.4.64+, 1.5.39+, and 2.0.13+, you can opt out of this default behavior by setting this property to `false` when you create the cluster.\nYou can create a cluster with the Cluster Scheduled Deletion feature by passing the following scheduled deletion flags to the [gcloud dataproc clusters create](/sdk/gcloud/reference/dataproc/clusters/create) command.\n| Flag    | Description                                                                               | Finest Granularity | Min Value      | Max Value      |\n|:-------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------------------|:---------------------------------|:------------------------------|\n| --max-idle1  | The duration from the moment when the cluster enters the idle state to the moment when the cluster starts to delete. Provide the duration in IntegerUnit format, where the unit can be \"s, m, h, d\" (seconds, minutes, hours, days, respectively). Examples: \"30m\" or \"1d\" (30 minutes or 1 day from when the cluster becomes idle). | 1 second    | 5 minutes      | 14 days      |\n| --expiration-time2 | The time to start deleting the cluster in ISO 8601 datetime format. An easy way to generate the datetime in correct format is through the Timestamp Generator. For example, \"2017-08-22T13:31:48-08:00\" specifies an expiration time of 13:21:48 in the UTC -8:00 time zone.               | 1 second    | 10 minutes from the current time | 14 days from the current time |\n| --max-age2   | The duration from the moment of submitting the cluster create request to the moment when the cluster starts to delete. Provide the duration in IntegerUnit format, where the unit can be \"s, m, h, d\" (seconds, minutes, hours, days, respectively). Examples: \"30m\" (30 minutes from now); \"1d\" (1 day from now).     | 1 second    | 10 minutes      | 14 days      |\n **1** You can pass the`--max-idle`flag with either the`--expiration-time`or`--max-age`flag in your cluster create request. The first to become true will take effect to shut down the cluster. **2** You can pass either the`--expiration-time`flag or the`--max-age`flag to the cluster create command, but not both.\n```\ngcloud dataproc clusters create cluster-name \\\n\u00a0\u00a0\u00a0\u00a0--region=region \\\n\u00a0\u00a0\u00a0\u00a0--max-idle=duration \\\n\u00a0\u00a0\u00a0\u00a0--expiration-time=time \\\n\u00a0\u00a0\u00a0\u00a0... other flags ...\n```\nYou can update a cluster that was created with the scheduled deletion feature to change or remove scheduled deletion settings by passing the following scheduled deletion flags to the [gcloud dataproc clusters update](/sdk/gcloud/reference/dataproc/clusters/update) command (other cluster update flags cannot be combined with scheduled deletion flags).\n| Flag    | Description                                                                               | Finest Granularity | Min Value                                     | Max Value      |\n|:-------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------|:------------------------------|\n| --max-idle1  | The duration from the moment when the cluster enters the idle state to the moment when the cluster starts to delete. Provide the duration in IntegerUnit format, where the unit can be \"s, m, h, d\" (seconds, minutes, hours, days, respectively). Examples: \"30m\" or \"1d\" (30 minutes or 1 day from when the cluster becomes idle). | 1 second    | 5 minutes                                     | 14 days      |\n| --no-max-idle  | Cancels cluster auto-deletion by cluster idle duration previously set by the max-idle flag                                                           | not applicable  | not applicable                                    | not applicable    |\n| --expiration-time2 | The time to start deleting the cluster in ISO 8601 datetime format. An easy way to generate the datetime in correct format is through the Timestamp Generator. For example, \"2017-08-22T13:31:48-08:00\" specifies an expiration time of 13:21:48 in the UTC -8:00 time zone.               | 1 second    | 10 minutes from the current time, and the new time must not be earlier than the previously set time.              | 14 days from the current time |\n| --max-age2   | The duration from the moment of submitting the cluster update request to the moment when the cluster starts to delete. Provide the duration in IntegerUnit format, where the unit can be \"s, m, h, d\" (seconds, minutes, hours, days, respectively). Examples: \"30m\" (30 minutes from now); \"1d\" (1 day from now).     | 1 second    | 10 minutes, and the updated scheduled deletion time (update time + new max-age duration) must not be earlier than the previously set cluster deletion time. | 14 days      |\n| --no-max-age  | Cancels cluster auto-deletion by maximum cluster age previously set by the max-age or expiration-time flag                                                       | not applicable  | not applicable                                    | not applicable    |\n **1** You can pass the`--max-idle`flag with either the`--expiration-time`or`--max-age`flag in your cluster update request. The first to become true will take effect to shut down the cluster. **2** You can pass either the`--expiration-time`flag or the`--max-age`flag to the cluster update command, but not both.\n```\ngcloud dataproc clusters update cluster-name \\\n\u00a0\u00a0\u00a0\u00a0--region=region \\\n\u00a0\u00a0\u00a0\u00a0--max-idle=duration \\\n\u00a0\u00a0\u00a0\u00a0--no-max-age \\\n\u00a0\u00a0\u00a0\u00a0... other flags\n```You can create a cluster with the Cluster Scheduled Deletion feature  by setting the following [ClusterLifecycleConfig](/dataproc/docs/reference/rest/v1/ClusterConfig#lifecycleconfig) fields in your [cluster.create](/dataproc/docs/reference/rest/v1/projects.regions.clusters/create) or [cluster.patch](/dataproc/docs/reference/rest/v1/projects.regions.clusters/patch) API request.\n| Flag   | Description                                                       | Finest Granularity | Min Value                                                                 | Max Value      |\n|:----------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------------------|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:------------------------------|\n| idleDeleteTtl1 | The duration from the moment when the cluster enters the idle state to the moment when the cluster starts to delete. Provide a duration in seconds with up to nine fractional digits, terminated by 's'. Example: \"3.5s\".    | 1 second    | 5 minutes from the time of creating or updating the cluster. When updating a cluster, the new value must be greater than the previously set value. Submit a cluster.patch request with an empty duration to cancel a previously set idleDeleteTtl value.      | 14 days      |\n| autoDeleteTime2 | The time to start deleting the cluster. Provide a timestamp in RFC 3339 UTC \"Zulu\" format, accurate to nanoseconds. Example: \"2014-10-02T15:01:23.045123456Z\".                  | 1 second    | 10 minutes from the current time. When updating a cluster, the new time must be later than the previously set time.                                       | 14 days from the current time |\n| autoDeleteTtl2 | The duration from the moment of submitting the cluster create or update request to the moment when the cluster starts to delete. Provide a duration in seconds with up to nine fractional digits, terminated by 's'. Example: \"3.5s\". | 1 second    | 10 minutes. When updating a cluster, the new scheduled deletion time (update time + new max-age duration) must be later than the previously set cluster deletion time. Submit a cluster.patch request with an empty duration to cancel a previously set autoDeleteTtl value. | 14 days      |\n **1** You can set both`idleDeleteTtl`and either`autoDeleteTime`or`autoDeleteTtl`in your cluster create request. The first to become true will take effect to shut down the cluster. **2** You can set either`autoDeleteTime`or`autoDeleteTtl`in your cluster create request, but not both.\n- Open the Dataproc [Create a cluster](https://console.cloud.google.com/dataproc/clustersAdd) page, then select the Customize cluster panel. Scroll down to the  Scheduled deletion section, then select the options to apply to your cluster.## Viewing Scheduled Deletion cluster settings\nYou can use the `gcloud dataproc clusters list` command to confirm that a cluster has scheduled deletion enabled.\n```\n gcloud dataproc clusters list \\\n \u00a0\u00a0\u00a0\u00a0--region=region\n```\n```\n...\nNAME   WORKER_COUNT ... SCHEDULED_DELETE\ncluster-id number  ... enabled\n...\n```\nYou can use the `gcloud dataproc clusters describe` command to check a cluster's `LifecycleConfig` scheduled deletion settings.\n```\ngcloud dataproc clusters describe cluster-name \\\n\u00a0\u00a0\u00a0\u00a0--region=region\n```\n```\n...\nlifecycleConfig:\n autoDeleteTime: '2018-11-28T19:33:48.146Z'\n idleDeleteTtl: 1800s\n idleStartTime: '2018-11-28T18:33:48.146Z'\n...\n```\nThe `autoDeleteTime` and `idleDeleteTtl` are the scheduled deletion configuration values previously set by the user on the cluster. Dataproc generates the `idleStartTime` value, which is the latest cluster idle start time. Dataproc deletes the cluster if the cluster remains idle at `idleStartTime` + `idleDeleteTtl` .You can make a [clusters.list](/dataproc/docs/reference/rest/v1/projects.regions.clusters/list) request to confirm that a cluster has scheduled deletion enabled.You can view the cluster's scheduled deletion settings by selecting  the cluster name from the Dataproc [Clusters page](https://console.cloud.google.com/dataproc/clusters) in the  Google Cloud console. From the clusters details page, select the  CONFIGURATION tab. Scroll down the cluster configuration list to view  the scheduled deletion settings.", "guide": "Dataproc"}