{"title": "Dataproc - \u5c07 Ranger \u8207\u7de9\u5b58\u548c\u7e2e\u5c0f\u7bc4\u570d\u642d\u914d\u4f7f\u7528", "url": "https://cloud.google.com/dataproc/docs/concepts/components/ranger-caching-downscoping?hl=zh-cn", "abstract": "# Dataproc - \u5c07 Ranger \u8207\u7de9\u5b58\u548c\u7e2e\u5c0f\u7bc4\u570d\u642d\u914d\u4f7f\u7528\n**\u76ee\u6a19** \uff1a\u77ad\u89e3\u5982\u4f55\u4f7f\u7528 Ranger \u5c6c\u6027\u5728 Dataproc \u96c6\u7fa3\u4e0a\u5553\u7528\u7de9\u5b58\u548c\u7e2e\u5c0f\u7bc4\u570d\u3002\n", "content": "## \u5553\u7528\u7de9\u5b58\n\u672c\u90e8\u5206\u5217\u51fa\u4e86\u4f7f\u7528 Ranger \u5553\u7528\u7de9\u5b58\u7684\u6b65\u9a5f\uff0c\u53ef\u6e1b\u5c11 Ranger \u5bc6\u9470\u7ba1\u7406\u7cfb\u7d71 (KMS) \u52a0\u5bc6\u548c\u89e3\u5bc6\u4ee4\u724c\u6240\u9700\u7684\u5f80\u8fd4\u6b21\u6578\u3002\n**\u6ce8\u610f** \uff1a\u5f9e\u6620\u50cf\u7248\u672c `2.0.92` \u958b\u59cb\uff0cRanger \u7de9\u5b58\u9069\u7528\u65bc Compute Engine \u4e0a\u7684 Dataproc \u6620\u50cf\u7248\u672c\u3002\n- \u5728 Dataproc \u96c6\u7fa3\u865b\u64ec\u6a5f\u4e0a\u5b89\u88dd [memcached](https://memcached.org/) \u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cMemcached \u670d\u52d9\u5668\u5728\u865b\u64ec\u6a5f\u7aef\u53e3 11211 ( `localhost:11211` ) \u4e0a\u5553\u52d5\u3002```\nsudo apt-get install -y memcached\n```\n- \u5728 Dataproc \u96c6\u7fa3\u865b\u64ec\u6a5f\u7684 `/etc/dataproc-ranger-gcs-plugin/conf/ranger-gcs-site.xml` Ranger \u914d\u7f6e\u6587\u4ef6\u4e2d\u8a2d\u7f6e\u4ee5\u4e0b\u5c6c\u6027\u3002```\n<property>\n<name>authorization.service.remoteCaching.address</name>\n<value>localhost:11211</value>\n</property>\n<property>\n<name>authorization.service.remoteCaching.class</name>\n<value>com.google.cloud.hadoop.ranger.gcs.authorization.caching.MemcachedCache</value>\n</property>\n<property>\n<name>authorization.service.remoteCaching.encryption.key.uri</name>\n<value>gcp-kms://projects/PROJECT_ID_OF_KMS_KEY/locations/REGION/keyRings/KEYRING_NAME/cryptoKeys/KEY_NAME</value>\n</property>\n```\n- \u91cd\u5553\u6388\u6b0a\u670d\u52d9\u3002```\nsudo systemctl restart ranger-gcs-plugin-authorization-server\n```\n### \u67e5\u770b\u7de9\u5b58\u72c0\u614b\n\u60a8\u53ef\u4ee5\u4f7f\u7528 [telnet](https://en.wikipedia.org/wiki/Telnet) \u67e5\u770b Ranger \u7de9\u5b58\u72c0\u614b\u3002\n- \u5b89\u88dd `telnet` \u3002```\nsudo apt-get install -y telnet\n```\n- \u4f7f\u7528 telnet \u9023\u63a5\u5230\u865b\u64ec\u6a5f\u7aef\u53e3 `11211` \u4e0a\u7684 `memcache` \u3002```\nsudo telnet 127.0.0.1 11211\n```\n- \u4f7f\u7528 `telnet` \u547d\u4ee4\u67e5\u770b\u7de9\u5b58\u72c0\u614b\uff0c\u5177\u9ad4\u547d\u4ee4\u5305\u62ec\uff1a- `stats items`\uff1a\u5217\u51fa\u7de9\u5b58\u9805\u7684\u72c0\u614b\u3002 \u793a\u4f8b\u8f38\u51fa\uff1a```\nSTAT items:17:number 2\nSTAT items:17:number_hot 0\nSTAT items:17:number_warm 0\nSTAT items:17:number_cold 2\n```\n- `stats cachedump`\uff1a\u5217\u51fa\u5b58\u5132\u5728\u7de9\u5b58\u4e2d\u7684\u9375\u3002 \u793a\u4f8b\u8f38\u51fa\uff1a```\nstats cachedump 17 2\nITEM 0616eeeeb54e23a09505da5bf75cd7fafe733eacf0d07bd7b1ac9cf46d17c188 [3051 b; 1707948281 s]\nITEM d23645df9c79290d59ddb1b9710ff04fee37aa0b5de866b9b6d56b54641d68b4 [3078 b; 1707948281 s]\n```\n- `flush_all`\uff1a\u4f7f\u7de9\u5b58\u9805\u5931\u6548\u3002\n## \u7e2e\u5c0f Cloud Storage \u8a2a\u554f\u4ee4\u724c\u7684\u7bc4\u570d\n\u60a8\u53ef\u80fd\u9700\u8981\u7e2e\u5c0f Ranger \u8a2a\u554f\u4ee4\u724c\u7684\u7bc4\u570d\uff0c\u624d\u80fd\u4e0a\u79fb\uff08\u64f4\u5927\uff09\u5916\u90e8 Hive \u8868\u6307\u5411\u7684 Cloud Storage \u8def\u5f91\u3002\n\u5982\u9700\u5c07\u6240\u6709\u5206\u5340\u548c\u5b50\u5206\u5340\u4e0a\u79fb\u5230\u8868\u7d1a\u5225\uff0c\u8acb\u5728 Dataproc \u96c6\u7fa3\u865b\u64ec\u6a5f\u7684 `ranger-gcs-site.xml` \u914d\u7f6e\u6587\u4ef6\u4e2d\u5c07 `downscope.table.partition-name.pruning.enabled` \u5c6c\u6027\u8a2d\u7f6e\u7232 `true` \u3002\n```\n<property>\n <name>downscope.table.partition-name.pruning.enabled</name>\n <value>true</value>\n</property>\n```\n\u793a\u4f8b\uff1a\n- Cloud Storage \u5b58\u5132\u6876\u540d\u7a31\uff1a`gs://warehouse`\n- \u539f\u59cb\u8a2a\u554f\u4ee4\u724c\u8def\u5f91\uff1a`warehouse/hive/table/type=debit/year=2017/month=Aug/day=01/`\n- \u5c07`downscope.table.partition-name.pruning.enabled`\u8a2d\u7f6e\u7232`true`\u5f8c\uff0c\u64f4\u5c55\u7684\u8a2a\u554f\u4ee4\u724c\u8def\u5f91\uff1a`warehouse/hive/table/`\n**\u6ce8\u610f** \uff1a\u7576 `log4j.properties` \u8a2d\u7f6e\u7232 `debug` \u6642\uff0c\u60a8\u53ef\u4ee5\u5728 `/var/log/ranger-gcs-plugin-authorization-server.log` \u4e2d\u9a57\u8b49\u8a2a\u554f\u4ee4\u724c\u8def\u5f91\u3002", "guide": "Dataproc"}