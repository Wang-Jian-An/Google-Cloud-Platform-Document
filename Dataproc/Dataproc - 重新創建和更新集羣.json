{"title": "Dataproc - \u91cd\u65b0\u5275\u5efa\u548c\u66f4\u65b0\u96c6\u7fa3", "url": "https://cloud.google.com/dataproc/docs/guides/recreate-cluster?hl=zh-cn", "abstract": "# Dataproc - \u91cd\u65b0\u5275\u5efa\u548c\u66f4\u65b0\u96c6\u7fa3\nDataproc \u6703\u963b\u6b62\u5275\u5efa\u4f7f\u7528 1.3.95\u30011.4.77\u30011.5.53 \u548c 2.0.27 \u4e4b\u524d\u7684\u6620\u50cf\u7248\u672c\u7684\u96c6\u7fa3\uff0c\u9019\u4e9b\u7248\u672c\u53d7 [Apache Log4j \u5b89\u5168\u6f0f\u6d1e](https://logging.apache.org/log4j/2.x/security.html) \u7684\u5f71\u97ff\u3002Dataproc \u9084\u6703\u963b\u6b62\u7232 Dataproc \u6620\u50cf\u7248\u672c 0.x\u30011.0.x\u30011.1.x \u548c 1.2.x \u5275\u5efa\u96c6\u7fa3\u3002Dataproc \u5efa\u8b70\u5118\u53ef\u80fd\u4f7f\u7528\u6700\u65b0\u7684\u6b21\u8981\u6620\u50cf\u7248\u672c\u5275\u5efa Dataproc \u96c6\u7fa3\u3002| \u6620\u50cf\u7248\u672c       | log4j \u7248\u672c | \u5ba2\u6236\u6307\u5c0e |\n|:------------------------------------|:-------------|:-----------|\n| 2.0.29\u30011.5.55 \u548c 1.4.79 \u6216\u66f4\u9ad8\u7248\u672c | log4j.2.17.1 | \u5efa\u8b70  |\n| 2.0.28\u30011.5.54 \u548c 1.4.78   | log4j.2.17.0 | \u5efa\u8b70  |\n| 2.0.27\u30011.5.53 \u548c 1.4.77   | log4j.2.16.0 | \u5f37\u70c8\u5efa\u8b70 |\n| 2.0.26\u30011.5.52 \u548c 1.4.76 \u6216\u66f4\u65e9\u7248\u672c | \u820a\u7248   | \u505c\u6b62\u4f7f\u7528 |\u5982\u9700\u77ad\u89e3\u7279\u5b9a\u6620\u50cf\u548c `log4j` \u66f4\u65b0\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 [Dataproc \u7248\u672c\u8aaa\u660e](https://cloud.google.com/dataproc/docs/release-notes?hl=zh-cn) \u3002\n", "content": "## \u91cd\u65b0\u5275\u5efa\u548c\u66f4\u65b0\u96c6\u7fa3\u7684\u6b65\u9a5f\n\u60a8\u53ef\u4ee5\u4f7f\u7528 `gcloud` \u547d\u4ee4\u884c\u5de5\u5177\u6216 Dataproc API \u5f9e\u73fe\u6709\u96c6\u7fa3\u4e2d\u8907\u88fd\u914d\u7f6e\uff0c\u66f4\u65b0\u8907\u88fd\u7684\u914d\u7f6e\uff0c\u7136\u5f8c\u4f7f\u7528\u66f4\u65b0\u5f8c\u7684\u914d\u7f6e\u5275\u5efa\u65b0\u96c6\u7fa3\u3002\n\u793a\u4f8b\u8aaa\u660e\u5c55\u793a\u77ad\u5982\u4f55\u66f4\u65b0\u96c6\u7fa3\u914d\u7f6e\u4e2d\u7684\u6620\u50cf\u7248\u672c\u8a2d\u7f6e\u3002\u60a8\u53ef\u4ee5\u66f4\u6539\u793a\u4f8b\u4ee5\u66f4\u65b0\u4e0d\u540c\u7684\u96c6\u7fa3\u914d\u7f6e\u8a2d\u7f6e\u3002\n\u5efa\u8b70\u7684\u505a\u6cd5\u662f\u7232\u751f\u7522\u74b0\u5883\u6307\u5b9a`major.minor`\u6620\u50cf\u7248\u672c\uff0c\u6216\u8005\u7576\u8207\u7279\u5b9a\u7d44\u4ef6\u7248\u672c\u7684\u517c\u5bb9\u6027\u5f88\u91cd\u8981\u6642\u6307\u5b9a\u6620\u50cf\u7248\u672c\u3002\u6b21\u8981\u767c\u884c\u7248\u548c\u64cd\u4f5c\u7cfb\u7d71\u767c\u884c\u7248\u6703\u81ea\u52d5\u8a2d\u7f6e\u7232\u6700\u65b0\u7684\u6bcf\u9031\u7248\u672c\u3002\n- \u8a2d\u7f6e\u8b8a\u91cf\u3002```\nexport PROJECT=project-id\nexport REGION=region\nexport OLD_CLUSTER=old-cluster-name\nexport NEW_CLUSTER=new-cluster-name\nexport NEW_IMAGE_VERSION=image-version (for example, '2.2-debian12')\n```\n- \u5c07\u73fe\u6709\uff08\u820a\uff09\u96c6\u7fa3\u914d\u7f6e\u5c0e\u51fa\u5230 YAML \u6587\u4ef6\u3002```\ngcloud dataproc clusters export $OLD_CLUSTER \\\n\u00a0\u00a0\u00a0\u00a0--project=$PROJECT \\\n\u00a0\u00a0\u00a0\u00a0--region=$REGION > \"${OLD_CLUSTER}-config.yaml\"\n```\n- \u66f4\u65b0\u914d\u7f6e\u3002\u4ee5\u4e0b\u793a\u4f8b\u4f7f\u7528`sed`\u66f4\u65b0\u6620\u50cf\u7248\u672c\u3002```\nsed -E \"s|(^[[:blank:]]+)imageVersion: .+|\\1imageVersion: ${NEW_IMAGE_VERSION}|g\" \"${OLD_CLUSTER}-config.yaml\" | sed -E '/^[[:blank:]]+imageUri: /d' > \"${NEW_CLUSTER}-config-updated.yaml\"\n```\n- \u4f7f\u7528\u65b0\u540d\u7a31\u548c\u66f4\u65b0\u5f8c\u7684\u914d\u7f6e\u5275\u5efa\u65b0\u96c6\u7fa3\u3002```\ngcloud dataproc clusters import $NEW_CLUSTER \\\n\u00a0\u00a0\u00a0\u00a0--project=$PROJECT \\\n\u00a0\u00a0\u00a0\u00a0--region=$REGION \\\n\u00a0\u00a0\u00a0\u00a0--source=\"${NEW_CLUSTER}-config-updated.yaml\"\n```\n- \u78ba\u8a8d\u60a8\u7684\u5de5\u4f5c\u8ca0\u8f09\u5728\u65b0\u96c6\u7fa3\u4e2d\u904b\u884c\u6b63\u5e38\u5f8c\uff0c\u522a\u9664\u73fe\u6709\uff08\u820a\uff09\u96c6\u7fa3\u3002 **\u91cd\u8981\u63d0\u793a** \uff1a\u6b64\u6b65\u9a5f\u6703\u522a\u9664\u60a8\u7684\u96c6\u7fa3\u4e2d HFDS \u548c\u672c\u5730\u78c1\u76e4\u4e2d\u5b58\u5132\u7684\u6240\u6709\u6578\u64da\u3002```\ngcloud dataproc clusters delete $OLD_CLUSTER \\\n\u00a0\u00a0\u00a0\u00a0--project=$PROJECT \\\n\u00a0\u00a0\u00a0\u00a0--region=$REGION\n```\n\u793a\u4f8b\u8aaa\u660e\u5c55\u793a\u77ad\u5982\u4f55\u66f4\u65b0\u96c6\u7fa3\u914d\u7f6e\u4e2d\u7684\u96c6\u7fa3\u540d\u7a31\u548c\u6620\u50cf\u7248\u672c\u8a2d\u7f6e\u3002\u60a8\u53ef\u4ee5\u66f4\u6539\u793a\u4f8b\u8b8a\u91cf\u4ee5\u66f4\u65b0\u4e0d\u540c\u7684\u96c6\u7fa3\u914d\u7f6e\u8a2d\u7f6e\u3002\n\u5efa\u8b70\u7684\u505a\u6cd5\u662f\u7232\u751f\u7522\u74b0\u5883\u6307\u5b9a`major.minor`\u6620\u50cf\u7248\u672c\uff0c\u6216\u8005\u7576\u8207\u7279\u5b9a\u7d44\u4ef6\u7248\u672c\u7684\u517c\u5bb9\u6027\u5f88\u91cd\u8981\u6642\u6307\u5b9a\u6620\u50cf\u7248\u672c\u3002\u6b21\u8981\u767c\u884c\u7248\u548c\u64cd\u4f5c\u7cfb\u7d71\u767c\u884c\u7248\u6703\u81ea\u52d5\u8a2d\u7f6e\u7232\u6700\u65b0\u7684\u6bcf\u9031\u7248\u672c\u3002\n- \u8a2d\u7f6e\u8b8a\u91cf\u3002```\nexport PROJECT=project-id\nexport REGION=region\nexport OLD_CLUSTER=old-cluster-name\nexport NEW_CLUSTER=new-cluster-name\nexport NEW_IMAGE_VERSION=image-version (for example, '2.2-debian12')\n```\n- \u5c07\u73fe\u6709\uff08\u820a\uff09\u96c6\u7fa3\u914d\u7f6e\u5c0e\u51fa\u5230 JSON \u6587\u4ef6\u3002```\ncurl -X GET -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \"https://dataproc.googleapis.com/v1/projects/${PROJECT}/regions/${REGION}/clusters/${OLD_CLUSTER}?alt=json\" > \"${OLD_CLUSTER}-config.json\"\n```\n- \u66f4\u65b0\u914d\u7f6e\u3002\u4ee5\u4e0b\u793a\u4f8b\u4f7f\u7528`jq`\u66f4\u65b0\u96c6\u7fa3\u540d\u7a31\u548c\u6620\u50cf\u7248\u672c\u3002```\njq \".clusterName = \\\"${NEW_CLUSTER}\\\" | .config.softwareConfig.imageVersion=\\\"${NEW_IMAGE_VERSION}\\\" | del(.config.workerConfig.imageUri) | del(.config.masterConfig.imageUri)\" \"${OLD_CLUSTER}-config.json\" > \"${NEW_CLUSTER}-config-updated.json\"\n```\n- \u5c0e\u5165\u66f4\u65b0\u5f8c\u7684\u96c6\u7fa3\u914d\u7f6e\uff0c\u4ee5\u4f7f\u7528\u66f4\u65b0\u5f8c\u7684\u914d\u7f6e\u5275\u5efa\u65b0\u96c6\u7fa3\u3002```\ncurl -i -X POST -H \"Authorization: Bearer $(gcloud auth print-access-token)\" -H \"Content-Type: application/json; charset=utf-8\" -d \"@${NEW_CLUSTER}-config-updated.json\" \"https://dataproc.googleapis.com/v1/projects/${PROJECT}/regions/${REGION}/clusters?alt=json\"\n```\n- \u78ba\u8a8d\u60a8\u7684\u5de5\u4f5c\u8ca0\u8f09\u5728\u65b0\u96c6\u7fa3\u4e2d\u904b\u884c\u6b63\u5e38\u5f8c\uff0c\u522a\u9664\u73fe\u6709\uff08\u820a\uff09\u96c6\u7fa3\u3002 **\u91cd\u8981\u63d0\u793a** \uff1a\u6b64\u6b65\u9a5f\u6703\u522a\u9664\u96c6\u7fa3\u4e2d HDFS \u548c\u672c\u5730\u78c1\u76e4\u4e0a\u5b58\u5132\u7684\u6240\u6709\u6578\u64da\u3002```\ncurl -X DELETE -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \"https://dataproc.googleapis.com/v1/projects/${PROJECT}/regions/${REGION}/clusters/${OLD_CLUSTER}\"\n```\n\u63a7\u5236\u6aaf\u4e0d\u652f\u6301\u901a\u904e\u5c0e\u5165\u96c6\u7fa3\u914d\u7f6e\u4f86\u91cd\u65b0\u5275\u5efa\u96c6\u7fa3\u3002", "guide": "Dataproc"}