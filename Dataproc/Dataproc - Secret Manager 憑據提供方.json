{"title": "Dataproc - Secret Manager \u6191\u64da\u63d0\u4f9b\u65b9", "url": "https://cloud.google.com/dataproc/docs/guides/hadoop-google-secret-manager-credential-provider?hl=zh-cn", "abstract": "# Dataproc - Secret Manager \u6191\u64da\u63d0\u4f9b\u65b9\n**\u76ee\u6a19** \uff1a\u77ad\u89e3\u5982\u4f55\u4f7f\u7528 Secret Manager \u4f5c\u7232\u6191\u64da\u5b58\u5132\u5340\uff0c\u5b89\u5168\u5730\u5b58\u5132\u548c\u8a2a\u554f\u7531 Dataproc \u96c6\u7fa3\u4e0a\u904b\u884c\u7684\u61c9\u7528\u8655\u7406\u7684\u654f\u611f\u6578\u64da\u3002\n**\u6ce8\u610f** \uff1a\u6b64\u529f\u80fd\u9069\u7528\u65bc\u4f7f\u7528\u6620\u50cf\u7248\u672c 2.1.41+ \u548c 2.2.6+ \u5275\u5efa\u7684 Dataproc \u96c6\u7fa3\u3002\n", "content": "## \u6982\u89bd\n[Secret Manager](https://cloud.google.com/secret-manager/docs/overview?hl=zh-cn) \u53ef\u4ee5\u4fdd\u8b77\u60a8\u7684\u654f\u611f\u6578\u64da\uff0c\u4f8b\u5982 API \u5bc6\u9470\u3001\u5bc6\u78bc\u548c\u8b49\u66f8\u3002\u53ef\u4ee5\u4f7f\u7528\u5b83\u5728 Google Cloud \u4e2d\u7ba1\u7406\u3001\u8a2a\u554f\u548c\u5be9\u8988 Secret\u3002\n\u8207 Secret Manager \u96c6\u6210\u7684 `GoogleHadoopSecretManagerCredentialProvider` API \u662f [Hadoop CredentialProvider API](https://hadoop.apache.org/docs/stable/hadoop-project-dist/hadoop-common/CredentialProviderAPI.html) \u7684\u5be6\u73fe\uff0cHadoop CredentialProvider API \u662f\u4e00\u7a2e\u7528\u65bc\u4fdd\u8b77\u654f\u611f\u6191\u64da\u4ee5\u9632\u6b62\u516c\u958b\u8a2a\u554f\u7684\u89e3\u6c7a\u65b9\u6848\u3002\n\u60a8\u53ef\u4ee5\u901a\u904e\u4ee5\u4e0b\u65b9\u5f0f\u4f7f\u7528 Hadoop \u6191\u64da\u63d0\u4f9b\u7a0b\u5e8f API\uff1a\n- \u4f7f\u7528 [Hadoop \u6191\u64da\u547d\u4ee4](#hadoop_credential_commands) \u3002\n- [\u914d\u7f6e OSS \u7d44\u4ef6](#configure_oss_components) \uff08\u4f8b\u5982 Hive\uff09\uff0c\u4ee5\u4fbf\u8207 Secret Manager \u642d\u914d\u4f7f\u7528\u3002## \u8853\u8a9e\n\u4e0b\u8868\u4ecb\u7d39\u4e86\u672c\u6587\u6a94\u4e2d\u4f7f\u7528\u7684\u8853\u8a9e\u3002\n| \u671f\u9650  | \u8aaa\u660e                                        |\n|:-----------|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| Secret  | Secret \u662f\u4e00\u500b\u9805\u76ee\u5168\u5c40\u5c0d\u8c61\uff0c\u5176\u4e2d\u5305\u542b\u4e00\u7d44\u5143\u6578\u64da\u548c Secret \u7248\u672c\u3002\u85c9\u52a9 Secret Manager\uff0c\u60a8\u53ef\u4ee5\u5c07\u5bc6\u9470\u4f5c\u7232\u4e8c\u9032\u5236 blob \u6216\u6587\u672c\u5b57\u7b26\u4e32\u9032\u884c\u5b58\u5132\u3001\u7ba1\u7406\u548c\u8a2a\u554f\u3002     |\n| Credential | \u5728 Hadoop \u548c\u5176\u4ed6 Dataproc \u8a17\u7ba1\u7684\u61c9\u7528\u4e2d\uff0c\u6191\u64da\u7531\u6191\u64da\u540d\u7a31 (ID) \u548c\u6191\u64da\u503c\uff08\u5bc6\u78bc\uff09\u7d44\u6210\u3002\u6191\u64da ID \u548c\u503c\u6620\u5c04\u5230 Secret Manager \u4e2d\u7684 Secret ID \u548c Secret \u503c\uff08Secret \u7248\u672c\uff09\u3002 |\n## Hadoop \u6191\u64da\u547d\u4ee4\n\u60a8\u53ef\u4ee5\u4f7f\u7528 `hadoop credential` \u547d\u4ee4\u5275\u5efa\u3001\u5217\u51fa\u548c\u7ba1\u7406 Secret\u3002 `hadoop credential` \u547d\u4ee4\u4f7f\u7528\u4ee5\u4e0b\u901a\u7528\u683c\u5f0f\uff1a `hadoop credential` `` `` `` \u3002\n\u5728\u4ee5\u4e0b\u793a\u4f8b\u4e2d\uff0c\u6dfb\u52a0\u4e86 `-provider` \u6a19\u8a8c\u4f86\u6307\u5b9a\u63d0\u4f9b\u7a0b\u5e8f\u985e\u578b\u548c\u4f4d\u7f6e\uff08\u63d0\u4f9b\u7a0b\u5e8f\u5b58\u5132\u5340\uff09\u3002 `gsm://` \u67b6\u69cb\u6307\u5b9a Secret Manager\u3002\n- \u4f7f\u7528\u6307\u5b9a\u7684 Secret ID \u5275\u5efa Secret\u3002\u5982\u679c\u6307\u5b9a\u7684 Secret ID \u5b58\u5728\uff0c\u5247\u8a72\u547d\u4ee4\u4e0d\u6703\u5275\u5efa Secret\u3002\u6b64\u884c\u7232\u8207 Hadoop `CredentialProvider` API \u4e00\u81f4\u3002```\nhadoop credential create secret-id -provider gsm://projects/PROJECT_ID -v VALUE\n```\n- \u5217\u51fa\u5b58\u5132\u5728\u9805\u76ee\u4e2d\u7684 Secret\u3002```\nhadoop credential list -provider gsm://projects/PROJECT_ID\n```\n- \u6aa2\u67e5\u9805\u76ee\u4e2d\u662f\u5426\u5b58\u5728\u5177\u6709\u6307\u5b9a\u503c\u7684 Secret\u3002```\nhadoop credential check SECRET_ID -provider gsm://projects/PROJECT_ID -v VALUE\n```\n- \u6aa2\u67e5\u914d\u7f6e\u6587\u4ef6\u4e2d\u662f\u5426\u6709\u7279\u5b9a Secret \u7248\u672c\u3002```\nhadoop credential conf CONFIG_FILE check SECRET_ID -provider gsm://projects/project-id -v VALUE\n```\n- \uff1a\u8a2d\u7f6e `hadoop.security.credstore.google-secret-manager.secret-version` \u7684 XML \u6587\u4ef6\u3002\n- \u522a\u9664\u9805\u76ee\u4e2d\u67d0\u500b\u5bc6\u9470\u7684\u6240\u6709\u7248\u672c\u3002```\nhadoop credential delete SECRET_ID -provider gsm://projects/ PROJECT_ID\n```\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [Hadoop \u547d\u4ee4\u6307\u5357](https://hadoop.apache.org/docs/stable/hadoop-project-dist/hadoop-common/CommandsManual.html#credential) \u3002\n## \u914d\u7f6e OSS \u7d44\u4ef6\n\u60a8\u53ef\u4ee5\u901a\u904e\u8a2d\u7f6e\u4ee5\u4e0b\u7d44\u4ef6\u5c6c\u6027\uff0c\u5c07 [Hadoop \u548c\u5176\u4ed6\u53d7\u652f\u6301\u7684\u5176\u4ed6 OSS \u7d44\u4ef6](https://hadoop.apache.org/docs/stable/hadoop-project-dist/hadoop-common/CredentialProviderAPI.html#Usage_Overview) \u914d\u7f6e\u7232\u8207 Secret Manager \u642d\u914d\u4f7f\u7528\uff1a\n- **\u63d0\u4f9b\u7a0b\u5e8f\u8def\u5f91** \uff08\u5fc5\u9700\uff09\uff1a\u63d0\u4f9b\u7a0b\u5e8f\u8def\u5f91\u5c6c\u6027 `hadoop.security.credential.provider.path` \u662f\u4e00\u500b\u9017\u865f\u5206\u9694\u5217\u8868\uff0c\u5176\u4e2d\u5305\u542b\u7232\u89e3\u6790\u6191\u64da\u800c\u904d\u6b77\u7684\u4e00\u500b\u6216\u591a\u500b\u6191\u64da\u63d0\u4f9b\u7a0b\u5e8f URI\u3002```\n--properties=hadoop.security.credential.provider.path=gsm://projects/project-id\n```- `scheme`\u7528\u65bc\u6307\u793a\u6191\u64da\u63d0\u4f9b\u7a0b\u5e8f\u7684\u985e\u578b\u3002Hadoop \u65b9\u6848\u5305\u62ec`jceks://`\u3001`user://`\u548c`localjceks://`\u3002\u5982\u4e0a\u4f8b\u6240\u793a\uff0c\u4f7f\u7528`gsm://`\u65b9\u6848\u5728 Secret Manager \u4e2d\u641c\u7d22\u6191\u64da\u3002\n- **\u66ff\u63db\u9ede\u904b\u7b97\u7b26** \uff08\u53ef\u9078\uff09\uff1aSecret Manager \u4e0d\u652f\u6301\u5728 Secret \u540d\u7a31\u4e2d\u4f7f\u7528\u9ede ( `.` ) \u904b\u7b97\u7b26\uff0c\u4f46 OSS \u7d44\u4ef6\u6191\u64da\u5bc6\u9470\u53ef\u4ee5\u5305\u542b\u6b64\u904b\u7b97\u7b26\u3002\u7576\u6b64\u5c6c\u6027\u8a2d\u7232 `true` \u6642\u3002 \u60a8\u53ef\u4ee5\u5c07\u6191\u64da\u540d\u7a31\u4e2d\u7684\u9ede( `.` ) \u66ff\u63db\u7232\u9023\u5b57\u7b26( `-` )\u3002\u4f8b\u5982\uff0c\u5982\u679c\u6b64\u5c6c\u6027\u8a2d\u7f6e\u7232 `true` \uff0c\u60a8\u53ef\u4ee5\u5728\u5c07\u6191\u64da\u540d\u7a31 `a.b.c` \u50b3\u905e\u7d66 Secret Manager \u6642\u5c07\u5176\u6307\u5b9a\u7232 `a-b-c` \u3002\u53ea\u6709\u5728\u4f7f\u7528 [Hadoop \u6191\u64da\u547d\u4ee4](#hadoop_credential_commands) \u6307\u5b9a\u6191\u64da\u6642\uff0c\u6216\u5728 OSS \u7d44\u4ef6\u5617\u8a66\u89e3\u6790\u6191\u64da\u6642\u6307\u5b9a\u6191\u64da\uff0c\u624d\u9700\u8981\u6b64\u5c6c\u6027\u3002\u5b83\u5c0d\u5275\u5efa\u3001\u5217\u51fa\u6216\u522a\u9664 Hadoop \u6191\u64da\u547d\u4ee4\u6c92\u6709\u5f71\u97ff\u3002```\n--properties=hadoop.security.credstore.google-secret-manager.secret-id.substitute-dot-operator=true\n```\n- **Secret \u7248\u672c** \uff08\u53ef\u9078\uff09\uff1aSecret Manager \u4e2d\u7684 Secret \u53ef\u4ee5\u6709\u591a\u500b\u7248\u672c\uff08\u503c\uff09\u3002\u4f7f\u7528\u6b64\u5c6c\u6027\u8a2a\u554f Secret \u7248\u672c\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cSecret Manager \u6703\u8a2a\u554f `LATEST` \u7248\u672c\uff0c\u8a72\u7248\u672c\u6703\u5728\u904b\u884c\u6642\u89e3\u6790\u7232 Secret \u7684\u6700\u65b0\u503c\u3002\u6700\u4f73\u505a\u6cd5\u662f\u5b9a\u7fa9\u6b64\u5c6c\u6027\uff0c\u4ee5\u4fbf\u5728\u751f\u7522\u74b0\u5883\u4e2d\u5be6\u73fe\u7a69\u5b9a\u7684\u8a2a\u554f\u6b0a\u9650\u3002```\n--properties=hadoop.security.credstore.google-secret-manager.secret-version=1\n```## Hive Metastore \u793a\u4f8b\nHive Metastore \u5c6c\u6027 `javax.jdo.option.ConnectionPassword` \u5305\u542b\u7528\u65bc\u9a57\u8b49\u5c0d Metastore \u6578\u64da\u5eab\u7684\u8a2a\u554f\u6b0a\u9650\u7684\u5bc6\u78bc\u3002\u6b64\u5bc6\u78bc\u4ee5\u7d14\u6587\u672c\u683c\u5f0f\u4fdd\u5b58\u5728 `hive-site.xml` \u4e2d\uff0c\u5b58\u5728\u5b89\u5168\u98a8\u96aa\u3002\u751f\u7522\u74b0\u5883\u4e2d\u7684\u6700\u4f73\u5be6\u8e10\u662f\u5c07\u5bc6\u78bc\u5b58\u5132\u5728 Secret Manager \u4e2d\uff0c\u7136\u5f8c\u66f4\u65b0 `hive-site.xml` \u914d\u7f6e\u6587\u4ef6\u4ee5\u5141\u8a31 Hive Metastore \u670d\u52d9\u5f9e Secret Manager \u8b80\u53d6\u5bc6\u78bc\u3002\n\u4ee5\u4e0b\u90e8\u5206\u4ecb\u7d39\u77ad\u5982\u4f55\u5728\u4e0d\u540c Hive Metastore \u5834\u666f\u4e2d\u4f7f\u7528 Secret Manager\u3002\n### \u5177\u6709\u672c\u5730 Metastore \u7684 Hive \u96c6\u7fa3\n- \u5728\u672c\u5730\u6216 [Cloud Shell](https://cloud.google.com/shell?hl=zh-cn) \u4e2d\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u4ee5\u4f7f\u7528\u6240\u9700\u7684 [\u96c6\u7fa3\u5c6c\u6027](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/cluster-properties?hl=zh-cn)  [\u5275\u5efa Dataproc \u96c6\u7fa3](https://cloud.google.com/dataproc/docs/guides/create-cluster?hl=zh-cn) \u3002```\ngcloud dataproc clusters create CLUSTER_NAME \\\n\u00a0\u00a0\u00a0\u00a0--region=REGION \\\n\u00a0\u00a0\u00a0\u00a0...other flags as needed... \\\n\u00a0\u00a0\u00a0\u00a0--properties=\"hive:hadoop.security.credential.provider.path=gsm://projects/PROJECT_ID,hive:hadoop.security.credstore.google-secret-manager.secret-id.substitute-dot-operator=true\"\n```\n- \u5275\u5efa Secret\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528 Secret Manager \u6216 `hadoop credential` \u547d\u4ee4\u5275\u5efa Secret\u3002\u5728 [\u4f7f\u7528 SSH](https://cloud.google.com/dataproc/docs/concepts/accessing/ssh?hl=zh-cn) \u9023\u63a5\u5230\u8a72\u7bc0\u9ede\u4e0a\u4e26\u6253\u958b\u4e00\u500b\u7d42\u7aef\u7a97\u53e3\u5f8c\uff0c\u5f9e Dataproc \u4e3b\u7bc0\u9ede\u547d\u4ee4\u884c\u904b\u884c`hadoop credential`\u548c\u4ee5\u4e0b\u793a\u4f8b\u4e2d\u5217\u51fa\u7684\u5176\u4ed6\u547d\u4ee4\u3002- **\u66ff\u4ee3\u65b9\u6848 1** \uff1a [\u4f7f\u7528 Secret Manager \u5275\u5efa Secret](//secret-manager/docs/create-secret-quickstart) - Secret \u540d\u7a31\uff1a`/projects/` `` `/secrets/javax-jdo-option-ConnectionPassword/versions/1`\n- Secret \u503c\uff1a`METASTORE_PASSWORD`\u3002\n- **\u66ff\u4ee3\u65b9\u6848 2** \uff1a\u4f7f\u7528 `hadoop credential` \u547d\u4ee4\u5275\u5efa Secret\u3002```\nsudo hadoop credential create javax-jdo-option-ConnectionPassword -provider gsm://projects/PROJECT_ID -v METASTORE_PASSWORD\n```- \uff1a\u7531\u65bc Secret Manager \u4e0d\u652f\u6301\u9ede(`.`) \u904b\u7b97\u7b26\uff0c\u56e0\u6b64\u8acb\u5c07\u5bc6\u78bc\u4e2d\u7684\u4efb\u4f55\u9ede(`.`) \u66ff\u63db\u7232\u9023\u5b57\u7b26(`-`)\u3002\n- \u9a57\u8b49\u8a72 Secret \u662f\u5426\u5b58\u5728\u3002```\nsudo hadoop credential list -provider gsm://projects/PROJECT_ID\n```\n- \u5f9e `hive-site.xml` \u6587\u4ef6\u4e2d\u79fb\u9664 `javax.jdo.option.ConnectionPassword` \u3002 \u4ee5\u4e0b\u547d\u4ee4\u6703\u5728 `vim` \u4e2d\u6253\u958b\u8a72\u6587\u4ef6\u4e26\u9032\u884c\u4fee\u6539\u3002```\nsudo vim /etc/hive/conf/hive-site.xml\n```\n- \u91cd\u5553 Hive Metastore\u3002```\nsudo systemctl restart hive-metastore\n```\n### \u5177\u6709\u5916\u90e8 Metastore \u7684 Hive \u96c6\u7fa3\n- \u5728\u672c\u5730\u6216 [Cloud Shell](https://cloud.google.com/shell?hl=zh-cn) \u4e2d\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u4ee5\u4f7f\u7528\u4ee5\u4e0b [\u96c6\u7fa3\u5c6c\u6027](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/cluster-properties?hl=zh-cn)  [\u5275\u5efa Dataproc \u96c6\u7fa3](https://cloud.google.com/dataproc/docs/guides/create-cluster?hl=zh-cn) \u3002```\ngcloud dataproc clusters create CLUSTER_NAME \\\n\u00a0\u00a0\u00a0\u00a0--region=REGION \\\n\u00a0\u00a0\u00a0\u00a0...other flags as needed... \\\n\u00a0\u00a0\u00a0\u00a0--properties=core:fs.defaultFS=gs://METASTORE_CLUSTER_PROXY_BUCKET,dataproc:dataproc.components.deactivate=\"hdfs hive-server2 hive-metastore\"\n```\n- \u5275\u5efa Secret\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528 Secret Manager \u6216 `hadoop credential` \u547d\u4ee4\u5275\u5efa Secret\u3002\u5728 [\u4f7f\u7528 SSH](https://cloud.google.com/dataproc/docs/concepts/accessing/ssh?hl=zh-cn) \u9023\u63a5\u5230\u8a72\u7bc0\u9ede\u4e0a\u4e26\u6253\u958b\u4e00\u500b\u7d42\u7aef\u7a97\u53e3\u5f8c\uff0c\u5f9e Dataproc \u4e3b\u7bc0\u9ede\u547d\u4ee4\u884c\u904b\u884c`hadoop credential`\u548c\u4ee5\u4e0b\u793a\u4f8b\u4e2d\u5217\u51fa\u7684\u5176\u4ed6\u547d\u4ee4\u3002- **\u66ff\u4ee3\u65b9\u6848 1** \uff1a [\u4f7f\u7528 Secret Manager \u5275\u5efa Secret](https://cloud.google.com/secret-manager/docs/create-secret-quickstart?hl=zh-cn) \uff1a- Secret \u540d\u7a31\uff1a`/projects/` `` `/secrets/javax-jdo-option-ConnectionPassword/versions/1`\n- Secret \u503c\uff1a`METASTORE_PASSWORD`\u3002\n- **\u66ff\u4ee3\u65b9\u6848 2** \uff1a\u4f7f\u7528`hadoop credential`\u547d\u4ee4\u5275\u5efa Secret\u3002```\nsudo hadoop credential create javax-jdo-option-ConnectionPassword -provider gsm://projects/PROJECT_ID -v METASTORE_PASSWORD\n```- \uff1a\u7531\u65bc Secret Manager \u4e0d\u652f\u6301\u9ede(`.`) \u904b\u7b97\u7b26\uff0c\u8acb\u5c07\u5bc6\u78bc\u4e2d\u7684\u9ede(`.`) \u66ff\u63db\u7232\u9023\u5b57\u7b26(`-`)\u3002\n- \u9a57\u8b49\u8a72 Secret \u662f\u5426\u5b58\u5728\u3002```\nsudo hadoop credential list -provider gsm://projects/PROJECT_ID\n \n```\n- \u5728\u672c\u5730\u6216 Cloud Shell \u4e2d\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u4ee5 [\u5275\u5efa\u5177\u6709\u5982\u4e0b](https://cloud.google.com/dataproc/docs/guides/create-cluster?hl=zh-cn)  [\u96c6\u7fa3\u5c6c\u6027](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/cluster-properties?hl=zh-cn) \u7684 Dataproc \u96c6\u7fa3\u3002\u4f7f\u7528\u6b64\u96c6\u7fa3\u904b\u884c Hive \u4f5c\u696d\u4e26\u9023\u63a5\u5230\u5916\u90e8 Metastore\u3002```\ngcloud dataproc clusters create CLUSTER_NAME \\\n\u00a0\u00a0\u00a0\u00a0--region=REGION \\\n\u00a0\u00a0\u00a0\u00a0...other flags as needed...\n\u00a0\u00a0\u00a0\u00a0--properties=\"hive:javax.jdo.option.ConnectionURL=jdbc:mysql://metastore-cluster-name-m/metastore,hive:hadoop.security.credential.provider.path=gsm://projects/project-id,hive:hadoop.security.credstore.google-secret-manager.secret-id.substitute-dot-operator=true\"\n```## \u5982\u9700\u6df1\u5165\u77ad\u89e3\n- \u700f\u89bd [Hive \u6587\u6a94](https://cwiki.apache.org/confluence/display/Hive/AdminManual+Configuration#AdminManualConfiguration-RemovingHiveMetastorePasswordfromHiveConfiguration) \u3002", "guide": "Dataproc"}