{"title": "Dataproc - Dataproc \u53ef\u9078 Ranger \u7d44\u4ef6", "url": "https://cloud.google.com/dataproc/docs/concepts/components/ranger?hl=zh-cn", "abstract": "# Dataproc - Dataproc \u53ef\u9078 Ranger \u7d44\u4ef6\n\u4f7f\u7528 [\u53ef\u9078\u7d44\u4ef6](https://cloud.google.com/dataproc/docs/concepts/components/overview?hl=zh-cn#available_optional_components) \u529f\u80fd\u5275\u5efa Dataproc \u96c6\u7fa3\u6642\uff0c\u60a8\u53ef\u4ee5\u5b89\u88dd\u5176\u4ed6\u7d44\u4ef6\uff0c\u4f8b\u5982 Ranger\u3002\u672c\u9801\u9762\u4ecb\u7d39\u4e86 Ranger \u7d44\u4ef6\u3002\n[Apache Ranger](https://ranger.apache.org/) \u7d44\u4ef6\u662f\u4e00\u500b\u958b\u6e90\u6846\u67b6\uff0c\u7528\u65bc\u7ba1\u7406 Hadoop \u751f\u614b\u7cfb\u7d71\u7684\u6b0a\u9650\u548c\u5be9\u8988\u3002Ranger \u7ba1\u7406\u54e1\u670d\u52d9\u5668\u548c\u7db2\u9801\u754c\u9762\u53ef\u7528\u65bc\u96c6\u7fa3\u7b2c\u4e00\u500b\u4e3b\u7bc0\u9ede\u4e0a\u7684\u7aef\u53e3 `6080` \u4e0a\u3002\n**\u53e6\u8acb\u53c3\u95b1** \uff1a\n- [\u5c07 Ranger \u8207 Kerberos \u642d\u914d\u4f7f\u7528](https://cloud.google.com/dataproc/docs/concepts/components/ranger-w-kerberos?hl=zh-cn) \n- [\u5099\u4efd\u548c\u6062\u5fa9 Ranger \u67b6\u69cb](https://cloud.google.com/dataproc/docs/concepts/components/backup-ranger-schema?hl=zh-cn) \n- [\u5728 Dataproc \u4e0a\u4f7f\u7528 Apache Ranger \u7684\u6700\u4f73\u5be6\u8e10](https://cloud.google.com/blog/products/data-analytics/running-cloud-managed-spark-and-hadoop-using-ranger?hl=zh-cn) ", "content": "## \u5b89\u88dd\u7d44\u4ef6\n\u6ce8\u610f\uff1a\u5728\u904b\u884c\u6b64\u9801\u9762\u4e0a\u7684 gcloud CLI \u547d\u4ee4\u4e4b\u524d\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u4efb\u4e00\u64cd\u4f5c\uff1a- [\u8a2d\u7f6e gcloud CLI \u9805\u76ee ID](https://cloud.google.com/sdk/gcloud/reference/config/set?hl=zh-cn#EXAMPLES) \u6216\n- \u5c07 [--project PROJECT_ID](https://cloud.google.com/sdk/gcloud/reference?hl=zh-cn#--project) \u6a19\u8a8c\u6dfb\u52a0\u5230\u6bcf\u500b gcloud \u547d\u4ee4\n\u5728\u5275\u5efa Dataproc \u96c6\u7fa3\u6642\u5b89\u88dd\u7d44\u4ef6\u3002 \u7d44\u4ef6\u53ef\u6dfb\u52a0\u5230\u4f7f\u7528 Dataproc [\u7248\u672c 1.3](https://cloud.google.com/dataproc/docs/concepts/versioning/dataproc-release-1.3?hl=zh-cn) \u53ca\u66f4\u9ad8\u7248\u672c\u5275\u5efa\u7684 \u96c6\u7fa3\u4e2d\u3002Ranger \u7d44\u4ef6\u9700\u8981\u5b89\u88dd [Solr](https://cloud.google.com/dataproc/docs/concepts/components/solr?hl=zh-cn) \u7d44\u4ef6\uff0c\u5982\u4e0b\u6240\u793a\uff1a\n\u5982\u9700\u67e5\u770b\u6bcf\u500b Dataproc \u6620\u50cf\u7248\u672c\u4e2d\u5305\u542b\u7684\u7d44\u4ef6\u7248\u672c\uff0c\u8acb\u53c3\u95b1 [\u652f\u6301\u7684 Dataproc \u7248\u672c](https://cloud.google.com/dataproc/docs/concepts/versioning/dataproc-versions?hl=zh-cn#supported_cloud_dataproc_versions) \u3002\n### \u5b89\u88dd\u6b65\u9a5f\n[](None)\n- \u8a2d\u7f6e\u60a8\u7684 Ranger \u7ba1\u7406\u54e1\u5bc6\u78bc\uff1a- \u5c07 [Cloud KMS CryptoKey Encrypter/Decrypter \u89d2\u8272](https://cloud.google.com/kms/docs/reference/permissions-and-roles?hl=zh-cn#predefined_roles) \u6388\u4e88\u96c6\u7fa3 [\u670d\u52d9\u8cec\u865f](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/service-accounts?hl=zh-cn#service_accounts_in_cloud_dataproc) \uff1a\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u96c6\u7fa3\u670d\u52d9\u8cec\u865f\u6703\u8a2d\u7f6e\u7232 [Compute Engine \u9ed8\u8a8d\u670d\u52d9\u8cec\u865f](https://cloud.google.com/compute/docs/access/service-accounts?hl=zh-cn#default_service_account) \uff0c\u8a72\u8cec\u865f\u7684\u683c\u5f0f\u5982\u4e0b\uff1a```\nproject-number-compute@developer.gserviceaccount.com\n```\u60a8\u53ef\u4ee5\u5728\u5275\u5efa\u96c6\u7fa3\u6642 [\u6307\u5b9a\u5176\u4ed6\u96c6\u7fa3\u670d\u52d9\u8cec\u865f](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/service-accounts?hl=zh-cn#using_service_accounts) \uff0c\u898b\u4e0b\u6587\u3002- **\u793a\u4f8b** \uff1a\u5c07 Cloud KMS CryptoKey Encrypter/Decrypter \u89d2\u8272\u6388\u4e88 Compute Engine \u9ed8\u8a8d\u670d\u52d9\u8cec\u865f\uff1a```\ngcloud projects add-iam-policy-binding project-id \\\n\u00a0\u00a0\u00a0\u00a0--member=serviceAccount:project-number-compute@developer.gserviceaccount.com \\\n\u00a0\u00a0\u00a0\u00a0--role=roles/cloudkms.cryptoKeyDecrypter\n```\n- \u4f7f\u7528 [\u5bc6\u9470\u7ba1\u7406\u670d\u52d9 (KMS) ](https://cloud.google.com/kms/docs/encrypt-decrypt?hl=zh-cn) \u5bc6\u9470\u52a0\u5bc6 Ranger \u7ba1\u7406\u54e1\u7528\u6236\u7684\u5bc6\u78bc\u3002 **\u60a8\u7684\u5bc6\u78bc\u5fc5\u9808\u81f3\u5c11\u5305\u542b 8 \u500b\u5b57\u7b26\uff0c\u4e14\u81f3\u5c11\u5305\u542b\u4e00\u500b\u5b57\u6bcd\u548c\u4e00\u500b\u6578\u5b57\u5b57\u7b26\u3002** - **\u793a\u4f8b** \uff1a- \u5275\u5efa\u5bc6\u9470\u74b0\uff1a```\ngcloud kms keyrings create my-keyring --location=global\n```\n- \u5275\u5efa\u5bc6\u9470\uff1a```\ngcloud kms keys create my-key \\\n\u00a0\u00a0\u00a0\u00a0--location=global \\\n\u00a0\u00a0\u00a0\u00a0--keyring=my-keyring \\\n\u00a0\u00a0\u00a0\u00a0--purpose=encryption\n```\n- \u52a0\u5bc6\u60a8\u7684 Ranger \u7ba1\u7406\u54e1\u7528\u6236\u5bc6\u78bc\uff1a```\necho \"my-ranger-admin-password\" | \\\n\u00a0\u00a0gcloud kms encrypt \\\n\u00a0\u00a0\u00a0\u00a0--location=global \\\n\u00a0\u00a0\u00a0\u00a0--keyring=my-keyring \\\n\u00a0\u00a0\u00a0\u00a0--key=my-key \\\n\u00a0\u00a0\u00a0\u00a0--plaintext-file=- \\\n\u00a0\u00a0\u00a0\u00a0--ciphertext-file=admin-password.encrypted\n```\n- \u5c07\u52a0\u5bc6\u5bc6\u78bc\u4e0a\u50b3\u5230\u9805\u76ee\u4e2d\u7684 [Cloud Storage \u5b58\u5132\u6876](https://cloud.google.com/storage/docs/creating-buckets?hl=zh-cn) \u3002- **\u793a\u4f8b** \uff1a```\ngsutil cp admin-password.encrypted gs://my-bucket\n```\n- \u5275\u5efa\u60a8\u7684\u96c6\u7fa3\uff1a- \u5b89\u88dd Ranger \u7d44\u4ef6\u6642\uff0c\u9084\u5fc5\u9808\u5b89\u88dd [Solr \u7d44\u4ef6](https://cloud.google.com/dataproc/docs/concepts/components/solr?hl=zh-cn) \uff0c\u5982\u4e0b\u6240\u793a\u3002- Ranger \u7d44\u4ef6\u4f9d\u8cf4 Solr \u7d44\u4ef6\u4f86\u5b58\u5132\u548c\u67e5\u8a62\u5176\u5be9\u8988\u65e5\u8a8c\uff0c\u8a72\u65e5\u8a8c\u9ed8\u8a8d\u4f7f\u7528 HDFS \u4f5c\u7232\u5b58\u5132\u3002\u5728\u522a\u9664\u96c6\u7fa3\u6642\uff0cHDFS \u6578\u64da\u4e5f\u6703\u88ab\u522a\u9664\u3002\u8981\u5728 Cloud Storage \u4e0a\u914d\u7f6e Solr \u7d44\u4ef6\u4ee5\u5b58\u5132\u6578\u64da\uff08\u5305\u62ec Ranger \u5be9\u8988\u65e5\u8a8c\uff09\uff0c\u8acb\u5728\u5275\u5efa\u96c6\u7fa3\u6642\u4f7f\u7528`dataproc:solr.gcs.path=gs://<bucket>` [\u96c6\u7fa3\u5c6c\u6027](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/cluster-properties?hl=zh-cn#service_properties) \u3002\u522a\u9664\u96c6\u7fa3\u540e\uff0cCloud Storage \u6578\u64da\u4ecd\u7136\u5b58\u5728\u3002\n- \u901a\u904e\u8a2d\u7f6e`dataproc:ranger.kms.key.uri`\u548c`dataproc:ranger.admin.password.uri` [\u96c6\u7fa3\u5c6c\u6027](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/cluster-properties?hl=zh-cn#dataproc-properties) \u5c07 KMS \u5bc6\u9470\u548c\u5bc6\u78bc Cloud Storage URI \u50b3\u905e\u7d66\u96c6\u7fa3\u5275\u5efa\u547d\u4ee4\u3002\n- \u6216\u8005\uff0c\u60a8\u53ef\u901a\u904e\u8a2d\u7f6e`dataproc:ranger.db.admin.password.uri` [\u96c6\u7fa3\u5c6c\u6027](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/cluster-properties?hl=zh-cn#dataproc-properties) \uff0c\u901a\u904e\u52a0\u5bc6\u7684 Cloud Storage \u6587\u4ef6 URI \u50b3\u905e Ranger \u6578\u64da\u5eab\u7684\u7ba1\u7406\u54e1\u7528\u6236\u5bc6\u78bc\u3002\n- \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cRanger \u7d44\u4ef6\u4f7f\u7528\u5728\u96c6\u7fa3\u7b2c\u4e00\u500b\u4e3b\u7bc0\u9ede\u4e0a\u904b\u884c\u7684 MySql \u6578\u64da\u5eab\u5be6\u4f8b\u3002\u5728 MySQL \u5be6\u4f8b\u4e2d\uff0c\u901a\u904e\u5c07\u8b8a\u91cf\u8a2d\u7f6e\u7232`ON`\u4f86\u5553\u7528`log_bin_trust_function_creators`\u6a19\u8a8c\u3002\u8a2d\u7f6e\u6b64\u6a19\u8a8c\u53ef\u4ee5\u63a7\u5236\u662f\u5426\u53ef\u4ee5\u4fe1\u4efb\u5b58\u5132\u7684\u51fd\u6578\u5275\u5efa\u8005\u3002\u6210\u529f\u5275\u5efa\u96c6\u7fa3\u548c Ranger \u914d\u7f6e\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5c07`log_bin_trust_function_creators`\u91cd\u7f6e\u7232`OFF`\u3002\n- \u5982\u60f3\u5728\u522a\u9664\u96c6\u7fa3\u540e\u4fdd\u7559 Ranger \u6578\u64da\u5eab\uff0c\u8acb\u4f7f\u7528 [Cloud SQL](https://cloud.google.com/sql/docs/mysql?hl=zh-cn) \u5be6\u4f8b\u4f5c\u7232\u5916\u90e8 MySql \u6578\u64da\u5eab\u3002- \u5c07`dataproc:ranger.cloud-sql.instance.connection.name` [\u96c6\u7fa3\u5c6c\u6027](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/cluster-properties?hl=zh-cn#dataproc-properties) \u8a2d\u7f6e\u7232 Cloud SQL \u5be6\u4f8b\u3002\n- \u5c07`dataproc:ranger.cloud-sql.root.password.uri` [\u96c6\u7fa3\u5c6c\u6027](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/cluster-properties?hl=zh-cn#dataproc-properties) \u8a2d\u7f6e\u7232 Cloud SQL \u5be6\u4f8b\u7684 KMS \u5bc6\u9470\u52a0\u5bc6\u6839\u5bc6\u78bc\u7684 Cloud Storage URI\u3002\n- \u8a2d\u7f6e`dataproc:ranger.cloud-sql.use-private-ip` [\u96c6\u7fa3\u5c6c\u6027](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/cluster-properties?hl=zh-cn#dataproc-properties) \u4ee5\u6307\u793a\u662f\u5426\u901a\u904e\u5c08\u7528 IP \u8207 Cloud SQL \u5be6\u4f8b\u9023\u63a5\u3002\nRanger \u7d44\u4ef6\u4f7f\u7528 [Cloud SQL \u4ee3\u7406](https://cloud.google.com/sql/docs/mysql/sql-proxy?hl=zh-cn) \u9023\u63a5\u5230 Cloud SQL \u5be6\u4f8b\u3002\u5982\u9700\u4f7f\u7528\u4ee3\u7406\uff1a- \u5728\u5275\u5efa\u96c6\u7fa3\u6642\u8a2d\u7f6e`sqlservice.admin`API \u7bc4\u570d\uff08\u8acb\u53c3\u95b1 [\u4f7f\u7528 OAuth 2.0 \u7232\u8acb\u6c42\u6388\u6b0a](https://cloud.google.com/sql/docs/mysql/admin-api?hl=zh-cn#OAuth2Authorizing) \uff09\u3002\u5982\u679c\u4f7f\u7528\u7684\u662f`gcloud dataproc cluster create`\u547d\u4ee4\uff0c\u8acb\u6dfb\u52a0`--scopes=default,sql-admin`\u53c3\u6578\u3002\n- \u5728\u60a8\u7684\u9805\u76ee\u4e2d\u5553\u7528 [SQL Admin API](https://console.cloud.google.com/flows/enableapi?apiid=sqladmin.googleapis.com&hl=zh-cn) \u3002\n- \u78ba\u4fdd\u96c6\u7fa3\u670d\u52d9\u8cec\u865f\u5177\u6709 [Cloud SQL Editor](https://cloud.google.com/sql/docs/mysql/project-access-control?hl=zh-cn#roles) \u89d2\u8272\u3002\n\u5982\u9700\u5275\u5efa\u5305\u542b Ranger \u7d44\u4ef6\u7684 Dataproc \u96c6\u7fa3\uff0c\u8acb\u4f7f\u7528\u5e36\u6709 `--optional-components` \u6a19\u8a8c\u7684 [gcloud dataproc clusters create](https://cloud.google.com/sdk/gcloud/reference/dataproc/clusters/create?hl=zh-cn)  \u547d\u4ee4\u3002\n\u5275\u5efa\u96c6\u7fa3\u6642\uff0c\u8acb\u4f7f\u7528\u5e36\u6709`--enable-component-gateway`\u6a19\u8a8c\u7684 [gcloud dataproc clusters create](https://cloud.google.com/sdk/gcloud/reference/dataproc/clusters/create?hl=zh-cn) \u547d\u4ee4\uff08\u5982\u4e0b\u6240\u793a\uff09\uff0c\u4ee5\u4fbf\u4f7f\u7528 [\u7d44\u4ef6\u7db2\u95dc](https://cloud.google.com/dataproc/docs/concepts/accessing/dataproc-gateways?hl=zh-cn) \u9023\u63a5\u5230 Ranger \u7ba1\u7406\u54e1\u7db2\u9801\u754c\u9762\u3002\n```\ngcloud dataproc clusters create cluster-name \\\n\u00a0\u00a0\u00a0\u00a0--optional-components=SOLR,RANGER \\\n\u00a0\u00a0\u00a0\u00a0--region=region \\\n\u00a0\u00a0\u00a0\u00a0--enable-component-gateway \\\n\u00a0\u00a0\u00a0\u00a0--properties=\"dataproc:ranger.kms.key.uri=projects/project-id/locations/global/keyRings/my-keyring/cryptoKeys/my-key,dataproc:ranger.admin.password.uri=gs://my-bucket/admin-password.encrypted\" \\\n\u00a0\u00a0\u00a0\u00a0... other flags\n```\u5728 [SoftwareConfig.Component](https://cloud.google.com/dataproc/docs/reference/rest/v1/ClusterConfig?hl=zh-cn#Component) \u5b57\u6bb5\u4e2d\u6307\u5b9a Ranger \u548c Solr \u7d44\u4ef6\uff0c\u4f5c\u7232 Dataproc API [clusters.create](https://cloud.google.com/dataproc/docs/reference/rest/v1/projects.regions.clusters/create?hl=zh-cn) \u8acb\u6c42\u7684\u4e00\u90e8\u5206\u3002\u60a8\u9084\u5fc5\u9808\u5728 [SoftwareConfig.Component.properties](https://cloud.google.com/static/dataproc/docs/reference/rest/v1/ClusterConfig?hl=zh-cn#SoftwareConfig.FIELDS.properties) \u5b57\u6bb5\u4e2d\u8a2d\u7f6e\u4ee5\u4e0b [\u96c6\u7fa3\u5c6c\u6027](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/cluster-properties?hl=zh-cn#service_properties) \uff1a\n- `dataproc:ranger.kms.key.uri`: \"projects//locations/global/keyRings//cryptoKeys/\"\n- `dataproc:ranger.admin.password.uri`: \"gs:///admin-password.encrypted\"\n\u4f7f\u7528 [Dataproc v1 API](https://cloud.google.com/dataproc/docs/reference/rest?hl=zh-cn#rest-resource:-v1.projects.regions.clusters) \uff0c\u5728 clusters.create \u8acb\u6c42\u4e2d\u5c07 [EndpointConfig.enableHttpPortAccess](https://cloud.google.com/dataproc/docs/reference/rest/v1/ClusterConfig?hl=zh-cn#EndpointConfig) \u5c6c\u6027\u8a2d\u7f6e\u7232`true`\uff0c\u5f9e\u800c\u5141\u8a31\u4f7f\u7528 [\u7d44\u4ef6\u7db2\u95dc](https://cloud.google.com/dataproc/docs/concepts/accessing/dataproc-gateways?hl=zh-cn) \u9023\u63a5\u5230 Jupyter \u7b46\u8a18\u672c\u7db2\u9801\u754c\u9762\u3002\n- \u5553\u7528\u7d44\u4ef6\u548c\u7d44\u4ef6\u7db2\u95dc\u3002- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u6253\u958b Dataproc [\u5275\u5efa\u96c6\u7fa3](https://console.cloud.google.com/dataproc/clustersAdd?hl=zh-cn) \u9801\u9762\u3002\u9078\u4e2d\u201c\u8a2d\u7f6e\u96c6\u7fa3\u201d\u9762\u677f\u3002\n- \u5728\u7d44\u4ef6\u90e8\u5206\u4e2d\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u5728\u201c\u53ef\u9078\u7d44\u4ef6\u201d\u4e0b\uff0c\u9078\u64c7\u201cRanger\u201d\u3001\u201cSolr\u201d\u4ee5\u53ca\u5176\u4ed6\u4e00\u4e9b\u8981\u5728\u96c6\u7fa3\u4e0a\u5b89\u88dd\u7684\u53ef\u9078\u7d44\u4ef6\u3002\n- \u5728\u201c\u7d44\u4ef6\u7db2\u95dc\u201d\u4e0b\uff0c\u9078\u64c7\u201c\u5553\u7528\u7d44\u4ef6\u7db2\u95dc\u201d\uff08\u8acb\u53c3\u95b1 [\u67e5\u770b\u548c\u8a2a\u554f\u7d44\u4ef6\u7db2\u95dc\u7db2\u5740](https://cloud.google.com/dataproc/docs/concepts/accessing/dataproc-gateways?hl=zh-cn#viewing_and_accessing_component_gateway_urls) \uff09\u3002\u9ede\u64ca \u6a19\u7c64\u9801\u3002\u5728 \u4e0b\uff0c\u9ede\u64ca **Ranger** \u4ee5\u6253\u958b Ranger \u7db2\u9801\u754c\u9762\u3002\u4f7f\u7528 Ranger \u7ba1\u7406\u54e1\u7528\u6236\u540d\uff08\u4f8b\u5982\u201cadmin\u201d\uff09\u548c\u5bc6\u78bc\u767b\u9304\u3002\n## Ranger \u7ba1\u7406\u54e1\u65e5\u8a8c\nRanger \u7ba1\u7406\u54e1\u65e5\u8a8c\u53ef\u5728 [Logging](https://console.cloud.google.com/logs?hl=zh-cn) \u4e2d\u4f5c\u7232 `ranger-admin-root` \u65e5\u8a8c\u3002", "guide": "Dataproc"}