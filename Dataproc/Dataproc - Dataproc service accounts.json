{"title": "Dataproc - Dataproc service accounts", "url": "https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/service-accounts", "abstract": "# Dataproc - Dataproc service accounts\nThis page describes service accounts and VM access scopes and how they are used with Dataproc.\n**Security requirement beginning August 3, 2020: ** Dataproc users are required to have [service account ActAs permission](/iam/docs/service-accounts-actas) to deploy Dataproc resources, for example, to create clusters and submit jobs. See [Roles for service account authentication](/iam/docs/service-account-permissions) for detailed information about service account permissions. **Opt-in for existing Dataproc users: ** Existing Dataproc users as of August 3, 2020 can opt in to this security requirement (see [Securing Dataproc, Dataflow, and Cloud Data Fusion](/iam/docs/service-accounts-actas#dataproc-dataflow-datafusion) ).\n", "content": "## What are service accounts?\nA [service account](/compute/docs/access/service-accounts) is a special account that can be used by services and applications running on a Compute Engine virtual machine (VM) instance to interact with other Google Cloud APIs. Applications can use service account credentials to authorize themselves to a set of APIs and perform actions on the VM within the permissions granted to the service account.\n**Use your identity instead of a VM service\n account.** See [Dataproc Personal Cluster Authentication](/dataproc/docs/concepts/iam/personal-auth) to run interactive workloads on a cluster as your [ user identity](/dataproc/docs/concepts/iam/dataproc-principals#api_user_user_identity) .\n## Dataproc service accounts\nThe following service accounts are granted permissions required to perform Dataproc actions in the project where your cluster is located.\n[](None)\n- [Dataproc VM service account](/dataproc/docs/concepts/iam/dataproc-principals#vm_service_account_data_plane_identity) : VMs in a Dataproc cluster use this service account for Dataproc data plane operations, such reading and writing data from and to Cloud Storage and BigQuery (see [Dataproc VM service account (Data Plane identity)](/dataproc/docs/concepts/iam/dataproc-principals#vm_service_account_data_plane_identity) ). The [Compute Engine default service account](/compute/docs/access/service-accounts#default_service_account) , `[project-number]-compute@developer.gserviceaccount.com` , is used as the Dataproc VM service account unless you [specify aVM service account](/dataproc/docs/concepts/configuring-clusters/service-accounts#create_a_cluster_with_a_custom_vm_service_account) when you create a cluster.The [Dataproc Worker](/dataproc/docs/concepts/iam/iam#roles) role provides the VM service account with the minimum permissions necessary to operate with Dataproc. Additional roles are necessary to grant permissions to read and write data to Google Cloud resources, such as BigQuery.\n[](None)\n- [Dataproc Service Agent service account](/dataproc/docs/guides/dataproc-principals#service_agent_control_plane_identity) : Dataproc creates this service account with the [Dataproc Service Agent](/iam/docs/understanding-roles#dataproc.serviceAgent) role in a Dataproc user's Google Cloud project. This service account cannot be replaced by a custom VM service account when you create a cluster. This service agent account is used to perform Dataproc control plane operations, such as the creation, update, and deletion of cluster VMs (see [Dataproc Service Agent (Control Plane identity)](/dataproc/docs/concepts/iam/dataproc-principals#service_agent_control_plane_identity) ).By default, Dataproc uses the `service-[project-number]@dataproc-accounts.iam.gserviceaccount.com` as the service agent account. If that service account does not have permission, Dataproc uses the [Google APIs service agent account](/iam/docs/service-account-types#google-managed_service_accounts) , `[project-number]@cloudservices.gserviceaccount.com` , for control plane operations.The Dataproc service agent service account is a [Google-managed service account](/iam/docs/service-account-types#google-managed) . To view this service account in your project, click \"Include Google-provided role grants\" on the [IAM](https://console.cloud.google.com/iam-admin/iam) page in the Google Cloud console. **Note:** The Dataproc service agent service account will not be listed on the IAM page if it is not a principal of any IAM policy in the project.\n**Shared VPC networks:** If the cluster uses a Shared VPC network, a Shared VPC Admin must grant both of the above service accounts the role of [Network User](/compute/docs/access/iam#compute.networkUser) for the Shared VPC host project. For more information, see:\n- [Create a cluster that uses a VPC network in another project](/dataproc/docs/concepts/configuring-clusters/network#create_a_cluster_that_uses_a_network_in_another_project) \n- [Shared VPC documentation: configuring service accounts as Service ProjectAdmins](/vpc/docs/provisioning-shared-vpc#sa-as-spa) ## Dataproc VM access scopes\nVM Access scopes and IAM roles work together to limit VM access to Google Cloud APIs. For example, if cluster VMs are granted only the `https://www.googleapis.com/auth/storage-full` scope, applications running on cluster VMs can call Cloud Storage APIs, but they are not able to make requests to BigQuery, even if they are running as a VM service account that had been granted a BigQuery role with broad permissions.\nA [best practice](/compute/docs/access/service-accounts#scopes_best_practice) is to grant the broad `cloud-platform` scope ( `https://www.googleapis.com/auth/cloud-platform` ) to VMs, and then limit VM access by granting specific [IAM roles](/dataproc/docs/concepts/iam/iam#roles) to the [VM service account](#VM_service_account) .\n**Note:** `cloud-platform` scope is applied by default to Dataproc cluster VMs created with Dataproc image version 2.1 or higher.\n**Default Dataproc VM scopes.** If scopes are not specified when a cluster is created (see [gcloud dataproc cluster create --scopes](/sdk/gcloud/reference/dataproc/clusters/create#--scopes) ), Dataproc VMs have the following default set of scopes:\n```\nhttps://www.googleapis.com/auth/cloud-platform (clusters created with image version 2.1+).\nhttps://www.googleapis.com/auth/bigquery\nhttps://www.googleapis.com/auth/bigtable.admin.table\nhttps://www.googleapis.com/auth/bigtable.data\nhttps://www.googleapis.com/auth/cloud.useraccounts.readonly\nhttps://www.googleapis.com/auth/devstorage.full_control\nhttps://www.googleapis.com/auth/devstorage.read_write\nhttps://www.googleapis.com/auth/logging.write\n```\nIf you specify scopes when creating a cluster, cluster VMs will have the scopes you specify **and** the following minimum set of required scopes (even if you don't specify them):\n```\nhttps://www.googleapis.com/auth/cloud-platform (clusters created with image version 2.1+).\nhttps://www.googleapis.com/auth/cloud.useraccounts.readonly\nhttps://www.googleapis.com/auth/devstorage.read_write\nhttps://www.googleapis.com/auth/logging.write\n```\n## Create a cluster with a custom VM service account\nWhen you create a cluster, you can specify a custom [VM service account](/dataproc/docs/concepts/iam/dataproc-principals#vm_service_account_data_plane_identity) that your cluster will use for Dataproc data plane operations instead of the [default VM service account](#VM_service_account) (you can't change the VM service account after the cluster is created). Using a VM service account with assigned [IAM roles](/iam/docs) allows you to provide your cluster with fine-grained access to project resources.\n**Objective:** This section shows you how to specify a custom VM service account when you create a cluster. See [Create a cluster with a custom VM service account from another project](#create_a_cluster_with_a_custom_vm_service_account_from_another_project) to specify a VM service account from a different project.\n### Preliminary steps\n- [Create the custom VM service account](/iam/docs/creating-managing-service-accounts#creating_a_service_account) within the project where the cluster will be created.\n- Grant the custom VM service account the [Dataproc Worker](/iam/docs/understanding-roles#dataproc.worker) role on the project and any additional roles needed by your jobs, such as the BigQuery [Reader and Writer](/bigquery/docs/access-control-basic-roles#dataset-basic-roles) roles (see [Dataproc permissions and IAM roles](/dataproc/docs/concepts/iam/iam) ). **gcloud CLI example:** - The following sample command grants the custom VM service account in the cluster project the Dataproc Worker role at the project level:\n```\ngcloud projects add-iam-policy-binding CLUSTER_PROJECT_ID \\\n\u00a0\u00a0\u00a0\u00a0--member=serviceAccount:SERVICE_ACCOUNT_NAME@PROJECT_ID.iam.gserviceaccount.com \\\n\u00a0\u00a0\u00a0\u00a0--role=\"roles/dataproc.worker\"\n \n```- **Consider a custom role:** Instead of granting service account the pre-defined Dataproc`Worker`role, you can grant the service account a custom role that contains Worker role permissions but limits the [storage.objects.*](/storage/docs/access-control/iam-permissions#object_permissions) permissions.- The custom role must at least grant the VM service account`storage.objects.create`,`storage.objects.get`, and`storage.objects.update`permissions on the objects in the [Dataproc staging and temp buckets](/dataproc/docs/concepts/configuring-clusters/staging-bucket) and on any additional buckets needed by jobs that will run on the cluster.\n### Create the cluster\n- Create the cluster in your project.\nUse the [gcloud dataproc clusters create](/sdk/gcloud/reference/dataproc/clusters/create) command to create a cluster with the custom VM service account.\n```\ngcloud dataproc clusters create CLUSTER_NAME \\\n\u00a0\u00a0\u00a0\u00a0--region=REGION \\\n\u00a0\u00a0\u00a0\u00a0--service-account=SERVICE_ACCOUNT_NAME@PROJECT_ID.iam.gserviceaccount.com \\\n\u00a0\u00a0\u00a0\u00a0--scopes=SCOPE\n```\nReplace the following:\n- : The cluster name, which must be unique within a project. The name must start with a lowercase letter, and can contain up to 51 lowercase letters, numbers, and hyphens. It cannot end with a hyphen. The name of a deleted cluster can be reused.\n- : The [region](/compute/docs/regions-zones#available) where the cluster will be located.\n- : The service account name.\n- : The Google Cloud project ID of the project containing your [VM service account](#VM_service_account) . This will be the ID of the project where your cluster will be created or the ID of another project if you are [creating a cluster with a custom VM service account in another cluster](#create_a_cluster_with_a_custom_vm_service_account_from_another_clusterservice_account) .\n- : [Access scope(s)](#dataproc_vm_access_scopes) for cluster VM instances (for example,`https://www.googleapis.com/auth/cloud-platform`).\nWhen completing the [GceClusterConfig](/dataproc/docs/reference/rest/v1/ClusterConfig#GceClusterConfig) as part of the [clusters.create](/dataproc/docs/reference/rest/v1/projects.regions.clusters/create) API request, set the following fields:- [serviceAccount](/dataproc/docs/reference/rest/v1/ClusterConfig#GceClusterConfig.FIELDS.service_account) : The service account will be located in the project where your cluster will be created unless you are using a [VM service account from a different project](#create_a_cluster_with_a_custom_vm_service_account_from_another_cluster) .\n- [serviceAccountScopes](/dataproc/docs/reference/rest/v1/ClusterConfig#GceClusterConfig.FIELDS.service_account_scopes) : Specify the [access scope(s)](#dataproc_vm_access_scopes) for cluster VM instances (for example,`https://www.googleapis.com/auth/cloud-platform`).\nSetting a Dataproc VM service account in the Google Cloud console is not supported. You can set the `cloud-platform` [access scope](#dataproc_vm_access_scopes) on cluster VMs when you create the cluster by clicking \"Enables the cloud-platform scope for this cluster\" in the **Project access** section of the **Manage security** panel on the Dataproc [Create a cluster](https://console.cloud.google.com/dataproc/clustersAdd) page in the Google Cloud console.\n## Create a cluster with a custom VM service account from another project\nWhen you create a cluster, you can specify a custom [VM service account](/dataproc/docs/concepts/iam/dataproc-principals#vm_service_account_data_plane_identity) that your cluster will use for Dataproc data plane operations instead of using the [default VM service account](#VM_service_account) (you can't specify a custom VM service account after the cluster is created). Using a custom VM service account with assigned [IAM roles](/iam/docs) allows you to provide your cluster with fine-grained access to project resources.\n**Objective:** This section shows you how to specify a custom VM service account for your cluster from a project that is different from the project where your cluster will be created. We refer to this project as the \"service account project\" to distinguish it from the project where your cluster will be created (the \"cluster project\"). See [Create a cluster with a custom VM service account](#create_a_cluster_with_a_custom_vm_service_account) to use a custom VM service account from the project where the cluster will be created .\n### Preliminary steps\n- In the service account project (the project where the custom VM service account is located):- [Enable service accounts to be attached across projects](/iam/docs/attach-service-accounts#enabling-cross-project) .\n- Enable the Dataproc API. [Enable the API](https://console.cloud.google.com/flows/enableapi?apiid=dataproc.googleapis.com) \n- Grant to your email account (the user who is creating the cluster) the [Service Account User](/iam/docs/service-accounts#user-role) role on either the service account project or, for more granular control, the custom VM service account in the service account project. **For more information:** See [Manage access to projects, folders, and organizations](/iam/docs/granting-changing-revoking-access) to grant roles at the project level and [Manage access to service accounts](/iam/docs/manage-access-service-accounts) grant roles at the service account level. **gcloud CLI examples:** - The following sample command grants to the user the Service Account User role at the project level:\n```\ngcloud projects add-iam-policy-binding SERVICE_ACCOUNT_PROJECT_ID \\\n\u00a0\u00a0\u00a0\u00a0--member=USER_EMAIL \\\n\u00a0\u00a0\u00a0\u00a0--role=\"roles/iam.serviceAccountUser\"\n```Notes: `` : Provide your user account email address, in the format: `user:user-name@example.com` .- The following sample command grants to the user the Service Account User role at the service account level:\n```\ngcloud iam service-accounts add-iam-policy-binding VM_SERVICE_ACCOUNT_EMAIL \\\n\u00a0\u00a0\u00a0\u00a0--member=USER_EMAIL \\\n\u00a0\u00a0\u00a0\u00a0--role=\"roles/iam.serviceAccountUser\"\n```Notes: `` : Provide your user account email address, in the format: `user:user-name@example.com` .\n- Grant the custom VM service account the [Dataproc Worker](/iam/docs/understanding-roles#dataproc.worker) role on the cluster project. **gcloud CLI example:** ```\ngcloud projects add-iam-policy-binding CLUSTER_PROJECT_ID \\\n\u00a0\u00a0\u00a0\u00a0--member=serviceAccount:SERVICE_ACCOUNT_NAME@SERVICE_ACCOUNT_PROJECT_ID.iam.gserviceaccount.com \\\n\u00a0\u00a0\u00a0\u00a0--role=\"roles/dataproc.worker\"\n \n```\n- Grant the [Dataproc Service Agent service account](#service_agent_account) in the cluster project the [Service Account User](/iam/docs/service-accounts#user-role) and the [Service Account Token Creator](/iam/docs/service-accounts#token-creator-role) roles on either the service account project or, for more granular control, the custom VM service account in the service account project. By doing this, you allow the Dataproc service agent service account in the cluster project to create tokens for the custom Dataproc VM service account in the service account project. **For more information:** See [Manage access to projects, folders, and organizations](/iam/docs/granting-changing-revoking-access) to grant roles at the project level and [Manage access to service accounts](/iam/docs/manage-access-service-accounts) grant roles at the service account level. **gcloud CLI examples:** - The following sample commands grant the Dataproc Service Agent service account in the cluster project the Service Account User and Service Account Token Creator roles at the project level:\n```\ngcloud projects add-iam-policy-binding SERVICE_ACCOUNT_PROJECT_ID \\\n\u00a0\u00a0\u00a0\u00a0--member=serviceAccount:service-CLUSTER_PROJECT_NUMBER@dataproc-accounts.iam.gserviceaccount.com \\\n\u00a0\u00a0\u00a0\u00a0--role=\"roles/iam.serviceAccountUser\"\n \n``````\ngcloud projects add-iam-policy-binding SERVICE_ACCOUNT_PROJECT_ID \\\n\u00a0\u00a0\u00a0\u00a0--member=serviceAccount:service-CLUSTER_PROJECT_NUMBER@dataproc-accounts.iam.gserviceaccount.com \\\n\u00a0\u00a0\u00a0\u00a0--role=\"roles/iam.serviceAccountTokenCreator\"\n```- The following sample commands grant the Dataproc Service Agent service account in the cluster project the Service Account User and Service Account Token Creator roles at the VM service account level:\n```\ngcloud iam service-accounts add-iam-policy-binding VM_SERVICE_ACCOUNT_EMAIL \\\n\u00a0\u00a0\u00a0\u00a0--member=serviceAccount:service-CLUSTER_PROJECT_NUMBER@dataproc-accounts.iam.gserviceaccount.com \\\n\u00a0\u00a0\u00a0\u00a0--role=\"roles/iam.serviceAccountUser\"\n \n``````\ngcloud iam service-accounts add-iam-policy-binding VM_SERVICE_ACCOUNT_EMAIL \\\n\u00a0\u00a0\u00a0\u00a0--member=serviceAccount:service-CLUSTER_PROJECT_NUMBER@dataproc-accounts.iam.gserviceaccount.com \\\n\u00a0\u00a0\u00a0\u00a0--role=\"roles/iam.serviceAccountTokenCreator\"\n```\n- Grant the [Compute Engine Service Agent service account](/compute/docs/access/service-accounts#compute_engine_service_account) in the cluster project the [Service Account Token Creator](/iam/docs/service-accounts#token-creator-role) role on either the service account project or, for more granular control, the custom VM service account in the service account project. By doing this, you grant the Compute Agent Service Agent service account in the cluster project the ability to create tokens for the custom Dataproc VM service account in the service account project. **For more information:** See [Manage access to projects, folders, and organizations](/iam/docs/granting-changing-revoking-access) to grant roles at the project level and [Manage access to service accounts](/iam/docs/manage-access-service-accounts) grant roles at the service account level. **gcloud CLI examples:** - The following sample command grants the Compute Engine Service Agent service account in the cluster project the Service Account Token Creator role at the project level:\n```\ngcloud projects add-iam-policy-binding SERVICE_ACCOUNT_PROJECT_ID \\\n\u00a0\u00a0\u00a0\u00a0--member=serviceAccount:service-CLUSTER_PROJECT_NUMBER@compute-system.iam.gserviceaccount.com \\\n\u00a0\u00a0\u00a0\u00a0--role=\"roles/iam.serviceAccountTokenCreator\"\n \n```- The following sample command grants the Compute Engine Service Agent service account in the cluster project the Service Account Token Creator role at the VM service account level:\n```\ngcloud iam service-accounts add-iam-policy-binding VM_SERVICE_ACCOUNT_EMAIL \\\n\u00a0\u00a0\u00a0\u00a0--member=serviceAccount:service-CLUSTER_PROJECT_NUMBER@compute-system.iam.gserviceaccount.com \\\n\u00a0\u00a0\u00a0\u00a0--role=\"roles/iam.serviceAccountTokenCreator\"\n \n```\n### Create the cluster\n- [Create the cluster in your project](#create_the_cluster) .## What's next\n- [Service accounts](/compute/docs/access/service-accounts) \n- [Dataproc permissions and IAM roles](/dataproc/docs/concepts/iam/iam) \n- [Dataproc principals and roles](/dataproc/docs/concepts/iam/dataproc-principals) \n- [Dataproc Service Account Based Secure Multi-tenancy](/dataproc/docs/concepts/iam/sa-multi-tenancy) \n- [Dataproc Personal Cluster Authentication](/dataproc/docs/concepts/iam/personal-auth) \n- [Dataproc Granular IAM](/dataproc/docs/concepts/iam/granular-iam)", "guide": "Dataproc"}