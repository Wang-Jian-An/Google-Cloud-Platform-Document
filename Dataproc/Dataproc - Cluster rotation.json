{"title": "Dataproc - Cluster rotation", "url": "https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/cluster-rotation", "abstract": "# Dataproc - Cluster rotation\n.\nOrganization security policies, regulatory compliance rules, and other considerations can prompt you to \"rotate\" your Dataproc clusters at regular intervals by deleting, then recreating clusters on a schedule. As part of cluster rotation, new clusters can be provisioned with the latest Dataproc image versions while retaining the configuration settings of the replaced clusters.\nThis page shows you how to set up clusters that you plan to rotate (\"rotated clusters\"), submit jobs to them, and then rotate the clusters as needed.\n[Custom image](/dataproc/docs/guides/dataproc-images) cluster rotation: You can apply previous or new customizations to a previous or new Dataproc base image when recreating the custom image cluster.\n", "content": "## Set up rotated clusters\nTo set up rotated clusters, create unique, timestamp-suffixed cluster names to distinguish previous from new clusters, and then attach labels to clusters that indicate if a cluster is part of a rotated cluster pool and actively receiving new job submissions. This example uses `cluster-pool` and `cluster-state=active` labels for these purposes, but you can use your own label names.\n- Set environment variables:```\nPROJECT=project ID \\\n\u00a0\u00a0REGION=region \\\n\u00a0\u00a0CLUSTER_POOL=cluster-pool-name \\\n\u00a0\u00a0CLUSTER_NAME=$CLUSTER_POOL-$(date '+%Y%m%d%H%M') \\\n\u00a0\u00a0BUCKET=Cloud Storage bucket-name\n```Notes:- : The name of the cluster pool associated with one or more clusters. This name is used in the cluster name and with the`cluster-pool`label attached to the cluster to identify the cluster as part of the pool.\n- Create the cluster. You can add arguments and use different labels.```\ngcloud dataproc clusters create ${CLUSTER_NAME} \\\n\u00a0\u00a0--project=${PROJECT_ID} \\\n\u00a0\u00a0--region=${REGION} \\\n\u00a0\u00a0--bucket=${BUCKET} \\\n\u00a0\u00a0--labels=\"cluster-pool=${CLUSTER_POOL},cluster-state=active\"\n```## Submit jobs to clusters\nThe following Google Cloud CLI and [Apache Airflow directed acyclic graph (DAG)](/composer/docs/how-to/using/writing-dags) examples submit an Apache Pig job to a cluster. Cluster labels are used to submit the job to an active cluster within a cluster pool.\nSubmit an Apache Pig job located in Cloud Storage. Pick the cluster using labels.\n```\ngcloud dataproc jobs submit pig \\\n\u00a0\u00a0\u00a0\u00a0--region=${REGION} \\\n\u00a0\u00a0\u00a0\u00a0--file=gs://${BUCKET}/scripts/script.pig \\\n\u00a0\u00a0\u00a0\u00a0--cluster-labels=\"cluster-pool=${CLUSTER_POOL},cluster-state=active\"\n \n```\nSubmit an Apache Pig job located in Cloud Storage using Airflow. Pick the cluster using labels.\n```\nfrom airflow import DAG\nfrom airflow.providers.google.cloud.operators.dataproc import DataprocSubmitJobOperator\nfrom datetime import datetime\n# Declare variables\nproject_id= # e.g: my-project\nregion=\"us-central1\"\ndag_id='pig_wordcount'\ncluster_labels={\"cluster-pool\":${CLUSTER_POOL},\n    \"cluster-state\":\"active\"}\nwordcount_script=\"gs://bucket-name/scripts/wordcount.pig\"\n# Define DAG\ndag = DAG(\n dag_id,\n schedule_interval=None, \n start_date=datetime(2023, 8, 16),\n catchup=False \n)\nPIG_JOB = {\n \"reference\": {\"project_id\": project_id},\n \"placement\": {\"cluster_labels\": cluster_labels},\n \"pig_job\": {\"query_file_uri\": wordcount_script},\n}\nwordcount_task = DataprocSubmitJobOperator(\n task_id='wordcount',\n region=region,\n project_id=project_id,\n job=PIG_JOB,\n dag=dag\n)\n```\n## Rotate clusters\n- Update the cluster labels attached to the clusters you are rotating out. This examples uses the `cluster-state=pendingfordeletion` label to signify that the cluster is not receiving new job submissions and is being rotated out, but you can use your own label for this purpose.```\ngcloud dataproc clusters update ${CLUSTER_NAME} \\\n\u00a0\u00a0\u00a0\u00a0--region=${REGION} \\\n\u00a0\u00a0\u00a0\u00a0--update-labels=\"cluster-state=pendingfordeletion\"\n```After the cluster label is updated, the cluster does not receive new jobs since jobs are submitted to clusters within a cluster pool with `active` labels only (see [Submit jobs to clusters](#submit_jobs_to_clusters) ).\n- Delete clusters you are rotating out after they finish running jobs. **Note:** You can automate this step with a monitoring script that fetches clusters with the `cluster-state=pendingfordeletion` label (or other label you added with the previous command), checks that no jobs are running on the cluster, and then deletes the cluster.", "guide": "Dataproc"}