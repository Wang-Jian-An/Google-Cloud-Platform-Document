{"title": "Dataproc - \u5728 Dataproc \u4e2d\u4f7f\u7528\u6578\u64da\u6cbf\u8972", "url": "https://cloud.google.com/dataproc/docs/guides/lineage?hl=zh-cn", "abstract": "# Dataproc - \u5728 Dataproc \u4e2d\u4f7f\u7528\u6578\u64da\u6cbf\u8972\n\u6578\u64da\u6cbf\u8972\u662f\u4e00\u9805 Dataplex \u529f\u80fd\uff0c\u53ef\u8b93\u60a8\u8ddf\u8e64\u6578\u64da\u5728\u7cfb\u7d71\u4e2d\u7684\u79fb\u52d5\u65b9\u5f0f\uff1a\u6578\u64da\u4f86\u81ea\u4f55\u8655\u3001\u88ab\u50b3\u905e\u5230\u4f55\u8655\u4ee5\u53ca\u5df2\u5c0d\u9019\u4e9b\u6578\u64da\u61c9\u7528\u4e86\u54ea\u4e9b\u8f49\u63db\u3002\n\u6578\u64da\u6cbf\u8972\u9069\u7528\u65bc\u9664 SparkR \u4e4b\u5916\u7684\u6240\u6709 Dataproc Spark \u4f5c\u696d\uff0c\u4ee5\u53ca Dataproc Compute Engine 2.0.74+ \u6620\u50cf\u548c 2.1.22+ \u6620\u50cf\u3002\u6cbf\u8972\u9069\u7528\u65bc BigQuery \u548c Cloud Storage \u6578\u64da\u6e90\u3002\n\u5728 Dataproc \u96c6\u7fa3\u4e2d\u5553\u7528\u8a72\u529f\u80fd\u5f8c\uff0cDataproc Spark \u4f5c\u696d\u6703\u6355\u7372\u6cbf\u8972\u4e8b\u4ef6\u4e26\u5c07\u5176\u767c\u4f48\u5230 Dataplex [Data Lineage API](https://cloud.google.com/dataplex/docs/reference/rest?hl=zh-cn) \u3002Dataproc \u4f7f\u7528 [OpenLineage Spark \u63d2\u4ef6](https://github.com/OpenLineage/OpenLineage) \uff0c\u901a\u904e [OpenLineage](https://cloud.google.com/data-catalog/docs/concepts/open-lineage?hl=zh-cn) \u8207 Data Lineage API \u96c6\u6210\u3002\n\u60a8\u53ef\u4ee5\u901a\u904e\u4ee5\u4e0b\u65b9\u5f0f\u901a\u904e Dataplex \u8a2a\u554f\u6cbf\u8972\u4fe1\u606f\uff1a\n- [\u6cbf\u8972\u53ef\u8996\u5316\u5716](https://cloud.google.com/data-catalog/docs/concepts/about-data-lineage?hl=zh-cn#lineage-feature-graph) \n- [Data Lineage API](https://cloud.google.com/data-catalog/docs/reference/data-lineage/rest?hl=zh-cn) ", "content": "## \u9650\u5236\n\u4ee5\u4e0b\u8cc7\u6e90\u4e0d\u652f\u6301\u6cbf\u8972\uff1a\n- BigQuery \u9023\u63a5\u5668\u7248\u672c 2\uff08\u6578\u64da\u6e90 API \u7248\u672c 2\uff0cSpark\uff09\n- Spark \u6d41\u5f0f\u5de5\u4f5c\u8ca0\u8f09## \u6e96\u5099\u5de5\u4f5c\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u9805\u76ee\u9078\u64c7\u5668\u9801\u9762\u4e0a\uff0c\u9078\u64c7\u5305\u542b\u8981\u8ddf\u8e64\u5176\u6cbf\u8972\u7684 Dataproc \u96c6\u7fa3\u7684\u9805\u76ee\u3002 [\u8f49\u5230\u201c\u9805\u76ee\u9078\u64c7\u5668\u201d](https://console.cloud.google.com/projectselector2/home/dashboard?hl=zh-cn) \n- \u5553\u7528 Data Lineage API \u548c Data Catalog API\u3002 [\u5553\u7528 API](https://console.cloud.google.com/apis/enableflow?apiid=datalineage.googleapis.com%2Cdatacatalog.googleapis.com&hl=zh-cn) ## \u6240\u9700\u7684\u89d2\u8272\n\u5982\u9700\u7372\u53d6\u5728 Dataproc \u4e2d\u4f7f\u7528\u6578\u64da\u6cbf\u8972\u6240\u9700\u7684\u6b0a\u9650\uff0c\u8acb\u8b93\u7ba1\u7406\u54e1\u5411\u60a8\u6388\u4e88\u5c0d Dataproc \u96c6\u7fa3\u865b\u64ec\u6a5f\u670d\u52d9\u5e33\u865f\u7684\u4ee5\u4e0b IAM \u89d2\u8272\uff1a\n- \u5728 Data Catalog \u4e2d\u67e5\u770b\u6cbf\u8972\u53ef\u8996\u5316\u5716\u8868\u6216\u4f7f\u7528 Data Lineage API\uff1a [Data Lineage Viewer ](https://cloud.google.com/iam/docs/understanding-roles?hl=zh-cn#datalineage.viewer) (`roles/datalineage.viewer`)\n- \u4f7f\u7528\u4ee5\u4e0b API \u624b\u52d5\u751f\u6210\u6cbf\u8972\uff1a [\u6578\u64da\u6cbf\u8972\u4e8b\u4ef6\u751f\u7522\u8005 ](https://cloud.google.com/iam/docs/understanding-roles?hl=zh-cn#datalineage.producer) (`roles/datalineage.producer`)\n- \u4f7f\u7528\u4ee5\u4e0b API \u4fee\u6539\u6cbf\u8972\uff1a [Data Lineage Editor ](https://cloud.google.com/iam/docs/understanding-roles?hl=zh-cn#datalineage.editor) (`roles/datalineage.editor`)\n- \u5c0d\u6cbf\u8972\u57f7\u884c\u6240\u6709\u64cd\u4f5c\uff1a [\u6578\u64da\u6cbf\u8972\u7ba1\u7406\u54e1 ](https://cloud.google.com/iam/docs/understanding-roles?hl=zh-cn#datalineage.admin) (`roles/datalineage.admin`)\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u6388\u4e88\u89d2\u8272\uff0c\u8acb\u53c3\u95b1 [\u7ba1\u7406\u8a2a\u554f\u6b0a\u9650](https://cloud.google.com/iam/docs/granting-changing-revoking-access?hl=zh-cn) \u3002\n\u60a8\u4e5f\u53ef\u4ee5\u901a\u904e [\u81ea\u5b9a\u7fa9\u89d2\u8272](https://cloud.google.com/iam/docs/creating-custom-roles?hl=zh-cn) \u6216\u5176\u4ed6 [\u9810\u5b9a\u7fa9\u89d2\u8272](https://cloud.google.com/iam/docs/understanding-roles?hl=zh-cn) \u4f86\u7372\u53d6\u6240\u9700\u7684\u6b0a\u9650\u3002\n## \u5728 Dataproc \u4e2d\u5553\u7528\u6578\u64da\u6cbf\u8972\n\u5728\u96c6\u7fa3\u7d1a\u5225\u5553\u7528\u6cbf\u8972\uff0c\u4ee5\u4fbf\u96c6\u7fa3\u4e2d\u6240\u6709\u63d0\u4ea4\u7684 Spark \u4f5c\u696d\u5411 Data Lineage API \u5831\u544a\u6cbf\u8972\u4fe1\u606f\u3002\n### \u5275\u5efa Dataproc \u96c6\u7fa3\n[\u5275\u5efa Dataproc \u96c6\u7fa3](https://cloud.google.com/dataproc/docs/guides/create-cluster?hl=zh-cn#creating_a_cloud_dataproc_cluster) \uff0c\u4e26\u5c07\u5c6c\u6027 `dataproc:dataproc.lineage.enabled` \u8a2d\u7f6e\u7232 `true` \u3002\n**\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f Dataproc \u6620\u50cf\u7248\u672c 2.0\uff0c\u8acb\u5c07\u96c6\u7fa3\u7bc4\u570d\u8a2d\u7f6e\u7232 `cloud-platform` \u3002\n```\ngcloud dataproc clusters create CLUSTER_NAME \\--region REGION \\--zone ZONE \\--project PROJECT_ID \\--properties 'dataproc:dataproc.lineage.enabled=true' \\--scopes https://www.googleapis.com/auth/cloud-platform\n```\n### \u63d0\u4ea4 Spark \u4f5c\u696d\n\u5982\u679c\u60a8\u5728\u5553\u7528\u4e86\u6cbf\u8972\u7684 Dataproc \u96c6\u7fa3\u4e0a [\u63d0\u4ea4 Spark \u4f5c\u696d](https://cloud.google.com/dataproc/docs/guides/submit-job?hl=zh-cn#how_to_submit_a_job) \uff0cDataproc \u6703\u6355\u7372\u6cbf\u8972\u4fe1\u606f\u4e26\u5c07\u5176\u5831\u544a\u7d66 Data Lineage API\u3002\n```\ngcloud dataproc jobs submit spark \\--project PROJECT_ID \\--cluster=CLUSTER_NAME \\--region REGION \\--class CLASS \\--jars=gs://APPLICATION_BUCKET/spark-application.jar \\--properties=spark.openlineage.namespace=CUSTOM_NAMESPACE,spark.openlineage.appName=CUSTOM_APPNAME\n```\n`spark.openlineage.namespace` \u548c `spark.openlineage.appName` \u5c6c\u6027\u662f\u53ef\u9078\u7684\uff0c\u7528\u65bc\u5c0d\u4f5c\u696d\u9032\u884c\u552f\u4e00\u6a19\u8b58\u3002\u5982\u679c\u60a8\u672a\u50b3\u905e\u9019\u4e9b\u5c6c\u6027\uff0cDataproc \u5c07\u4f7f\u7528\u4ee5\u4e0b\u9ed8\u8a8d\u503c\uff1a\n- `spark.openlineage.namespace`\u7684\u9ed8\u8a8d\u503c\uff1a\n- `spark.openlineage.appName`\u7684\u9ed8\u8a8d\u503c\uff1a`spark.app.name`\n### \u5728 Dataplex \u4e2d\u67e5\u770b\u6cbf\u8972\u5716\n\u6cbf\u8972\u53ef\u8996\u5316\u5716\u53ef\u986f\u793a\u9805\u76ee\u8cc7\u6e90\u8207\u5275\u5efa\u9019\u4e9b\u8cc7\u6e90\u7684\u6d41\u7a0b\u4e4b\u9593\u7684\u95dc\u4fc2\u3002\u60a8\u53ef\u4ee5\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u4ee5\u5716\u8868\u53ef\u8996\u5316\u7684\u5f62\u5f0f\u67e5\u770b\u6578\u64da\u6cbf\u8972\u4fe1\u606f\uff0c\u4e5f\u53ef\u4ee5\u4ee5 JSON \u6578\u64da\u7684\u5f62\u5f0f\u5f9e Data Lineage API \u6aa2\u7d22\u6b64\u4fe1\u606f\u3002\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5728 Dataplex \u754c\u9762\u4e2d\u67e5\u770b\u6cbf\u8972\u5716](https://cloud.google.com/data-catalog/docs/how-to/lineage-gcp?hl=zh-cn#view-lineage-graphs) \u3002\n### \u793a\u4f8b\n\u8acb\u8003\u616e\u4ee5\u4e0b Spark \u4f5c\u696d\uff0c\u8a72\u4f5c\u696d\u5f9e BigQuery \u8868\u4e2d\u8b80\u53d6\u6578\u64da\uff0c\u4e26\u5411\u53e6\u4e00\u500b BigQuery \u8868\u5beb\u5165\u6578\u64da\uff1a\n```\n#!/usr/bin/env pythonfrom pyspark.sql import SparkSessionimport sysspark = SparkSession \\\u00a0 .builder \\\u00a0 .appName('LINEAGE_BQ_TO_BQ') \\\u00a0 .getOrCreate()bucket = lineage-ol-testspark.conf.set('temporaryGcsBucket', bucket)source = sample.sourcewords = spark.read.format('bigquery') \\\u00a0 .option('table', source) \\\u00a0 .load()words.createOrReplaceTempView('words')word_count = spark.sql('SELECT word, SUM(word_count) AS word_count FROM words GROUP BY word')destination = sample.destinationword_count.write.format('bigquery') \\\u00a0 .option('table', destination) \\\u00a0 .save()\n```\n\u6b64 Spark \u4f5c\u696d\u6703\u5728 Dataplex \u754c\u9762\u4e2d\u5275\u5efa\u4ee5\u4e0b\u6cbf\u8972\u5716\uff1a\n## \u5728 Dataproc \u4e2d\u505c\u7528\u6578\u64da\u6cbf\u8972\n\u5728 [\u5275\u5efa\u96c6\u7fa3](#create-cluster) \u6642\u5553\u7528\u6cbf\u8972\u5f8c\uff0c\u4fbf\u7121\u6cd5\u5728\u96c6\u7fa3\u7d1a\u5c64\u505c\u7528\u6cbf\u8972\u3002\u5982\u9700\u5728 Dataproc \u96c6\u7fa3\u4e2d\u505c\u7528\u6cbf\u8972\uff0c\u8acb\u91cd\u65b0\u5275\u5efa\u4e0d\u5e36 `dataproc:dataproc.lineage.enabled` \u5c6c\u6027\u7684\u96c6\u7fa3\u3002\n\u5982\u9700\u7232\u5728\u5553\u7528\u6cbf\u8972\u7684\u60c5\u6cc1\u4e0b\u5275\u5efa\u7684\u96c6\u7fa3\u4e0a\u7684\u7279\u5b9a\u4f5c\u696d\u505c\u7528\u6cbf\u8972\uff0c\u60a8\u5fc5\u9808\u5728\u63d0\u4ea4\u4f5c\u696d\u6642\u50b3\u905e `spark.extraListeners` \u5c6c\u6027\u7232\u7a7a\u503c\u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u8a73\u7d30\u77ad\u89e3 [\u6578\u64da\u6cbf\u8972](https://cloud.google.com/data-catalog/docs/concepts/about-data-lineage?hl=zh-cn) \u3002", "guide": "Dataproc"}