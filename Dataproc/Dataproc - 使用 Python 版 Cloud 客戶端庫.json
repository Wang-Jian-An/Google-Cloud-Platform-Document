{"title": "Dataproc - \u4f7f\u7528 Python \u7248 Cloud \u5ba2\u6236\u7aef\u5eab", "url": "https://cloud.google.com/dataproc/docs/tutorials/python-library-example?hl=zh-cn", "abstract": "# Dataproc - \u4f7f\u7528 Python \u7248 Cloud \u5ba2\u6236\u7aef\u5eab\n\u672c\u6559\u7a0b\u63d0\u4f9b\u4e86\u4e00\u9805 [Cloud Shell \u6f14\u793a](https://cloud.google.com/shell/docs/tutorials?hl=zh-cn) \uff0c\u8a72\u6f14\u793a\u4f7f\u7528 [Python \u7248 Google Cloud \u5ba2\u6236\u7aef\u5eab](https://cloud.google.com/python/docs/reference/dataproc/latest?hl=zh-cn) \u4ee5\u7de8\u7a0b\u65b9\u5f0f\u8abf\u7528 [Dataproc gRPC API](https://cloud.google.com/dataproc/docs/reference/rpc?hl=zh-cn) \u4f86\u5275\u5efa\u96c6\u7fa3\u4e26\u5c07\u4f5c\u696d\u63d0\u4ea4\u5230\u8a72\u96c6\u7fa3\u3002\n\u4ee5\u4e0b\u90e8\u5206\u4ecb\u7d39 GitHub [GoogleCloudPlatform/python-dataproc](https://github.com/googleapis/python-dataproc/tree/master/samples/snippets) \u4ee3\u78bc\u5eab\u4e2d\u5305\u542b\u7684\u6f14\u793a\u4ee3\u78bc\u64cd\u4f5c\u3002\n\u6f14\u793a\u6559\u7a0b\u4ee3\u78bc\u767c\u51fa\u55ae\u7368\u7684 API \u8acb\u6c42\u4ee5\u5275\u5efa\u96c6\u7fa3\u3001\u5c07\u4f5c\u696d\u63d0\u4ea4\u5230\u96c6\u7fa3\uff0c\u7136\u5f8c\u522a\u9664\u96c6\u7fa3\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528 [\u5167\u5d4c\u5de5\u4f5c\u6d41](https://cloud.google.com/dataproc/docs/reference/rpc/google.cloud.dataproc.v1?hl=zh-cn#google.cloud.dataproc.v1.WorkflowTemplateService.InstantiateInlineWorkflowTemplate) \u901a\u904e\u4e00\u500b API \u8acb\u6c42\u5b8c\u6210\u9019\u4e9b\u4efb\u52d9\uff08\u8acb\u53c3\u95b1 [instantiate_inline_workflow_template.py](https://github.com/googleapis/python-dataproc/blob/master/samples/snippets/instantiate_inline_workflow_template.py) \u7372\u53d6\u793a\u4f8b\uff09\u3002\n", "content": "## \u904b\u884c Cloud Shell \u6f14\u793a\n\u9ede\u64ca **\u5728 Cloud Shell \u4e2d\u6253\u958b** (Open in Cloud Shell) \u4ee5\u904b\u884c\u6f14\u793a\u3002\n[\u5728 Cloud Shell \u4e2d\u6253\u958b](https://ssh.cloud.google.com/cloudshell/open?cloudshell_git_repo=https%3A%2F%2Fgithub.com%2Fgoogleapis%2Fpython-dataproc&cloudshell_working_dir=samples%2Fsnippets&tutorial=python-api-walkthrough.md&cloudshell_open_in_editor=submit_job_to_cluster.py&hl=zh-cn)\n## \u77ad\u89e3\u4ee3\u78bc\n### \u61c9\u7528\u9ed8\u8a8d\u6191\u64da\n\u672c\u6559\u7a0b\u4e2d\u7684 [Cloud Shell \u6f14\u793a](#run_the_cloud_shell_walkthrough) \u4f7f\u7528 Google Cloud \u9805\u76ee\u6191\u64da\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u5728\u672c\u5730\u904b\u884c\u4ee3\u78bc\u6642\uff0c\u63a8\u85a6\u7684\u505a\u6cd5\u662f\u4f7f\u7528 [\u670d\u52d9\u8cec\u865f\u6191\u64da](https://cloud.google.com/docs/authentication/production?hl=zh-cn#obtaining_and_providing_service_account_credentials_manually) \u5c0d\u4ee3\u78bc\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\n### \u5275\u5efa Dataproc \u96c6\u7fa3\n\u8a2d\u7f6e\u4ee5\u4e0b\u503c\u4ee5\u5275\u5efa\u96c6\u7fa3\uff1a\n- \u5c07\u5728\u5176\u4e2d\u5275\u5efa\u96c6\u7fa3\u7684\u9805\u76ee\n- \u5c07\u5728\u5176\u4e2d\u5275\u5efa\u96c6\u7fa3\u7684\u5340\u57df\n- \u96c6\u7fa3\u7684\u540d\u7a31\n- \u96c6\u7fa3\u914d\u7f6e\uff0c\u7528\u65bc\u6307\u5b9a\u4e00\u500b\u4e3b\u5be6\u4f8b\u548c\u5169\u500b\u4e3b\u8981\u5de5\u4f5c\u5668\n\u5176\u9918\u96c6\u7fa3\u8a2d\u7f6e\u5c07\u4f7f\u7528\u9ed8\u8a8d\u914d\u7f6e\u8a2d\u7f6e\u3002 \u60a8\u53ef\u4ee5\u66ff\u63db\u9ed8\u8a8d\u96c6\u7fa3\u914d\u7f6e\u8a2d\u7f6e\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u6dfb\u52a0\u8f14\u52a9\u865b\u64ec\u6a5f\uff08\u9ed8\u8a8d\u503c = 0\uff09\u6216\u7232\u96c6\u7fa3\u6307\u5b9a\u975e\u9ed8\u8a8d VPC \u7db2\u7d61\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [CreateCluster](https://cloud.google.com/dataproc/docs/reference/rpc/google.cloud.dataproc.v1?hl=zh-cn#google.cloud.dataproc.v1.ClusterController.CreateCluster) \u3002\n[  dataproc/snippets/submit_job_to_cluster.py ](https://github.com/GoogleCloudPlatform/python-docs-samples/blob/HEAD/dataproc/snippets/submit_job_to_cluster.py) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/python-docs-samples/blob/HEAD/dataproc/snippets/submit_job_to_cluster.py)\n```\ndef quickstart(project_id, region, cluster_name, gcs_bucket, pyspark_file):\u00a0 \u00a0 # Create the cluster client.\u00a0 \u00a0 cluster_client = dataproc_v1.ClusterControllerClient(\u00a0 \u00a0 \u00a0 \u00a0 client_options={\"api_endpoint\": f\"{region}-dataproc.googleapis.com:443\"}\u00a0 \u00a0 )\u00a0 \u00a0 # Create the cluster config.\u00a0 \u00a0 cluster = {\u00a0 \u00a0 \u00a0 \u00a0 \"project_id\": project_id,\u00a0 \u00a0 \u00a0 \u00a0 \"cluster_name\": cluster_name,\u00a0 \u00a0 \u00a0 \u00a0 \"config\": {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"master_config\": {\"num_instances\": 1, \"machine_type_uri\": \"n1-standard-2\"},\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"worker_config\": {\"num_instances\": 2, \"machine_type_uri\": \"n1-standard-2\"},\u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 }\u00a0 \u00a0 # Create the cluster.\u00a0 \u00a0 operation = cluster_client.create_cluster(\u00a0 \u00a0 \u00a0 \u00a0 request={\"project_id\": project_id, \"region\": region, \"cluster\": cluster}\u00a0 \u00a0 )\u00a0 \u00a0 result = operation.result()\u00a0 \u00a0 print(f\"Cluster created successfully: {result.cluster_name}\")\n```### \u63d0\u4ea4\u4f5c\u696d\n\u8a2d\u7f6e\u4ee5\u4e0b\u503c\u4ee5\u63d0\u4ea4\u4f5c\u696d\uff1a\n- \u5c07\u5728\u5176\u4e2d\u5275\u5efa\u96c6\u7fa3\u7684\u9805\u76ee\n- \u5c07\u5728\u5176\u4e2d\u5275\u5efa\u96c6\u7fa3\u7684\u5340\u57df\n- \u4f5c\u696d\u914d\u7f6e\uff0c\u7528\u65bc\u6307\u5b9a PySpark \u4f5c\u696d\u7684\u96c6\u7fa3\u540d\u7a31\u548c Cloud Storage \u6587\u4ef6\u8def\u5f91 (URI)\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [SubmitJob](https://cloud.google.com/dataproc/docs/reference/rpc/google.cloud.dataproc.v1?hl=zh-cn#google.cloud.dataproc.v1.JobController.SubmitJob) \u3002\n[  dataproc/snippets/submit_job_to_cluster.py ](https://github.com/GoogleCloudPlatform/python-docs-samples/blob/HEAD/dataproc/snippets/submit_job_to_cluster.py) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/python-docs-samples/blob/HEAD/dataproc/snippets/submit_job_to_cluster.py)\n```\n# Create the job client.job_client = dataproc_v1.JobControllerClient(\u00a0 \u00a0 client_options={\"api_endpoint\": f\"{region}-dataproc.googleapis.com:443\"})# Create the job config.job = {\u00a0 \u00a0 \"placement\": {\"cluster_name\": cluster_name},\u00a0 \u00a0 \"pyspark_job\": {\"main_python_file_uri\": f\"gs://{gcs_bucket}/{spark_filename}\"},}operation = job_client.submit_job_as_operation(\u00a0 \u00a0 request={\"project_id\": project_id, \"region\": region, \"job\": job})response = operation.result()# Dataproc job output is saved to the Cloud Storage bucket# allocated to the job. Use regex to obtain the bucket and blob info.matches = re.match(\"gs://(.*?)/(.*)\", response.driver_output_resource_uri)output = (\u00a0 \u00a0 storage.Client()\u00a0 \u00a0 .get_bucket(matches.group(1))\u00a0 \u00a0 .blob(f\"{matches.group(2)}.000000000\")\u00a0 \u00a0 .download_as_bytes()\u00a0 \u00a0 .decode(\"utf-8\"))print(f\"Job finished successfully: {output}\\r\\n\")\n```### \u522a\u9664\u96c6\u7fa3\n\u4ee5\u4e0b\u503c\u8a2d\u7f6e\u7232\u522a\u9664\u96c6\u7fa3\uff1a\n- \u5c07\u5728\u5176\u4e2d\u5275\u5efa\u96c6\u7fa3\u7684\u9805\u76ee\n- \u5c07\u5728\u5176\u4e2d\u5275\u5efa\u96c6\u7fa3\u7684\u5340\u57df\n- \u96c6\u7fa3\u7684\u540d\u7a31\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [DeleteCluster](https://cloud.google.com/dataproc/docs/reference/rpc/google.cloud.dataproc.v1?hl=zh-cn#google.cloud.dataproc.v1.JobController.DeleteCluster) \u3002\n[  dataproc/snippets/submit_job_to_cluster.py ](https://github.com/GoogleCloudPlatform/python-docs-samples/blob/HEAD/dataproc/snippets/submit_job_to_cluster.py) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/python-docs-samples/blob/HEAD/dataproc/snippets/submit_job_to_cluster.py)\n```\n# Delete the cluster once the job has terminated.operation = cluster_client.delete_cluster(\u00a0 \u00a0 request={\u00a0 \u00a0 \u00a0 \u00a0 \"project_id\": project_id,\u00a0 \u00a0 \u00a0 \u00a0 \"region\": region,\u00a0 \u00a0 \u00a0 \u00a0 \"cluster_name\": cluster_name,\u00a0 \u00a0 })operation.result()print(f\"Cluster {cluster_name} successfully deleted.\")\n```", "guide": "Dataproc"}