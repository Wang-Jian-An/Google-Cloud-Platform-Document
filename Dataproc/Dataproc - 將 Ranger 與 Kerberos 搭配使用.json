{"title": "Dataproc - \u5c07 Ranger \u8207 Kerberos \u642d\u914d\u4f7f\u7528", "url": "https://cloud.google.com/dataproc/docs/concepts/components/ranger-w-kerberos?hl=zh-cn", "abstract": "# Dataproc - \u5c07 Ranger \u8207 Kerberos \u642d\u914d\u4f7f\u7528\n\u4ee5\u4e0b\u793a\u4f8b\u901a\u904e [Ranger](https://cloud.google.com/dataproc/docs/concepts/components/ranger?hl=zh-cn) \u548c [Solr](https://cloud.google.com/dataproc/docs/concepts/components/solr?hl=zh-cn) \u7d44\u4ef6\u5275\u5efa\u548c\u4f7f\u7528 [\u5df2\u5553\u7528 Kerberos](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/security?hl=zh-cn) \u7684 Dataproc \u96c6\u7fa3\uff0c\u4ee5\u63a7\u5236\u7528\u6236\u5c0d Hadoop\u3001YARN \u548c HIVE \u8cc7\u6e90\u7684\u8a2a\u554f\u6b0a\u9650\u3002\n\u5099\u8a3b\uff1a\n- \u60a8\u53ef\u4ee5\u901a\u904e [\u7d44\u4ef6\u7db2\u95dc](https://cloud.google.com/dataproc/docs/concepts/accessing/dataproc-gateways?hl=zh-cn) \u8a2a\u554f Ranger \u7db2\u9801\u754c\u9762\u3002\n- \u5728\u5305\u542b Kerberos \u96c6\u7fa3\u7684 Ranger \u4e2d\uff0cDataproc \u901a\u904e\u522a\u9664 Kerberos \u7528\u6236\u7684\u9818\u57df\u548c\u5be6\u4f8b\u5c07 Kerberos \u7528\u6236\u6620\u5c04\u5230\u7cfb\u7d71\u7528\u6236\u3002\u4f8b\u5982\uff0cKerberos \u4e3b\u8cec\u865f `user1/cluster-m@MY.REALM` \u88ab\u6620\u5c04\u5230\u7cfb\u7d71 `user1` \uff0c\u4e14\u7cfb\u7d71\u5b9a\u7fa9\u4e86 Ranger \u653f\u7b56\u4ee5\u5141\u8a31\u6216\u62d2\u7d55 `user1` \u7684\u6b0a\u9650\u3002\n- [\u8a2d\u7f6e Ranger \u7ba1\u7406\u54e1\u5bc6\u78bc](https://cloud.google.com/dataproc/docs/concepts/components/ranger?hl=zh-cn#installation_steps) \u3002\n- [\u8a2d\u7f6e Kerberos Root \u4e3b\u8cec\u865f\u5bc6\u78bc](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/security?hl=zh-cn#set_up_your_kerberos_root_principal_password) \u3002\n- \u5275\u5efa\u96c6\u7fa3\u3002- \u4ee5\u4e0b`gcloud`\u547d\u4ee4\u53ef\u4ee5\u5728\u672c\u5730\u7d42\u7aef\u7a97\u53e3\u4e2d\u904b\u884c\uff0c\u4e5f\u53ef\u4ee5\u5f9e\u9805\u76ee\u7684 [Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn) \u4e2d\u904b\u884c\u3002```\ngcloud dataproc clusters create cluster-name \\\n\u00a0\u00a0\u00a0\u00a0--region=region \\\n\u00a0\u00a0\u00a0\u00a0--optional-components=SOLR,RANGER \\\n\u00a0\u00a0\u00a0\u00a0--enable-component-gateway \\\n\u00a0\u00a0\u00a0\u00a0--properties=\"dataproc:ranger.kms.key.uri=projects/project-id/locations/global/keyRings/keyring/cryptoKeys/key,dataproc:ranger.admin.password.uri=gs://bucket/admin-password.encrypted\" \\\n\u00a0\u00a0\u00a0\u00a0--kerberos-root-principal-password-uri=gs://bucket/kerberos-root-principal-password.encrypted \\\n\u00a0\u00a0\u00a0\u00a0--kerberos-kms-key=projects/project-id/locations/global/keyRings/keyring/cryptoKeys/key\n```\n- \u96c6\u7fa3\u904b\u884c\u5f8c\uff0c\u524d\u5f80 Google Cloud \u63a7\u5236\u6aaf\u4e0a\u7684 Dataproc [\u96c6\u7fa3](https://console.cloud.google.com/dataproc/clusters?hl=zh-cn) \u9801\u9762\uff0c\u7136\u5f8c\u9078\u64c7\u96c6\u7fa3\u540d\u7a31\u4ee5\u6253\u958b **\u96c6\u7fa3\u8a73\u60c5** \u9801\u9762\u3002\u9ede\u64ca **\u7db2\u9801\u754c\u9762** \u6a19\u7c64\u9801\u4ee5\u986f\u793a\u7d44\u4ef6\u7db2\u95dc\u93c8\u63a5\u5217\u8868\uff0c\u9019\u4e9b\u93c8\u63a5\u6307\u5411\u5b89\u88dd\u5728\u96c6\u7fa3\u4e0a\u7684 [\u9ed8\u8a8d\u7d44\u4ef6\u548c\u53ef\u9078\u7d44\u4ef6](https://cloud.google.com/dataproc/docs/concepts/components/overview?hl=zh-cn) \u7684\u7db2\u9801\u754c\u9762\u3002\u9ede\u64ca Ranger \u93c8\u63a5\u3002\n- \u901a\u904e\u8f38\u5165\u201cadmin\u201d\u7528\u6236\u540d\u548c Ranger \u7ba1\u7406\u54e1\u5bc6\u78bc\u767b\u9304\u5230 Ranger\u3002\n- Ranger \u7ba1\u7406\u754c\u9762\u6703\u5728\u672c\u5730\u700f\u89bd\u5668\u4e2d\u6253\u958b\u3002\n\u4ee5\u4e0b\u793a\u4f8b\u5275\u5efa Ranger \u653f\u7b56\uff0c\u4ee5\u5141\u8a31\u6216\u62d2\u7d55\u8a2a\u554f\u5169\u500b\u64cd\u4f5c\u7cfb\u7d71\u7528\u6236\u548c Kerberos \u4e3b\u5e33\u865f\uff1a`userone`\u548c`usertwo`\u3002\n#", "content": "## YARN \u8a2a\u554f\u653f\u7b56\n\u6b64\u793a\u4f8b\u5275\u5efa\u4e86\u4e00\u500b Ranger \u653f\u7b56\uff0c\u4ee5\u5141\u8a31\u548c\u62d2\u7d55\u7528\u6236\u8a2a\u554f [YARN root.default \u968a\u5217](https://hadoop.apache.org/docs/current/hadoop-yarn/hadoop-yarn-site/CapacityScheduler.html#Configuration) \u3002\n- \u5f9e Ranger \u7ba1\u7406\u754c\u9762\u4e2d\u9078\u64c7 `yarn-dataproc` \u3002\n- \u5728 **yarn-dataproc \u653f\u7b56** \u9801\u9762\u4e0a\uff0c\u9ede\u64ca **\u6dfb\u52a0\u65b0\u653f\u7b56** \u3002 \u5728 **\u5275\u5efa\u653f\u7b56** \u9801\u9762\u4e0a\uff0c\u8f38\u5165\u6216\u9078\u64c7\u4ee5\u4e0b\u5b57\u6bb5\uff1a- `Policy Name`\uff1a\u201cyarn-policy-1\u201d\n- `Queue`\uff1a\u201croot.default\u201d\n- `Audit Logging`\uff1a\u201c\u662f\u201d\n- `Allow Conditions`\uff1a- `Select User`\uff1a\u201cuserone\u201d\n- `Permissions`\uff1a\u201c\u5168\u9078\u201d\uff08\u6388\u4e88\u6240\u6709\u6b0a\u9650\uff09\n- `Deny Conditions` :- `Select User`\uff1a\u201cusertwo\u201d\n- `Permissions`\uff1a\u201c\u5168\u9078\u201d\uff08\u62d2\u7d55\u6240\u6709\u6b0a\u9650\uff09\n\u9ede\u64ca **\u6dfb\u52a0** \u4ee5\u4fdd\u5b58\u653f\u7b56\u3002\u8a72\u653f\u7b56\u5217\u5728 **yarn-dataproc \u653f\u7b56** \u9801\u9762\u4e0a\uff1a\n- \u5728\u4e3b SSH \u6703\u8a71\u7a97\u53e3\u4e2d\u4ee5 userone \u8eab\u4efd\u904b\u884c Hadoop mapreduce \u4f5c\u696d\uff1a```\nuserone@example-cluster-m:~$ hadoop jar /usr/lib/hadoop-mapreduce/hadoop-mapreduced-examples.\njar pi 5 10\n```- Ranger \u754c\u9762\u986f\u793a\u5141\u8a31`userone`\u63d0\u4ea4\u4f5c\u696d\u3002\n- \u5f9e\u865b\u64ec\u6a5f\u7684\u4e3b SSH \u6703\u8a71\u7a97\u53e3\u4ee5 `usertwo` \u8eab\u4efd\u904b\u884c Hadoop mapreduce \u4f5c\u696d\uff1a```\nusertwo@example-cluster-m:~$ hadoop jar /usr/lib/hadoop-mapreduce/hadoop-mapreduced-examples.\njar pi 5 10\n```- Ranger \u754c\u9762\u986f\u793a\uff0c\u7cfb\u7d71\u5df2\u62d2\u7d55`usertwo`\u63d0\u4ea4\u4f5c\u696d\u3002\n### HDFS \u8a2a\u554f\u653f\u7b56\n\u6b64\u793a\u4f8b\u5275\u5efa\u4e86\u4e00\u500b Ranger \u653f\u7b56\uff0c\u4ee5\u5141\u8a31\u548c\u62d2\u7d55\u7528\u6236\u5c0d HDFS `/tmp` \u76ee\u9304\u7684\u8a2a\u554f\u3002\n- \u5f9e Ranger \u7ba1\u7406\u754c\u9762\u4e2d\u9078\u64c7 `hadoop-dataproc` \u3002\n- \u5728 **hadoop-dataproc \u653f\u7b56** \u9801\u9762\u4e0a\uff0c\u9ede\u64ca **\u6dfb\u52a0\u65b0\u653f\u7b56** \u3002 \u5728 **\u5275\u5efa\u653f\u7b56** \u9801\u9762\u4e0a\uff0c\u8f38\u5165\u6216\u9078\u64c7\u4ee5\u4e0b\u5b57\u6bb5\uff1a- `Policy Name`\uff1a\u201chadoop-policy-1\u201d\n- `Resource Path`\uff1a\u201c/tmp\u201d\n- `Audit Logging`\uff1a\u201c\u662f\u201d\n- `Allow Conditions`\uff1a- `Select User`\uff1a\u201cuserone\u201d\n- `Permissions`\uff1a\u201c\u5168\u9078\u201d\uff08\u6388\u4e88\u6240\u6709\u6b0a\u9650\uff09\n- `Deny Conditions` :- `Select User`\uff1a\u201cusertwo\u201d\n- `Permissions`\uff1a\u201c\u5168\u9078\u201d\uff08\u62d2\u7d55\u6240\u6709\u6b0a\u9650\uff09\n\u9ede\u64ca **\u6dfb\u52a0** \u4ee5\u4fdd\u5b58\u653f\u7b56\u3002\u8a72\u653f\u7b56\u5217\u5728 **hadoop-dataproc \u653f\u7b56** \u9801\u9762\u4e0a\uff1a\n- \u4ee5 userone \u8eab\u4efd\u8a2a\u554f HDFS `/tmp` \u76ee\u9304\uff1a```\nuserone@example-cluster-m:~$ hadoop fs -ls /tmp\n```- Ranger \u754c\u9762\u986f\u793a\uff0c\u7cfb\u7d71\u5141\u8a31`userone`\u8a2a\u554f HDFS /tmp \u76ee\u9304\u3002\n- \u4ee5 `usertwo` \u8eab\u4efd\u8a2a\u554f HDFS `/tmp` \u76ee\u9304\uff1a```\nusertwo@example-cluster-m:~$ hadoop fs -ls /tmp\n```- Ranger \u754c\u9762\u986f\u793a`usertwo`\u88ab\u62d2\u7d55\u8a2a\u554f HDFS /tmp \u76ee\u9304\u3002\n### Hive \u8a2a\u554f\u653f\u7b56\n\u6b64\u793a\u4f8b\u5275\u5efa\u4e86\u4e00\u500b Ranger \u653f\u7b56\uff0c\u4ee5\u5141\u8a31\u548c\u62d2\u7d55\u7528\u6236\u8a2a\u554f Hive \u8868\u3002\n- \u5728\u4e3b\u5be6\u4f8b\u4e0a\u4f7f\u7528 Hive CLI \u5275\u5efa\u4e00\u500b\u5c0f\u578b\u7684 `employee` \u8868\u3002```\nhive> CREATE TABLE IF NOT EXISTS employee (eid int, name String); INSERT INTO employee VALUES (1 , 'bob') , (2 , 'alice'), (3 , 'john');\n```\n- \u5f9e Ranger \u7ba1\u7406\u754c\u9762\u4e2d\u9078\u64c7 `hive-dataproc` \u3002\n- \u5728 **hive-dataproc \u653f\u7b56** \u9801\u9762\u4e0a\uff0c\u9ede\u64ca **\u6dfb\u52a0\u65b0\u653f\u7b56** \u3002 \u5728 **\u5275\u5efa\u653f\u7b56** \u9801\u9762\u4e0a\uff0c\u8f38\u5165\u6216\u9078\u64c7\u4ee5\u4e0b\u5b57\u6bb5\uff1a- `Policy Name`\uff1a\u201chive-policy-1\u201d\n- `database`\uff1a\u201c\u9ed8\u8a8d\u201d\n- `table`\uff1a\u201c\u54e1\u5de5\u201d\n- `Hive Column`\uff1a\u201c*\u201d\n- `Audit Logging`\uff1a\u201c\u662f\u201d\n- `Allow Conditions`\uff1a- `Select User`\uff1a\u201cuserone\u201d\n- `Permissions`\uff1a\u201c\u5168\u9078\u201d\uff08\u6388\u4e88\u6240\u6709\u6b0a\u9650\uff09\n- `Deny Conditions` :- `Select User`\uff1a\u201cusertwo\u201d\n- `Permissions`\uff1a\u201c\u5168\u9078\u201d\uff08\u62d2\u7d55\u6240\u6709\u6b0a\u9650\uff09\n\u9ede\u64ca **\u6dfb\u52a0** \u4ee5\u4fdd\u5b58\u653f\u7b56\u3002\u8a72\u653f\u7b56\u5217\u5728 **hive-dataproc \u653f\u7b56** \u9801\u9762\u4e0a\uff1a\n- \u5728\u865b\u64ec\u6a5f\u7684\u4e3b SSH \u6703\u8a71\u4e2d\u4ee5 userone \u8eab\u4efd\u91dd\u5c0d Hive \u54e1\u5de5\u8868\u904b\u884c\u67e5\u8a62\uff1a```\nuserone@example-cluster-m:~$ beeline -u \"jdbc:hive2://$(hostname -f):10000/default;principal=hive/$(hostname -f)@REALM\" -e \"select * from employee;\"\n```- userone \u67e5\u8a62\u6210\u529f\uff1a```\nConnected to: Apache Hive (version 2.3.6)\nDriver: Hive JDBC (version 2.3.6)\nTransaction isolation: TRANSACTION_REPEATABLE_READ\n+---------------+----------------+\n| employee.eid | employee.name |\n+---------------+----------------+\n| 1    | bob   |\n| 2    | alice   |\n| 3    | john   |\n+---------------+----------------+\n3 rows selected (2.033 seconds)\n```\n- \u5728\u865b\u64ec\u6a5f\u7684\u4e3b SSH \u6703\u8a71\u4e2d\u4ee5 usertwo \u8eab\u4efd\u91dd\u5c0d Hive \u54e1\u5de5\u8868\u904b\u884c\u67e5\u8a62\uff1a```\nusertwo@example-cluster-m:~$ beeline -u \"jdbc:hive2://$(hostname -f):10000/default;principal=hive/$(hostname -f)@REALM\" -e \"select * from employee;\"\n```- \u62d2\u7d55 usertwo \u8a2a\u554f\u8a72\u8868\uff1a```\nError: Could not open client transport with JDBC Uri:\n...\nPermission denied: user=usertwo, access=EXECUTE, inode=\"/tmp/hive\"\n```\n### \u7cbe\u7d30 Hive \u8a2a\u554f\nRanger \u652f\u6301\u5728 Hive \u4e0a\u4f7f\u7528\u906e\u7f69\u548c\u884c\u7d1a\u904e\u6ffe\u689d\u4ef6\u3002\u6b64\u793a\u4f8b\u662f\u901a\u904e\u6dfb\u52a0\u906e\u7f69\u548c\u904e\u6ffe\u689d\u4ef6\u653f\u7b56\u57fa\u65bc\u4e0a\u4e00\u500b `hive-policy-1` \u69cb\u5efa\u7684\u3002\n- \u5f9e Ranger \u7ba1\u7406\u754c\u9762\u4e2d\u9078\u64c7 `hive-dataproc` \uff0c\u7136\u5f8c\u9078\u64c7 **\u906e\u7f69** \u6a19\u7c64\uff0c\u9ede\u64ca **\u6dfb\u52a0\u65b0\u653f\u7b56** \u3002- \u5728 **\u5275\u5efa\u653f\u7b56** \u9801\u9762\u4e2d\uff0c\u8f38\u5165\u6216\u9078\u64c7\u4ee5\u4e0b\u5b57\u6bb5\u4f86\u5275\u5efa\u4e00\u500b\u653f\u7b56\u7528\u4f86\u63a9\u84cb\uff08\u53d6\u6d88\uff09\u54e1\u5de5\u59d3\u540d\u5217\uff1a- `Policy Name`\uff1a\u201chive-masking \u653f\u7b56\u201d\n- `database`\uff1a\u201c\u9ed8\u8a8d\u201d\n- `table`\uff1a\u201c\u54e1\u5de5\u201d\n- `Hive Column`\uff1a\u201c\u59d3\u540d\u201d\n- `Audit Logging`\uff1a\u201c\u662f\u201d\n- `Mask Conditions`\uff1a- `Select User`\uff1a\u201cuserone\u201d\n- `Access Types`\uff1a\u201c\u9078\u64c7\u201d\uff08\u6dfb\u52a0/\u4fee\u6539\u6b0a\u9650\uff09\n- `Select Masking Option`\uff1a\u201c\u53d6\u6d88\u201d\u9ede\u64ca **\u6dfb\u52a0** \u4ee5\u4fdd\u5b58\u653f\u7b56\u3002\n- \u5f9e Ranger \u7ba1\u7406\u754c\u9762\u4e2d\u9078\u64c7 `hive-dataproc` \uff0c\u7136\u5f8c\u9078\u64c7 **\u884c\u7d1a\u904e\u6ffe\u689d\u4ef6** \u6a19\u7c64\uff0c\u9ede\u64ca **\u6dfb\u52a0\u65b0\u653f\u7b56** \u3002- \u5728 **\u5275\u5efa\u653f\u7b56** \u9801\u9762\u4e2d\uff0c\u8f38\u5165\u6216\u9078\u64c7\u4ee5\u4e0b\u5b57\u6bb5\u4f86\u5275\u5efa\u4e00\u500b\u653f\u7b56\u7528\u4f86\u904e\u6ffe\uff08\u8fd4\u56de\uff09 `eid` \u4e0d\u7b49\u65bc `1` \u7684\u884c\uff1a- `Policy Name`\uff1a\u201chive-filter \u653f\u7b56\u201d\n- `Hive Database`\uff1a\u201c\u9ed8\u8a8d\u201d\n- `Hive Table`\uff1a\u201c\u54e1\u5de5\u201d\n- `Audit Logging`\uff1a\u201c\u662f\u201d\n- `Mask Conditions`\uff1a- `Select User`\uff1a\u201cuserone\u201d\n- `Access Types`\uff1a\u201c\u9078\u64c7\u201d\uff08\u6dfb\u52a0/\u4fee\u6539\u6b0a\u9650\uff09\n- `Row Level Filter`\uff1a\u201ceid != 1\u201d\u904e\u6ffe\u689d\u4ef6\u8868\u9054\u5f0f\u9ede\u64ca **\u6dfb\u52a0** \u4ee5\u4fdd\u5b58\u653f\u7b56\u3002\n- \u5728\u865b\u64ec\u6a5f\u7684\u4e3b SSH \u6703\u8a71\u4e2d\u4ee5 userone \u8eab\u4efd\u91dd\u5c0d Hive \u54e1\u5de5\u8868\u904b\u884c\u4e0a\u4e00\u67e5\u8a62\uff1a```\nuserone@example-cluster-m:~$ beeline -u \"jdbc:hive2://$(hostname -f):10000/default;principal=hive/$(hostname -f)@REALM\" -e \"select * from employee;\"\n```- \u67e5\u8a62\u5c07\u8fd4\u56de\u906e\u84cb\u4e86\u7684\u540d\u7a31\u5217\u4ee5\u53ca\u5f9e\u7d50\u679c\u4e2d\u6ffe\u9664\u7684 bob (eid=1)\uff1a```\nTransaction isolation: TRANSACTION_REPEATABLE_READ\n+---------------+----------------+\n| employee.eid | employee.name |\n+---------------+----------------+\n| 2    | NULL   |\n| 3    | NULL   |\n+---------------+----------------+\n2 rows selected (0.47 seconds)\n```", "guide": "Dataproc"}