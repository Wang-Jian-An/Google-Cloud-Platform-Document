{"title": "Dataproc - Ranger Cloud Storage \u63d2\u4ef6", "url": "https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/ranger-plugin?hl=zh-cn", "abstract": "# Dataproc - Ranger Cloud Storage \u63d2\u4ef6\nDataproc Ranger Cloud Storage \u63d2\u4ef6\uff08\u9069\u7528\u65bc Dataproc \u6620\u50cf\u7248\u672c 1.5 \u548c 2.0\uff09\u53ef\u5728\u6bcf\u500b Dataproc \u96c6\u7fa3\u865b\u64ec\u6a5f\u4e0a\u6fc0\u6d3b\u6388\u6b0a\u670d\u52d9\u3002\u6388\u6b0a\u670d\u52d9\u6839\u64da Ranger \u653f\u7b56\u8a55\u4f30\u4f86\u81ea [Cloud Storage \u9023\u63a5\u5668](https://cloud.google.com/dataproc/docs/concepts/connectors/cloud-storage?hl=zh-cn) \u7684\u8acb\u6c42\uff0c\u5982\u679c\u5141\u8a31\u8acb\u6c42\uff0c\u5247\u8fd4\u56de\u96c6\u7fa3 [\u865b\u64ec\u6a5f\u670d\u52d9\u5e33\u865f](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/service-accounts?hl=zh-cn#VM_service_account) \u7684\u8a2a\u554f\u4ee4\u724c\u3002\nRanger Cloud Storage \u63d2\u4ef6\u4f9d\u8cf4 [Kerberos](https://web.mit.edu/kerberos/) \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u4e26\u8207 Cloud Storage \u9023\u63a5\u5668\u5c0d\u59d4\u8a17\u4ee4\u724c\u7684\u652f\u6301\u9032\u884c\u4e86\u96c6\u6210\u3002\u59d4\u6d3e\u4ee4\u724c\u5b58\u5132\u5728\u96c6\u7fa3\u4e3b\u670d\u52d9\u5668\u7bc0\u9ede\u4e0a\u7684 [MySQL](https://dev.mysql.com/doc/refman/5.7/en/) \u6578\u64da\u5eab\u4e2d\u3002\u6578\u64da\u5eab\u7684\u6839\u5bc6\u78bc\u662f\u5728 [\u5275\u5efa Dataproc \u96c6\u7fa3](#create_a_dataproc_cluster) \u6642\u901a\u904e\u96c6\u7fa3\u5c6c\u6027\u6307\u5b9a\u7684\u3002\n\u4f7f\u7528\u9ed8\u8a8d\u7684 **KMS \u5c0d\u7a31\u52a0\u5bc6** \uff08\u5305\u62ec\u6d88\u606f\u8eab\u4efd\u9a57\u8b49\uff09\u3002\u8acb\u52ff\u4f7f\u7528\u975e\u5c0d\u7a31\u5bc6\u9470\u3002\n", "content": "## \u6e96\u5099\u5de5\u4f5c\n\u5728\u9805\u76ee\u4e2d\u7232 [Dataproc \u865b\u64ec\u6a5f\u670d\u52d9\u5e33\u865f](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/service-accounts?hl=zh-cn#VM_service_account) \u6388\u4e88 [Service Account Token Creator](https://cloud.google.com/iam/docs/understanding-roles?hl=zh-cn#iam.serviceAccountTokenCreator) \u89d2\u8272\u548c [IAM Role Admin](https://cloud.google.com/iam/docs/understanding-roles?hl=zh-cn#iam.roleAdmin) \u89d2\u8272\u3002\n## \u5b89\u88dd Ranger Cloud Storage \u63d2\u4ef6\n\u5275\u5efa Dataproc \u96c6\u7fa3\u6642\uff0c\u5728\u672c\u5730\u7d42\u7aef\u7a97\u53e3\u6216 [Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn) \u4e2d\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u4ee5\u5b89\u88dd Ranger Cloud Storage \u63d2\u4ef6\u3002\n### \u8a2d\u7f6e\u74b0\u5883\u8b8a\u91cf\n```\nexport CLUSTER_NAME=new-cluster-name \\\n\u00a0\u00a0\u00a0\u00a0export REGION=region \\\n\u00a0\u00a0\u00a0\u00a0export KERBEROS_KMS_KEY_URI=Kerberos-KMS-key-URI \\\n\u00a0\u00a0\u00a0\u00a0export KERBEROS_PASSWORD_URI=Kerberos-password-URI \\\n\u00a0\u00a0\u00a0\u00a0export RANGER_ADMIN_PASSWORD_KMS_KEY_URI=Ranger-admin-password-KMS-key-URI \\\n\u00a0\u00a0\u00a0\u00a0export RANGER_ADMIN_PASSWORD_GCS_URI=Ranger-admin-password-GCS-URI \\\n\u00a0\u00a0\u00a0\u00a0export RANGER_GCS_PLUGIN_MYSQL_KMS_KEY_URI=MySQL-root-password-KMS-key-URI \\\n\u00a0\u00a0\u00a0\u00a0export RANGER_GCS_PLUGIN_MYSQL_PASSWORD_URI=MySQL-root-password-GCS-URI\n```\n\u5099\u8a3b\uff1a\n- CLUSTER_NAME\uff1a\u65b0\u96c6\u7fa3\u7684\u540d\u7a31\u3002\n- REGION\uff1a\u5c07\u5728\u5176\u4e2d\u5275\u5efa\u96c6\u7fa3\u7684 [\u5340\u57df](https://cloud.google.com/compute/docs/regions-zones?hl=zh-cn#available) \uff0c\u4f8b\u5982`us-west1`\u3002\n- KERBEROS_KMS_KEY_URI \u548c KERBEROS_PASSWORD_URI\uff1a\u8acb\u53c3\u95b1 [\u8a2d\u7f6e\u60a8\u7684 Kerberos root \u4e3b\u5e33\u865f\u5bc6\u78bc](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/security?hl=zh-cn#set_up_your_kerberos_root_principal_password) \u3002\n- RANGER_ADMIN_PASSWORD_KMS_KEY_URI \u548c RANGER_ADMIN_PASSWORD_GCS_URI\uff1a\u8acb\u53c3\u95b1 [\u8a2d\u7f6e\u60a8\u7684 Ranger \u7ba1\u7406\u54e1\u5bc6\u78bc](https://cloud.google.com/dataproc/docs/concepts/components/ranger?hl=zh-cn#installation_steps) \u3002\n- RANGER_GCS_PLUGIN_MYSQL_KMS_KEY_URI \u548c RANGER_GCS_PLUGIN_MYSQL_PASSWORD_URI\uff1a\u6309\u7167 [\u8a2d\u7f6e Ranger \u7ba1\u7406\u54e1\u5bc6\u78bc](https://cloud.google.com/dataproc/docs/concepts/components/ranger?hl=zh-cn#installation_steps) \u7684\u6b65\u9a5f\u8a2d\u7f6e MySQL \u5bc6\u78bc\u3002\n### \u5275\u5efa Dataproc \u96c6\u7fa3\n\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u5275\u5efa Dataproc \u96c6\u7fa3\uff0c\u4e26\u5728\u8a72\u96c6\u7fa3\u4e0a\u5b89\u88dd Ranger Cloud Storage \u63d2\u4ef6\u3002\n```\ngcloud dataproc clusters create ${CLUSTER_NAME} \\\n\u00a0\u00a0\u00a0\u00a0--region=${REGION} \\\n\u00a0\u00a0\u00a0\u00a0--scopes cloud-platform \\\n\u00a0\u00a0\u00a0\u00a0--enable-component-gateway \\\n\u00a0\u00a0\u00a0\u00a0--optional-components=SOLR,RANGER \\\n\u00a0\u00a0\u00a0\u00a0--kerberos-kms-key=${KERBEROS_KMS_KEY_URI} \\\n\u00a0\u00a0\u00a0\u00a0--kerberos-root-principal-password-uri=${KERBEROS_PASSWORD_URI} \\\n\u00a0\u00a0\u00a0\u00a0--properties=\"dataproc:ranger.gcs.plugin.enable=true, \\\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dataproc:ranger.kms.key.uri=${RANGER_ADMIN_PASSWORD_KMS_KEY_URI}, \\\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dataproc:ranger.admin.password.uri=${RANGER_ADMIN_PASSWORD_GCS_URI}, \\\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dataproc:ranger.gcs.plugin.mysql.kms.key.uri=${RANGER_GCS_PLUGIN_MYSQL_KMS_KEY_URI}, \\\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0dataproc:ranger.gcs.plugin.mysql.password.uri=${RANGER_GCS_PLUGIN_MYSQL_PASSWORD_URI}\"\n```\n\u5099\u8a3b\uff1a\n- **1.5 \u6620\u50cf\u7248\u672c** \uff1a\u5982\u679c\u60a8\u8981\u5275\u5efa 1.5 \u6620\u50cf\u7248\u672c\u7684\u96c6\u7fa3\uff08\u8acb\u53c3\u95b1 [\u9078\u64c7\u7248\u672c](https://cloud.google.com/dataproc/docs/concepts/versioning/overview?hl=zh-cn#selecting_versions) \uff09\uff0c\u8acb\u6dfb\u52a0`--metadata=GCS_CONNECTOR_VERSION=` ``\u6a19\u8a8c\u4ee5\u5b89\u88dd\u6240\u9700\u7684\u9023\u63a5\u5668\u7248\u672c\u3002\n### \u9a57\u8b49 Ranger Cloud Storage \u63d2\u4ef6\u5b89\u88dd\n\u96c6\u7fa3\u5275\u5efa\u5b8c\u6210\u5f8c\uff0c [Ranger \u7ba1\u7406\u7db2\u9801\u754c\u9762](https://cloud.google.com/dataproc/docs/concepts/accessing/dataproc-gateways?hl=zh-cn#viewing_and_accessing_component_gateway_urls) \u4e2d\u6703\u986f\u793a\u540d\u7232 `gcs-dataproc` \u7684 `GCS` \u670d\u52d9\u985e\u578b\u3002\n## Ranger Cloud Storage \u63d2\u4ef6\u9ed8\u8a8d\u653f\u7b56\n\u9ed8\u8a8d `gcs-dataproc` \u670d\u52d9\u5177\u6709\u4ee5\u4e0b\u653f\u7b56\uff1a\n- \u8981\u8b80\u53d6\u548c\u5beb\u5165 Dataproc \u96c6\u7fa3 [\u66ab\u5b58\u548c\u81e8\u6642\u5b58\u5132\u5206\u5340](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/staging-bucket?hl=zh-cn) \u7684\u653f\u7b56\n- `all - bucket, object-path` \u653f\u7b56\uff1a\u5141\u8a31\u6240\u6709\u7528\u6236\u8a2a\u554f\u6240\u6709\u5c0d\u8c61\u7684\u5143\u6578\u64da\u3002\u5fc5\u9808\u5177\u5099\u6b64\u8a2a\u554f\u6b0a\u9650\uff0cCloud Storage \u9023\u63a5\u5668\u624d\u80fd\u57f7\u884c HCFS\uff08 [Hadoop \u517c\u5bb9\u6587\u4ef6\u7cfb\u7d71](https://cwiki.apache.org/confluence/display/HADOOP2/HCFS) \uff09\u64cd\u4f5c\u3002\n## \u4f7f\u7528\u63d0\u793a\n### \u61c9\u7528\u5c0d\u5b58\u5132\u6876\u6587\u4ef6\u593e\u7684\u8a2a\u554f\u6b0a\u9650\n\u7232\u4e86\u9069\u61c9\u5728 Cloud Storage \u5b58\u5132\u6876\u4e2d\u5275\u5efa\u4e2d\u9593\u6587\u4ef6\u7684\u61c9\u7528\uff0c\u60a8\u53ef\u4ee5\u6388\u4e88 Cloud Storage \u5b58\u5132\u6876\u8def\u5f91\u7684 `Modify Objects` \u3001 `List Objects` \u548c `Delete Objects` \u6b0a\u9650\uff0c\u7136\u5f8c\u9078\u64c7 `recursive` \u6a21\u5f0f\u4ee5\u5c07\u6b0a\u9650\u64f4\u5c55\u5230\u6307\u5b9a\u8def\u5f91\u4e0a\u7684\u5b50\u8def\u5f91\u3002\n**\u6ce8\u610f** \uff1a\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cgcloud CLI \u4f5c\u696d\u53ef\u4ee5\u8a2a\u554f\u6240\u6709 Cloud Storage \u8cc7\u6e90\u3002### \u4fdd\u8b77\u63aa\u65bd\n\u7232\u5e6b\u52a9\u9632\u6b62\u63d2\u4ef6\u88ab\u898f\u907f\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u60a8\u53ef\u4ee5\u5411 [\u865b\u64ec\u6a5f\u670d\u52d9\u5e33\u865f](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/service-accounts?hl=zh-cn#VM_service_account) \u6388\u4e88\u5c0d Cloud Storage \u5b58\u5132\u5206\u5340\u4e2d\u8cc7\u6e90\u7684\u8a2a\u554f\u6b0a\u9650\uff0c\u4ee5\u4fbf\u5176\u4f7f\u7528\u7e2e\u5c0f\u7bc4\u570d\u7684\u8a2a\u554f\u4ee4\u724c\u6388\u4e88\u5c0d\u9019\u4e9b\u8cc7\u6e90\u7684\u8a2a\u554f\u6b0a\u9650\uff08\u8acb\u53c3\u95b1 [Cloud Storage \u7684 IAM \u6b0a\u9650](https://cloud.google.com/storage/docs/access-control/iam-permissions?hl=zh-cn#object_permissions) \uff09\u3002\u6b64\u5916\uff0c\u8acb\u79fb\u9664\u7528\u6236\u5c0d\u5b58\u5132\u6876\u8cc7\u6e90\u7684\u8a2a\u554f\u6b0a\u9650\uff0c\u4ee5\u907f\u514d\u7528\u6236\u76f4\u63a5\u8a2a\u554f\u5b58\u5132\u6876\u3002\n- \u505c\u7528\u96c6\u7fa3\u865b\u64ec\u6a5f\u4e0a\u7684 `sudo` \u548c\u5176\u4ed6\u6839\u8a2a\u554f\u6b0a\u9650\uff08\u5305\u62ec\u66f4\u65b0 `sudoer` \u6587\u4ef6\uff09\uff0c\u4ee5\u9632\u6b62\u5192\u5145\u5225\u4eba\u6216\u66f4\u6539\u8eab\u4efd\u9a57\u8b49\u548c\u6388\u6b0a\u8a2d\u7f6e\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1\u6709\u95dc\u6dfb\u52a0/\u79fb\u9664 `sudo` \u7528\u6236\u6b0a\u9650\u7684 Linux \u8aaa\u660e\u3002\n- \u4f7f\u7528 `iptable` \u963b\u6b62\u96c6\u7fa3\u865b\u64ec\u6a5f\u5c0d Cloud Storage \u7684\u76f4\u63a5\u8a2a\u554f\u8acb\u6c42\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u963b\u6b62\u5c0d\u865b\u64ec\u6a5f\u5143\u6578\u64da\u670d\u52d9\u5668\u7684\u8a2a\u554f\uff0c\u4ee5\u9632\u6b62\u8a2a\u554f\u7528\u65bc\u5c0d Cloud Storage \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u548c\u6388\u6b0a\u8a2a\u554f\u7684\u865b\u64ec\u6a5f\u670d\u52d9\u5e33\u865f\u6191\u64da\u6216\u8a2a\u554f\u4ee4\u724c\uff08\u8acb\u53c3\u95b1 [block_vm_metadata_server.sh](https://github.com/GoogleCloudDataproc/initialization-actions/blob/master/ranger/block_vm_metadata_server.sh) \uff0c\u9019\u662f\u4e00\u500b\u4f7f\u7528 `iptable` \u898f\u5247\u963b\u6b62\u8a2a\u554f\u865b\u64ec\u6a5f\u5143\u6578\u64da\u670d\u52d9\u5668\u7684 [\u521d\u59cb\u5316\u8173\u672c](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/init-actions?hl=zh-cn) \uff09\u3002\n### Spark\u3001Hive-on-MapReduce \u548c Hive-on-Tez \u4f5c\u696d\n\u7232\u4e86\u4fdd\u8b77\u654f\u611f\u7684\u7528\u6236\u8eab\u4efd\u9a57\u8b49\u8a73\u7d30\u4fe1\u606f\u4e26\u6e1b\u5c11\u5bc6\u9470\u5206\u767c\u4e2d\u5fc3 (KDC) \u4e0a\u7684\u8ca0\u8f09\uff0cSpark \u9a45\u52d5\u7a0b\u5e8f\u4e0d\u6703\u5c07 Kerberos \u6191\u64da\u5206\u767c\u7d66\u57f7\u884c\u7a0b\u5e8f\u3002\u76f8\u53cd\uff0cSpark \u9a45\u52d5\u7a0b\u5e8f\u5f9e Ranger Cloud Storage \u63d2\u4ef6\u7372\u53d6\u59d4\u8a17\u4ee4\u724c\uff0c\u7136\u5f8c\u5c07\u59d4\u8a17\u4ee4\u724c\u5206\u767c\u7d66\u57f7\u884c\u7a0b\u5e8f\u3002\u57f7\u884c\u5668\u4f7f\u7528\u59d4\u8a17\u4ee4\u724c\u5411 Ranger Cloud Storage \u63d2\u4ef6\u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u4ee5\u63db\u53d6\u5141\u8a31\u8a2a\u554f Cloud Storage \u7684 Google \u8a2a\u554f\u4ee4\u724c\u3002\nHive-on-MapReduce \u548c Hive-on-Tez \u4f5c\u696d\u4e5f\u4f7f\u7528\u4ee4\u724c\u8a2a\u554f Cloud Storage\u3002\u5728\u63d0\u4ea4\u4ee5\u4e0b\u4f5c\u696d\u985e\u578b\u6642\uff0c\u8acb\u4f7f\u7528\u4ee5\u4e0b\u5c6c\u6027\u7372\u53d6\u7528\u65bc\u8a2a\u554f\u6307\u5b9a Cloud Storage \u5b58\u5132\u5206\u5340\u7684\u4ee4\u724c\uff1a\n- **Spark \u4f5c\u696d** \uff1a```\n--conf spark.yarn.access.hadoopFileSystems=gs://bucket-name,gs://bucket-name,...\n```\n- **Hive-on-MapReduce \u4f5c\u696d** \uff1a```\n--hiveconf \"mapreduce.job.hdfs-servers=gs://bucket-name,gs://bucket-name,...\"\n```\n- **Hive-on-Tez \u4f5c\u696d** \uff1a```\n--hiveconf \"tez.job.fs-servers=gs://bucket-name,gs://bucket-name,...\"\n```## Spark \u4f5c\u696d\u5834\u666f\n\u5f9e\u5b89\u88dd\u4e86 Ranger Cloud Storage \u63d2\u4ef6\u7684 Dataproc \u96c6\u7fa3\u865b\u64ec\u6a5f\u4e0a\u7684\u7d42\u7aef\u7a97\u53e3\u904b\u884c\u6642\uff0cSpark Wordcount \u4f5c\u696d\u6703\u5931\u6557\u3002\n```\nspark-submit \\\n\u00a0\u00a0\u00a0\u00a0--conf spark.yarn.access.hadoopFileSystems=gs://${FILE_BUCKET} \\\n\u00a0\u00a0\u00a0\u00a0--class org.apache.spark.examples.JavaWordCount \\\n\u00a0\u00a0\u00a0\u00a0/usr/lib/spark/examples/jars/spark-examples.jar \\\n\u00a0\u00a0\u00a0\u00a0gs://bucket-name/wordcount.txt\n```\n\u5099\u8a3b\uff1a\n- FILE_BUCKET\uff1a\u7528\u65bc Spark \u8a2a\u554f\u7684 Cloud Storage \u5b58\u5132\u6876\u3002\n\u932f\u8aa4\u8f38\u51fa\uff1a\n```\nCaused by: com.google.gcs.ranger.client.shaded.io.grpc.StatusRuntimeException: PERMISSION_DENIED:\nAccess denied by Ranger policy: User: '<USER>', Bucket: '<dataproc_temp_bucket>',\nObject Path: 'a97127cf-f543-40c3-9851-32f172acc53b/spark-job-history/', Action: 'LIST_OBJECTS'\n```\n\u5099\u8a3b\uff1a\n- \u5728\u5df2\u5553\u7528 Kerberos \u7684\u74b0\u5883\u4e2d\uff0c\u9700\u8981\u4f7f\u7528`spark.yarn.access.hadoopFileSystems=gs://${FILE_BUCKET}`\u3002\n\u932f\u8aa4\u8f38\u51fa\uff1a\n```\nCaused by: java.lang.RuntimeException: Failed creating a SPNEGO token.\nMake sure that you have run `kinit` and that your Kerberos configuration is correct.\nSee the full Kerberos error message: No valid credentials provided\n(Mechanism level: No valid credentials provided)\n```\n\u4f7f\u7528 **Ranger \u7ba1\u7406\u54e1\u7db2\u9801\u754c\u9762** \u4e2d\u7684 **\u8a2a\u554f\u7ba1\u7406\u5668** \u4fee\u6539\u653f\u7b56\uff0c\u5c07 `username` \u6dfb\u52a0\u5230\u5177\u6709 `List Objects` \u548c\u5176\u4ed6 `temp` \u5b58\u5132\u6876\u6b0a\u9650\u7684\u7528\u6236\u5217\u8868\u4e2d\u3002\n\u904b\u884c\u4f5c\u696d\u6703\u751f\u6210\u65b0\u932f\u8aa4\u3002\n\u932f\u8aa4\u8f38\u51fa\uff1a\n```\ncom.google.gcs.ranger.client.shaded.io.grpc.StatusRuntimeException: PERMISSION_DENIED:\nAccess denied by Ranger policy: User: <USER>, Bucket: '<file-bucket>',\nObject Path: 'wordcount.txt', Action: 'READ_OBJECTS'\n```\n\u6dfb\u52a0\u4e86\u4e00\u9805\u653f\u7b56\uff0c\u4ee5\u5411\u7528\u6236\u6388\u4e88\u5c0d `wordcount.text` Cloud Storage \u8def\u5f91\u7684\u8b80\u53d6\u6b0a\u9650\u3002\n\u4f5c\u696d\u904b\u884c\u4f75\u6210\u529f\u5b8c\u6210\u3002\n```\nINFO com.google.cloud.hadoop.fs.gcs.auth.GcsDelegationTokens:\nUsing delegation token RangerGCSAuthorizationServerSessionToken\nowner=<USER>, renewer=yarn, realUser=, issueDate=1654116824281,\nmaxDate=0, sequenceNumber=0, masterKeyId=0\nthis: 1\nis: 1\na: 1\ntext: 1\nfile: 1\n22/06/01 20:54:13 INFO org.sparkproject.jetty.server.AbstractConnector: Stopped\n```", "guide": "Dataproc"}