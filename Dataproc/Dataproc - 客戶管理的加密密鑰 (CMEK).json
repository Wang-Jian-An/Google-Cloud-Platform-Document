{"title": "Dataproc - \u5ba2\u6236\u7ba1\u7406\u7684\u52a0\u5bc6\u5bc6\u9470 (CMEK)", "url": "https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/customer-managed-encryption?hl=zh-cn", "abstract": "# Dataproc - \u5ba2\u6236\u7ba1\u7406\u7684\u52a0\u5bc6\u5bc6\u9470 (CMEK)\n\u4f7f\u7528 Dataproc \u6642\uff0c\u96c6\u7fa3\u548c\u4f5c\u696d\u6578\u64da\u5b58\u5132\u5728\u8207\u96c6\u7fa3\u4e2d\u7684 Compute Engine \u865b\u64ec\u6a5f\u76f8\u95dc\u806f\u7684\u6c38\u4e45\u6027\u78c1\u76e4\u4ee5\u53ca Cloud Storage [\u66ab\u5b58\u5b58\u5132\u6876](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/staging-bucket?hl=zh-cn) \u4e2d\u3002\u6b64\u6c38\u4e45\u6027\u78c1\u76e4\u548c\u5b58\u5132\u6876\u6578\u64da\u4f7f\u7528 Google \u751f\u6210\u7684\u6578\u64da\u52a0\u5bc6\u5bc6\u9470 (DEK) \u548c\u5bc6\u9470\u52a0\u5bc6\u5bc6\u9470 (KEK) \u9032\u884c\u52a0\u5bc6\u3002\n\u85c9\u52a9 CMEK \u529f\u80fd\uff0c\u60a8\u53ef\u4ee5\u5275\u5efa\u3001\u4f7f\u7528\u548c\u64a4\u6d88\u5bc6\u9470\u52a0\u5bc6\u5bc6\u9470 (KEK)\u3002Google \u4ecd\u6703\u63a7\u5236\u6578\u64da\u52a0\u5bc6\u5bc6\u9470 (DEK)\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3 Google \u6578\u64da\u52a0\u5bc6\u5bc6\u9470\uff0c\u8acb\u53c3\u95b1 [\u975c\u614b\u52a0\u5bc6](https://cloud.google.com/security/encryption/default-encryption?hl=zh-cn) \u3002\n**\u6ce8\u610f** \uff1a\u5bc6\u9470 (CMEK) \u5fc5\u9808\u8207\u52a0\u5bc6\u8cc7\u6e90\u4f4d\u65bc\u540c\u4e00\u4f4d\u7f6e\uff0c\u4f8b\u5982\uff0c\u7528\u65bc\u5c0d `us-central1` \u5340\u57df\u4e2d\u7684\u8cc7\u6e90\u9032\u884c\u52a0\u5bc6\u7684 CMEK \u4e5f\u5fc5\u9808\u4f4d\u65bc `us-central1` \u5340\u57df\u4e2d\u3002\nCMEK \u8207\u5ba2\u6236\u52a0\u5bc6\u5bc6\u9470 (CSEK) \u4e0d\u540c\uff0c\u7528\u6236\u53ef\u4f7f\u7528 CMEK \u6307\u5b9a\u5bc6\u9470\u52a0\u5bc6\u5bc6\u9470\u7684\u5167\u5bb9\u3002\uff08\u8acb\u53c3\u95b1 [\u5ba2\u6236\u63d0\u4f9b\u7684\u52a0\u5bc6\u5bc6\u9470](https://cloud.google.com/docs/security/encryption/customer-supplied-encryption-keys?hl=zh-cn) \uff09\u3002\n", "content": "## \u5c07 CMEK \u7528\u65bc\u96c6\u7fa3\u6578\u64da\n\u60a8\u53ef\u4ee5\u4f7f\u7528\u5ba2\u6236\u7ba1\u7406\u7684\u52a0\u5bc6\u5bc6\u9470 (CMEK) \u52a0\u5bc6\u4ee5\u4e0b\u96c6\u7fa3\u6578\u64da\uff1a\n- \u639b\u63a5\u5230 Dataproc \u96c6\u7fa3\u4e2d\u865b\u64ec\u6a5f\u7684\u6c38\u4e45\u6027\u78c1\u76e4\u4e0a\u7684\u6578\u64da\n- \u63d0\u4ea4\u5230\u96c6\u7fa3\u7684\u4f5c\u696d\u53c3\u6578\u6578\u64da\uff0c\u4f8b\u5982\u4f7f\u7528 Spark SQL \u4f5c\u696d\u63d0\u4ea4\u7684\u67e5\u8a62\u5b57\u7b26\u4e32\n- \u96c6\u7fa3\u5143\u6578\u64da\u3001 [\u4f5c\u696d\u9a45\u52d5\u7a0b\u5e8f\u8f38\u51fa](https://cloud.google.com/dataproc/docs/guides/dataproc-job-output?hl=zh-cn#job_driver_output) \u4ee5\u53ca\u5beb\u5165\u60a8\u5275\u5efa\u7684 Dataproc [\u66ab\u5b58\u5b58\u5132\u6876](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/staging-bucket?hl=zh-cn#create_your_own_staging_and_temp_buckets) \u7684\u5176\u4ed6\u6578\u64da\n**\u6ce8\u610f** \uff1a\u60a8\u9084\u53ef\u4ee5\u5c07 CMEK \u8207 [\u5de5\u4f5c\u6d41\u6a21\u677f\u4f5c\u696d\u53c3\u6578\u52a0\u5bc6](#use_cmek_with_workflow_template_data) \u642d\u914d\u4f7f\u7528\u3002\n\u5982\u9700\u4f7f\u7528 CMEK \u52a0\u5bc6\u96c6\u7fa3\u6578\u64da\uff0c\u8acb\u6309\u4ee5\u4e0b\u6b65\u9a5f\u64cd\u4f5c\uff1a\n- \u4f7f\u7528 [Cloud Key Management Service](https://cloud.google.com/kms/docs/creating-keys?hl=zh-cn) \u5275\u5efa\u4e00\u500b\u6216\u591a\u500b\u5bc6\u9470\u3002\u8cc7\u6e90\u540d\u7a31\uff08\u4e5f\u7a31\u7232\u5bc6\u9470\u7684\u8cc7\u6e90 ID\uff0c\u60a8\u5c07\u5728\u5f8c\u7e8c\u6b65\u9a5f\u4e2d\u4f7f\u7528\uff09\u6309\u5982\u4e0b\u65b9\u5f0f\u69cb\u9020\uff1a```\nprojects/PROJECT_ID/locations/REGION/keyRings/KEY_RING_NAME/cryptoKeys/KEY_NAME\n```\u4f7f\u7528 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **\u52a0\u5bc6\u5bc6\u9470** \u9801\u9762\u5c07\u5bc6\u9470\u8cc7\u6e90 ID \u8907\u88fd\u5230\u526a\u8cbc\u677f\u3002\n- \u7232\u4ee5\u4e0b\u670d\u52d9\u5e33\u865f\u5206\u914d\u4ee5\u4e0b\u89d2\u8272\uff1a- \u6309\u7167 [Compute Engine\u2192\u4f7f\u7528 Cloud KMS \u5bc6\u9470\u4fdd\u8b77\u8cc7\u6e90\u2192\u6e96\u5099\u5de5\u4f5c](https://cloud.google.com/compute/docs/disks/customer-managed-encryption?hl=zh-cn#before_you_begin) \u4e2d\u7684\u7b2c 5 \u9805\uff0c\u5c07 Cloud KMS [CryptoKey Encrypter/Decrypter](https://cloud.google.com/kms/docs/reference/permissions-and-roles?hl=zh-cn#cloudkms.cryptoKeyEncrypterDecrypter) \u89d2\u8272\u5206\u914d\u7d66 [Compute Engine \u670d\u52d9\u4ee3\u7406](https://cloud.google.com/compute/docs/access/service-accounts?hl=zh-cn#compute_engine_service_account) \u670d\u52d9\u5e33\u865f\u3002\u5982\u679c Compute Engine \u670d\u52d9\u4ee3\u7406\u670d\u52d9\u5e33\u865f\u672a\u986f\u793a\u5728 Google Cloud \u63a7\u5236\u6aaf\u7684 [IAM](https://console.cloud.google.com/iam-admin/iam?hl=zh-cn) \u9801\u9762\u4e0a\uff0c\u8acb\u9ede\u64ca\u8a72\u9801\u9762\u4e0a\u7684\u201c\u5305\u62ec Google \u63d0\u4f9b\u7684\u89d2\u8272\u6388\u6b0a\u201d\u3002\n- \u5c07 Cloud KMS [CryptoKey Encrypter/Decrypter](https://cloud.google.com/kms/docs/reference/permissions-and-roles?hl=zh-cn#cloudkms.cryptoKeyEncrypterDecrypter) \u89d2\u8272\u5206\u914d\u7d66 [Cloud Storage \u670d\u52d9\u4ee3\u7406](https://cloud.google.com/storage/docs/encryption/using-customer-managed-keys?hl=zh-cn#service-agent-access) \u670d\u52d9\u5e33\u865f\u3002\n- \u5c07 Cloud KMS [CryptoKey Encrypter/Decrypter](https://cloud.google.com/kms/docs/reference/permissions-and-roles?hl=zh-cn#cloudkms.cryptoKeyEncrypterDecrypter) \u548c Service Usage [Service Usage Consumer](https://cloud.google.com/service-usage/docs/access-control?hl=zh-cn#predefined_roles) \u89d2\u8272\u5206\u914d\u7d66 [Dataproc \u670d\u52d9\u4ee3\u7406](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/service-accounts?hl=zh-cn#service_agent_account) \u670d\u52d9\u5e33\u865f\u3002\n- \u5c07\u5bc6\u9470\u7684\u8cc7\u6e90 ID \u50b3\u905e\u7d66 Google Cloud CLI \u6216 Dataproc API\uff0c\u4ee5\u7528\u65bc\u96c6\u7fa3\u6578\u64da\u52a0\u5bc6\u3002- \u5982\u9700\u4f7f\u7528\u5bc6\u9470\u52a0\u5bc6\u96c6\u7fa3\u6c38\u4e45\u6027\u78c1\u76e4\u6578\u64da\uff0c\u8acb\u5728\u5275\u5efa\u96c6\u7fa3\u6642\u5c07\u5bc6\u9470\u7684\u8cc7\u6e90 ID \u50b3\u905e\u7d66`--gce-pd-kms-key`\u6a19\u8a8c\u3002```\ngcloud dataproc clusters create CLUSTER_NAME \\\n\u00a0\u00a0\u00a0\u00a0--region=REGION \\\n\u00a0\u00a0\u00a0\u00a0--gce-pd-kms-key='projects/PROJECT_ID/locations/REGION/keyRings/KEY_RING_NAME/cryptoKeys/KEY_NAME' \\\n\u00a0\u00a0\u00a0\u00a0other args ...\n```\u60a8\u53ef\u4ee5\u901a\u904e `gcloud` \u547d\u4ee4\u884c\u5de5\u5177\u9a57\u8b49\u5bc6\u9470\u8a2d\u7f6e\u3002```\ngcloud dataproc clusters describe CLUSTER_NAME \\\n\u00a0\u00a0\u00a0\u00a0--region=REGION\n```\u547d\u4ee4\u8f38\u51fa\u4ee3\u78bc\u6bb5\uff1a```\n...\nconfigBucket: dataproc- ...\nencryptionConfig:\ngcePdKmsKeyName: projects/project-id/locations/region/keyRings/key-ring-name/cryptoKeys/key-name\n...\n```\n- \u5982\u9700\u4f7f\u7528\u5bc6\u9470\u52a0\u5bc6\u96c6\u7fa3\u6c38\u4e45\u6027\u78c1\u76e4\u6578\u64da\u548c\u4f5c\u696d\u53c3\u6578\u6578\u64da\uff0c\u8acb\u5728\u5275\u5efa\u96c6\u7fa3\u6642\u5c07\u5bc6\u9470\u7684\u8cc7\u6e90 ID \u50b3\u905e\u7d66`--kms-key`\u6a19\u8a8c\u3002\u5982\u9700\u67e5\u770b\u4f7f\u7528`--kms-key`\u6a19\u8a8c\u52a0\u5bc6\u7684\u4f5c\u696d\u985e\u578b\u548c\u53c3\u6578\u5217\u8868\uff0c\u8acb\u53c3\u95b1 [Cluster.EncryptionConfig.kmsKey](https://cloud.google.com/dataproc/docs/reference/rest/v1/ClusterConfig?hl=zh-cn#EncryptionConfig.FIELDS.kms_key) \u3002```\ngcloud dataproc clusters create CLUSTER_NAME \\\n\u00a0\u00a0\u00a0\u00a0--region=REGION \\\n\u00a0\u00a0\u00a0\u00a0--kms-key='projects/PROJECT_ID/locations/REGION/keyRings/KEY_RING_NAME/cryptoKeys/KEY_NAME' \\\n\u00a0\u00a0\u00a0\u00a0other args ...\n \n```\u60a8\u53ef\u4ee5\u4f7f\u7528 gcloud CLI `dataproc clusters describe` \u547d\u4ee4\u9a57\u8b49\u5bc6\u9470\u8a2d\u7f6e\u3002\u5bc6\u9470\u8cc7\u6e90 ID \u5728 `gcePdKmsKeyName` \u548c `kmsKey` \u4e0a\u8a2d\u7f6e\uff0c\u4ee5\u5c07\u60a8\u7684\u5bc6\u9470\u7528\u65bc\u52a0\u5bc6\u96c6\u7fa3\u6c38\u4e45\u6027\u78c1\u76e4\u548c\u4f5c\u696d\u53c3\u6578\u6578\u64da\u3002```\ngcloud dataproc clusters describe CLUSTER_NAME \\\n\u00a0\u00a0\u00a0\u00a0--region=REGION\n \n```\u547d\u4ee4\u8f38\u51fa\u4ee3\u78bc\u6bb5\uff1a```\n...\nconfigBucket: dataproc- ...\nencryptionConfig:\ngcePdKmsKeyName: projects/PROJECT_ID/locations/REGION/keyRings/KEY_RING_NAME/cryptoKeys/KEY_NAME\nkmsKey: projects/PROJECT_ID/locations/REGION/keyRings/key-KEY_RING_NAME-name/cryptoKeys/KEY_NAME\n...\n```\u60a8\u53ef\u4ee5\u4f7f\u7528`--gce-pd-kms-key`\u6216`--kms-key`\u6a19\u8a8c\uff08\u4f46\u4e0d\u80fd\u540c\u6642\u4f7f\u7528\u9019\u5169\u8005\uff09\u4f86\u4f7f\u7528\u5bc6\u9470\u52a0\u5bc6\u96c6\u7fa3\u6578\u64da\u3002\n- \u5982\u9700\u52a0\u5bc6\u5beb\u5165 Cloud Storage \u4e2d Dataproc \u66ab\u5b58\u5b58\u5132\u6876\u7684\u96c6\u7fa3\u5143\u6578\u64da\u3001\u4f5c\u696d\u9a45\u52d5\u7a0b\u5e8f\u548c\u5176\u4ed6\u8f38\u51fa\u6578\u64da\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- [\u4f7f\u7528 CMEK \u5275\u5efa\u81ea\u5df1\u7684\u5b58\u5132\u6876](https://cloud.google.com/storage/docs/encryption/using-customer-managed-keys?hl=zh-cn) \u3002 [\u5c07\u5bc6\u9470\u6dfb\u52a0\u5230\u5b58\u5132\u6876](https://cloud.google.com/storage/docs/encryption/using-customer-managed-keys?hl=zh-cn#set-default-key) \u6642\uff0c\u8acb\u4f7f\u7528\u60a8\u5728\u7b2c 1 \u6b65\u4e2d\u5275\u5efa\u7684\u5bc6\u9470\u3002\n- \u5728\u5275\u5efa\u96c6\u7fa3\u6642\uff0c\u5c07\u5b58\u5132\u6876\u540d\u7a31\u50b3\u905e\u7d66\u201c--bucket\u201d\u6a19\u8a8c\u3002\n```\ngcloud dataproc clusters create CLUSTER_NAME \\\n\u00a0\u00a0\u00a0\u00a0--region=REGION \\\n\u00a0\u00a0\u00a0\u00a0--bucket=CMEK_BUCKET_NAME \\\n\u00a0\u00a0\u00a0\u00a0other args ...\n \n```\u5982\u679c\u60a8\u7684\u4f5c\u696d\u63a1\u7528\u5b58\u5132\u6876\u53c3\u6578\uff0c\u60a8\u9084\u53ef\u4ee5\u5c07\u5553\u7528\u4e86 CMEK \u7684\u5b58\u5132\u6876\u50b3\u905e\u7d66\u201cgcloud dataproc job submit\u201d\u547d\u4ee4\uff0c\u5982\u4ee5\u4e0b\u201ccmek-bucket\u201d\u793a\u4f8b\u6240\u793a\uff1a```\ngcloud dataproc jobs submit pyspark gs://cmek-bucket/wordcount.py \\\n\u00a0\u00a0\u00a0\u00a0--region=region \\\n\u00a0\u00a0\u00a0\u00a0--cluster=cluster-name \\\n\u00a0\u00a0\u00a0\u00a0--\u00a0gs://cmek-bucket/shakespeare.txt\u00a0gs://cmek-bucket/counts\n \n```\n- Dataproc \u4e0d\u6703\u5728 Cloud Storage \u5b58\u5132\u6876\u4e0a\u7ba1\u7406\u5ba2\u6236\u7ba1\u7406\u7684\u52a0\u5bc6\u5bc6\u9470\u3002\n- \u5982\u679c\u5c07\u5b58\u5132\u6876\u8207\u5ba2\u6236\u7ba1\u7406\u7684\u52a0\u5bc6\u5bc6\u9470\u642d\u914d\u4f7f\u7528\uff0c\u53ef\u80fd\u6703\u6e1b\u6162\u5beb\u5165\u5927\u578b\u6587\u4ef6\u7684\u901f\u5ea6\u3002\n- \u5982\u9700\u4f7f\u7528\u5bc6\u9470\u52a0\u5bc6\u96c6\u7fa3\u865b\u64ec\u6a5f\u6c38\u4e45\u6027\u78c1\u76e4\u6578\u64da\uff0c\u8acb\u5728 [cluster.create](https://cloud.google.com/dataproc/docs/reference/rest/v1/projects.regions.clusters/create?hl=zh-cn) \u8acb\u6c42\u4e2d\u5305\u542b [ClusterConfig.EncryptionConfig.gcePdKmsKeyName](https://cloud.google.com/dataproc/docs/reference/rest/v1/ClusterConfig?hl=zh-cn#encryptionconfig) \u5b57\u6bb5\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528 gcloud CLI `dataproc clusters describe` \u547d\u4ee4\u9a57\u8b49\u5bc6\u9470\u8a2d\u7f6e\u3002```\ngcloud dataproc clusters describe CLUSTER_NAME \\\n\u00a0\u00a0\u00a0\u00a0--region=REGION\n```\u547d\u4ee4\u8f38\u51fa\u4ee3\u78bc\u6bb5\uff1a```\n...\nconfigBucket: dataproc- ...\nencryptionConfig:\ngcePdKmsKeyName: projects/PROJECT_ID/locations/REGION/keyRings/KEY_RING_NAME/cryptoKeys/KEY_NAME\n...\n```\n- \u5982\u9700\u4f7f\u7528\u5bc6\u9470\u52a0\u5bc6\u96c6\u7fa3\u865b\u64ec\u6a5f\u6c38\u4e45\u6027\u78c1\u76e4\u6578\u64da\u548c\u4f5c\u696d\u53c3\u6578\u6578\u64da\uff0c\u8acb\u5728 [cluster.create](https://cloud.google.com/dataproc/docs/reference/rest/v1/projects.regions.clusters/create?hl=zh-cn) \u8acb\u6c42\u4e2d\u5305\u542b`Cluster.EncryptionConfig.kmsKey`\u5b57\u6bb5\u3002\u5982\u9700\u67e5\u770b\u4f7f\u7528`--kms-key`\u5b57\u6bb5\u52a0\u5bc6\u7684\u4f5c\u696d\u985e\u578b\u548c\u53c3\u6578\u5217\u8868\uff0c\u8acb\u53c3\u95b1 [Cluster.EncryptionConfig.kmsKey](https://cloud.google.com/dataproc/docs/reference/rest/v1/ClusterConfig?hl=zh-cn#EncryptionConfig.FIELDS.kms_key) \u3002\u60a8\u53ef\u4ee5\u5728\u96c6\u7fa3\u5275\u5efa\u8acb\u6c42\u4e2d\u6dfb\u52a0`Cluster.EncryptionConfig.gcePdKmsKeyName`\u5b57\u6bb5\u6216`Cluster.EncryptionConfig.kmsKey`\u5b57\u6bb5\uff0c\u4f46\u4e0d\u80fd\u540c\u6642\u5305\u542b\u9019\u5169\u500b\u5b57\u6bb5\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528 gcloud CLI `dataproc clusters describe` \u547d\u4ee4\u9a57\u8b49\u5bc6\u9470\u8a2d\u7f6e\u3002\u5bc6\u9470\u8cc7\u6e90 ID \u5728 `gcePdKmsKeyName` \u548c `kmsKey` \u4e0a\u8a2d\u7f6e\uff0c\u4ee5\u5c07\u60a8\u7684\u5bc6\u9470\u7528\u65bc\u52a0\u5bc6\u96c6\u7fa3\u6c38\u4e45\u6027\u78c1\u76e4\u548c\u4f5c\u696d\u53c3\u6578\u6578\u64da\u3002```\ngcloud dataproc clusters describe CLUSTER_NAME \\\n\u00a0\u00a0\u00a0\u00a0--region=REGION\n```\u547d\u4ee4\u8f38\u51fa\u4ee3\u78bc\u6bb5\uff1a```\n...\nconfigBucket: dataproc- ...\nencryptionConfig:\ngcePdKmsKeyName: projects/PROJECT_ID/locations/REGION/keyRings/KEY_RING_NAME/cryptoKeys/KEY_NAME\nkmsKey: projects/PROJECT_ID/locations/REGION/keyRings/KEY_RING_NAME/cryptoKeys/KEY_NAME\n```\n- \u5982\u9700\u52a0\u5bc6\u5beb\u5165 Cloud Storage \u4e2d Dataproc \u66ab\u5b58\u5b58\u5132\u6876\u7684\u96c6\u7fa3\u5143\u6578\u64da\u3001\u4f5c\u696d\u9a45\u52d5\u7a0b\u5e8f\u548c\u5176\u4ed6\u8f38\u51fa\u6578\u64da\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- [\u4f7f\u7528 CMEK \u5275\u5efa\u81ea\u5df1\u7684\u5b58\u5132\u6876](https://cloud.google.com/storage/docs/encryption/using-customer-managed-keys?hl=zh-cn) \u3002 [\u5c07\u5bc6\u9470\u6dfb\u52a0\u5230\u5b58\u5132\u6876](https://cloud.google.com/storage/docs/encryption/using-customer-managed-keys?hl=zh-cn#set-default-key) \u6642\uff0c\u8acb\u4f7f\u7528\u60a8\u5728\u7b2c 1 \u6b65\u4e2d\u5275\u5efa\u7684\u5bc6\u9470\u3002\n- \u5c07\u5b58\u5132\u6876\u540d\u7a31\u4f5c\u7232 [cluster.create](https://cloud.google.com/dataproc/docs/reference/rest/v1/projects.regions.clusters/create?hl=zh-cn) \u8acb\u6c42\u7684\u4e00\u90e8\u5206\u50b3\u905e\u7d66 [ClusterConfig.configBucket](https://cloud.google.com/dataproc/docs/reference/rest/v1/ClusterConfig?hl=zh-cn#FIELDS.config_bucket) \u5b57\u6bb5\u3002\n```\ngcloud dataproc clusters create CLUSTER_NAME \\\n\u00a0\u00a0\u00a0\u00a0--region=REGION \\\n\u00a0\u00a0\u00a0\u00a0--bucket=CMEK_BUCKET_NAMEt \\\n\u00a0\u00a0\u00a0\u00a0other args ...\n```\n- Dataproc \u4e0d\u6703\u5728 Cloud Storage \u5b58\u5132\u6876\u4e0a\u7ba1\u7406\u5ba2\u6236\u7ba1\u7406\u7684\u52a0\u5bc6\u5bc6\u9470\u3002\n- \u5982\u679c\u5c07\u5b58\u5132\u6876\u8207\u5ba2\u6236\u7ba1\u7406\u7684\u52a0\u5bc6\u5bc6\u9470\u642d\u914d\u4f7f\u7528\uff0c\u53ef\u80fd\u6703\u6e1b\u6162\u5beb\u5165\u5927\u578b\u6587\u4ef6\u7684\u901f\u5ea6\u3002\n\u5982\u679c\u60a8\u7684\u4f5c\u696d\u63a1\u7528\u5b58\u5132\u6876\u53c3\u6578\uff0c\u60a8\u9084\u53ef\u4ee5\u5c07\u5553\u7528\u4e86 CMEK \u7684\u5b58\u5132\u6876\u50b3\u905e\u7d66\u201cgcloud dataproc job submit\u201d\u547d\u4ee4\uff0c\u5982\u4ee5\u4e0b\u201ccmek-bucket\u201d\u793a\u4f8b\u6240\u793a\uff1a```\ngcloud dataproc jobs submit pyspark gs://cmek-bucket/wordcount.py \\\n\u00a0\u00a0\u00a0\u00a0--region=region \\\n\u00a0\u00a0\u00a0\u00a0--cluster=cluster-name \\\n\u00a0\u00a0\u00a0\u00a0--\u00a0gs://cmek-bucket/shakespeare.txt\u00a0gs://cmek-bucket/counts\n \n```## \u5c07 CMEK \u8207\u5de5\u4f5c\u6d41\u6a21\u677f\u6578\u64da\u7d50\u5408\u4f7f\u7528\nDataproc \u5de5\u4f5c\u6d41\u6a21\u677f\u4f5c\u696d\u53c3\u6578\u6578\u64da\uff08\u4f8b\u5982 Spark SQL \u4f5c\u696d\u7684\u67e5\u8a62\u5b57\u7b26\u4e32\uff09\u53ef\u4ee5\u4f7f\u7528 CMEK \u9032\u884c\u52a0\u5bc6\u3002\u6309\u7167\u672c\u90e8\u5206\u4e2d\u7684\u7b2c 1 \u6b65\u3001\u7b2c 2 \u6b65\u548c\u7b2c 3 \u6b65\uff0c\u5c07 CMEK \u7528\u65bc\u60a8\u7684 Dataproc \u5de5\u4f5c\u6d41\u6a21\u677f\u3002\u5982\u9700\u67e5\u770b\u5728\u5553\u7528\u6b64\u529f\u80fd\u6642\u4f7f\u7528 CMEK \u52a0\u5bc6\u7684\u5de5\u4f5c\u6d41\u6a21\u677f\u4f5c\u696d\u985e\u578b\u548c\u53c3\u6578\u5217\u8868\uff0c\u8acb\u53c3\u95b1 [WorkflowTemplate.EncryptionConfig.kmsKey](https://cloud.google.com/dataproc/docs/reference/rest/v1/projects.locations.workflowTemplates?hl=zh-cn#encryptionconfig) \u3002\n- \u4f7f\u7528 [Cloud Key Management Service (Cloud KMS)](https://cloud.google.com/kms/docs/creating-keys?hl=zh-cn) \u5275\u5efa\u5bc6\u9470\u3002 \u5bc6\u9470\u7684\u8cc7\u6e90\u540d\u7a31\uff08\u60a8\u5c07\u5728\u5f8c\u7e8c\u6b65\u9a5f\u4e2d\u4f7f\u7528\uff09\u6309\u5982\u4e0b\u65b9\u5f0f\u69cb\u9020\uff1a```\nprojects/project-id/locations/region/keyRings/key-ring-name/cryptoKeys/key-name\n```\u4f7f\u7528 Google Cloud \u63a7\u5236\u6aaf\u7684 **\u52a0\u5bc6\u5bc6\u9470** \u9801\u9762\uff0c\u5c07\u5bc6\u9470\u8cc7\u6e90 ID \u8907\u88fd\u5230\u526a\u8cbc\u677f\u3002\n- \u5982\u9700\u4f7f Dataproc \u670d\u52d9\u5e33\u865f\u80fd\u5920\u4f7f\u7528\u60a8\u7684\u5bc6\u9470\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u5c07 Cloud KMS`CryptoKey Encrypter/Decrypter`\u89d2\u8272\u5206\u914d\u7d66 [DataprocService Agent \u670d\u52d9\u5e33\u865f](https://cloud.google.com/dataproc/docs/concepts/iam/dataproc-principals?hl=zh-cn#service_agent_control_plane_identity) \u3002\n- \u5c07 Service Usage`Service Usage Consumer`\u89d2\u8272\u5206\u914d\u7d66 [DataprocService Agent \u670d\u52d9\u5e33\u865f](https://cloud.google.com/dataproc/docs/concepts/iam/dataproc-principals?hl=zh-cn#service_agent_control_plane_identity) \u3002\n- \u60a8\u53ef\u4ee5\u4f7f\u7528 Google Cloud CLI \u6216 Dataproc API \u5728\u5de5\u4f5c\u6d41\u4e2d\u8a2d\u7f6e\u5728\u7b2c 1 \u6b65\u4e2d\u5275\u5efa\u7684\u5bc6\u9470\u3002\u5728\u5de5\u4f5c\u6d41\u4e2d\u8a2d\u7f6e\u5bc6\u9470\u5f8c\uff0c\u6240\u6709\u5de5\u4f5c\u6d41\u4f5c\u696d\u53c3\u6578\u548c\u67e5\u8a62\u90fd\u5c07\u4f7f\u7528 [WorkflowTemplate.EncryptionConfig.kmsKey](https://cloud.google.com/dataproc/docs/reference/rest/v1/projects.locations.workflowTemplates?hl=zh-cn#encryptionconfig) \u4e2d\u5217\u51fa\u7684\u4efb\u4f55\u4f5c\u696d\u985e\u578b\u548c\u53c3\u6578\u7684\u5bc6\u9470\u9032\u884c\u52a0\u5bc6\u3002\n\u4f7f\u7528 [gcloud dataproclifecycle-templates create](https://cloud.google.com/sdk/gcloud/reference/dataproc/workflow-templates/create?hl=zh-cn) \u547d\u4ee4\u5275\u5efa\u5de5\u4f5c\u6d41\u6a21\u677f\u6642\uff0c\u5c07\u5bc6\u9470\u7684\u8cc7\u6e90 ID \u50b3\u905e\u7d66 `--kms-key` \u6a19\u8a8c\u3002\n **\u793a\u4f8b** \uff1a\n```\ngcloud dataproc workflow-templates create my-template-name \\\n\u00a0\u00a0\u00a0\u00a0--region=region \\\n\u00a0\u00a0\u00a0\u00a0--kms-key='projects/project-id/locations/region/keyRings/key-ring-name/cryptoKeys/key-name' \\\n\u00a0\u00a0\u00a0\u00a0other args ...\n```\n\u60a8\u53ef\u4ee5\u901a\u904e\n`gcloud`\n\u547d\u4ee4\u884c\u5de5\u5177\u9a57\u8b49\u5bc6\u9470\u8a2d\u7f6e\u3002\n```\ngcloud dataproc workflow-templates describe TEMPLATE_NAME \\\n\u00a0\u00a0\u00a0\u00a0--region=REGION\n```\n```\n...\nid: my-template-name\nencryptionConfig:\nkmsKey: projects/PROJECT_ID/locations/REGION/keyRings/KEY_RING_NAME/cryptoKeys/KEY_NAME\n...\n```\u5728 [workflowTemplates.create \u8acb\u6c42](https://cloud.google.com/dataproc/docs/reference/rest/v1/projects.regions.workflowTemplates/create?hl=zh-cn) \u4e2d\u4f7f\u7528 [WorkflowTemplate.EncryptionConfig.kmsKey](https://cloud.google.com/dataproc/docs/reference/rest/v1/projects.locations.workflowTemplates?hl=zh-cn#encryptionconfig) \u3002\n\u60a8\u53ef\u4ee5\u901a\u904e\u767c\u51fa [workflowTemplates.get](https://cloud.google.com/dataproc/docs/reference/rest/v1/projects.regions.workflowTemplates/get?hl=zh-cn) \u8acb\u6c42\u4f86\u9a57\u8b49\u5bc6\u9470\u8a2d\u7f6e\u3002\u8fd4\u56de\u7684 JSON \u5305\u542b `kmsKey` \u5217\u8868\uff1a\n```\n...\n\"id\": \"my-template-name\",\n\"encryptionConfig\": {\n \"kmsKey\": \"projects/project-id/locations/region/keyRings/key-ring-name/cryptoKeys/key-name\"\n},\n```\n## Cloud External Key Manager\n\u85c9\u52a9 [Cloud External Key Manager (Cloud EKM) (EKM)](https://cloud.google.com/kms/docs/ekm?hl=zh-cn) \uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 [\u53d7\u652f\u6301\u7684\u5916\u90e8\u5bc6\u9470\u7ba1\u7406\u5408\u4f5c\u4f19\u4f34](https://cloud.google.com/kms/docs/ekm?hl=zh-cn#supported_partners) \u7ba1\u7406\u7684\u5bc6\u9470\u4fdd\u8b77 Dataproc \u6578\u64da\u3002\u60a8\u5728 Dataproc \u4e2d\u4f7f\u7528 EKM \u6240\u9075\u5faa\u7684\u6b65\u9a5f\u8207\u60a8\u7528\u65bc [\u8a2d\u7f6e CMEK \u5bc6\u9470](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/customer-managed-encryption?hl=zh-cn#using_cmek) \u7684\u6b65\u9a5f\u76f8\u540c\uff0c\u4f46\u4e0d\u540c\u4e4b\u8655\u5728\u65bc\uff1a\u60a8\u7684\u5bc6\u9470\u6307\u5411 **\u5916\u90e8\u7ba1\u7406\u7684\u5bc6\u9470** \u7684 URI\uff08\u8acb\u53c3\u95b1 [Cloud EKM \u6982\u89bd](https://cloud.google.com/kms/docs/ekm?hl=zh-cn#overview) \uff09\u3002\n### Cloud EKM \u932f\u8aa4\n\u4f7f\u7528 Cloud EKM \u6642\uff0c\u7531\u65bc\u8207\u8f38\u5165\u3001Cloud EKM\u3001\u5916\u90e8\u5bc6\u9470\u7ba1\u7406\u5408\u4f5c\u4f19\u4f34\u7cfb\u7d71\u6216 EKM \u8207\u5916\u90e8\u7cfb\u7d71\u4e4b\u9593\u7684\u901a\u4fe1\u76f8\u95dc\u7684\u932f\u8aa4\uff0c\u5617\u8a66\u5275\u5efa\u96c6\u7fa3\u7684\u64cd\u4f5c\u53ef\u80fd\u6703\u5931\u6557\u3002\u5982\u679c\u60a8\u4f7f\u7528 REST API \u6216 Google Cloud \u63a7\u5236\u6aaf\uff0c\u5247 [Logging](https://cloud.google.com/logging?hl=zh-cn) \u4e2d\u6703\u8a18\u9304\u932f\u8aa4\u3002\u60a8\u53ef\u4ee5\u901a\u904e **\u67e5\u770b\u65e5\u8a8c** \u6a19\u7c64\u9801\u6aa2\u67e5\u5931\u6557\u96c6\u7fa3\u7684\u932f\u8aa4\u3002\n\u5982\u679c\u60a8\u4f7f\u7528 [Cloud Shell](https://cloud.google.com/shell?hl=zh-cn) \u5275\u5efa\u96c6\u7fa3\uff0c\u5247\u932f\u8aa4\u6703\u986f\u793a\u5728 Cloud Shell \u7d42\u7aef\u548c Logging \u4e2d\u3002", "guide": "Dataproc"}