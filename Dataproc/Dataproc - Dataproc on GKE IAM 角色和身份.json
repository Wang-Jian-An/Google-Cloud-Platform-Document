{"title": "Dataproc - Dataproc on GKE IAM \u89d2\u8272\u548c\u8eab\u4efd", "url": "https://cloud.google.com/dataproc/docs/guides/dpgke/dataproc-gke-iam?hl=zh-cn", "abstract": "# Dataproc - Dataproc on GKE IAM \u89d2\u8272\u548c\u8eab\u4efd\n", "content": "## \u6578\u64da\u5e73\u9762\u8eab\u4efd\nDataproc on GKE \u4f7f\u7528 [GKE \u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity?hl=zh-cn) \u4f86\u5141\u8a31 Dataproc on GKE \u96c6\u7fa3\u4e2d\u7684 pod \u901a\u904e\u9ed8\u8a8d [Dataproc \u865b\u64ec\u6a5f\u670d\u52d9\u5e33\u865f\uff08\u6578\u64da\u5e73\u9762\u8eab\u4efd\uff09](https://cloud.google.com/dataproc/docs/concepts/iam/dataproc-principals?hl=zh-cn#vm_service_account_data_plane_identity) \u7684\u6388\u6b0a\u57f7\u884c\u64cd\u4f5c\u3002Workload Identity \u9700\u8981\u4ee5\u4e0b\u6b0a\u9650\u624d\u80fd\u66f4\u65b0 Dataproc on GKE \u865b\u64ec\u96c6\u7fa3\u4f7f\u7528\u7684 GSA \u4e0a\u7684 IAM \u653f\u7b56\uff1a\n- `compute.projects.get`\n- `iam.serviceAccounts.getIamPolicy`\n- `iam.serviceAccounts.setIamPolicy`\n**\u6ce8\u610f** \uff1a\u60a8\u53ef\u4ee5\u5c07\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u8207\u5176\u4ed6 GSA \u642d\u914d\u4f7f\u7528\uff1a\u8acb\u53c3\u95b1 [\u81ea\u5b9a\u7fa9 IAM \u914d\u7f6e](#custom_iam_configuration) \u3002\nGKE Workload Identity \u6703\u5c07\u4ee5\u4e0b GKE \u670d\u52d9\u5e33\u865f (KSA) \u95dc\u806f\u5230 Dataproc \u865b\u64ec\u6a5f\u670d\u52d9\u5e33\u865f\uff1a [](None)\n- `agent`KSA\uff08\u8207 Dataproc \u63a7\u5236\u5e73\u9762\u4ea4\u4e92\uff09\uff1a`serviceAccount:${PROJECT}.svc.id.goog[${DPGKE_NAMESPACE}/agent]`\n- `spark-driver`KSA\uff08\u904b\u884c Spark \u9a45\u52d5\u7a0b\u5e8f\uff09\uff1a`serviceAccount:${PROJECT}.svc.id.goog[${DPGKE_NAMESPACE}/spark-driver]`\n- `spark-executor`KSA\uff08\u904b\u884c Spark \u57f7\u884c\u7a0b\u5e8f\uff09\uff1a`serviceAccount:${PROJECT}.svc.id.goog[${DPGKE_NAMESPACE}/spark-executor]`\n\u5728 [\u5275\u5efa Dataproc on GKE \u96c6\u7fa3](https://cloud.google.com/dataproc/docs/guides/dpgke/quickstarts/dataproc-gke-quickstart-create-cluster?hl=zh-cn) \u6642\uff0c\u8acb\u4f7f\u7528`gcloud dataproc clusters gke create --setup-workload-identity`\u6a19\u8a8c\uff0c\u4ee5\u5275\u5efa\u96c6\u7fa3\u6240\u9700\u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u7d81\u5b9a\u3002\n### \u5206\u914d\u89d2\u8272\n\u5411 [Dataproc \u865b\u64ec\u6a5f\u670d\u52d9\u5e33\u865f](https://cloud.google.com/dataproc/docs/concepts/iam/dataproc-principals?hl=zh-cn#vm_service_account_data_plane_identity) \u6388\u4e88\u6b0a\u9650\uff0c\u5141\u8a31 `spark-driver` \u548c `spark-executor` \u8a2a\u554f\u9805\u76ee\u8cc7\u6e90\u3001\u6578\u64da\u6e90\u3001\u6578\u64da\u63a5\u6536\u5668\u4ee5\u53ca\u5de5\u4f5c\u8ca0\u8f09\u6240\u9700\u7684\u4efb\u4f55\u5176\u4ed6\u670d\u52d9\u3002\n\u793a\u4f8b\uff1a\n\u4ee5\u4e0b\u547d\u4ee4\u5c07\u89d2\u8272\u5206\u914d\u7d66 [\u9ed8\u8a8d Dataproc \u865b\u64ec\u6a5f\u670d\u52d9\u5e33\u865f](https://cloud.google.com/dataproc/docs/concepts/configuring-clusters/service-accounts?hl=zh-cn#dataproc_service_accounts_2) \uff0c\u4ee5\u5141\u8a31\u5728 GKE \u96c6\u7fa3\u865b\u64ec\u6a5f\u4e0a\u7684 Dataproc \u4e0a\u904b\u884c\u7684 Spark \u5de5\u4f5c\u8ca0\u8f09\u8a2a\u554f\u9805\u76ee\u4e2d\u7684 Cloud Storage \u5b58\u5132\u5206\u5340\u548c BigQuery \u6578\u64da\u96c6\u3002\n```\ngcloud projects add-iam-policy-binding \\\n\u00a0\u00a0\u00a0\u00a0--role=roles/storage.objectAdmin \\\n\u00a0\u00a0\u00a0\u00a0--role=roles/bigquery.dataEditor \\\n\u00a0\u00a0\u00a0\u00a0--member=\"project-number-compute@developer.gserviceaccount.com\" \\\n\u00a0\u00a0\u00a0\u00a0\"${PROJECT}\"\n```\n## \u81ea\u5b9a\u7fa9 IAM \u914d\u7f6e\nDataproc on GKE \u4f7f\u7528 [GKE \u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity?hl=zh-cn) \u5c07\u9ed8\u8a8d\u7684 [Dataproc \u865b\u64ec\u6a5f\u670d\u52d9\u5e33\u865f\uff08\u6578\u64da\u5e73\u9762\u8eab\u4efd\uff09](https://cloud.google.com/dataproc/docs/concepts/iam/dataproc-principals?hl=zh-cn#vm_service_account_data_plane_identity) \u95dc\u806f\u5230\u4e09\u500b [GKE \u670d\u52d9\u5e33\u865f (KSA)](#ksa-sas) \u3002\n\u5982\u9700\u5275\u5efa\u548c\u4f7f\u7528\u5176\u4ed6 Google \u670d\u52d9\u5e33\u865f (GSA) \u9023\u63a5\u5230 KSA\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u5275\u5efa GSA\uff08\u8acb\u53c3\u95b1 [\u5275\u5efa\u548c\u7ba1\u7406\u670d\u52d9\u5e33\u865f](https://cloud.google.com/iam/docs/creating-managing-service-accounts?hl=zh-cn) \uff09\u3002gcloud CLI \u793a\u4f8b\uff1a```\ngcloud iam service-accounts create \"dataproc-${USER}\" \\\n\u00a0\u00a0\u00a0\u00a0--description \"Used by Dataproc on GKE workloads.\"\n```\u5099\u8a3b\uff1a- \u8a72\u793a\u4f8b\u5c07 GSA \u540d\u7a31\u8a2d\u7f6e\u7232\u201cdataproc-${USER}\u201d\uff0c\u4f46\u60a8\u53ef\u4ee5\u4f7f\u7528\u5176\u4ed6\u540d\u7a31\u3002\n- \u8a2d\u7f6e\u74b0\u5883\u8b8a\u91cf\uff1a```\nPROJECT=project-id \\\n\u00a0\u00a0DPGKE_GSA=\"dataproc-${USER}@${PROJECT}.iam.gserviceaccount.com\"\n\u00a0\u00a0DPGKE_NAMESPACE=GKE namespace\n```\u5099\u8a3b\uff1a- `DPGKE_GSA`\uff1a\u9019\u4e9b\u793a\u4f8b\u8a2d\u7f6e\u4e86`DPGKE_GSA`\u4e26\u5c07\u5176\u7528\u4f5c\u5305\u542b GSA \u96fb\u5b50\u90f5\u4ef6\u5730\u5740\u7684\u8b8a\u91cf\u7684\u540d\u7a31\u3002\u60a8\u53ef\u4ee5\u8a2d\u7f6e\u548c\u4f7f\u7528\u5176\u4ed6\u8b8a\u91cf\u540d\u7a31\u3002\n- `DPGKE_NAMESPACE`\uff1a\u9ed8\u8a8d\u7684 [GKE \u547d\u540d\u7a7a\u9593](https://cloud.google.com/dataproc/docs/reference/rest/v1/GkeClusterConfig?hl=zh-cn#NamespacedGkeDeploymentTarget.FIELDS.cluster_namespace) \u662f Dataproc on GKE \u96c6\u7fa3\u7684\u540d\u7a31\u3002\n- \u5275\u5efa Dataproc on GKE \u96c6\u7fa3\u6642\uff0c\u8acb\u7232 Dataproc \u6dfb\u52a0\u4ee5\u4e0b\u5c6c\u6027\uff0c\u4ee5\u4fbf\u4f7f\u7528\u60a8\u7684 GSA \u800c\u4e0d\u662f\u9ed8\u8a8d\u7684 GSA\uff1a```\n--properties \"dataproc:dataproc.gke.agent.google-service-account=${DPGKE_GSA}\" \\\n--properties \"dataproc:dataproc.gke.spark.driver.google-service-account=${DPGKE_GSA}\" \\\n--properties \"dataproc:dataproc.gke.spark.executor.google-service-account=${DPGKE_GSA}\" \\\n```\n- \u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u7232\u670d\u52d9\u5e33\u865f\u5206\u914d\u5fc5\u8981\u7684 [Workload Identity](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity?hl=zh-cn) \u6b0a\u9650\uff1a- \u7232\u60a8\u7684 GSA \u5206\u914d`dataproc.worker`\u89d2\u8272\uff0c\u4ee5\u5141\u8a31\u5176\u5145\u7576\u4ee3\u7406\uff1a```\ngcloud projects add-iam-policy-binding \\\n\u00a0\u00a0\u00a0\u00a0--role=roles/dataproc.worker \\\n\u00a0\u00a0\u00a0\u00a0--member=\"serviceAccount:${DPGKE_GSA}\" \\\n\u00a0\u00a0\u00a0\u00a0\"${PROJECT}\"\n```\n- \u7232 `agent` KSA \u5206\u914d `iam.workloadIdentityUser` \u89d2\u8272\uff0c\u4f7f\u5176\u53ef\u4ee5\u5145\u7576 GSA\uff1a```\ngcloud iam service-accounts add-iam-policy-binding \\\n\u00a0\u00a0\u00a0\u00a0--role=roles/iam.workloadIdentityUser \\\n\u00a0\u00a0\u00a0\u00a0--member=\"serviceAccount:${PROJECT}.svc.id.goog[${DPGKE_NAMESPACE}/agent]\" \\\n\u00a0\u00a0\u00a0\u00a0\"${DPGKE_GSA}\"\n```\n- \u7232 `spark-driver` KSA \u6388\u4e88 `iam.workloadIdentityUser` \u89d2\u8272\uff0c\u4f7f\u5176\u53ef\u4ee5\u5145\u7576 GSA\uff1a```\ngcloud iam service-accounts add-iam-policy-binding \\\n\u00a0\u00a0\u00a0\u00a0--role=roles/iam.workloadIdentityUser \\\n\u00a0\u00a0\u00a0\u00a0--member=\"serviceAccount:${PROJECT}.svc.id.goog[${DPGKE_NAMESPACE}/spark-driver]\" \\\n\u00a0\u00a0\u00a0\u00a0\"${DPGKE_GSA}\"\n```\n- \u7232 `spark-executor` KSA \u6388\u4e88 `iam.workloadIdentityUser` \u89d2\u8272\uff0c\u4f7f\u5176\u53ef\u4ee5\u5145\u7576 GSA\uff1a```\ngcloud iam service-accounts add-iam-policy-binding \\\n\u00a0\u00a0\u00a0\u00a0--role=roles/iam.workloadIdentityUser \\\n\u00a0\u00a0\u00a0\u00a0--member=\"serviceAccount:${PROJECT}.svc.id.goog[${DPGKE_NAMESPACE}/spark-executor]\" \\\n\u00a0\u00a0\u00a0\u00a0\"${DPGKE_GSA}\"\n```", "guide": "Dataproc"}