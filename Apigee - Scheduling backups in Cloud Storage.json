{"title": "Apigee - Scheduling backups in Cloud Storage", "url": "https://cloud.google.com/apigee/docs/api-platform/get-started/what-apigee", "abstract": "# Apigee - Scheduling backups in Cloud Storage\nYou are currently viewing version 1.6 of the Apigee hybrid documentation. **This version is end of life.** You should upgrade to a newer version. For more information, see [Supported versions](/apigee/docs/hybrid/supported-platforms#supported-versions) .\nThis page describes how to schedule backups for Cassandra in Cloud Storage. In this method, backups are stored in the specified Cloud Storage bucket.\n**Note:** After applying the backup configuration on the existing cluster, the Cassandra pods will restart one after another (rolling restart) from last to first.\nTo schedule Cassandra backups, perform the following steps:\n- Run the following`create-service-account`command to create a Google Cloud service account (SA) with the standard [roles/storage.objectAdmin](https://cloud.google.com/storage/docs/access-control/iam-roles) role.  This SA role allows you to write backup data  to Cloud Storage. Execute the following command in the`` `/hybrid-files`directory:```\n./tools/create-service-account --env non-prod --dir ./service-accounts\n```This command creates a single service account named`apigee-non-prod`for use in non-production environments and  places the downloaded key file in the`./service-accounts`directory. **Note:** If you prefer to create all the individual service  accounts for a production environment, use the following command:```\n./tools/create-service-account --env prod --dir ./service-accounts\n```For more information about Google Cloud service accounts, see [Creating and managing service accounts](https://cloud.google.com/iam/docs/creating-managing-service-accounts) .\n- The`create-service-account`command saves a JSON file containing the  service account private key. The file is saved in the same directory  where the command executes. You will need the path to this file  in the following steps.\n- [Create a Cloud Storage bucket](https://cloud.google.com/storage/docs/creating-buckets) .  Specify a reasonable data [ retention policy](https://cloud.google.com/storage/docs/bucket-lock#retention-policy) for the bucket. Apigee recommends a data retention policy of 15 days.\n- Open your`overrides.yaml`file.\n- Add the following`cassandra.backup`properties to enable backup. Do not  remove any of the properties that are already configured.\n```\ncassandra:\u00a0 ...\u00a0 backup:\u00a0 \u00a0 enabled: true\u00a0 \u00a0 serviceAccountPath: SA_JSON_FILE_PATH\u00a0 \u00a0 dbStorageBucket: CLOUD_STORAGE_BUCKET_PATH\u00a0 \u00a0 schedule: BACKUP_SCHEDULE_CODE\u00a0 \u00a0 cloudProvider: \"GCP\" \u00a0# For remote server backup set this to HYBRID (all caps)\u00a0 ...\u00a0 \n``````\n...cassandra:\u00a0 storage:\u00a0 \u00a0 type: gcepd\u00a0 \u00a0 capacity: 50Gi\u00a0 \u00a0 gcepd:\u00a0 \u00a0 \u00a0 replicationType: regional-pd\u00a0 auth:\u00a0 \u00a0 default:\u00a0 \u00a0 \u00a0 password: \"abc123\"\u00a0 \u00a0 admin:\u00a0 \u00a0 \u00a0 password: \"abc234\"\u00a0 \u00a0 ddl:\u00a0 \u00a0 \u00a0 password: \"abc345\"\u00a0 \u00a0 dml:\u00a0 \u00a0 \u00a0 password: \"abc456\"\u00a0 nodeSelector:\u00a0 \u00a0 key: cloud.google.com/gke-nodepool\u00a0 \u00a0 value: apigee-data\u00a0 backup:\u00a0 \u00a0 enabled: true\u00a0 \u00a0 serviceAccountPath: \"/Users/myhome/.ssh/my-cassandra-backup-sa.json\"\u00a0 \u00a0 dbStorageBucket: \"gs://myname-cassandra-backup\"\u00a0 \u00a0 schedule: \"45 23 * * 6\"\u00a0 \u00a0 cloudProvider: \"GCP\"\u00a0 \u00a0 \u00a0 ... \n```- Where:\n- | Property     | Description                                                                                                        |\n|:--------------------------|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| backup:enabled   | Backup is disabled by default. You must set this property to true.                                                                                          |\n| backup:serviceAccountPath | SA_JSON_FILE_PATH The path on your filesystem to the service account JSON file that was downloaded when you ran the ./tools/create-service-account command. You can also provide a relative file path. The path will be relative to the hybrid-base-directory/hybrid-files directory.                                     |\n| backup:dbStorageBucket | CLOUD_STORAGE_BUCKET_PATH The Cloud Storage bucket path in this format: gs://BUCKET_NAME. The gs:// is required.                                                                              |\n| backup:cloudProvider  | GCP/HYBRID For a Cloud Storage backup, set the property to GCP. For example, cloudProvider: \"GCP\". For a remote server backup, set the property to HYBRID. For example, cloudProvider: \"HYBRID\".                                                          |\n| backup:schedule   | BACKUP_SCHEDULE_CODE The time when the backup starts, specified in standard crontab syntax. Default: 0 2 * * * Note: Avoid scheduling a backup that starts a short time after you apply the backup configuration to your cluster. When you apply the backup configuration, Kubernetes recreates the Cassandra nodes. If the backup starts before the nodes restart, the first backup will fail and the subsequent backups will pass. |\n- Apply the configuration changes to the new cluster. For example:```\n$APIGEECTL_HOME/apigeectl apply --datastore -f YOUR_OVERRIDES_FILE\n```Where is the path to the overrides file you just edited.\n- Verify the backup job. For example:```\nkubectl get cronjob -n apigee\n``````\nNAME \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0SCHEDULE \u00a0 \u00a0 SUSPEND \u00a0 ACTIVE \u00a0 LAST SCHEDULE \u00a0 AGEapigee-cassandra-backup \u00a0 33 * * * * \u00a0 False \u00a0 \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0<none> \u00a0 \u00a0 \u00a0 \u00a0 \u00a094s\n``", "content": "`", "guide": "Apigee"}