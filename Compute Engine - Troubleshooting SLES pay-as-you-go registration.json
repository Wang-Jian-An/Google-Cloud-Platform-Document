{"title": "Compute Engine - Troubleshooting SLES pay-as-you-go registration", "url": "https://cloud.google.com/compute/docs/instances", "abstract": "# Compute Engine - Troubleshooting SLES pay-as-you-go registration\nThis document describes how to resolve issues you might encounter when you connect Compute Engine virtual machine (VM) instances running pay-as-you-go (PAYG) SUSE Linux Enterprise Server (SLES) to the SUSE Subscription Management Tool (SMT) repository.\n", "content": "## Before you begin\n- Ensure that the VM has an associated [service account](/compute/docs/access/service-accounts) .\n- Ensure that the [Service Metadata API](/compute/docs/instances/verifying-instance-identity) is accessible from the VM.\n- Use the [sc-repocheck](https://github.com/rfparedes/susecloud-repocheck) tool to automatically troubleshoot the issues.\n- Check the steps described in the [SUSE PAYG troubleshooting](https://opensource.suse.com/premium-support/docs/data-collection/repo-issues.html) guide.\n- If you haven't already, set up authentication. [Authentication](/compute/docs/authentication) is the process by which your identity is verified for access to Google Cloud services and APIs. To run code or samples from a local development environment, you can authenticate to Compute Engine as follows.Select the tab for how you plan to use the samples on this page:\nWhen you use the Google Cloud console to access Google Cloud services and   APIs, you don't need to set up authentication.- [Install](/sdk/docs/install) the Google Cloud CLI, then [initialize](/sdk/docs/initializing) it by running the following command:```\ngcloud init\n``` **Note:** If you installed the gcloud CLI  previously, make sure you have the latest version by running`gcloud components  update`.\n- [ Set a default region and zone](/compute/docs/gcloud-compute#set_default_zone_and_region_in_your_local_client) .\n## Network issues\n### Unresolvable domain name\nYou might encounter the following issues if the VM can't connect to the `smt-gce.susecloud.net` SMT server:\n```\nSUSEConnect error: SocketError: getaddrinfo: Name or service not known\n```\n```\nping: unknown host smt-gce.susecloud.net\n```\nThese issues are likely caused by an incorrect resolution of the SMT server domain name `smt-gce.susecloud.net` . This domain is not globally resolvable, so you must set its IP address according to the VM region, by doing the following:\nCheck the `/etc/hosts` file to make sure it contains an entry with the `smt-gce.susecloud.net` domain.\n```\ncat /etc/hosts | grep -i smt\n```\nThe output looks similar to the following, but the IP address might be different:\n```\n# Added by SMT registration do not remove, retain comment as well\n108.59.80.221 smt-gce.susecloud.net smt-gce\n```\nIf the `/etc/hosts` file doesn't contain the same lines as the preceding example, do the following:\n- Find an IP address that corresponds with your VM's region from the [list of SUSE SMT IP addresses](https://pint.suse.com/?resource=servers&csp=google&serverType=smt) .\n- Edit the file to add the SUSE SMT IP address and any other information that is missing.\n**Note:** While you can modify the `/etc/hosts` file for troubleshooting purposes, it is important to know that using the `registercloudguest` tool might overwrite your changes.\n### Network unavailability\nYou may encounter the following errors due to network unavailability, even if the VM is able to resolve Compute Engine Update Server domain name:\n```\nUnexpected exception.\nNot ready to read within timeout.\n```\n```\nRepository 'SLE-Module-Adv-Systems-Management12-Pool' is invalid.\nRepository 'SLE-Module-Adv-Systems-Management12-Updates' is invalid.\n```\nThe following are some examples of errors in the `/var/log/cloudregister` log file, yo may find during the investigation:\n```\nWARNING:Unable to remove client registration from server\nWARNING:HTTPSConnectionPool(host='smt-gce.susecloud.net', port=443): Max retries exceeded with url: /connect/systems (Caused by NewConnectionError(': Failed to establish a new connection: [Errno 110] Connection timed out',))\n```\n```\nINFO:Region server arguments: ?regionHint=europe-central2\nERROR:No response from: [('34.118.112.80', None), ('34.116.251.218', None), ('34.116.224.144', None)]\n```\nTo find out more about the cause of the issue, perform a network connectivity test. The following example shows how to test an HTTPS connection using `cURL` :\n```\ncurl -sSI -m 5 -o /dev/null \\\u00a0 -w 'Response code (>0 is OK): %{http_code}\\n' \\\u00a0 'https://smt-gce.susecloud.net'\n```\nThe output of the command contains an [HTTP response code](https://developer.mozilla.org/docs/Web/HTTP/Status) or an error message. The following are common responses and errors:\n- Successful response:```\nResponse code (>0 is OK): 200\n```\n- Request timeout error:```\nResponse code (>0 is OK): 000curl: (28) Connection timed out after 5001 milliseconds\n```\n- Unresolvable domain error:```\nResponse code (>0 is OK): 000curl: (6) Could not resolve host: smt-gce.susecloud.net\n```\n**Note:** Any response code that is greater than `0` is considered a positive response because a connection with the server was established, even if the response contains a client or server error response code.\nIn certain scenarios, such as strict host firewall rules, the default IP address associated with the `smt-gce.susecloud.net` domain might not be available. To ensure that the issue is not only related to the current IP address, perform a network connectivity tests for alternate regional servers. Retrieve the list of regional servers by doing the following:\nGo to [SUSE WebUI](https://pint.suse.com/?resource=servers&csp=google) to obtain the list of regional update servers.\nUse `pint` tool to obtain the list of regional update servers via CLI.- Install required package```\nsudo zypper install python3-susepubliccloudinfo\n```\n- Use the following command with specific region```\npint google servers --region us-central1\n```\n- The successful output contains a list of entries in XML format```\n<?xml version='1.0' encoding='UTF-8'?>\n<servers>\n <server ip=\"146.148.73.14\" name=\"\" region=\"us-central1\" type=\"regionserver-sles\"/>\n <server ip=\"162.222.182.90\" name=\"\" region=\"us-central1\" type=\"regionserver-sap\"/>\n <server ip=\"108.59.80.221\" name=\"smt-gce.susecloud.net\" region=\"us-central1\" type=\"smt\"/>\n <server ip=\"108.59.85.41\" name=\"smt-gce.susecloud.net\" region=\"us-central1\" type=\"smt\"/>\n <server ip=\"108.59.80.58\" name=\"smt-gce.susecloud.net\" region=\"us-central1\" type=\"smt\"/>\n</servers>\n```\nTo find the full list of SUSE server IPs for Google Cloud, view the following documents:\n- [Region Servers](https://susepubliccloudinfo.suse.com/v1/google/servers/regionserver.xml) \n- [SMT Servers](https://susepubliccloudinfo.suse.com/v1/google/servers/smt.xml) \nThe network unavailability may be due to VM misconfiguration. In case of issues it is necessary to perform [network diagnostics](/compute/docs/troubleshooting/troubleshooting-networking) to identify the root cause.\n### Registration failed\nYou might encounter the following error if you have VMs that have a private IP address in Cloud NAT:\n```\nERROR: Registration failed: Registering system to registration proxy https://smt-gce.susecloud.net\ncommand '/usr/bin/zypper --non-interactive refs Python_3_Module_x86_64' failed\nError: zypper returned 4 with 'Problem retrieving the repository index file for service 'Python_3_Module_x86_64':\nTimeout exceeded when accessing 'https://smt-gce.susecloud.net/services/2045/repo/repoindex.xml?credentials=Python_3_Module_x86_64'.\n```\nTo resolve this issue, review the Cloud NAT configuration to verify that the **minimum ports per VM instance** parameter is set to at least **160** .\nFor more information, check the [Registration and zypper failed for Compute Engine instances behind Cloud NAT](https://www.suse.com/support/kb/doc/?id=000019662) SUSE support bulletin.\n### No response\nIf your VM experiences problems communicating with update and region servers, you may observe the following errors:\n- `SUSEConnect` error:```\nSUSEConnect error: Errno::ETIMEDOUT: Connection timed out - connect(2) for \"smt-gce.susecloud.net\" port 443\n```\n- `zypper` error:```\nError retrieving metadata for 'SLE-Module-Adv-Systems-Management12-Pool':\nNot ready to read within timeout.\n...\n```\nThese errors can be caused by the absence of a response from update and region servers. To verify if this is the case, check the `/var/log/cloudregister` logs for similar content:\n```\nINFO:Region server arguments: ?regionHint=europe-central2\nINFO:Using API: regionInfo\nINFO:Region server arguments: ?regionHint=europe-central2\nINFO:Getting update server information, attempt 1\nINFO: Using region server: 130.211.242.136\nERROR: No response from: 130.211.242.136\nINFO: Using region server: 35.187.193.56\nERROR: No response from: 35.187.193.56\nINFO: Using region server: 162.222.182.90\nERROR: No response from: 162.222.182.90\nINFO: Using region server: 130.211.88.88\nERROR: No response from: 130.211.88.88\nERROR: None of the servers responded\nERROR: Attempted: [IPv4Address('130.211.242.136'), IPv4Address('35.187.193.56'), IPv4Address('162.222.182.90'), IPv4Address('130.211.88.88')]\n...\n...\n...\nERROR:Request not answered by any server after 3 attempts\nERROR:Exiting without registration\n```\nTo resolve this issue, try one or more of the following:\n- Confirm that the VM has an external IP address or that the Virtual Private Cloud subnet uses a NAT (either Cloud NAT or custom solution).\n- If you modified the default network routing rules, such as limiting public Internet access or routing traffic through an on-premises network, add routes manually for SMT IPs through the default gateway of Compute Engine, by doing the following:- Go to the **Routes** page in the Google Cloud console. [Go to the Routes page](https://console.cloud.google.com/networking/routes/list) \n- Under the **Route Management** tab look for a route that includes the SUSE SMT IP addresses and verify that it has the Compute Engine default gateway set as the next hop.\n- If the route is missing, you can add it by clicking on **Create Route** and entering the necessary information.\n- If you're using an internal passthrough Network Load Balancer, for example with additional intermediary network software (such as firewalls, custom NATs, etc.), make sure that the load balancer is being used as the next hop for VM traffic, by doing the following:- Go to the **VM instances** page in the Google Cloud console. [Go to the VM instances page](https://console.cloud.google.com/compute/instances) \n- Click the name of the VM you want to check. The **VM details** page opens.\n- In the **Network interfaces** section, click **View details** .\n- In the **Firewall and routes details** section locate the route that defines the path to the desired IP address range.\n- Click the name of the route and confirm that internal passthrough Network Load Balancer or its IP address is set as the next hop.\nIf there is no route that defines the path to the desired IP address range, or if the next hop of the route is different from internal passthrough Network Load Balancer, then [set up internal passthrough Network Load Balancer as the next hop](/load-balancing/docs/internal/ilb-next-hop-overview) .\n- If you're using an internal passthrough Network Load Balancer, confirm that it's located in the same region as the VM.- Go to the **VM instances** page in the Google Cloud console. [Go to the VM instances page](https://console.cloud.google.com/compute/instances) \n- Locate the VM you want to check and note down its region.\n- Go to the **Load balancing** page in the Google Cloud console. [Go to the Load balancing page](https://console.cloud.google.com/net-services/loadbalancing/list/loadBalancers) \n- Locate the internal passthrough Network Load Balancer used and check if it is in the same region as the VM.\n- If the VM and the internal passthrough Network Load Balancer aren't in the same region, enable [global access](/load-balancing/docs/internal#client-access) .\n## OS configuration issues\n### Unknown registration status\nIf you don't know whether or not your pay-as-you-go (PAYG) SUSE Linux Enterprise Server (SLES) is registered, run the following command:\n```\nsudo SUSEConnect --status-text\n```\nThe output contains the version and registration status of the SUSE products, including SUSE Linux Enterprise Server.\n```\nInstalled Products:\n-----------------------------------------\n SUSE Linux Enterprise Server 12 SP5\n (SLES/12.5/x86_64)\n Registered\n-----------------------------------------...\n```\nIf the status is `Not Registered` , start from the [re-registration](#re-registration) process to fix the issue.\n### Incorrect base product symlink\nYou may encounter the following errors if the base product link points to an incorrect product file:\n```\nERROR:Unable to obtain product information from server \"108.59.85.41,None\"\n  Unprocessable Entity\n  {\"type\":\"error\",\"error\":\"Unmet product dependencies, activate one of these products first: SUSE Linux Enterprise Server 12 x86_64...\n  ...\nUnable to register modules, exiting.\n```\nThis error is caused by an incorrect product file (i.e. `sle-module-toolchain.prod` ) being pointed to by the `/etc/products.d/baseproduct` symbolic link.\nTo resolve this issue, update the symlink at `/etc/products.d/baseproduct` to point to the appropriate base product file, by doing the following:\n- Navigate to the `/etc/products.d` directory```\n\u00a0 cd /etc/products.d\n```\n- Run the following command replacing `SLES.prod` with `SLES_SAP.prod` if SLES for SAP is installed:```\n\u00a0 sudo ln -sf SLES.prod baseproduct\n```\n**Note:** If the `SLES.prod` or `SLES_SAP.prod` product file is missing, you can [create a new VM instance](/compute/docs/create-linux-vm-instance) with the same boot disk image and copy the correct file from there to the `/etc/products.d` directory.\n### Instance identity information unavailability\nYou may encounter the following errors if the instance identity information is not available for the VM:\n```\nERROR:Data collected from stderr for instance data collection \"b'Unable to access instance identity information\\n'\"\n```\nTo access the instance metadata for [identity tokens](/compute/docs/instances/verifying-instance-identity) all VMs must be associated with a [service account](/compute/docs/access/service-accounts) .\nFor more information, read the [Public Cloud Infrastructure Update](https://www.suse.com/support/kb/doc/?id=000019633) .\nTo check that the VM is relevant to this situation, run the following command on the VM:\n```\ncurl -s -H 'Metadata-Flavor: Google' \\\u00a0 'http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/identity?audience=test'\n```\nExample of a successful response with an identity token:\n```\neyJhbGciOiJSUzI1NiIsImtpZCI6IjkzOTd0MDQxSHQ2NDNxNzkzUjY1MDIwNzEyMjZPNnppaTdqNTl3eTciLCJ0eXAiOiJKV1QifQ.eyJhdWQiOiJ0ZXN0IiwiYXpwIjoiMjY1MDIwMDUyMzgzMjYyNTk0ODU2IiwiZXhwIjoxNjgzNzEyNTQzLCJpYXQiOjE2ODM3MTI4NjQsImlzcyI6Imh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbSIsInN1YiI6IjQ1NjA2MzQ5MDg5Mzc0Njg3ODI5NyJ9.EpzQ3NZ8mKStdpH10fL34qsKG0rjQEflzvLJLm2tVNX4xBJAkMhi8lcs5InUEY-QMK3njgbzdzNtD1fXoIfKoeWsqkA8vG3NkBz5zqRrtaB2STcO14H5tjIdTBsrCtET447tRXlGG5cvgMcWnRDZG92-jUZEpWki_Ri4T69X5-bBWkfE2Thm3oSUW4fScdeVOEmOgWnzD2jeVqQ_2YniywvpkT-rLzKfN-5AgN66zgBfXqJVTC90KFMebfiaOoL7z6ZSM9AjZGf45QEMZjxjd-Xzyee6ZWK8s0RE3hJlytb3zYcLt3tJwQ1WhnrC2ToJ-ZmKxxK3xKDLCvCQ6Ny5to\n```\nIf the metadata returned is not a token but an error message such as the following, the VM is affected:\n```\n{\n \"error\": \"invalid_request\",\n \"error_description\": \"Service account not enabled on this instance\"\n}\n```\nTo remediate this issue, perform the following steps:\n- Stop the VM:```\ngcloud compute instances stop VM_NAME\n```\n- Add a service account to the VM:```\ngcloud compute instances set-service-account VM_NAME \\\u00a0 --service account SERVICE_ACCOUNT \\\u00a0 --no-scopes\n``` **Note:** Flag `--no-scopes` removes all scopes from the VM. If no flag is specified for access scope, default scopes will be assigned to the compute instance's service account, or the service account will retain its current scopes.\n- Start the VM:```\ngcloud compute instances start VM_NAME\n```\n- After adding the missing service account, run the following command from the VM to re-register the SLES:```\nsudo registercloudguest --force-new\n```Check details in the [re-registration](#re-registration) section.\n### Registration behind proxies\nYou might encounter an issue if your VMs configured to utilize any kind of proxying software. The following example demonstrates an attempt to register SLES via an HTTP proxy.\n```\nERROR: Baseproduct registration failed\nERROR: Registering system to registration proxy https://smt-gce.susecloud.net\nAnnouncing system to https://smt-gce.susecloud.net ...\nSUSEConnect error: Net::HTTPFatalError: 503 \"Service Unavailable\"\n```\nSUSE on Compute Engine does not provide official support for operating system registration when performed through intermediaries that modify the original communication, such as proxies of man-in-the-middle (MITM) or non-transparent types.\n**Note:** It is important to note that Google Cloud does not accept any responsibility for the registration process using 3rd-party proxying software.\nThe official solution to resolve this issue is to [Set up Cloud NAT](/nat/docs/set-up-manage-network-address-translation) and route VM traffic through it.\n## Common workarounds\n### Re-registration\nIn some cases, a re-registration approach can be used to work around registration issues.\nTo force a new registration use the following command:\n```\nsudo registercloudguest --force-new\n```\nIf successful, the following line will be output.\n```\nRegistration succeeded\n```\nDetails of re-registration process can be found in the `/var/log/cloudregister` .\n```\nINFO:Forced new registration\nINFO:Clean current registration server: ('108.59.80.221', None)\n...\nINFO:Starting new HTTP connection (1): 169.254.169.254\nINFO:Region server arguments: ?regionHint=us-central1\nINFO:Using region server: 130.211.242.136\nINFO:Starting new HTTPS connection (1): 130.211.242.136\nINFO:Starting new HTTPS connection (1): 108.59.80.58\nINFO:Modified /etc/hosts, added: 108.59.80.58 smt-gce.susecloud.net smt-gce\n...\nINFO:Starting new HTTPS connection (1): 108.59.80.58\nDEBUG:\"GET /api/health/status HTTP/1.1\" 200 None\nINFO:Current update server will be used: \"('108.59.80.58', None)\"\nINFO:Starting new HTTPS connection (1): smt-gce.susecloud.net\nDEBUG:\"POST /connect/systems/products/migrations HTTP/1.1\" 422 None\nINFO:Registration: /usr/sbin/SUSEConnect --url https://smt-gce.susecloud.net --product sle-module-containers/12/x86_64 --instance-data /var/lib/cloudregister/9c982106-78de-48fe-a662-20383da4c760\n```\n```\nINFO:Forced new registration\nINFO:Using API: regionInfo\nINFO:Starting new HTTP connection (1): 169.254.169.254\nINFO:Region server arguments: ?regionHint=us-central1\nINFO:Using region server: 130.211.242.136\nINFO:Starting new HTTPS connection (1): 130.211.242.136\nERROR:No response from: 130.211.242.136\nINFO:Using region server: 130.211.88.88\nINFO:Starting new HTTPS connection (1): 130.211.88.88\nERROR:No response from: 130.211.88.88\nINFO:Using region server: 146.148.73.14\nINFO:Starting new HTTPS connection (1): 146.148.73.14\nERROR:No response from: 146.148.73.14\nERROR:None of the servers responded\nERROR: Attempted: ['130.211.242.136', '130.211.88.88', '146.148.73.14']\nERROR:Exiting without registration\n```\n**Note:** If the re-registration process failed, this may be due to the [Incorrect base product symlink](#incorrect_base_product_symlink) .\n### Deregistration\nIn some cases, such as major release upgrade, you may encounter the following errors because the system is already registered to SUMA:\n```\nCan't get available migrations from server: SUSE::Connect::ApiError: The requested products 'SUSE Manager Client Tools for SLE 12 x86_64' are not activated on the system.\n```\n```\nThis system is managed by SUSE manager.\n```\nResolve the issue, by doing the following:\n- Remove the SUSE Manager Client Tools module as described in the [Deleting modules and extensions](https://documentation.suse.com/smart/linux/single-html/task-delete-modules-extensions/index.html) guide.\n- Deregister from SUMA, by following the [How to deregister a SUSE Manager Client](https://www.suse.com/support/kb/doc/?id=000018170) guide.\n- Run the following commands from VM to cleanup old registration:```\n\u00a0 sudo SUSEConnect --cleanup && \\\u00a0 \u00a0 sudo registercloudguest --clean && \\\u00a0 \u00a0 sudo rm -f /etc/SUSEConnect && \\\u00a0 \u00a0 sudo rm -f /etc/zypp/{repos,services,credentials}.d/* && \\\u00a0 \u00a0 sudo rm -f /var/lib/cloudregister/* && \\\u00a0 \u00a0 sudo rm -rf /var/cache/zypp/* && \\\u00a0 \u00a0 sudo rm -rf /var/cache/cloudregister/* && \\\u00a0 \u00a0 sudo sed -i '/^# Added by SMT reg/,+1d' /etc/hosts\n```\n- Run the following command to register the system again:```\n\u00a0 sudo registercloudguest --force-new\n```Check details in the [re-registration](#re-registration) section.\n- When the registration process is done, refresh the services and repositories, and check if all the expected repositories for the system provided by the SMT server are present:```\n\u00a0 sudo zypper ref -s && \\\u00a0 \u00a0 sudo zypper ls && \\\u00a0 \u00a0 sudo zypper lr -U\n```", "guide": "Compute Engine"}