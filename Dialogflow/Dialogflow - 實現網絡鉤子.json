{"title": "Dialogflow - \u5be6\u73fe\u7db2\u7d61\u9264\u5b50", "url": "https://cloud.google.com/dialogflow/cx/docs/how/webhook?hl=zh-cn", "abstract": "# Dialogflow - \u5be6\u73fe\u7db2\u7d61\u9264\u5b50\n\u672c\u6307\u5357\u63d0\u4f9b\u4e86\u6709\u95dc\u5be6\u73fe [\u7db2\u7d61\u9264\u5b50](https://cloud.google.com/dialogflow/cx/docs/concept/webhook?hl=zh-cn) \u7684\u5404\u7a2e\u793a\u4f8b\uff0c\u4ee5\u53ca\u7db2\u7d61\u9264\u5b50\u554f\u984c\u6392\u67e5\u5efa\u8b70\u3002\n", "content": "## \u8a2d\u7f6e\u6703\u8a71\u53c3\u6578\n\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u77ad\u5982\u4f55\u8a2d\u7f6e\u6703\u8a71\u53c3\u6578\u3002\n\u8981\u5411 Dialogflow \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u8a2d\u7f6e\u61c9\u7528\u9ed8\u8a8d\u6191\u64da\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7232\u672c\u5730\u958b\u767c\u74b0\u5883\u8a2d\u7f6e\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/docs/authentication/provide-credentials-adc?hl=zh-cn#local-dev) \u3002\n\u8acb\u53c3\u95b1\n [Webhook \u5feb\u901f\u5165\u9580](https://cloud.google.com/dialogflow/cx/docs/quick/webhook?hl=zh-cn) \n\u3002\n\u8981\u5411 Dialogflow \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u8a2d\u7f6e\u61c9\u7528\u9ed8\u8a8d\u6191\u64da\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7232\u672c\u5730\u958b\u767c\u74b0\u5883\u8a2d\u7f6e\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/docs/authentication/provide-credentials-adc?hl=zh-cn#local-dev) \u3002\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/java-docs-samples/blob/HEAD/dialogflow-cx/src/main/java/dialogflow/cx/WebhookConfigureSessionParameters.java) \n```\n// TODO: Change class name to Example// TODO: Uncomment the line below before running cloud function// package com.example;import com.google.cloud.functions.HttpFunction;import com.google.cloud.functions.HttpRequest;import com.google.cloud.functions.HttpResponse;import com.google.gson.Gson;import com.google.gson.GsonBuilder;import com.google.gson.JsonObject;import java.io.BufferedWriter;public class WebhookConfigureSessionParameters implements HttpFunction {\u00a0 @Override\u00a0 public void service(HttpRequest request, HttpResponse response) throws Exception {\u00a0 \u00a0 JsonObject orderParameter = new JsonObject();\u00a0 \u00a0 orderParameter.addProperty(\"order_number\", \"12345\");\u00a0 \u00a0 JsonObject parameterObject = new JsonObject();\u00a0 \u00a0 parameterObject.add(\"parameters\", orderParameter);\u00a0 \u00a0 // Creates webhook response object\u00a0 \u00a0 JsonObject webhookResponse = new JsonObject();\u00a0 \u00a0 webhookResponse.add(\"session_info\", parameterObject);\u00a0 \u00a0 Gson gson = new GsonBuilder().setPrettyPrinting().create();\u00a0 \u00a0 String jsonResponseObject = gson.toJson(webhookResponse);\u00a0 \u00a0 /** { \"session_info\": { \"parameters\": { \"order_number\": \"12345\" } } } */\u00a0 \u00a0 BufferedWriter writer = response.getWriter();\u00a0 \u00a0 // Sends the webhookResponseObject\u00a0 \u00a0 writer.write(jsonResponseObject.toString());\u00a0 }}\n```\u8981\u5411 Dialogflow \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u8a2d\u7f6e\u61c9\u7528\u9ed8\u8a8d\u6191\u64da\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7232\u672c\u5730\u958b\u767c\u74b0\u5883\u8a2d\u7f6e\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/docs/authentication/provide-credentials-adc?hl=zh-cn#local-dev) \u3002\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/nodejs-docs-samples/blob/HEAD/dialogflow-cx/webhook-configure-session-parameters.js) \n```\nconst functions = require('@google-cloud/functions-framework');functions.http('configureSessionParams', (request, response) => {\u00a0 // Session parameter configured by the webhook\u00a0 const orderNumber = 123;\u00a0 const jsonResponse = {\u00a0 \u00a0 sessionInfo: {\u00a0 \u00a0 \u00a0 parameters: {\u00a0 \u00a0 \u00a0 \u00a0 orderNumber: orderNumber,\u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 },\u00a0 };\u00a0 response.send(jsonResponse);});\n```\u8981\u5411 Dialogflow \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u8a2d\u7f6e\u61c9\u7528\u9ed8\u8a8d\u6191\u64da\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7232\u672c\u5730\u958b\u767c\u74b0\u5883\u8a2d\u7f6e\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/docs/authentication/provide-credentials-adc?hl=zh-cn#local-dev) \u3002\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/python-docs-samples/blob/HEAD/dialogflow-cx/webhook_configure_session_parameters.py) \n```\nimport functions_framework# TODO (developer): change entry point to configure_session_params in Cloud Function@functions_framework.httpdef configure_session_params(request):\u00a0 \u00a0 \"\"\"Webhook to validate or configure new session parameters.\"\"\"\u00a0 \u00a0 order_number = 123\u00a0 \u00a0 json_response = {\u00a0 \u00a0 \u00a0 \u00a0 \"sessionInfo\": {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"parameters\": {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"orderNumber\": order_number,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 }\u00a0 \u00a0 return json_response\n```\n## \u8fd4\u56de\u57f7\u884c\u65b9\u5f0f\u97ff\u61c9\n\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u77ad\u5982\u4f55\u8fd4\u56de\u57f7\u884c\u65b9\u5f0f\u97ff\u61c9\u3002\n**\u6ce8\u610f** \uff1a\u6700\u4f73\u5be6\u8e10\u662f\u8a2d\u7f6e\u6703\u8a71\u53c3\u6578\uff0c\u800c\u4e0d\u662f\u57f7\u884c\u65b9\u5f0f\u97ff\u61c9\u3002\u9019\u6a23\uff0c\u4ee3\u7406\u57f7\u884c\u65b9\u5f0f\u5c31\u53ef\u4ee5\u4e00\u81f4\u5730\u63a7\u5236\u52d5\u614b\u97ff\u61c9\u3002\n\u8981\u5411 Dialogflow \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u8a2d\u7f6e\u61c9\u7528\u9ed8\u8a8d\u6191\u64da\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7232\u672c\u5730\u958b\u767c\u74b0\u5883\u8a2d\u7f6e\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/docs/authentication/provide-credentials-adc?hl=zh-cn#local-dev) \u3002\n\u8acb\u53c3\u95b1\n [Webhook \u5feb\u901f\u5165\u9580](https://cloud.google.com/dialogflow/cx/docs/quick/webhook?hl=zh-cn) \n\u3002\n\u8981\u5411 Dialogflow \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u8a2d\u7f6e\u61c9\u7528\u9ed8\u8a8d\u6191\u64da\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7232\u672c\u5730\u958b\u767c\u74b0\u5883\u8a2d\u7f6e\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/docs/authentication/provide-credentials-adc?hl=zh-cn#local-dev) \u3002\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/java-docs-samples/blob/HEAD/dialogflow/basic-webhook/src/main/java/com/example/dialogflow/cx/BasicWebhook.java) \n```\n// TODO: Change class name to Example// TODO: add GSON dependency to Pom file// (https://mvnrepository.com/artifact/com.google.code.gson/gson/2.8.5)// TODO: Uncomment the line bellow before running cloud function// package com.example;import com.google.cloud.functions.HttpFunction;import com.google.cloud.functions.HttpRequest;import com.google.cloud.functions.HttpResponse;import com.google.gson.Gson;import com.google.gson.GsonBuilder;import com.google.gson.JsonObject;import com.google.gson.JsonParser;import java.io.BufferedWriter;public class BasicWebhook implements HttpFunction {\u00a0 @Override\u00a0 public void service(HttpRequest request, HttpResponse response) throws Exception {\u00a0 \u00a0 Gson gson = new GsonBuilder().create();\u00a0 \u00a0 JsonObject parsedRequest = gson.fromJson(request.getReader(), JsonObject.class);\u00a0 \u00a0 // For more information on the structure of this object https://cloud.google.com/dialogflow/cx/docs/reference/rest/v3/Fulfillment\u00a0 \u00a0 String requestTag = parsedRequest.getAsJsonObject(\"fulfillmentInfo\")\u00a0 \u00a0 \u00a0 \u00a0 .getAsJsonPrimitive(\"tag\").toString();\u00a0 \u00a0 JsonObject responseObject = null;\u00a0 \u00a0 String defaultIntent = \"\\\"Default Welcome Intent\\\"\";\u00a0 \u00a0 String secondIntent = \"\\\"get-agent-name\\\"\";\u00a0 \u00a0 String responseText = \"\";\u00a0 \u00a0 // Compares the Intent Tag to provide the correct response\u00a0 \u00a0 if (requestTag.equals(defaultIntent)) {\u00a0 \u00a0 \u00a0 responseText = \"\\\"Hello from a Java GCF Webhook\\\"\";\u00a0 \u00a0 } else if (requestTag.equals(secondIntent)) {\u00a0 \u00a0 \u00a0 responseText = \"\\\"My name is Flowhook\\\"\";\u00a0 \u00a0 } else {\u00a0 \u00a0 \u00a0 responseText = \"\\\"Sorry I didn't get that\\\"\";\u00a0 \u00a0 }\u00a0 \u00a0 // Constructing the response jsonObject\u00a0 \u00a0 responseObject =\u00a0 \u00a0 \u00a0 \u00a0 JsonParser\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .parseString(\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"{ \\\"fulfillment_response\\\": { \\\"messages\\\": [ { \\\"text\\\": { \\\"text\\\": [\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 + responseText\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 + \"] } } ] } }\")\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .getAsJsonObject();\u00a0 \u00a0 BufferedWriter writer = response.getWriter();\u00a0 \u00a0 //Sends the responseObject\u00a0 \u00a0 writer.write(responseObject.toString());\u00a0 }}\n```\u8981\u5411 Dialogflow \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u8a2d\u7f6e\u61c9\u7528\u9ed8\u8a8d\u6191\u64da\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7232\u672c\u5730\u958b\u767c\u74b0\u5883\u8a2d\u7f6e\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/docs/authentication/provide-credentials-adc?hl=zh-cn#local-dev) \u3002\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/nodejs-docs-samples/blob/HEAD/dialogflow-cx/webhooks.js) \n```\nconst functions = require('@google-cloud/functions-framework');functions.http('handleWebhook', (request, response) => {\u00a0 const tag = request.body.fulfillmentInfo.tag;\u00a0 let text = '';\u00a0 if (tag === 'Default Welcome Intent') {\u00a0 \u00a0 text = 'Hello from a GCF Webhook';\u00a0 } else if (tag === 'get-name') {\u00a0 \u00a0 text = 'My name is Flowhook';\u00a0 } else {\u00a0 \u00a0 text = `There are no fulfillment responses defined for \"${tag}\"\" tag`;\u00a0 }\u00a0 const jsonResponse = {\u00a0 \u00a0 fulfillment_response: {\u00a0 \u00a0 \u00a0 messages: [\u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 text: {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 //fulfillment text response to be sent to the agent\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 text: [text],\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 ],\u00a0 \u00a0 },\u00a0 };\u00a0 response.send(jsonResponse);});\n```\u8981\u5411 Dialogflow \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u8a2d\u7f6e\u61c9\u7528\u9ed8\u8a8d\u6191\u64da\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7232\u672c\u5730\u958b\u767c\u74b0\u5883\u8a2d\u7f6e\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/docs/authentication/provide-credentials-adc?hl=zh-cn#local-dev) \u3002\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/python-docs-samples/blob/HEAD/dialogflow-cx/webhook.py) \n```\nimport functions_framework# TODO(developer): change entry point to handle_webhook in cloud function@functions_framework.httpdef handle_webhook(request):\u00a0 \u00a0 req = request.get_json()\u00a0 \u00a0 tag = req[\"fulfillmentInfo\"][\"tag\"]\u00a0 \u00a0 if tag == \"Default Welcome Intent\":\u00a0 \u00a0 \u00a0 \u00a0 text = \"Hello from a GCF Webhook\"\u00a0 \u00a0 elif tag == \"get-name\":\u00a0 \u00a0 \u00a0 \u00a0 text = \"My name is Flowhook\"\u00a0 \u00a0 else:\u00a0 \u00a0 \u00a0 \u00a0 text = f\"There are no fulfillment responses defined for {tag} tag\"\u00a0 \u00a0 # You can also use the google.cloud.dialogflowcx_v3.types.WebhookRequest protos instead of manually writing the json object\u00a0 \u00a0 # Please see https://googleapis.dev/python/dialogflow/latest/dialogflow_v2/types.html?highlight=webhookresponse#google.cloud.dialogflow_v2.types.WebhookResponse for an overview\u00a0 \u00a0 res = {\"fulfillment_response\": {\"messages\": [{\"text\": {\"text\": [text]}}]}}\u00a0 \u00a0 # Returns json\u00a0 \u00a0 return res\n```\n## \u6839\u64da\u9700\u8981\u8a2d\u7f6e\u8868\u55ae\u53c3\u6578\n\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u77ad\u5982\u4f55\u6839\u64da\u9700\u8981\u6a19\u8a18\u53c3\u6578\u3002\n\u8981\u5411 Dialogflow \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u8a2d\u7f6e\u61c9\u7528\u9ed8\u8a8d\u6191\u64da\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7232\u672c\u5730\u958b\u767c\u74b0\u5883\u8a2d\u7f6e\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/docs/authentication/provide-credentials-adc?hl=zh-cn#local-dev) \u3002\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/java-docs-samples/blob/HEAD/dialogflow-cx/src/main/java/dialogflow/cx/ConfigureWebhookToSetFormParametersAsOptionalOrRequired.java) \n```\n// TODO: Change class name to Example// TODO: Uncomment the line below before running cloud function// package com.example;import com.google.cloud.functions.HttpFunction;import com.google.cloud.functions.HttpRequest;import com.google.cloud.functions.HttpResponse;import com.google.gson.Gson;import com.google.gson.GsonBuilder;import com.google.gson.JsonArray;import com.google.gson.JsonObject;import java.io.BufferedWriter;public class ConfigureWebhookToSetFormParametersAsOptionalOrRequired implements HttpFunction {\u00a0 @Override\u00a0 public void service(HttpRequest request, HttpResponse response) throws Exception {\u00a0 \u00a0 JsonObject parameterObject = new JsonObject();\u00a0 \u00a0 parameterObject.addProperty(\"display_name\", \"order_number\");\u00a0 \u00a0 parameterObject.addProperty(\"required\", \"true\");\u00a0 \u00a0 parameterObject.addProperty(\"state\", \"VALID\");\u00a0 \u00a0 JsonArray parameterInfoList = new JsonArray();\u00a0 \u00a0 parameterInfoList.add(parameterObject);\u00a0 \u00a0 JsonObject parameterInfoObject = new JsonObject();\u00a0 \u00a0 parameterInfoObject.add(\"parameter_info\", parameterInfoList);\u00a0 \u00a0 JsonObject formInfo = new JsonObject();\u00a0 \u00a0 formInfo.add(\"form_info\", parameterInfoObject);\u00a0 \u00a0 // Constructs the webhook response object\u00a0 \u00a0 JsonObject webhookResponse = new JsonObject();\u00a0 \u00a0 webhookResponse.add(\"page_info\", formInfo);\u00a0 \u00a0 Gson gson = new GsonBuilder().setPrettyPrinting().create();\u00a0 \u00a0 String jsonResponseObject = gson.toJson(webhookResponse);\u00a0 \u00a0 /* {\u00a0 \u00a0 \u00a0* \u00a0 \"page_info\": {\u00a0 \u00a0 \u00a0* \u00a0 \u00a0 \"form_info\": {\u00a0 \u00a0 \u00a0* \u00a0 \u00a0 \u00a0 \"parameter_info\": [\u00a0 \u00a0 \u00a0* \u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0* \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"display_name\": \"order_number\",\u00a0 \u00a0 \u00a0* \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"required\": \"true\",\u00a0 \u00a0 \u00a0* \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"state\": \"VALID\"\u00a0 \u00a0 \u00a0* \u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0* \u00a0 \u00a0 \u00a0 ]\u00a0 \u00a0 \u00a0* \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0* \u00a0 }\u00a0 \u00a0 \u00a0* }\u00a0 \u00a0 \u00a0*/\u00a0 \u00a0 BufferedWriter writer = response.getWriter();\u00a0 \u00a0 // Sends the responseObject\u00a0 \u00a0 writer.write(jsonResponseObject.toString());\u00a0 }}\n```\u8981\u5411 Dialogflow \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u8a2d\u7f6e\u61c9\u7528\u9ed8\u8a8d\u6191\u64da\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7232\u672c\u5730\u958b\u767c\u74b0\u5883\u8a2d\u7f6e\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/docs/authentication/provide-credentials-adc?hl=zh-cn#local-dev) \u3002\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/nodejs-docs-samples/blob/HEAD/dialogflow-cx/configure-webhook-to-set-form-parameter-as-optional-or-required.js) \n```\nconst functions = require('@google-cloud/functions-framework');functions.http('configureOptionalFormParam', (request, response) => {\u00a0 // The value of the parameter that the webhook will set as optional or required.\u00a0 // Note that the webhook cannot add or remove any form parameter\u00a0 const jsonResponse = {\u00a0 \u00a0 pageInfo: {\u00a0 \u00a0 \u00a0 formInfo: {\u00a0 \u00a0 \u00a0 \u00a0 parameterInfo: [\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 displayName: 'order-number',\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 // if required: false, the agent will not reprompt for this parameter, even if the state is 'INVALID'\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 required: true,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 state: 'VALID',\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 ],\u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 },\u00a0 };\u00a0 // Info about form parameter that is sent in the webhook response:\u00a0 console.log(\u00a0 \u00a0 'Parameter Info: \\n',\u00a0 \u00a0 jsonResponse.pageInfo.formInfo.parameterInfo[0]\u00a0 );\u00a0 response.send(jsonResponse);});\n```\n## \u9a57\u8b49\u8868\u55ae\u53c3\u6578\n\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u77ad\u5982\u4f55\u9a57\u8b49\u8868\u55ae\u53c3\u6578\u3002\n\u8981\u5411 Dialogflow \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u8a2d\u7f6e\u61c9\u7528\u9ed8\u8a8d\u6191\u64da\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7232\u672c\u5730\u958b\u767c\u74b0\u5883\u8a2d\u7f6e\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/docs/authentication/provide-credentials-adc?hl=zh-cn#local-dev) \u3002\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/java-docs-samples/blob/HEAD/dialogflow-cx/src/main/java/dialogflow/cx/WebhookValidateFormParameter.java) \n```\n// TODO: Change class name to Example// TODO: Uncomment the line below before running cloud function// package com.example;import com.google.cloud.functions.HttpFunction;import com.google.cloud.functions.HttpRequest;import com.google.cloud.functions.HttpResponse;import com.google.gson.Gson;import com.google.gson.GsonBuilder;import com.google.gson.JsonArray;import com.google.gson.JsonObject;import java.io.BufferedWriter;public class WebhookValidateFormParameter implements HttpFunction {\u00a0 @Override\u00a0 public void service(HttpRequest request, HttpResponse response) throws Exception {\u00a0 \u00a0 JsonObject sessionInfo = new JsonObject();\u00a0 \u00a0 JsonObject sessionParameter = new JsonObject();\u00a0 \u00a0 sessionParameter.addProperty(\"order_number\", \"null\");\u00a0 \u00a0 sessionInfo.add(\"parameters\", sessionParameter);\u00a0 \u00a0 JsonObject parameterObject = new JsonObject();\u00a0 \u00a0 parameterObject.addProperty(\"display_name\", \"order_number\");\u00a0 \u00a0 parameterObject.addProperty(\"required\", \"true\");\u00a0 \u00a0 parameterObject.addProperty(\"state\", \"INVALID\");\u00a0 \u00a0 parameterObject.addProperty(\"value\", \"123\");\u00a0 \u00a0 JsonArray parameterInfoList = new JsonArray();\u00a0 \u00a0 parameterInfoList.add(parameterObject);\u00a0 \u00a0 JsonObject parameterInfoObject = new JsonObject();\u00a0 \u00a0 parameterInfoObject.add(\"parameter_info\", parameterInfoList);\u00a0 \u00a0 JsonObject pageInfo = new JsonObject();\u00a0 \u00a0 pageInfo.add(\"form_info\", parameterInfoObject);\u00a0 \u00a0 // Constructs the webhook response object\u00a0 \u00a0 JsonObject webhookResponse = new JsonObject();\u00a0 \u00a0 webhookResponse.add(\"page_info\", pageInfo);\u00a0 \u00a0 webhookResponse.add(\"session_info\", sessionInfo);\u00a0 \u00a0 Gson gson = new GsonBuilder().setPrettyPrinting().create();\u00a0 \u00a0 String jsonResponseObject = gson.toJson(webhookResponse);\u00a0 \u00a0 /**\u00a0 \u00a0 \u00a0* { \"page_info\": { \"form_info\": { \"parameter_info\": [ { \"display_name\": \"order_number\",\u00a0 \u00a0 \u00a0* \"required\": \"true\", \"state\": \"INVALID\", \"value\": \"123\" } ] } }, \"session_info\": {\u00a0 \u00a0 \u00a0* \"parameters\": { \"order_number\": \"null\" } } }\u00a0 \u00a0 \u00a0*/\u00a0 \u00a0 BufferedWriter writer = response.getWriter();\u00a0 \u00a0 // Sends the responseObject\u00a0 \u00a0 writer.write(jsonResponseObject.toString());\u00a0 }}\n```\u8981\u5411 Dialogflow \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u8a2d\u7f6e\u61c9\u7528\u9ed8\u8a8d\u6191\u64da\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7232\u672c\u5730\u958b\u767c\u74b0\u5883\u8a2d\u7f6e\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/docs/authentication/provide-credentials-adc?hl=zh-cn#local-dev) \u3002\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/nodejs-docs-samples/blob/HEAD/dialogflow-cx/webhook-validate-form-parameter.js) \n```\nconst functions = require('@google-cloud/functions-framework');functions.http('validateParameter', (request, response) => {\u00a0 // Webhook will validate or invalidate parameter based on logic configured by the user.\u00a0 // Access parameter values through the webhook request via `request.body.pageInfo.formInfo.parameterInfo[]`\u00a0 const jsonResponse = {\u00a0 \u00a0 page_info: {\u00a0 \u00a0 \u00a0 form_info: {\u00a0 \u00a0 \u00a0 \u00a0 parameter_info: [\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 displayName: 'orderNumber',\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 required: true,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 state: 'INVALID',\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 value: 123,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 ],\u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 },\u00a0 \u00a0 sessionInfo: {\u00a0 \u00a0 \u00a0 parameters: {\u00a0 \u00a0 \u00a0 \u00a0 // Set session parameter to null if the form parameter is 'INVALID' and your agent needs to reprompt the user\u00a0 \u00a0 \u00a0 \u00a0 orderNumber: null,\u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 },\u00a0 };\u00a0 response.send(jsonResponse);});\n```\u8981\u5411 Dialogflow \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u8a2d\u7f6e\u61c9\u7528\u9ed8\u8a8d\u6191\u64da\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7232\u672c\u5730\u958b\u767c\u74b0\u5883\u8a2d\u7f6e\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/docs/authentication/provide-credentials-adc?hl=zh-cn#local-dev) \u3002\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/python-docs-samples/blob/HEAD/dialogflow-cx/webhook_validate_form_parameter.py) \n```\nimport functions_framework@functions_framework.httpdef validate_parameter(request):\u00a0 \u00a0 \"\"\"Webhook will validate or invalidate parameter based on logic configured by the user.\"\"\"\u00a0 \u00a0 return {\u00a0 \u00a0 \u00a0 \u00a0 \"page_info\": {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"form_info\": {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"parameter_info\": [\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"displayName\": \"orderNumber\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"required\": True,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"state\": \"INVALID\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"value\": 123,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ],\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 \"sessionInfo\": {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"parameters\": {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 # Set session parameter to None if the form parameter is 'INVALID' and your agent needs to reprompt the user\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"orderNumber\": None,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 }\n```\n## \u8a18\u9304\u6703\u8a71 ID\n\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u77ad\u5982\u4f55\u8a18\u9304 webhook \u8acb\u6c42\u4e2d\u7684 `session ID` \u3002\n\u8981\u5411 Dialogflow \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u8a2d\u7f6e\u61c9\u7528\u9ed8\u8a8d\u6191\u64da\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7232\u672c\u5730\u958b\u767c\u74b0\u5883\u8a2d\u7f6e\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/docs/authentication/provide-credentials-adc?hl=zh-cn#local-dev) \u3002\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/python-docs-samples/blob/HEAD/dialogflow-cx/webhook_log_session_info.py) \n```\nimport reimport functions_framework@functions_framework.httpdef log_session_id_for_troubleshooting(request):\u00a0 \u00a0 \"\"\"Webhook will log session id corresponding to request.\"\"\"\u00a0 \u00a0 req = request.get_json()\u00a0 \u00a0 # You can read more about SessionInfo at https://cloud.google.com/dialogflow/cx/docs/reference/rest/v3/SessionInfo\u00a0 \u00a0 # Use a regex pattern to get the session ID\u00a0 \u00a0 session_id_regex = r\".+\\/sessions\\/(.+)\"\u00a0 \u00a0 session = req[\"sessionInfo\"][\"session\"]\u00a0 \u00a0 regex_match = re.search(session_id_regex, session)\u00a0 \u00a0 session_id = regex_match.group(1)\u00a0 \u00a0 # Instead of printing, use the logging tools available to you\u00a0 \u00a0 print(f\"Debug Node: session ID = {session_id}\")\u00a0 \u00a0 # Return a generic response\u00a0 \u00a0 res = {\u00a0 \u00a0 \u00a0 \u00a0 \"fulfillment_response\": {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"messages\": [{\"text\": {\"text\": [f\"Request Session ID: {session_id}\"]}}]\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 }\u00a0 \u00a0 # Returns json\u00a0 \u00a0 return res\n```\n## \u554f\u984c\u6392\u67e5\n\u5728\u5c0d\u7db2\u7d61\u9264\u5b50\u9032\u884c\u554f\u984c\u6392\u67e5\u6642\uff0c\u8a18\u9304\u7db2\u7d61\u9264\u5b50\u4e2d\u7684\u6703\u8a71 ID \u6703\u5f88\u6709\u5e6b\u52a9\u3002 [WebhookRequest](https://cloud.google.com/dialogflow/cx/docs/concept/webhook?hl=zh-cn#webhook-request) \u7684 `sessionInfo.session` \u5b57\u6bb5\u5305\u542b\u6703\u8a71 ID\u3002\u6bcf\u500b\u5c0d\u8a71\u7684\u6703\u8a71 ID \u61c9\u8a72\u662f\u552f\u4e00\u7684\uff0c\u4e26\u4e14\u6709\u52a9\u65bc\u60a8\u6bd4\u8f03\u4f7f\u7528\u76f8\u540c\u6703\u8a71 ID \u7684\u8acb\u6c42\u7684\u4ee3\u7406\u65e5\u8a8c\u8207\u7db2\u7d61\u9264\u5b50\u65e5\u8a8c\u3002\u4e0a\u9762\u7684 [\u8a18\u9304\u6703\u8a71 ID](#session-id) \u90e8\u5206\u4ecb\u7d39\u77ad\u5982\u4f55\u5f9e webhook \u8a18\u9304\u6703\u8a71 ID\u3002\n\u6b64\u5916\uff0c\u5982\u679c\u60a8\u5728 [Cloud Functions](https://cloud.google.com/functions?hl=zh-cn) \u6216\u985e\u4f3c\u7684 Google Cloud \u7121\u670d\u52d9\u5668\u65b9\u6848\u4e0a\u8a17\u7ba1 webhook\uff0c\u5247\u53ef\u4ee5\u4f7f\u7528 [\u65e5\u8a8c\u689d\u76ee](https://cloud.google.com/logging/docs/reference/v2/rest/v2/LogEntry?hl=zh-cn) \u4e2d\u7684 `trace` \u5b57\u6bb5\u4f5c\u7232\u65e5\u8a8c\u904e\u6ffe\u689d\u4ef6\u3002\u55ae\u6b21\u57f7\u884c\u51fd\u6578\u5c07\u7522\u751f\u5177\u6709\u76f8\u540c\u8ddf\u8e64\u8a18\u9304\u503c\u7684\u591a\u500b\u65e5\u8a8c\u689d\u76ee\u3002\n\u4ee5\u4e0b\u793a\u4f8b\u4f7f\u7528\u6703\u8a71 ID \u548c\u8ddf\u8e64\u8a18\u9304\u503c\u5c07\u7279\u5b9a Dialogflow \u4ee3\u7406\u932f\u8aa4\u65e5\u8a8c\u8207\u76f8\u61c9\u7684 Cloud Functions \u7db2\u7d61\u9264\u5b50\u65e5\u8a8c\u689d\u76ee\u76f8\u95dc\u806f\u3002\u8a72\u793a\u4f8b\u5c0d\u5553\u7528\u4e86 [Cloud Logging](https://cloud.google.com/dialogflow/cx/docs/concept/logging?hl=zh-cn#enable) \u7684\u4ee3\u7406\u4f7f\u7528 [Cloud Logging \u904e\u6ffe\u689d\u4ef6](https://cloud.google.com/logging/docs/view/building-queries?hl=zh-cn) \u3002\n### 1. \u904e\u6ffe\u7279\u5b9a\u4ee3\u7406\u7684\u932f\u8aa4\u65e5\u8a8c\u7684 Dialogflow \u65e5\u8a8c\n\u4f7f\u7528\u4ee5\u4e0b Cloud Logging \u904e\u6ffe\u689d\u4ef6\u4f86\u904e\u6ffe\u7279\u5b9a\u4ee3\u7406\u7684\u932f\u8aa4\u65e5\u8a8c\u7684 Dialogflow \u65e5\u8a8c\uff1a\n```\nlabels.location_id=\"global\"\nlabels.agent_id=\"AGENT_ID\"\nseverity=ERROR\n```\nwebhook \u65e5\u8a8c\u932f\u8aa4\u689d\u76ee\u5982\u4e0b\u6240\u793a\uff1a\n```\n{\u00a0 \"insertId\": \"-zi368ye1ie3r\",\u00a0 \"jsonPayload\": {\u00a0 \u00a0 \"message\": \"Webhook error: State: URL_UNREACHABLE, Reason: UNREACHABLE_5xx, HTTP status code: 500\",\u00a0 \u00a0 \"code\": 14\u00a0 },\u00a0 \"resource\": {\u00a0 \u00a0 \"type\": \"global\",\u00a0 \u00a0 \"labels\": {\u00a0 \u00a0 \u00a0 \"project_id\": \"PROJECT_ID\"\u00a0 \u00a0 }\u00a0 },\u00a0 \"timestamp\": \"2022-10-05T19:44:53.098938Z\",\u00a0 \"severity\": \"ERROR\",\u00a0 \"labels\": {\u00a0 \u00a0 \"session_id\": \"ec8781-f28-7e6-791-d7e992e8f\",\u00a0 \u00a0 \"location_id\": \"global\",\u00a0 \u00a0 \"agent_id\": \"807346f0-f501-42b5-9642-af59d5e98165\"\u00a0 },\u00a0 \"logName\": \"projects/PROJECT_ID/logs/dialogflow-runtime.googleapis.com%2Frequests\",\u00a0 \"receiveTimestamp\": \"2022-10-05T19:44:53.222552658Z\"}\n```\n\u8acb\u6ce8\u610f `labels.session_id` \u5b57\u6bb5\uff0c\u5176\u4e2d\u5305\u542b\u6703\u8a71 ID\u3002\u60a8\u5c07\u5728\u4e0b\u4e00\u6b65\u4e2d\u4f7f\u7528\u8a72\u6703\u8a71 ID\u3002\n### 2. \u6839\u64da\u6703\u8a71 ID \u904e\u6ffe Cloud Functions \u51fd\u6578\u65e5\u8a8c\n\u4f7f\u7528\u4ee5\u4e0b Cloud Logging \u904e\u6ffe\u689d\u4ef6\u4f86\u904e\u6ffe\u76f8\u61c9\u6703\u8a71 ID \u7684 Cloud Function \u51fd\u6578\u65e5\u8a8c\uff1a\n**\u6ce8\u610f** \uff1a\u6b64\u904e\u6ffe\u689d\u4ef6\u5047\u5b9a\u60a8\u4f7f\u7528\u8207\u4e0a\u8ff0 [\u8a18\u9304\u6703\u8a71 ID](#session-id) \u793a\u4f8b\u5b8c\u5168\u76f8\u540c\u7684\u6587\u5b57\u4f86\u8a18\u9304\u6703\u8a71 ID\u3002\n```\nresource.type = \"cloud_function\"\nresource.labels.function_name = \"CLOUD_FUNCTION_NAME\"\nresource.labels.region = \"CLOUD_FUNCTION_REGION\"\ntextPayload=\"Debug Node: session ID = SESSION_ID\"\n```\n\u751f\u6210\u7684\u65e5\u8a8c\u8207\u5728\u63d0\u4f9b\u7684 [\u6703\u8a71](https://cloud.google.com/dialogflow/cx/docs/concept/session?hl=zh-cn) \u671f\u9593\u751f\u6210\u7684\u7db2\u7d61\u9264\u5b50\u65e5\u8a8c\u76f8\u5c0d\u61c9\u3002\u4f8b\u5982\uff1a\n```\n{\u00a0 \"textPayload\": \"Debug Node: session ID = ec8781-f28-7e6-791-d7e992e8f\",\u00a0 \"insertId\": \"632bdb2b000b7c6c77d0cc62\",\u00a0 \"resource\": {\u00a0 \u00a0 \"type\": \"cloud_function\",\u00a0 \u00a0 \"labels\": {\u00a0 \u00a0 \u00a0 \"project_id\": \"PROJECT_ID\",\u00a0 \u00a0 \u00a0 \"function_name\": \"webhook\",\u00a0 \u00a0 \u00a0 \"region\": \"us-central1\"\u00a0 \u00a0 }\u00a0 },\u00a0 \"timestamp\": \"2022-10-05T19:44:53.098938Z\",\u00a0 \"severity\": \"INFO\",\u00a0 \"labels\": {\u00a0 \u00a0 \"execution_id\": \"ozt5bnz50eeo\",\u00a0 \u00a0 \"instance_id\": \"00c61b117c1f116421aa5503bc80f9aa636b9ef117bb2722f3d54414085e62be6e55af0aa0250a63534262b31a3d3a14af8c940203f1915db8b25b\"\u00a0 },\u00a0 \"logName\": \"projects/PROJECT_ID/logs/cloudfunctions.googleapis.com%2Fcloud-functions\",\u00a0 \"trace\": \"projects/PROJECT_ID/traces/e41eefc1fac48665b442bfa400cc2f5e\",\u00a0 \"receiveTimestamp\": \"2022-10-05T19:44:53.222552658Z\"}\n```\n\u8a18\u4e0b `trace` \u5b57\u6bb5\uff0c\u4e0b\u4e00\u6b65\u6703\u7528\u5230\u3002\n### 3. \u904e\u6ffe\u7279\u5b9a\u8ddf\u8e64\u8a18\u9304\u7684 Cloud Functions \u51fd\u6578\u65e5\u8a8c\n\u4f7f\u7528\u4ee5\u4e0b Cloud Logging \u904e\u6ffe\u689d\u4ef6\u4f86\u904e\u6ffe\u7279\u5b9a\u8ddf\u8e64\u8a18\u9304\u7684 Cloud Function \u65e5\u8a8c\uff1a\n```\nresource.type = \"cloud_function\"\nresource.labels.function_name = \"CLOUD_FUNCTION_NAME\"\nresource.labels.region = \"CLOUD_FUNCTION_REGION\"\ntrace=\"projects/PROJECT_ID/traces/TRACE_ID\"\n```\n\u5176\u4e2d `TRACE_ID` \u662f\u8ddf\u8e64\u8a18\u9304\u7684\u6700\u5f8c\u4e00\u6bb5\u3002\u4f8b\u5982\uff0c `projects/PROJECT_ID/traces/e41eefc1fac48665b442bfa400cc2f5e` \u7684 `TRACE_ID` \u7232 `e41eefc1fac48665b442bfa400cc2f5e` \u3002\n\u751f\u6210\u7684\u65e5\u8a8c\u5c0d\u61c9\u65bc\u57f7\u884c webhook \u8acb\u6c42\u671f\u9593\u751f\u6210\u7684\u6240\u6709 webhook \u65e5\u8a8c\uff0c\u9019\u4e9b\u65e5\u8a8c\u8207\u7b2c 1 \u6b65\u4e2d\u7684\u6703\u8a71 ID \u548c\u7b2c 2 \u6b65\u4e2d\u7684\u8ddf\u8e64\u8a18\u9304\u76f8\u95dc\u806f\u3002", "guide": "Dialogflow"}