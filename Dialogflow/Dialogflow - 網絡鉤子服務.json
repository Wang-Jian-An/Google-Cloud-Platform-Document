{"title": "Dialogflow - \u7db2\u7d61\u9264\u5b50\u670d\u52d9", "url": "https://cloud.google.com/dialogflow/es/docs/fulfillment-webhook?hl=zh-cn", "abstract": "# Dialogflow - \u7db2\u7d61\u9264\u5b50\u670d\u52d9\n\u5982\u9700\u5728\u751f\u7522\u7cfb\u7d71\u4e2d\u4f7f\u7528 fulfillment\uff0c\u60a8\u61c9\u5be6\u73fe\u4e26\u90e8\u7f72\u7db2\u7d61\u9264\u5b50\u670d\u52d9\u3002\u5982\u9700\u8655\u7406 fulfillment\uff0c\u60a8\u7684\u7db2\u7d61\u9264\u5b50\u670d\u52d9\u9700\u8981\u63a5\u53d7 JSON \u8acb\u6c42\u4e26\u8fd4\u56de\u672c\u6307\u5357\u4e2d\u6307\u5b9a\u7684 JSON \u97ff\u61c9\u3002 [fulfillment \u6982\u89bd\u6587\u6a94](https://cloud.google.com/dialogflow/docs/fulfillment-overview?hl=zh-cn) \u4e2d\u4ecb\u7d39\u4e86\u95dc\u65bc fulfillment \u548c\u7db2\u7d61\u9264\u5b50\u7684\u8a73\u7d30\u8655\u7406\u6d41\u7a0b\u3002\n", "content": "## \u7db2\u7d61\u9264\u5b50\u670d\u52d9\u8981\u6c42\n\u60a8\u7684\u7db2\u7d61\u9264\u5b50\u670d\u52d9\u5fc5\u9808\u6eff\u8db3\u4ee5\u4e0b\u8981\u6c42\uff1a\n- \u5b83\u5fc5\u9808\u8655\u7406 HTTPS \u8acb\u6c42\u3002\u4e0d\u652f\u6301 HTTP\u3002\u5982\u679c\u60a8\u4f7f\u7528 [\u8a08\u7b97](https://cloud.google.com/products/compute?hl=zh-cn) \u6216 [\u7121\u670d\u52d9\u5668\u8a08\u7b97](https://cloud.google.com/serverless?hl=zh-cn) \u89e3\u6c7a\u65b9\u6848\u5728 Google Cloud Platform \u4e0a\u8a17\u7ba1\u7db2\u7d61\u9264\u5b50\u670d\u52d9\uff0c\u8acb\u53c3\u95b1\u4f7f\u7528 HTTPS \u670d\u52d9\u7684\u7522\u54c1\u6587\u6a94\u3002\u5c0d\u65bc\u5176\u4ed6\u8a17\u7ba1\u9805\uff0c\u8acb\u53c3\u95b1 [\u7372\u53d6\u60a8\u7db2\u57df\u7684 SSL \u8b49\u66f8](https://support.google.com/domains/answer/7630973?hl=zh-cn) \u3002\n- \u5176\u8acb\u6c42\u7684\u7db2\u5740\u9808\u53ef\u516c\u958b\u8a2a\u554f\u3002\n- \u5b83\u5fc5\u9808\u4f7f\u7528 JSON [WebhookRequest](#webhook_request) \u6b63\u6587\u8655\u7406 POST \u8acb\u6c42\u3002\n- \u5b83\u5fc5\u9808\u4f7f\u7528 JSON [WebhookResponse](#webhook_response) \u6b63\u6587\u4f86\u97ff\u61c9`WebhookRequest`\u8acb\u6c42\u3002## \u8eab\u4efd\u9a57\u8b49\n\u8acb\u52d9\u5fc5\u4fdd\u8b77\u60a8\u7684\u7db2\u7d61\u9264\u5b50\u670d\u52d9\uff0c\u78ba\u4fdd\u53ea\u6709\u60a8\u6216\u60a8\u7684 Dialogflow \u4ee3\u7406\u7e94\u6709\u6b0a\u767c\u51fa\u8acb\u6c42\u3002Dialogflow \u652f\u6301\u4ee5\u4e0b\u8eab\u4efd\u9a57\u8b49\u6a5f\u5236\uff1a\n- \u4f7f\u7528\u767b\u9304\u540d\u548c\u5bc6\u78bc\u9032\u884c\u57fa\u672c\u7684\u8eab\u4efd\u9a57\u8b49\u3002\u9019\u5728 [\u5553\u7528](#enable) fulfillment \u6642\u9032\u884c\u914d\u7f6e\u3002\n- [\u4f7f\u7528 Cloud Functions](#gcf) \n- \u4f7f\u7528\u8eab\u4efd\u9a57\u8b49\u6a19\u982d\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u9019\u5728 [\u5553\u7528](#enable) fulfillment \u6642\u9032\u884c\u914d\u7f6e\u3002\n- [\u96d9\u5411 TLS \u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/dialogflow/docs/fulfillment-mtls?hl=zh-cn) \u3002\n**\u6ce8\u610f** \uff1aDialogflow \u7121\u6cd5\u4fdd\u8b49\u767c\u9001\u7db2\u7d61\u9264\u5b50\u8acb\u6c42\u7684\u6a5f\u5668\u7684 IP \u5730\u5740\u7bc4\u570d\u3002\u60a8\u61c9\u8a72\u4f7f\u7528\u4e0a\u9762\u5217\u51fa\u7684\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u4e4b\u4e00\uff0c\u800c\u4e0d\u662f\u901a\u904e IP \u5730\u5740\u7bc4\u570d\u9650\u5236\u8a2a\u554f\u6b0a\u9650\u3002\n## \u7db2\u7d61\u9264\u5b50\u8acb\u6c42\n\u7576\u7232 fulfillment \u914d\u7f6e\u7684\u610f\u5716\u5339\u914d\u6642\uff0cDialogflow \u6703\u5411\u60a8\u7684\u7db2\u7d61\u9264\u5b50\u670d\u52d9\u767c\u9001 HTTPS POST \u7db2\u7d61\u9264\u5b50\u8acb\u6c42\u3002\u6b64\u8acb\u6c42\u7684\u6b63\u6587\u662f\u4e00\u500b JSON \u5c0d\u8c61\uff0c\u5176\u4e2d\u5305\u542b\u6709\u95dc\u5339\u914d\u610f\u5716\u7684\u4fe1\u606f\u3002\n\u9664\u4e86\u6700\u7d42\u7528\u6236\u67e5\u8a62\u4e4b\u5916\uff0c\u8a31\u591a\u96c6\u6210\u9084\u6703\u767c\u9001\u4e00\u4e9b\u6709\u95dc\u6700\u7d42\u7528\u6236\u7684\u4fe1\u606f\u3002\u4f8b\u5982\uff0c\u7528\u65bc\u552f\u4e00\u6a19\u8b58\u7528\u6236\u7684 ID\u3002\u60a8\u53ef\u4ee5\u901a\u904e\u7db2\u7d61\u9264\u5b50\u8acb\u6c42\u4e2d\u7684 `originalDetectIntentRequest` \u5b57\u6bb5\u8a2a\u554f\u6b64\u4fe1\u606f\uff0c\u6b64\u4fe1\u606f\u5305\u542b\u5f9e\u96c6\u6210\u5e73\u81fa\u767c\u9001\u7684\u4fe1\u606f\u3002\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [WebhookRequest](https://cloud.google.com/dialogflow/docs/reference/common-types?hl=zh-cn#webhookrequest) \u53c3\u8003\u6587\u6a94\u3002\n\u4ee5\u4e0b\u662f\u8acb\u6c42\u793a\u4f8b\uff1a\n```\n{\n \"responseId\": \"response-id\",\n \"session\": \"projects/project-id/agent/sessions/session-id\",\n \"queryResult\": {\n \"queryText\": \"End-user expression\",\n \"parameters\": {\n  \"param-name\": \"param-value\"\n },\n \"allRequiredParamsPresent\": true,\n \"fulfillmentText\": \"Response configured for matched intent\",\n \"fulfillmentMessages\": [  {\n  \"text\": {\n   \"text\": [   \"Response configured for matched intent\"\n   ]\n  }\n  }\n ],\n \"outputContexts\": [  {\n  \"name\": \"projects/project-id/agent/sessions/session-id/contexts/context-name\",\n  \"lifespanCount\": 5,\n  \"parameters\": {\n   \"param-name\": \"param-value\"\n  }\n  }\n ],\n \"intent\": {\n  \"name\": \"projects/project-id/agent/intents/intent-id\",\n  \"displayName\": \"matched-intent-name\"\n },\n \"intentDetectionConfidence\": 1,\n \"diagnosticInfo\": {},\n \"languageCode\": \"en\"\n },\n \"originalDetectIntentRequest\": {}\n}\n```\n## \u7db2\u7d61\u9264\u5b50\u97ff\u61c9\n\u4e00\u65e6\u7db2\u7d61\u9264\u5b50\u6536\u5230\u7db2\u7d61\u9264\u5b50\u8acb\u6c42\uff0c\u5176\u9700\u8981\u767c\u9001\u4e00\u500b\u7db2\u7d61\u9264\u5b50\u97ff\u61c9\u3002\u6b64\u97ff\u61c9\u7684\u6b63\u6587\u7232 JSON \u5c0d\u8c61\uff0c\u5176\u5305\u542b\u4ee5\u4e0b\u4fe1\u606f\uff1a\n- Dialogflow \u8fd4\u56de\u7d66\u6700\u7d42\u7528\u6236\u7684 [\u97ff\u61c9](https://cloud.google.com/dialogflow/docs/intents-responses?hl=zh-cn) \u3002\n- \u66f4\u65b0\u5c0d\u8a71\u7684\u6709\u6548 [\u4e0a\u4e0b\u6587](https://cloud.google.com/dialogflow/docs/contexts-overview?hl=zh-cn) \u3002\n- \u7528\u65bc\u89f8\u767c\u610f\u5716\u5339\u914d\u7684 [\u5f8c\u7e8c\u4e8b\u4ef6](https://cloud.google.com/dialogflow/docs/events-overview?hl=zh-cn) \u3002\n- \u5c07\u767c\u9001\u5230 [\u96c6\u6210](https://cloud.google.com/dialogflow/docs/integrations?hl=zh-cn) \u6216 [\u6aa2\u6e2c\u610f\u5716\u5ba2\u6236\u7aef](https://cloud.google.com/dialogflow/docs/api-overview?hl=zh-cn#detect-intent) \u7684 [\u81ea\u5b9a\u7fa9\u8f09\u8377](https://cloud.google.com/dialogflow/docs/intents-rich-messages?hl=zh-cn#custom) \n\u60a8\u7684\u97ff\u61c9\u6703\u53d7\u5230\u4ee5\u4e0b\u9650\u5236\uff1a\n- \u5c0d\u65bc [Google \u52a9\u7406](https://cloud.google.com/dialogflow/docs/integrations/aog?hl=zh-cn) \u61c9\u7528\uff0c\u97ff\u61c9\u5fc5\u9808\u5728 10 \u79d2\u5167\u767c\u751f\uff1b\u5c0d\u65bc\u5176\u4ed6\u6240\u6709\u61c9\u7528\uff0c\u97ff\u61c9\u5fc5\u9808\u5728 5 \u79d2\u5167\u767c\u751f\uff0c\u5426\u5247\u8acb\u6c42\u6703\u8d85\u6642\u3002\n- \u97ff\u61c9\u5927\u5c0f\u4e0d\u5f97\u8d85\u904e 64 KiB\u3002\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [WebhookResponse](https://cloud.google.com/dialogflow/docs/reference/common-types?hl=zh-cn#webhookresponse) \u53c3\u8003\u6587\u6a94\u3002\n### \u6587\u672c\u97ff\u61c9\n[\u6587\u672c\u97ff\u61c9](https://cloud.google.com/dialogflow/docs/intents-rich-messages?hl=zh-cn#text) \u793a\u4f8b\uff1a\n```\n{\n \"fulfillmentMessages\": [ {\n  \"text\": {\n  \"text\": [   \"Text response from webhook\"\n  ]\n  }\n }\n ]\n}\n```\n### \u5361\u7247\u97ff\u61c9\n[\u5361\u7247\u97ff\u61c9](https://cloud.google.com/dialogflow/docs/intents-rich-messages?hl=zh-cn#card) \u793a\u4f8b\uff1a\n```\n{\n \"fulfillmentMessages\": [ {\n  \"card\": {\n  \"title\": \"card title\",\n  \"subtitle\": \"card text\",\n  \"imageUri\": \"https://example.com/images/example.png\",\n  \"buttons\": [   {\n   \"text\": \"button text\",\n   \"postback\": \"https://example.com/path/for/end-user/to/follow\"\n   }\n  ]\n  }\n }\n ]\n}\n```\n### Google \u52a9\u7406\u97ff\u61c9\n[Google \u52a9\u7406\u97ff\u61c9](https://cloud.google.com/dialogflow/docs/intents-rich-messages?hl=zh-cn#aog) \u793a\u4f8b\uff1a\n```\n{\n \"payload\": {\n \"google\": {\n  \"expectUserResponse\": true,\n  \"richResponse\": {\n  \"items\": [   {\n   \"simpleResponse\": {\n    \"textToSpeech\": \"this is a Google Assistant response\"\n   }\n   }\n  ]\n  }\n }\n }\n}\n```\n### Context\n\u8a2d\u7f6e [\u8f38\u51fa\u4e0a\u4e0b\u6587](https://cloud.google.com/dialogflow/docs/contexts-input-output?hl=zh-cn#output_contexts) \u7684\u793a\u4f8b\uff1a\n```\n{\n \"fulfillmentMessages\": [ {\n  \"text\": {\n  \"text\": [   \"Text response from webhook\"\n  ]\n  }\n }\n ],\n \"outputContexts\": [ {\n  \"name\": \"projects/project-id/agent/sessions/session-id/contexts/context-name\",\n  \"lifespanCount\": 5,\n  \"parameters\": {\n  \"param-name\": \"param-value\"\n  }\n }\n ]\n}\n```\n### Event\n\u8abf\u7528 [\u81ea\u5b9a\u7fa9\u4e8b\u4ef6](https://cloud.google.com/dialogflow/docs/events-custom?hl=zh-cn) \u7684\u793a\u4f8b\uff1a\n```\n{\n \"followupEventInput\": {\n \"name\": \"event-name\",\n \"languageCode\": \"en-US\",\n \"parameters\": {\n  \"param-name\": \"param-value\"\n }\n }\n}\n```\n### \u6703\u8a71\u5be6\u9ad4\n\u8a2d\u7f6e [\u6703\u8a71\u5be6\u9ad4](https://cloud.google.com/dialogflow/docs/entities-session?hl=zh-cn) \u7684\u793a\u4f8b\uff1a\n```\n{\n \"fulfillmentMessages\": [ {\n  \"text\": {\n  \"text\": [   \"Choose apple or orange\"\n  ]\n  }\n }\n ],\n \"sessionEntityTypes\":[ {\n  \"name\":\"projects/project-id/agent/sessions/session-id/entityTypes/fruit\",\n  \"entities\":[  {\n   \"value\":\"APPLE_KEY\",\n   \"synonyms\":[   \"apple\",\n   \"green apple\",\n   \"crabapple\"\n   ]\n  },\n  {\n   \"value\":\"ORANGE_KEY\",\n   \"synonyms\":[   \"orange\"\n   ]\n  }\n  ],\n  \"entityOverrideMode\":\"ENTITY_OVERRIDE_MODE_OVERRIDE\"\n }\n ]\n}\n```\n## \u5553\u7528\u548c\u7ba1\u7406 fulfillment\n\u5982\u9700\u901a\u904e\u63a7\u5236\u6aaf\u7232\u60a8\u7684\u4ee3\u7406\u5553\u7528\u548c\u7ba1\u7406 fulfillment\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u8f49\u5230 [Dialogflow ES \u63a7\u5236\u6aaf](https://dialogflow.cloud.google.com?hl=zh-cn) \u3002\n- \u9078\u64c7\u4e00\u500b\u4ee3\u7406\u3002\n- \u9078\u64c7\u5de6\u5074\u908a\u6b04\u83dc\u55ae\u4e2d\u7684 **Fulfillment** \u3002\n- \u5c07 **\u7db2\u8def\u9264\u5b50** \u5b57\u6bb5\u5207\u63db\u7232 **\u5df2\u5553\u7528** \u3002\n- \u5728\u8868\u55ae\u4e2d\u63d0\u4f9b\u7db2\u7d61\u9264\u5b50\u670d\u52d9\u7684\u8a73\u7d30\u4fe1\u606f\u3002\u5982\u679c\u60a8\u7684\u7db2\u7d61\u9264\u5b50\u4e0d\u9700\u8981\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u5c07\u8eab\u4efd\u9a57\u8b49\u5b57\u6bb5\u7559\u7a7a\u3002\n- \u9ede\u64ca\u9801\u9762\u5e95\u90e8\u7684 **\u4fdd\u5b58** \u3002\u8981\u4f7f\u7528 API \u7232\u4ee3\u7406\u5553\u7528\u548c\u7ba1\u7406 fulfillment\uff0c\u8acb\u53c3\u95b1 [\u4ee3\u7406\u53c3\u8003](https://cloud.google.com/dialogflow/docs/reference/common-types?hl=zh-cn#agents) \u3002 `getFulfillment` \u548c `updateFulfillment` \u65b9\u6cd5\u53ef\u7528\u65bc\u7ba1\u7406 fulfillment \u8a2d\u7f6e\u3002\n\u5982\u9700\u901a\u904e\u63a7\u5236\u6aaf\u7232\u610f\u5716\u5553\u7528 fulfillment\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u5728\u5de6\u5074\u908a\u6b04\u83dc\u55ae\u4e2d\u9078\u64c7 **\u610f\u5716** (Intents)\u3002\n- \u9078\u64c7\u4e00\u500b\u610f\u5716\u3002\n- \u5411\u4e0b\u6efe\u52d5\u5230 **Fulfillment** \u90e8\u5206\u3002\n- \u958b\u5553 **\u7232\u6b64\u610f\u5716\u5553\u7528 webhook \u8abf\u7528** \u3002\n- \u9ede\u64ca **\u4fdd\u5b58** \u3002\n\u5982\u9700\u4f7f\u7528 API \u7232\u610f\u5716\u5553\u7528 fulfillment\uff0c\u8acb\u53c3\u95b1 [\u610f\u5716\u53c3\u8003](https://cloud.google.com/dialogflow/docs/reference/common-types?hl=zh-cn#intents) \u3002\u5c07 `webhookState` \u5b57\u6bb5\u8a2d\u7f6e\u7232 `WEBHOOK_STATE_ENABLED` \u3002\n## \u7db2\u7d61\u9264\u5b50\u932f\u8aa4\n\u5982\u679c\u60a8\u7684\u7db2\u7d61\u9264\u5b50\u670d\u52d9\u767c\u751f\u932f\u8aa4\uff0c\u5247\u6703\u8fd4\u56de\u4ee5\u4e0b\u67d0\u500b HTTP \u72c0\u614b\u4ee3\u78bc\uff1a\n- `400`Bad Request\n- `401`Unauthorized\n- `403`Forbidden\n- `404`Not found\n- `500`Server fault\n- `503`Service Unavailable\n\u5728\u4ee5\u4e0b\u4efb\u4f55\u4e00\u7a2e\u932f\u8aa4\u60c5\u6cc1\u4e0b\uff0cDialogflow \u90fd\u6703\u4f7f\u7528\u7232\u7576\u524d\u5339\u914d\u7684\u610f\u5716\u914d\u7f6e\u7684\u5167\u7f6e\u97ff\u61c9\u4f86\u97ff\u61c9\u6700\u7d42\u7528\u6236\uff1a\n- \u97ff\u61c9\u5df2\u8d85\u6642\u3002\n- \u6536\u5230\u932f\u8aa4\u72c0\u614b\u4ee3\u78bc\u3002\n- \u7121\u6548\u97ff\u61c9\u3002\n- \u7db2\u7d61\u9264\u5b50\u670d\u52d9\u4e0d\u53ef\u7528\u3002\n\u6b64\u5916\uff0c\u5982\u679c\u610f\u5716\u5339\u914d\u7531 [\u6aa2\u6e2c\u610f\u5716 API \u8abf\u7528](https://cloud.google.com/dialogflow/docs/api-overview?hl=zh-cn#detect-intent) \u89f8\u767c\uff0c\u5247\u6aa2\u6e2c\u610f\u5716\u97ff\u61c9\u4e2d\u7684 `status` \u5b57\u6bb5\u5305\u542b\u7db2\u7d61\u9264\u5b50\u932f\u8aa4\u4fe1\u606f\u3002\u4f8b\u5982\uff1a\n```\n\"status\": {\u00a0 \u00a0 \"code\": 206,\u00a0 \u00a0 \"message\": \"Webhook call failed. <details of the error...>\"}\n```\n## \u4f7f\u7528 Cloud Functions\n\u60a8\u53ef\u4ee5\u901a\u904e\u591a\u7a2e\u65b9\u5f0f\u4f7f\u7528 Cloud Functions \u9032\u884c\u5c65\u884c\u3002Dialogflow [\u5167\u5d4c\u7de8\u8f2f\u5668](https://cloud.google.com/dialogflow/es/docs/fulfillment-inline-editor?hl=zh-cn) \u8207 [Cloud Functions](https://cloud.google.com/functions/docs?hl=zh-cn) \u96c6\u6210\u3002\u4f7f\u7528\u5167\u5d4c\u7de8\u8f2f\u5668\u5275\u5efa\u548c\u4fee\u6539\u7db2\u7d61\u9264\u5b50\u4ee3\u78bc\u6642\uff0cDialogflow \u6703\u8207 Cloud Functions \u51fd\u6578\u5efa\u7acb\u5b89\u5168\u9023\u63a5\u3002\n\u60a8\u9084\u53ef\u4ee5\u9078\u64c7\u4f7f\u7528\u5167\u5d4c\u7de8\u8f2f\u5668\u5275\u5efa\u7684 Cloud Functions \u51fd\u6578\uff08\u53ef\u80fd\u662f\u56e0\u7232\u60a8\u60f3\u8981\u4f7f\u7528 Node.js \u4ee5\u5916\u7684\u8a9e\u8a00\uff09\u3002\u5982\u679c Cloud Functions \u51fd\u6578\u8207\u60a8\u7684\u4ee3\u7406\u4f4d\u65bc\u540c\u4e00\u9805\u76ee\u4e2d\uff0c\u5247\u4ee3\u7406\u53ef\u4ee5\u8abf\u7528\u60a8\u7684\u7db2\u7d61\u9264\u5b50\uff0c\u800c\u7121\u9700\u4efb\u4f55\u7279\u6b8a\u914d\u7f6e\u3002\n\u4f46\u662f\uff0c\u5728\u4e0b\u9762\u5169\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u60a8\u5fc5\u9808\u624b\u52d5\u8a2d\u7f6e\u6b64\u96c6\u6210\uff1a\n- \u60a8\u7684\u4ee3\u7406\u9805\u76ee\u5fc5\u9808\u5b58\u5728\u5177\u6709\u4ee5\u4e0b\u5730\u5740\u7684 **Dialogflow Service Agent** [\u670d\u52d9\u5e33\u865f](https://cloud.google.com/iam/docs/understanding-service-accounts?hl=zh-cn) \uff1a```\nservice-agent-project-number@gcp-sa-dialogflow.iam.gserviceaccount.com\n```\u7576\u60a8\u7232\u9805\u76ee\u5275\u5efa\u7b2c\u4e00\u500b\u4ee3\u7406\u6642\uff0c\u901a\u5e38\u6703\u81ea\u52d5\u5275\u5efa\u9019\u500b\u7279\u6b8a\u7684\u670d\u52d9\u5e33\u865f\u53ca\u95dc\u806f\u7684\u5bc6\u9470\u3002\u5982\u679c\u60a8\u7684\u4ee3\u7406\u662f 2021 \u5e74 5 \u6708 10 \u65e5\u4e4b\u524d\u5275\u5efa\u7684\uff0c\u5247\u60a8\u53ef\u80fd\u9700\u8981\u4f7f\u7528\u4ee5\u4e0b\u4ee3\u78bc\u89f8\u767c\u5275\u5efa\u6b64\u7279\u6b8a\u670d\u52d9\u5e33\u865f\uff1a\n- \u7232\u9805\u76ee\u5275\u5efa\u65b0\u7684\u4ee3\u7406\u3002\n- \u57f7\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud beta services identity create --service=dialogflow.googleapis.com --project=agent-project-id\n```\n- \u5982\u679c\u7db2\u7d61\u9264\u5b50\u51fd\u6578\u4f4d\u65bc\u8207\u4ee3\u7406\u4e0d\u540c\u7684\u9805\u76ee\u4e2d\uff0c\u5247\u5fc5\u9808\u63d0\u4f9b **Cloud Functions Invoker** [IAM \u89d2\u8272](https://cloud.google.com/iam/docs/understanding-roles?hl=zh-cn) **Dialogflow \u670d\u52d9\u4ee3\u7406** \u670d\u52d9\u5e33\u865f\u3002## \u670d\u52d9\u8eab\u4efd\u4ee4\u724c\nDialogflow \u8abf\u7528\u7db2\u7d61\u9264\u5b50\u6642\uff0c\u6703\u901a\u904e\u8acb\u6c42\u63d0\u4f9b [Google \u8eab\u4efd\u4ee4\u724c](https://developers.google.com/identity/sign-in/web/backend-auth?hl=zh-cn) \u3002\u4efb\u4f55\u7db2\u7d61\u9264\u5b50\u90fd\u53ef\u4ee5\u9078\u64c7\u6027\u5730\u4f7f\u7528 Google \u5ba2\u6236\u7aef\u5eab\u6216 [github.com/googleapis/google-auth-library-nodejs](https://github.com/googleapis/google-auth-library-nodejs) \u7b49\u958b\u6e90\u5eab\u9a57\u8b49\u4ee4\u724c\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u6309\u4ee5\u4e0b\u65b9\u5f0f\u9a57\u8b49 ID \u4ee4\u724c\u7684 `email` \uff1a\n```\nservice-agent-project-number@gcp-sa-dialogflow.iam.gserviceaccount.com\n```\n## \u793a\u4f8b\n\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u77ad\u5982\u4f55\u63a5\u6536 `WebhookRequest` \u4ee5\u53ca\u767c\u9001 `WebhookResponse` \u3002\u9019\u4e9b\u793a\u4f8b\u5f15\u7528\u4e86\u5728 [\u5feb\u901f\u5165\u9580](https://cloud.google.com/dialogflow/docs/quick/build-agent?hl=zh-cn) \u4e2d\u5275\u5efa\u7684\u610f\u5716\u3002\n```\nimport (\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"log\"\n\t\"net/http\"\n)\ntype intent struct {\n\tDisplayName string `json:\"displayName\"`\n}\ntype queryResult struct {\n\tIntent intent `json:\"intent\"`\n}\ntype text struct {\n\tText []string `json:\"text\"`\n}\ntype message struct {\n\tText text `json:\"text\"`\n}\n// webhookRequest is used to unmarshal a WebhookRequest JSON object. Note that\n// not all members need to be defined--just those that you need to process.\n// As an alternative, you could use the types provided by\n// the Dialogflow protocol buffers:\n// https://godoc.org/google.golang.org/genproto/googleapis/cloud/dialogflow/v2#WebhookRequest\ntype webhookRequest struct {\n\tSession  string  `json:\"session\"`\n\tResponseID string  `json:\"responseId\"`\n\tQueryResult queryResult `json:\"queryResult\"`\n}\n// webhookResponse is used to marshal a WebhookResponse JSON object. Note that\n// not all members need to be defined--just those that you need to process.\n// As an alternative, you could use the types provided by\n// the Dialogflow protocol buffers:\n// https://godoc.org/google.golang.org/genproto/googleapis/cloud/dialogflow/v2#WebhookResponse\ntype webhookResponse struct {\n\tFulfillmentMessages []message `json:\"fulfillmentMessages\"`\n}\n// welcome creates a response for the welcome intent.\nfunc welcome(request webhookRequest) (webhookResponse, error) {\n\tresponse := webhookResponse{\n\t\tFulfillmentMessages: []message{\n\t\t\t{\n\t\t\t\tText: text{\n\t\t\t\t\tText: []string{\"Welcome from Dialogflow Go Webhook\"},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t}\n\treturn response, nil\n}\n// getAgentName creates a response for the get-agent-name intent.\nfunc getAgentName(request webhookRequest) (webhookResponse, error) {\n\tresponse := webhookResponse{\n\t\tFulfillmentMessages: []message{\n\t\t\t{\n\t\t\t\tText: text{\n\t\t\t\t\tText: []string{\"My name is Dialogflow Go Webhook\"},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t}\n\treturn response, nil\n}\n// handleError handles internal errors.\nfunc handleError(w http.ResponseWriter, err error) {\n\tw.WriteHeader(http.StatusInternalServerError)\n\tfmt.Fprintf(w, \"ERROR: %v\", err)\n}\n// HandleWebhookRequest handles WebhookRequest and sends the WebhookResponse.\nfunc HandleWebhookRequest(w http.ResponseWriter, r *http.Request) {\n\tvar request webhookRequest\n\tvar response webhookResponse\n\tvar err error\n\t// Read input JSON\n\tif err = json.NewDecoder(r.Body).Decode(&request); err != nil {\n\t\thandleError(w, err)\n\t\treturn\n\t}\n\tlog.Printf(\"Request: %+v\", request)\n\t// Call intent handler\n\tswitch intent := request.QueryResult.Intent.DisplayName; intent {\n\tcase \"Default Welcome Intent\":\n\t\tresponse, err = welcome(request)\n\tcase \"get-agent-name\":\n\t\tresponse, err = getAgentName(request)\n\tdefault:\n\t\terr = fmt.Errorf(\"Unknown intent: %s\", intent)\n\t}\n\tif err != nil {\n\t\thandleError(w, err)\n\t\treturn\n\t}\n\tlog.Printf(\"Response: %+v\", response)\n\t// Send response\n\tif err = json.NewEncoder(w).Encode(&response); err != nil {\n\t\thandleError(w, err)\n\t\treturn\n\t}\n}\n``` [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/googleapis/java-dialogflow/blob/HEAD/samples/snippets/src/main/dialogflow/Example.java) \n```\n// TODO: add GSON dependency to Pom file// (https://mvnrepository.com/artifact/com.google.code.gson/gson/2.8.5)// TODO: Uncomment the line bellow before running cloud function// package com.example;import com.google.cloud.functions.HttpFunction;import com.google.cloud.functions.HttpRequest;import com.google.cloud.functions.HttpResponse;import com.google.gson.Gson;import com.google.gson.GsonBuilder;import com.google.gson.JsonObject;import com.google.gson.JsonParser;import java.io.BufferedWriter;public class Example implements HttpFunction {\u00a0 public void service(HttpRequest request, HttpResponse response) throws Exception {\u00a0 \u00a0 JsonParser parser = new JsonParser();\u00a0 \u00a0 Gson gson = new GsonBuilder().create();\u00a0 \u00a0 JsonObject job = gson.fromJson(request.getReader(), JsonObject.class);\u00a0 \u00a0 String str =\u00a0 \u00a0 \u00a0 \u00a0 job.getAsJsonObject(\"queryResult\")\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .getAsJsonObject(\"intent\")\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .getAsJsonPrimitive(\"displayName\")\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .toString();\u00a0 \u00a0 JsonObject o = null;\u00a0 \u00a0 String a = '\"' + \"Default Welcome Intent\" + '\"';\u00a0 \u00a0 String b = '\"' + \"get-agent-name\" + '\"';\u00a0 \u00a0 String responseText = \"\";\u00a0 \u00a0 if (str.equals(a)) {\u00a0 \u00a0 \u00a0 responseText = '\"' + \"Hello from a Java GCF Webhook\" + '\"';\u00a0 \u00a0 } else if (str.equals(b)) {\u00a0 \u00a0 \u00a0 responseText = '\"' + \"My name is Flowhook\" + '\"';\u00a0 \u00a0 } else {\u00a0 \u00a0 \u00a0 responseText = '\"' + \"Sorry I didn't get that\" + '\"';\u00a0 \u00a0 }\u00a0 \u00a0 o =\u00a0 \u00a0 \u00a0 \u00a0 parser\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .parse(\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"{\\\"fulfillmentMessages\\\": [ { \\\"text\\\": { \\\"text\\\": [ \"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 + responseText\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 + \" ] } } ] }\")\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .getAsJsonObject();\u00a0 \u00a0 BufferedWriter writer = response.getWriter();\u00a0 \u00a0 writer.write(o.toString());\u00a0 }}\n``` [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/googleapis/nodejs-dialogflow/blob/HEAD/samples/webhook.js) \n```\n// TODO: Add handleWebhook to 'Entry point' in the Google Cloud Functionexports.handleWebhook = (request, response) => {\u00a0 const tag = request.body.queryResult.intent.displayName;\u00a0 let jsonResponse = {};\u00a0 if (tag === 'Default Welcome Intent') {\u00a0 \u00a0 //fulfillment response to be sent to the agent if the request tag is equal to \"welcome tag\"\u00a0 \u00a0 jsonResponse = {\u00a0 \u00a0 \u00a0 fulfillment_messages: [\u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 text: {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 //fulfillment text response to be sent to the agent\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 text: ['Hello from a GCF Webhook'],\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 ],\u00a0 \u00a0 };\u00a0 } else if (tag === 'get-name') {\u00a0 \u00a0 //fulfillment response to be sent to the agent if the request tag is equal to \"welcome tag\"\u00a0 \u00a0 jsonResponse = {\u00a0 \u00a0 \u00a0 fulfillment_messages: [\u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 text: {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 //fulfillment text response to be sent to the agent\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 text: ['My name is Flowhook'],\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 ],\u00a0 \u00a0 };\u00a0 } else {\u00a0 \u00a0 jsonResponse = {\u00a0 \u00a0 \u00a0 //fulfillment text response to be sent to the agent if there are no defined responses for the specified tag\u00a0 \u00a0 \u00a0 fulfillment_messages: [\u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 text: {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ////fulfillment text response to be sent to the agent\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 text: [\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 `There are no fulfillment responses defined for \"${tag}\"\" tag`,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ],\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 ],\u00a0 \u00a0 };\u00a0 }\u00a0 response.send(jsonResponse);};\n``` [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/googleapis/python-dialogflow/blob/HEAD/samples/snippets/webhook.py) \n```\n# TODO: change the default Entry Point text to handleWebhookdef handleWebhook(request):\u00a0 \u00a0 req = request.get_json()\u00a0 \u00a0 responseText = \"\"\u00a0 \u00a0 intent = req[\"queryResult\"][\"intent\"][\"displayName\"]\u00a0 \u00a0 if intent == \"Default Welcome Intent\":\u00a0 \u00a0 \u00a0 \u00a0 responseText = \"Hello from a GCF Webhook\"\u00a0 \u00a0 elif intent == \"get-agent-name\":\u00a0 \u00a0 \u00a0 \u00a0 responseText = \"My name is Flowhook\"\u00a0 \u00a0 else:\u00a0 \u00a0 \u00a0 \u00a0 responseText = f\"There are no fulfillment responses defined for Intent {intent}\"\u00a0 \u00a0 # You can also use the google.cloud.dialogflowcx_v3.types.WebhookRequest protos instead of manually writing the json object\u00a0 \u00a0 res = {\"fulfillmentMessages\": [{\"text\": {\"text\": [responseText]}}]}\u00a0 \u00a0 return res\n```", "guide": "Dialogflow"}