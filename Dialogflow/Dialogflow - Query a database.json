{"title": "Dialogflow - Query a database", "url": "https://cloud.google.com/dialogflow/es/docs/tutorials/deploy/database", "abstract": "# Dialogflow - Query a database\nYour webhook currently uses hardcoded data in the `accountBalanceCheck` function. In this step of the tutorial, you will create a [Spanner](/spanner/docs) database, populate it with balance data, and update your function to query the database.\n", "content": "## Project configuration\nIt is important that your Dialogflow agent and the database are both in the same project. This is the easiest way for your function to have secure access to your database. Also, you must enable the Spanner API.\n- Before creating the database, select your project from the Google Cloud console. [Go to project selector](https://console.cloud.google.com/projectselector2/home/dashboard) \n- Enable the Spanner API for the project. [Enable the Spanner API](https://console.cloud.google.com/flows/enableapi?apiid=spanner.googleapis.com) ## Create a Spanner instance\nWhen you first use Spanner, you must create an instance, which is an allocation of resources that are used by Spanner databases in that instance.\n- In the Google Cloud console, go to the **Spanner Instances** page. [Go to Spanner instances](https://console.cloud.google.com/spanner/instances) \n- Click **Create instance** .\n- For the instance name, enter **Tutorial Instance** .\n- The instance ID is automatically entered based on the instance name.\n- In **Choose your configuration** , retain the default option **Regional** and select the same region [location](/dialogflow/es/docs/how/region) that you chose when creating the function.\n- In **Allocate compute capacity** , enter 100 processing units. This provides a minimal capacity for the tutorial.\n- Click **Create** . The Google Cloud console displays the **Overview** page for the instance you created.## Create a Spanner database\nNow that you have an instance, you need to create a database. To create a database:\n- In the instance **Overview** page, click **Create database** .\n- For the database name, enter **tutorial-database** .\n- Select the **Google Standard SQL** database dialect.\n- Click **Create** . The Google Cloud console displays the **Overview** page for the database you created.## Create tables for your database\nNow that you have a database, you need to create tables for the database. To create tables:\n- In the Tables section of the database **Overview** page, click **Create table** .\n- In the **Write DDL statements** page, enter:```\nCREATE TABLE Checking (\u00a0 AccountId INT64,\u00a0 Balance INT64,) PRIMARY KEY(AccountId);\n```\n- Click **Submit** . The Google Cloud console returns to the database **Overview** page and shows that **Schema updates** are underway. Wait until the update is complete.\n- In the Tables section of the database **Overview** page, click **Create table** .\n- In the **Write DDL statements** page, enter:```\nCREATE TABLE Savings (\u00a0 AccountId INT64,\u00a0 Balance INT64,) PRIMARY KEY(AccountId);\n```\n- Click **Submit** . The Google Cloud console returns to the database **Overview** page and shows that **Schema updates** are underway. Wait until the update is complete.## Insert data into your tables\nNow that your database has tables, you need to add data to the tables. To add data:\n- In the list of tables on the database **Overview** page, click the Checking table. The Google Cloud console displays the table's **Schema** page.\n- In the left navigation menu, click **Data** to display the table's **Data** page.\n- Click **Insert** . The Google Cloud console displays the table's **Query** page with a new query tab that contains `INSERT` and `SELECT` statements. Overwrite those statements with the following:```\nINSERT INTO Checking (AccountId, Balance)VALUES(1, 1000),\u00a0 \u00a0 \u00a0 (2, 2000);\n```\n- Click **Run** .\n- In the left navigation menu, click **Data** again to display the table's data. Confirm that the table contains the desired data.\n- Click the **tutorial-database: Overview** link to return to the database overview page.\n- In the list of tables on the database **Overview** page, click the Savings table. The Google Cloud console displays the table's **Schema** page.\n- In the left navigation menu, click **Data** to display the table's **Data** page.\n- Click **Insert** . The Google Cloud console displays the table's **Query** page with a new query tab that contains `INSERT` and `SELECT` statements. Overwrite those statements with the following:```\nINSERT INTO Savings (AccountId, Balance)VALUES(1, 10000),\u00a0 \u00a0 \u00a0 (2, 20000);\n```\n- Click **Run** .\n- In the left navigation menu, click **Data** again to display the table's data. Confirm that the table contains the desired data.## Update the Cloud Function to query the database\nThe `accountBalanceCheck` function in the webhook code checks whether specific environment variables are set with information for connecting to the database. If these environment variables are not set, the function uses a hardcoded account balance.\nNow that you have a database set up, update your Cloud Function to set required environment variables:\n- Open the Cloud Functions overview page. [Go to Cloud Functions overview](https://console.cloud.google.com/functions/list) \n- Click the tutorial-banking-webhook function to go to its details page.\n- Click **Edit** .\n- Open the **Runtime, build and connections settings** section.\n- Select the **Runtime** tab.\n- Add the following variables in the Runtime environment variables section:- `PROJECT_ID`: your project ID\n- `SPANNER_INSTANCE_ID`: your Spanner instance ID (probably`tutorial-instance`)\n- `SPANNER_DATABASE_ID`: your spanner database ID (probably`tutorial-database`)\n- Click **Next** .\n- Click **Deploy** .\n- Wait until the status indicator shows that the function has successfully deployed.## Test your agent\nYour agent is now ready to try. Click the **Test Agent** button from the Dialogflow console to open the simulator. Attempt to have the following conversation with the agent:\n| Conversational turn | You        | Agent               |\n|----------------------:|:----------------------------------|:---------------------------------------------------------------|\n|      1 | Hello        | Hello, thanks for choosing ACME Bank.       |\n|      2 | I want to know my account balance | What account do you want the balance for: savings or checking? |\n|      3 | Checking       | Here's your latest balance: $10.00        |\nIf you examine the code, $10 is not the hardcoded value. This means that your webhook has successfully connected to the database, which does have a balance of $10.\n## Troubleshooting\nThe webhook code includes logging statements. If you are having issues, try [viewing the logs](/functions/docs/monitoring/logging) for your Cloud Function.\nIf your function is not connecting to the database, and you see a permission error in the logs, you may need to fix the role for the default service account used by your function. This service account is of the form `` `@appspot.gserviceaccount.com` . You can fix this in one of the following ways:\n- If the default service account is shown on the IAM main page, [change permissions for the service account](/functions/docs/securing/function-identity#default) . The role will work, but you may want a more granular role in a production scenario. [Go to the IAM main page](https://console.cloud.google.com/iam-admin/iam) \n- If the a default service account is not shown on the IAM main page, [grant the required role](/iam/docs/grant-role-console#grant_an_iam_role) by adding the service account as a new principal.\n- Alternatively, you can [use a service account that you create](/functions/docs/securing/function-identity#individual) .## More information\nFor more information about the steps above, see:\n- [Using Cloud Spanner with Cloud Functions](/functions/docs/tutorials/use-cloud-spanner) \n- [Create and query a database by using the Google Cloud console](/spanner/docs/create-query-database-console) \n- [Google Standard SQL data definition language](/spanner/docs/reference/standard-sql/data-definition-language) \n- [Google Standard SQL data manipulation language](/spanner/docs/reference/standard-sql/dml-syntax)", "guide": "Dialogflow"}