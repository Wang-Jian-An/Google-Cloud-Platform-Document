{"title": "Vertex AI Search and Conversation - Use data source access control", "url": "https://cloud.google.com/generative-ai-app-builder/docs/data-source-access-control?hl=zh-cn", "abstract": "# Vertex AI Search and Conversation - Use data source access control\n**Note:** Data source access control is in Public preview.\nThis page describes how to enforce data source access control for search apps in Vertex AI Search and Conversation.\nAccess control for your data sources in Vertex AI Search and Conversation limits the data that users can view in your search app's results. Google uses your identity provider to identify the end user performing a search and determine if they have access to the documents that are returned as results.\nFor example, say that employees at your company search across Confluence documents using your search app. However, you need to make sure they can't view content through the app that they aren't allowed to access. If you have set up a workforce pool in Google Cloud for your organization's identity provider, then you can also specify that workforce pool in Vertex AI Search and Conversation. Now, if an employee uses your app, they get search results only for documents that their account already has access to in Confluence.\n", "content": "## About data source access control\nTurning on access control is a one-time procedure.\nAccess control is available for Cloud Storage, BigQuery, Google Drive, and all third-party data sources.\nTo turn on data source access control for Vertex AI Search and Conversation, you must have your organization's identity provider configured in Google Cloud. The following authentication frameworks are supported:\n- Google Identity: If you use Google Identity, then all user identities and user groups are present and managed through Google Cloud. For more information about Google Identity, see the [Google Identity](https://developers.google.com/identity) documentation.\n- Third party identity provider federation: If you use an external identity provider, for example Okta or Azure, then you must set up [workforce identity federation](/iam/docs/workforce-identity-federation) in Google Cloud before you can turn on data source access control for Vertex AI Search and Conversation.## Limitations\nAccess control has the following limitations:\n- 100 readers are allowed per document. Each principal counts as a reader, where a principal can be a group or an individual user.\n- You can select one identity provider per Vertex AI Search-supported location.\n- Access control is honored only for identity and groups that are explicitly defined in your identity provider. Identities or groups that are defined natively within third-party apps are not supported.\n- To set a data source as access-controlled, you must select this setting during data store creation. You can't turn this setting on or off for an existing data store.\n- The **Data** > **Documents** tab in the console doesn't show data for access-controlled data sources because this data should only be visible to users that have view access.\n- To preview results in the console for search apps that use third-party access control, you must log into the federated console. See [Preview results for access controlled apps](#preview) .## Before you begin\nThis procedure assumes you have set up an identity provider in your Google Cloud project.\n- **Google Identity** : If you use Google Identity, you can proceed to the [Connect to your identity provider](#connect-idp) procedure.\n- **Third-party identity provider** : Make sure you have set up a workforce identity pool for your third-party identity provider. Ensure you have specified subject and group attribute mappings when setting up workforce pool. For information about attribute mappings, see [Attributemappings](/iam/docs/workforce-identity-federation#attribute-mappings.) in the IAM documentation. For more information about workforce identity pools, see [Manage workforce identity poolproviders](/iam/docs/manage-workforce-identity-pools-providers) in the IAM documentation.## Connect to your identity provider\nTo specify an identity provider for Vertex AI Search and Conversation and turn on data source access control, follow these steps:\n- In the Google Cloud console, go to the **Search and Conversation** page. [Search and Conversation](https://console.cloud.google.com/gen-app-builder/engines) \n- Go to the **Settings** > **Authentication** page.\n- Click **Add identity provider** for the location you want to update.\n- Select your identity provider in the **Add identity provider** dialog. If you select a third party identity provider, also select the workforce pool that applies for your data sources.\n- Click **Save changes** .## Configure a data source with access control\nTo apply access control to a data source, use the following steps depending on the kind of data source you're setting up:\n- Third-party data sources: No additional configuration is required when you create your app. Skip to [Preview results for apps with third-party accesscontrol](#preview) \n- Google Drive: No additional configuration is required when you create your app.\n- [Unstructured data from Cloud Storage](#acl-storage-unstructured) \n- [Structured data from Cloud Storage](#acl-storage-structured) \n- [Unstructured data from BigQuery](#acl-unstructured-bq) \n- [Structured data from BigQuery](#acl-structured-bq) \n### Unstructured data from Cloud Storage\nWhen setting up a data store for unstructured data from Cloud Storage, you need to also upload ACL metadata and set the data store as access controlled:\n- When preparing your data, include ACL information in your metadata using the `acl_info` field. For example:```\n{\u00a0 \u00a0\"id\": \"<your-id>\",\u00a0 \u00a0\"jsonData\": \"<JSON string>\",\u00a0 \u00a0\"content\": {\u00a0 \u00a0 \u00a0\"mimeType\": \"<application/pdf or text/html>\",\u00a0 \u00a0 \u00a0\"uri\": \"gs://<your-gcs-bucket>/directory/filename.pdf\"\u00a0 \u00a0}\u00a0 \u00a0\"acl_info\": {\u00a0 \u00a0 \u00a0\"readers\": [\u00a0 \u00a0 \u00a0 \u00a0{\u00a0 \u00a0 \u00a0 \u00a0 \u00a0\"principals\": [\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0{ \"group_id\": \"group_1\" },\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0{ \"user_id\": \"user_1\" }\u00a0 \u00a0 \u00a0 \u00a0 \u00a0]\u00a0 \u00a0 \u00a0 \u00a0}\u00a0 \u00a0 \u00a0]\u00a0 \u00a0}\u00a0}\n```For more information about unstructured data with metadata, see the Unstructured data section of [Prepare data foringesting](/generative-ai-app-builder/docs/prepare-data#unstructured) .\n- When following the steps for data store creation in [Create a search datastore](/generative-ai-app-builder/docs/create-data-store-es) , you can enable access control by doing the following in either the console or using the API:- **Console** : When creating a data store, select **This data store contains\naccess control information** during data store creation.\n- **API** : When creating data store, include the flag`\"aclEnabled\": \"true\"`in your JSON payload.\n- When following the steps for data import in [Create a search datastore](/generative-ai-app-builder/docs/create-data-store-es) , make sure to do the following:- Upload your metadata with ACL information from the same bucket as your unstructured data\n- If using the API, set [GcsSource.dataSchema](/generative-ai-app-builder/docs/reference/rest/v1/GcsSource) to`document`\n### Structured data from Cloud Storage\nWhen setting up a data store for unstructured data from Cloud Storage, you need to also upload ACL metadata and set the data store as access controlled:\n- When preparing your data, include ACL information in your metadata using the `acl_info` field. For example:```\n{\u00a0 \u00a0\"id\": \"<your-id>\",\u00a0 \u00a0\"jsonData\": \"<JSON string>\",\u00a0 \u00a0\"acl_info\": {\u00a0 \u00a0 \u00a0\"readers\": [\u00a0 \u00a0 \u00a0 \u00a0{\u00a0 \u00a0 \u00a0 \u00a0 \u00a0\"principals\": [\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0{ \"group_id\": \"group_1\" },\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0{ \"user_id\": \"user_1\" }\u00a0 \u00a0 \u00a0 \u00a0 \u00a0]\u00a0 \u00a0 \u00a0 \u00a0}\u00a0 \u00a0 \u00a0]\u00a0 \u00a0}\u00a0}\n```\n- When following the steps for data store creation in [Create a search datastore](/generative-ai-app-builder/docs/create-data-store-es) , you can enable access control by doing the following in either the console or using the API:- **Console** : When creating a data store, select **This data store contains\naccess control information** during data store creation.\n- **API** : When creating data store, include the flag`\"aclEnabled\": \"true\"`in your JSON payload.\n- When following the steps for data import in [Create a search datastore](/generative-ai-app-builder/docs/create-data-store-es) , make sure to do the following:- Upload your metadata with ACL information from the same bucket as your unstructured data\n- If using the API, set [GcsSource.dataSchema](/generative-ai-app-builder/docs/reference/rest/v1/GcsSource) to`document`\n### Unstructured data from BigQuery\nWhen setting up a data store for structured data from BigQuery, you need to set the data store as access controlled and provide ACL metadata using a predefined schema for Vertex AI Search:\n- When preparing your data, specify the following schema. Don't use a custom schema.```\n[\u00a0 {\u00a0 \u00a0 \"name\": \"id\",\u00a0 \u00a0 \"mode\": \"REQUIRED\",\u00a0 \u00a0 \"type\": \"STRING\",\u00a0 \u00a0 \"fields\": []\u00a0 },\u00a0 {\u00a0 \u00a0 \"name\": \"jsonData\",\u00a0 \u00a0 \"mode\": \"NULLABLE\",\u00a0 \u00a0 \"type\": \"STRING\",\u00a0 \u00a0 \"fields\": []\u00a0 },\u00a0 {\u00a0 \u00a0 \"name\": \"content\",\u00a0 \u00a0 \"type\": \"RECORD\",\u00a0 \u00a0 \"mode\": \"NULLABLE\",\u00a0 \u00a0 \"fields\": [\u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \"name\": \"mimeType\",\u00a0 \u00a0 \u00a0 \u00a0 \"type\": \"STRING\",\u00a0 \u00a0 \u00a0 \u00a0 \"mode\": \"NULLABLE\"\u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \"name\": \"uri\",\u00a0 \u00a0 \u00a0 \u00a0 \"type\": \"STRING\",\u00a0 \u00a0 \u00a0 \u00a0 \"mode\": \"NULLABLE\"\u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 ]\u00a0 }\u00a0 {\u00a0 \u00a0 \"name\": \"acl_info\",\u00a0 \u00a0 \"type\": \"RECORD\",\u00a0 \u00a0 \"mode\": \"NULLABLE\",\u00a0 \u00a0 \"fields\": [\u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \"name\": \"readers\",\u00a0 \u00a0 \u00a0 \u00a0 \"type\": \"RECORD\",\u00a0 \u00a0 \u00a0 \u00a0 \"mode\": \"REPEATED\",\u00a0 \u00a0 \u00a0 \u00a0 \"fields\": [\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"name\": \"principals\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"type\": \"RECORD\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"mode\": \"REPEATED\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"fields\": [\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"name\": \"user_id\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"type\": \"STRING\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"mode\": \"NULLABLE\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"name\": \"group_id\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"type\": \"STRING\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"mode\": \"NULLABLE\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ]\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 ]\u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 ]\u00a0 }]\n```\n- Include your ACL metadata as a column in your BigQuery table.\n- When following the steps in [Create a search datastore](/generative-ai-app-builder/docs/create-data-store-es) , enable access control in either the console or using the API:- **Console** : When creating a data store, select **This data store contains\naccess control information** during data store creation.\n- **API** : When creating data store, include the flag`\"aclEnabled\": \"true\"`in your JSON payload.\n- When following the steps for data import in [Create a search datastore](/generative-ai-app-builder/docs/create-data-store-es) , if using the API, set [BigQuerySource.dataSchema](/generative-ai-app-builder/docs/reference/rest/v1/BigQuerySource) to `document` .\n### Structured data from BigQuery\nWhen setting up a data store for structured data from BigQuery, you need to set the data store as access controlled and provide ACL metadata using a predefined schema for Vertex AI Search:\n- When preparing your data, specify the following schema. Don't use a custom schema.```\n[\u00a0 {\u00a0 \u00a0 \"name\": \"id\",\u00a0 \u00a0 \"mode\": \"REQUIRED\",\u00a0 \u00a0 \"type\": \"STRING\",\u00a0 \u00a0 \"fields\": []\u00a0 },\u00a0 {\u00a0 \u00a0 \"name\": \"jsonData\",\u00a0 \u00a0 \"mode\": \"NULLABLE\",\u00a0 \u00a0 \"type\": \"STRING\",\u00a0 \u00a0 \"fields\": []\u00a0 },\u00a0 {\u00a0 \u00a0 \"name\": \"acl_info\",\u00a0 \u00a0 \"type\": \"RECORD\",\u00a0 \u00a0 \"mode\": \"NULLABLE\",\u00a0 \u00a0 \"fields\": [\u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \"name\": \"readers\",\u00a0 \u00a0 \u00a0 \u00a0 \"type\": \"RECORD\",\u00a0 \u00a0 \u00a0 \u00a0 \"mode\": \"REPEATED\",\u00a0 \u00a0 \u00a0 \u00a0 \"fields\": [\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"name\": \"principals\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"type\": \"RECORD\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"mode\": \"REPEATED\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"fields\": [\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"name\": \"user_id\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"type\": \"STRING\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"mode\": \"NULLABLE\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"name\": \"group_id\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"type\": \"STRING\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"mode\": \"NULLABLE\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ]\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 ]\u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 ]\u00a0 }]\n```\n- Include your ACL metadata as a column in your BigQuery table.\n- When following the steps in [Create a search datastore](/generative-ai-app-builder/docs/create-data-store-es) , enable access control in either the console or using the API:- **Console** : When creating a data store, select **This data store contains\naccess control information** during data store creation.\n- **API** : When creating data store, include the flag`\"aclEnabled\": \"true\"`in your JSON payload.\n- When following the steps for data import in [Create a searchdata store](/generative-ai-app-builder/docs/create-data-store-es) , make sure to do the following:- If using the console, then when specifying the kind of data you're uploading, select **JSONL for structured data with metadata** \n- If using the API, set [BigQuerySource.dataSchema](/generative-ai-app-builder/docs/reference/rest/v1/BigQuerySource) to`document`\n## Preview results for apps with third-party access control\nPreviewing results in the console for apps with third-party access control requires you to sign in with your organization's credentials. Follow these steps:\n- In the Google Cloud console, go to the **Search and Conversation** page. [Search and Conversation](https://console.cloud.google.com/gen-app-builder/engines) \n- Click the name of the search app whose results you want to preview.\n- Go to the **Preview** page.\n- Click **Preview with federated identity** to go to the federated console.\n- Enter your workforce pool provider and organization's credentials.\n- Preview results for your app on the **Preview** page that appears.For more information about previewing your search results, see [Get search results](/generative-ai-app-builder/docs/preview-search-results) .## Grant the Discovery Engine Viewer role\nTo give users the ability to make search calls, grant the Discovery Engine Viewer role to users in your domain or workforce pool.\nFor more information about granting roles, see the [IAM documentation](/iam/docs) .\n## Authorize the search widget\nIf you want to deploy a search widget for an access-controlled app, follow these steps:\n- Grant the Discovery Engine Viewer role to users in your domain or workforce pool who need to make search API calls.\n- Generate authorization tokens to pass to your widget:- For Google Identity: Generate OAuth 2.0 access tokens.\n- For workforce identity federation: Follow the steps in [Obtain short-lived tokens for workforce identityfederation](/iam/docs/workforce-obtaining-short-lived-credentials) to get your token.\n- Follow the steps in [Add a widget with an authorization token](/generative-ai-app-builder/docs/add-widget#auth-token) to pass the token to your widget.", "guide": "Vertex AI Search and Conversation"}