{"title": "Vertex AI Search and Conversation - Customer-managed encryption keys", "url": "https://cloud.google.com/generative-ai-app-builder/docs/cmek?hl=zh-cn", "abstract": "# Vertex AI Search and Conversation - Customer-managed encryption keys\nThis page describes how to use your own encryption key to protect your data stores in the US and EU multi-regions.\nBy default, Vertex AI Search and Conversation [encrypts your content stored at rest](/security/encryption/default-encryption) . Vertex AI Search and Conversation handles and manages this default encryption for you without any additional actions on your part.\nHowever, if you have specific compliance or regulatory requirements related to the keys that protect your data, you can use customer-managed encryption keys (CMEK) to protect your resources. In this case, you'll use Cloud KMS keys and follow the procedure on this page. The key is associated with a specific location: the US multi-region or the EU multi-region.\nCloud KMS keys are used to encrypt and decrypt the data in your data stores and apps. For general information about Cloud KMS, see the [Cloud Key Management Service documentation](/kms/docs) .\n", "content": "## Limitations of Cloud KMS in Vertex AI Search and Conversation\nThe following limitations apply to CMEK (Cloud KMS) keys in Vertex AI Search and Conversation:\n- Keys cannot be changed (or rotated).\n- After a key has been registered, it cannot be deregistered or removed from a data store.\n- You must use US or EU multi-region data stores and apps (not global ones). For more information about multi-regions and data residency, including limits associated with using non-global locations, see [Vertex AI Search locations](/generative-ai-app-builder/docs/locations) or [Vertex AI Conversation locations](/dialogflow/cx/docs/concept/region#avail) .\n- If you need to register more than one key for a project, contact your Google account team to request a quota increase for CMEK configurations, providing a justification for why you need more than one key.\n- Data stores created before a key is registered to the project cannot be protected by the key.\n- For Vertex AI Search, Enterprise edition is required. For information about Enterprise edition, see [About advanced features](/generative-ai-app-builder/docs/about-advanced-features) .## Before you begin\nMake sure you satisfy the following prerequisites:\n- Contact your Google account representative and ask to be added to the allowlist for customer-managed encryption keys in Vertex AI Search and Conversation.\n- A symmetric Cloud KMS key with the rotation period set to **Never(Manual rotation)** . See [Create a key ring](/kms/docs/create-key-ring) and [Create a key](/kms/docs/create-key) in the Cloud KMS documentation.\n- The CryptoKey Encrypter/Decrypter IAM role ( `roles/cloudkms.cryptoKeyEncrypterDecrypter` ) on the key has been granted to the Discovery Engine service agent. For general instructions on how to add a role to a service agent, see [Grant or revoke a singlerole](/iam/docs/manage-access-service-accounts) .\n- The CryptoKey Encrypter/Decrypter IAM role ( `roles/cloudkms.cryptoKeyEncrypterDecrypter` ) on the key has been granted to the Cloud Storage service agent. If this role is not granted, data import for CMEK-protected data stores will fail because Discovery Engine is not able to make the CMEK-protected, temporary bucket and directory that is required for importing.\n- Do not create any data stores or apps that you want managed by your key until after you have completed the [key registration](#key-registration) instructions on this page.\n- Enterprise edition features are turned on for the app. See [Turn Enterpriseedition on or off](/generative-ai-app-builder/docs/enterprise-edition) .## Register your Cloud KMS key\nTo register your own managed key for Vertex AI Search and Conversation, follow these steps:\n- Call the `UpdateCmekConfig` method with the Cloud KMS key that you want to register.```\ncurl -X PATCH \\-H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\-H \"Content-Type: application/json\" \\-d '{\"kms_key\":\"projects/KMS_PROJECT_ID/locations/LOCATION/keyRings/KEY_RING/cryptoKeys/KEY_NAME\"}' \\\"https://LOCATION-discoveryengine.googleapis.com/v1alpha/projects/PROJECT_ID/locations/LOCATION/cmekConfig\"\n```- : The ID of your project that contains the key. The project number won't work.\n- : The multi-region of your data store:`us`or`eu`.\n- : The name of the key ring that holds the key.\n- : The name of the key.\n- : The ID of your project that contains the data store.\nAn example curl call and response looks like this:```\n$ curl -X patch\n-H \"Authorization: Bearer $(gcloud auth print-access-token)\"\n-H \"Content-Type: application/json\n-d '{\"kms_key\":\"projects/key-project-456/locations/us/keyRings/my-key-ring/cryptoKeys/my-key\"}'\n\"https://us-discoveryengine.googleapis.com/v1alpha/projects/my-ai-app-project-123/locations/us/cmekConfig\"\n\u00a0\n{\n \"name\": \"projects/my-ai-app-project-123/locations/us/operations/update-cmek-config-56789\",\n \"metadata\": {\n \"@type\": \"type.googleapis.com/google.cloud.discoveryengine.v1alpha.UpdateCmekConfigMetadata\"\n }\n}\n```\n- Optional: Record the `name` value returned by the method and follow the instructions in [Get detailsabout a long-running operation](/generative-ai-app-builder/docs/long-running-operations#get-details) to see when the operation is complete.It typically takes a few minutes to register a key.\nAfter the operation completes, new data stores in that multi-region are protected by the key. For general information about creating data stores, see [Create a search data store](/generative-ai-app-builder/docs/create-data-store-es) .\n**Note:** It can several hours to create the first data store after the key is registered. However, subsequent data stores will be created within seconds.\n## Optional: Verify that a data store is protected by a key\nData stores that were created before your key was registered are not protected by the key. If you want to confirm that a particular data store is protected by your key, follow these steps:\n- Run the following curl command on the data store:```\ncurl -X GET \\-H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\-H \"Content-Type: application/json\" \\-H \"x-goog-user-project: PROJECT_ID\" \\\"https://LOCATION-discoveryengine.googleapis.com/v1alpha/projects/PROJECT_ID/locations/LOCATION/collections/default_collection/dataStores/DATA_STORE_ID\"\n```- : The multi-region of your data store:`us`or`eu`.\n- : The ID of your project that contains the data store.\n- : The ID of the data store.\nAn example curl call looks like this:```\ncurl -X GET\n-H \"Authorization: Bearer $(gcloud auth print-access-token)\"\n-H \"Content-Type: application/json\"\n-H \"x-goog-user-project: my-ai-app-project-123\"\n\"https://us-discoveryengine.googleapis.com/v1alpha/projects/my-ai-app-project-123/locations/us/collections/default_collection/dataStores/my-data-store-1\"\n```\n- Review the output from the command: If the `cmekConfig` field is in the output and the `kmsKey` field shows the key that you registered, then the data store is protected by the key.An example response looks like this:```\n{\n \"name\": \"projects/969795412903/locations/us/collections/default_collection/dataStores/my-data-store-1\",\n \"displayName\": \"my-data-store-1\",\n \"industryVertical\": \"GENERIC\",\n \"createTime\": \"2023-09-05T21:20:21.520552Z\",\n \"solutionTypes\": [ \"SOLUTION_TYPE_SEARCH\"\n ],\n \"defaultSchemaId\": \"default_schema\",\n \"cmekConfig\": {\n \"name\": \"projects/969795412903/locations/us/collections/default_collection/dataStores/my-data-store-1/cmekConfig\",\n \"kmsKey\": \"projects/my-ai-app-project-123/locations/us/keyRings/my-key-ring/cryptoKeys/my-key\"\n }\n}\n```## If a key is disabled or revoked\nIf a key is [disabled](/kms/docs/enable-disable) or permissions for the key are revoked, the data store stops ingesting data and stops serving data within 15 minutes. However, re-enabling a key or restoring permissions takes a long time. It can take up to 24 hours before the data store can resume serving data.\nTherefore, do not disable a key unless necessary. Disabling and enabling a key on a data store is a time-consuming operation. For example, repeatedly switching a key between disabled and enabled means it will take a long time for the data store to reach a protected state. Disabling a key and re-enabling it immediately afterward could result in days of downtime because the key is first disabled from the data store and subsequently re-enabled.", "guide": "Vertex AI Search and Conversation"}