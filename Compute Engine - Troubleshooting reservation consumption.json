{"title": "Compute Engine - Troubleshooting reservation consumption", "url": "https://cloud.google.com/compute/docs/instances", "abstract": "# Compute Engine - Troubleshooting reservation consumption\n[reservations](/compute/docs/instances/reservations-overview)\n", "content": "## Difficulty tracking reservation consumption\n**Issue:** Although you can [view the details of a reservation](/compute/docs/instances/reservations-view) or [monitor the consumption of reservations](/compute/docs/instances/reservations-monitor) to view how many of its reserved VMs are being consumed and monitor changes to this number over time, you cannot directly view which VMs are consuming a reservation.\n**Resolution:** If you can successfully create a VM that targets a [specific reservation](/compute/docs/instances/reservations-consume#consuming_instances_from_a_specific_reservation) , then the VM is consuming the reservation specified in the affinity property ( `reservationAffinity` ) of the VM. Otherwise, creating the VM fails because [the properties don't match](/compute/docs/troubleshooting/troubleshooting-vm-creation#mismatched_reservation_properties) or there are [no available reserved resources](/compute/docs/troubleshooting/troubleshooting-reservation-creation#resource-availability) .\nYou can also create a VM that targets a specific reservation to test that it's [correctly configured to automatically consume a matching reservation](/compute/docs/instances/reservations-consume#test-properties-match) , and then create the VM to [consume any matching reservation](/compute/docs/instances/reservations-consume#consuming_instances_from_any_matching_reservation) .\n## Issues for VMs not consuming reservations\nIf a VM can't consume a reservation, it might be due to one or more of the following issues:\n- The VM's properties don't match the reservation's properties.\n- The VM's reservation affinity is incorrect.\n- The reservation is already fully consumed by other matching VMs.\n- The quota for the resource is exceeded\nThis section describes how to identify each of these issues, how to resolve each, and how to verify reservation consumption.\n### Mismatched VM properties\n**Issue:** A VM cannot consume a reservation with different [VM properties](/compute/docs/instances/reservations-overview#requirements) .\nTo identify this issue, select one of the following methods:\n- View the details the reservation and VM, and manually verify that their VM properties match:- View the details of the reservation that you want the VM to consume using the [gcloud compute reservations describe command](/sdk/gcloud/reference/compute/reservations/describe) :```\ngcloud compute reservations describe RESERVATION_NAME --zone=ZONE\n```Replace the following:- is the name of a reservation.\n- is the zone where the reservation is located.\nKeep this output available.\n- View the details of the VM that you want to consume the reservation [gcloud compute instances describe command](/sdk/gcloud/reference/compute/instances/describe) .```\ngcloud compute instances describe VM_NAME\n```where is the name of the VM.Keep this output available.\n- Using both the VM description and reservation description outputs, verify that following properties match:- `project`- If the reservation is shared with multiple projects (if the reservation has the`shareType`property set to`SPECIFIC_PROJECTS`), the VM's project can either match the project where the reservation is located or match any of the projects listed under`shareSettings`.\n- `zone`\n- `machineType`\n- `guestAccelerators.acceleratorType`\n- `guestAccelerators.acceleratorCount`\n- `minCpuPlatform`- Your VM and reservation must have the exact same`minCpuPlatform`configuration. If you specify a`minCpuPlatform`value for either one of them, then both of them must have the same value for that property. Otherwise, both the reservation and the VM should omit the property. For instance, setting`minCpuPlatform`to`\"Intel Broadwell\"`when creating a VM will not match the`minCpuPlatform`value of`\"Automatic\"`within a reservation.\n- `localSsds.interface`- The reservation and VM must have the same number of local SSDs with a matching`localSsds.interface`property for each local SSD.\n- `resourcePolicies`\n Only if a reservation specifies a [compact placement policy](/compute/docs/instances/use-compact-placement-policies) .\n- Create a VM that targets a specific reservation, which returns an error if the properties don't match. For instructions, see [Verify reservation consumption](/compute/docs/instances/reservations-consume#verify-consumption) .\n**Resolution:** Update any mismatched VM properties by doing one of the following:\n- [Update the VM](/compute/docs/instances/update-instance-properties) to match the reservation's properties.\n- [Delete the reservation](/compute/docs/instances/reservations-delete#deleting_a_reservation) and [create a new reservation](/compute/docs/instances/reservations-single-project) that matches the VM's properties.\nTo check if the VM is now consuming the reservation, see [Verify reservation consumption](/compute/docs/instances/reservations-consume#verify-consumption) .\nIf the VM's and reservation's properties match but the VM is not consuming the reservation, proceed to the next section.\n### VMs miss a placement policy\n**Issue** : A VM is trying to consume a reservation without specifying the reservation's [compact placement policy](/compute/docs/instances/use-compact-placement-policies) .\n**Resolution** : If a single-project reservation specifies a compact placement policy, a VM must specify the same compact placement policy to consume the reservation. Otherwise, the VM can't consume the reservation.\nTo make sure that a VM consumes a reservation that specifies a compact placement policy, try one of the following:\n- If you created a single-project reservation by [specifying properties directly](/compute/docs/instances/reservations-single-project#specify-vm-properties) , apply the compact placement policy [when creating VMs](/compute/docs/instances/use-compact-placement-policies#create-vm) .\n- If you created a single-project reservation by [specifying an instance template](/compute/docs/instances/reservations-single-project#specify-instance-template) , select one of the following methods:- Recommended: use the reservation's [instance template to create VMs](/compute/docs/instances/create-vm-from-instance-template) . This action automatically applies the same compact placement policy specified in the reservation to each new VM you create.\n- Apply the compact placement policy [when creating VMs](/compute/docs/instances/use-compact-placement-policies#create-vm) . This method requires you to manually ensure that the compact placement policy, and any other VM properties, of your VMs and reservations match \u2014any [mismatched properties prevent consumption](/compute/docs/troubleshooting/troubleshooting-reservation-consumption#mismatched-vm-properties) .\n### VMs specify a different compact placement policy\n**Issue** : A VM is trying to consume a reservation, but the [compact placement policy](/compute/docs/instances/define-instance-placement#compact) specified in the VM and in the reservation don't match.\n**Resolution** : If a single-project reservation specifies a compact placement policy, a VM must specify the same compact placement policy to consume the reservation. Otherwise, the VM can't consume the reservation.\nTo solve this issue, try one of the following:\n- If you created a single-project reservation by [specifying properties directly](/compute/docs/instances/reservations-single-project#specify-vm-properties) , apply the reservation's compact placement policy [when creating new VMs](/compute/docs/instances/use-compact-placement-policies#create-vm) .\n- If you created a single-project reservation by [specifying an instance template](/compute/docs/instances/reservations-single-project#specify-instance-template) , use the same template to create VMs. This action automatically applies the same compact placement policy specified in the reservation to each new VM you create.\n### VM's reservation affinity is incorrect\n**Issue** : The VM's reservation affinity is misconfigured. A VM's [reservation affinity](/compute/docs/instances/reservations-consume#consuming_reserved_instances) controls the reservations that a VM can consume. To check your VM's reservation affinity, do the following:\n- View the details of the reservation that you want the VM to consume with the [gcloud compute reservations describecommand.](/sdk/gcloud/reference/compute/reservations/describe) ```\n gcloud compute reservations describe RESERVATION_NAME --zone=ZONE\n```Replace the following:- is the name of a reservation.\n- is the zone where the reservation is located.\nIn the output, find the value of the `specificReservationRequired` field, either `true` or `false` .\n- View the details of the VM using the [gcloud compute instances describecommand.](/sdk/gcloud/reference/compute/instances/describe) ```\n gcloud compute instances describe VM_NAME\n```where with the name of the VM.In the output, find the `reservationAffinity` field, which looks similar to the following:```\n...\n reservationAffinity:\n  consumeReservationType: RESERVATION_AFFINITY\n  key: compute.googleapis.com/reservation-name\n  values:\n  - RESERVATION_NAME\n ...\n```\n**Resolution** : [Update the VM's reservationAffinity property](/compute/docs/instances/update-instance-properties) to be compatible with the reservation's `specificReservationRequired` field by using one of the following accepted configurations:\n- If the reservation's `specificReservationRequired` field is `true` , the VM's `reservationAffinity` property must match the following:```\n...\n reservationAffinity:\n consumeReservationType: SPECIFIC_RESERVATION\n key: compute.googleapis.com/reservation-name\n values:\n - RESERVATION_NAME\n ...\n```where is the name of the reservation.\n- If the reservation's `specificReservationRequired` field is `false` , the VM's `reservationAffinity` property must match the following:```\n...\n reservationAffinity:\n consumeReservationType: ANY_RESERVATION\n ...\n```\nYou need to restart the VM to make the update. After the update, to check if the VM is consuming the reservation, see [Verify reservation consumption](/compute/docs/instances/reservations-consume#verify-consumption) .\nIf the VM's reservation affinity is configured correctly but the VM is not consuming any reservations, proceed to the next section.\n### Reservation is already fully consumed\n**Issue:** The number of VMs currently in use for this reservation matches the reservation's total number of reserved VMs.\nTo identify this issue, [view the details of the reservation](/compute/docs/instances/reservations-view#listing_and_describing_reservations) and verify that the number of VMs in use for this reservation is less than the reservation's total number of reserved VMs.\n**Resolution:** You can increase the number of VMs available to consume for the reservation by doing one of the following:\n- Increase the number of VMs in the reservation by [resizing the reservation](/compute/docs/instances/reservations-modify#resizing_a_reservation) .\n- Create a new reservation with the same properties, if the reservation already reserves the [maximum number of VMs](/compute/docs/troubleshooting/troubleshooting-vm-creation#max-vm-count-exceeded) .\n- Reduce the number of other VMs that are consuming the reservation. For more information, see [VMs unintentionally consuming reservations](#unintentional-reservation-consumption) .\nTo check if the VM is now consuming the reservation, see [Verify reservation consumption](/compute/docs/instances/reservations-consume#verify-consumption) .\nIf the reservation is not fully consumed, but the VM is not consuming the reservation, you can further troubleshoot the issue by creating a VM that targets a specific reservation, which returns an error if the consumption fails. For more information, proceed to the next section.\n## VM count not restored after stopping or deleting a VM\n**Issue** : If you stop, suspend, or delete a VM that is consuming a reservation, then the operation must complete before the VM no longer counts against the reservation, and the previously consumed resources are again available for consumption.\n**Resolution** : Wait for a few minutes for the stop, suspend, or delete operation on the VMs to complete. Then, to verify that the stopped, suspended, or deleted VMs no longer count against the reservation, check the total number of consumed VMs in the reservation by using one of the following methods:\n- Recommended: [Monitor the reservation](/compute/docs/instances/reservations-monitor) and look for a change in the measurements of the reservation.\n- [View the details of the reservation](/compute/docs/instances/reservations-view#describe-reservations) and check if the value of the `inUseCount` field decreased. If its value didn't decrease, one or more VMs have started consuming the reservation while the stop, suspend, or delete operation was completing.## VMs unintentionally consuming reservations\n**Issue** : When you create [reservations that are consumed automatically](/compute/docs/instances/reservations-consume#consuming_instances_from_any_matching_reservation) (default), VMs might unintentionally consume these reservations.\n**Resolution** : You can help control which VMs consume reservations by doing the following:\n- Use [VMs that cannot consume any reservations](/compute/docs/instances/reservations-consume#creating_instances_without_consuming_reservations) where selected.\n- Use [reservations that are only consumed when specifically targeted](/compute/docs/instances/reservations-consume#consuming_instances_from_a_specific_reservation) instead of automatically consumed reservations.## Resource quota exceeded\n**Issue:** A shared reservation is not utilised because a [quota has been exceeded](/compute/docs/troubleshooting/troubleshooting-vm-creation#insufficient_quota) for a particular resource.\nShared reservations have an [additional requirement](/compute/docs/instances/reservations-overview#requirements-shared-reservations) with regards to quota. The owner project must have sufficient quota for twice the resources reserved for consumer projects to use the reserved resources.\n**Resolution:**  [Request additional quota](/docs/quota_detail/view_manage#requesting_higher_quota) for the resource to be used.", "guide": "Compute Engine"}