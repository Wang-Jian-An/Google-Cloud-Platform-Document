{"title": "Compute Engine - Troubleshooting Windows VMs", "url": "https://cloud.google.com/compute/docs/instances", "abstract": "# Compute Engine - Troubleshooting Windows VMs\nThis document describes the methods and tools available to resolve the following Compute Engine Windows virtual machine (VM) instance boot issues:\n- You can't connect to the VM using RDP, and [troubleshooting](/compute/docs/troubleshooting/troubleshooting-rdp) is unsuccessful in resolving your connection.\n- The login screen has not appeared in a [VMscreenshot](/compute/docs/troubleshooting/troubleshooting-rdp#vm-screenshot) , and the VM does not appear to be making progress or performing an update.\n- You have encountered a blue screen error, frozen or erratically behaving VM under normal operation.\nIf you are experiencing issues connecting to Windows VMs, see [TroubleshootingRDP](/compute/docs/troubleshooting/troubleshooting-rdp) .\n", "content": "## Before you begin\n- Review the [Microsoft Advanced troubleshooting for Windows bootproblems](https://docs.microsoft.com/en-us/windows/client-management/advanced-troubleshooting-boot-problems) for information about troubleshooting the Windows boot process.\n- If you haven't already, set up authentication. [Authentication](/compute/docs/authentication) is the process by which your identity is verified for access to Google Cloud services and APIs. To run code or samples from a local development environment, you can authenticate to Compute Engine as follows.Select the tab for how you plan to use the samples on this page:\nWhen you use the Google Cloud console to access Google Cloud services and   APIs, you don't need to set up authentication.- [Install](/sdk/docs/install) the Google Cloud CLI, then [initialize](/sdk/docs/initializing) it by running the following command:```\ngcloud init\n``` **Note:** If you installed the gcloud CLI  previously, make sure you have the latest version by running`gcloud components  update`.\n- [ Set a default region and zone](/compute/docs/gcloud-compute#set_default_zone_and_region_in_your_local_client) .\n## Using the Advanced Boot Options menu\nIf Windows doesn't start correctly, use the Advanced Boot Options menu to access safe mode or complete an online repair of the operating system. For more information, see [Advanced startupoptions](https://support.microsoft.com/en-us/windows/advanced-startup-options-including-safe-mode-b90e7808-80b5-a291-d4b8-1a1af602b617) .\nTo enter the Advanced Boot Options menu on your Windows VM, complete the following procedure:\n- Enable a [display device](/compute/docs/instances/enable-instance-virtual-display#virtual-display-add-remove) for the VM if you haven't already.\n- [Connect to the VM's interactive serialconsole](/compute/docs/troubleshooting/troubleshooting-using-serial-console#connectserialconsole) .\n- Restart the VM using one of the following methods:\n- In the Google Cloud console, go to the **VM instances** page. [Go to VM instances](https://console.cloud.google.com/compute/instances) \n- Click the name of the VM you want to restart. The VM instance details page opens.\n- Click the **Reset** button to reboot the VM.\nUse the [gcloud compute instances resetcommand](/sdk/gcloud/reference/compute/instances/reset) to reset the VM:\n```\ngcloud compute instances reset VM_NAME --zone=ZONE --project=PROJECT_ID\n```\nReplace the following:- ``: the ID of the project that contains the VM\n- ``: the name of the zone in which the VM is located\n- ``: the name of the VM\nWhile connected to the interactive serial console, open a Command Prompt session and run the following command. For more information about opening a Command Prompt session, see [Opening CommandPrompt in WindowsSAC](/compute/docs/instances/connecting-to-windows#command-prompt) .\n```\nshutdown /r /t 0\n```\nThe Windows Boot Manager menu opens:\n- Before the countdown expires, complete these steps:- Ensure the interactive serial console is your active window.\n- Press the `Esc` key on your keyboard.\n- Press the number `8` key on your keyboard.\nThe Advanced Boot Options menu opens:\n- Use the arrow keys on your keyboard to select an option, then open it by pressing the **Enter** key.\n**Note:** If you are unable to see the Windows Boot Manager and need to enter the Advanced Boot Options menu, you will need to [enable the Windows Boot Managermenu](#windows-boot-manager) .\n## Enabling the Windows Boot Manager menu\nYou can configure the Windows Boot Manager menu to display when a Windows VM instance is being rebooted. To enable the Windows boot manager menu, do the following:\n**Note:** If you need to enable the Windows Boot Menu to perform a operating system repair and are unable to login to the VM, you might need to complete an [offline repair](#offline-repair) instead.\n[Connect to the VM](/compute/docs/instances/connecting-to-windows) and open a Command Prompt with [administrativeaccess](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj717276(v=ws.11)) .  If you cannot connect to the VM, add the  subsequent steps as values to a `windows-startup-script-cmd` or `windows-startup-script-ps1` [startup script](/compute/docs/instances/startup-scripts/windows#passing-directly) instead of running them directly\n- To enable the Windows Boot Manager menu at startup and add a 15 second timeout, run the following commands:```\nbcdedit /set {bootmgr} displaybootmenu yes\n``````\nbcdedit /set {bootmgr} timeout 15\n```\n- To reboot the VM and display the Windows boot manager menu in the serial console using the following command:```\nshutdown -r -t 0\n```\n- To enable the Windows Boot Manager menu at startup and add a 15 second timeout, run the following commands:```\nbcdedit /set '{bootmgr}' displaybootmenu yes\n``````\nbcdedit /set '{bootmgr}' timeout 15\n```\n- To reboot the VM and display the Windows boot manager menu in the serial console using the following command:```\nshutdown -r -t 0\n```## Completing an offline repair\nIf your VM doesn't start correctly and using the advanced boot menu has failed to resolve the issue, try performing an offline repair using a functional Windows VM instance for recovery with a snapshot of the troubled VM's boot disk. Using a snapshot gives you a backup copy that can be modified without changing the state of the original VM.\n- [Create a snapshot](/compute/docs/disks/create-snapshots) of the troubled VM's boot disk.\n- [Create adisk](/compute/docs/disks/restore-snapshot#create-disk-from-snapshot) using that snapshot.\n- [Create a VM with an additional non-bootdisk](/compute/docs/instances/create-start-instance#create_a_vm_instance_with_additional_non-boot_disks) , using the newly created disk. Your recovery VM should meet these criteria:- The recovery VM must be in the same zone as the disk that was created.\n- The recovery VM should also be using a [Windows Serverimage](https://cloud.google.com/compute/docs/images/os-details#windows_server) .\n- The [source image](/compute/docs/instances/view-vm-image) of the recovery VM's boot disk should be different to the source image of troubled VM's boot disk.\n **Caution:** Ensure that the [boot diskimage](/compute/docs/instances/view-vm-image) of the recovery VM differs from the boot disk that is being repaired; failure to do so may result in duplicate disk or partition GUID and unpredictable results as [confirmed byMicrosoft](https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/windows-and-gpt-faq#detecting-a-duplicate-disk-or-partition-guid) .\n- You can now use Windows tools and utilities to attempt an offline repair of on the additional attached disk. Refer to the following documentation for details about completing an offline repair of your VM:- [Scanning the volume for errors with the chkdskutility](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/chkdsk) \n- [Verify the integrity of system files withsfc](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/sfc) \n- [Repair your Windows image withdism](https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/repair-a-windows-image) \n- If the offline repair has completed successfully, [update the bootdisk](/compute/docs/disks/detach-reattach-boot-disk#update_a_boot_disk_for_an_instance) of the troubled VM to be the newly repaired boot disk.\n- Optional: Delete the additional resources after you no longer need them:- [Delete the recovery VM](/compute/docs/instances/deleting-instance) \n- Delete the original corrupted boot disk\n- [Delete the original corrupted boot disksnapshot](/compute/docs/disks/create-snapshots#deleting_snapshot) \n## Troubleshooting blue screen errors\nThe Windows operating system may experience a stop code or blue screen error, also know as a Blue Screen of Death. If a VM experiences a blue screen error, the VM stops running and needs to perform a restart before resuming normal operations.\nIf you believe a blue screen error may have occurred, confirm this by identifying presence of errors using one or more of the following methods:\n**Note:** Google provided [Windows public images](/compute/docs/images) version 20191112 and later contain the `google-compute-engine-driver-pvpanic` driver which automatically sends kernel panic information to the serial port. If it is not installed on your instance, [install thedriver](/compute/docs/instances/windows#gce-windows-drivers) .- In the Google Cloud console, go to the **VM instances** page. [Go to VM instances](https://console.cloud.google.com/compute/instances) \n- Click the name of the VM you want to view logs for. The VM instance details page opens.\n- Under **Logs** , click **Serial port 1** .\n- A stack trace dump similar to the following confirms a blue screen error:```\nntoskrnl.exe [0xFFFFF802C9606000, 0xFFFFF802C9E23000]\nnetbios.sys [0xFFFFF80E98430000, 0xFFFFF80E98442000]\nvolmgr.sys [0xFFFFF80E97E40000, 0xFFFFF80E97E58000]\nNTFS.sys [0xFFFFF80E98060000, 0xFFFFF80E98293000]\ncrashdmp.sys [0xFFFFF80E986C0000, 0xFFFFF80E986D9000]\npvpanic.sys [0xFFFFF80E99030000, 0xFFFFF80E9903C000]\nmyfault.sys [0xFFFFF80E9A570000, 0xFFFFF80E9A578000]\nDumping stack trace:\n0xFFFFF80E990317C7 (pvpanic.sys+0x17C7)\n0xFFFFF80E990316D3 (pvpanic.sys+0x16D3)\n0xFFFFF802C97D9681 (ntoskrnl.exe+0x1D3681)\n0xFFFFF802C97D8A1F (ntoskrnl.exe+0x1D2A1F)\n0xFFFFF802C97633F4 (ntoskrnl.exe+0x15D3F4)\n0xFFFFF802C9773329 (ntoskrnl.exe+0x16D329)\n0xFFFFF802C976F152 (ntoskrnl.exe+0x169152)\n0xFFFFF80E9A572794 (myfault.sys+0x2794)\nCurrent Process: notmyfault64.e\n```\n **Note:** Serial logs are kept as long as the instance is in the `RUNNING` [life cycle state](/compute/docs/instances/instance-life-cycle) , unless you have serial logging enable. For more information, see [Viewing serial portoutput](/compute/docs/instances/viewing-serial-port-output) .\n **Note:** Google provided [Windows public images](/compute/docs/images) version 20191112 and later contain the `google-compute-engine-driver-pvpanic` driver which automatically sends kernel panic information to the serial port. If it is not installed on your instance, [install thedriver](/compute/docs/instances/windows#gce-windows-drivers) .- In the Google Cloud console, go to the **VM instances** page. [Go to VM instances](https://console.cloud.google.com/compute/instances) \n- Click the name of the VM you want to view logs for. The VM instance details page opens.\n- Under **Logs** , expand **More** , then click **Serial port 2 (console)** .\n- Review the serial port of the instance, and look for this output similar to the following:```\n!SAC>\nYour PC ran into a problem and needs to restart.\nIf you call a support person, give them this info:\nUNEXPECTED_KERNEL_MODE_TRAP\nmyfault.sys\n0x0000000000000008\n0xFFFFC6812AB94F70\n0xFFFFC6812E38EFF0\n0xFFFFF80E9A572794\nWe're just collecting some error info, and then we'll restart for you.\n100% complete\n```\n **Note:** Serial logs are kept as long as the instance is in the `RUNNING` [life cycle state](/compute/docs/instances/instance-life-cycle) , unless you have serial logging enable. For more information, see [Viewing serial portoutput](/compute/docs/instances/viewing-serial-port-output) .- [Connect to the instance](/compute/docs/instances/connecting-to-windows) and open a Command Prompt with [administrativeaccess](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj717276(v=ws.11)) .\n- To display the most recent blue screen event, run the following command:```\nwevtutil qe System \"/q:*[System [(EventID=1001)]]\" /rd:True /c:1 /f:Text\n```\n- Review the output, which looks similar to the following:```\nEvent[0]:\n Log Name: System\n Source: Microsoft-Windows-WER-SystemErrorReporting\n Date: 2021-04-14T08:53:52.933\n Event ID: 1001\n Task: N/A\n Level: Error\n Opcode: N/A\n Keyword: Classic\n User: N/A\n User Name: N/A\n Computer: WINDOWS\n Description:\nThe computer has rebooted from a bugcheck. The bugcheck was: 0x1000007f (0x\n0000000000000008, 0xffffc6812ab94f70, 0xffffc6812e38eff0, 0xfffff80e9a572794\n). A dump was saved in: C:\\Windows\\Minidump\\041421-12656-01.dmp. Report Id:\na5710c98-a577-4b3e-a3c9-2fc0aa4e5d83.\n```\nFor information about customizing `wetutil` queries, see [wevtutil](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/wevtutil) .\nIf the VM is no longer operational, or the other methods have proven unsuccessful. You can inspect the boot disk of the suspected blue screen VM with a secondary VM. Using a snapshot gives you a backup copy that can be modified without changing the state of the original VM.- [Create a snapshot](/compute/docs/disks/create-snapshots) of the suspected blue screen VM's boot disk.\n- [Create adisk](/compute/docs/disks/restore-snapshot#create-disk-from-snapshot) using that snapshot.\n- [Create a VM with an additional non-bootdisk](/compute/docs/instances/create-start-instance#create_a_vm_instance_with_additional_non-boot_disks) , using the newly created disk of the suspected VM. Your recovery VM should meet these criteria:- The recovery VM must be in the same zone as the disk that was created.\n- The recovery VM should also be using a [Windows Serverimage](https://cloud.google.com/compute/docs/images/os-details#windows_server) .\n- The [source image](/compute/docs/instances/view-vm-image) of the recovery VM's boot disk should be different to the source image of troubled VM's boot disk.\n **Caution:** Ensure that the [boot diskimage](/compute/docs/instances/view-vm-image) of the recovery VM differs from the boot disk that is being repaired; failure to do so may result in duplicate disk or partition GUID and unpredictable results as [confirmed byMicrosoft](https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/windows-and-gpt-faq#detecting-a-duplicate-disk-or-partition-guid) .\n- Browse the additional disk and locate for the following files:```\n%SystemRoot%\\Memory.dmp\n%SystemRoot%\\Minidump\\DATE-TIME-NUM.dmp\n```The date and time of the file can help you correlate if the suspected instance experienced a blue screen error. These files can also be used for analysis and diagnosis.\n- Optional: Delete the additional resources after you no longer need them:- [Delete the newly createdVM](/compute/docs/instances/deleting-instance) \n- [Delete the original corrupted bootdisk](/compute/docs/disks/working-with-persistent-disks) \n- [Delete the original corrupted boot disksnapshot](/compute/docs/disks/create-snapshots#deleting_snapshot) After you obtain the blue screen error information and optionally obtained access to the memory dump file, follow the diagnostic steps and recommendations as provided by Microsoft:\n- [Understanding blue screen data](https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/blue-screen-data) \n- [Bug check code reference](https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/bug-check-code-reference2) \n- [Advanced troubleshooting for stop code or blue screen errors](https://docs.microsoft.com/en-us/windows/client-management/troubleshoot-stop-errors) ## Licensing issues\nWindows operating systems renew their licenses every seven days by connecting to the [Key Management Service (KMS)](https://technet.microsoft.com/en-us/library/ff793434.aspx) server. If you receive messages about license expiration or any other issues related to licenses on your Windows VMs, do the following:\n- Confirm that your Windows VM's VPC network is configured to [allowcommunication withKMS](/compute/docs/instances/windows/creating-managing-windows-instances#kms-server) .\n- Confirm that the Windows Firewall permits outbound connections to the KMS server:- IP address:`35.190.247.13`\n- Port:`1688`\n- Protocol:`TCP`\nFor more information about configuring Windows Advanced Firewall rules, see [Create an Outbound PortRule](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-firewall/create-an-outbound-port-rule) .\n- Test the connection to the KMS server is successful by running the following command:```\npowershell.exe Test-NetConnection 35.190.247.13 -Port 1688\n```\n- Run the following commands to confirm the current state of your license, set the server IP address of the KMS and force an activation:```\ncscript \\windows\\system32\\slmgr.vbs /dlv\n``````\ncscript \\windows\\system32\\slmgr.vbs /skms 35.190.247.13:1688\n``````\ncscript \\windows\\system32\\slmgr.vbs /ato\n```## Troubleshooting Interactive Serial Console\n- Ensure that you meet the [prerequsiste to access serial console](/compute/docs/troubleshooting/troubleshooting-using-serial-console#before-you-begin) .\n- Enable [Emergency Management Services](https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/boot-parameters-to-enable-ems-redirection) . If EMS is turned off, the serial console won't take any keyboard inputs but present only a blank screen with a blinking cursor.\n- [Connect to the VM using RDP](/compute/docs/instances/connecting-to-windows) and open `Command Prompt` as an Administrator. If you cannot RDP, add the subsequent steps as values to the [windows-startup-script-cmd](/compute/docs/instances/startup-scripts/windows#passing-directly) startup key.\n- Set the global EMS redirection settings to use COM2, a baud rate of 115200, and enable EMS.```\nbcdedit /emssettings EMSPORT:2 EMSBAUDRATE:115200\nbcdedit /ems on\n```\n- Reboot the VM to apply the updated configuration. If you're using a metadata script don't add the shutdown command.```\nshutdown -r -t 0\n```\n- [Connect through RDP](/compute/docs/instances/connecting-to-windows) and open `Powershell` as Administrator. If you cannot RDP, add the subsequent steps as values to the [windows-startup-script-ps1](/compute/docs/instances/startup-scripts/windows#passing-directly) startup key.\n- Set the global EMS redirection settings to use COM2, a baud rate of 115200, and enable EMS.```\nbcdedit /emssettings EMSPORT:2 EMSBAUDRATE:115200\nbcdedit /ems on\n```\n- Reboot the VM to apply the updated configuration. If you're using a metadata script don't add the shutdown command.```\nshutdown -r -t 0\n```\n## What's next\n- Learn how to [collect diagnostic information from aVM](/compute/docs/instances/collecting-diagnostic-information) .\n- Learn how to [capture screenshots fromVMs](/compute/docs/instances/capturing-vm-screenshots) .\n- Learn about [licensing for Windows Server and SQL Serverimages](/compute/docs/instances/windows#licensing_for_windows_server_images) .\n- Learn more about [interacting with the serialconsole](/compute/docs/troubleshooting/troubleshooting-using-serial-console#enabling_interactive_access_on_the_serial_console) .\n- Learn how to [Troubleshoot RDPconnections](/compute/docs/troubleshooting/troubleshooting-rdp) .", "guide": "Compute Engine"}