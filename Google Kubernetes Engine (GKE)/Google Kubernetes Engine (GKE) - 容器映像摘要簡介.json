{"title": "Google Kubernetes Engine (GKE) - \u5bb9\u5668\u6620\u50cf\u6458\u8981\u7c21\u4ecb", "url": "https://cloud.google.com/kubernetes-engine/docs/concepts/about-container-images?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - \u5bb9\u5668\u6620\u50cf\u6458\u8981\u7c21\u4ecb\n\u672c\u6587\u6a94\u4ecb\u7d39\u6620\u50cf\u6458\u8981\uff0c\u5305\u62ec\u4ec0\u9ebc\u662f\u6620\u50cf\u6458\u8981\u3001\u5982\u4f55\u67e5\u627e\u6620\u50cf\u6458\u8981\u4ee5\u53ca\u5982\u4f55\u5728 Kubernetes \u96c6\u7fa3\u4e2d\u5f37\u5236\u4f7f\u7528\u5b83\u5011\u3002\u672c\u6587\u6a94\u9069\u7528\u65bc\u69cb\u5efa\u548c\u90e8\u7f72\u5bb9\u5668\u6620\u50cf\u7684\u958b\u767c\u8005\u548c\u904b\u71df\u5546\u3002\n[\u5bb9\u5668\u6620\u50cf\u6458\u8981](https://github.com/opencontainers/image-spec/blob/main/descriptor.md#digests) \u662f\u552f\u4e00\u4e14\u4e0d\u53ef\u6539\u8b8a\u5730\u6a19\u8b58\u5bb9\u5668\u6620\u50cf\u3002\u901a\u904e\u6458\u8981\u90e8\u7f72\u6620\u50cf\u6642\uff0c\u60a8\u53ef\u4ee5\u907f\u514d\u901a\u904e [\u6620\u50cf\u6a19\u8a18](https://github.com/opencontainers/distribution-spec/blob/main/spec.md) \u9032\u884c\u90e8\u7f72\u7684\u7f3a\u9ede\u3002\n\u672c\u6587\u6a94\u4e2d\u7684\u547d\u4ee4\u5047\u5b9a\u60a8\u53ef\u4ee5\u4f7f\u7528\u5df2\u5b89\u88dd\u7684\u5de5\u5177\uff08\u4f8b\u5982 [Google Cloud CLI](https://cloud.google.com/sdk?hl=zh-cn) \u3001Docker\u3001cURL\u3001 [jq](https://jqlang.github.io/jq/) \u548c [pack](https://buildpacks.io/docs/tools/pack/) \uff09\u8a2a\u554f Linux \u6216 macOS shell \u74b0\u5883\u3002\u6216\u8005\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u9810\u5148\u5b89\u88dd\u4e86\u9019\u4e9b\u5de5\u5177\u7684 [Cloud Shell](https://cloud.google.com/shell?hl=zh-cn) \u3002\n", "content": "## \u5bb9\u5668\u6620\u50cf\u548c\u6620\u50cf\u6a19\u8a18\n\u4f7f\u7528\u5bb9\u5668\u6620\u50cf\u6642\uff0c\u9700\u8981\u4e00\u7a2e\u65b9\u6cd5\u4f86\u5f15\u7528\u6240\u4f7f\u7528\u7684\u6620\u50cf\u3002 [\u6620\u50cf\u6a19\u7c64](https://github.com/opencontainers/distribution-spec/blob/main/spec.md) \u662f\u5f15\u7528\u6620\u50cf\u4e0d\u540c\u7248\u672c\u7684\u5e38\u7528\u65b9\u6cd5\u3002\u4e00\u7a2e\u5e38\u898b\u7684\u65b9\u6cd5\u662f\u5728\u69cb\u5efa\u6642\u7528\u7248\u672c\u6a19\u8b58\u7b26\u6a19\u8a18\u6620\u50cf\u3002\u4f8b\u5982\uff0c `v1.0.1` \u53ef\u4ee5\u5f15\u7528\u60a8\u7a31\u7232 `1.0.1` \u7684\u7248\u672c\u3002\n\u6a19\u8a18\u4f7f\u6620\u50cf\u4fee\u8a02\u6613\u65bc\u901a\u904e\u4eba\u985e\u53ef\u8b80\u7684\u5b57\u7b26\u4e32\u67e5\u627e\u3002\u4f46\u662f\uff0c\u6a19\u8a18\u662f\u53ef\u8b8a\u5f15\u7528\uff0c\u9019\u610f\u5473\u7740\u6a19\u7c64\u6240\u5f15\u7528\u7684\u6620\u50cf\u53ef\u4ee5\u66f4\u6539\uff0c\u5982\u4e0b\u5716\u6240\u793a\uff1a\n\u5982\u4e0a\u5716\u6240\u793a\uff0c\u5982\u679c\u60a8\u767c\u4f48\u7684\u6620\u50cf\u6240\u4f7f\u7528\u7684\u6a19\u8a18\u8207\u73fe\u6709\u6620\u50cf\u76f8\u540c\uff0c\u5247\u8a72\u6a19\u8a18\u6703\u505c\u6b62\u6307\u5411\u73fe\u6709\u6620\u50cf\uff0c\u4e26\u958b\u59cb\u6307\u5411\u65b0\u6620\u50cf\u3002\n### \u6620\u50cf\u6a19\u8a18\u7684\u7f3a\u9ede\n\u6a19\u8a18\u662f\u53ef\u8b8a\u7684\uff0c\u56e0\u6b64\u7576\u60a8\u4f7f\u7528\u5b83\u5011\u90e8\u7f72\u6620\u50cf\u6642\uff0c\u5b83\u5011\u5177\u6709\u4ee5\u4e0b\u7f3a\u9ede\uff1a\n- \u5728 Kubernetes \u4e2d\uff0c\u6309\u6a19\u7c64\u90e8\u7f72\u53ef\u80fd\u6703\u5c0e\u81f4\u610f\u5916\u7d50\u679c\u3002\u4f8b\u5982\uff0c\u5047\u8a2d\u60a8\u6709\u4e00\u500b\u73fe\u6709\u7684 Deployment \u8cc7\u6e90\uff0c\u8a72\u8cc7\u6e90\u901a\u904e\u6a19\u8a18 `v1.0.1` \u5f15\u7528\u4e86\u4e00\u500b\u5bb9\u5668\u6620\u50cf\u3002\u8981\u4fee\u5fa9\u932f\u8aa4\u6216\u9032\u884c\u4e00\u4e9b\u5c0f\u7684\u66f4\u6539\uff0c\u60a8\u7684\u69cb\u5efa\u904e\u7a0b\u5c07\u5275\u5efa\u4e00\u500b\u5177\u6709\u76f8\u540c\u6a19\u8a18 `v1.0.1` \u7684\u65b0\u6620\u50cf\u3002\u5373\u4f7f\u60a8\u4e0d\u66f4\u6539 Deployment \u8cc7\u6e90\u898f\u7bc4\uff0c\u901a\u904e Deployment \u8cc7\u6e90\u5275\u5efa\u7684\u65b0 Pod \u4ecd\u53ef\u4ee5\u4f7f\u7528\u820a\u6620\u50cf\u6216\u65b0\u6620\u50cf\u3002\u6b64\u554f\u984c\u4e5f\u9069\u7528\u65bc\u5176\u4ed6 Kubernetes \u8cc7\u6e90\uff0c\u4f8b\u5982StatefulSets\u3001DaemonSets\u3001ReplicaSets \u548c Jobs\u3002\n- \u5982\u679c\u60a8\u4f7f\u7528\u5de5\u5177\u6383\u63cf\u6216\u5206\u6790\u6620\u50cf\uff0c\u7531\u9019\u4e9b\u5de5\u5177\u751f\u6210\u7684\u7d50\u679c\u5c07\u50c5\u5c0d\u6383\u63cf\u7684\u6620\u50cf\u6709\u6548\u3002\u7232\u4e86\u78ba\u4fdd\u60a8\u90e8\u7f72\u5df2\u7d93\u904e\u6383\u63cf\u7684\u6620\u50cf\uff0c\u60a8\u7121\u6cd5\u4f9d\u8cf4\u6a19\u8a18\uff0c\u56e0\u7232\u8a72\u6a19\u8a18\u5f15\u7528\u7684\u6620\u50cf\u53ef\u80fd\u5df2\u7d93\u66f4\u6539\u3002\n- \u5982\u679c\u60a8\u5c07 [Binary Authorization](https://cloud.google.com/binary-authorization/docs?hl=zh-cn) \u8207 [Google Kubernetes Engine (GKE)](https://cloud.google.com/kubernetes-engine/docs?hl=zh-cn) \u642d\u914d\u4f7f\u7528\uff0c\u5247\u57fa\u65bc\u6a19\u8a18\u7684\u90e8\u7f72\u6703\u88ab\u7981\u6b62\u4f7f\u7528\uff0c\u56e0\u7232\u7121\u6cd5\u78ba\u5b9a\u5275\u5efa Pod \u6642\u4f7f\u7528\u7684\u78ba\u5207\u6620\u50cf\u3002\n\u90e8\u7f72\u6620\u50cf\u6642\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u6620\u50cf\u6458\u8981\u4f86\u907f\u514d\u4f7f\u7528\u6a19\u8a18\u7684\u52a3\u52e2\u3002\u60a8\u4ecd\u7136\u53ef\u4ee5\u6839\u64da\u9700\u8981\u7232\u6620\u50cf\u6dfb\u52a0\u6a19\u8a18\uff0c\u4f46\u4e26\u975e\u5fc5\u9808\u9019\u6a23\u505a\u3002\n## \u6620\u50cf\u7684\u7d50\u69cb\n\u6620\u50cf\u7531\u4ee5\u4e0b\u7d44\u4ef6\u7d44\u6210\uff1a\n- [\u6620\u50cf\u6e05\u55ae](https://github.com/opencontainers/image-spec/blob/main/manifest.md#oci-image-manifest-specification) \n- [\u914d\u7f6e\u5c0d\u8c61](https://github.com/opencontainers/image-spec/blob/main/manifest.md#image-manifest-property-descriptions) \n- \u4e00\u500b\u6216\u591a\u500b [\u6587\u4ef6\u7cfb\u7d71\u5c64](https://github.com/opencontainers/image-spec/blob/main/layer.md#image-layer-filesystem-changeset) \u7684\u6578\u7d44\n- \u53ef\u9078\u7684 [\u6620\u50cf\u7d22\u5f15](https://github.com/opencontainers/image-spec/blob/main/image-index.md#oci-image-index-specification) \n\u9019\u4e9b\u7d44\u4ef6\u5982\u4e0b\u5716\u6240\u793a\uff1a\n\u4e0a\u5716\u986f\u793a\u4e86\u8207\u6620\u50cf\u7d44\u4ef6\u6709\u95dc\u7684\u5176\u4ed6\u8a73\u7d30\u4fe1\u606f\uff1a\n- \u6620\u50cf\u6e05\u55ae\u662f\u4e00\u500b JSON \u6587\u6a94\uff0c\u5176\u4e2d\u5305\u542b\u5c0d\u914d\u7f6e\u5c0d\u8c61\u3001\u6587\u4ef6\u7cfb\u7d71\u5c64\u548c\u53ef\u9078\u5143\u6578\u64da\u7684\u5f15\u7528\u3002\n- \u6620\u50cf\u6e05\u55ae\u4f7f\u7528`digest`\u7279\u6027\u5f15\u7528\u914d\u7f6e\u5c0d\u8c61\u548c\u6bcf\u500b\u6587\u4ef6\u7cfb\u7d71\u5c64\u3002`digest`\u7279\u6027\u7684\u503c\u662f\u6458\u8981\u6240\u5f15\u7528\u7684\u5167\u5bb9\u7684\u52a0\u5bc6\u54c8\u5e0c\u503c\uff0c\u901a\u5e38\u4f7f\u7528 [SHA-256](https://github.com/opencontainers/image-spec/blob/main/descriptor.md#sha-256) \u7b97\u6cd5\u9032\u884c\u8a08\u7b97\u3002\n- \u6458\u8981\u503c\u7528\u65bc\u69cb\u5efa\u5c0d\u8c61\u7684\u4e0d\u53ef\u8b8a\u5730\u5740\u3002\u6b64\u904e\u7a0b\u7a31\u7232 [\u5167\u5bb9\u53ef\u5c0b\u5740\u7684\u5b58\u5132](https://wikipedia.org/wiki/Content-addressable_storage) \uff0c\u9019\u610f\u5473\u7740\u60a8\u53ef\u4ee5\u6839\u64da\u5176\u6458\u8981\u6aa2\u7d22\u6620\u50cf\u6e05\u55ae\u3001\u6620\u50cf\u7d22\u5f15\u3001\u914d\u7f6e\u5c0d\u8c61\u548c\u5c64\u3002\n- \u6620\u50cf\u6458\u8981\u662f\u6620\u50cf\u7d22\u5f15\u6216\u6620\u50cf\u6e05\u55ae JSON \u6587\u6a94\u7684\u54c8\u5e0c\u503c\u3002\n- \u914d\u7f6e\u5c0d\u8c61\u662f\u4e00\u500b JSON \u6587\u6a94\uff0c\u7528\u65bc\u5b9a\u7fa9 [\u6620\u50cf\u7684\u7279\u6027](https://github.com/opencontainers/image-spec/blob/main/config.md#properties) \uff0c\u4f8b\u5982 CPU \u67b6\u69cb\u3001\u5165\u53e3\u9ede\u3001\u516c\u958b\u7aef\u53e3\u548c\u74b0\u5883\u8b8a\u91cf\u3002\n- \u6587\u4ef6\u7cfb\u7d71\u5c64\u6578\u7d44\u5b9a\u7fa9\u4e86\u5bb9\u5668\u904b\u884c\u6642\u5806\u758a\u5c64\u7684\u9806\u5e8f\u3002\u9019\u4e9b\u5c64\u4f5c\u7232 [tar \u6587\u4ef6](https://wikipedia.org/wiki/Tar_(computing)) \u5206\u767c\uff0c\u901a\u5e38\u4f7f\u7528 [gzip](https://www.gzip.org/) \u5be6\u7528\u7a0b\u5e8f\u9032\u884c\u58d3\u7e2e\u3002\n- \u53ef\u9078\u6620\u50cf\u7d22\u5f15\uff08\u6709\u6642\u7a31\u7232 [\u6e05\u55ae\u5217\u8868](https://docs.docker.com/registry/spec/manifest-v2-2/#manifest-list) \uff09\u5f15\u7528\u4e00\u500b\u6216\u591a\u500b\u6620\u50cf\u6e05\u55ae\u3002\u8a72\u53c3\u8003\u662f\u6620\u50cf\u6e05\u55ae\u7684\u6458\u8981\u3002\u5728\u7232\u4e0d\u540c\u7684 [\u5e73\u81fa](https://github.com/opencontainers/image-spec/blob/main/image-index.md#image-index-property-descriptions) \uff08\u4f8b\u5982`amd64`\u548c`arm64`\u67b6\u69cb\uff09\u751f\u6210\u591a\u500b\u76f8\u95dc\u6620\u50cf\u6642\uff0c\u6620\u50cf\u7d22\u5f15\u6703\u975e\u5e38\u6709\u7528\u3002\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u700f\u89bd\u6620\u50cf\u6e05\u55ae\u3001\u6458\u8981\u548c\u6a19\u8a18](#exploring_image_manifests_digests_and_tags) \u90e8\u5206\u3002\n## \u67e5\u627e\u6620\u50cf\u6458\u8981\n\u5982\u9700\u4f7f\u7528\u6620\u50cf\u6458\u8981\u9032\u884c\u90e8\u7f72\uff0c\u60a8\u5fc5\u9808\u5148\u627e\u5230\u6458\u8981\u3002\u7136\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5c07\u6458\u8981\u8207\u90e8\u7f72\u547d\u4ee4\u4e00\u8d77\u4f7f\u7528\uff0c\u6216\u5c07\u5176\u5305\u542b\u5728 Kubernetes \u6e05\u55ae\u4e2d\u3002\n\u60a8\u53ef\u4ee5\u901a\u904e\u591a\u7a2e\u65b9\u5f0f\u7372\u53d6\u6620\u50cf\u7684\u6458\u8981\uff0c\u5177\u9ad4\u53d6\u6c7a\u65bc\u60a8\u7576\u524d\u7684\u60c5\u6cc1\u3002\u4ee5\u4e0b\u90e8\u5206\u5305\u542b\u4e0d\u540c\u7522\u54c1\u548c\u5de5\u5177\u7684\u793a\u4f8b\u3002\n\u5728\u4ee5\u4e0b\u90e8\u5206\u4e2d\uff0c\u5728 Cloud Shell \u6216\u5df2\u5b89\u88dd gcloud CLI\u3001Docker\u3001cURL \u548c `jq` \u7b49\u5de5\u5177\u7684 shell \u74b0\u5883\u4e2d\u904b\u884c\u547d\u4ee4\u3002\n### Artifact Registry\n- \u5c0d\u65bc\u5b58\u5132\u5728 [Artifact Registry](https://cloud.google.com/artifact-registry/docs?hl=zh-cn) \u4e2d\u7684\u6620\u50cf\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 [gcloud artifacts docker images describe \u547d\u4ee4](https://cloud.google.com/sdk/gcloud/reference/artifacts/docker/images/describe?hl=zh-cn) \u3002```\ngcloud artifacts docker images describe \\\n LOCATION-docker.pkg.dev/PROJECT/REPOSITORY/IMAGE:TAG \\\n --format 'value(image_summary.digest)'\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u4ee3\u78bc\u5eab\u7684\u5340\u57df\u6216\u591a\u5340\u57df [\u4f4d\u7f6e](https://cloud.google.com/artifact-registry/docs/repositories/repo-locations?hl=zh-cn) \n- ``\uff1a\u60a8\u7684 [Google Cloud \u9805\u76ee ID](https://cloud.google.com/resource-manager/docs/creating-managing-projects?hl=zh-cn#identifying_projects) \n- ``\uff1a\u60a8\u7684\u4ee3\u78bc\u5eab\u540d\u7a31\n- ``\uff1a\u60a8\u7684\u6620\u50cf\u540d\u7a31\n- ``\uff1a\u60a8\u7684\u6620\u50cf\u6a19\u8a18\n### Container Registry\n- \u5c0d\u65bc\u5b58\u5132\u5728 [Container Registry](https://cloud.google.com/container-registry/docs?hl=zh-cn) \u4e2d\u7684\u6620\u50cf\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 [gcloud container images describe \u547d\u4ee4](https://cloud.google.com/sdk/gcloud/reference/container/images/describe?hl=zh-cn) \u7372\u53d6\u6620\u50cf\u7684\u6458\u8981\uff0c\u65b9\u6cd5\u662f\u63d0\u4f9b\u540d\u7a31\u548c\u6a19\u8a18\u3002\u4f7f\u7528 [--format \u6a19\u8a8c](https://cloud.google.com/sdk/gcloud/reference/topic/formats?hl=zh-cn) \u53ea\u986f\u793a\u6458\u8981\uff1a```\ngcloud container images describe \\\u00a0 \u00a0 gcr.io/google-containers/pause-amd64:3.2 \\\u00a0 \u00a0 --format 'value(image_summary.digest)'\n```\u5118\u7ba1\u60a8\u7684\u6458\u8981\u503c\u53ef\u80fd\u6709\u6240\u4e0d\u540c\uff0c\u4f46\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nsha256:4a1c4b21597c1b4415bdbecb28a3296c6b5e23ca4f9feeb599860a1dac6a0108\n```\n### Cloud Build\n\u5c0d\u65bc\u4f7f\u7528 [Cloud Build](https://cloud.google.com/build/docs?hl=zh-cn) \u69cb\u5efa\u7684\u6620\u50cf\uff0c\u60a8\u53ef\u4ee5\u7d50\u5408\u4f7f\u7528 [gcloud builds describe \u547d\u4ee4](https://cloud.google.com/sdk/gcloud/reference/builds/describe?hl=zh-cn) \u548c `--format` \u6a19\u8a8c\u4f86\u7372\u53d6\u6620\u50cf\u6458\u8981\u3002\u7121\u8ad6\u60a8\u4f7f\u7528\u54ea\u500b\u8a3b\u518a\u8868\u4f86\u767c\u5e03\u6620\u50cf\uff0c\u6b64\u65b9\u6cd5\u90fd\u9069\u7528\u3002\n- \u5c0d\u65bc\u5df2\u7d93\u5b8c\u6210\u7684\u69cb\u5efa\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u7372\u53d6\u9805\u76ee\u7684\u69cb\u5efa\u5217\u8868\uff1a```\ngcloud builds list\n```\u8a18\u4e0b `` \u3002\n- \u7372\u53d6\u6620\u50cf\u6458\u8981\uff1a```\ngcloud builds describe BUILD_ID \\\n --format 'value(results.images[0].digest)'\n```\u5c07 `` \u66ff\u63db\u7232 Cloud Build \u5206\u914d\u7d66\u69cb\u5efa\u7684\u552f\u4e00 ID\u3002\n- \u91dd\u5c0d\u7576\u524d\u9805\u76ee\u5f9e Cloud Build \u7372\u53d6\u6700\u65b0\u69cb\u5efa\u7684\u6620\u50cf\u540d\u7a31\u548c\u6458\u8981\uff1a```\ngcloud builds describe \\\u00a0 \u00a0 $(gcloud builds list --limit 1 --format 'value(id)') \\\u00a0 \u00a0 --format 'value[separator=\"@\"](results.images[0].name,results.images[0].digest)'\n```\n- \u5982\u679c\u60a8\u7684\u69cb\u5efa\u751f\u6210\u4e86\u591a\u5f35\u6620\u50cf\uff0c\u8acb\u904e\u6ffe\u8f38\u51fa\u4e26\u7372\u53d6\u5176\u4e2d\u4e00\u500b\u6620\u50cf\u7684\u6458\u8981\uff1a```\ngcloud builds describe BUILD_ID --format json \\\n | jq -r '.results.images[] | select(.name==\"YOUR_IMAGE_NAME\") | .digest'\n```\u5c07 `` \u66ff\u63db\u7232 [cloudbuild.yaml \u6587\u4ef6](https://cloud.google.com/build/docs/build-config?hl=zh-cn#images) \u4e2d\u5176\u4e2d\u4e00\u500b\u6620\u50cf\u7684\u540d\u7a31\u3002\n- \u5982\u679c\u60a8\u4f7f\u7528 [gcloud builds submit \u547d\u4ee4](https://cloud.google.com/sdk/gcloud/reference/builds/submit?hl=zh-cn) \u5411 Cloud Build \u63d0\u4ea4\u69cb\u5efa\uff0c\u5247\u53ef\u4ee5\u5f9e\u74b0\u5883\u8b8a\u91cf\u7684\u8f38\u51fa\u4e2d\u6355\u7372\u6620\u50cf\u6458\u8981\uff1a```\nIMAGE_DIGEST=$(gcloud builds submit \\\u00a0 \u00a0 --format 'value(results.images[0].digest)' | tail -n1)\n```\n### Cloud Native Buildpacks\n- \u5982\u679c\u60a8\u4f7f\u7528 [Cloud Native Buildpack](https://cloud.google.com/blog/products/containers-kubernetes/google-cloud-now-supports-buildpacks?hl=zh-cn) \u548c Google Cloud \u69cb\u5efa\u5668\u4f86\u69cb\u5efa\u548c\u767c\u4f48\u6620\u50cf\uff0c\u5247\u53ef\u4ee5\u5c07 `--quiet` \u6a19\u8a8c\u8207 `pack` \u547d\u4ee4\u7d50\u5408\u4f7f\u7528\u4f86\u6355\u7372\u6620\u50cf\u540d\u7a31\u548c\u6458\u8981\u3002```\npack build --builder gcr.io/buildpacks/builder:v1 --publish --quiet \\\n LOCATION-docker.pkg.dev/PROJECT_ID/REPOSITORY/IMAGE \\\n > image-with-digest.txt\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u4ee3\u78bc\u5eab\u7684\u5340\u57df\u6216\u591a\u5340\u57df [\u4f4d\u7f6e](https://cloud.google.com/artifact-registry/docs/repositories/repo-locations?hl=zh-cn) \n- ``\uff1a\u60a8\u7684 [Google Cloud \u9805\u76ee ID](https://cloud.google.com/resource-manager/docs/creating-managing-projects?hl=zh-cn#identifying_projects) \n- ``\uff1a\u60a8\u7684\u4ee3\u78bc\u5eab\u540d\u7a31\n- ``\uff1a\u60a8\u7684\u6620\u50cf\u540d\u7a31\n\u6587\u4ef6 `image-with-digest.txt` \u5305\u542b\u6620\u50cf\u540d\u7a31\u548c\u6458\u8981\u3002\u5982\u679c\u8981\u7232\u6620\u50cf\u6dfb\u52a0\u6a19\u8a18\uff0c\u8acb\u4f7f\u7528 `--tag` \u6a19\u8a8c\u3002\n### Docker \u5ba2\u6236\u7aef\n- `docker` \u547d\u4ee4\u884c\u5ba2\u6236\u7aef\u7684 [manifest \u5b50\u547d\u4ee4](https://docs.docker.com/engine/reference/commandline/manifest/) \u53ef\u4ee5\u5f9e\u5bb9\u5668\u6620\u50cf\u8a3b\u518a\u8868\u4e2d\u63d0\u53d6\u6620\u50cf\u6e05\u55ae\u548c\u6e05\u55ae\u5217\u8868\u3002\u5f9e\u6620\u50cf `registry.k8s.io/pause:3.9` \u7684\u6e05\u55ae\u5217\u8868\u7372\u53d6\u6458\u8981\uff08\u91dd\u5c0d `amd64` CPU \u67b6\u69cb\u548c `linux` \u64cd\u4f5c\u7cfb\u7d71\uff09\uff1a```\ndocker manifest inspect --verbose registry.k8s.io/pause:3.9 | \\\u00a0 \u00a0 jq -r 'if type==\"object\"\u00a0 \u00a0 \u00a0 \u00a0 then .Descriptor.digest\u00a0 \u00a0 \u00a0 \u00a0 else .[] | select(.Descriptor.platform.architecture==\"amd64\" and\u00a0 \u00a0 \u00a0 \u00a0 .Descriptor.platform.os==\"linux\") | .Descriptor.digest\u00a0 \u00a0 \u00a0 \u00a0 end'\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nsha256:8d4106c88ec0bd28001e34c975d65175d994072d65341f62a8ab0754b0fafe10\n```\n- \u5c0d\u65bc\u5b58\u5132\u5728\u672c\u5730 [Docker \u5b88\u8b77\u7a0b\u5e8f](https://docs.docker.com/config/daemon/) \u4e2d\u7684\u6620\u50cf\uff0c\u4ee5\u53ca\u5f9e\u6620\u50cf\u8a3b\u518a\u8868\u62c9\u53d6\u6216\u63a8\u9001\u5230\u6620\u50cf\u8a3b\u518a\u8868\u7684\u6620\u50cf\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 Docker \u547d\u4ee4\u884c\u5de5\u5177\u4f86\u7372\u53d6\u6620\u50cf\u6458\u8981\uff1a- \u5c07\u6620\u50cf\u62c9\u53d6\u5230\u672c\u5730 [Docker \u5b88\u8b77\u7a0b\u5e8f](https://docs.docker.com/config/daemon/) \uff1a```\ndocker pull docker.io/library/debian:bookworm\n```\n- \u7372\u53d6\u6620\u50cf\u6458\u8981\uff1a```\ndocker inspect docker.io/library/debian:bookworm \\\u00a0 \u00a0 | jq -r '.[0].RepoDigests[0]' \\\u00a0 \u00a0 | cut -d'@' -f2\n```\u5118\u7ba1\u60a8\u7684\u6458\u8981\u503c\u53ef\u80fd\u6709\u6240\u4e0d\u540c\uff0c\u4f46\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nsha256:3d868b5eb908155f3784317b3dda2941df87bbbbaa4608f84881de66d9bb297b\n```\n- \u5217\u51fa\u672c\u5730 Docker \u5b88\u8b77\u7a0b\u5e8f\u4e2d\u7684\u6240\u6709\u6620\u50cf\u548c\u6458\u8981\uff1a```\ndocker images --digests\n```\u8f38\u51fa\u6703\u986f\u793a\u5177\u6709\u6458\u8981\u503c\u7684\u6620\u50cf\u7684\u6458\u8981\u3002\u5f9e\u6620\u50cf\u8a3b\u518a\u8868\u62c9\u53d6\u6620\u50cf\u6216\u5c07\u6620\u50cf\u63a8\u9001\u5230\u6620\u50cf\u8a3b\u518a\u8868\u6642\uff0c\u6620\u50cf\u53ea\u6709\u6458\u8981\u503c\u3002\n### crane \u548c gcrane\n\u60a8\u53ef\u4ee5\u4f7f\u7528\u958b\u6e90 [crane](https://github.com/google/go-containerregistry/blob/main/cmd/crane/README.md) \u548c [gcrane](https://github.com/google/go-containerregistry/blob/main/cmd/gcrane/README.md) \u547d\u4ee4\u884c\u5de5\u5177\u4f86\u7372\u53d6\u6620\u50cf\u6458\u8981\uff0c\u800c\u7121\u9700\u5c07\u6620\u50cf\u62c9\u53d6\u5230\u672c\u5730 Docker \u5b88\u8b77\u7a0b\u5e8f\u3002\n- \u5c07 `crane` \u548c `gcrane` \u4e0b\u8f09\u5230\u7576\u524d\u76ee\u9304\uff1a```\nVERSION=$(curl -sL https://api.github.com/repos/google/go-containerregistry/releases/latest | jq -r .tag_name)curl -L \"https://github.com/google/go-containerregistry/releases/download/${VERSION}/go-containerregistry_$(uname -s)_$(uname -m).tar.gz\" | tar -zxf - crane gcrane\n```\n- \u7372\u53d6\u6620\u50cf\u6458\u8981\uff1a```\n./gcrane digest gcr.io/distroless/static-debian11:nonroot\n````crane` \u548c `gcrane` \u5177\u6709\u672c\u6587\u6a94\u672a\u4ecb\u7d39\u7684\u5176\u4ed6\u529f\u80fd\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [crane](https://github.com/google/go-containerregistry/blob/main/cmd/crane/README.md#crane) \u548c [gcrane](https://github.com/google/go-containerregistry/blob/main/cmd/gcrane/README.md#gcrane) \u7684\u6587\u6a94\u3002## \u5f37\u5236\u5728 Kubernetes \u90e8\u7f72\u4e2d\u4f7f\u7528\u6620\u50cf\u6458\u8981\n\u5982\u679c\u8981\u5c0d\u90e8\u7f72\u5230 Kubernetes \u96c6\u7fa3\u7684\u6620\u50cf\u5f37\u5236\u57f7\u884c\u6458\u8981\uff0c\u53ef\u4ee5\u4f7f\u7528 [Policy Controller](https://cloud.google.com/anthos-config-management/docs/concepts/policy-controller?hl=zh-cn) \u6216 [Open Policy Agent (OPA) Gatekeeper](https://open-policy-agent.github.io/gatekeeper/website/) \u3002Policy Controller \u662f\u57fa\u65bc OPA Gatekeeper \u958b\u6e90\u9805\u76ee\u69cb\u5efa\u7684\u3002\nPolicy Controller \u548c OPA Gatekeeper \u90fd\u662f\u5728 [OPA \u653f\u7b56\u5f15\u64ce](https://www.openpolicyagent.org/) \u7684\u57fa\u790e\u4e0a\u69cb\u5efa\u7684\u3002Policy Controller \u548c OPA Gatekeeper \u63d0\u4f9b [Kubernetes \u9a57\u8b49\u51c6\u8a31\u7db2\u7d61\u9264\u5b50](https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/) \u5f37\u5236\u57f7\u884c\u653f\u7b56\uff0c\u4e26\u4e14 [\u81ea\u5b9a\u7fa9\u8cc7\u6e90\u5b9a\u7fa9 (CRD)](https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/) \u9069\u7528\u65bc [\u9650\u5236\u689d\u4ef6\u6a21\u677f](https://github.com/open-policy-agent/frameworks/tree/master/constraint#what-is-a-constraint-template) \u548c [\u9650\u5236\u689d\u4ef6](https://github.com/open-policy-agent/frameworks/tree/master/constraint#what-is-a-constraint) \u3002\n\u9650\u5236\u689d\u4ef6\u6a21\u677f\u5305\u542b\u4e00\u7a2e\u4f7f\u7528\u540d\u7232 [Rego](https://www.openpolicyagent.org/docs/latest/#rego) \u7684\u9ad8\u7d1a\u8072\u660e\u8a9e\u8a00\u4f86\u8868\u793a\u7684\u653f\u7b56\u908f\u8f2f\u3002\u4ee5\u4e0b\u9650\u5236\u689d\u4ef6\u6a21\u677f\u53ef\u9a57\u8b49 Kubernetes \u8cc7\u6e90\u898f\u7bc4\u4e2d\u7684\u5bb9\u5668\u3001 [init \u5bb9\u5668](https://kubernetes.io/docs/concepts/workloads/pods/init-containers/) \u548c [\u81e8\u6642\u5bb9\u5668](https://kubernetes.io/docs/concepts/workloads/pods/ephemeral-containers/) \u662f\u5426\u4f7f\u7528\u542b\u6458\u8981\u7684\u6620\u50cf\uff1a\n[  library/general/imagedigests/template.yaml ](https://github.com/open-policy-agent/gatekeeper-library/blob/HEAD/library/general/imagedigests/template.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/open-policy-agent/gatekeeper-library/blob/HEAD/library/general/imagedigests/template.yaml)\n```\napiVersion: templates.gatekeeper.sh/v1kind: ConstraintTemplatemetadata:\u00a0 name: k8simagedigests\u00a0 annotations:\u00a0 \u00a0 metadata.gatekeeper.sh/title: \"Image Digests\"\u00a0 \u00a0 metadata.gatekeeper.sh/version: 1.0.0\u00a0 \u00a0 description: >-\u00a0 \u00a0 \u00a0 Requires container images to contain a digest.\u00a0 \u00a0 \u00a0 https://kubernetes.io/docs/concepts/containers/images/spec:\u00a0 crd:\u00a0 \u00a0 spec:\u00a0 \u00a0 \u00a0 names:\u00a0 \u00a0 \u00a0 \u00a0 kind: K8sImageDigests\u00a0 \u00a0 \u00a0 validation:\u00a0 \u00a0 \u00a0 \u00a0 openAPIV3Schema:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 type: object\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 description: >-\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Requires container images to contain a digest.\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 https://kubernetes.io/docs/concepts/containers/images/\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 properties:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 exemptImages:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 description: >-\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Any container that uses an image that matches an entry in this list will be excluded\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 from enforcement. Prefix-matching can be signified with `*`. For example: `my-image-*`.\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 It is recommended that users use the fully-qualified Docker image name (e.g. start with a domain name)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 in order to avoid unexpectedly exempting images from an untrusted repository.\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 type: array\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 items:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 type: string\u00a0 targets:\u00a0 \u00a0 - target: admission.k8s.gatekeeper.sh\u00a0 \u00a0 \u00a0 rego: |\u00a0 \u00a0 \u00a0 \u00a0 package k8simagedigests\u00a0 \u00a0 \u00a0 \u00a0 import data.lib.exempt_container.is_exempt\u00a0 \u00a0 \u00a0 \u00a0 violation[{\"msg\": msg}] {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 container := input.review.object.spec.containers[_]\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 not is_exempt(container)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 satisfied := [re_match(\"@[a-z0-9]+([+._-][a-z0-9]+)*:[a-zA-Z0-9=_-]+\", container.image)]\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 not all(satisfied)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 msg := sprintf(\"container <%v> uses an image without a digest <%v>\", [container.name, container.image])\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 violation[{\"msg\": msg}] {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 container := input.review.object.spec.initContainers[_]\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 not is_exempt(container)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 satisfied := [re_match(\"@[a-z0-9]+([+._-][a-z0-9]+)*:[a-zA-Z0-9=_-]+\", container.image)]\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 not all(satisfied)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 msg := sprintf(\"initContainer <%v> uses an image without a digest <%v>\", [container.name, container.image])\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 violation[{\"msg\": msg}] {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 container := input.review.object.spec.ephemeralContainers[_]\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 not is_exempt(container)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 satisfied := [re_match(\"@[a-z0-9]+([+._-][a-z0-9]+)*:[a-zA-Z0-9=_-]+\", container.image)]\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 not all(satisfied)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 msg := sprintf(\"ephemeralContainer <%v> uses an image without a digest <%v>\", [container.name, container.image])\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 libs:\u00a0 \u00a0 \u00a0 \u00a0 - |\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 package lib.exempt_container\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 is_exempt(container) {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 exempt_images := object.get(object.get(input, \"parameters\", {}), \"exemptImages\", [])\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 img := container.image\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 exemption := exempt_images[_]\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 _matches_exemption(img, exemption)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 _matches_exemption(img, exemption) {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 not endswith(exemption, \"*\")\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 exemption == img\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 _matches_exemption(img, exemption) {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 endswith(exemption, \"*\")\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 prefix := trim_suffix(exemption, \"*\")\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 startswith(img, prefix)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 }\n```\n\u4e0a\u8ff0\u653f\u7b56\u5305\u542b\u4e00\u500b\u6b63\u5247\u8868\u9054\u5f0f\u4f5c\u7232 [re_match \u51fd\u6578](https://www.openpolicyagent.org/docs/v0.22.0/policy-reference/#regex) \u7684\u8f38\u5165\u3002\u6b64\u6b63\u5247\u8868\u9054\u5f0f\u8207\u5bb9\u5668\u6620\u50cf\u6458\u8981\u4e00\u81f4\uff0c\u4e26\u4e14\u57fa\u65bc [Open Container Initiative \u6620\u50cf\u898f\u7bc4\u4e2d\u7684\u6458\u8981\u683c\u5f0f](https://github.com/opencontainers/image-spec/blob/main/descriptor.md#digests) \u3002\n\u9650\u5236\u689d\u4ef6\u6703\u901a\u904e\u8207 `kind` \u548c `namespace` \u7b49\u7279\u6027\u9032\u884c\u5339\u914d\u4f86\u5c07\u653f\u7b56\u61c9\u7528\u65bc Kubernetes \u8cc7\u6e90\u3002\u4ee5\u4e0b\u793a\u4f8b\u9650\u5236\u689d\u4ef6\u5c07\u9650\u5236\u689d\u4ef6\u6a21\u677f\u4e2d\u7684\u653f\u7b56\u61c9\u7528\u65bc `default` \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 `Pod` \u8cc7\u6e90\u3002\n[  library/general/imagedigests/samples/container-image-must-have-digest/constraint.yaml ](https://github.com/open-policy-agent/gatekeeper-library/blob/HEAD/library/general/imagedigests/samples/container-image-must-have-digest/constraint.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/open-policy-agent/gatekeeper-library/blob/HEAD/library/general/imagedigests/samples/container-image-must-have-digest/constraint.yaml)\n```\napiVersion: constraints.gatekeeper.sh/v1beta1kind: K8sImageDigestsmetadata:\u00a0 name: container-image-must-have-digestspec:\u00a0 match:\u00a0 \u00a0 kinds:\u00a0 \u00a0 \u00a0 - apiGroups: [\"\"]\u00a0 \u00a0 \u00a0 \u00a0 kinds: [\"Pod\"]\u00a0 \u00a0 namespaces:\u00a0 \u00a0 \u00a0 - \"default\"\n```\n\u5275\u5efa\u9650\u5236\u689d\u4ef6\u6a21\u677f\u548c\u9650\u5236\u689d\u4ef6\u5f8c\uff0c `default` \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u4efb\u4f55\u65b0 pod \u90fd\u5fc5\u9808\u4f7f\u7528\u6620\u50cf\u6458\u8981\u4f86\u5f15\u7528\u5bb9\u5668\u6620\u50cf\u3002\n\u5982\u9700\u67e5\u770b\u5b8c\u6574\u793a\u4f8b\uff0c\u8acb\u53c3\u95b1 Gatekeeper \u653f\u7b56\u5eab\u4e2d\u7684 [imagedigests \u653f\u7b56](https://github.com/open-policy-agent/gatekeeper-library/tree/master/library/general/imagedigests) \u3002\n## \u95dc\u65bc\u6620\u50cf\u6e05\u55ae\u3001\u6458\u8981\u548c\u6a19\u8a18\n\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u77ad\u89e3\u5982\u4f55\u4f7f\u7528 `curl` \u548c `docker` \u7b49\u547d\u4ee4\u884c\u5de5\u5177\u63a2\u7d22\u8a3b\u518a\u8868\u4e2d\u7684\u73fe\u6709\u6620\u50cf\u3002\u5728 Cloud Shell \u6216\u5df2\u5b89\u88dd gcloud CLI\u3001Docker\u3001cURL \u548c `jq` \u7b49\u5de5\u5177\u7684 shell \u74b0\u5883\u4e2d\u904b\u884c\u547d\u4ee4\u3002\u4ee5\u4e0b\u547d\u4ee4\u4f7f\u7528 [Container Registry](https://cloud.google.com/container-registry/docs?hl=zh-cn) \u4e2d\u7684\u516c\u5171\u6620\u50cf\u3002\n- \u4f7f\u7528 cURL \u548c [\u6e05\u55ae\u7db2\u5740](https://github.com/opencontainers/distribution-spec/blob/main/spec.md) \u7372\u53d6\u6620\u50cf `gcr.io/google-containers/pause-amd64:3.2` \u7684\u6e05\u55ae\uff1a```\ncurl -s https://gcr.io/v2/google-containers/pause-amd64/manifests/3.2\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\n{\n \"schemaVersion\": 2,\n \"mediaType\": \"application/vnd.docker.distribution.manifest.v2+json\",\n \"config\": {\n  \"mediaType\": \"application/vnd.docker.container.image.v1+json\",\n  \"size\": 759,\n  \"digest\": \"sha256:80d28bedfe5dec59da9ebf8e6260224ac9008ab5c11dbbe16ee3ba3e4439ac2c\"\n },\n \"layers\": [  {\n   \"mediaType\": \"application/vnd.docker.image.rootfs.diff.tar.gzip\",\n   \"size\": 296534,\n   \"digest\": \"sha256:c74f8866df097496217c9f15efe8f8d3db05d19d678a02d01cc7eaed520bb136\"\n  }\n ]\n}\n````config` \u90e8\u5206\u6709\u4e00\u500b\u6458\u8981\u7279\u6027\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u6b64\u503c\u4f86\u6aa2\u7d22\u914d\u7f6e\u5c0d\u8c61\u3002\u540c\u6a23\uff0c\u6bcf\u500b\u5c64\u90fd\u6709\u4e00\u500b `digest` \u7279\u6027\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u8a72\u7279\u6027\u6aa2\u7d22\u8a72\u5c64\u7684 tar \u6587\u4ef6\u3002\n- \u5982\u679c\u6620\u50cf\u5305\u542b\u53ef\u9078\u7684\u6620\u50cf\u7d22\u5f15\uff0c\u5247\u4f7f\u7528\u6a19\u8a18\u767c\u9001\u5230\u6e05\u55ae\u7db2\u5740\u7684 HTTP `GET` \u8acb\u6c42\u6703\u8fd4\u56de\u6620\u50cf\u7d22\u5f15\uff0c\u800c\u4e0d\u662f\u6620\u50cf\u6e05\u55ae\u3002\u7372\u53d6\u6620\u50cf `gcr.io/google-containers/pause:3.2` \u7684\u6620\u50cf\u7d22\u5f15\uff1a```\ncurl -s https://gcr.io/v2/google-containers/pause/manifests/3.2\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\n{\n \"schemaVersion\": 2,\n \"mediaType\": \"application/vnd.docker.distribution.manifest.list.v2+json\",\n \"manifests\": [  {\n   \"mediaType\": \"application/vnd.docker.distribution.manifest.v2+json\",\n   \"size\": 526,\n   \"digest\": \"sha256:4a1c4b21597c1b4415bdbecb28a3296c6b5e23ca4f9feeb599860a1dac6a0108\",\n   \"platform\": {\n   \"architecture\": \"amd64\",\n   \"os\": \"linux\"\n   }\n  },\n  {\n   \"mediaType\": \"application/vnd.docker.distribution.manifest.v2+json\",\n   \"size\": 526,\n   \"digest\": \"sha256:bbb7780ca6592cfc98e601f2a5e94bbf748a232f9116518643905aa30fc01642\",\n   \"platform\": {\n   \"architecture\": \"arm\",\n   \"os\": \"linux\",\n   \"variant\": \"v7\"\n   }\n  },\n  {\n   \"mediaType\": \"application/vnd.docker.distribution.manifest.v2+json\",\n   \"size\": 526,\n   \"digest\": \"sha256:31d3efd12022ffeffb3146bc10ae8beb890c80ed2f07363515580add7ed47636\",\n   \"platform\": {\n   \"architecture\": \"arm64\",\n   \"os\": \"linux\"\n   }\n  },\n  {\n   \"mediaType\": \"application/vnd.docker.distribution.manifest.v2+json\",\n   \"size\": 526,\n   \"digest\": \"sha256:7f82fecd72730a6aeb70713476fb6f7545ed1bbf32cadd7414a77d25e235aaca\",\n   \"platform\": {\n   \"architecture\": \"ppc64le\",\n   \"os\": \"linux\"\n   }\n  },\n  {\n   \"mediaType\": \"application/vnd.docker.distribution.manifest.v2+json\",\n   \"size\": 526,\n   \"digest\": \"sha256:1175fd4d728641115e2802be80abab108b8d9306442ce35425a4e8707ca60521\",\n   \"platform\": {\n   \"architecture\": \"s390x\",\n   \"os\": \"linux\"\n   }\n  }\n ]\n}\n```\n- \u5c0d\u7d50\u679c\u9032\u884c\u904e\u6ffe\uff0c\u4ee5\u63d0\u53d6\u6240\u9700\u5e73\u81fa\u7684\u6620\u50cf\u6458\u8981\u3002\u7372\u53d6 `amd64` CPU \u67b6\u69cb\u548c `linux` \u64cd\u4f5c\u7cfb\u7d71\u7684\u6620\u50cf\u6e05\u55ae\u7684\u6458\u8981\uff1a```\ncurl -s https://gcr.io/v2/google-containers/pause/manifests/3.2 | \\\u00a0 \u00a0 jq -r '.manifests[] | select(.platform.architecture==\"amd64\" and .platform.os==\"linux\") | .digest'\n```\u6b64\u547d\u4ee4\u4e2d\u7684\u904e\u6ffe\u64cd\u4f5c\u6703\u6a21\u64ec\u5bb9\u5668\u904b\u884c\u6642\uff08\u4f8b\u5982 [containerd](https://github.com/containerd/containerd/blob/main/docs/content-flow.md#image-format) \uff09\u5982\u4f55\u5f9e\u6620\u50cf\u7d22\u5f15\u4e2d\u9078\u64c7\u8207\u76ee\u6a19\u5e73\u81fa\u5339\u914d\u7684\u6620\u50cf\u3002\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nsha256:4a1c4b21597c1b4415bdbecb28a3296c6b5e23ca4f9feeb599860a1dac6a0108\n```\u6b64 [\u6620\u50cf\u6458\u8981](https://github.com/opencontainers/image-spec/blob/main/descriptor.md#digests) \u662f\u5c07 [\u9632\u885d\u7a81\u54c8\u5e0c](https://wikipedia.org/wiki/Collision_resistance) \u61c9\u7528\u65bc\u6620\u50cf\u7d22\u5f15\u6216\u6620\u50cf\u6e05\u55ae\u7684\u7d50\u679c\uff0c\u901a\u5e38\u662f [SHA-256](https://github.com/opencontainers/image-spec/blob/main/descriptor.md#sha-256) \u7b97\u6cd5\u3002\n- \u7372\u53d6\u6620\u50cf `gcr.io/google-containers/pause-amd64:3.2` \u7684\u6458\u8981\uff1a```\ncurl -s https://gcr.io/v2/google-containers/pause-amd64/manifests/3.2 \\\u00a0 \u00a0 | shasum -a 256 \\\u00a0 \u00a0 | cut -d' ' -f1\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\n4a1c4b21597c1b4415bdbecb28a3296c6b5e23ca4f9feeb599860a1dac6a0108\n```\u60a8\u53ef\u4ee5\u4f7f\u7528\u6620\u50cf\u6458\u8981\u503c\u4f86\u5f15\u7528\u6b64\u6620\u50cf\uff0c\u5982\u4e0b\u6240\u793a\uff1a```\ngcr.io/google-containers/pause-amd64@sha256:4a1c4b21597c1b4415bdbecb28a3296c6b5e23ca4f9feeb599860a1dac6a0108\n```\n- \u4f7f\u7528 [\u5167\u5bb9\u53ef\u5c0b\u5740\u7684\u5b58\u5132](https://wikipedia.org/wiki/Content-addressable_storage) \u6982\u5ff5\uff0c\u5c07\u6458\u8981\u7528\u4f5c\u53c3\u8003\uff0c\u4ee5\u7372\u53d6\u6620\u50cf\u6e05\u55ae\uff1a```\ncurl -s https://gcr.io/v2/google-containers/pause-amd64/manifests/sha256:4a1c4b21597c1b4415bdbecb28a3296c6b5e23ca4f9feeb599860a1dac6a0108\n```\n- \u8a31\u591a\u5bb9\u5668\u6620\u50cf\u8a3b\u518a\u8868\u6703\u5728 `Docker-Content-Digest` \u6a19\u982d\u4e2d\u8fd4\u56de\u6e05\u55ae\u6458\u8981\u3001\u6620\u50cf\u7d22\u5f15\u3001\u914d\u7f6e\u5c0d\u8c61\u548c\u6587\u4ef6\u7cfb\u7d71\u5c64\uff0c\u4ee5\u97ff\u61c9 HTTP `HEAD` \u8acb\u6c42\u3002\u7372\u53d6\u6620\u50cf `gcr.io/google-containers/pause-amd64:3.2` \u7684\u6620\u50cf\u7d22\u5f15\u7684\u6458\u8981\uff1a```\ncurl -s --head https://gcr.io/v2/google-containers/pause/manifests/3.2 \\\u00a0 \u00a0 | grep -i Docker-Content-Digest \\\u00a0 \u00a0 | cut -d' ' -f2\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nsha256:927d98197ec1141a368550822d18fa1c60bdae27b78b0c004f705f548c07814f\n``` [Open Container Initiative Distribution \u898f\u7bc4\u4e26\u672a\u898f\u5b9a](https://github.com/opencontainers/distribution-spec/blob/main/spec.md#checking-if-content-exists-in-the-registry) `Docker-Content-Digest` \u6a19\u982d\uff0c\u56e0\u6b64\u6b64\u65b9\u6cd5\u53ef\u80fd\u4e26\u4e0d\u9069\u7528\u65bc\u6240\u6709\u5bb9\u5668\u6620\u50cf\u8a3b\u518a\u8868\u3002\u60a8\u53ef\u4ee5\u5c07\u5176\u8207 [Artifact Registry](https://cloud.google.com/artifact-registry/docs?hl=zh-cn) \u548c [Container Registry](https://cloud.google.com/container-registry/docs?hl=zh-cn) \u642d\u914d\u4f7f\u7528\u3002\n- \u5982\u9700\u4f7f\u7528\u6620\u50cf\u6e05\u55ae\u4e2d\u7684\u6458\u8981\u503c\u6aa2\u7d22\u6620\u50cf\u914d\u7f6e\u5c0d\u8c61\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u7372\u53d6\u914d\u7f6e\u6458\u8981\uff1a```\nCONFIG_DIGEST=$(curl -s https://gcr.io/v2/google-containers/pause-amd64/manifests/3.2 \\\u00a0 \u00a0 | jq -r '.config.digest')\n```\n- \u4f7f\u7528\u914d\u7f6e\u6458\u8981\u4f86\u6aa2\u7d22\u914d\u7f6e\u5c0d\u8c61\uff0c\u4e26\u4f7f\u7528 `jq` \u8a2d\u7f6e\u8f38\u51fa\u683c\u5f0f\uff0c\u4f7f\u5176\u66f4\u6613\u65bc\u95b1\u8b80\uff1a```\ncurl -sL https://gcr.io/v2/google-containers/pause-amd64/blobs/$CONFIG_DIGEST \\\u00a0 \u00a0 | jq\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\n{\n \"architecture\": \"amd64\",\n \"config\": {\n \"Env\": [  \"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"\n ],\n \"Entrypoint\": [  \"/pause\"\n ],\n \"WorkingDir\": \"/\",\n \"OnBuild\": null\n },\n \"created\": \"2020-02-14T10:51:50.60182885-08:00\",\n \"history\": [ {\n  \"created\": \"2020-02-14T10:51:50.60182885-08:00\",\n  \"created_by\": \"ARG ARCH\",\n  \"comment\": \"buildkit.dockerfile.v0\",\n  \"empty_layer\": true\n },\n {\n  \"created\": \"2020-02-14T10:51:50.60182885-08:00\",\n  \"created_by\": \"ADD bin/pause-amd64 /pause # buildkit\",\n  \"comment\": \"buildkit.dockerfile.v0\"\n },\n {\n  \"created\": \"2020-02-14T10:51:50.60182885-08:00\",\n  \"created_by\": \"ENTRYPOINT [\\\"/pause\\\"]\",\n  \"comment\": \"buildkit.dockerfile.v0\",\n  \"empty_layer\": true\n }\n ],\n \"os\": \"linux\",\n \"rootfs\": {\n \"type\": \"layers\",\n \"diff_ids\": [  \"sha256:ba0dae6243cc9fa2890df40a625721fdbea5c94ca6da897acdd814d710149770\"\n ]\n }\n}\n```\n- \u5982\u9700\u4f7f\u7528\u6620\u50cf\u6e05\u55ae\u4e2d\u7684\u6458\u8981\u503c\u6aa2\u7d22\u6587\u4ef6\u7cfb\u7d71\u5c64\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u7372\u53d6\u8981\u6aa2\u7d22\u7684\u5c64\u7684\u6458\u8981\uff1a```\nLAYER_DIGEST=$(curl -s https://gcr.io/v2/google-containers/pause-amd64/manifests/3.2 \\\u00a0 \u00a0 | jq -r '.layers[0].digest')\n```\n- \u4f7f\u7528\u5c64\u6458\u8981\u4f86\u6aa2\u7d22\u5c64 tar \u6587\u4ef6\uff0c\u4e26\u5217\u51fa\u5167\u5bb9\uff1a```\ncurl -sL https://gcr.io/v2/google-containers/pause-amd64/blobs/$LAYER_DIGEST \\\u00a0 \u00a0 | tar --list\n```\u6b64\u5c64\u53ea\u6709\u4e00\u500b\u6587\u4ef6\uff0c\u540d\u7232 `pause` \u3002\n- \u5982\u9700\u67e5\u627e\u8207\u6620\u50cf\u6458\u8981\u95dc\u806f\u7684\u6a19\u8a18\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u5b9a\u7fa9\u60a8\u60f3\u67e5\u627e\u7684\u6458\u8981\uff1a```\nIMAGE_DIGEST=$(curl -s https://gcr.io/v2/google-containers/pause-amd64/manifests/3.2 \\\u00a0 \u00a0 | shasum -a 256 \\\u00a0 \u00a0 | cut -d' ' -f1)\n````IMAGE_DIGEST` \u74b0\u5883\u8b8a\u91cf\u5305\u542b\u6a19\u8a18 `3.2` \u6240\u5f15\u7528\u6620\u50cf\u7684\u6458\u8981\u3002\n- \u4f7f\u7528 [\u6620\u50cf\u6a19\u8a18\u5217\u8868\u7aef\u9ede /tags/list](https://github.com/opencontainers/distribution-spec/blob/main/spec.md) \u5217\u51fa\u6a19\u8a18\u4fe1\u606f\uff0c\u4e26\u63d0\u53d6\u6458\u8981\u503c\u5c0d\u61c9\u7684\u6a19\u8a18\uff1a```\ncurl -s \"https://gcr.io/v2/google-containers/pause-amd64/tags/list?n=1\" \\\u00a0 \u00a0 | jq \".manifest.\\\"sha256:$IMAGE_DIGEST\\\".tag\"\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\n[ \"3.2\"\n]\n```\n- \u5982\u9700\u4f7f\u7528 cURL \u5f9e Artifact Registry \u5bb9\u5668\u6620\u50cf\u4ee3\u78bc\u5eab\u7372\u53d6\u6620\u50cf\u7684\u6e05\u55ae\uff0c\u8acb\u5728 `Authorization` \u8acb\u6c42\u6a19\u982d\u4e2d\u6dfb\u52a0 [\u8a2a\u554f\u4ee4\u724c](https://developers.google.com/identity/protocols/oauth2?hl=zh-cn) \uff1a```\ncurl -s -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\\n https://LOCATION-docker.pkg.dev/v2/PROJECT_ID/REPOSITORY/IMAGE/manifests/DIGEST\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u4ee3\u78bc\u5eab\u7684\u5340\u57df\u6216\u591a\u5340\u57df [\u4f4d\u7f6e](https://cloud.google.com/artifact-registry/docs/repositories/repo-locations?hl=zh-cn) \n- ``\uff1a\u60a8\u7684 [Google Cloud \u9805\u76ee ID](https://cloud.google.com/resource-manager/docs/creating-managing-projects?hl=zh-cn#identifying_projects) \n- ``\uff1a\u60a8\u7684\u4ee3\u78bc\u5eab\u540d\u7a31\n- ``\uff1a\u60a8\u7684\u6620\u50cf\u540d\u7a31\n- ``\uff1a\u6620\u50cf\u6458\u8981\uff0c\u683c\u5f0f\u7232`sha256:` ``\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u77ad\u89e3 [\u69cb\u5efa\u5bb9\u5668](https://cloud.google.com/architecture/best-practices-for-building-containers?hl=zh-cn) \u7684\u6700\u4f73\u505a\u6cd5\u3002\n- \u77ad\u89e3 [\u64cd\u4f5c\u5bb9\u5668](https://cloud.google.com/architecture/best-practices-for-operating-containers?hl=zh-cn) \u7684\u6700\u4f73\u505a\u6cd5\u3002\n- \u5982\u9700\u8a73\u7d30\u77ad\u89e3\u6620\u50cf\uff0c\u8acb\u53c3\u95b1 Open Container Initiative [\u6620\u50cf\u683c\u5f0f](https://github.com/opencontainers/image-spec/blob/main/spec.md#image-format-specification) \u548c [\u5206\u4f48](https://github.com/opencontainers/distribution-spec/blob/main/spec.md#distribution-specification) \u898f\u7bc4\u3002", "guide": "Google Kubernetes Engine (GKE)"}