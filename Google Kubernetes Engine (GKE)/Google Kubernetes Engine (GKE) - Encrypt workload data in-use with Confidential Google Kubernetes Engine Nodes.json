{"title": "Google Kubernetes Engine (GKE) - Encrypt workload data in-use with Confidential Google Kubernetes Engine Nodes", "url": "https://cloud.google.com/kubernetes-engine/docs/how-to/confidential-gke-nodes", "abstract": "# Google Kubernetes Engine (GKE) - Encrypt workload data in-use with Confidential Google Kubernetes Engine Nodes\nThis page shows you how to enforce encryption of [data in-use](https://wikipedia.org/wiki/Data_in_use) in your nodes and workloads using Confidential Google Kubernetes Engine Nodes.\n", "content": "## Overview\nConfidential GKE Nodes is built on top of Compute Engine [Confidential VM](/confidential-computing/confidential-vm/docs/about-cvm) using AMD Secure Encryption Virtualization (SEV), which encrypts the memory contents of VMs in-use. Encryption-in-use is one of the three states of end-to-end encryption.\nWhen you enable Confidential GKE Nodes on a cluster or on a node pool, data in workloads running on the confidential nodes is encrypted-in-use. For visibility over your control plane, use [Access Transparency](/access-transparency) .\nYou can enable Confidential GKE Nodes when doing one of the following:\n- Create a new cluster\n- Create a new node pool\n- Update an existing node pool\nYou cannot update an existing cluster to change the cluster-level Confidential GKE Nodes setting.\nThe following table shows you the GKE behavior that applies when you enable Confidential GKE Nodes at the cluster level or at the node pool level:\n| Confidential GKE Nodes setting | How to configure         | Behavior                                                                    |\n|:---------------------------------|:----------------------------------------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| Cluster-level     | Create a new cluster        | All nodes in the cluster in any node pool use Confidential GKE Nodes. You cannot do the following: Disable Confidential GKE Nodes for a new or existing node pool in the cluster Disable Confidential GKE Nodes on the cluster Enable Confidential GKE Nodes on existing clusters |\n| Node pool level     | Create a new node pool Update an existing node pool | You can only configure Confidential GKE Nodes for node pools when this feature is disabled at the cluster-level.                                          |\n## Pricing\nThere is no additional cost to deploy Confidential GKE Nodes, other than the cost of [Compute Engine Confidential VM](/confidential-computing/confidential-vm/pricing) . However, Confidential GKE Nodes might generate slightly more log data on startup than standard nodes. For information on logs pricing, see [Pricing for Google Cloud Observability](/stackdriver/pricing) .\n## Availability\nConfidential GKE Nodes is available in the following situations:\n- Confidential GKE Nodes is only available in zones and regions with [N2D instances](/compute/docs/machine-types#n2d_machine_types) or [C2D instances](/compute/docs/compute-optimized-machines#c2d_machine_types) available.\n- Confidential GKE Nodes can be used with [Container-Optimized OS](/kubernetes-engine/docs/concepts/node-images#cos) and [Container-Optimized OS with containerd (cos_containerd)](/kubernetes-engine/docs/concepts/using-containerd) .## Before you begin\nBefore you start, make sure you have performed the following tasks:\n- Enable    the Google Kubernetes Engine API.\n- [    Enable Google Kubernetes Engine API   ](https://console.cloud.google.com/flows/enableapi?apiid=container.googleapis.com) \n- If you want to use the Google Cloud CLI for this task, [install](/sdk/docs/install) and then [initialize](/sdk/docs/initializing) the  gcloud CLI. If you previously installed the gcloud CLI, get the latest  version by running`gcloud components update`. **Note:** For existing gcloud CLI  installations, make sure to set the`compute/region`and`compute/zone` [properties](/sdk/docs/properties#setting_properties) . By setting default locations,  you can avoid errors in gcloud CLI like the following:`One of [--zone, --region] must be supplied: Please specify location`.## Enable Confidential GKE Nodes on clusters\nYou can create a new cluster with Confidential GKE Nodes enabled by using the gcloud CLI or the Google Cloud console. If you enable Confidential GKE Nodes at the cluster level, all the nodes in the cluster are [Confidential VM](/confidential-computing/confidential-vm/docs/about-cvm) .\nWhen creating a new cluster, specify the `--enable-confidential-nodes` option in the gcloud CLI:\n```\ngcloud container clusters create CLUSTER_NAME \\\u00a0 \u00a0 --machine-type=MACHINE_TYPE \\\u00a0 \u00a0 --enable-confidential-nodes\n```\nReplace the following:- : the name of your new cluster.\n- : the machine type for your cluster's default node pool, which must be the [N2D machine type](/compute/docs/general-purpose-machines#n2d_machines) or the [C2D machine type](/compute/docs/compute-optimized-machines#c2d_machine_types) .\n- Go to the **Google Kubernetes Engine** page in the Google Cloud console. [Go to Google Kubernetes Engine](https://console.cloud.google.com/kubernetes/list) \n- Click **Create** .\n- In the **Standard** section, click **Configure** .\n- From the navigation pane, under **Cluster** , click **Security** .\n- Select the **Enable Confidential GKE Nodes** checkbox.\n- Configure your cluster as needed.\n- Click **Create** .\nSee [Creating a regional cluster](/kubernetes-engine/docs/how-to/creating-a-regional-cluster) for more details about creating clusters.\nAfter creating a cluster with Confidential GKE Nodes, any node pools created in this cluster can only use confidential nodes. You cannot create regular node pools in clusters with Confidential GKE Nodes enabled. You also cannot disable Confidential GKE Nodes on individual node pools when you enable Confidential GKE Nodes at the cluster level.\n## Enable Confidential GKE Nodes on node pools\nYou can enable Confidential GKE Nodes on specific node pools if Confidential GKE Nodes is disabled at the cluster level.\n### Create a new node pool\nTo create a new node pool with Confidential GKE Nodes enabled, run the following command:\n```\ngcloud container node-pools create NODE_POOL_NAME \\\u00a0 \u00a0 --cluster=CLUSTER_NAME \\\u00a0 \u00a0 --machine-type=MACHINE_TYPE \\\u00a0 \u00a0 --enable-confidential-nodes\n```\nReplace the following:\n- : the name of your new node pool.\n- : the name of your cluster.\n- : the machine type for your node pool, which must be an [N2D machine type](/compute/docs/machine-types#n2d_machine_types) or the [C2D machine type](/compute/docs/compute-optimized-machines#c2d_machine_types) .\n### Update an existing node pool\nYou can enable Confidential GKE Nodes on existing node pools that use the [N2D machine type](/compute/docs/machine-types#n2d_machine_types) or the [C2D machine type](/compute/docs/compute-optimized-machines#c2d_machine_types) . Run the following command:\n```\ngcloud container node-pools update NODE_POOL_NAME \\\u00a0 \u00a0 --cluster=CLUSTER_NAME \\\u00a0 \u00a0 --enable-confidential-nodes\n```\nReplace the following:\n- : the name of your node pool.\n- : the name of your cluster.## Verify that Confidential GKE Nodes are enabled\n### On clusters\nYou can verify that your cluster is using Confidential GKE Nodes with the gcloud CLI or the Google Cloud console.\nDescribe the cluster:\n```\ngcloud container clusters describe CLUSTER_NAME\n```\nIf Confidential GKE Nodes is enabled, the output of the command includes the following lines:\n```\nconfidentialNodes:\n enabled: true\n```- Go to the **Google Kubernetes Engine** page in the Google Cloud console. [Go to Google Kubernetes Engine](https://console.cloud.google.com/kubernetes/list) \n- Click the name of the cluster you want to inspect.\n- Under **Security** , in the **Confidential GKE Nodes** field, verify that Confidential GKE Nodes is **Enabled** .\n### On node pools\nTo verify that your node pool is using Confidential GKE Nodes, run the following command:\n```\ngcloud container node-pools describe NODE_POOL_NAME \\\u00a0 \u00a0 --cluster=CLUSTER_NAME\n```\nIf Confidential GKE Nodes is enabled, the output is similar to the following:\n```\nconfidentialNodes:\n enabled: true\n```\n### On nodes\nTo validate the confidentiality of specific nodes, you can:\n- [Validate AMD SEV is enabled](/confidential-computing/confidential-vm/docs/creating-cvm-instance#verify-confidential) , or\n- [Validate Confidential VM using Cloud Monitoring](/confidential-computing/confidential-vm/docs/monitoring) .## Run applications on Confidential GKE Nodes\nGoogle's approach to Confidential Computing is to enable an effortless lift and shift for existing applications. GKE workloads that you run today can run on Confidential GKE Nodes without code changes.\nOptionally, if you want to declaratively express that your workloads must only run on clusters with Confidential GKE Nodes, you can use the `cloud.google.com/gke-confidential-nodes` [node selector](https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#nodeselector) . Here's an example Pod spec that uses this selector:\n```\napiVersion: v1\nkind: Pod\nspec:\n containers:\n - name: my-confidential-app\n image: us-docker.pkg.dev/myproject/myrepo/my-confidential-app\n nodeSelector:\n cloud.google.com/gke-confidential-nodes: \"true\"\n```\n## Set organization policy constraints\nYou can define an organization policy constraint to ensure that all VM resources created across your organization are Confidential VM instances. For GKE, you can customize the **Restrict Non-ConfidentialComputing** constraint to require that all new clusters are created with Confidential GKE Nodes enabled. Add the `container.googleapis.com` API Service name to the deny list when [enforcing organization policy constraints](/confidential-computing/confidential-vm/docs/org-policy-constraints) , for example:\n```\ngcloud resource-manager org-policies deny \\\u00a0 \u00a0 constraints/compute.restrictNonConfidentialComputing compute.googleapis.com container.googleapis.com \\\u00a0 \u00a0 --project=PROJECT_ID\n```\nReplace with your project ID.\n## Limitations\nConfidential GKE Nodes has the following limitations:\n- All the [limitations of Compute Engine Confidential VM instances](/confidential-computing/confidential-vm/docs/error-messages#known_issues_and_limitations) apply to Confidential GKE Nodes.\n- Confidential VM instances terminate when a [host maintenance event](/compute/docs/instances/host-maintenance-overview) occurs, causing the node to enter a`NotReady`state. Running Pods will experience disruptions until the node becomes ready again. If the maintenance takes more than five minutes, GKE might try to recreate the Pods on other nodes.\n- Confidential GKE Nodes that have the [C2D machine type](/compute/docs/compute-optimized-machines#c2d_machine_types) can only use [node auto-provisioning](/kubernetes-engine/docs/how-to/node-auto-provisioning) in GKE version 1.24 or later.\n- Confidential GKE Nodes only supports [PersistentVolumes](/kubernetes-engine/docs/concepts/persistent-volumes) backed by [persistent disks](/compute/docs/disks#pdspecs) if your control plane runs GKE version 1.22 or later. For instructions, refer to [Using the Compute Engine persistent disk CSI Driver ](/kubernetes-engine/docs/how-to/persistent-volumes/gce-pd-csi-driver) .\n- Confidential GKE Nodes is not compatible with GPUs.\n- Confidential GKE Nodes is not compatible with sole tenant nodes.\n- Confidential GKE Nodes only supports [using ephemeral storage on local SSDs](/kubernetes-engine/docs/how-to/persistent-volumes/local-ssd#creating_a_node_pool_using_ephemeral_storage_on_local_ssds) , but doesn't support using local SSDs in general.\n- Only Container-Optimized OS nodes are supported. Ubuntu and Windows nodes are not supported.\n- Autopilot clusters don't support Confidential GKE Nodes.## Disable Confidential GKE Nodes\nDisabling Confidential GKE Nodes only works for node pools that have enabled Confidential GKE Nodes. If the cluster is created with Confidential GKE Nodes, you cannot disable the feature. Run the following command to disable Confidential GKE Nodes on a node pool:\n```\ngcloud container node-pools update NODE_POOL_NAME \\\u00a0 \u00a0 --cluster=CLUSTER_NAME \\\u00a0 \u00a0 --no-enable-confidential-nodes\n```\n## What's next\n- [Learn more about Confidential VM](/confidential-computing/confidential-vm/docs/about-cvm) .\n- [Learn more about node images](/kubernetes-engine/docs/concepts/node-images) .\n- [Learn more about Google Cloud encryption at rest](/security/encryption/default-encryption) .\n- [Learn more about Google Cloud encryption in transit](/security/encryption-in-transit) .\n- [Learn more about customer-managed encryption keys (CMEK)](/kubernetes-engine/docs/how-to/using-cmek) .\n- [Learn more about application-layer secrets encryption](/kubernetes-engine/docs/how-to/encrypting-secrets) .", "guide": "Google Kubernetes Engine (GKE)"}