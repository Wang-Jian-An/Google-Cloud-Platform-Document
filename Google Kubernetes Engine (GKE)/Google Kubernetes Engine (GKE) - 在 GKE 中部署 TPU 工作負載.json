{"title": "Google Kubernetes Engine (GKE) - \u5728 GKE \u4e2d\u90e8\u7f72 TPU \u5de5\u4f5c\u8ca0\u8f09", "url": "https://cloud.google.com/kubernetes-engine/docs/how-to/tpus?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - \u5728 GKE \u4e2d\u90e8\u7f72 TPU \u5de5\u4f5c\u8ca0\u8f09\n\u672c\u9801\u9762\u4ecb\u7d39\u77ad\u5982\u4f55\u5728 Google Kubernetes Engine (GKE) \u4e2d\u8acb\u6c42\u548c\u90e8\u7f72\u4f7f\u7528 Cloud TPU \u52a0\u901f\u5668 (TPU) \u7684\u5de5\u4f5c\u8ca0\u8f09\u3002\n\u5728 GKE \u4e2d\u914d\u7f6e\u548c\u90e8\u7f72 TPU \u5de5\u4f5c\u8ca0\u8f09\u4e4b\u524d\uff0c\u60a8\u61c9\u8a72\u5148\u719f\u6089\u4ee5\u4e0b\u6982\u5ff5\uff1a\n- [Cloud TPU \u7c21\u4ecb](https://cloud.google.com/tpu/docs/intro-to-tpu?hl=zh-cn) \u3002\n- [Cloud TPU \u7cfb\u7d71\u67b6\u69cb](https://cloud.google.com/tpu/docs/system-architecture-tpu-vm?hl=zh-cn#versions) \u3002\n- [GKE \u4e2d\u7684 TPU \u7c21\u4ecb](https://cloud.google.com/kubernetes-engine/docs/concepts/tpus?hl=zh-cn) \u3002", "content": "## \u9808\u77e5\u4e8b\u9805\n\u5728\u958b\u59cb\u4e4b\u524d\uff0c\u8acb\u78ba\u4fdd\u60a8\u5df2\u57f7\u884c\u4ee5\u4e0b\u4efb\u52d9\uff1a\n- \u5553\u7528 Google Kubernetes Engine API\u3002\n- [  \u5553\u7528 Google Kubernetes Engine API ](https://console.cloud.google.com/flows/enableapi?apiid=container.googleapis.com&hl=zh-cn) \n- \u5982\u679c\u60a8\u8981\u4f7f\u7528 Google Cloud CLI \u57f7\u884c\u6b64\u4efb\u52d9\uff0c\u8acb [\u5b89\u88dd](https://cloud.google.com/sdk/docs/install?hl=zh-cn) \u4e26 [\u521d\u59cb\u5316](https://cloud.google.com/sdk/docs/initializing?hl=zh-cn) gcloud CLI\u3002 \u5982\u679c\u60a8\u4e4b\u524d\u5b89\u88dd\u4e86 gcloud CLI\uff0c\u8acb\u904b\u884c`gcloud components update`\u4ee5\u7372\u53d6\u6700\u65b0\u7248\u672c\u3002 **\u6ce8\u610f** \uff1a\u5c0d\u65bc\u73fe\u6709 gcloud CLI \u5b89\u88dd\uff0c\u8acb\u52d9\u5fc5\u8a2d\u7f6e`compute/region`\u548c`compute/zone` [\u5c6c\u6027](https://cloud.google.com/sdk/docs/properties?hl=zh-cn#setting_properties) \u3002\u901a\u904e\u8a2d\u7f6e\u9ed8\u8a8d\u4f4d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u907f\u514d gcloud CLI \u4e2d\u51fa\u73fe\u4ee5\u4e0b\u932f\u8aa4\uff1a`One of [--zone, --region] must be supplied: Please specify location`\u3002## GKE \u4e2d\u7684 TPU \u53ef\u7528\u6027\n\u4f7f\u7528 GKE \u5275\u5efa\u548c\u7ba1\u7406\u5177\u6709 TPU \u7684\u7bc0\u9ede\u6c60\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u9019\u4e9b\u5c08\u9580\u69cb\u5efa\u7684\u52a0\u901f\u5668\u4f86\u57f7\u884c\u5927\u898f\u6a21 AI \u6a21\u578b\u8a13\u7df4\u3001\u8abf\u512a\u548c\u63a8\u7406\u3002\n\u8acb\u53c3\u95b1 [GKE \u4e2d\u652f\u6301\u7684 TPU \u7248\u672c\u5217\u8868](https://cloud.google.com/kubernetes-engine/docs/concepts/tpus?hl=zh-cn#availability) \u3002\n## \u898f\u5283 TPU \u914d\u7f6e\n\u6839\u64da\u60a8\u7684\u6a5f\u5668\u5b78\u7fd2\u6a21\u578b\u53ca\u5176\u6240\u9700\u7684\u5167\u5b58\u91cf\u898f\u5283 TPU \u914d\u7f6e\u3002\u4ee5\u4e0b\u662f\u5728\u898f\u5283 TPU \u914d\u7f6e\u6642\u76f8\u95dc\u7684\u6b65\u9a5f\uff1a\n- [\u9078\u64c7 TPU \u7248\u672c\u548c\u62d3\u64b2](https://cloud.google.com/kubernetes-engine/docs/concepts/tpus?hl=zh-cn#topology) \u3002\n- [\u9078\u64c7\u8981\u4f7f\u7528\u7684\u7bc0\u9ede\u6c60\u985e\u578b](https://cloud.google.com/kubernetes-engine/docs/concepts/tpus?hl=zh-cn#node_pool) \u3002## \u78ba\u4fdd\u7232\u6309\u9700\u6216 Spot \u865b\u64ec\u6a5f\u63d0\u4f9b\u8db3\u5920\u7684\u914d\u984d\n\u5982\u679c\u60a8\u8981\u5275\u5efa\u5305\u542b\u6309\u9700\u6216 Spot \u865b\u64ec\u6a5f\u7684 TPU \u7bc0\u9ede\u6c60\uff0c\u5247\u5fc5\u9808\u5728\u8981\u4f7f\u7528\u7684\u5340\u57df\u4e2d\u5177\u6709\u8db3\u5920\u7684 TPU \u914d\u984d\u3002\n\u5275\u5efa\u4f7f\u7528 TPU \u9810\u7559\u7684 TPU \u7bc0\u9ede\u6c60 \u4e0d\u9700\u8981\u4efb\u4f55 TPU \u914d\u984d\u3002 \u5c0d\u65bc\u9810\u7559\u7684 TPU\uff0c\u60a8\u53ef\u4ee5\u653e\u5fc3\u5730\u8df3\u904e\u6b64\u90e8\u5206\u3002\n\u5728 GKE \u4e2d\u5275\u5efa\u6309\u9700\u6216 Spot TPU \u7bc0\u9ede\u6c60\u9700\u8981 Compute Engine API \u914d\u984d\u3002Compute Engine API \u914d\u984d (compute.googleapis.com) \u8207 Cloud TPU API \u914d\u984d (tpu.googleapis.com) \u4e0d\u540c\uff0c\u4f7f\u7528 Cloud TPU API \u5275\u5efa TPU \u6642\u9700\u8981\u5f8c\u8005\u3002\n\u5982\u9700\u67e5\u770b TPU \u7684 Compute Engine API \u914d\u984d\u7684\u9650\u5236\u548c\u7576\u524d\u7528\u91cf\uff0c\u8acb\u6309\u7167\u4ee5\u4e0b\u6b65\u9a5f\u64cd\u4f5c\uff1a\n- \u8f49\u5230 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **\u914d\u984d** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u914d\u984d\u201d](https://console.cloud.google.com/iam-admin/quotas?hl=zh-cn) \n- \u5728 filter_list **\u904e\u6ffe\u689d\u4ef6** \u6846\u4e2d\uff0c\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u9078\u64c7 **\u670d\u52d9** \u5c6c\u6027\uff0c\u8f38\u5165 **Compute Engine API** \uff0c\u7136\u5f8c\u6309 **Enter** \u9375\u3002\n- \u9078\u64c7 **\u985e\u578b** \u5c6c\u6027\uff0c\u7136\u5f8c\u9078\u64c7 **\u914d\u984d** \u3002\n- \u9078\u64c7 **\u540d\u7a31** \u5c6c\u6027\uff0c\u7136\u5f8c\u6839\u64da TPU \u7248\u672c\u548c\u6a5f\u5668\u985e\u578b\u8f38\u5165\u914d\u984d\u7684\u540d\u7a31\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u8a08\u5283\u5275\u5efa\u5176\u6a5f\u5668\u985e\u578b\u4ee5 `ct5lp-` \u958b\u982d\u7684\u6309\u9700 TPU v5e \u7bc0\u9ede\uff0c\u8acb\u8f38\u5165 `TPU v5 Lite PodSlice chips` \u3002| TPU \u7248\u672c | \u6a5f\u5668\u985e\u578b\u958b\u982d\u7232 | \u6309\u9700\u5be6\u4f8b\u7684\u914d\u984d\u540d\u7a31   | Spot2 \u5be6\u4f8b\u7684\u914d\u984d\u540d\u7a31     |\n|:-----------|:-----------------|:---------------------------|:---------------------------------------|\n| TPU v4  | ct4p-   | TPU v4 PodSlice chips  | Preemptible TPU v4 PodSlice chips  |\n| TPU v5e | ct5l-   | TPU v5 Lite Device chips | Preemptible TPU v5 Lite Device chips |\n| TPU v5e | ct5lp-   | TPU v5 Lite PodSlice chips | Preemptible TPU v5 Lite PodSlice chips |\n| TPU v5p | ct5p-   | TPU v5p chips    | Preemptible TPU v5p chips    |\n- \u9078\u64c7 **\u7dad\u5ea6\uff08\u4f8b\u5982\u4f4d\u7f6e\uff09** \u5c6c\u6027\uff0c\u7136\u5f8c\u8f38\u5165 `region:` \uff0c\u5f8c\u8ddf\u60a8\u8a08\u5283\u5728 GKE \u4e2d\u5275\u5efa TPU \u7684\u5340\u57df\u7684\u540d\u7a31\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u8a08\u5283\u5728\u53ef\u7528\u5340 `us-west4-a` \u4e2d\u5275\u5efa TPU \u7bc0\u9ede\uff0c\u8acb\u8f38\u5165 `region:us-west4` \u3002TPU \u914d\u984d\u662f\u5340\u57df\u6027\u7684\uff0c\u56e0\u6b64\u540c\u4e00\u5340\u57df\u5167\u7684\u6240\u6709\u53ef\u7528\u5340\u90fd\u4f7f\u7528\u540c\u4e00 TPU \u914d\u984d\u3002\u5982\u679c\u6c92\u6709\u914d\u984d\u8207\u60a8\u8f38\u5165\u7684\u904e\u6ffe\u689d\u4ef6\u5339\u914d\uff0c\u5247\u8aaa\u660e\u9805\u76ee\u5c1a\u672a\u7372\u5f97\u6240\u9700\u5340\u57df\u7684\u4efb\u4f55\u6307\u5b9a\u914d\u984d\uff0c\u60a8\u5fc5\u9808 [\u7533\u8acb\u589e\u52a0 TPU \u914d\u984d](https://cloud.google.com/docs/quota/view-manage?hl=zh-cn#requesting_higher_quota) \u3002\n**\u6ce8\u610f\uff1a** \u5275\u5efa TPU \u9810\u7559\u5f8c\uff0c\u76f8\u61c9\u914d\u984d\u7684\u9650\u5236\u503c\u548c\u7576\u524d\u4f7f\u7528\u503c\u90fd\u6703\u589e\u52a0 TPU \u9810\u7559\u4e2d\u7684\u82af\u7247\u6578\u91cf\u3002\u4f8b\u5982\uff0c\u7232\u6a5f\u5668\u985e\u578b\u4ee5 `ct5lp-` \u958b\u982d\u7684 16 \u500b TPU v5e \u82af\u7247\u5275\u5efa\u9810\u7559\u5f8c\uff0c\u76f8\u95dc\u5340\u57df\u4e2d `TPU v5 Lite PodSlice chips` \u914d\u984d\u7684 **\u9650\u5236** \u548c **\u7576\u524d\u7528\u91cf** \u6703\u589e\u52a0 16\u3002\n- \u5275\u5efa TPU \u7bc0\u9ede\u6c60\u6642\uff0c\u8acb\u4f7f\u7528 [--reservation \u548c --reservation-affinity=specific \u6a19\u8a8c](https://cloud.google.com/sdk/gcloud/reference/container/node-pools/create?hl=zh-cn#--reservation) \u5275\u5efa\u9810\u7559\u5be6\u4f8b\u3002\u8cfc\u8cb7\u627f\u8afe\u6642\uff0cTPU \u9810\u7559\u53ef\u4f9b\u4f7f\u7528\u3002 [\u21a9](#fnref1) \n- \u5275\u5efa TPU \u7bc0\u9ede\u6c60\u6642\uff0c\u8acb\u4f7f\u7528 [--spot \u6a19\u8a8c](https://cloud.google.com/sdk/gcloud/reference/container/node-pools/create?hl=zh-cn#--spot) \u4f86\u5275\u5efa [Spot](https://cloud.google.com/spot-vms?hl=zh-cn) \u5be6\u4f8b\u3002 [\u21a9](#fnref2) ## \u78ba\u4fdd\u9810\u7559\u53ef\u7528\u6027\n\u5275\u5efa\u9810\u7559 TPU \u7bc0\u9ede\u6c60\u610f\u5473\u7740\u4f7f\u7528\u9810\u7559\u7684 TPU \u7bc0\u9ede\u6c60\u4e0d\u9700\u8981\u4efb\u4f55 TPU \u914d\u984d\u3002\u4f46\u662f\uff0c\u5728\u5275\u5efa\u7bc0\u9ede\u6c60\u6642\uff0c\u9810\u7559\u5fc5\u9808\u5177\u6709\u8db3\u5920\u7684\u53ef\u7528\u6216\u672a\u4f7f\u7528\u7684\u82af\u7247\u3002\n\u5982\u9700\u67e5\u770b\u9805\u76ee\u4e2d\u5b58\u5728\u54ea\u4e9b\u9810\u7559\uff0c\u8acb [\u67e5\u770b\u9810\u7559\u5217\u8868](https://cloud.google.com/compute/docs/instances/reservations-view?hl=zh-cn#list-reservations) \u3002\n\u5982\u9700\u67e5\u770b TPU \u9810\u7559\u4e2d\u53ef\u7528\u7684\u82af\u7247\u6578\uff0c\u8acb [\u67e5\u770b\u9810\u7559\u7684\u8a73\u7d30\u4fe1\u606f](https://cloud.google.com/compute/docs/instances/reservations-view?hl=zh-cn#describe-reservations) \u3002\n## \u5275\u5efa\u96c6\u7fa3\n\u5728\u5177\u6709\u53ef\u7528 TPU \u7684\u5340\u57df\u4e2d\u5275\u5efa Standard \u6a21\u5f0f\u7684 GKE \u96c6\u7fa3\u3002\u6211\u5011\u5efa\u8b70\u60a8\u4f7f\u7528\u5340\u57df\u7d1a\u96c6\u7fa3\uff0c\u53ef\u63d0\u4f9b Kubernetes \u63a7\u5236\u5e73\u9762\u7684\u9ad8\u53ef\u7528\u6027\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528 Google Cloud CLI \u6216 Google Cloud \u63a7\u5236\u6aaf\u3002\n```\ngcloud container clusters create CLUSTER_NAME \\\u00a0 --location LOCATION \\\u00a0 --cluster-version VERSION\n```\n\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a\n- ``\uff1a\u65b0\u96c6\u7fa3\u7684\u540d\u7a31\u3002\n- ``\uff1a\u5177\u6709\u53ef\u7528 TPU \u5bb9\u91cf\u7684\u5340\u57df\u3002\n- ``\uff1aGKE \u7248\u672c\uff0c\u5fc5\u9808\u652f\u6301\u60a8\u8981\u4f7f\u7528\u7684\u6a5f\u5668\u985e\u578b\u3002\u8acb\u6ce8\u610f\uff0c\u9ed8\u8a8d\u7684 GKE \u7248\u672c\u53ef\u80fd\u4e0d\u9069\u7528\u65bc\u76ee\u6a19 TPU\u3002 \u5982\u9700\u77ad\u89e3 TPU \u6a5f\u5668\u985e\u578b\u53ef\u7528\u7684\u6700\u4f4e GKE \u7248\u672c\uff0c\u8acb\u53c3\u95b1 [GKE \u4e2d\u7684 TPU \u53ef\u7528\u6027](https://cloud.google.com/kubernetes-engine/docs/concepts/tpus?hl=zh-cn#availability) ## \u5275\u5efa\u7bc0\u9ede\u6c60\n### \u55ae\u4e3b\u6a5f TPU \u5207\u7247\n\u60a8\u53ef\u4ee5\u4f7f\u7528 Google Cloud CLI\u3001Terraform \u6216 Google Cloud \u63a7\u5236\u6aaf\u5275\u5efa [\u55ae\u4e3b\u6a5f TPU \u5207\u7247\u7bc0\u9ede\u6c60](https://cloud.google.com/kubernetes-engine/docs/concepts/tpus?hl=zh-cn#node_pool) \u3002\n```\ngcloud container node-pools create POOL_NAME \\\u00a0 \u00a0 --location=LOCATION \\\u00a0 \u00a0 --cluster=CLUSTER_NAME \\\u00a0 \u00a0 --node-locations=NODE_ZONES \\\u00a0 \u00a0 --machine-type=MACHINE_TYPE \\\u00a0 \u00a0 [--num-nodes=NUM_NODES \\]\u00a0 \u00a0 [--spot \\]\u00a0 \u00a0 [--enable-autoscaling \\]\u00a0 \u00a0 [--reservation-affinity=specific \\\u00a0 \u00a0 --reservation=RESERVATION_NAME \\]\u00a0 \u00a0 [--total-min-nodes TOTAL_MIN_NODES \\]\u00a0 \u00a0 [--total-max-nodes TOTAL_MAX_NODES \\]\u00a0 \u00a0 [--location-policy=ANY]\n```\n\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u65b0\u7bc0\u9ede\u6c60\u7684\u540d\u7a31\u3002\n- `` \uff1a\u57fa\u65bc\u60a8\u8981\u4f7f\u7528\u7684 TPU \u7248\u672c\u7684\u53ef\u7528\u5340\u540d\u7a31\uff1a- \u5c0d\u65bc TPU v4\uff0c\u8acb\u4f7f\u7528`us-central2-b`\u3002\n- \u5c0d\u65bc\u4ee5`ct5l-`\u958b\u982d\u7684 TPU v5e \u6a5f\u5668\u985e\u578b\uff0c\u8acb\u4f7f\u7528`us-central1-a`\u6216`europe-west4-b`\u3002\n- \u5c0d\u65bc\u4ee5`ct5lp-`\u958b\u982d\u7684 TPU v5e \u6a5f\u5668\u985e\u578b\uff0c\u8acb\u4f7f\u7528`us-west1-c`\u3001`us-west4-a`\u3001`us-west4-b`\u3001`us-central1-a`\u3001`us-east1-c`\u3001`us-east5-b`\u6216`europe-west4-a`\u3002\n- \u5c0d\u65bc TPU v5p\uff0c\u8acb\u4f7f\u7528`us-east1-d`\u3001`us-east5-a`\u6216`us-east5-c`\u3002\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u9078\u64c7 TPU \u7248\u672c\u548c\u62d3\u64b2](https://cloud.google.com/kubernetes-engine/docs/how-to/tpus?hl=zh-cn#version_and_topology) \u3002\n- `` \uff1a\u96c6\u7fa3\u7684\u540d\u7a31\u3002\n- `` \uff1aGKE \u5728\u5176\u4e2d\u5275\u5efa\u7bc0\u9ede\u6c60\u7684\u4e00\u500b\u6216\u591a\u500b\u53ef\u7528\u5340\u7684\u82f1\u6587\u9017\u865f\u5206\u9694\u5217\u8868\u3002\n- `` \uff1a\u7528\u65bc\u7bc0\u9ede\u7684\u6a5f\u5668\u985e\u578b\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u8207 TPU \u517c\u5bb9\u7684\u6a5f\u5668\u985e\u578b\uff0c\u8acb\u4f7f\u7528 [TPU \u914d\u7f6e\u6620\u5c04](https://cloud.google.com/kubernetes-engine/docs/concepts/tpus?hl=zh-cn#configuration) \u4e2d\u7684\u8868\u3002\n\uff08\u53ef\u9078\uff09\u60a8\u9084\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u6a19\u8a8c\uff1a- ``\uff1a\u6bcf\u500b\u53ef\u7528\u5340\u7684\u7bc0\u9ede\u6c60\u4e2d\u7684\u521d\u59cb\u7bc0\u9ede\u6578\u3002\u5982\u679c\u7701\u7565\u6b64\u6a19\u8a8c\uff0c\u5247\u9ed8\u8a8d\u503c\u7232`3`\u3002\u5982\u679c\u4f7f\u7528`--enable-autoscaling`\u6a19\u8a8c\u7232\u7bc0\u9ede\u6c60\u5553\u7528\u4e86\u81ea\u52d5\u64f4\u7e2e\u529f\u80fd\uff0c\u6211\u5011\u5efa\u8b70\u60a8\u5c07``\u8a2d\u7f6e\u7232`0`\uff0c\u56e0\u7232\u81ea\u52d5\u64f4\u7e2e\u5668\u5728\u5de5\u4f5c\u8ca0\u8f09\u9700\u8981\u6642\u6703\u9810\u914d\u66f4\u591a\u7bc0\u9ede\u3002\n- ``\uff1aGKE \u5728\u5275\u5efa\u7bc0\u9ede\u6c60\u6642\u4f7f\u7528\u7684\u9810\u7559\u7684\u540d\u7a31\u3002\u5982\u679c\u60a8\u7701\u7565\u6b64\u6a19\u8a8c\uff0c\u5247 GKE \u6703\u4f7f\u7528\u53ef\u7528\u7684 TPU\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3 TPU \u9810\u7559\uff0c\u8acb\u53c3\u95b1 [TPU \u9810\u7559](https://cloud.google.com/kubernetes-engine/docs/concepts/tpus?hl=zh-cn#tpu_reservation) \u3002\n- `--enable-autoscaling`\uff1a\u5275\u5efa\u5553\u7528\u4e86\u81ea\u52d5\u64f4\u7e2e\u529f\u80fd\u7684\u7bc0\u9ede\u6c60\u3002- ``\uff1a\u7bc0\u9ede\u6c60\u4e2d\u7684\u6240\u6709\u7bc0\u9ede\u6578\u4e0b\u9650\u3002\u9664\u975e\u540c\u6642\u6307\u5b9a\u4e86\u81ea\u52d5\u64f4\u7e2e\uff0c\u5426\u5247\u8acb\u5ffd\u7565\u6b64\u5b57\u6bb5\u3002\n- ``\uff1a\u7bc0\u9ede\u6c60\u4e2d\u7684\u6240\u6709\u7bc0\u9ede\u6578\u4e0a\u9650\u3002\u9664\u975e\u540c\u6642\u6307\u5b9a\u4e86\u81ea\u52d5\u64f4\u7e2e\uff0c\u5426\u5247\u8acb\u5ffd\u7565\u6b64\u5b57\u6bb5\u3002\n- `--spot`\uff1a\u8a2d\u7f6e\u7bc0\u9ede\u6c60\u4ee5\u5c0d\u7bc0\u9ede\u6c60\u4e2d\u7684\u7bc0\u9ede\u4f7f\u7528 [Spot \u865b\u64ec\u6a5f](https://cloud.google.com/kubernetes-engine/docs/concepts/spot-vms?hl=zh-cn) \u3002\u5275\u5efa\u7bc0\u9ede\u6c60\u5f8c\uff0c\u60a8\u5c07\u7121\u6cd5\u66f4\u6539\u6b64\u8a2d\u7f6e\u3002\n- \u78ba\u4fdd\u60a8\u4f7f\u7528 [google](https://registry.terraform.io/providers/hashicorp/google/latest) \u63d0\u4f9b\u7a0b\u5e8f 4.84.0 \u7248\u6216\u66f4\u9ad8\u7248\u672c\u3002\n- \u5c07\u4ee5\u4e0b\u584a\u6dfb\u52a0\u5230 Terraform \u914d\u7f6e\u4e2d\uff1a\n```\nresource \"google_container_node_pool\" \"NODE_POOL_RESOURCE_NAME\" {\u00a0 provider \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 = google\u00a0 project \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0= PROJECT_ID\u00a0 cluster \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0= CLUSTER_NAME\u00a0 name \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 = POOL_NAME\u00a0 location \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 = CLUSTER_LOCATION\u00a0 node_locations \u00a0 \u00a0 = [NODE_ZONES]\u00a0 initial_node_count = NUM_NODES\u00a0 autoscaling {\u00a0 \u00a0 total_min_node_count = TOTAL_MIN_NODES\u00a0 \u00a0 total_max_node_count = TOTAL_MAX_NODES\u00a0 \u00a0 location_policy \u00a0 \u00a0 \u00a0= \"ANY\"\u00a0 }\u00a0 node_config {\u00a0 \u00a0 machine_type = MACHINE_TYPE\u00a0 \u00a0 reservation_affinity {\u00a0 \u00a0 \u00a0 consume_reservation_type = \"SPECIFIC_RESERVATION\"\u00a0 \u00a0 \u00a0 key = \"compute.googleapis.com/reservation-name\"\u00a0 \u00a0 \u00a0 values = [RESERVATION_LABEL_VALUES]\u00a0 \u00a0 }\u00a0 \u00a0 spot = true\u00a0 }}\n```\n\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1aTerraform \u6a21\u677f\u4e2d\u7684\u7bc0\u9ede\u6c60\u8cc7\u6e90\u7684\u540d\u7a31\u3002\n- ``\uff1a\u60a8\u7684\u9805\u76ee ID\u3002\n- ``\uff1a\u73fe\u6709\u96c6\u7fa3\u7684\u540d\u7a31\u3002\n- ``\uff1a\u8981\u5275\u5efa\u7684\u7bc0\u9ede\u6c60\u7684\u540d\u7a31\u3002\n- ``\uff1a\u96c6\u7fa3\u7684\u8a08\u7b97\u53ef\u7528\u5340\u3002\u6307\u5b9a TPU \u7248\u672c\u53ef\u7528\u7684\u5340\u57df\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u9078\u64c7 TPU \u7248\u672c\u548c\u62d3\u64b2](https://cloud.google.com/kubernetes-engine/docs/how-to/tpus?hl=zh-cn#version_and_topology) \u3002\n- ``\uff1aGKE \u5728\u5176\u4e2d\u5275\u5efa\u7bc0\u9ede\u6c60\u7684\u4e00\u500b\u6216\u591a\u500b\u53ef\u7528\u5340\u7684\u82f1\u6587\u9017\u865f\u5206\u9694\u5217\u8868\u3002\n- ``\uff1a\u6bcf\u500b\u7bc0\u9ede\u6c60\u53ef\u7528\u5340\u7684\u7bc0\u9ede\u6c60\u4e2d\u7684\u521d\u59cb\u7bc0\u9ede\u6578\u3002\u5982\u679c\u7701\u7565\uff0c\u5247\u9ed8\u8a8d\u503c\u7232`3`\u3002\u5982\u679c\u4f7f\u7528\u81ea\u52d5\u64f4\u7e2e\u6a21\u677f\u7232\u7bc0\u9ede\u6c60\u5553\u7528\u4e86\u81ea\u52d5\u64f4\u7e2e\u529f\u80fd\uff0c\u6211\u5011\u5efa\u8b70\u60a8\u5c07``\u8a2d\u7f6e\u7232`0`\uff0c\u56e0\u7232 GKE \u5728\u5de5\u4f5c\u8ca0\u8f09\u9700\u8981\u6642\u6703\u9810\u914d\u66f4\u591a TPU \u7bc0\u9ede\u3002\n- ``\uff1a\u8981\u4f7f\u7528\u7684 TPU \u6a5f\u5668\u985e\u578b\u3002\u5982\u9700\u67e5\u770b\u8207 TPU \u517c\u5bb9\u7684\u6a5f\u5668\u985e\u578b\uff0c\u8acb\u4f7f\u7528 [TPU \u914d\u7f6e\u6620\u5c04](https://cloud.google.com/kubernetes-engine/docs/concepts/tpus?hl=zh-cn#configuration) \u4e2d\u7684\u8868\u3002\n\uff08\u53ef\u9078\uff09\u60a8\u9084\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u8b8a\u91cf\uff1a- `autoscaling`\uff1a\u5275\u5efa\u5553\u7528\u4e86\u81ea\u52d5\u64f4\u7e2e\u529f\u80fd\u7684\u7bc0\u9ede\u6c60\u3002\u5c0d\u65bc\u55ae\u4e3b\u6a5f TPU \u5207\u7247\uff0cGKE \u6703\u5728`TOTAL_MIN_NODES`\u548c`TOTAL_MAX_NODES`\u503c\u4e4b\u9593\u9032\u884c\u64f4\u7e2e\u3002- ``\uff1a\u7bc0\u9ede\u6c60\u4e2d\u7684\u6240\u6709\u7bc0\u9ede\u6578\u4e0b\u9650\u3002\u9664\u975e\u540c\u6642\u6307\u5b9a\u4e86\u81ea\u52d5\u64f4\u7e2e\uff0c\u5426\u5247\u6b64\u5b57\u6bb5\u662f\u53ef\u9078\u5b57\u6bb5\u3002\n- ``\uff1a\u7bc0\u9ede\u6c60\u4e2d\u7684\u6240\u6709\u7bc0\u9ede\u6578\u4e0a\u9650\u3002\u9664\u975e\u540c\u6642\u6307\u5b9a\u4e86\u81ea\u52d5\u64f4\u7e2e\uff0c\u5426\u5247\u6b64\u5b57\u6bb5\u662f\u53ef\u9078\u5b57\u6bb5\u3002\n- ``\uff1a\u5982\u679c\u60a8\u4f7f\u7528 [TPU \u9810\u7559](https://cloud.google.com/kubernetes-engine/docs/concepts/tpus?hl=zh-cn#tpu_reservation) \uff0c\u5247\u9019\u662f\u5275\u5efa\u7bc0\u9ede\u6c60\u6642\u4f7f\u7528\u7684\u9810\u7559\u8cc7\u6e90\u7684\u6a19\u7c64\u5217\u8868\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u586b\u5145`reservation_affinity`\u5b57\u6bb5\u4e2d\u7684``\uff0c\u8acb\u53c3\u95b1 [Terraform \u63d0\u4f9b\u7a0b\u5e8f](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/container_cluster#reservation_affinity) \u3002\n- `spot`\uff1a\u8a2d\u7f6e\u7bc0\u9ede\u6c60\u4ee5\u5c0d TPU \u7bc0\u9ede\u4f7f\u7528 Spot \u865b\u64ec\u6a5f\u3002\u5275\u5efa\u7bc0\u9ede\u6c60\u5f8c\uff0c\u60a8\u5c07\u7121\u6cd5\u66f4\u6539\u6b64\u8a2d\u7f6e\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [Spot \u865b\u64ec\u6a5f](https://cloud.google.com/kubernetes-engine/docs/concepts/spot-vms?hl=zh-cn) \u3002\n\u5982\u9700\u5275\u5efa\u5177\u6709 TPU \u7684\u7bc0\u9ede\u6c60\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u8f49\u5230 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **Google Kubernetes Engine** \u9801\u9762\u3002 [\u524d\u5f80 Google Kubernetes Engine](https://console.cloud.google.com/kubernetes/list?hl=zh-cn) \n- \u5728\u96c6\u7fa3\u5217\u8868\u4e2d\uff0c\u9ede\u64ca\u60a8\u8981\u4fee\u6539\u7684\u96c6\u7fa3\u7684\u540d\u7a31\u3002\n- \u9ede\u64ca **\u6dfb\u52a0\u7bc0\u9ede\u6c60** \u3002\n- \u5728 **\u7bc0\u9ede\u6c60\u8a73\u60c5** \u90e8\u5206\u4e2d\uff0c\u52fe\u9078 **\u6307\u5b9a\u7bc0\u9ede\u4f4d\u7f6e** \u8907\u9078\u6846\u3002\n- \u6839\u64da\u60a8\u8981\u4f7f\u7528\u7684 TPU \u7248\u672c\u9078\u64c7\u53ef\u7528\u5340\uff1a- \u5c0d\u65bc TPU v4\uff0c\u8acb\u4f7f\u7528`us-central2-b`\u3002\n- \u5c0d\u65bc\u4ee5`ct5l-`\u958b\u982d\u7684 TPU v5e \u6a5f\u5668\u985e\u578b\uff0c\u8acb\u4f7f\u7528`us-central1-a`\u6216`europe-west4-b`\u3002\n- \u5c0d\u65bc\u4ee5`ct5lp-`\u958b\u982d\u7684 TPU v5e \u6a5f\u5668\u985e\u578b\uff0c\u8acb\u4f7f\u7528`us-west1-c`\u3001`us-west4-a`\u3001`us-west4-b`\u3001`us-central1-a`\u3001`us-east1-c`\u3001`us-east5-b`\u6216`europe-west4-a`\u3002\n- \u5c0d\u65bc TPU v5p\uff0c\u8acb\u4f7f\u7528`us-east1-d`\u3001`us-east5-a`\u6216`us-east5-c`\u3002\n- \u5728\u5c0e\u822a\u7a97\u683c\u4e2d\uff0c\u9ede\u64ca **\u7bc0\u9ede** \u3002\n- \u5728 **\u6a5f\u5668\u914d\u7f6e** \u90e8\u5206\u4e2d\uff0c\u9078\u64c7 **TPU** \u3002\n- \u5728 **\u7cfb\u5217** \u4e0b\u62c9\u83dc\u55ae\u4e2d\uff0c\u9078\u64c7\u4ee5\u4e0b\u9078\u9805\u4e4b\u4e00\uff1a- **CT4P** \uff1aTPU v4\n- **CT5LP** \uff1aTPU v5e\n- **CT5P** \uff1aTPU v5p\n- \u5728 **\u6a5f\u5668\u985e\u578b** \u4e0b\u62c9\u83dc\u55ae\u4e2d\uff0c\u9078\u64c7\u8981\u7528\u65bc\u7bc0\u9ede\u7684\u6a5f\u5668\u7684\u540d\u7a31\u3002\u4f7f\u7528 [TPU \u914d\u7f6e\u6620\u5c04](https://cloud.google.com/kubernetes-engine/docs/concepts/tpus?hl=zh-cn#configuration) \u8868\u53ef\u77ad\u89e3\u5982\u4f55\u5b9a\u7fa9\u7528\u65bc\u5275\u5efa\u55ae\u4e3b\u6a5f TPU \u7bc0\u9ede\u6c60\u7684\u6a5f\u5668\u985e\u578b\u548c TPU \u62d3\u64b2\u3002\n- \u5728 **TPU \u62d3\u64b2** \u4e0b\u62c9\u83dc\u55ae\u4e2d\uff0c\u9078\u64c7 TPU \u5207\u7247\u7684\u7269\u7406\u62d3\u64b2\u3002\n- \u5728 **\u9700\u8981\u66f4\u6539** \u5c0d\u8a71\u6846\u4e2d\uff0c\u9ede\u64ca **\u9032\u884c\u66f4\u6539** \u3002\n- \u78ba\u4fdd **\u5553\u52d5\u78c1\u76e4\u985e\u578b** \u7232 **\u6a19\u6e96\u6c38\u4e45\u6027\u78c1\u76e4** \u6216 **SSD \u6c38\u4e45\u6027\u78c1\u76e4** \u3002\n- \uff08\u53ef\u9078\uff09\u9078\u4e2d **\u5728 Spot \u865b\u64ec\u6a5f\u4e0a\u5553\u7528\u7bc0\u9ede** \u8907\u9078\u6846\uff0c\u4ee5\u5c0d\u7bc0\u9ede\u6c60\u4e2d\u7684\u7bc0\u9ede\u4f7f\u7528 Spot \u865b\u64ec\u6a5f\u3002\n- \u9ede\u64ca **\u5275\u5efa** \u3002\n### \u591a\u4e3b\u6a5f TPU \u5207\u7247\n\u60a8\u53ef\u4ee5\u4f7f\u7528 Google Cloud CLI\u3001Terraform \u6216 Google Cloud \u63a7\u5236\u6aaf\u5275\u5efa [\u591a\u4e3b\u6a5f TPU \u5207\u7247](https://cloud.google.com/kubernetes-engine/docs/concepts/tpus?hl=zh-cn#node_pool) \u7bc0\u9ede\u6c60\u3002\n```\ngcloud container node-pools create POOL_NAME \\\u00a0 \u00a0 --location=LOCATION \\\u00a0 \u00a0 --cluster=CLUSTER_NAME \\\u00a0 \u00a0 --node-locations=NODE_ZONE \\\u00a0 \u00a0 --machine-type=MACHINE_TYPE \\\u00a0 \u00a0 --tpu-topology=TPU_TOPOLOGY \\\u00a0 \u00a0 --num-nodes=NUM_NODES \\\u00a0 \u00a0 [--spot \\]\u00a0 \u00a0 [--enable-autoscaling \\\u00a0 \u00a0 \u00a0 --max-nodes MAX_NODES]\u00a0 \u00a0 [--reservation-affinity=specific \\\u00a0 \u00a0 --reservation=RESERVATION_NAME]\n```\n\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u65b0\u7bc0\u9ede\u6c60\u7684\u540d\u7a31\u3002\n- ``\uff1a\u57fa\u65bc\u60a8\u8981\u4f7f\u7528\u7684 TPU \u7248\u672c\u7684\u53ef\u7528\u5340\u540d\u7a31\uff1a- \u5c0d\u65bc TPU v4\uff0c\u8acb\u4f7f\u7528`us-central2-b`\u3002\n- \u4ee5`ct5l-`\u958b\u982d\u7684 TPU v5e \u6a5f\u5668\u985e\u578b\u7d55\u4e0d\u6703\u662f\u591a\u4e3b\u6a5f\u3002\n- \u5c0d\u65bc\u4ee5`ct5lp-`\u958b\u982d\u7684 TPU v5e \u6a5f\u5668\u985e\u578b\uff0c\u8acb\u4f7f\u7528`us-west1-c`\u3001`us-west4-a`\u3001`us-west4-b`\u3001`us-central1-a`\u3001`us-east1-c`\u3001`us-east5-b`\u6216`europe-west4-a`\u3002\n- \u5c0d\u65bc\u4ee5`ct5p-`\u958b\u982d\u7684 TPU v5p \u6a5f\u5668\u985e\u578b\uff0c\u8acb\u4f7f\u7528`us-east1-d`\u3001`us-east5-a`\u6216`us-east5-c`\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u9078\u64c7 TPU \u7248\u672c\u548c\u62d3\u64b2](https://cloud.google.com/kubernetes-engine/docs/how-to/tpus?hl=zh-cn#version_and_topology) \u3002\n- ``\uff1a\u96c6\u7fa3\u7684\u540d\u7a31\u3002\n- ``\uff1aGKE \u5728\u5176\u4e2d\u5275\u5efa\u7bc0\u9ede\u6c60\u7684\u4e00\u500b\u6216\u591a\u500b\u53ef\u7528\u5340\u7684\u82f1\u6587\u9017\u865f\u5206\u9694\u5217\u8868\u3002\n- ``\uff1a\u7528\u65bc\u7bc0\u9ede\u7684\u6a5f\u5668\u985e\u578b\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u53ef\u7528\u6a5f\u5668\u985e\u578b\uff0c\u8acb\u53c3\u95b1 [TPU \u914d\u7f6e\u6620\u5c04](https://cloud.google.com/kubernetes-engine/docs/concepts/tpus?hl=zh-cn#configuration) \u3002\n- ``\uff1aTPU \u5207\u7247\u7684\u7269\u7406\u62d3\u64b2\u3002\u62d3\u64b2\u683c\u5f0f\u53d6\u6c7a\u65bc TPU \u7248\u672c\uff0c\u5982\u4e0b\u6240\u793a\uff1a- TPU v4\uff1a\u4f7f\u7528 3 \u5143\u7d44 (`{A}x{B}x{C}`) \u5b9a\u7fa9\u62d3\u64b2\uff0c\u4f8b\u5982`4x4x4`\u3002\n- TPU v5e\uff1a\u4f7f\u7528 2 \u5143\u7d44 (`{A}x{B}`) \u5b9a\u7fa9\u62d3\u64b2\uff0c\u4f8b\u5982`2x2`\u3002\n- ``\uff1a\u7bc0\u9ede\u6c60\u4e2d\u7684\u7bc0\u9ede\u6578\u3002\u8a72\u503c\u5fc5\u9808\u7232\u96f6\u6216``(`{A}x{B}x{C}`) \u4e2d\u5b9a\u7fa9\u7684\u503c\u7684\u4e58\u7a4d\u9664\u4ee5\u6bcf\u500b\u865b\u64ec\u6a5f\u4e2d\u7684\u82af\u7247\u6578\u91cf\u3002\u5c0d\u65bc\u591a\u4e3b\u6a5f TPU v4 \u548c TPU v5e\uff0c\u6bcf\u500b\u865b\u64ec\u6a5f\u4e2d\u7684\u82af\u7247\u6578\u91cf\u7232 4\u3002\u56e0\u6b64\uff0c\u5982\u679c``\u7232`2x4x4`\uff08\u6bcf\u500b\u865b\u64ec\u6a5f\u4e2d\u6709\u56db\u500b\u82af\u7247\u7684 TPU v4\uff09\uff0c\u5247``\u7232 32/4\uff0c\u7b49\u65bc 8\u3002\n\uff08\u53ef\u9078\uff09\u60a8\u9084\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u6a19\u8a8c\uff1a- ``\uff1aGKE \u5728\u5275\u5efa\u7bc0\u9ede\u6c60\u6642\u4f7f\u7528\u7684\u9810\u7559\u7684\u540d\u7a31\u3002\u5982\u679c\u60a8\u7701\u7565\u6b64\u6a19\u8a8c\uff0c\u5247 GKE \u6703\u4f7f\u7528\u53ef\u7528\u7684 TPU \u7bc0\u9ede\u6c60\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3 TPU \u9810\u7559\uff0c\u8acb\u53c3\u95b1 [TPU \u9810\u7559](https://cloud.google.com/kubernetes-engine/docs/concepts/tpus?hl=zh-cn#tpu_reservation) \u3002\n- `--spot`\uff1a\u8a2d\u7f6e\u7bc0\u9ede\u6c60\u4ee5\u5c0d TPU \u7bc0\u9ede\u4f7f\u7528 Spot \u865b\u64ec\u6a5f\u3002\u5275\u5efa\u7bc0\u9ede\u6c60\u5f8c\uff0c\u60a8\u5c07\u7121\u6cd5\u66f4\u6539\u6b64\u8a2d\u7f6e\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [Spot \u865b\u64ec\u6a5f](https://cloud.google.com/kubernetes-engine/docs/concepts/spot-vms?hl=zh-cn) \u3002\n- `--enable-autoscaling`\uff1a\u5275\u5efa\u5553\u7528\u4e86\u81ea\u52d5\u64f4\u7e2e\u529f\u80fd\u7684\u7bc0\u9ede\u6c60\u3002\u7576 GKE \u64f4\u7e2e\u591a\u4e3b\u6a5f TPU \u5207\u7247\u7bc0\u9ede\u6c60\u6642\uff0c\u5b83\u6703 [\u4ee5\u539f\u5b50\u65b9\u5f0f](https://cloud.google.com/kubernetes-engine/docs/concepts/tpus?hl=zh-cn#terminology) \u5c07\u7bc0\u9ede\u6c60\u5f9e\u96f6\u64f4\u5bb9\u5230\u5927\u5c0f\u4e0a\u9650\u3002- ``\uff1a\u7bc0\u9ede\u6c60\u7684\u5927\u5c0f\u4e0a\u9650\u3002\u5982\u679c\u63d0\u4f9b\u4e86`--enable-autoscaling`\uff0c\u5247\u5fc5\u9808\u4f7f\u7528`--max-nodes`\u6a19\u8a8c\uff0c\u4e14\u8a72\u6a19\u8a8c\u5fc5\u9808\u7b49\u65bc``(`{A}x{B}x{C}`) \u4e2d\u5b9a\u7fa9\u7684\u503c\u7684\u4e58\u7a4d\u9664\u4ee5\u6bcf\u500b\u865b\u64ec\u6a5f\u4e2d\u7684\u82af\u7247\u6578\u91cf\u3002- \u78ba\u4fdd\u60a8\u4f7f\u7528 [google](https://registry.terraform.io/providers/hashicorp/google/latest) \u63d0\u4f9b\u7a0b\u5e8f 4.84.0 \u7248\u6216\u66f4\u9ad8\u7248\u672c\u3002\n- \u5c07\u4ee5\u4e0b\u584a\u6dfb\u52a0\u5230 Terraform \u914d\u7f6e\u4e2d\uff1a```\nresource \"google_container_node_pool\" \"NODE_POOL_RESOURCE_NAME\" {\u00a0 provider \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 = google\u00a0 project \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0= PROJECT_ID\u00a0 cluster \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0= CLUSTER_NAME\u00a0 name \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 = POOL_NAME\u00a0 location \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 = CLUSTER_LOCATION\u00a0 node_locations \u00a0 \u00a0 = [NODE_ZONES]\u00a0 initial_node_count = NUM_NODES\u00a0 autoscaling {\u00a0 \u00a0 max_node_count = MAX_NODES\u00a0 \u00a0 location_policy \u00a0 \u00a0 \u00a0= \"ANY\"\u00a0 }\u00a0 node_config {\u00a0 \u00a0 machine_type = MACHINE_TYPE\u00a0 \u00a0 reservation_affinity {\u00a0 \u00a0 \u00a0 consume_reservation_type = \"SPECIFIC_RESERVATION\"\u00a0 \u00a0 \u00a0 key = \"compute.googleapis.com/reservation-name\"\u00a0 \u00a0 \u00a0 values = [RESERVATION_LABEL_VALUES]\u00a0 \u00a0 }\u00a0 \u00a0 spot = true\u00a0 }\u00a0 placement_policy {\u00a0 \u00a0 type = \"COMPACT\"\u00a0 \u00a0 tpu_topology = TPU_TOPOLOGY\u00a0 }}\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1aTerraform \u6a21\u677f\u4e2d\u7684\u7bc0\u9ede\u6c60\u8cc7\u6e90\u7684\u540d\u7a31\u3002\n- ``\uff1a\u60a8\u7684\u9805\u76ee ID\u3002\n- ``\uff1a\u8981\u5728\u5176\u4e2d\u6dfb\u52a0\u7bc0\u9ede\u6c60\u7684\u73fe\u6709\u96c6\u7fa3\u7684\u540d\u7a31\u3002\n- ``\uff1a\u8981\u5275\u5efa\u7684\u7bc0\u9ede\u6c60\u7684\u540d\u7a31\u3002\n- ``\uff1a\u96c6\u7fa3\u7684\u8a08\u7b97\u4f4d\u7f6e\u3002\u6211\u5011\u5efa\u8b70\u60a8\u4f7f\u7528\u5340\u57df\u7d1a\u96c6\u7fa3\uff0c\u4ee5\u63d0\u9ad8 Kubernetes \u63a7\u5236\u5e73\u9762\u7684\u53ef\u9760\u6027\u3002\u60a8\u9084\u53ef\u4ee5\u4f7f\u7528\u53ef\u7528\u5340\u7d1a\u96c6\u7fa3\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u9078\u64c7 TPU \u7248\u672c\u548c\u62d3\u64b2](https://cloud.google.com/kubernetes-engine/docs/how-to/tpus?hl=zh-cn#version_and_topology) \u3002\n- ``\uff1aGKE \u5728\u5176\u4e2d\u5275\u5efa\u7bc0\u9ede\u6c60\u7684\u4e00\u500b\u6216\u591a\u500b\u53ef\u7528\u5340\u7684\u82f1\u6587\u9017\u865f\u5206\u9694\u5217\u8868\u3002\n- ``\uff1a\u7bc0\u9ede\u6c60\u4e2d\u7684\u7bc0\u9ede\u6578\u3002\u8a72\u503c\u5fc5\u9808\u7232\u96f6\u6216 TPU \u82af\u7247\u7684\u6578\u91cf\u9664\u4ee5 4\uff0c\u56e0\u7232\u5728\u591a\u4e3b\u6a5f TPU \u5207\u7247\u4e2d\uff0c\u6bcf\u500b TPU \u7bc0\u9ede\u90fd\u6709 4 \u500b\u82af\u7247\u3002\u4f8b\u5982\uff0c\u5982\u679c``\u7232`4x8`\uff0c\u5247\u6709 32 \u500b\u82af\u7247\uff0c\u9019\u610f\u5473\u7740``\u5fc5\u9808\u7232 8\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3 TPU \u62d3\u64b2\uff0c\u8acb\u4f7f\u7528 [TPU \u914d\u7f6e\u6620\u5c04](https://cloud.google.com/kubernetes-engine/docs/concepts/tpus?hl=zh-cn#configuration) \u4e2d\u7684\u8868\u683c\u3002\n- ``\uff1a\u6307\u793a\u6240\u9700\u7684 TPU \u5207\u7247\u7269\u7406\u62d3\u64b2\u3002\u62d3\u64b2\u683c\u5f0f\u53d6\u6c7a\u65bc\u60a8\u4f7f\u7528\u7684 TPU \u7248\u672c\uff1a- \u5c0d\u65bc TPU v4\uff1a\u4f7f\u7528 3 \u5143\u7d44 (`{A}x{B}x{C}`) \u5b9a\u7fa9\u62d3\u64b2\uff0c\u4f8b\u5982`4x4x4`\u3002\n- \u5c0d\u65bc TPU v5e\uff1a\u4f7f\u7528 2 \u5143\u7d44 (`{A}x{B}`) \u5b9a\u7fa9\u62d3\u64b2\uff0c\u4f8b\u5982`2x2`\u3002\uff08\u53ef\u9078\uff09\u60a8\u9084\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u8b8a\u91cf\uff1a- ``\uff1a\u5982\u679c\u60a8\u4f7f\u7528 [TPU \u9810\u7559](https://cloud.google.com/kubernetes-engine/docs/concepts/tpus?hl=zh-cn#tpu_reservation) \uff0c\u5247\u9019\u662f\u5275\u5efa\u7bc0\u9ede\u6c60\u6642\u4f7f\u7528\u7684\u9810\u7559\u8cc7\u6e90\u7684\u6a19\u7c64\u5217\u8868\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u586b\u5145`reservation_affinity`\u5b57\u6bb5\u4e2d\u7684``\uff0c\u8acb\u53c3\u95b1 [Terraform \u63d0\u4f9b\u7a0b\u5e8f](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/container_cluster#reservation_affinity) \u3002\n- `autoscaling`\uff1a\u5275\u5efa\u5553\u7528\u4e86\u81ea\u52d5\u64f4\u7e2e\u529f\u80fd\u7684\u7bc0\u9ede\u6c60\u3002\u7576 GKE \u64f4\u7e2e\u591a\u4e3b\u6a5f TPU \u5207\u7247\u7bc0\u9ede\u6c60\u6642\uff0c\u5b83\u6703 [\u4ee5\u539f\u5b50\u65b9\u5f0f](https://cloud.google.com/kubernetes-engine/docs/concepts/tpus?hl=zh-cn#terminology) \u5c07\u7bc0\u9ede\u6c60\u5f9e\u96f6\u64f4\u5bb9\u5230\u5927\u5c0f\u4e0a\u9650\u3002- ``\uff1a\u7bc0\u9ede\u6c60\u7684\u5927\u5c0f\u4e0a\u9650\u3002\u8a72\u503c\u5fc5\u9808\u7b49\u65bc``(`{A}x{B}x{C}`) \u4e2d\u5b9a\u7fa9\u7684\u503c\u7684\u4e58\u7a4d\u9664\u4ee5\u6bcf\u500b\u865b\u64ec\u6a5f\u4e2d\u7684\u82af\u7247\u6578\u91cf\u3002\n- `spot`\uff1a\u53ef\u8b93\u7bc0\u9ede\u6c60\u5c0d TPU \u7bc0\u9ede\u4f7f\u7528 Spot \u865b\u64ec\u6a5f\u3002\u5275\u5efa\u7bc0\u9ede\u6c60\u5f8c\uff0c\u60a8\u5c07\u7121\u6cd5\u66f4\u6539\u6b64\u8a2d\u7f6e\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [Spot \u865b\u64ec\u6a5f](https://cloud.google.com/kubernetes-engine/docs/concepts/spot-vms?hl=zh-cn) \u3002\n\u5982\u9700\u5275\u5efa\u5177\u6709 TPU \u7684\u7bc0\u9ede\u6c60\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u8f49\u5230 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **Google Kubernetes Engine** \u9801\u9762\u3002 [\u524d\u5f80 Google Kubernetes Engine](https://console.cloud.google.com/kubernetes/list?hl=zh-cn) \n- \u5728\u96c6\u7fa3\u5217\u8868\u4e2d\uff0c\u9ede\u64ca\u60a8\u8981\u4fee\u6539\u7684\u96c6\u7fa3\u7684\u540d\u7a31\u3002\n- \u9ede\u64ca **\u6dfb\u52a0\u7bc0\u9ede\u6c60** \u3002\n- \u5728 **\u7bc0\u9ede\u6c60\u8a73\u60c5** \u90e8\u5206\u4e2d\uff0c\u52fe\u9078 **\u6307\u5b9a\u7bc0\u9ede\u4f4d\u7f6e** \u8907\u9078\u6846\u3002\n- \u6839\u64da\u60a8\u8981\u4f7f\u7528\u7684 TPU \u7248\u672c\u9078\u64c7\u53ef\u7528\u5340\uff1a- \u5c0d\u65bc TPU v4\uff0c\u8acb\u4f7f\u7528`us-central2-b`\u3002\n- \u4ee5`ct5l-`\u958b\u982d\u7684 TPU v5e \u6a5f\u5668\u985e\u578b\u7d55\u4e0d\u6703\u662f\u591a\u4e3b\u6a5f\u3002\n- \u5c0d\u65bc\u4ee5`ct5lp-`\u958b\u982d\u7684 TPU v5e \u6a5f\u5668\u985e\u578b\uff0c\u8acb\u4f7f\u7528`us-west1-c`\u3001`us-west4-a`\u3001`us-west4-b`\u3001`us-central1-a`\u3001`us-east1-c`\u3001`us-east5-b`\u6216`europe-west4-a`\u3002\n- \u5c0d\u65bc\u4ee5`ct5p-`\u958b\u982d\u7684 TPU v5p \u6a5f\u5668\u985e\u578b\uff0c\u8acb\u4f7f\u7528`us-east1-d`\u3001`us-east5-a`\u6216`us-east5-c`\u3002\n- \u5728\u5c0e\u822a\u7a97\u683c\u4e2d\uff0c\u9ede\u64ca **\u7bc0\u9ede** \u3002\n- \u5728 **\u6a5f\u5668\u914d\u7f6e** \u90e8\u5206\u4e2d\uff0c\u9078\u64c7 **TPU** \u3002\n- \u5728 **\u7cfb\u5217** \u4e0b\u62c9\u83dc\u55ae\u4e2d\uff0c\u9078\u64c7\u4ee5\u4e0b\u9078\u9805\u4e4b\u4e00\uff1a- **CT4P** \uff1a\u9069\u7528\u65bc TPU v4\u3002\n- **CT5LP** \uff1a\u9069\u7528\u65bc TPU v5e\u3002\n- \u5728 **\u6a5f\u5668\u985e\u578b** \u4e0b\u62c9\u83dc\u55ae\u4e2d\uff0c\u9078\u64c7\u8981\u7528\u65bc\u7bc0\u9ede\u7684\u6a5f\u5668\u7684\u540d\u7a31\u3002\u4f7f\u7528 [TPU \u914d\u7f6e\u6620\u5c04](https://cloud.google.com/kubernetes-engine/docs/concepts/tpus?hl=zh-cn#configuration) \u8868\u53ef\u77ad\u89e3\u5982\u4f55\u5b9a\u7fa9\u7528\u65bc\u5275\u5efa\u591a\u4e3b\u6a5f TPU \u7bc0\u9ede\u6c60\u7684\u6a5f\u5668\u985e\u578b\u548c TPU \u62d3\u64b2\u3002\n- \u5728 **TPU \u62d3\u64b2** \u4e0b\u62c9\u83dc\u55ae\u4e2d\uff0c\u9078\u64c7 TPU \u5207\u7247\u7684\u7269\u7406\u62d3\u64b2\u3002\n- \u5728 **\u9700\u8981\u66f4\u6539** \u5c0d\u8a71\u6846\u4e2d\uff0c\u9ede\u64ca **\u9032\u884c\u66f4\u6539** \u3002\n- \u78ba\u4fdd **\u5553\u52d5\u78c1\u76e4\u985e\u578b** \u7232 **\u6a19\u6e96\u6c38\u4e45\u6027\u78c1\u76e4** \u6216 **SSD \u6c38\u4e45\u6027\u78c1\u76e4** \u3002\n- \uff08\u53ef\u9078\uff09\u9078\u4e2d **\u5728 Spot \u865b\u64ec\u6a5f\u4e0a\u5553\u7528\u7bc0\u9ede** \u8907\u9078\u6846\uff0c\u4ee5\u5c0d\u7bc0\u9ede\u6c60\u4e2d\u7684\u7bc0\u9ede\u4f7f\u7528 Spot \u865b\u64ec\u6a5f\u3002\n- \u9ede\u64ca **\u5275\u5efa** \u3002\n### \u9810\u914d\u72c0\u614b\n\u5982\u679c GKE \u56e0 TPU \u5bb9\u91cf\u4e0d\u8db3\u800c\u7121\u6cd5\u5275\u5efa TPU \u5207\u7247\u7bc0\u9ede\u6c60\uff0c\u60a8\u7684 TPU \u9810\u914d\u8acb\u6c42\u5c07\u6dfb\u52a0\u5230\u5168\u5c40\u968a\u5217\u4e2d\uff0c\u800c\u4e0d\u662f\u6536\u5230 `GCE_STOCKOUT` \u932f\u8aa4\u3002\n\u60a8\u7684 TPU \u9810\u914d\u8acb\u6c42\u53ef\u80fd\u6703\u5728\u6b64\u968a\u5217\u4e2d\u4fdd\u7559\u5f88\u9577\u6642\u9593\uff0c\u4e26\u4e14\u5728\u968a\u5217\u4e2d\u4fdd\u6301\u201c\u9810\u914d\u201d\u72c0\u614b\u3002\n\u4e00\u65e6 TPU \u5bb9\u91cf\u8db3\u5920\uff0cGKE \u5c31\u6703\u5275\u5efa TPU \u5207\u7247\u7bc0\u9ede\u6c60\u3002\n\u60a8\u53ef\u4ee5\u901a\u904e [\u522a\u9664 TPU \u5207\u7247\u7bc0\u9ede\u6c60](https://cloud.google.com/kubernetes-engine/docs/how-to/node-pools?hl=zh-cn#deleting_a_node_pool) \u4f86\u522a\u9664\u5df2\u52a0\u5165\u968a\u5217\u7684 TPU \u8acb\u6c42\u3002\n## \u5728 TPU \u7bc0\u9ede\u4e0a\u904b\u884c\u5de5\u4f5c\u8ca0\u8f09\n### \u5de5\u4f5c\u8ca0\u8f09\u6e96\u5099\n\u5275\u5efa\u96c6\u7fa3\u548c\u7bc0\u9ede\u6c60\u5f8c\uff0c\u60a8\u53ef\u4ee5\u8a2d\u7f6e\u5de5\u4f5c\u8ca0\u8f09\u3002\u524d\u63d0\u689d\u4ef6\u662f\u60a8\u5fc5\u9808\u5b8c\u6210\u4ee5\u4e0b\u5de5\u4f5c\u8ca0\u8f09\u6e96\u5099\u6b65\u9a5f\uff1a\n- JAX\u3001PyTorch \u548c TensorFlow \u7b49\u6846\u67b6\u4f7f\u7528 `libtpu` \u5171\u4eab\u5eab\u8a2a\u554f TPU \u865b\u64ec\u6a5f\u3002 `libtpu` \u5305\u62ec XLA \u7de8\u8b6f\u5668\u3001TPU \u904b\u884c\u6642\u8edf\u4ef6\u548c TPU \u9a45\u52d5\u7a0b\u5e8f\u3002\u6bcf\u500b PyTorch \u548c JAX \u7248\u672c\u90fd\u9700\u8981\u7279\u5b9a\u7684 `libtpu.so` \u7248\u672c\u3002\u5982\u9700\u5728 GKE \u4e2d\u4f7f\u7528 TPU\uff0c\u8acb\u78ba\u4fdd\u60a8\u4f7f\u7528\u4ee5\u4e0b\u7248\u672c\uff1a| TPU \u7248\u672c | libtpu.so\u7248\u672c                         |\n|:-----------|:----------------------------------------------------------------------------------------------------------------|\n| TPU v4  | \u63a8\u85a6\u7684 jax[tpu] \u7248\u672c\uff1a0.4.4 \u6216\u66f4\u9ad8\u7248\u672c\u3002 \u63a8\u85a6\u7684 torchxla[tpuvm] \u7248\u672c\uff1av2.0.0 \u6216\u66f4\u9ad8\u7248\u672c\u3002      |\n| TPU v5e | \u63a8\u85a6\u7684 jax[tpu] \u7248\u672c\uff1av0.4.9 \u6216\u66f4\u9ad8\u7248\u672c\u3002 \u63a8\u85a6\u7684 torchxla[tpuvm] \u7248\u672c\uff1av2.1.0 \u6216\u66f4\u9ad8\u7248\u672c\u3002      |\n| TPU v5p | \u63a8\u85a6\u7684 jax[tpu] \u7248\u672c\uff1a0.4.19 \u6216\u66f4\u9ad8\u7248\u672c\u3002 \u63a8\u85a6\u7684 Torchxla[tpuvm] \u7248\u672c\uff1a\u5efa\u8b70\u4f7f\u7528 2023 \u5e74 10 \u6708 23 \u65e5\u7684\u591c\u9593\u7248\u672c\u3002 |\n- \u7232\u8acb\u6c42 TPU \u8cc7\u6e90\u7684\u5bb9\u5668\u8a2d\u7f6e\u4ee5\u4e0b\u74b0\u5883\u8b8a\u91cf\uff1a- `TPU_WORKER_ID`\uff1a\u6bcf\u500b Pod \u7684\u552f\u4e00\u6574\u6578\u3002\u6b64 ID \u8868\u793a TPU \u5207\u7247\u4e2d\u7684\u552f\u4e00\u5de5\u4f5c\u5668 ID\u3002\u6b64\u5b57\u6bb5\u652f\u6301\u7684\u503c\u7bc4\u570d\u5f9e 0 \u5230 Pod \u6578\u91cf\u6e1b\u53bb 1\u3002\n- `TPU_WORKER_HOSTNAMES`\uff1a\u9700\u8981\u5728\u5207\u7247\u5167\u76f8\u4e92\u901a\u4fe1\u7684 TPU \u865b\u64ec\u6a5f\u4e3b\u6a5f\u540d\u6216 IP \u5730\u5740\u7684\u82f1\u6587\u9017\u865f\u5206\u9694\u5217\u8868\u3002\u5207\u7247\u4e2d\u7684\u6bcf\u500b TPU \u865b\u64ec\u6a5f\u90fd\u61c9\u8a72\u6709\u4e00\u500b\u4e3b\u6a5f\u540d\u6216 IP \u5730\u5740\u3002IP \u5730\u5740\u6216\u4e3b\u6a5f\u540d\u5217\u8868\u6309`TPU_WORKER_ID`\u6392\u5e8f\u4e14\u7232\u96f6\u7d22\u5f15\u3002\n\u5728 `completionMode: Indexed, subdomain` , `parallelism > 1` \u60c5\u6cc1\u4e0b\u5275\u5efa Job \u4e26\u8acb\u6c42 `google.com/tpu` \u5c6c\u6027\u6642\uff0cGKE \u6703\u4f7f\u7528\u8b8a\u66f4 webhook \u81ea\u52d5\u6ce8\u5165\u9019\u4e9b\u74b0\u5883\u8b8a\u91cf\u3002GKE \u6703\u6dfb\u52a0\u4e00\u500b\u7121\u982d Service\uff0c\u4ee5\u4fbf\u7232 [\u652f\u6301 Service \u7684 Pod](https://kubernetes.io/docs/concepts/services-networking/service/#headless-services) \u6dfb\u52a0 DNS \u8a18\u9304\u3002\u4f7f\u7528 [Kuberay](https://github.com/ray-project/kuberay) \u90e8\u7f72 TPU \u591a\u4e3b\u6a5f\u8cc7\u6e90\u6642\uff0cGKE \u63d0\u4f9b\u53ef\u90e8\u7f72\u7684 [Webhook](https://github.com/GoogleCloudPlatform/ai-on-gke/blob/main/applications/ray/kuberay-tpu-webhook/) \u4f5c\u7232 [Terraform \u6a21\u677f](https://github.com/GoogleCloudPlatform/ai-on-gke/tree/main/applications/ray) \u7684\u4e00\u90e8\u5206\uff0c\u7528\u65bc\u904b\u884c Ray on GKE\u3002\u6709\u95dc\u4f7f\u7528 TPU \u904b\u884c Ray on GKE \u7684\u8aaa\u660e\uff0c\u8acb\u53c3\u95b1 [TPU \u7528\u6236\u6307\u5357](https://github.com/GoogleCloudPlatform/ai-on-gke/blob/main/applications/ray/TPU_guide.md) \u3002\u66f4\u6539 webhook \u6703\u5c07\u9019\u4e9b\u74b0\u5883\u8b8a\u91cf\u6ce8\u5165\u8acb\u6c42 `google.com/tpu` \u5c6c\u6027\u7684 Ray \u96c6\u7fa3\u548c\u591a\u4e3b\u6a5f `cloud.google.com/gke-tpu-topology` \u7bc0\u9ede\u9078\u64c7\u5668\u3002\n- \u5728\u5de5\u4f5c\u8ca0\u8f09\u6e05\u55ae\u4e2d\uff0c\u6dfb\u52a0 Kubernetes \u7bc0\u9ede\u9078\u64c7\u5668\uff0c\u4ee5\u78ba\u4fdd GKE \u6839\u64da\u60a8\u5b9a\u7fa9\u7684 TPU \u6a5f\u5668\u985e\u578b\u548c TPU \u62d3\u64b2\u8abf\u5ea6 TPU \u5de5\u4f5c\u8ca0\u8f09\uff1a```\nnodeSelector:\u00a0 cloud.google.com/gke-tpu-accelerator: TPU_ACCELERATOR\u00a0 cloud.google.com/gke-tpu-topology: TPU_TOPOLOGY\n```\n\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a\n- `` \uff1aTPU \u52a0\u901f\u5668\u7684\u540d\u7a31\uff1a- \u5c0d\u65bc TPU v4\uff0c\u8acb\u4f7f\u7528`tpu-v4-podslice`\u3002\n- \u5c0d\u65bc\u4ee5`ct5l-`\u958b\u982d\u7684 TPU v5e \u6a5f\u5668\u985e\u578b\uff0c\u8acb\u4f7f\u7528`tpu-v5-lite-device`\u3002\n- \u5c0d\u65bc\u4ee5`ct5lp-`\u958b\u982d\u7684 TPU v5e \u6a5f\u5668\u985e\u578b\uff0c\u8acb\u4f7f\u7528`tpu-v5-lite-podslice`\u3002\n- \u5c0d\u65bc TPU v5p\uff0c\u8acb\u4f7f\u7528`tpu-v5p-slice`\u3002\n- `` \uff1aTPU \u5207\u7247\u7684\u7269\u7406\u62d3\u64b2\u3002\u62d3\u64b2\u683c\u5f0f\u53d6\u6c7a\u65bc TPU \u7248\u672c\uff0c\u5982\u4e0b\u6240\u793a\uff1a- TPU v4\uff1a\u4f7f\u7528 3 \u5143\u7d44 (`{A}x{B}x{C}`) \u5b9a\u7fa9\u62d3\u64b2\uff0c\u4f8b\u5982`4x4x4`\u3002\n- TPU v5e\uff1a\u4f7f\u7528 2 \u5143\u7d44 (`{A}x{B}`) \u5b9a\u7fa9\u62d3\u64b2\uff0c\u4f8b\u5982`2x2`\u3002\n- TPU v5p\uff1a\u4f7f\u7528 3 \u5143\u7d44 (`{A}x{B}x{C}`) \u5b9a\u7fa9\u62d3\u64b2\uff0c\u4f8b\u5982`4x4x4`\u3002\u5b8c\u6210\u5de5\u4f5c\u8ca0\u8f09\u6e96\u5099\u5f8c\uff0c\u60a8\u53ef\u4ee5\u904b\u884c\u4f7f\u7528 TPU \u7684 Job\u3002\n\u4ee5\u4e0b\u90e8\u5206\u8209\u4f8b\u8aaa\u660e\u4e86\u5982\u4f55\u904b\u884c\u4f7f\u7528 TPU \u57f7\u884c\u7c21\u55ae\u8a08\u7b97\u7684 Job\u3002\n### \u793a\u4f8b 1\uff1a\u904b\u884c\u986f\u793a TPU \u7bc0\u9ede\u6c60\u4e2d\u53ef\u7528 TPU \u82af\u7247\u6578\u91cf\u7684\u5de5\u4f5c\u8ca0\u8f09\n\u6b64\u793a\u4f8b\u5305\u62ec\u4ee5\u4e0b\u914d\u7f6e\uff1a\n- TPU \u7248\u672c\uff1av4 (`tpu-v4-podslice`)\n- \u62d3\u64b2\uff1a2x2x4\n- \u7bc0\u9ede\u6c60\u985e\u578b\uff1a\u591a\u4e3b\u6a5f TPU \u5207\u7247\n- \u5275\u5efa\u4ee5\u4e0b `tpu-job.yaml` \u6e05\u55ae\uff1a```\napiVersion: v1kind: Servicemetadata:\u00a0 name: headless-svcspec:\u00a0 clusterIP: None\u00a0 selector:\u00a0 \u00a0 job-name: tpu-job-podslice---apiVersion: batch/v1kind: Jobmetadata:\u00a0 name: tpu-job-podslicespec:\u00a0 backoffLimit: 0\u00a0 completions: 4\u00a0 parallelism: 4\u00a0 completionMode: Indexed\u00a0 template:\u00a0 \u00a0 spec:\u00a0 \u00a0 \u00a0 subdomain: headless-svc\u00a0 \u00a0 \u00a0 restartPolicy: Never\u00a0 \u00a0 \u00a0 nodeSelector:\u00a0 \u00a0 \u00a0 \u00a0 cloud.google.com/gke-tpu-accelerator: tpu-v4-podslice\u00a0 \u00a0 \u00a0 \u00a0 cloud.google.com/gke-tpu-topology: 2x2x4\u00a0 \u00a0 \u00a0 containers:\u00a0 \u00a0 \u00a0 - name: tpu-job\u00a0 \u00a0 \u00a0 \u00a0 image: python:3.10\u00a0 \u00a0 \u00a0 \u00a0 ports:\u00a0 \u00a0 \u00a0 \u00a0 - containerPort: 8471 # Default port using which TPU VMs communicate\u00a0 \u00a0 \u00a0 \u00a0 - containerPort: 8431 # Port to export TPU runtime metrics, if supported.\u00a0 \u00a0 \u00a0 \u00a0 securityContext:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 privileged: true\u00a0 \u00a0 \u00a0 \u00a0 command:\u00a0 \u00a0 \u00a0 \u00a0 - bash\u00a0 \u00a0 \u00a0 \u00a0 - -c\u00a0 \u00a0 \u00a0 \u00a0 - |\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 pip install 'jax[tpu]' -f https://storage.googleapis.com/jax-releases/libtpu_releases.html\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 python -c 'import jax; print(\"TPU cores:\", jax.device_count())'\u00a0 \u00a0 \u00a0 \u00a0 resources:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 requests:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 google.com/tpu: 4\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 limits:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 google.com/tpu: 4\n```\u6bcf\u500b TPU \u7bc0\u9ede\u90fd\u5177\u6709\u4ee5\u4e0b\u7bc0\u9ede\u6a19\u7c64\uff1a- `cloud.google.com/gke-accelerator-type: tpu-v4-podslice`\n- `cloud.google.com/gke-tpu-topology: 2x2x4`\n- \u61c9\u7528\u6e05\u55ae\uff1a```\nkubectl apply -f tpu-job.yaml\n```GKE \u6703\u904b\u884c\u5177\u6709\u56db\u500b TPU \u865b\u64ec\u6a5f\u7684 TPU v4 \u5207\u7247\uff08\u591a\u4e3b\u6a5f TPU \u5207\u7247\uff09\u3002\u7bc0\u9ede\u6c60\u5177\u6709 16 \u500b\u4e92\u9023\u82af\u7247\u3002\n- \u9a57\u8b49 Job \u662f\u5426\u5275\u5efa\u4e86\u56db\u500b Pod\uff1a```\nkubectl get pods\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nNAME      READY STATUS  RESTARTS AGE\ntpu-job-podslice-0-5cd8r 0/1  Completed 0   97s\ntpu-job-podslice-1-lqqxt 0/1  Completed 0   97s\ntpu-job-podslice-2-f6kwh 0/1  Completed 0   97s\ntpu-job-podslice-3-m8b5c 0/1  Completed 0   97s\n```\n- \u7372\u53d6\u5176\u4e2d\u4e00\u500b Pod \u7684\u65e5\u8a8c\uff1a```\nkubectl logs POD_NAME\n```\u5c07 `` \u66ff\u63db\u7232\u67d0\u500b\u5df2\u5275\u5efa\u7684 Pod \u7684\u540d\u7a31\u3002\u4f8b\u5982 `tpu-job-podslice-0-5cd8r` \u3002\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nTPU cores: 16\n```\n### \u793a\u4f8b 2\uff1a\u904b\u884c\u986f\u793a TPU \u865b\u64ec\u6a5f\u4e2d\u53ef\u7528 TPU \u82af\u7247\u6578\u91cf\u7684\u5de5\u4f5c\u8ca0\u8f09\n- \u62d3\u64b2\uff1a2x4\n- TPU \u7248\u672c\uff1av5e (`tpu-v5-lite-podslice`)\n- \u7bc0\u9ede\u6c60\u985e\u578b\uff1a\u55ae\u4e3b\u6a5f TPU \u5207\u7247\n- \u5275\u5efa\u4ee5\u4e0b\u6e05\u55ae\u4f5c\u7232 `tpu-pod.yaml````\napiVersion: v1kind: Podmetadata:\u00a0 name: tpu-job-jax-v5spec:\u00a0 restartPolicy: Never\u00a0 nodeSelector:\u00a0 \u00a0 cloud.google.com/gke-tpu-accelerator: tpu-v5-lite-podslice\u00a0 \u00a0 cloud.google.com/gke-tpu-topology: 2x4\u00a0 containers:\u00a0 - name: tpu-job\u00a0 \u00a0 image: python:3.10\u00a0 \u00a0 ports:\u00a0 \u00a0 - containerPort: 8431 # Port to export TPU runtime metrics, if supported.\u00a0 \u00a0 securityContext:\u00a0 \u00a0 \u00a0 privileged: true\u00a0 \u00a0 command:\u00a0 \u00a0 - bash\u00a0 \u00a0 - -c\u00a0 \u00a0 - |\u00a0 \u00a0 \u00a0 pip install 'jax[tpu]' -f https://storage.googleapis.com/jax-releases/libtpu_releases.html\u00a0 \u00a0 \u00a0 python -c 'import jax; print(\"Total TPU chips:\", jax.device_count())'\u00a0 \u00a0 resources:\u00a0 \u00a0 \u00a0 requests:\u00a0 \u00a0 \u00a0 \u00a0 google.com/tpu: 8\u00a0 \u00a0 \u00a0 limits:\u00a0 \u00a0 \u00a0 \u00a0 google.com/tpu: 8\n```\u6b64\u6e05\u55ae\u5305\u542b\u4ee5\u4e0b\u7bc0\u9ede\u6a19\u7c64\uff1a- `cloud.google.com/gke-tpu-accelerator: tpu-v5-lite-podslice`\n- `cloud.google.com/gke-tpu-topology: 2x4`\nGKE \u6703\u9810\u914d\u4e00\u500b\u5177\u6709\u516b\u500b\u55ae\u4e3b\u6a5f TPU \u5207\u7247\u7684\u7bc0\u9ede\u6c60\uff0c\u9019\u4e9b\u5207\u7247\u4f7f\u7528 TPU v5e\u3002\u6bcf\u500b TPU \u865b\u64ec\u6a5f\u90fd\u5177\u6709\u516b\u500b\u82af\u7247\uff08\u55ae\u4e3b\u6a5f TPU \u5207\u7247\uff09\u3002## \u4f7f\u7528\u52a0\u901f\u5668\uff08GPU \u548c TPU\uff09\u5347\u7d1a\u7bc0\u9ede\u6c60\nGKE \u6703 [\u81ea\u52d5\u5347\u7d1a](https://cloud.google.com/kubernetes-engine/docs/concepts/cluster-upgrades?hl=zh-cn#upgrading_automatically) Standard \u96c6\u7fa3\uff0c\u5305\u62ec\u7bc0\u9ede\u6c60\u3002\u5982\u679c\u60a8\u5e0c\u671b\u7bc0\u9ede\u66f4\u5feb\u5730\u5347\u7d1a\u5230\u66f4\u9ad8\u7248\u672c\uff0c\u4e5f\u53ef\u4ee5 [\u624b\u52d5\u5347\u7d1a](https://cloud.google.com/kubernetes-engine/docs/how-to/upgrading-a-cluster?hl=zh-cn#upgrade_nodes) \u7bc0\u9ede\u6c60\u3002\u5982\u9700\u63a7\u5236\u96c6\u7fa3\u5347\u7d1a\u7684\u65b9\u5f0f\uff0c\u8acb\u4f7f\u7528 [\u767c\u4f48\u6e20\u9053](https://cloud.google.com/kubernetes-engine/docs/concepts/release-channels?hl=zh-cn) \u3001 [\u7dad\u8b77\u7a97\u53e3\u548c\u6392\u9664\u9805](https://cloud.google.com/kubernetes-engine/docs/concepts/maintenance-windows-and-exclusions?hl=zh-cn) \u4ee5\u53ca [\u767c\u4f48\u9806\u5e8f](https://cloud.google.com/kubernetes-engine/docs/concepts/about-rollout-sequencing?hl=zh-cn) \u3002\n\u60a8\u9084\u53ef\u4ee5\u7232\u7bc0\u9ede\u6c60\u914d\u7f6e [\u7bc0\u9ede\u5347\u7d1a\u7b56\u7565](https://cloud.google.com/kubernetes-engine/docs/concepts/node-pool-upgrade-strategies?hl=zh-cn) \uff0c\u4f8b\u5982 [\u8d85\u984d\u914d\u7f6e\u5347\u7d1a](https://cloud.google.com/kubernetes-engine/docs/concepts/node-pool-upgrade-strategies?hl=zh-cn#surge) \u6216 [\u85cd\u7da0\u5347\u7d1a](https://cloud.google.com/kubernetes-engine/docs/concepts/node-pool-upgrade-strategies?hl=zh-cn#blue-green-upgrade-strategy) \u3002\u901a\u904e\u914d\u7f6e\u9019\u4e9b\u7b56\u7565\uff0c\u60a8\u53ef\u4ee5\u78ba\u4fdd\u7bc0\u9ede\u6c60\u7684\u5347\u7d1a\u65b9\u5f0f\u80fd\u5920\u5728\u901f\u5ea6\u548c\u74b0\u5883\u4e2d\u65b7\u4e4b\u9593\u5be6\u73fe\u6700\u4f73\u5e73\u8861\u3002\u5c0d\u65bc [\u591a\u4e3b\u6a5f TPU \u5207\u7247\u7bc0\u9ede\u6c60](https://cloud.google.com/kubernetes-engine/docs/concepts/tpus?hl=zh-cn#node_pool) \uff0cGKE \u6703\u5728\u55ae\u4e00\u6b65\u9a5f\u4e2d\u4ee5\u539f\u5b50\u65b9\u5f0f\u91cd\u65b0\u5275\u5efa\u6574\u500b\u7bc0\u9ede\u6c60\uff0c\u800c\u4e0d\u662f\u4f7f\u7528\u914d\u7f6e\u7684\u7bc0\u9ede\u5347\u7d1a\u7b56\u7565\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [GKE \u4e2d\u7684 TPU \u76f8\u95dc\u8853\u8a9e](https://cloud.google.com/kubernetes-engine/docs/concepts/tpus?hl=zh-cn#terminology) \u4e2d\u7684\u201c\u539f\u5b50\u6027\u201d\u5b9a\u7fa9\u3002\n\u4f7f\u7528\u7bc0\u9ede\u5347\u7d1a\u7b56\u7565\u6703\u66ab\u6642\u8981\u6c42 GKE \u9810\u914d\u66f4\u591a\u8cc7\u6e90\uff0c\u5177\u9ad4\u53d6\u6c7a\u65bc\u914d\u7f6e\u3002\u5982\u679c Google Cloud \u5c0d\u7bc0\u9ede\u6c60\u7684\u8cc7\u6e90\u5177\u6709\u5bb9\u91cf\u9650\u5236\uff08\u4f8b\u5982\uff0c\u60a8\u5617\u8a66\u4f7f\u7528 GPU \u6216 TPU \u5275\u5efa\u66f4\u591a\u7bc0\u9ede\u6642\u51fa\u73fe [\u8cc7\u6e90\u53ef\u7528\u6027](https://cloud.google.com/compute/docs/troubleshooting/troubleshooting-resource-availability?hl=zh-cn) \u932f\u8aa4\uff09\uff0c\u8acb\u53c3\u95b1 [\u5728\u8cc7\u6e90\u53d7\u9650\u7684\u74b0\u5883\u4e2d\u5347\u7d1a](https://cloud.google.com/kubernetes-engine/docs/how-to/node-upgrades-quota?hl=zh-cn#upgrade-resource-constrained) \u3002\n## \u6e05\u7406\n\u7232\u907f\u514d\u7cfb\u7d71\u56e0\u672c\u6307\u5357\u4e2d\u4f7f\u7528\u7684\u8cc7\u6e90\u5411\u60a8\u7684 Google Cloud \u8cec\u865f\u6536\u53d6\u8cbb\u7528\uff0c\u8acb\u8003\u616e\u522a\u9664\u4e0d\u518d\u5177\u6709\u8a08\u5283\u5de5\u4f5c\u8ca0\u8f09\u7684 TPU \u7bc0\u9ede\u6c60\u3002\u5982\u679c\u5fc5\u9808\u6b63\u5e38\u7d42\u6b62\u5de5\u4f5c\u8ca0\u8f09\u904b\u884c\uff0c\u8acb\u4f7f\u7528 [kubectl drain](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#drain) \u6e05\u7406\u5de5\u4f5c\u8ca0\u8f09\uff0c\u7136\u5f8c\u518d\u522a\u9664\u7bc0\u9ede\u3002\n- \u522a\u9664 TPU \u7bc0\u9ede\u6c60\uff1a```\ngcloud container node-pools delete POOL_NAME \\\u00a0 \u00a0 --location=LOCATION \\\u00a0 \u00a0 --cluster=CLUSTER_NAME\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u7bc0\u9ede\u6c60\u7684\u540d\u7a31\u3002\n- ``\uff1a\u96c6\u7fa3\u7684\u540d\u7a31\u3002\n- ``\uff1a\u96c6\u7fa3\u7684\u8a08\u7b97\u4f4d\u7f6e\u3002\n## \u5176\u4ed6\u914d\u7f6e\n\u4ee5\u4e0b\u90e8\u5206\u4ecb\u7d39\u4e86\u53ef\u61c9\u7528\u65bc TPU \u5de5\u4f5c\u8ca0\u8f09\u7684\u5176\u4ed6\u914d\u7f6e\u3002\n### \u591a\u5207\u7247\n\u60a8\u53ef\u4ee5\u5c07\u8f03\u5c0f\u7684\u5207\u7247\u805a\u5408\u5230\u591a\u5207\u7247\u4e2d\uff0c\u4ee5\u8655\u7406\u8f03\u5927\u7684\u8a13\u7df4\u5de5\u4f5c\u8ca0\u8f09\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [GKE \u4e2d\u7684\u591a\u5207\u7247 TPU](https://cloud.google.com/tpu/docs/tpu-gke-multislice?hl=zh-cn) \u3002\n### \u9077\u79fb TPU \u9810\u7559\n\u5982\u679c\u60a8\u5df2\u6709 TPU \u9810\u7559\uff0c\u5247\u5fc5\u9808\u5148\u5c07 TPU \u9810\u7559\u9077\u79fb\u5230\u65b0\u7684\u57fa\u65bc Compute Engine \u7684\u9810\u7559\u7cfb\u7d71\u3002\u60a8\u9084\u53ef\u4ee5\u5275\u5efa\u57fa\u65bc Compute Engine \u7684\u9810\u7559\u7cfb\u7d71\uff0c\u4e0d\u9700\u8981\u9077\u79fb\u3002\u5982\u9700\u77ad\u89e3\u5982\u4f55\u9077\u79fb TPU \u9810\u7559\uff0c\u8acb\u53c3\u95b1 [TPU \u9810\u7559](https://cloud.google.com/kubernetes-engine/docs/concepts/tpus?hl=zh-cn#tpu_reservation) \u3002\n### \u65e5\u8a8c\u8a18\u9304\nGKE \u7bc0\u9ede\uff08\u5305\u62ec TPU \u865b\u64ec\u6a5f\uff09\u4e0a\u904b\u884c\u7684\u5bb9\u5668\u767c\u51fa\u7684\u65e5\u8a8c\u6703\u7531 GKE \u65e5\u8a8c\u8a18\u9304\u4ee3\u7406 [\u6536\u96c6](https://cloud.google.com/stackdriver/docs/solutions/gke/managing-logs?hl=zh-cn) \uff0c\u767c\u9001\u5230 Logging\uff0c\u4e26\u4e14 [\u986f\u793a\u5728 Logging \u4e2d](https://cloud.google.com/stackdriver/docs/solutions/gke/using-logs?hl=zh-cn) \u3002\n### \u4f7f\u7528 GKE \u7bc0\u9ede\u81ea\u52d5\u9810\u914d\n\u60a8\u53ef\u4ee5\u5c07 GKE \u914d\u7f6e\u7232\u81ea\u52d5\u5275\u5efa\u548c\u522a\u9664\u7bc0\u9ede\u6c60\uff0c\u4ee5\u6eff\u8db3 TPU \u5de5\u4f5c\u8ca0\u8f09\u7684\u8cc7\u6e90\u9700\u6c42\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u914d\u7f6e Cloud TPU](https://cloud.google.com/kubernetes-engine/docs/how-to/node-auto-provisioning?hl=zh-cn#tpu) \u3002\n### TPU \u7bc0\u9ede\u81ea\u52d5\u4fee\u5fa9\n\u5982\u679c\u591a\u4e3b\u6a5f TPU \u5207\u7247\u7bc0\u9ede\u6c60\u4e2d\u7684 TPU \u7bc0\u9ede\u5065\u5eb7\u72c0\u6cc1\u4e0d\u4f73\uff0c\u5247\u7cfb\u7d71\u6703\u91cd\u65b0\u5275\u5efa\u6574\u500b\u7bc0\u9ede\u6c60\u3002\u5c0e\u81f4 TPU \u7bc0\u9ede\u5065\u5eb7\u72c0\u6cc1\u4e0d\u4f73\u7684\u689d\u4ef6\u5305\u62ec\uff1a\n- \u4efb\u4f55\u5177\u6709\u901a\u7528\u7bc0\u9ede [\u689d\u4ef6](https://cloud.google.com/kubernetes-engine/docs/how-to/node-auto-repair?hl=zh-cn#repair_criteria) \u7684 TPU \u7bc0\u9ede\u3002\n- \u4efb\u4f55\u4e0d\u53ef\u5206\u914d TPU \u6578\u91cf\u5927\u65bc\u96f6\u7684 TPU \u7bc0\u9ede\u3002\n- \u4efb\u4f55\u5df2\u505c\u6b62\uff08\u7531\u65bc\u6436\u4f54\uff09\u6216\u7d42\u6b62\u7684 TPU \u865b\u64ec\u6a5f\u5be6\u4f8b\u3002\n- \u7bc0\u9ede\u7dad\u8b77\uff1a\u5982\u679c\u591a\u4e3b\u6a5f TPU \u5207\u7247\u7bc0\u9ede\u6c60\u4e2d\u7684\u4efb\u4f55 TPU \u7bc0\u9ede\uff08\u865b\u64ec\u6a5f\uff09\u56e0\u4e3b\u6a5f\u7dad\u8b77\u800c\u95dc\u9589\uff0cGKE \u6703\u91cd\u65b0\u5275\u5efa\u6574\u500b TPU \u5207\u7247\u3002\n\u60a8\u53ef\u4ee5\u5728 [\u64cd\u4f5c\u6b77\u53f2\u8a18\u9304](https://cloud.google.com/kubernetes-engine/docs/how-to/node-auto-repair?hl=zh-cn#node_repair_history) \u4e2d\u67e5\u770b\u4fee\u5fa9\u72c0\u614b\uff08\u5305\u62ec\u5931\u6557\u539f\u56e0\uff09\u3002\u5982\u679c\u5931\u6557\u662f\u914d\u984d\u4e0d\u8db3\u9020\u6210\u7684\uff0c\u8acb\u8207\u60a8\u7684 Google Cloud \u5ba2\u6236\u4ee3\u8868\u806f\u7e6b\uff0c\u4ee5\u589e\u52a0\u76f8\u61c9\u7684\u914d\u984d\u3002\n### \u53ef\u89c0\u6e2c\u6027\u548c\u6307\u6a19\n\u5728 GKE 1.27.4-gke.900 \u7248\u6216\u66f4\u9ad8\u7248\u672c\u4e2d\uff0c\u4f7f\u7528 JAX [0.4.14](https://github.com/google/jax/releases/tag/jaxlib-v0.4.14) \u7248\u6216\u66f4\u9ad8\u7248\u672c\u4e26\u5c07 `containerPort: 8431` \u5c0e\u51fa TPU \u5229\u7528\u7387\u6307\u6a19\u6307\u5b9a\u7232 GKE [\u7cfb\u7d71\u6307\u6a19](https://cloud.google.com/stackdriver/docs/solutions/gke/managing-metrics?hl=zh-cn#system-metrics) \u7684 TPU \u5de5\u4f5c\u8ca0\u8f09\u3002 Cloud Monitoring \u63d0\u4f9b\u4ee5\u4e0b\u6307\u6a19\u4f86\u76e3\u63a7 TPU \u5de5\u4f5c\u8ca0\u8f09\u7684\u904b\u884c\u6642\u6027\u80fd\uff1a\n- \u5de5\u4f5c\u9031\u671f\uff1aTensorCore \u5728 TPU \u82af\u7247\u4e0a\u4e3b\u52d5\u8655\u7406\u7684\u6642\u9593\u4f54\u904e\u53bb\u7684\u63a1\u6a23\u9031\u671f\uff0860 \u79d2\uff09\u7684\u767e\u5206\u6bd4\u3002\u767e\u5206\u6bd4\u8d8a\u9ad8\uff0cTPU \u5229\u7528\u7387\u8d8a\u9ad8\u3002\n- \u5df2\u4f7f\u7528\u7684\u5167\u5b58\uff1a\u5df2\u5206\u914d\u7684\u52a0\u901f\u5668\u5167\u5b58\u91cf\uff08\u4ee5\u5b57\u7bc0\u7232\u55ae\u4f4d\uff09\u3002\u6bcf 60 \u79d2\u63a1\u6a23\u4e00\u6b21\u3002\n- \u5167\u5b58\u7e3d\u91cf\uff1a\u52a0\u901f\u5668\u5167\u5b58\u7e3d\u91cf\uff08\u4ee5\u5b57\u7bc0\u7232\u55ae\u4f4d\uff09\u3002\u6bcf 60 \u79d2\u63a1\u6a23\u4e00\u6b21\u3002\n\u9019\u4e9b\u6307\u6a19\u4f4d\u65bc Kubernetes \u7bc0\u9ede ( `k8s_node` ) \u548c Kubernetes \u5bb9\u5668 ( `k8s_container` ) \u67b6\u69cb\u4e2d\u3002\nKubernetes \u5bb9\u5668\uff1a\n- `kubernetes.io/container/accelerator/duty_cycle`\n- `kubernetes.io/container/accelerator/memory_used`\n- `kubernetes.io/container/accelerator/memory_total`\nKubernetes \u7bc0\u9ede\uff1a\n- `kubernetes.io/node/accelerator/duty_cycle`\n- `kubernetes.io/node/accelerator/memory_used`\n- `kubernetes.io/node/accelerator/memory_total`\u5728 GKE 1.28.1-gke.1066000 \u6216\u66f4\u9ad8\u7248\u672c\u4e2d\uff0cTPU \u865b\u64ec\u6a5f\u5c07 TPU \u5229\u7528\u7387\u6307\u6a19\u5c0e\u51fa\u7232 GKE [\u7cfb\u7d71\u6307\u6a19](https://cloud.google.com/stackdriver/docs/solutions/gke/managing-metrics?hl=zh-cn#system-metrics) \u3002Cloud Monitoring \u63d0\u4f9b\u4ee5\u4e0b\u6307\u6a19\u4f86\u76e3\u63a7 TPU \u4e3b\u6a5f\u7684\u6027\u80fd\uff1a\n- TensorCore \u5229\u7528\u7387\uff1a\u7576\u524d\u4f7f\u7528\u7684 TensorCore \u767e\u5206\u6bd4\u3002TensorCore \u503c\u7b49\u65bc [\u77e9\u9663\u4e58\u6cd5\u55ae\u5143 (MXU) \u52a0\u4e0a\u77e2\u91cf\u55ae\u4f4d](https://cloud.google.com/tpu/docs/system-architecture-tpu-vm?hl=zh-cn#tpu_chip) \u7684\u7e3d\u548c\u3002TensorCore \u5229\u7528\u7387\u503c\u662f\u904e\u53bb\u63a1\u6a23\u9031\u671f\uff0860 \u79d2\uff09\u5167\u57f7\u884c\u7684 TensorCore \u64cd\u4f5c\u6578\u91cf\u9664\u4ee5\u540c\u4e00\u9031\u671f\u5167\u652f\u6301\u7684 TensorCore \u64cd\u4f5c\u6578\u91cf\u3002\u503c\u8d8a\u5927\uff0c\u5229\u7528\u7387\u8d8a\u9ad8\u3002\n- \u5167\u5b58\u5e36\u5bec\u5229\u7528\u7387\uff1a\u6b63\u5728\u4f7f\u7528\u7684\u52a0\u901f\u5668\u5167\u5b58\u5e36\u5bec\u7684\u7576\u524d\u767e\u5206\u6bd4\u3002\u8a08\u7b97\u65b9\u6cd5\u662f\u5c07\u63a1\u6a23\u9031\u671f\uff0860 \u79d2\uff09\u5167\u4f7f\u7528\u7684\u5167\u5b58\u5e36\u5bec\u9664\u4ee5\u540c\u4e00\u63a1\u6a23\u9031\u671f\u652f\u6301\u7684\u6700\u5927\u5e36\u5bec\u3002\n\u9019\u4e9b\u6307\u6a19\u4f4d\u65bc Kubernetes \u7bc0\u9ede ( `k8s_node` ) \u548c Kubernetes \u5bb9\u5668 ( `k8s_container` ) \u67b6\u69cb\u4e2d\u3002\nKubernetes \u5bb9\u5668\uff1a\n- `kubernetes.io/container/accelerator/tensorcore_utilization`\n- `kubernetes.io/container/accelerator/memory_bandwidth_utilization`\nKubernetes \u7bc0\u9ede\uff1a\n- `kubernetes.io/container/node/tensorcore_utilization`\n- `kubernetes.io/container/node/memory_bandwidth_utilization`\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [Kubernetes \u6307\u6a19](https://cloud.google.com/monitoring/api/metrics_kubernetes?hl=zh-cn#kubernetes-kubernetes) \u548c [GKE \u7cfb\u7d71\u6307\u6a19](https://cloud.google.com/stackdriver/docs/solutions/gke/managing-metrics?hl=zh-cn#system-metrics) \u3002\n### \u5728\u7121\u7279\u6b0a\u6a21\u5f0f\u4e0b\u904b\u884c\u5bb9\u5668\n**\u6ce8\u610f** \uff1a\u5728 GKE 1.28 \u6216\u66f4\u9ad8\u7248\u672c\u7684\u7bc0\u9ede\u4e2d\u904b\u884c\u7684\u5bb9\u5668\u4e0d\u9700\u8981\u5553\u7528\u7279\u6b0a\u6a21\u5f0f\u4f86\u8a2a\u554f TPU\u3002\n\u5982\u679c\u60a8\u7684 TPU \u7bc0\u9ede\u904b\u884c\u7684\u7248\u672c\u4f4e\u65bc 1.28\uff0c\u8acb\u95b1\u8b80\u4ee5\u4e0b\u90e8\u5206\uff1a\n\u5728 TPU \u865b\u64ec\u6a5f\u4e0a\u904b\u884c\u7684\u5bb9\u5668\u9700\u8981\u8a2a\u554f\u66f4\u9ad8\u7684\u9396\u5b9a\u5167\u5b58\u9650\u5236\uff0c\u4ee5\u4fbf\u9a45\u52d5\u7a0b\u5e8f\u53ef\u4ee5\u901a\u904e\u76f4\u63a5\u5167\u5b58\u8a2a\u554f (DMA) \u8207 TPU \u82af\u7247\u9032\u884c\u901a\u4fe1\u3002\u5982\u9700\u5be6\u73fe\u9019\u4e00\u76ee\u6a19\uff0c\u60a8\u5fc5\u9808\u914d\u7f6e\u66f4\u9ad8\u7684 [ulimit](https://ss64.com/bash/ulimit.html) \u3002\u5982\u679c\u8981\u7e2e\u5c0f\u5bb9\u5668\u7684\u6b0a\u9650\u7bc4\u570d\uff0c\u8acb\u5b8c\u6210\u4ee5\u4e0b\u6b65\u9a5f\uff1a\n- \u4fee\u6539 `securityContext` \u4ee5\u5305\u542b\u4ee5\u4e0b\u5b57\u6bb5\uff1a```\nsecurityContext:\u00a0 capabilities:\u00a0 \u00a0 add: [\"SYS_RESOURCE\"]\n```\n- \u5728\u8a2d\u7f6e\u5de5\u4f5c\u8ca0\u8f09\u4ee5\u4f7f\u7528 TPU \u8cc7\u6e90\u4e4b\u524d\uff0c\u8acb\u5728\u5bb9\u5668\u5167\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4f86\u589e\u52a0 `ulimit` \uff1a```\nulimit -l 68719476736\n```\n**\u6ce8\u610f** \uff1a\u5c0d\u65bc TPU v5e\uff0c\u904b\u884c 1.27.4-gke.900 \u7248\u53ca\u66f4\u9ad8\u7248\u672c\u7684\u96c6\u7fa3\u53ef\u4ee5\u5728\u7121\u7279\u6b0a\u6a21\u5f0f\u4e0b\u904b\u884c\u5bb9\u5668\u3002\n## \u5df2\u77e5\u554f\u984c\n- \u5728\u65b0\u7684 TPU \u7bc0\u9ede\u5831\u544a\u53ef\u7528 TPU \u4e4b\u524d\uff0c\u96c6\u7fa3\u81ea\u52d5\u64f4\u7e2e\u5668\u53ef\u80fd\u6703\u932f\u8aa4\u5730\u8a08\u7b97\u9019\u4e9b TPU \u7bc0\u9ede\u7684\u5bb9\u91cf\u3002\u7136\u5f8c\uff0c\u96c6\u7fa3\u81ea\u52d5\u64f4\u7e2e\u5668\u53ef\u80fd\u6703\u57f7\u884c\u984d\u5916\u7684\u64f4\u5bb9\uff0c\u56e0\u6b64\u5275\u5efa\u8d85\u51fa\u9700\u8981\u7684\u7bc0\u9ede\u3002\u96c6\u7fa3\u81ea\u52d5\u64f4\u7e2e\u5668\u6703\u5728\u5e38\u898f\u7e2e\u5bb9\u64cd\u4f5c\u5f8c\u7e2e\u5bb9\u984d\u5916\u7684\u7bc0\u9ede\uff08\u5982\u679c\u4e0d\u9700\u8981\uff09\u3002\n- \u96c6\u7fa3\u81ea\u52d5\u64f4\u7e2e\u5668\u6703\u53d6\u6d88\u64f4\u5bb9\u8655\u65bc\u7b49\u5f85\u72c0\u614b\u8d85\u904e 15 \u5206\u9418\u7684 TPU \u7bc0\u9ede\u6c60\u3002\u96c6\u7fa3\u81ea\u52d5\u64f4\u7e2e\u5668\u7a0d\u5f8c\u5c07\u91cd\u8a66\u6b64\u985e\u64f4\u5bb9\u64cd\u4f5c\u3002\u5c0d\u65bc\u4e0d\u4f7f\u7528\u9810\u7559\u7684\u5ba2\u6236\uff0c\u6b64\u884c\u7232\u53ef\u80fd\u6703\u964d\u4f4e TPU \u53ef\u7372\u53d6\u6027\u3002\n- \u5bb9\u5fcd TPU \u6c61\u9ede\u7684\u975e TPU \u5de5\u4f5c\u8ca0\u8f09\u53ef\u80fd\u6703\u963b\u6b62\u7e2e\u5bb9\u5728\u6392\u7a7a TPU \u7bc0\u9ede\u6c60\u671f\u9593\u91cd\u65b0\u5275\u5efa\u7684\u7bc0\u9ede\u6c60\u3002## \u5f8c\u7e8c\u6b65\u9a5f\n- [\u5728 TPU \u4e0a\u4f7f\u7528 Saxml \u63d0\u4f9b\u5927\u8a9e\u8a00\u6a21\u578b](https://cloud.google.com/kubernetes-engine/docs/tutorials/tpu-multihost-saxml?hl=zh-cn) \n- [\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u4f7f\u7528 TPU \u5728 GKE \u4e0a\u8a2d\u7f6e Ray](https://github.com/GoogleCloudPlatform/ai-on-gke/blob/main/ray-on-gke/TPU_guide.md#tpu-user-guide) \n- [\u5229\u7528 GKE \u5728 Cloud TPU \u4e0a\u69cb\u5efa\u5927\u898f\u6a21\u7684\u6a5f\u5668\u5b78\u7fd2](https://www.youtube.com/watch?v=wtKhG1aTgtY&hl=zh-cn) \n- [\u5728 TPU \u4e0a\u4f7f\u7528 KubeRay \u63d0\u4f9b\u5927\u8a9e\u8a00\u6a21\u578b](https://www.youtube.com/watch?v=RK_u6cfPnnw&hl=zh-cn) \n- [\u6392\u67e5 GKE \u4e2d\u7684 TPU \u554f\u984c](https://cloud.google.com/kubernetes-engine/docs/troubleshooting/troubleshoot-tpus?hl=zh-cn)", "guide": "Google Kubernetes Engine (GKE)"}