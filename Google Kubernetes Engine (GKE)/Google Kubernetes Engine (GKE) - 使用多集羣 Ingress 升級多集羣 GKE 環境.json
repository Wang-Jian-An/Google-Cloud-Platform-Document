{"title": "Google Kubernetes Engine (GKE) - \u4f7f\u7528\u591a\u96c6\u7fa3 Ingress \u5347\u7d1a\u591a\u96c6\u7fa3 GKE \u74b0\u5883", "url": "https://cloud.google.com/kubernetes-engine/docs/tutorials/upgrading-multi-cluster-gke-environment-multi-cluster-ingress?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - \u4f7f\u7528\u591a\u96c6\u7fa3 Ingress \u5347\u7d1a\u591a\u96c6\u7fa3 GKE \u74b0\u5883\nLast reviewed 2022-12-15 UTC\n\u672c\u6559\u7a0b\u4ecb\u7d39\u77ad\u5982\u4f55\u4f7f\u7528 [\u591a\u96c6\u7fa3 Ingress](https://cloud.google.com/kubernetes-engine/docs/concepts/multi-cluster-ingress?hl=zh-cn) \u5347\u7d1a\u591a\u96c6\u7fa3 Google Kubernetes Engine (GKE) \u74b0\u5883\u3002\u672c\u6559\u7a0b\u662f [\u4f7f\u7528\u591a\u96c6\u7fa3 Ingress \u5347\u7d1a\u591a\u96c6\u7fa3 GKE \u6587\u6a94](https://cloud.google.com/kubernetes-engine/docs/concepts/multi-cluster-gke-upgrades-multi-cluster-ingress?hl=zh-cn) \u7684\u5ef6\u7e8c\uff0c\u66f4\u8a73\u7d30\u5730\u4ecb\u7d39\u4e86\u6b65\u9a5f\u3001\u67b6\u69cb\u548c\u8853\u8a9e\u3002\u6211\u5011\u5efa\u8b70\u60a8\u5148\u95b1\u8b80\u6982\u5ff5\u6587\u6a94\uff0c\u7136\u5f8c\u518d\u5b78\u7fd2\u672c\u6559\u7a0b\u3002\n\u5982\u9700\u67e5\u770b\u591a\u96c6\u7fa3 Ingress (MCI)\u3001\u591a\u96c6\u7fa3\u7db2\u95dc (MCG) \u8207\u4f7f\u7528\u7368\u7acb\u7db2\u7d61\u7aef\u9ede\u7d44\uff08LB \u548c\u7368\u7acb NEG\uff09\u7684\u8ca0\u8f09\u5747\u8861\u5668\u4e4b\u9593\u7684\u8a73\u7d30\u6bd4\u8f03\uff0c\u8acb\u53c3\u95b1 [\u9078\u64c7\u9069\u7528\u65bc GKE \u7684\u591a\u96c6\u7fa3\u8ca0\u8f09\u5747\u8861 API](https://cloud.google.com/kubernetes-engine/docs/concepts/choose-mc-lb-api?hl=zh-cn) \u3002\n\u672c\u6587\u6a94\u9069\u7528\u65bc\u8ca0\u8cac\u7dad\u8b77 GKE \u96c6\u7fa3\u8266\u968a\u7684 Google Cloud \u7ba1\u7406\u54e1\u3002\n\u6211\u5011\u5efa\u8b70\u81ea\u52d5\u5347\u7d1a GKE \u96c6\u7fa3\u3002\u81ea\u52d5\u5347\u7d1a\u662f\u4e00\u7a2e\u5168\u4ee3\u7ba1\u5f0f\u65b9\u6cd5\uff0c\u4f7f\u96c6\u7fa3\uff08\u63a7\u5236\u5c64\u9762\u548c\u7bc0\u9ede\uff09\u6839\u64da\u7531 Google Cloud \u78ba\u5b9a\u7684\u767c\u4f48\u6642\u9593\u8868\u81ea\u52d5\u66f4\u65b0\uff0c\u7121\u9700\u64cd\u4f5c\u8005\u9032\u884c\u4efb\u4f55\u5e72\u9810\u3002\u4f46\u662f\uff0c\u5982\u679c\u60a8\u60f3\u8981\u66f4\u597d\u5730\u63a7\u5236\u96c6\u7fa3\u7684\u5347\u7d1a\u65b9\u5f0f\u548c\u6642\u9593\uff0c\u672c\u6559\u7a0b\u5c07\u4ecb\u7d39\u5347\u7d1a\u61c9\u7528\u5728\u5176\u4e0a\u904b\u884c\u7684\u6240\u6709\u96c6\u7fa3\u7684\u65b9\u6cd5\u3002\u7136\u5f8c\uff0c\u5b83\u4f7f\u7528\u591a\u96c6\u7fa3 Ingress \u5728\u5347\u7d1a\u524d\u4e00\u6b21\u6392\u7a7a\u4e00\u500b\u96c6\u7fa3\u3002", "content": "## \u67b6\u69cb\u672c\u6559\u7a0b\u4f7f\u7528\u4ee5\u4e0b\u67b6\u69cb\u3002\u7e3d\u5171\u6709\u4e09\u500b\u96c6\u7fa3\uff1a\u5169\u500b\u96c6\u7fa3\uff08 `blue` \u548c `green` \uff09\u5145\u7576\u90e8\u7f72\u4e86\u540c\u4e00\u61c9\u7528\u7684\u76f8\u540c\u96c6\u7fa3\uff0c\u53e6\u4e00\u500b\u96c6\u7fa3 ( `ingress-config` ) \u5145\u7576\u914d\u7f6e\u591a\u96c6\u7fa3 Ingress \u7684\u63a7\u5236\u5c64\u9762\u96c6\u7fa3\u3002\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u9700\u8981\u5c07\u793a\u4f8b\u61c9\u7528\u90e8\u7f72\u5230\u5169\u500b\u61c9\u7528\u96c6\u7fa3\uff08 `blue` \u548c `green` \u96c6\u7fa3\uff09\u3002## \u76ee\u6a19\n- \u5275\u5efa\u4e09\u500b GKE \u96c6\u7fa3\uff0c\u4e26\u5c07\u5176\u8a3b\u518a\u7232\u8266\u968a\u3002\n- \u914d\u7f6e\u4e00\u500b GKE \u96c6\u7fa3 (`ingress-config`) \u4f5c\u7232\u4e2d\u592e\u914d\u7f6e\u96c6\u7fa3\u3002\n- \u5c07\u793a\u4f8b\u61c9\u7528\u90e8\u7f72\u5230\u5176\u4ed6 GKE \u96c6\u7fa3\u3002\n- \u914d\u7f6e\u591a\u96c6\u7fa3 Ingress\uff0c\u5c07\u5ba2\u6236\u7aef\u6d41\u91cf\u767c\u9001\u5230\u540c\u6642\u5728\u9019\u5169\u500b\u61c9\u7528\u96c6\u7fa3\u4e0a\u904b\u884c\u7684\u61c9\u7528\u3002\n- \u7232\u61c9\u7528\u8a2d\u7f6e\u8ca0\u8f09\u751f\u6210\u5668\u4e26\u914d\u7f6e\u76e3\u63a7\u3002\n- \u5f9e\u591a\u96c6\u7fa3 Ingress \u4e2d\u79fb\u9664\uff08\u6392\u7a7a\uff09\u4e00\u500b\u61c9\u7528\u96c6\u7fa3\uff0c\u4e26\u5347\u7d1a\u6392\u7a7a\u7684\u96c6\u7fa3\u3002\n- \u4f7f\u7528\u591a\u96c6\u7fa3 Ingress \u5c07\u6d41\u91cf\u9000\u56de\u5230\u5347\u7d1a\u5f8c\u7684\u96c6\u7fa3\u3002\n## \u8cbb\u7528\nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728\u672c\u6587\u6a94\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Google Cloud \u7684\u4ee5\u4e0b\u6536\u8cbb\u7d44\u4ef6\uff1a- [GKE](https://cloud.google.com/kubernetes-engine/pricing?hl=zh-cn) \n- [\u7db2\u7d61](https://cloud.google.com/vpc/network-pricing?hl=zh-cn#vpc-pricing) \n- [Cloud Load Balancing](https://cloud.google.com/vpc/network-pricing?hl=zh-cn#lb) \n\u60a8\u53ef\u4f7f\u7528 [\u50f9\u683c\u8a08\u7b97\u5668](https://cloud.google.com/products/calculator?hl=zh-cn) \u6839\u64da\u60a8\u7684\u9810\u8a08\u4f7f\u7528\u60c5\u6cc1\u4f86\u4f30\u7b97\u8cbb\u7528\u3002 \nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5b8c\u6210\u672c\u6587\u6a94\u4e2d\u63cf\u8ff0\u7684\u4efb\u52d9\u5f8c\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u522a\u9664\u6240\u5275\u5efa\u7684\u8cc7\u6e90\u4f86\u907f\u514d\u7e7c\u7e8c\u8a08\u8cbb\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u6e05\u7406](#clean-up) \u3002## \u6e96\u5099\u5de5\u4f5c- \u672c\u6559\u7a0b\u8981\u6c42\u60a8 [\u8a2d\u7f6e\u591a\u96c6\u7fa3 Ingress](https://cloud.google.com/kubernetes-engine/docs/how-to/multi-cluster-ingress-setup?hl=zh-cn#requirements_for) \uff0c\u4ee5\u5b8c\u6210\u4ee5\u4e0b\u8a2d\u7f6e\uff1a- \u5169\u500b\u6216\u66f4\u591a\u96c6\u7fa3\uff0c\u76f8\u540c\u7684\u61c9\u7528\uff08\u4f8b\u5982\u547d\u540d\u7a7a\u9593\u3001Deployment \u548c Service\uff09\u5728\u6240\u6709\u96c6\u7fa3\u4e0a\u904b\u884c\u3002\n- \u95dc\u9589\u6240\u6709\u96c6\u7fa3\u7684\u81ea\u52d5\u5347\u7d1a\u3002\n- \u96c6\u7fa3\u662f\u4f7f\u7528\u5225\u540d IP \u5730\u5740\u7bc4\u570d\u7684 [VPC \u539f\u751f\u96c6\u7fa3](https://cloud.google.com/kubernetes-engine/docs/how-to/alias-ips?hl=zh-cn) \n- \u5553\u7528 HTTP \u8ca0\u8f09\u5747\u8861\uff08\u9ed8\u8a8d\u5553\u7528\uff09\u3002\n- `gcloud --version`\u5fc5\u9808\u7232 369 \u6216\u66f4\u9ad8\u3002GKE \u96c6\u7fa3\u8a3b\u518a\u6b65\u9a5f\u4f9d\u8cf4\u65bc\u6b64\u7248\u672c\u6216\u66f4\u9ad8\u7248\u672c\u3002\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728 Google Cloud Console \u4e2d\u7684\u9805\u76ee\u9078\u64c7\u5668\u9801\u9762\u4e0a\uff0c\u9078\u64c7\u6216 [\u5275\u5efa\u4e00\u500b Google Cloud \u9805\u76ee](https://cloud.google.com/resource-manager/docs/creating-managing-projects?hl=zh-cn) \u3002 **\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u4e0d\u6253\u7b97\u4fdd\u7559\u5728\u6b64\u904e\u7a0b\u4e2d\u5275\u5efa\u7684\u8cc7\u6e90\uff0c\u8acb\u5275\u5efa\u65b0\u7684\u9805\u76ee\uff0c\u800c\u4e0d\u8981\u9078\u64c7\u73fe\u6709\u7684\u9805\u76ee\u3002\u5b8c\u6210\u672c\u6559\u7a0b\u4ecb\u7d39\u7684\u6b65\u9a5f\u5f8c\uff0c\u60a8\u53ef\u4ee5\u522a\u9664\u6240\u5275\u5efa\u7684\u9805\u76ee\uff0c\u4e26\u79fb\u9664\u8207\u8a72\u9805\u76ee\u95dc\u806f\u7684\u6240\u6709\u8cc7\u6e90\u3002 [\u8f49\u5230\u201c\u9805\u76ee\u9078\u64c7\u5668\u201d](https://console.cloud.google.com/projectselector2/home/dashboard?hl=zh-cn) \n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them [\u78ba\u4fdd\u60a8\u7684 Google Cloud \u9805\u76ee\u5df2\u5553\u7528\u7d50\u7b97\u529f\u80fd](https://cloud.google.com/billing/docs/how-to/verify-billing-enabled?hl=zh-cn#console) \u3002\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u6fc0\u6d3b Cloud Shell\u3002 [\u6fc0\u6d3b Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn) \n- \u8a2d\u7f6e\u9ed8\u8a8d\u9805\u76ee\uff1a```\nexport PROJECT=$(gcloud info --format='value(config.project)')gcloud config set project ${PROJECT}\n```\n- \u5553\u7528 GKE\u3001Hub \u548c `multiclusteringress` API\uff1a```\ngcloud services enable container.googleapis.com \\\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0gkehub.googleapis.com \\\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0multiclusteringress.googleapis.com \\\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0multiclusterservicediscovery.googleapis.com\n```\n## \u8a2d\u7f6e\u74b0\u5883\n- \u5728 Cloud Shell \u4e2d\uff0c\u514b\u9686\u4ee3\u78bc\u5eab\u4ee5\u7372\u53d6\u672c\u6559\u7a0b\u7684\u6587\u4ef6\uff1a```\ncd ${HOME}git clone https://github.com/GoogleCloudPlatform/gke-multicluster-upgrades.git\n```\n- \u5275\u5efa `WORKDIR` \u76ee\u9304\uff1a```\ncd gke-multicluster-upgradesexport WORKDIR=`pwd`\n```\n## \u5275\u5efa GKE \u96c6\u7fa3\u4e26\u5c07\u5176\u8a3b\u518a\u5230 Hub\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u5275\u5efa\u4e09\u500b GKE \u96c6\u7fa3\uff0c\u4e26\u5c07\u5b83\u5011\u8a3b\u518a\u5230 GKE Enterprise Hub\u3002\n### \u5275\u5efa GKE \u96c6\u7fa3\n- \u5728 Cloud Shell \u4e2d\uff0c\u5275\u5efa\u4e09\u500b GKE \u96c6\u7fa3\uff1a```\ngcloud container clusters create ingress-config --zone us-west1-a \\--release-channel=None --no-enable-autoupgrade --num-nodes=4 \\--enable-ip-alias --workload-pool=${PROJECT}.svc.id.goog --quiet --asyncgcloud container clusters create blue --zone us-west1-b --num-nodes=3 \\--release-channel=None --no-enable-autoupgrade --enable-ip-alias \\--workload-pool=${PROJECT}.svc.id.goog --quiet --asyncgcloud container clusters create green --zone us-west1-c --num-nodes=3 \\--release-channel=None --no-enable-autoupgrade --enable-ip-alias \\--workload-pool=${PROJECT}.svc.id.goog --quiet\n```\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u5728\u55ae\u500b\u5340\u57df\u7684\u4e09\u500b\u4e0d\u540c\u53ef\u7528\u5340\u4e2d\u5275\u5efa\u96c6\u7fa3\uff1a `us-west1-a` \u3001 `us-west1-b` \u548c `us-west1-c` \u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5340\u57df\u548c\u53ef\u7528\u5340\uff0c\u8acb\u53c3\u95b1 [\u5730\u7406\u4f4d\u7f6e\u548c\u5340\u57df](https://cloud.google.com/docs/geography-and-regions?hl=zh-cn) \u3002\n- \u7b49\u5f85\u5e7e\u5206\u9418\uff0c\u76f4\u5230\u6240\u6709\u96c6\u7fa3\u90fd\u6210\u529f\u5275\u5efa\u3002\u78ba\u4fdd\u9019\u4e9b\u96c6\u7fa3\u90fd\u5728\u904b\u884c\uff1a```\ngcloud container clusters list\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nNAME: ingress-config\nLOCATION: us-west1-a\nMASTER_VERSION: 1.22.8-gke.202\nMASTER_IP: 35.233.186.135\nMACHINE_TYPE: e2-medium\nNODE_VERSION: 1.22.8-gke.202\nNUM_NODES: 4\nSTATUS: RUNNING\nNAME: blue\nLOCATION: us-west1-b\nMASTER_VERSION: 1.22.8-gke.202\nMASTER_IP: 34.82.35.222\nMACHINE_TYPE: e2-medium\nNODE_VERSION: 1.22.8-gke.202\nNUM_NODES: 3\nSTATUS: RUNNING\nNAME: green\nLOCATION: us-west1-c\nMASTER_VERSION: 1.22.8-gke.202\nMASTER_IP: 35.185.204.26\nMACHINE_TYPE: e2-medium\nNODE_VERSION: 1.22.8-gke.202\nNUM_NODES: 3\nSTATUS: RUNNING\n```\n- \u5275\u5efa [kubeconfig](https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/) \u6587\u4ef6\u4e26\u9023\u63a5\u5230\u6240\u6709\u96c6\u7fa3\uff0c\u4ee5\u5728 `kubeconfig` \u6587\u4ef6\u4e2d\u751f\u6210\u689d\u76ee\uff1a```\ntouch gke-upgrade-kubeconfigexport KUBECONFIG=gke-upgrade-kubeconfiggcloud container clusters get-credentials ingress-config \\\u00a0 \u00a0 --zone us-west1-a --project ${PROJECT}gcloud container clusters get-credentials blue --zone us-west1-b \\\u00a0 \u00a0 --project ${PROJECT}gcloud container clusters get-credentials green --zone us-west1-c \\\u00a0 \u00a0 --project ${PROJECT}\n```\u4f7f\u7528 [kubeconfig](https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/) \u6587\u4ef6\u7232\u6bcf\u500b\u96c6\u7fa3\u5275\u5efa\u7528\u6236\u548c\u4e0a\u4e0b\u6587\uff0c\u5f9e\u800c\u5275\u5efa\u91dd\u5c0d\u96c6\u7fa3\u7684\u8eab\u4efd\u9a57\u8b49\u3002\u5275\u5efa `kubeconfig` \u6587\u4ef6\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5feb\u901f\u5207\u63db\u96c6\u7fa3\u4e4b\u9593\u7684\u4e0a\u4e0b\u6587\u3002\n- \u9a57\u8b49 `kubeconfig` \u6587\u4ef6\u4e2d\u6709\u4e09\u500b\u96c6\u7fa3\uff1a```\nkubectl config view -ojson | jq -r '.clusters[].name'\n```\u8f38\u51fa\u5982\u4e0b\u6240\u793a\uff1a```\ngke_gke-multicluster-upgrades_us-west1-a_ingress-config\ngke_gke-multicluster-upgrades_us-west1-b_blue\ngke_gke-multicluster-upgrades_us-west1-c_green\n```\n- \u7372\u53d6\u4e09\u500b\u96c6\u7fa3\u7684\u4e0a\u4e0b\u6587\u4f9b\u7a0d\u5f8c\u4f7f\u7528\uff1a```\nexport INGRESS_CONFIG_CLUSTER=$(kubectl config view -ojson | jq \\\u00a0 \u00a0 -r '.clusters[].name' | grep ingress-config)export BLUE_CLUSTER=$(kubectl config view -ojson | jq \\\u00a0 \u00a0 -r '.clusters[].name' | grep blue)export GREEN_CLUSTER=$(kubectl config view -ojson | jq \\\u00a0 \u00a0 -r '.clusters[].name' | grep green)echo -e \"${INGRESS_CONFIG_CLUSTER}\\n${BLUE_CLUSTER}\\n${GREEN_CLUSTER}\"\n```\u8f38\u51fa\u5982\u4e0b\u6240\u793a\uff1a```\ngke_gke-multicluster-upgrades_us-west1-a_ingress-config\ngke_gke-multicluster-upgrades_us-west1-b_blue\ngke_gke-multicluster-upgrades_us-west1-c_green\n```\n### \u5c07 GKE \u96c6\u7fa3\u8a3b\u518a\u5230\u8266\u968a\u901a\u904e\u5c07\u96c6\u7fa3\u8a3b\u518a\u5230\u8266\u968a\uff0c\u60a8\u53ef\u4ee5\u5728\u6df7\u5408\u74b0\u5883\u4e2d\u904b\u7dad Kubernetes \u96c6\u7fa3\u3002\u8a3b\u518a\u5230\u8266\u968a\u7684\u96c6\u7fa3\u53ef\u4ee5\u4f7f\u7528\u9ad8\u7d1a GKE \u529f\u80fd\uff0c\u4f8b\u5982\u591a\u96c6\u7fa3 Ingress\u3002\u5982\u9700\u5411\u8266\u968a\u8a3b\u518a GKE \u96c6\u7fa3\uff0c\u60a8\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 Google Cloud \u670d\u52d9\u8cec\u865f\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u63a8\u85a6\u7684 [Workload Identity](https://cloud.google.com/kubernetes-engine/docs/concepts/workload-identity?hl=zh-cn) \u65b9\u6cd5\uff0c\u6b64\u65b9\u6cd5\u5141\u8a31 GKE \u96c6\u7fa3\u4e2d\u7684Kubernetes \u670d\u52d9\u8cec\u865f\u5145\u7576 Identity and Access Management \u670d\u52d9\u8cec\u865f\u3002- \u5c07\u4e09\u500b\u96c6\u7fa3\u8a3b\u518a\u7232\u8266\u968a\uff1a```\ngcloud container fleet memberships register ingress-config \\\u00a0 \u00a0 --gke-cluster=us-west1-a/ingress-config \\\u00a0 \u00a0 --enable-workload-identitygcloud container fleet memberships register blue \\\u00a0 \u00a0 --gke-cluster=us-west1-b/blue \\\u00a0 \u00a0 --enable-workload-identitygcloud container fleet memberships register green \\\u00a0 \u00a0 --gke-cluster=us-west1-c/green \\\u00a0 \u00a0 --enable-workload-identity\n```\n- \u9a57\u8b49\u96c6\u7fa3\u662f\u5426\u5df2\u8a3b\u518a\uff1a```\ngcloud container fleet memberships list\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nNAME: blue\nEXTERNAL_ID: 401b4f08-8246-4f97-a6d8-cf1b78c2a91d\nNAME: green\nEXTERNAL_ID: 8041c36a-9d42-40c8-a67f-54fcfd84956e\nNAME: ingress-config\nEXTERNAL_ID: 65ac48fe-5043-42db-8b1e-944754a0d725\n```\n- \u901a\u904e Hub \u5553\u7528 `multiclusteringress` \u529f\u80fd\uff0c\u5c07 `ingress-config` \u96c6\u7fa3\u914d\u7f6e\u7232\u591a\u96c6\u7fa3 Ingress \u7684\u914d\u7f6e\u96c6\u7fa3\uff1a```\ngcloud container fleet ingress enable --config-membership=ingress-config\n```\u4e0a\u8ff0\u547d\u4ee4\u5c07 `MulticlusterIngress` \u548c `MulticlusterService` [CRD\uff08\u81ea\u5b9a\u7fa9\u8cc7\u6e90\u5b9a\u7fa9\uff09](https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/) \u6dfb\u52a0\u5230 `ingress-config` \u96c6\u7fa3\u3002\u6b64\u547d\u4ee4\u9700\u8981\u5e7e\u5206\u9418\u624d\u80fd\u5b8c\u6210\u3002\u8acb\u7b49\u5f85\u547d\u4ee4\u5b8c\u6210\uff0c\u7136\u5f8c\u518d\u7e7c\u7e8c\u4e0b\u4e00\u6b65\u3002\n- \u9a57\u8b49\u662f\u5426\u7232\u591a\u96c6\u7fa3 Ingress \u6210\u529f\u914d\u7f6e\u4e86 `ingress-cluster` \u96c6\u7fa3\uff1a```\nwatch gcloud container fleet ingress describe\n```\u7b49\u5f85\u76f4\u81f3\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\ncreateTime: '2022-07-05T10:21:40.383536315Z'\nmembershipStates:\n projects/662189189487/locations/global/memberships/blue:\n state:\n  code: OK\n  updateTime: '2022-07-08T10:59:44.230329189Z'\n projects/662189189487/locations/global/memberships/green:\n state:\n  code: OK\n  updateTime: '2022-07-08T10:59:44.230329950Z'\n projects/662189189487/locations/global/memberships/ingress-config:\n state:\n  code: OK\n  updateTime: '2022-07-08T10:59:44.230328520Z'\nname: projects/gke-multicluster-upgrades/locations/global/features/multiclusteringress\nresourceState:\n state: ACTIVE\nspec:\n multiclusteringress:\n configMembership: projects/gke-multicluster-upgrades/locations/global/memberships/ingress-config\nstate:\n state:\n code: OK\n description: Ready to use\n updateTime: '2022-07-08T10:57:33.303543609Z'\nupdateTime: '2022-07-08T10:59:45.247576318Z'\n``` **\u6ce8\u610f** \uff1a\u6b64\u529f\u80fd\u53ea\u6709\u5728\u914d\u7f6e\u96c6\u7fa3\u8655\u65bc `OK` \u72c0\u614b\u4e4b\u5f8c\u7e94\u53ef\u4ee5\u4f7f\u7528\u3002\u5982\u679c\u60a8\u5728\u5e7e\u5206\u9418\u5f8c\u672a\u770b\u5230 `code: OK` \uff0c\u8acb\u8f49\u5230 [\u554f\u984c\u6392\u67e5\u90e8\u5206](https://cloud.google.com/kubernetes-engine/docs/how-to/troubleshooting-and-ops?hl=zh-cn) \u3002\u8981\u9000\u51fa `watch` \u547d\u4ee4\uff0c\u8acb\u6309 **Control+C** \u3002\n## \u5c07\u793a\u4f8b\u61c9\u7528\u90e8\u7f72\u5230\u85cd\u8272\u548c\u7da0\u8272\u96c6\u7fa3\n- \u5728 Cloud Shell \u4e2d\uff0c\u5c07\u793a\u4f8b `whereami` \u61c9\u7528\u90e8\u7f72\u5230 `blue` \u548c `green` \u96c6\u7fa3\uff1a```\nkubectl --context ${BLUE_CLUSTER} apply -f ${WORKDIR}/application-manifestskubectl --context ${GREEN_CLUSTER} apply -f ${WORKDIR}/application-manifests\n```\n- \u7b49\u5f85\u5e7e\u5206\u9418\uff0c\u4e26\u78ba\u4fdd `blue` \u548c `green` \u96c6\u7fa3\u4e2d\u7684\u6240\u6709 pod \u90fd\u7232 `Running` \u72c0\u614b\uff1a```\nkubectl --context ${BLUE_CLUSTER} get podskubectl --context ${GREEN_CLUSTER} get pods\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nNAME         READY STATUS RESTARTS AGE\nwhereami-deployment-756c7dc74c-zsmr6 1/1  Running 0   74s\nNAME         READY STATUS RESTARTS AGE\nwhereami-deployment-756c7dc74c-sndz7 1/1  Running 0   68s.\n```\n## \u914d\u7f6e\u591a\u96c6\u7fa3 Ingress\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u5275\u5efa\u4e00\u500b\u591a\u96c6\u7fa3 Ingress\uff0c\u4ee5\u5c07\u6d41\u91cf\u767c\u9001\u5230 `blue` \u548c `green` \u96c6\u7fa3\u4e0a\u904b\u884c\u7684\u61c9\u7528\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528 [Cloud Load Balancing](https://cloud.google.com/load-balancing/docs/load-balancing-overview?hl=zh-cn) \u5275\u5efa\u8ca0\u8f09\u5747\u8861\u5668\uff0c\u4ee5\u5c07 `blue` \u548c `green` \u96c6\u7fa3\u4e2d\u7684 `whereami` \u7528\u4f5c\u5f8c\u7aef\u3002\u5982\u9700\u5275\u5efa\u8ca0\u8f09\u5747\u8861\u5668\uff0c\u60a8\u9700\u8981\u5169\u500b\u8cc7\u6e90\uff1a\u4e00\u500b `MultiClusterIngress` \u4ee5\u53ca\u4e00\u500b\u6216\u591a\u500b `MultiClusterServices` \u3002 `MultiClusterIngress` \u548c `MultiClusterService` \u5c0d\u8c61\u662f\u591a\u96c6\u7fa3\u6a21\u64ec\uff0c\u985e\u4f3c\u65bc\u5728\u55ae\u500b\u96c6\u7fa3\u4e0a\u4e0b\u6587\u4e2d\u4f7f\u7528\u7684\u73fe\u6709 Kubernetes Ingress \u548c Service \u8cc7\u6e90\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u5c07 `MulticlusterIngress` \u8cc7\u6e90\u90e8\u7f72\u5230 `ingress-config` \u96c6\u7fa3\uff1a```\nkubectl --context ${INGRESS_CONFIG_CLUSTER} apply -f ${WORKDIR}/multicluster-manifests/mci.yaml\n```\u8f38\u51fa\u5982\u4e0b\u6240\u793a\uff1a```\nmulticlusteringress.networking.gke.io/whereami-mci created\n```\n- \u5c07 `MulticlusterService` \u8cc7\u6e90\u90e8\u7f72\u5230 `ingress-config` \u96c6\u7fa3\uff1a```\nkubectl --context ${INGRESS_CONFIG_CLUSTER} apply -f ${WORKDIR}/multicluster-manifests/mcs-blue-green.yaml\n```\u8f38\u51fa\u5982\u4e0b\u6240\u793a\uff1a```\nmulticlusterservice.networking.gke.io/whereami-mcs created\n```\n- \u8981\u6bd4\u8f03\u9019\u5169\u7a2e\u8cc7\u6e90\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u6aa2\u67e5 `MulticlusterIngress` \u8cc7\u6e90\uff1a```\nkubectl --context ${INGRESS_CONFIG_CLUSTER} get multiclusteringress -o yaml\n```\u8f38\u51fa\u5305\u542b\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nspec:\n template:\n spec:\n  backend:\n  serviceName: whereami-mcs\n  servicePort: 8080\n````MulticlusterIngress` \u8cc7\u6e90\u8207 Kubernetes Ingress \u8cc7\u6e90\u985e\u4f3c\uff0c\u4f46 `serviceName` \u898f\u7bc4\u6307\u5411 `MulticlusterService` \u8cc7\u6e90\u3002\n- \u6aa2\u67e5 `MulticlusterService` \u8cc7\u6e90\uff1a```\nkubectl --context ${INGRESS_CONFIG_CLUSTER} get multiclusterservice -o yaml\n```\u8f38\u51fa\u5305\u542b\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nspec:\n clusters:\n - link: us-west1-b/blue\n - link: us-west1-c/green\n template:\n spec:\n  ports:\n  - name: web\n  port: 8080\n  protocol: TCP\n  targetPort: 8080\n  selector:\n  app: whereami\n````MulticlusterService` \u8cc7\u6e90\u8207 Kubernetes \u670d\u52d9\u8cc7\u6e90\u985e\u4f3c\uff0c\u4f46\u5b83\u6709 `clusters` \u898f\u7bc4\u3002 `clusters` \u503c\u662f\u5728\u5176\u4e2d\u5275\u5efa `MulticlusterService` \u8cc7\u6e90\u7684\u5df2\u8a3b\u518a\u96c6\u7fa3\u7684\u5217\u8868\n- \u9a57\u8b49 `MulticlusterIngress` \u8cc7\u6e90\u662f\u5426\u5df2\u5275\u5efa\u5f8c\u7aef\u670d\u52d9\u6307\u5411 `MulticlusterService` \u8cc7\u6e90\u7684\u8ca0\u8f09\u5747\u8861\u5668\uff1a```\nwatch kubectl --context ${INGRESS_CONFIG_CLUSTER} \\\u00a0 \u00a0 \u00a0 get multiclusteringress -o jsonpath=\"{.items[].status.VIP}\"\n```\u6b64\u904e\u7a0b\u6700\u9577\u53ef\u80fd\u9700\u8981 10 \u5206\u9418\u3002 \u7b49\u5f85\u76f4\u81f3\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\n34.107.246.9\n```\u5982\u9700\u9000\u51fa `watch` \u547d\u4ee4\uff0c\u8acb\u6309 `Control+C` \u3002\n- \u5728 Cloud Shell \u4e2d\uff0c\u7372\u53d6 Cloud Load Balancing VIP\uff1a```\nexport GCLB_VIP=$(kubectl --context ${INGRESS_CONFIG_CLUSTER} \\\u00a0 \u00a0 \u00a0 \u00a0get multiclusteringress -o json | jq -r '.items[].status.VIP') \\\u00a0 \u00a0 \u00a0 \u00a0&& echo ${GCLB_VIP}\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\n34.107.246.9\n```\n- \u4f7f\u7528 `curl` \u8a2a\u554f\u8ca0\u8f09\u5747\u8861\u5668\u548c\u5df2\u90e8\u7f72\u7684\u61c9\u7528\uff1a```\ncurl ${GCLB_VIP}\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\n{\n \"cluster_name\": \"green\",\n \"host_header\": \"34.107.246.9\",\n \"pod_name\": \"whereami-deployment-756c7dc74c-sndz7\",\n \"pod_name_emoji\": \"\ud83d\ude07\",\n \"project_id\": \"gke-multicluster-upgrades\",\n \"timestamp\": \"2022-07-08T14:26:07\",\n \"zone\": \"us-west1-c\"\n}\n```\n- \u91cd\u8907\u904b\u884c `curl` \u547d\u4ee4\u3002\u8acb\u6ce8\u610f\uff0c\u8acb\u6c42\u6b63\u5728\u90e8\u7f72\u5230\u5169\u500b\u96c6\u7fa3\uff08 `blue` \u548c `green` \uff09\u7684 `whereami` \u61c9\u7528\u4e4b\u9593\u9032\u884c\u8ca0\u8f09\u5747\u8861\u3002\n## \u8a2d\u7f6e\u8ca0\u8f09\u751f\u6210\u5668\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u8a2d\u7f6e `loadgenerator` Service\uff0c\u4ee5\u5411 Cloud Load Balancing VIP \u751f\u6210\u5ba2\u6236\u7aef\u6d41\u91cf\u3002\u9996\u5148\uff0c\u6d41\u91cf\u6703\u88ab\u9aee\u9001\u5230 `blue` \u548c `green` \u96c6\u7fa3\uff0c\u56e0\u7232 `MulticlusterService` \u8cc7\u6e90\u88ab\u8a2d\u7f6e\u7232\u540c\u6642\u5411\u9019\u5169\u500b\u96c6\u7fa3\u767c\u9001\u6d41\u91cf\u3002\u7a0d\u5f8c\uff0c\u60a8\u5c07\u914d\u7f6e `MulticlusterService` \u8cc7\u6e90\u4ee5\u5c07\u6d41\u91cf\u767c\u9001\u5230\u55ae\u500b\u96c6\u7fa3\u3002- \u914d\u7f6e `loadgenerator` \u6e05\u55ae\u4ee5\u5c07\u5ba2\u6236\u7aef\u6d41\u91cf\u767c\u9001\u5230 Cloud Load Balancing\uff1a```\nTEMPLATE=loadgen-manifests/loadgenerator.yaml.templ && envsubst < ${TEMPLATE} > ${TEMPLATE%.*}\n```\n- \u5728 `ingress-config` \u96c6\u7fa3\u4e2d\u90e8\u7f72 `loadgenerator` \uff1a```\nkubectl --context ${INGRESS_CONFIG_CLUSTER} apply -f ${WORKDIR}/loadgen-manifests\n```\n- \u9a57\u8b49 `ingress-config` \u96c6\u7fa3\u4e2d\u7684 `loadgenerator` pod \u662f\u5426\u7232 `Running` \u72c0\u614b\uff1a```\nkubectl --context ${INGRESS_CONFIG_CLUSTER} get pods\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nNAME        READY STATUS RESTARTS AGE\nloadgenerator-5498cbcb86-hqscp 1/1  Running 0   53s\nloadgenerator-5498cbcb86-m2z2z 1/1  Running 0   53s\nloadgenerator-5498cbcb86-p56qb 1/1  Running 0   53s\n```\u5982\u679c\u4efb\u4f55 pod \u7684\u72c0\u614b\u4e0d\u662f `Running` \uff0c\u8acb\u7b49\u5f85\u5e7e\u5206\u9418\uff0c\u7136\u5f8c\u518d\u6b21\u904b\u884c\u8a72\u547d\u4ee4\u3002\n## \u76e3\u6e2c\u6d41\u91cf\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Google Cloud \u63a7\u5236\u6aaf\u76e3\u63a7\u767c\u9001\u5230 `whereami` \u61c9\u7528\u7684\u6d41\u91cf\u3002\n\u5728\u4e0a\u4e00\u90e8\u5206\u4e2d\uff0c\u60a8\u8a2d\u7f6e\u4e86 `loadgenerator` \u90e8\u7f72\uff0c\u4ee5\u901a\u904e Cloud Load Balancing VIP \u8a2a\u554f `whereami` \u61c9\u7528\u4f86\u6a21\u64ec\u5ba2\u6236\u7aef\u6d41\u91cf\u3002\u60a8\u53ef\u4ee5\u901a\u904e Google Cloud \u63a7\u5236\u6aaf\u76e3\u63a7\u9019\u4e9b\u6307\u6a19\u3002\u60a8\u9996\u5148\u8a2d\u7f6e\u76e3\u63a7\uff0c\u4ee5\u4fbf\u53ef\u4ee5\u5728\u6392\u7a7a\u96c6\u7fa3\u4ee5\u9032\u884c\u5347\u7d1a\u6642\u9032\u884c\u76e3\u63a7\uff08\u4e0b\u4e00\u90e8\u5206\u6703\u5c0d\u6b64\u9032\u884c\u8aaa\u660e\uff09\u3002- \u5275\u5efa\u4fe1\u606f\u4e2d\u5fc3\u4ee5\u986f\u793a\u5230\u9054\u591a\u96c6\u7fa3 Ingress \u7684\u6d41\u91cf\uff1a```\nexport DASH_ID=$(gcloud monitoring dashboards create \\\u00a0 \u00a0 --config-from-file=dashboards/cloud-ops-dashboard.json \\\u00a0 \u00a0 --format=json | jq \u00a0-r \".name\" | awk -F '/' '{print $4}')\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nCreated [721b6c83-8f9b-409b-a009-9fdf3afb82f8]\n```\n- Google Cloud \u63a7\u5236\u6aaf\u4e2d\u63d0\u4f9b\u4f86\u81ea Cloud Load Balancing \u7684\u6307\u6a19\u3002\u751f\u6210\u7db2\u5740\uff1a```\necho \"https://console.cloud.google.com/monitoring/dashboards/builder/${DASH_ID}/?project=${PROJECT}&timeDomain=1h\"\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nhttps://console.cloud.google.com/monitoring/dashboards/builder/721b6c83-8f9b-409b-a009-9fdf3afb82f8/?project=gke-multicluster-upgrades&timeDomain=1h\"\n```\n- \u5728\u700f\u89bd\u5668\u4e2d\uff0c\u8f49\u5230\u4e0a\u8ff0\u547d\u4ee4\u751f\u6210\u7684\u7db2\u5740\u3002\u6d41\u5411\u793a\u4f8b\u61c9\u7528\u7684\u6d41\u91cf\u5c07\u5f9e\u8ca0\u8f09\u751f\u6210\u5668\u50b3\u8f38\u5230 `blue` \u548c `green` \u96c6\u7fa3\uff08\u7531\u96c6\u7fa3\u6240\u5728\u7684\u5169\u500b\u53ef\u7528\u5340\u8aaa\u660e\uff09\u3002\u6642\u9593\u8ef8\u6307\u6a19\u5716\u8868\u986f\u793a\u4e86\u6d41\u5411\u5169\u500b\u5f8c\u7aef\u7684\u6d41\u91cf\u3002 `k8s1-` \u9f20\u6a19\u61f8\u505c\u503c\u8868\u793a\u5169\u500b\u524d\u7aef `MulticlusterServices` \u7684\u7db2\u7d61\u7aef\u9ede\u7d44 (NEG) \u6b63\u5728 `blue` \u548c `green` \u96c6\u7fa3\u4e2d\u904b\u884c\u3002 **\u6ce8\u610f** \uff1a\u5716\u8868\u984f\u8272\u53ef\u80fd\u8207 `blue` \u548c `green` \u96c6\u7fa3\u4e0d\u5c0d\u61c9\u3002\u6d41\u91cf\u53ef\u80fd\u9700\u8981\u5e7e\u5206\u9418\u7684\u6642\u9593\u624d\u80fd\u986f\u793a\u5728\u5716\u8868\u4e2d\u3002 \n## \u6392\u7a7a\u548c\u5347\u7d1a blue \u96c6\u7fa3\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u6392\u7a7a `blue` \u96c6\u7fa3\u3002\u6392\u7a7a\u96c6\u7fa3\u610f\u5473\u7740\u5c07\u5176\u5f9e\u8ca0\u8f09\u5747\u8861\u6c60\u4e2d\u79fb\u9664\u3002\u6392\u7a7a `blue` \u96c6\u7fa3\u540e\uff0c\u6240\u6709\u4ee5\u61c9\u7528\u7232\u76ee\u7684\u5730\u7684\u5ba2\u6236\u7aef\u6d41\u91cf\u90fd\u6703\u6d41\u5411 `green` \u96c6\u7fa3\u3002\u60a8\u53ef\u4ee5\u6309\u7167\u4e0a\u4e00\u90e8\u5206\u4e2d\u7684\u8aaa\u660e\u76e3\u63a7\u6b64\u904e\u7a0b\u3002\u6392\u7a7a\u96c6\u7fa3\u540e\uff0c\u60a8\u53ef\u4ee5\u5347\u7d1a\u6392\u7a7a\u7684\u96c6\u7fa3\u3002\u5347\u7d1a\u5b8c\u6210\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5c07\u5176\u91cd\u65b0\u653e\u5165\u8ca0\u8f09\u5747\u8861\u6c60\u4e2d\u3002\u91cd\u8907\u9019\u4e9b\u6b65\u9a5f\u4ee5\u5347\u7d1a\u53e6\u4e00\u500b\u96c6\u7fa3\uff08\u672c\u6559\u7a0b\u4e2d\u672a\u4ecb\u7d39\uff09\u3002\n\u5982\u9700\u6392\u7a7a `blue` \u96c6\u7fa3\uff0c\u60a8\u9700\u8981\u66f4\u65b0 `ingress-cluster` \u96c6\u7fa3\u4e2d\u7684 `MulticlusterService` \u8cc7\u6e90\uff0c\u4e26\u5f9e `clusters` \u898f\u7bc4\u4e2d\u79fb\u9664 `blue` \u96c6\u7fa3\u3002\n### \u6392\u7a7a\u85cd\u8272\u96c6\u7fa3\n- \u5728 Cloud Shell \u4e2d\uff0c\u66f4\u65b0 `ingress-config` \u96c6\u7fa3\u4e2d\u7684 `MulticlusterService` \u8cc7\u6e90\uff1a```\nkubectl --context ${INGRESS_CONFIG_CLUSTER} \\\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 apply -f ${WORKDIR}/multicluster-manifests/mcs-green.yaml\n```\n- \u9a57\u8b49 `clusters` \u898f\u7bc4\u4e2d\u53ea\u6709 `green` \u96c6\u7fa3\uff1a```\nkubectl --context ${INGRESS_CONFIG_CLUSTER} get multiclusterservice \\\u00a0 \u00a0 \u00a0 \u00a0 -o json | jq '.items[].spec.clusters'\n```\u8f38\u51fa\u5982\u4e0b\u6240\u793a\uff1a```\n[ {\n \"link\": \"us-west1-c/green\"\n }\n]\n````clusters` \u898f\u7bc4\u4e2d\u50c5\u5217\u51fa\u4e86 `green` \u96c6\u7fa3\uff0c\u56e0\u6b64\u53ea\u6709 `green` \u96c6\u7fa3\u5728\u8ca0\u8f09\u5747\u8861\u6c60\u4e2d\u3002\n- \u60a8\u53ef\u4ee5\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u67e5\u770b\u4f86\u81ea Cloud Load Balancing \u6307\u6a19\u7684\u6307\u6a19\u3002\u751f\u6210\u7db2\u5740\uff1a```\necho \"https://console.cloud.google.com/monitoring/dashboards/builder/${DASH_ID}/?project=${PROJECT}&timeDomain=1h\"\n```\n- \u5728\u700f\u89bd\u5668\u4e2d\uff0c\u8f49\u5230\u4e0a\u4e00\u500b\u547d\u4ee4\u751f\u6210\u7684\u7db2\u5740\u3002\u5716\u8868\u986f\u793a\u53ea\u6709 `green` \u96c6\u7fa3\u6b63\u5728\u63a5\u6536\u6d41\u91cf\u3002 \n### \u5347\u7d1a blue \u96c6\u7fa3\u7531\u65bc `blue` \u96c6\u7fa3\u4e0d\u518d\u63a5\u6536\u4efb\u4f55\u5ba2\u6236\u7aef\u6d41\u91cf\uff0c\u60a8\u53ef\u4ee5\u5347\u7d1a\u96c6\u7fa3\uff08\u63a7\u5236\u5c64\u9762\u548c\u7bc0\u9ede\uff09\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u7372\u53d6\u96c6\u7fa3\u7684\u7576\u524d\u7248\u672c\uff1a```\ngcloud container clusters list\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nNAME: ingress-config\nLOCATION: us-west1-a\nMASTER_VERSION: 1.22.8-gke.202\nMASTER_IP: 35.233.186.135\nMACHINE_TYPE: e2-medium\nNODE_VERSION: 1.22.8-gke.202\nNUM_NODES: 4\nSTATUS: RUNNING\nNAME: blue\nLOCATION: us-west1-b\nMASTER_VERSION: 1.22.8-gke.202\nMASTER_IP: 34.82.35.222\nMACHINE_TYPE: e2-medium\nNODE_VERSION: 1.22.8-gke.202\nNUM_NODES: 3\nSTATUS: RUNNING\nNAME: green\nLOCATION: us-west1-c\nMASTER_VERSION: 1.22.8-gke.202\nMASTER_IP: 35.185.204.26\nMACHINE_TYPE: e2-medium\nNODE_VERSION: 1.22.8-gke.202\nNUM_NODES: 3\nSTATUS: RUNNING\n```\u60a8\u7684\u96c6\u7fa3\u7248\u672c\u53ef\u80fd\u6703\u6709\u6240\u4e0d\u540c\uff0c\u5177\u9ad4\u53d6\u6c7a\u65bc\u60a8\u5b8c\u6210\u672c\u6559\u7a0b\u7684\u6642\u9593\u3002\n- \u7372\u53d6\u53ef\u7528\u5340\u4e2d\u53ef\u7528 `MasterVersions` \u7248\u672c\u7684\u5217\u8868\uff1a```\ngcloud container get-server-config --zone us-west1-b --format=json | jq \\'.validMasterVersions[0:20]'\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\n[ \"1.24.1-gke.1400\",\n \"1.23.7-gke.1400\",\n \"1.23.6-gke.2200\",\n \"1.23.6-gke.1700\",\n \"1.23.6-gke.1501\",\n \"1.23.6-gke.1500\",\n \"1.23.5-gke.2400\",\n \"1.23.5-gke.1503\",\n \"1.23.5-gke.1501\",\n \"1.22.10-gke.600\",\n \"1.22.9-gke.2000\",\n \"1.22.9-gke.1500\",\n \"1.22.9-gke.1300\",\n \"1.22.8-gke.2200\",\n \"1.22.8-gke.202\",\n \"1.22.8-gke.201\",\n \"1.22.8-gke.200\",\n \"1.21.13-gke.900\",\n \"1.21.12-gke.2200\",\n \"1.21.12-gke.1700\"\n]\n```\n- \u7372\u53d6\u53ef\u7528\u5340\u4e2d\u53ef\u7528 `NodeVersions` \u7248\u672c\u7684\u5217\u8868\uff1a```\ngcloud container get-server-config --zone us-west1-b --format=json | jq \\'.validNodeVersions[0:20]'\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\n[ \"1.24.1-gke.1400\",\n \"1.23.7-gke.1400\",\n \"1.23.6-gke.2200\",\n \"1.23.6-gke.1700\",\n \"1.23.6-gke.1501\",\n \"1.23.6-gke.1500\",\n \"1.23.5-gke.2400\",\n \"1.23.5-gke.1503\",\n \"1.23.5-gke.1501\",\n \"1.22.10-gke.600\",\n \"1.22.9-gke.2000\",\n \"1.22.9-gke.1500\",\n \"1.22.9-gke.1300\",\n \"1.22.8-gke.2200\",\n \"1.22.8-gke.202\",\n \"1.22.8-gke.201\",\n \"1.22.8-gke.200\",\n \"1.22.7-gke.1500\",\n \"1.22.7-gke.1300\",\n \"1.22.7-gke.900\"\n]\n```\n- \u7232 `MasterVersions` \u548c `NodeVersions` \u5217\u8868\u4e2d\u4e14\u9ad8\u65bc `blue` \u96c6\u7fa3\u7684\u7576\u524d\u7248\u672c\u7684 `MasterVersion` \u548c `NodeVersion` \u7248\u672c\u8a2d\u7f6e\u74b0\u5883\u8b8a\u91cf\uff0c\u4f8b\u5982\uff1a```\nexport UPGRADE_VERSION=\"1.22.10-gke.600\"\n```\u672c\u6559\u7a0b\u4f7f\u7528 `1.22.10-gke.600` \u7248\u672c\u3002\u60a8\u7684\u96c6\u7fa3\u7248\u672c\u53ef\u80fd\u6703\u6709\u6240\u4e0d\u540c\uff0c\u5177\u9ad4\u53d6\u6c7a\u65bc\u60a8\u5b8c\u6210\u672c\u6559\u7a0b\u6642\u53ef\u7528\u7684\u7248\u672c\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u5347\u7d1a\uff0c\u8acb\u53c3\u95b1 [\u5347\u7d1a\u96c6\u7fa3\u548c\u7bc0\u9ede\u6c60](https://cloud.google.com/kubernetes-engine/docs/how-to/upgrading-a-cluster?hl=zh-cn#upgrading_the_cluster) \u3002 **\u6ce8\u610f** \uff1a\u5efa\u8b70\u60a8\u4e0d\u8981\u8df3\u904e\u6b21\u8981\u96c6\u7fa3\u7248\u672c\uff0c\u4ee5\u907f\u514d\u6f5b\u5728\u7684\u63a7\u5236\u5e73\u9762\u6216\u7bc0\u9ede\u4e0d\u517c\u5bb9\u554f\u984c\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u201c\u6211\u53ef\u4ee5\u5728\u96c6\u7fa3\u5347\u7d1a\u671f\u9593\u8df3\u904e\u591a\u500b GKE \u7248\u672c\u55ce\uff1f\u201d](https://cloud.google.com/kubernetes-engine/versioning?hl=zh-cn#skip-versions) \u3002\n- \u5347\u7d1a `blue` \u96c6\u7fa3\u7684 `control plane` \u7bc0\u9ede\uff1a```\ngcloud container clusters upgrade blue \\\u00a0 \u00a0 --zone us-west1-b --master --cluster-version ${UPGRADE_VERSION}\n```\u8981\u78ba\u8a8d\u5347\u7d1a\uff0c\u8acb\u6309 `Y` \u3002\u6b64\u904e\u7a0b\u9700\u8981\u5e7e\u5206\u9418\u624d\u80fd\u5b8c\u6210\u3002 \u7b49\u5f85\u5347\u7d1a\u5b8c\u6210\u5f8c\u518d\u7e7c\u7e8c\u64cd\u4f5c\u3002\u66f4\u65b0\u5b8c\u6210\u5f8c\uff0c\u8f38\u51fa\u5982\u4e0b\uff1a```\nUpdated\n[https://container.googleapis.com/v1/projects/gke-multicluster-upgrades/zones/us-west1-b/clusters/blue].\n```\n- \u5347\u7d1a `blue` \u96c6\u7fa3\u4e2d\u7684\u7bc0\u9ede\uff1a```\ngcloud container clusters upgrade blue \\\u00a0 \u00a0 --zone=us-west1-b --node-pool=default-pool \\\u00a0 \u00a0 --cluster-version ${UPGRADE_VERSION}\n```\u8981\u78ba\u8a8d\u66f4\u65b0\uff0c\u8acb\u6309 `Y` \u3002\u6b64\u904e\u7a0b\u9700\u8981\u5e7e\u5206\u9418\u624d\u80fd\u5b8c\u6210\u3002 \u7b49\u5f85\u7bc0\u9ede\u5347\u7d1a\u5b8c\u6210\u5f8c\u518d\u7e7c\u7e8c\u64cd\u4f5c\u3002\u5347\u7d1a\u5b8c\u6210\u5f8c\uff0c\u8f38\u51fa\u5982\u4e0b\uff1a```\nUpgrading blue... Done with 3 out of 3 nodes (100.0%): 3 succeeded...done.\nUpdated [https://container.googleapis.com/v1/projects/gke-multicluster-upgrades/zones/us-west1-b/clusters/blue].\n```\n- \u9a57\u8b49 `blue` \u96c6\u7fa3\u662f\u5426\u5df2\u5347\u7d1a\uff1a```\ngcloud container clusters list\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nNAME: ingress-config\nLOCATION: us-west1-a\nMASTER_VERSION: 1.22.8-gke.202\nMASTER_IP: 35.233.186.135\nMACHINE_TYPE: e2-medium\nNODE_VERSION: 1.22.8-gke.202\nNUM_NODES: 4\nSTATUS: RUNNING\nNAME: blue\nLOCATION: us-west1-b\nMASTER_VERSION: 1.22.10-gke.600\nMASTER_IP: 34.82.35.222\nMACHINE_TYPE: e2-medium\nNODE_VERSION: 1.22.10-gke.600\nNUM_NODES: 3\nSTATUS: RUNNING\nNAME: green\nLOCATION: us-west1-c\nMASTER_VERSION: 1.22.8-gke.202\nMASTER_IP: 35.185.204.26\nMACHINE_TYPE: e2-medium\nNODE_VERSION: 1.22.8-gke.202\nNUM_NODES: 3\nSTATUS: RUNNING\n```\n## \u5c07 blue \u96c6\u7fa3\u91cd\u65b0\u6dfb\u52a0\u5230\u8ca0\u8f09\u5747\u8861\u6c60\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07 `blue` \u96c6\u7fa3\u91cd\u65b0\u6dfb\u52a0\u5230\u8ca0\u8f09\u5747\u8861\u6c60\u4e2d\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u5148\u9a57\u8b49\u61c9\u7528\u90e8\u7f72\u662f\u5426\u6b63\u5728 `blue` \u96c6\u7fa3\u4e0a\u904b\u884c\uff0c\u7136\u5f8c\u518d\u5c07\u5176\u91cd\u65b0\u6dfb\u52a0\u5230\u8ca0\u8f09\u5747\u8861\u6c60\u4e2d\uff1a```\nkubectl --context ${BLUE_CLUSTER} get pods\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nNAME         READY STATUS RESTARTS AGE\nwhereami-deployment-756c7dc74c-xdnb6 1/1  Running 0   17m\n```\n- \u66f4\u65b0 `MutliclusterService` \u8cc7\u6e90\u4ee5\u5c07 `blue` \u96c6\u7fa3\u91cd\u65b0\u6dfb\u52a0\u5230\u8ca0\u8f09\u5747\u8861\u6c60\uff1a```\nkubectl --context ${INGRESS_CONFIG_CLUSTER} apply \\\u00a0 \u00a0 \u00a0 \u00a0 -f ${WORKDIR}/multicluster-manifests/mcs-blue-green.yaml\n```\n- \u9a57\u8b49\u96c6\u7fa3\u898f\u7bc4\u4e2d\u662f\u5426\u540c\u6642\u6709 `blue` \u548c `green` \u96c6\u7fa3\uff1a```\nkubectl --context ${INGRESS_CONFIG_CLUSTER} get multiclusterservice \\\u00a0 \u00a0 \u00a0 \u00a0 -o json | jq '.items[].spec.clusters'\n```\u8f38\u51fa\u5982\u4e0b\u6240\u793a\uff1a```\n[ {\n \"link\": \"us-west1-b/blue\"\n },\n {\n \"link\": \"us-west1-c/green\"\n }\n]\n````blue` \u548c `green` \u96c6\u7fa3\u73fe\u5728\u5728 `clusters` \u898f\u7bc4\u4e2d\u3002\n- Google Cloud \u63a7\u5236\u6aaf\u4e2d\u63d0\u4f9b\u4f86\u81ea Cloud Load Balancing \u6307\u6a19\u7684\u6307\u6a19\u3002\u751f\u6210\u7db2\u5740\uff1a```\necho \"https://console.cloud.google.com/monitoring/dashboards/builder/${DASH_ID}/?project=${PROJECT}&timeDomain=1h\"\n```\n- \u5728\u700f\u89bd\u5668\u4e2d\uff0c\u8f49\u5230\u4e0a\u4e00\u500b\u547d\u4ee4\u751f\u6210\u7684\u7db2\u5740\u3002\u8a72\u5716\u8868\u986f\u793a\u85cd\u8272\u548c\u7da0\u8272\u96c6\u7fa3\u90fd\u4f7f\u7528\u8ca0\u8f09\u5747\u8861\u5668\u63a5\u6536\u4f86\u81ea\u8ca0\u8f09\u751f\u6210\u5668\u7684\u6d41\u91cf\u3002 **\u6ce8\u610f** \uff1a\u6d41\u91cf\u53ef\u80fd\u9700\u8981\u5e7e\u5206\u9418\u6642\u9593\u624d\u80fd\u91cd\u65b0\u5747\u8861\u3002 \u606d\u559c\uff01\u60a8\u4f7f\u7528\u591a\u96c6\u7fa3 Ingress \u5728\u591a\u96c6\u7fa3\u67b6\u69cb\u4e2d\u6210\u529f\u5347\u7d1a\u4e86 GKE \u96c6\u7fa3\u3002\n- \u5982\u9700\u5347\u7d1a `green` \u96c6\u7fa3\uff0c\u8acb\u91cd\u8907 [\u6392\u7a7a\u548c\u5347\u7d1a\u85cd\u8272\u96c6\u7fa3](#draining_and_upgrading_the_blue_cluster) \u7684\u6b65\u9a5f\uff0c\u5728\u6574\u500b\u904e\u7a0b\u4e2d\u5c07 `blue` \u66ff\u63db\u7232 `green` \u3002\n## \u6e05\u7406\u7232\u907f\u514d\u56e0\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528\u7684\u8cc7\u6e90\u5c0e\u81f4\u60a8\u7684 Google Cloud \u8cec\u865f\u7522\u751f\u8cbb\u7528\uff0c\u8acb\u522a\u9664\u5305\u542b\u9019\u4e9b\u8cc7\u6e90\u7684\u9805\u76ee\uff0c\u6216\u8005\u4fdd\u7559\u9805\u76ee\u4f46\u522a\u9664\u5404\u500b\u8cc7\u6e90\u3002\n\u907f\u514d\u7522\u751f\u8cbb\u7528\u7684\u6700\u7c21\u55ae\u65b9\u6cd5\u662f\u522a\u9664\u60a8\u7232\u672c\u6559\u7a0b\u5275\u5efa\u7684 Google Cloud \u9805\u76ee\u3002\u6216\u8005\uff0c\u60a8\u4e5f\u53ef\u4ee5\u522a\u9664\u5404\u500b\u8cc7\u6e90\u3002\n### \u522a\u9664\u96c6\u7fa3\n- \u5728 Cloud Shell \u4e2d\uff0c\u53d6\u6d88\u8a3b\u518a\u4e26\u522a\u9664 `blue` \u548c `green` \u96c6\u7fa3\uff1a```\ngcloud container fleet memberships unregister blue --gke-cluster=us-west1-b/bluegcloud container clusters delete blue --zone us-west1-b --quietgcloud container fleet memberships unregister green --gke-cluster=us-west1-c/greengcloud container clusters delete green --zone us-west1-c --quiet\n```\n- \u5f9e `ingress-config` \u96c6\u7fa3\u4e2d\u522a\u9664 `MuticlusterIngress` \u8cc7\u6e90\uff1a```\nkubectl --context ${INGRESS_CONFIG_CLUSTER} delete -f ${WORKDIR}/multicluster-manifests/mci.yaml\n```\u6b64\u547d\u4ee4\u6703\u5f9e\u9805\u76ee\u4e2d\u522a\u9664 Cloud Load Balancing \u8cc7\u6e90\u3002\n- \u53d6\u6d88\u8a3b\u518a\u4e26\u522a\u9664 `ingress-config` \u96c6\u7fa3\uff1a```\ngcloud container fleet memberships unregister ingress-config --gke-cluster=us-west1-a/ingress-configgcloud container clusters delete ingress-config --zone us-west1-a --quiet\n```\n- \u9a57\u8b49\u6240\u6709\u96c6\u7fa3\u662f\u5426\u5df2\u522a\u9664\uff1a```\ngcloud container clusters list\n```\u8f38\u51fa\u5982\u4e0b\u6240\u793a\uff1a```\n*&lt;null&gt;*\n```\n- \u91cd\u7f6e `kubeconfig` \u6587\u4ef6\uff1a```\nunset KUBECONFIG\n```\n- \u79fb\u9664 `WORKDIR` \u6587\u4ef6\u593e\uff1a```\ncd ${HOME}rm -rf ${WORKDIR}\n```\n### \u522a\u9664\u9805\u76ee- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- **\u8b66\u544a** \uff1a\u522a\u9664\u9805\u76ee\u6703\u7522\u751f\u4ee5\u4e0b\u5f71\u97ff- **\u9805\u76ee\u4e2d\u7684\u6240\u6709\u5167\u5bb9\u90fd\u6703\u88ab\u522a\u9664\u3002** \u5982\u679c\u60a8\u5c07\u73fe\u6709\u9805\u76ee\u7528\u65bc\u672c\u6587\u6a94\u4e2d\u7684\u4efb\u52d9\uff0c\u5247\u522a\u9664\u8a72\u9805\u76ee\u5f8c\uff0c\u9084\u5c07\u522a\u9664\u60a8\u5df2\u5728\u8a72\u9805\u76ee\u4e2d\u5b8c\u6210\u7684\u4efb\u4f55\u5176\u4ed6\u5de5\u4f5c\u3002\n- **\u81ea\u5b9a\u7fa9\u9805\u76ee ID \u4e1f\u5931\u3002** \u5275\u5efa\u6b64\u9805\u76ee\u6642\uff0c\u60a8\u53ef\u80fd\u5275\u5efa\u4e86\u8981\u5728\u5c07\u4f86\u4f7f\u7528\u7684\u81ea\u5b9a\u7fa9\u9805\u76ee ID\u3002\u8981\u4fdd\u7559\u4f7f\u7528\u8a72\u9805\u76ee ID \u7684\u7db2\u5740\uff08\u4f8b\u5982`appspot.com`\u7db2\u5740\uff09\uff0c\u8acb\u522a\u9664\u9805\u76ee\u5167\u7684\u6240\u9078\u8cc7\u6e90\uff0c\u800c\u4e0d\u662f\u522a\u9664\u6574\u500b\u9805\u76ee\u3002\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u9032\u5165 **\u7ba1\u7406\u8cc7\u6e90** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u7ba1\u7406\u8cc7\u6e90\u201d](https://console.cloud.google.com/iam-admin/projects?hl=zh-cn) \n- \u5728\u9805\u76ee\u5217\u8868\u4e2d\uff0c\u9078\u64c7\u8981\u522a\u9664\u7684\u9805\u76ee\uff0c\u7136\u5f8c\u9ede\u64ca **\u522a\u9664** \u3002\n- \u5728\u5c0d\u8a71\u6846\u4e2d\u8f38\u5165\u9805\u76ee ID\uff0c\u7136\u5f8c\u9ede\u64ca **\u95dc\u9589** \u4ee5\u522a\u9664\u9805\u76ee\u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u8a73\u7d30\u77ad\u89e3 [\u591a\u96c6\u7fa3 Ingress](https://cloud.google.com/kubernetes-engine/docs/concepts/multi-cluster-ingress?hl=zh-cn) \u3002\n- \u77ad\u89e3\u5982\u4f55 [\u8de8\u96c6\u7fa3\u90e8\u7f72\u591a\u96c6\u7fa3 Ingress](https://cloud.google.com/kubernetes-engine/docs/how-to/multi-cluster-ingress?hl=zh-cn) \u3002\n- \u63a2\u7d22\u6709\u95dc Google Cloud \u7684\u53c3\u8003\u67b6\u69cb\u3001\u5716\u8868\u548c\u6700\u4f73\u5be6\u8e10\u3002\u67e5\u770b\u6211\u5011\u7684 [Cloud Architecture Center](https://cloud.google.com/architecture?hl=zh-cn) \u3002", "guide": "Google Kubernetes Engine (GKE)"}