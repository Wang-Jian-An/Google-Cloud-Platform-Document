{"title": "Google Kubernetes Engine (GKE) - Configure node upgrade strategies", "url": "https://cloud.google.com/kubernetes-engine/docs/how-to/node-pool-upgrade-strategies", "abstract": "# Google Kubernetes Engine (GKE) - Configure node upgrade strategies\nAs a platform administrator, you can configure a node upgrade strategy to tune how GKE upgrades the nodes in your Google Kubernetes Engine (GKE) clusters. To learn more about node upgrade strategies, see [Node upgrade strategies](/kubernetes-engine/docs/concepts/node-pool-upgrade-strategies) .\n", "content": "## Before you begin\nBefore you start, make sure you have performed the following tasks:\n- Enable    the Google Kubernetes Engine API.\n- [    Enable Google Kubernetes Engine API   ](https://console.cloud.google.com/flows/enableapi?apiid=container.googleapis.com) \n- If you want to use the Google Cloud CLI for this task, [install](/sdk/docs/install) and then [initialize](/sdk/docs/initializing) the  gcloud CLI. If you previously installed the gcloud CLI, get the latest  version by running`gcloud components update`. **Note:** For existing gcloud CLI  installations, make sure to set the`compute/region`and`compute/zone` [properties](/sdk/docs/properties#setting_properties) . By setting default locations,  you can avoid errors in gcloud CLI like the following:`One of [--zone, --region] must be supplied: Please specify location`.## Configure a node upgrade strategy\nWhen configuring your cluster's node pools, you can select and configure one of the supported node upgrade strategies, namely [surge](/kubernetes-engine/docs/concepts/node-pool-upgrade-strategies#surge) or [blue-green](/kubernetes-engine/docs/concepts/node-pool-upgrade-strategies#blue-green-upgrade-strategy) . Using these upgrade strategies lets you optimize the node pool upgrade process based on your cluster environment's needs.\n**Note:** By default, node pools use the surge upgrade strategy with `maxSurge=1` and `maxUnavailable=0` .\n## Configure surge upgrades\n[Surge upgrades](/kubernetes-engine/docs/concepts/node-pool-upgrade-strategies#surge) allow you to change the number of nodes GKE upgrades at one time and the amount of disruption an upgrade makes on your workloads.\nThe `max-surge-upgrade` and `max-unavailable-upgrade` flags are defined for each node pool. For more information on choosing the right parameters, go to [Optimize your surge upgrade configuration](/kubernetes-engine/docs/concepts/node-pool-upgrade-strategies#optimizing-surge) .\n**Note:** All new node pools are automatically configured to use surge upgrades`maxSurge=1 maxUnavailable=0`. To tune your configuration, see [Optimize your surge upgrade configuration](/kubernetes-engine/docs/concepts/node-pool-upgrade-strategies#optimizing-surge) .\n**Warning:** For [nodes that use Spot VMs](/kubernetes-engine/docs/how-to/spot-vms) , surge upgrade values are ignored because there is no availability guarantee. During an upgrade, old nodes are drained directly without waiting for surge nodes that use Spot VMs to be ready.\nYou can change these settings when creating or updating a cluster or node pool.\nThe following variables are used in the commands mentioned below:\n- ``: the name of the cluster for the node pool.\n- ``: the zone for the cluster.\n- ``: the name of the node pool.\n- ``: the number of nodes in the node pool in each of the cluster's zones.\n- ``: the number of extra (surge) nodes to be created on each upgrade of the node pool.\n- ``: the number of nodes that can be unavailable at the same time on each upgrade of the node pool.To create a cluster with specific settings for surge upgrades, use the `max-surge-upgrade` and `max-unavailable-upgrade` flags.\n```\ngcloud container clusters create CLUSTER_NAME \\\n --max-surge-upgrade=SURGE_NODES --max-unavailable-upgrade=UNAVAILABLE_NODES\n```\nTo create a cluster without surge upgrades, set the value for the `max-surge-upgrade` flag to `0` .\n```\ngcloud container clusters create CLUSTER_NAME \\\n --max-surge-upgrade=0 --max-unavailable-upgrade=1\n```\nTo create a node pool in an existing cluster with specific settings for surge upgrades, use the `max-surge-upgrade` and `max-unavailable-upgrade` flags.\n```\ngcloud container node-pools create NODE_POOL_NAME \\\n --num-nodes=NUMBER_NODES --cluster=CLUSTER_NAME \\\n --max-surge-upgrade=SURGE_NODES --max-unavailable-upgrade=UNAVAILABLE_NODES\n```\nTo update the upgrade settings of an existing node pool, use the `max-surge-upgrade` and `max-unavailable-upgrade` flags. If you set `max-surge-upgrade` to greater than `0` , GKE creates surge nodes. If you set `max-surge-upgrade` to `0` , GKE doesn't create surge nodes.\n```\ngcloud container node-pools update NODE_POOL_NAME \\\n --cluster=CLUSTER_NAME \\\n --max-surge-upgrade=SURGE_NODES --max-unavailable-upgrade=UNAVAILABLE_NODES\n```\nTo see if surge upgrades are enabled on a node pool, use `gcloud` to describe the cluster's parameters:\n```\ngcloud container node-pools describe NODE_POOL_NAME \\\n --cluster=CLUSTER_NAME\n```\nIf surge upgrades are enabled on the node pool, the strategy listed is `SURGE` .\n**Note:** While recreating nodes does not require additional Compute Engine resources, surge upgrading nodes does. Resource allocation is subjected to [Compute Engine quota](/compute/quotas) . Depending on your configuration, this quota can limit the number of parallel upgrades or even cause the upgrade  to fail. If you don't have any additional quota or reservation for the nodes in your node pool, don't use `maxSurge` .For more information about quota, go to [Ensure resources for node upgrades](/kubernetes-engine/docs/how-to/node-upgrades-quota) .\n## Configure blue-green upgrades\nWith [blue-green node poolupgrades](/kubernetes-engine/docs/concepts/node-pool-upgrade-strategies#blue-green-upgrade-strategy) , you can control:\n- ``or``: the size of batches of nodes that GKE drains at a time, meaning that the Pods are removed from the nodes. Default is`BATCH_NODE_COUNT=1`. If either of these settings are set to 0, GKE skips this phase and proceeds to the [Soak nodepool](/kubernetes-engine/docs/concepts/node-pool-upgrade-strategies#bg-phase-soak-node-pool) phase.\n- ``: the time between each batch of nodes being drained.\n- ``: the amount of soak time for you to validate your workload on the new node configuration.\nTo learn more about how the phases of blue-green upgrades work, see [The phases of blue-green upgrades](/kubernetes-engine/docs/concepts/node-pool-upgrade-strategies#phases-of-blue-green-upgrades) .\nThe following variables are used in the commands listed in the next sections:\n- ``: the name of the cluster for the node pool.\n- ``: the name of the node pool.\n- ``: the number of nodes in the node pool in each of the cluster's zones.\n- ``: the number of blue nodes to drain in a batch during the blue pool drain phase. Default is 1. If it is set to 0, the blue pool drain phase will be skipped.\n- ``: the percentage of blue nodes to drain in a batch during the blue pool drain phase, expressed as a decimal between 0 and 1, inclusive. If it is set to 0, the blue pool drain phase will be skipped.\n- ``: the duration in seconds to wait after each batch drain. Default is 0.\n- ``: the duration in seconds to wait after completing drain of all batches. Default is 3600 seconds.\n### Creating a node pool with blue-green upgrade strategy\nTo create a node pool in an existing cluster with the blue-green upgrade strategy with the default parameters, use the following command:\n```\ngcloud container node-pools create NODE_POOL_NAME \\\u00a0 \u00a0 --cluster=CLUSTER_NAME \\\u00a0 \u00a0 --enable-blue-green-upgrade\n```\nTo create a node pool with custom blue-green upgrade settings, use the parameter flags with the node pool creation command.\nThis command creates a node pool with the following customized blue-green configuration, using an absolute node count for the batch drains:\n- ``= 2\n- ``= 10s\n- ``= 600s\n```\ngcloud container node-pools create NODE_POOL_NAME \\\u00a0 \u00a0 --cluster=CLUSTER_NAME \\\u00a0 \u00a0 --enable-blue-green-upgrade \\\u00a0 \u00a0 --standard-rollout-policy=batch-node-count=2,batch-soak-duration=10s \\\u00a0 \u00a0 --node-pool-soak-duration=600s\n```\nThis command creates a node pool with the following customized blue-green configuration, using a percentage for the batch drains:\n- ``= 25% (of the node pool size)\n- ``= 10s\n- ``= 1800s\n```\ngcloud container node-pools create NODE_POOL_NAME \\\u00a0 \u00a0 --cluster=CLUSTER_NAME \\\u00a0 \u00a0 --enable-blue-green-upgrade \\\u00a0 \u00a0 --standard-rollout-policy=batch-percent=0.25,batch-soak-duration=10s \\\u00a0 \u00a0 --node-pool-soak-duration=1800s\n```\n### Updating an existing node pool blue-green upgrade strategy\nTo update an existing node pool to the blue-green upgrade strategy, use the following command:\n```\ngcloud container node-pools update NODE_POOL_NAME \\\u00a0 \u00a0 --cluster=CLUSTER_NAME \\\u00a0 \u00a0 --enable-blue-green-upgrade\n```\nTo update an existing node pool to the blue-green upgrade strategy with custom settings, use the parameter flags with the node pool creation command.\nThis command updates a node pool to use the following customized blue-green configuration, using an absolute node count for the batch drains:\n- ``= 2\n- ``= 10s\n- ``= 600s\n```\ngcloud container node-pools update NODE_POOL_NAME \\\u00a0 \u00a0 --cluster=CLUSTER_NAME \\\u00a0 \u00a0 --enable-blue-green-upgrade \\\u00a0 \u00a0 --standard-rollout-policy=batch-node-count=2,batch-soak-duration=10s \\\u00a0 \u00a0 --node-pool-soak-duration=600s\n```\nThis command creates a node pool with the following customized blue-green configuration, using a percentage for the batch drains:\n- ``= 25% (of the node pool size)\n- ``= 10s\n- ``= 1800s\n```\ngcloud container node-pools update NODE_POOL_NAME \\\u00a0 \u00a0 --cluster=CLUSTER_NAME \\\u00a0 \u00a0 --enable-blue-green-upgrade \\\u00a0 \u00a0 --standard-rollout-policy=batch-percent=0.25,batch-soak-duration=10s \\\u00a0 \u00a0 --node-pool-soak-duration=1800s\n```\n### Switching back to surge upgrades\nYou can change the behavior of [blue-green upgrades](/kubernetes-engine/docs/concepts/node-pool-upgrade-strategies#phases-of-blue-green-upgrades) with settings, and [control the upgrade process with commands](/kubernetes-engine/docs/concepts/node-pool-upgrade-strategies#control-in-progress-blue-green-upgrade) .\nHowever, if you want to use [surge upgrades](/kubernetes-engine/docs/concepts/node-pool-upgrade-strategies#surge) instead, run the following command to switch back to surge upgrades:\n```\ngcloud container node-pools update NODE_POOL_NAME \\\u00a0 \u00a0 --cluster=CLUSTER_NAME \\\u00a0 \u00a0 --enable-surge-upgrade\n```\n## Inspect the upgrade settings of a node pool\nTo inspect the current upgrade settings of a node pool, you can use the following command to describe the node pool:\n```\ngcloud container node-pools describe NODE_POOL_NAME \\\u00a0 \u00a0 --cluster=CLUSTER_NAME\n```\nThe following snippet is an example output of the command. The `strategy` field indicates the upgrade strategy in use: **SURGE** indicates that the surge upgrade strategy is enabled, and **BLUE_GREEN** indicates that the blue-green upgrade strategy is enabled.\n```\nupgradeSettings:\n blueGreenSettings:\n nodePoolSoakDuration: 1800s\n standardRolloutPolicy:\n  batchNodeCount: 1\n  batchSoakDuration: 10s\n strategy: BLUE_GREEN\n```\nThis command also shows you the current phase of an in-progress blue-green upgrade. Learn more about [checking the upgrade settings of a node pool](/kubernetes-engine/docs/how-to/upgrading-a-cluster#check-settings) .\n## What's next\n- Learn more about [node upgrade strategies](/kubernetes-engine/docs/concepts/node-pool-upgrade-strategies) .\n- Learn how to [manually upgrade your node pools](/kubernetes-engine/docs/how-to/upgrading-a-cluster#upgrade_nodes) .", "guide": "Google Kubernetes Engine (GKE)"}