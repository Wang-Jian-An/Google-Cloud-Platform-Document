{"title": "Google Kubernetes Engine (GKE) - Adjust log throughput", "url": "https://cloud.google.com/kubernetes-engine/docs/how-to/adjust-log-throughput?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - Adjust log throughput\nThis document describes default log throughput and how to increase throughput.\nWhen system logging is enabled, a dedicated Logging agent is automatically deployed and managed. It runs on all GKE nodes in a cluster to collect logs, adds helpful metadata about the container, pod, and cluster, and then sends the logs to Cloud Logging using a fluentbit-based agent.\nThe dedicated Logging agent provides at least 100 KiB per second log throughput per node for system and workload logs. If a node is underutilized, then depending on the type of log load (for example, text or structured log entries, very few containers on the node or many containers), the dedicated logging agent might provide throughput as much as 500 KiB per second or more. Additionally, in clusters with GKE control plane version 1.23.13-gke.1000 or later, the Logging agent allows for throughput as high as 10 MiB per second on nodes that have at least 2 unused CPU cores. Be aware, however, that at higher throughputs, some logs may be lost.\n", "content": "## Identify nodes with higher log throughput\nBy default, GKE clusters collect [system metrics](/stackdriver/docs/solutions/gke/managing-metrics#system-metrics) . The system metric `kubernetes.io/node/logs/input_bytes` provides the number of log bytes generated per second on a node. This metric can help you decide which variant of the logging agent makes sense to deploy in your cluster or node pools.\nTo view the historical logging throughput for each node in your cluster, follow these steps:\n- In the navigation panel of the Google Cloud console, select **Monitoring** , and then select **Metrics explorer** : [Go to Metrics explorer](https://console.cloud.google.com/monitoring/metrics-explorer) \n- In the **Select a metric** field, select `kubernetes.io/node/logs/input_bytes` .\n- In the **Group by** field, select **project_id** , **location** , **cluster_name** , and **node_name** .\n- Click **OK** \n- Optionally, sort the list of metrics in descending order by clicking the column header **Value** above the list of metrics.\nTo understand how much logging volume is due to system components or due to workloads running on the node, you may also group by the **type** metric label.\n## Enable high-throughput logging\nIf any GKE nodes require more than 100 KiB per second log throughput and your GKE Standard cluster is using control plane version 1.23.13-gke.1000 or later, you can configure GKE to deploy an alternative configuration of the Logging agent designed to maximize logging throughput. This maximum throughput Logging variant allows for throughput as high as 10 MiB per second per node. You can deploy this high-throughput Logging agent to all nodes in a cluster or to all nodes in a node pool.\nThis high-throughput configuration will consume additional CPU and memory.\n**Warning:** Changing the logging agent on an existing node pool recreates all nodes. If you change the logging agent for an existing cluster, the existing node pools are unaffected and the change only applies to new node pools added to the cluster.\nTo enable high-throughput logging on all nodes in a new cluster:\n```\ngcloud container clusters create CLUSTER_NAME \\\u00a0 \u00a0 --location=COMPUTE_LOCATION \\\u00a0 \u00a0 --logging-variant=MAX_THROUGHPUT \\\u00a0 \u00a0 --machine-type=MACHINE_TYPE\n```\nReplace the following:- ``: the name of the new cluster.\n- ``: the [Compute Engine location](/compute/docs/regions-zones/viewing-regions-zones) for the new cluster.\n- ``: a machine type that has enough CPU for the Logging agent, such as`e2-standard-8`.\nAll newly created node pools in this cluster, including the default node pool, deploy the high-throughput Logging agent.\nTo configure high-throughput logging for an existing cluster: use the [gcloud container clusters update](/sdk/gcloud/reference/container/clusters/update) command:\n```\ngcloud container clusters update CLUSTER_NAME \\\u00a0 \u00a0 --location=COMPUTE_LOCATION \\\u00a0 \u00a0 --logging-variant=MAX_THROUGHPUT\n```\nReplace the following:- ``: the name of the cluster.\n- ``: the [Compute Engine location](/compute/docs/regions-zones/viewing-regions-zones) of the cluster.\nTo create a new node pool that uses the high-throughput Logging agent, use the [gcloud container node-pools create](/sdk/gcloud/reference/container/node-pools/create) command:\n```\ngcloud container node-pools create NODEPOOL_NAME \\\u00a0 \u00a0 --cluster=CLUSTER_NAME \\\u00a0 \u00a0 --location=COMPUTE_LOCATION \\\u00a0 \u00a0 --logging-variant=MAX_THROUGHPUT\n```\nReplace the following:- ``: the name of the new node pool.\n- ``: the name of the cluster.\n- ``: the [Compute Engine location](/compute/docs/regions-zones/viewing-regions-zones) for the new cluster.\nTo update an existing node pool, use the [gcloud container node-pools update](/sdk/gcloud/reference/container/node-pools/update) command.\n```\ngcloud container node-pools update NODEPOOL_NAME \\\u00a0 \u00a0 --cluster=CLUSTER_NAME \\\u00a0 \u00a0 --location=COMPUTE_LOCATION \\\u00a0 \u00a0 --logging-variant=MAX_THROUGHPUT\n```\nReplace the following:- ``: the name of the node pool.\n- ``: the name of the cluster.\n- ``: the [Compute Engine location](/compute/docs/regions-zones/viewing-regions-zones) .\nThe following code blocks specify how to declare node pools with or without high-throughput logging.\nTo manage the node pools explicitly, you must specify your cluster without a default node pool.\n```\nresource \"google_container_cluster\" \"with_example_logging_variants\" {\u00a0 provider \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 = google\u00a0 name \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 = \"CLUSTER_NAME\"\u00a0 location \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 = \"COMPUTE_LOCATION\"\u00a0 initial_node_count = 1\u00a0 remove_default_node_pool = true # We want to manage our node pools separately.}\n```\nTo specify a node pool that uses the high-throughput agent, use the `node_config` field to specify the Logging agent variant as `MAX_THROUGHPUT` and an appropriate machine type:\n```\nresource \"google_container_node_pool\" \"with_example_logging_variant\" {\u00a0 provider = google\u00a0 name \u00a0 \u00a0 = \"example-node-pool-with-htl\"\u00a0 cluster \u00a0= google_container_cluster.with_example_logging_variants.name\u00a0 location = \"COMPUTE_LOCATION\"\u00a0 node_config {\u00a0 \u00a0 logging_variant = \"MAX_THROUGHPUT\"\u00a0 \u00a0 # Use a machine type with enough CPU to accommodate the high-throughput agent, such as e2-standard-8.\u00a0 \u00a0 machine_type = \"e2-standard-8\"\u00a0 }\u00a0 node_count = 1}\n```\nTo specify a node pool that uses the default agent, use the `node_config` field to specify the Logging agent variant as `DEFAULT` :\n```\nresource \"google_container_node_pool\" \"with_default_logging_variant\" {\u00a0 provider = google\u00a0 name \u00a0 \u00a0 = \"example-node-pool-with-default-logging\"\u00a0 cluster \u00a0= google_container_cluster.with_example_logging_variants.name\u00a0 location = \"COMPUTE_LOCATION\"\u00a0 node_config {\u00a0 \u00a0 logging_variant = \"DEFAULT\"\u00a0 }\u00a0 node_count = 1}\n```\n## Disable high-throughput logging\nIf you no longer want to use the high-throughput Logging agent, deploy the default Logging agent to the cluster or node pool.\n**Warning:** Changing the logging agent on an existing node pool recreates all nodes. If you change the logging agent for an existing cluster, the existing node pools are unaffected and the change only applies to new node pools added to the cluster.\nPass the flag `--logging-variant=DEFAULT` when you create or update a cluster or node pool.\nTo use the default logging agent on all nodes in a new cluster:\n```\n\u00a0 gcloud container clusters create CLUSTER_NAME \\\u00a0 \u00a0 \u00a0 --location=COMPUTE_LOCATION \\\u00a0 \u00a0 \u00a0 --logging-variant=DEFAULT \\\u00a0 \u00a0 \u00a0 --machine-type=MACHINE_TYPE\n```\nReplace the following:- ``: the name of the new cluster.\n- ``: the [Compute Engine location](/compute/docs/regions-zones/viewing-regions-zones) for the new cluster.\n- ``: a machine type that has enough CPU for the Logging agent, such as`e2-standard-8`.\nTo use the default logging agent on an existing cluster: use the [gcloud container clusters update](/sdk/gcloud/reference/container/clusters/update) command:\n```\ngcloud container clusters update CLUSTER_NAME \\\u00a0 \u00a0 --location=COMPUTE_LOCATION \\\u00a0 \u00a0 --logging-variant=DEFAULT\n```\nReplace the following:- ``: the name of the cluster.\n- ``: the [Compute Engine location](/compute/docs/regions-zones/viewing-regions-zones) of the cluster.\nTo use the default logging agent for a new node pool, use the [gcloud container node-pools create](/sdk/gcloud/reference/container/node-pools/create) command:\n```\ngcloud container node-pools create NODEPOOL_NAME \\\u00a0 \u00a0 --cluster=CLUSTER_NAME \\\u00a0 \u00a0 --location=COMPUTE_LOCATION \\\u00a0 \u00a0 --logging-variant=DEFAULT\n```\nReplace the following:- ``: the name of the new node pool.\n- ``: the name of the cluster.\n- ``: the [Compute Engine location](/compute/docs/regions-zones/viewing-regions-zones) for the new cluster.\nTo update an existing node pool, use the [gcloud container node-pools update](/sdk/gcloud/reference/container/node-pools/update) command:\n```\ngcloud container node-pools update NODEPOOL_NAME \\\u00a0 \u00a0 --cluster=CLUSTER_NAME \\\u00a0 \u00a0 --location=COMPUTE_LOCATION \\\u00a0 \u00a0 --logging-variant=DEFAULT\n```\nReplace the following:- ``: the name of the node pool.\n- ``: the name of the cluster.\n- ``: the [Compute Engine location](/compute/docs/regions-zones/viewing-regions-zones) .\nIf you no longer want Terraform to create node pools that use the high-throughput Logging agent, set the `logging_variant` field to `DEFAULT` .\n## What's next\n- Learn about [configuring logging and monitoring](/kubernetes-engine/docs/how-to/config-logging-monitoring) for GKE.", "guide": "Google Kubernetes Engine (GKE)"}