{"title": "Google Kubernetes Engine (GKE) - \u5c07\u61c9\u7528\u90e8\u7f72\u5230 GKE \u96c6\u7fa3", "url": "https://cloud.google.com/kubernetes-engine/docs/deploy-app-cluster?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - \u5c07\u61c9\u7528\u90e8\u7f72\u5230 GKE \u96c6\u7fa3\n# \u5c07\u61c9\u7528\u90e8\u7f72\u5230 GKE \u96c6\u7fa3\u5728\u672c\u5feb\u901f\u5165\u9580\u4e2d\uff0c\u60a8\u9700\u8981\u5c07\u4e00\u500b\u7c21\u55ae\u7684\u7db2\u7d61\u670d\u52d9\u5668 [\u5bb9\u5668\u5316\u61c9\u7528](https://cloud.google.com/kubernetes-engine/docs/concepts/kubernetes-engine-overview?hl=zh-cn#workloads) \u90e8\u7f72\u5230 Google Kubernetes Engine (GKE) \u96c6\u7fa3\u3002\u60a8\u5c07\u77ad\u89e3\u5982\u4f55\u5275\u5efa\u96c6\u7fa3\u4ee5\u53ca\u5982\u4f55\u5c07\u61c9\u7528\u90e8\u7f72\u5230\u96c6\u7fa3\u4ee5\u4f9b\u7528\u6236\u8a2a\u554f\u3002\n\u672c\u5feb\u901f\u5165\u9580\u5047\u5b9a\u60a8\u5c0d [Kubernetes](https://kubernetes.io) \u5177\u6709\u57fa\u672c\u7684\u77ad\u89e3\u3002", "content": "## \u6e96\u5099\u5de5\u4f5c\n\u8acb\u6309\u7167\u4ee5\u4e0b\u6b65\u9a5f\u5553\u7528 Kubernetes Engine API\uff1a\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n## \u5553\u52d5 Cloud Shell\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 [Cloud Shell](https://cloud.google.com/shell/docs?hl=zh-cn) \uff0c\u9019\u662f\u4e00\u500b\u7528\u65bc\u7ba1\u7406 Google Cloud \u4e0a\u8a17\u7ba1\u8cc7\u6e90\u7684 Shell \u74b0\u5883\u3002\nCloud Shell \u9810\u5b89\u88dd\u6709 [Google Cloud CLI](https://cloud.google.com/sdk/gcloud?hl=zh-cn) \u548c [kubectl](https://kubernetes.io/docs/reference/kubectl/) \u547d\u4ee4\u884c\u5de5\u5177\u3002gcloud CLI \u7232 Google Cloud \u63d0\u4f9b\u4e86\u4e3b\u8981\u7684\u547d\u4ee4\u884c\u754c\u9762\uff0c `kubectl` \u5247\u7232 Kubernetes \u96c6\u7fa3\u904b\u884c\u547d\u4ee4\u63d0\u4f9b\u4e86\u4e3b\u8981\u547d\u4ee4\u884c\u754c\u9762\u3002\n\u5553\u52d5 Cloud Shell\uff1a- \u524d\u5f80 Google Cloud \u63a7\u5236\u6aaf\u3002 [Google Cloud \u63a7\u5236\u6aaf](https://console.cloud.google.com/?hl=zh-cn) \n- \u5728\u63a7\u5236\u6aaf\u7684\u53f3\u4e0a\u89d2\uff0c\u9ede\u64ca **\u6fc0\u6d3b Cloud Shell** \u6309\u9215\uff1a \n\u63a7\u5236\u6aaf\u4e0b\u65b9\u7684\u6846\u67b6\u5167\u6703\u6253\u958b\u4e00\u500b Cloud Shell \u6703\u8a71\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u6b64 shell \u904b\u884c `gcloud` \u548c `kubectl` \u547d\u4ee4\u3002 \u5728\u904b\u884c\u547d\u4ee4\u4e4b\u524d\uff0c\u8acb\u5728 Google Cloud CLI \u4e2d\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u8a2d\u7f6e\u9ed8\u8a8d\u9805\u76ee\uff1a\n```\ngcloud config set project PROJECT_ID\n```\n\u5c07 `` \u66ff\u63db\u7232\u60a8\u7684 [\u9805\u76ee ID](https://support.google.com/cloud/answer/6158840?hl=zh-cn) \u3002## \u5275\u5efa GKE \u96c6\u7fa3\u4e00\u500b [\u96c6\u7fa3](https://cloud.google.com/kubernetes-engine/docs/concepts/cluster-architecture?hl=zh-cn) \u5305\u542b\u81f3\u5c11\u4e00\u81fa\u96c6\u7fa3\u63a7\u5236\u5c64\u9762 \u6a5f\u5668\u4ee5\u53ca\u591a\u81fa\u5de5\u4f5c\u5668\u6a5f\u5668\uff0c\u9019\u4e9b\u5de5\u4f5c\u5668\u6a5f\u5668\u7a31\u7232\u201c\u7bc0\u9ede\u201d\u3002 \u7bc0\u9ede\u662f\u904b\u884c Kubernetes \u9032\u7a0b\u7684 [Compute Engine \u865b\u64ec\u6a5f\u5be6\u4f8b](https://cloud.google.com/compute/docs/instances?hl=zh-cn) \uff1b\u5fc5\u9808\u6709\u9019\u4e9b\u9032\u7a0b\uff0c\u7bc0\u9ede\u624d\u80fd\u52a0\u5165\u5230\u96c6\u7fa3\u4e2d\u3002\u60a8\u5c07\u61c9\u7528\u90e8\u7f72\u5230\u96c6\u7fa3\uff0c\u8a72\u61c9\u7528\u5728\u7bc0\u9ede\u4e0a\u904b\u884c\u3002\n\u5275\u5efa\u540d\u7232 `hello-cluster` \u7684 Autopilot \u96c6\u7fa3\uff1a\n```\ngcloud container clusters create-auto hello-cluster \\\u00a0 \u00a0 --location=us-central1\n```\n **\u6ce8\u610f** \uff1a\u96c6\u7fa3\u5275\u5efa\u904e\u7a0b\u53ef\u80fd\u9700\u8981\u5e7e\u5206\u9418\u624d\u80fd\u5b8c\u6210\u3002\n### \u7372\u53d6\u7528\u65bc\u96c6\u7fa3\u7684\u8eab\u4efd\u9a57\u8b49\u6191\u64da\u5275\u5efa\u96c6\u7fa3\u540e\uff0c\u60a8\u9700\u8981\u7372\u53d6\u8eab\u4efd\u9a57\u8b49\u6191\u64da\u624d\u80fd\u8207\u8a72\u96c6\u7fa3\u4ea4\u4e92\uff1a\n```\ngcloud container clusters get-credentials hello-cluster \\\u00a0 \u00a0 --location us-central1\n```\n\u6b64\u547d\u4ee4\u5c07 `kubectl` \u914d\u7f6e\u7232\u4f7f\u7528\u60a8\u5275\u5efa\u7684\u96c6\u7fa3\u3002## \u5c07\u61c9\u7528\u90e8\u7f72\u5230\u96c6\u7fa3\u73fe\u5728\u60a8\u5df2\u5275\u5efa\u4e86\u4e00\u500b\u96c6\u7fa3\uff0c\u53ef\u4ee5\u5411\u5176\u90e8\u7f72 [\u5bb9\u5668\u5316\u61c9\u7528](https://cloud.google.com/kubernetes-engine/docs/concepts/kubernetes-engine-overview?hl=zh-cn#workloads) \u4e86\u3002\u5728\u672c\u5feb\u901f\u5165\u9580\u4e2d\uff0c\u60a8\u53ef\u4ee5\u90e8\u7f72\u6211\u5011\u7684 `hello-app` \u793a\u4f8b Web \u61c9\u7528\u3002\nGKE \u4f7f\u7528 Kubernetes \u5c0d\u8c61\u5275\u5efa\u548c\u7ba1\u7406\u96c6\u7fa3\u7684\u8cc7\u6e90\u3002Kubernetes \u63d0\u4f9b\u4e86 [Deployment](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/) \u5c0d\u8c61\uff0c\u7528\u65bc\u90e8\u7f72 Web \u670d\u52d9\u5668\u7b49\u7121\u72c0\u614b\u61c9\u7528\u3002 [Service](https://cloud.google.com/kubernetes-engine/docs/concepts/service?hl=zh-cn) \u5c0d\u8c61\u5247\u7528\u65bc\u5b9a\u7fa9\u5f9e\u4e92\u806f\u7db2\u8a2a\u554f\u60a8\u7684\u61c9\u7528\u6642\u9700\u8981\u9075\u5faa\u7684\u898f\u5247\u548c\u8ca0\u8f09\u5747\u8861\u6a5f\u5236\u3002\n### \u5275\u5efa Deployment\u5982\u9700\u5728\u96c6\u7fa3\u4e2d\u904b\u884c `hello-app` \uff0c\u60a8\u9700\u8981\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4f86\u90e8\u7f72\u61c9\u7528\uff1a\n```\nkubectl create deployment hello-server \\\u00a0 \u00a0 --image=us-docker.pkg.dev/google-samples/containers/gke/hello-app:1.0\n```\n\u6b64 Kubernetes \u547d\u4ee4 [kubectl create deployment](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#create) \u6703\u5275\u5efa\u540d\u7232 `hello-server` \u7684 Deployment\u3002\u6b64 Deployment \u7684 [Pod](https://kubernetes.io/docs/concepts/workloads/pods) \u904b\u884c `hello-app` \u5bb9\u5668\u6620\u50cf\u3002\n\u5728\u6b64\u547d\u4ee4\u4e2d\uff1a- `--image`\u6307\u5b9a\u4e86\u8981\u90e8\u7f72\u7684\u5bb9\u5668\u6620\u50cf\u3002\u5728\u672c\u793a\u4f8b\u4e2d\uff0c\u8a72\u547d\u4ee4\u6703\u5f9e [Artifact Registry](https://cloud.google.com/artifact-registry/docs?hl=zh-cn) \u4ee3\u78bc\u5eab\u4e2d\u62c9\u53d6\u793a\u4f8b\u6620\u50cf`us-docker.pkg.dev/google-samples/containers/gke/hello-app`\u3002`:1.0`\u6307\u793a\u8981\u62c9\u53d6\u7684\u7279\u5b9a\u6620\u50cf\u7248\u672c\u3002\u5982\u679c\u60a8\u672a\u6307\u5b9a\u7248\u672c\uff0c\u5247\u7cfb\u7d71\u6703\u4f7f\u7528 [\u9ed8\u8a8d\u6a19\u8a18](https://cloud.google.com/architecture/best-practices-for-building-containers?hl=zh-cn#properly_tag_your_images) `latest`\u7684\u6620\u50cf\u3002\n### \u516c\u958b Deployment\u90e8\u7f72\u61c9\u7528\u5f8c\uff0c\u60a8\u9700\u8981\u5c07\u5176\u516c\u958b\u5230\u4e92\u806f\u7db2\uff0c\u4ee5\u4fbf\u7528\u6236\u8a2a\u554f\u8a72\u61c9\u7528\u3002\u60a8\u53ef\u4ee5\u901a\u904e\u5275\u5efa Service \u4f86\u516c\u958b\u61c9\u7528\uff0c\u9019\u662f\u4e00\u7a2e Kubernetes \u8cc7\u6e90\uff0c\u53ef\u4ee5\u5c07\u60a8\u7684\u61c9\u7528\u516c\u958b\u7d66\u5916\u90e8\u6d41\u91cf\u3002\n\u5982\u9700\u516c\u958b\u60a8\u7684\u61c9\u7528\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b [kubectl expose](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#expose) \u547d\u4ee4\uff1a\n```\nkubectl expose deployment hello-server \\\u00a0 \u00a0 --type LoadBalancer \\\u00a0 \u00a0 --port 80 \\\u00a0 \u00a0 --target-port 8080\n```\n\u50b3\u5165 `--type LoadBalancer` \u6a19\u8a8c\u6703\u7232\u60a8\u7684\u5bb9\u5668\u5275\u5efa Compute Engine \u8ca0\u8f09\u5747\u8861\u5668\u3002 `--port` \u6a19\u8a8c\u6703\u521d\u59cb\u5316\u9023\u63a5\u5230\u4e92\u806f\u7db2\u7684\u516c\u5171\u7aef\u53e3 80\uff0c `--target-port` \u6a19\u8a8c\u6703\u5c07\u6d41\u91cf\u8def\u7531\u5230\u61c9\u7528\u7684\u7aef\u53e3 8080\u3002\n\u8ca0\u8f09\u5747\u8861\u5668\u6309 Compute Engine \u7684 [\u8ca0\u8f09\u5747\u8861\u5668\u50f9\u683c](https://cloud.google.com/compute/pricing?hl=zh-cn#lb) \u8a08\u8cbb\u3002\n### \u6aa2\u67e5\u548c\u67e5\u770b\u61c9\u7528\n- \u4f7f\u7528 [kubectl get pods](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#get) \u6aa2\u67e5\u6b63\u5728\u904b\u884c\u7684 Pod\uff1a```\nkubectl get pods\n```\u60a8\u61c9\u8a72\u6703\u770b\u5230\u4e00\u500b `hello-server` Pod \u6b63\u5728\u60a8\u7684\u96c6\u7fa3\u4e0a\u904b\u884c\u3002\n- \u4f7f\u7528 [kubectl get service](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#get) \u6aa2\u67e5 `hello-server` Service\uff1a```\nkubectl get service hello-server\n```\u5f9e\u6b64\u547d\u4ee4\u7684\u8f38\u51fa\u7d50\u679c\u7684 `EXTERNAL-IP` \u5217\u4e2d\uff0c\u8907\u88fd Service \u7684\u5916\u90e8 IP \u5730\u5740\u3002 **\u6ce8\u610f** \uff1a\u53ef\u80fd\u9700\u8981\u7b49\u5f85\u5e7e\u5206\u9418\uff0c\u624d\u80fd\u770b\u5230\u586b\u5145\u7684 Service \u5916\u90e8 IP \u5730\u5740\u3002\u5982\u679c\u61c9\u7528\u7684\u5916\u90e8 IP \u5730\u5740\u662f `<pending>` \uff0c\u8acb\u518d\u6b21\u904b\u884c `kubectl get` \u3002\n- \u5728\u60a8\u7684\u7db2\u7d61\u700f\u89bd\u5668\u4e2d\u4f7f\u7528\u5916\u90e8 IP \u5730\u5740\u53ca\u516c\u958b\u7684\u7aef\u53e3\u67e5\u770b\u61c9\u7528\uff1a```\nhttp://EXTERNAL_IP\n```\n\u60a8\u525b\u525b\u5411 GKE \u90e8\u7f72\u4e86\u4e00\u500b\u5bb9\u5668\u5316 Web \u61c9\u7528\u3002## \u6e05\u7406\u7232\u907f\u514d\u56e0\u672c\u9801\u4e2d\u4f7f\u7528\u7684\u8cc7\u6e90\u5c0e\u81f4\u60a8\u7684 Google Cloud \u8cec\u865f\u7522\u751f\u8cbb\u7528\uff0c\u8acb\u6309\u7167\u4ee5\u4e0b\u6b65\u9a5f\u64cd\u4f5c\u3002- \u904b\u884c [kubectl delete](https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#delete) \u4ee5\u522a\u9664\u61c9\u7528\u7684 Service\uff1a```\nkubectl delete service hello-server\n```\u6b64\u547d\u4ee4\u6703\u522a\u9664\u60a8\u5728\u516c\u958b Deployment \u6642\u5275\u5efa\u7684 Compute Engine \u8ca0\u8f09\u5747\u8861\u5668\u3002\n- \u904b\u884c [gcloud container clusters delete](https://cloud.google.com/sdk/gcloud/reference/container/clusters/delete?hl=zh-cn) \u4ee5\u522a\u9664\u60a8\u7684\u96c6\u7fa3\uff1a```\ngcloud container clusters delete hello-cluster \\\u00a0 \u00a0 --location us-central1\n```\n## \u53ef\u9078\uff1ahello-app \u4ee3\u78bc\u5be9\u8988`hello-app` \u662f\u4e00\u500b\u7c21\u55ae\u7684 Web \u670d\u52d9\u5668\u61c9\u7528\uff0c\u7531\u5169\u500b\u6587\u4ef6\u7d44\u6210\uff1a `main.go` \u548c `Dockerfile` \u3002\n`hello-app` \u6253\u5305\u7232 [Docker](https://docker.com/) \u5bb9\u5668\u6620\u50cf\u3002\u5bb9\u5668\u6620\u50cf\u5b58\u5132\u5728\u4efb\u610f Docker \u6620\u50cf\u8a3b\u518a\u8868\uff08\u4f8b\u5982 Artifact Registry\uff09\u4e2d\u3002\u6211\u5011\u5728 `us-docker.pkg.dev/google-samples/containers/gke/hello-app` \u7684 Artifact Registry \u4ee3\u78bc\u5eab\u4e2d\u8a17\u7ba1 `hello-app` \u3002\n`main.go` \u662f\u4f7f\u7528 [Go \u7de8\u7a0b\u8a9e\u8a00](https://golang.org) \u7de8\u5beb\u7684\u4e00\u500b Web \u670d\u52d9\u5668\u5be6\u73fe\u3002\u8a72\u670d\u52d9\u5668\u6703\u4ee5\u4e00\u689d\u201cHello, world!\u201d\u6d88\u606f\u97ff\u61c9\u4efb\u4f55 HTTP \u8acb\u6c42\u3002\n [  quickstarts/hello-app/main.go ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/quickstarts/hello-app/main.go) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/quickstarts/hello-app/main.go) \n```\npackage mainimport (\u00a0 \u00a0 \u00a0 \u00a0 \"fmt\"\u00a0 \u00a0 \u00a0 \u00a0 \"log\"\u00a0 \u00a0 \u00a0 \u00a0 \"net/http\"\u00a0 \u00a0 \u00a0 \u00a0 \"os\")func main() {\u00a0 \u00a0 \u00a0 \u00a0 // register hello function to handle all requests\u00a0 \u00a0 \u00a0 \u00a0 mux := http.NewServeMux()\u00a0 \u00a0 \u00a0 \u00a0 mux.HandleFunc(\"/\", hello)\u00a0 \u00a0 \u00a0 \u00a0 // use PORT environment variable, or default to 8080\u00a0 \u00a0 \u00a0 \u00a0 port := os.Getenv(\"PORT\")\u00a0 \u00a0 \u00a0 \u00a0 if port == \"\" {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 port = \"8080\"\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 // start the web server on port and accept requests\u00a0 \u00a0 \u00a0 \u00a0 log.Printf(\"Server listening on port %s\", port)\u00a0 \u00a0 \u00a0 \u00a0 log.Fatal(http.ListenAndServe(\":\"+port, mux))}// hello responds to the request with a plain-text \"Hello, world\" message.func hello(w http.ResponseWriter, r *http.Request) {\u00a0 \u00a0 \u00a0 \u00a0 log.Printf(\"Serving request: %s\", r.URL.Path)\u00a0 \u00a0 \u00a0 \u00a0 host, _ := os.Hostname()\u00a0 \u00a0 \u00a0 \u00a0 fmt.Fprintf(w, \"Hello, world!\\n\")\u00a0 \u00a0 \u00a0 \u00a0 fmt.Fprintf(w, \"Version: 1.0.0\\n\")\u00a0 \u00a0 \u00a0 \u00a0 fmt.Fprintf(w, \"Hostname: %s\\n\", host)}\n```\n`Dockerfile` \u7528\u65bc\u63cf\u8ff0\u60a8\u5e0c\u671b Docker \u69cb\u5efa\u7684\u6620\u50cf\uff08\u5305\u62ec\u5176\u6240\u6709\u8cc7\u6e90\u548c\u4f9d\u8cf4\u9805\uff09\uff0c\u4e26\u6307\u5b9a\u61c9\u7528\u61c9\u8a72\u516c\u958b\u7684\u7db2\u7d61\u7aef\u53e3\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u6b64\u6587\u4ef6\u7684\u5de5\u4f5c\u65b9\u5f0f\uff0c\u8acb\u53c3\u95b1 Docker \u6587\u6a94\u4e2d\u7684 [Dockerfile \u53c3\u8003](https://docs.docker.com/engine/reference/builder/) \u3002\n [  quickstarts/hello-app/Dockerfile ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/quickstarts/hello-app/Dockerfile) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/quickstarts/hello-app/Dockerfile) \n```\nFROM golang:1.21.0 as builderWORKDIR /appRUN go mod init hello-appCOPY *.go ./RUN CGO_ENABLED=0 GOOS=linux go build -o /hello-appFROM gcr.io/distroless/base-debian11WORKDIR /COPY --from=builder /hello-app /hello-appENV PORT 8080USER nonroot:nonrootCMD [\"/hello-app\"]\n```\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u8a73\u7d30\u77ad\u89e3\u5982\u4f55 [\u5275\u5efa\u96c6\u7fa3](https://cloud.google.com/kubernetes-engine/docs/how-to/creating-a-container-cluster?hl=zh-cn) \u3002\n- \u8a73\u7d30\u77ad\u89e3 [Kubernetes](http://kubernetes.io/) \u3002\n- \u77ad\u89e3\u5982\u4f55 [\u6253\u5305\u3001\u8a17\u7ba1\u548c\u90e8\u7f72\u7c21\u55ae\u7684 Web \u670d\u52d9\u5668\u61c9\u7528](https://cloud.google.com/kubernetes-engine/docs/tutorials/hello-app?hl=zh-cn) \u3002\n- [\u4f7f\u7528 Cloud Code for VS Code](https://cloud.google.com/code/docs/vscode/quickstart-local-dev?hl=zh-cn) \u6216 [Cloud Code for IntelliJ](https://cloud.google.com/code/docs/intellij/deploy-kubernetes-app?hl=zh-cn) \u90e8\u7f72 Kubernetes \u61c9\u7528\u3002\n- \u77ad\u89e3\u5982\u4f55 [\u5c07 Linux \u61c9\u7528\u5347\u7d1a\u7232\u5bb9\u5668\u5e73\u81fa](https://cloud.google.com/code/docs/vscode/replatform-apps-to-containers?hl=zh-cn) \u3002", "guide": "Google Kubernetes Engine (GKE)"}