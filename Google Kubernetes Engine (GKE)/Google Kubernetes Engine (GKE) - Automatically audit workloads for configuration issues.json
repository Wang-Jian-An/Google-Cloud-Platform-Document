{"title": "Google Kubernetes Engine (GKE) - Automatically audit workloads for configuration issues", "url": "https://cloud.google.com/kubernetes-engine/docs/how-to/protect-workload-configuration", "abstract": "# Google Kubernetes Engine (GKE) - Automatically audit workloads for configuration issues\nThis page shows you how to automatically audit your workload configurations for security concerns and get actionable recommendations to improve the security posture of your Google Kubernetes Engine (GKE) Autopilot and Standard clusters. Workload configuration auditing is a feature of the security posture dashboard. For more information, see [About workload configuration auditing](/kubernetes-engine/docs/concepts/about-configuration-scanning) .\n", "content": "## Pricing\nThe security posture dashboard is offered at no extra charge in GKE through the Container Security API.\nEntries added to Cloud Logging use [Cloud Logging pricing](/stackdriver/pricing#logging-costs) .\n## Before you begin\nBefore you start, make sure you have performed the following tasks:\n- Enable    the Google Kubernetes Engine API.\n- [    Enable Google Kubernetes Engine API   ](https://console.cloud.google.com/flows/enableapi?apiid=container.googleapis.com) \n- If you want to use the Google Cloud CLI for this task, [install](/sdk/docs/install) and then [initialize](/sdk/docs/initializing) the  gcloud CLI. If you previously installed the gcloud CLI, get the latest  version by running`gcloud components update`. **Note:** For existing gcloud CLI  installations, make sure to set the`compute/region`and`compute/zone` [properties](/sdk/docs/properties#setting_properties) . By setting default locations,  you can avoid errors in gcloud CLI like the following:`One of [--zone, --region] must be supplied: Please specify location`.\n- Enable the Container Security API. [EnableContainer Security API](https://console.cloud.google.com/flows/enableapi?apiid=containersecurity.googleapis.com) \n### Requirements\n- To get the permissions that you need to use workload configuration auditing,   ask your administrator to grant you the [Security Posture Viewer ](https://cloud.google.com/iam/docs/understanding-roles#containersecurity.viewer) ( `roles/containersecurity.viewer` ) IAM role on your Google Cloud project.    For more information about granting roles, see [Manage access](/iam/docs/granting-changing-revoking-access) .This predefined role contains     the permissions required to use workload configuration auditing. To see the exact permissions that are   required, expand the **Required permissions** section:You might also be able to get   these permissions  with [custom roles](/iam/docs/creating-custom-roles) or  other [predefined roles](/iam/docs/understanding-roles) .\n- Workload configuration auditing requires GKE version 1.21 and later.\n**Note:** Workload configuration auditing is automatically enabled when you create new Autopilot or Standard clusters running version 1.27 and later. For these cluster versions, skip to [Deploy a test workload](#deploy-test-workload) .\n## Enable workload configuration auditing\nWorkload configuration auditing is enabled by default in new Autopilot and Standard clusters running version 1.27 and later. You can also manually enable this feature using the gcloud CLI or the Google Cloud console.\n### Enable configuration auditing on a new cluster\nCreate a new GKE cluster using the gcloud CLI:\n```\ngcloud container clusters create-auto CLUSTER_NAME \\\u00a0 \u00a0 --location=LOCATION \\\u00a0 \u00a0 --security-posture=standard\n```\nReplace the following:- ``: the name of your new cluster.\n- ``: the [Compute Engine region or zone](/compute/docs/regions-zones#available) for your   cluster.\n- Go to the **Google Kubernetes Engine** page in the Google Cloud console. [Go to Google Kubernetes Engine](https://console.cloud.google.com/kubernetes/list) \n- Clickadd_box **Create** .\n- In the **GKE Autopilot** section, click **Configure** .\n- In the navigation pane, click **Advanced settings** . If you're creating a Standard cluster, click **Security** instead.\n- In the **Security** section, select the **Configuration audit** checkbox.\n- Configure other options for your cluster and click **Create** when you're ready.\n### Enable configuration auditing on an existing cluster\nUpdate the cluster:\n```\ngcloud container clusters update CLUSTER_NAME \\\u00a0 \u00a0 --location=LOCATION \\\u00a0 \u00a0 --security-posture=standard\n```Replace the following:- ``: the name of your cluster.\n- ``: the [Compute Engine region or zone](/compute/docs/regions-zones#available) of your   cluster.\n- Go to the **Security Posture** page in the Google Cloud console. [Go to Security Posture](https://console.cloud.google.com/kubernetes/security/dashboard) \n- Click the **Settings** tab.\n- In the **Configuration audit enabled clusters** section, click **Select clusters** .\n- In the **Audit disabled** tab, select the checkboxes for the   clusters that you want to add.\n- Click **Enable audit** , then click **Confirm** to enable  auditing on those clusters.\nIf you use Google Kubernetes Engine (GKE) Enterprise edition to manage fleets of clusters, you can also configure fleet-level configuration auditing settings that apply to all member clusters. For instructions, see [Configure GKE security posture dashboard features at fleet-level](/kubernetes-engine/docs/how-to/fleet-security-posture) .\n## Deploy a test workload\nDeploy a sample application that intentionally violates the Pod Security Standards.\n- Save the following manifest as `misconfig-sample.yaml` :```\napiVersion: apps/v1kind: Deploymentmetadata:\u00a0 name: helloweb\u00a0 labels:\u00a0 \u00a0 app: hellospec:\u00a0 selector:\u00a0 \u00a0 matchLabels:\u00a0 \u00a0 \u00a0 app: hello\u00a0 \u00a0 \u00a0 tier: web\u00a0 template:\u00a0 \u00a0 metadata:\u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 app: hello\u00a0 \u00a0 \u00a0 \u00a0 tier: web\u00a0 \u00a0 spec:\u00a0 \u00a0 \u00a0 containers:\u00a0 \u00a0 \u00a0 - name: hello-app\u00a0 \u00a0 \u00a0 \u00a0 image: us-docker.pkg.dev/google-samples/containers/gke/hello-app:1.0\u00a0 \u00a0 \u00a0 \u00a0 ports:\u00a0 \u00a0 \u00a0 \u00a0 - containerPort: 8080\u00a0 \u00a0 \u00a0 \u00a0 securityContext:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 runAsNonRoot: false\u00a0 \u00a0 \u00a0 \u00a0 resources:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 requests:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 cpu: 200m\n```\n- Deploy the application to your cluster:```\nkubectl apply -f misconfig-sample.yaml\n```\nIf you want to try other violations, modify `misconfig-sample.yaml` with the corresponding \"bad\" configuration.\n## View and action configuration audit results\nThe initial audit takes up to 15 minutes to return results. GKE displays the results on the security posture dashboard and automatically adds entries to the cluster logs.\n### View results\nTo see an overview of discovered concerns across your project's clusters and workloads, do the following:\n- Go to the **Security Posture** page in the Google Cloud console. [Go to Security Posture](https://console.cloud.google.com/kubernetes/security/dashboard) \n- Click the **Concerns** tab.\n- In the **Filter concerns** pane, in the **Concern type** section, select the **Configuration** checkbox.\n### View concern details and recommendations\nTo view detailed information about a specific configuration concern, click the row containing that concern.\nThe **Configuration Concern** pane shows the following information:\n- **Description:** a description of the concern.\n- **Recommended action:** an overview of actions that you can take to fix the configuration issue. This section includes the following details:- Which resources need the fix\n- Sample commands that you can run to apply the fix to affected resources\n- The Google Cloud console instructions, if applicable, to fix the issue\n### View logs for discovered concerns\nGKE adds entries to Logging for each discovered concern.\n- Go to the **Logs Explorer** in the Google Cloud console. [Goto Logs Explorer](https://console.cloud.google.com/logs/query) \n- In the **Query** field, specify the following query:```\nresource.type=\"k8s_cluster\"\njsonPayload.@type=\"type.googleapis.com/cloud.kubernetes.security.containersecurity_logging.Finding\"\njsonPayload.type=\"FINDING_TYPE_MISCONFIG\"\n```\n- Click **Run query** .## Clean up\n- Delete the sample workload that you deployed.```\nkubectl delete deployment helloweb\n```\n- Optionally, delete the cluster that you used.```\ngcloud container clusters delete CLUSTER_NAME \\\u00a0 \u00a0 --region=COMPUTE_REGION\n```## Disable workload configuration auditing\nYou can disable workload configuration auditing using either the gcloud CLI or the Google Cloud console.\nRun the following command:\n```\ngcloud container clusters update CLUSTER_NAME \\\u00a0 \u00a0 --region=LOCATION \\\u00a0 \u00a0 --security-posture=disabled\n```\nReplace the following:- ``: the name of your cluster.\n- ``: the [Compute Engine region or zone](/compute/docs/regions-zones#available) for your   cluster.\n- Go to the **Security Posture** page in the Google Cloud console. [Go to Security Posture](https://console.cloud.google.com/kubernetes/security/dashboard) \n- Click the **Settings** tab.\n- In the **Configuration audit enabled clusters** section, click **Select clusters** .\n- In the **Audit enabled** tab, select the checkboxes for the   clusters that you want to remove.\n- Click **Disable audit** , then click **Confirm** to disable  auditing on those clusters.## Limitations of workload configuration auditing\n- Windows Server node pools aren't supported.\n- Workload configuration auditing doesn't scan GKE-managed workloads, such as workloads in the`kube-system`namespace.\n- Workload configuration auditing is only available for clusters with less than 1,000 nodes.## What's next\n- [Learn more about the security posture dashboard](/kubernetes-engine/docs/concepts/about-security-posture-dashboard) .\n- [Learn more about how configuration auditing works](/kubernetes-engine/docs/concepts/about-configuration-scanning) .\n- [Learn how to secure your clusters based on Google's recommendations](/kubernetes-engine/docs/how-to/hardening-your-cluster) .", "guide": "Google Kubernetes Engine (GKE)"}