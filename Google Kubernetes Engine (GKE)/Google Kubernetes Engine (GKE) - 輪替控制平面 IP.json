{"title": "Google Kubernetes Engine (GKE) - \u8f2a\u66ff\u63a7\u5236\u5e73\u9762 IP", "url": "https://cloud.google.com/kubernetes-engine/docs/how-to/ip-rotation?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - \u8f2a\u66ff\u63a7\u5236\u5e73\u9762 IP\n\u672c\u9801\u9762\u4ecb\u7d39\u5982\u4f55\u5728\u904b\u884c\u7248\u672c 1.16.10-gke.8 \u53ca\u66f4\u9ad8\u7248\u672c\u7684 Google Kubernetes Engine (GKE) \u96c6\u7fa3\u4e2d\u57f7\u884c\u63a7\u5236\u5c64\u9762 IP \u5730\u5740\u8f2a\u66ff\u3002\n", "content": "## \u6982\u89bd\n\u5982\u9700\u66f4\u6539\u63a7\u5236\u5e73\u9762\u7528\u65bc\u8655\u7406\u4f86\u81ea Kubernetes API \u7684\u8acb\u6c42\u7684 IP \u5730\u5740\uff0c\u60a8\u53ef\u4ee5\u57f7\u884c IP \u8f2a\u66ff\u3002\u63a7\u5236\u5e73\u9762 IP \u5730\u5740\u662f\u975c\u614b\u5730\u5740\uff0c\u9664\u975e\u60a8\u57f7\u884c IP \u5730\u5740\u8f2a\u66ff\uff0c\u5426\u5247\u8a72\u5730\u5740\u4e0d\u6703\u6539\u8b8a\u3002\nIP \u5730\u5740\u8f2a\u66ff\u6703\u66f4\u6539 SSL \u8b49\u66f8\u548c\u96c6\u7fa3\u8b49\u66f8\u6388\u6b0a\u6a5f\u69cb (CA)\uff0c\u5f9e\u800c\u9650\u5236\u5148\u524d\u5730\u5740\u8207\u65b0\u5730\u5740\u7684\u9023\u63a5\u3002\nIP \u5730\u5740\u8f2a\u66ff\u4e5f\u662f [\u6191\u64da\u8f2a\u66ff](https://cloud.google.com/kubernetes-engine/docs/how-to/credential-rotation?hl=zh-cn) \u7684\u4e00\u90e8\u5206\u3002\n## \u6e96\u5099\u5de5\u4f5c\n\u5728\u958b\u59cb\u4e4b\u524d\uff0c\u8acb\u78ba\u4fdd\u60a8\u5df2\u57f7\u884c\u4ee5\u4e0b\u4efb\u52d9\uff1a\n- \u5553\u7528 Google Kubernetes Engine API\u3002\n- [  \u5553\u7528 Google Kubernetes Engine API ](https://console.cloud.google.com/flows/enableapi?apiid=container.googleapis.com&hl=zh-cn) \n- \u5982\u679c\u60a8\u8981\u4f7f\u7528 Google Cloud CLI \u57f7\u884c\u6b64\u4efb\u52d9\uff0c\u8acb [\u5b89\u88dd](https://cloud.google.com/sdk/docs/install?hl=zh-cn) \u4e26 [\u521d\u59cb\u5316](https://cloud.google.com/sdk/docs/initializing?hl=zh-cn) gcloud CLI\u3002 \u5982\u679c\u60a8\u4e4b\u524d\u5b89\u88dd\u4e86 gcloud CLI\uff0c\u8acb\u904b\u884c`gcloud components update`\u4ee5\u7372\u53d6\u6700\u65b0\u7248\u672c\u3002 **\u6ce8\u610f** \uff1a\u5c0d\u65bc\u73fe\u6709 gcloud CLI \u5b89\u88dd\uff0c\u8acb\u52d9\u5fc5\u8a2d\u7f6e`compute/region`\u548c`compute/zone` [\u5c6c\u6027](https://cloud.google.com/sdk/docs/properties?hl=zh-cn#setting_properties) \u3002\u901a\u904e\u8a2d\u7f6e\u9ed8\u8a8d\u4f4d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u907f\u514d gcloud CLI \u4e2d\u51fa\u73fe\u4ee5\u4e0b\u932f\u8aa4\uff1a`One of [--zone, --region] must be supplied: Please specify location`\u3002## \u57f7\u884c IP \u5730\u5740\u8f2a\u66ff\nIP \u8f2a\u66ff\u6d89\u53ca\u591a\u500b\u6b65\u9a5f\uff1a\n- \u7576\u60a8\u5553\u52d5 IP \u8f2a\u66ff\u6642\uff0c\u9664\u4e86\u539f\u59cb IP \u5730\u5740\u4ee5\u5916\uff0c\u63a7\u5236\u5c64\u9762\u9084\u6703\u958b\u59cb\u901a\u904e\u65b0 IP \u5730\u5740\u63d0\u4f9b\u670d\u52d9\u3002\n- GKE \u6703\u91cd\u65b0\u5275\u5efa\u7bc0\u9ede\u6c60\u4ee5\u4f7f\u7528\u65b0\u7684 IP \u5730\u5740\u3002\n- \u5553\u52d5\u8f2a\u66ff\u5f8c\uff0c\u60a8\u5fc5\u9808\u66f4\u65b0\u96c6\u7fa3\u7684 API \u5ba2\u6236\u7aef\uff08\u4f8b\u5982\u4f7f\u7528`kubectl`\u547d\u4ee4\u884c\u754c\u9762\u7684\u958b\u767c\u6a5f\u5668\uff09\u624d\u80fd\u958b\u59cb\u901a\u904e\u65b0 IP \u5730\u5740\u8207\u63a7\u5236\u5c64\u9762\u901a\u4fe1\u3002\n- \u5b8c\u6210\u8f2a\u66ff\u5f8c\uff0c\u63a7\u5236\u5c64\u9762\u4fbf\u6703\u505c\u6b62\u901a\u904e\u820a IP \u5730\u5740\u8655\u7406\u6d41\u91cf\u3002\n**\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u5553\u52d5 IP \u8f2a\u66ff\uff0c\u4f46\u672a\u5b8c\u6210\u6b64\u904e\u7a0b\uff0c\u5247 GKE \u6703\u5728\u4e03\u5929\u5f8c\u81ea\u52d5\u5b8c\u6210\u8f2a\u66ff\u3002\n### \u5553\u52d5\u8f2a\u66ff\n- \u8981\u5553\u52d5 IP \u8f2a\u66ff\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud container clusters update CLUSTER_NAME \\\u00a0 \u00a0 --start-ip-rotation\n```\u5c07 `` \u66ff\u63db\u7232\u60a8\u7684\u96c6\u7fa3\u7684\u540d\u7a31\u3002\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nThis will start an IP Rotation on cluster CLUSTER_NAME.\nThe master will be updated to serve on a new IP address in addition to\nthe current IP address. Google Kubernetes Engine will then schedule recreation of all nodes\nto point to the new IP address. If maintenance window is\nused, nodes are not recreated until a maintenance window occurs. See\ndocumentation on how to manually update nodes. This operation is\nlong-running and will block other operations on the cluster (including\ndelete) until it has run to completion.\nDo you want to continue (Y/n)?\n```\u6b64\u547d\u4ee4\u6703\u5c07\u63a7\u5236\u5e73\u9762\u914d\u7f6e\u7232\u901a\u904e\u5169\u500b IP \u5730\u5740\uff08\u539f\u59cb\u5730\u5740\u548c\u65b0\u5730\u5740\uff09\u8655\u7406\u6d41\u91cf\u3002 **\u6ce8\u610f** \uff1a\u6b64\u547d\u4ee4\u6703\u5c0e\u81f4\u96c6\u7fa3 API \u77ed\u66ab\u505c\u6a5f\u3002\n- \u78ba\u8a8d\u8f2a\u66ff\u4e26\u4f7f shell \u4fdd\u6301\u6253\u958b\u72c0\u614b\uff0c\u4ee5\u4f7f\u64cd\u4f5c\u5b8c\u6210\u3002\n### \u91cd\u65b0\u5275\u5efa\u7bc0\u9ede\n\u91cd\u65b0\u914d\u7f6e API \u670d\u52d9\u5668\u4ee5\u5728\u65b0 IP \u5730\u5740\u4e0a\u63d0\u4f9b\u670d\u52d9\u5f8c\uff0cGKE \u6703\u81ea\u52d5\u66f4\u65b0\u60a8\u7684\u7bc0\u9ede\u4ee5\u4f7f\u7528\u65b0\u7684 IP \u5730\u5740\u3002GKE \u6703\u5c07\u6240\u6709\u7bc0\u9ede\u5347\u7d1a\u5230\u6700\u63a5\u8fd1\u7684\u53d7\u652f\u6301\u7bc0\u9ede\u7248\u672c\uff0c\u5f9e\u800c\u91cd\u65b0\u5275\u5efa\u7bc0\u9ede\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7bc0\u9ede\u6c60\u5347\u7d1a](https://cloud.google.com/kubernetes-engine/docs/concepts/cluster-upgrades?hl=zh-cn#node_pool_upgrades) \u3002\n\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cGKE \u6703\u5728\u60a8\u5553\u52d5\u64cd\u4f5c\u4e03\u5929\u5f8c\u81ea\u52d5\u5b8c\u6210 IP \u5730\u5740\u8f2a\u66ff\u3002\u5982\u679c\u96c6\u7fa3\u4e2d\u7684\u6d3b\u8e8d\u7dad\u8b77\u7a97\u53e3\u6216\u6392\u9664\u9805\u6703\u963b\u6b62 GKE \u5728\u9019\u4e03\u5929\u5167\u91cd\u65b0\u5275\u5efa\u67d0\u4e9b\u7bc0\u9ede\uff0c\u5247 IP \u5730\u5740\u8f2a\u66ff\u7121\u6cd5\u5b8c\u6210\u3002\n- \u5982\u679c\u60a8\u4f7f\u7528\u53ef\u80fd\u5c0e\u81f4\u8f2a\u66ff\u5931\u6557\u7684\u7dad\u8b77\u6392\u9664\u9805\u6216\u7dad\u8b77\u7a97\u53e3\uff0c\u8acb\u624b\u52d5\u5347\u7d1a\u96c6\u7fa3\u4ee5\u5f37\u5236\u91cd\u65b0\u5275\u5efa\u7bc0\u9ede\uff1a```\ngcloud container clusters upgrade CLUSTER_NAME \\\u00a0 \u00a0 --location=LOCATION \\\u00a0 \u00a0 --cluster-version=VERSION\n```\u5c07 `` \u66ff\u63db\u7232\u96c6\u7fa3\u5df2\u5728\u4f7f\u7528\u7684\u540c\u4e00 GKE \u7248\u672c \u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7dad\u8b77\u7a97\u53e3\u7684\u6ce8\u610f\u4e8b\u9805](https://cloud.google.com/kubernetes-engine/docs/concepts/maintenance-windows-and-exclusions?hl=zh-cn#caveats) \u3002- \u8981\u5553\u52d5\u8f2a\u66ff\u64cd\u4f5c\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud container operations list \\\u00a0 \u00a0 --filter=\"operationType=UPGRADE_NODES AND status=RUNNING\" \\\u00a0 \u00a0 --format=\"value(name)\"\n```\u6b64\u547d\u4ee4\u8fd4\u56de\u7bc0\u9ede\u5347\u7d1a\u64cd\u4f5c\u7684 ID \u3002\n- \u8981\u8f2a\u8a62\u64cd\u4f5c\uff0c\u8acb\u5c07\u64cd\u4f5c ID \u50b3\u905e\u7d66\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud container operations wait OPERATION_ID\n```\n\u7bc0\u9ede\u6c60\u6703\u9010\u4e00\u91cd\u65b0\u5275\u5efa\uff0c\u4e26\u4e14\u6bcf\u500b\u7bc0\u9ede\u6c60\u90fd\u6709\u81ea\u5df1\u7684\u64cd\u4f5c\u3002\u5982\u679c\u60a8\u6709\u591a\u500b\u7bc0\u9ede\u6c60\uff0c\u8acb\u6309\u7167\u4ee5\u4e0b\u8aaa\u660e\u8f2a\u8a62\u6bcf\u500b\u64cd\u4f5c\u3002\n### \u66f4\u65b0 API \u5ba2\u6236\u7aef\n\u5553\u52d5 IP \u5730\u5740\u8f2a\u66ff\u5f8c\uff0c\u60a8\u5fc5\u9808\u66f4\u65b0\u96c6\u7fa3\u5916\u7684\u6240\u6709 API \u5ba2\u6236\u7aef\uff08\u4f8b\u5982\u958b\u767c\u8005\u6a5f\u5668\u4e0a\u7684 `kubectl` \uff09\u4ee5\u6307\u5411\u65b0\u7684 IP \u5730\u5740\u3002\n\u8981\u66f4\u65b0 API \u5ba2\u6236\u7aef\uff0c\u8acb\u7232\u6bcf\u500b\u5ba2\u6236\u7aef\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ngcloud container clusters get-credentials CLUSTER_NAME\n```\n**\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f Kubernetes Certificates API\uff0c\u5247\u9084\u5fc5\u9808 [\u9812\u767c\u65b0\u8b49\u66f8](https://kubernetes.io/docs/tasks/tls/managing-tls-in-a-cluster/) \u3002\n### \u5b8c\u6210\u8f2a\u66ff\n\u66f4\u65b0\u96c6\u7fa3\u5916\u90e8\u7684 API \u5ba2\u6236\u7aef\u5f8c\uff0c\u5b8c\u6210\u8f2a\u66ff\u4ee5\u5c07\u63a7\u5236\u5e73\u9762\u914d\u7f6e\u7232\u50c5\u901a\u904e\u65b0 IP \u5730\u5740\u8655\u7406\u6d41\u91cf\u3002\n\u8981\u5b8c\u6210\u8f2a\u66ff\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ngcloud container clusters update CLUSTER_NAME \\\u00a0 \u00a0 --complete-ip-rotation\n```\n\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a\n```\nThis will complete the in-progress IP Rotation on cluster CLUSTER_NAME.\nThe master will be updated to stop serving on the old IP address and only\nserve on the new IP address. Make sure all API clients have been updated\nto communicate with the new IP address (e.g. by running `gcloud container\nclusters get-credentials --project PROJECT_ID --region COMPUTE_REGION\nCLUSTER_NAME`). This operation is long-running and will\nblock other operations on the cluster (including delete) until it has\nrun to completion.\n```\n**\u6ce8\u610f** \uff1a\u6b64\u547d\u4ee4\u6703\u5c0e\u81f4\u96c6\u7fa3 API \u77ed\u66ab\u505c\u6a5f\u3002\n\u5982\u679c IP \u5730\u5740\u8f2a\u66ff\u7121\u6cd5\u5b8c\u6210\uff0c\u4e26\u8fd4\u56de\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\u7684\u932f\u8aa4\u6d88\u606f\uff0c\u8acb\u53c3\u95b1 [\u554f\u984c\u6392\u67e5](https://cloud.google.com/kubernetes-engine/docs/troubleshooting?hl=zh-cn#credential-rotation-node-recreate) \uff1a\n```\nERROR: (gcloud.container.clusters.update) ResponseError: code=400, message=Node pool \"test-pool-1\" requires recreation.\n```\n## \u5f8c\u7e8c\u6b65\u9a5f\n- [\u77ad\u89e3\u5225\u540d IP](https://cloud.google.com/kubernetes-engine/docs/how-to/alias-ips?hl=zh-cn) \u3002\n- [\u77ad\u89e3 IP \u50de\u88dd\u4ee3\u7406](https://cloud.google.com/kubernetes-engine/docs/how-to/ip-masquerade-agent?hl=zh-cn) \u3002\n- [\u77ad\u89e3\u5982\u4f55\u914d\u7f6e\u6388\u6b0a\u7db2\u7d61](https://cloud.google.com/kubernetes-engine/docs/how-to/authorized-networks?hl=zh-cn) \u3002", "guide": "Google Kubernetes Engine (GKE)"}