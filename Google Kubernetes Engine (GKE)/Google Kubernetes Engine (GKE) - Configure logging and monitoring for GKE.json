{"title": "Google Kubernetes Engine (GKE) - Configure logging and monitoring for GKE", "url": "https://cloud.google.com/kubernetes-engine/docs/how-to/config-logging-monitoring?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - Configure logging and monitoring for GKE\nGoogle Kubernetes Engine (GKE) includes integration with Cloud Logging and Cloud Monitoring, including [Google Cloud Managed Service for Prometheus](/stackdriver/docs/managed-prometheus) .\nThis integration lets you monitor your running GKE clusters, manage your system and debug logs, and analyze your system's performance using advanced profiling and tracing capabilities.\nThis integration also provides a [dashboard](/kubernetes-engine/docs/how-to/view-observability-metrics) for observing your GKE clusters.\nSecurity logs, including basic audit logs, are available for GKE and most other Google Cloud services even when Cloud Logging is not enabled for a GKE cluster. For more information, see [Cloud Audit Logs](/logging/docs/audit) .\nThis page describes how to do the following:\n- Create a new cluster and configure Cloud Logging, Cloud Monitoring, and Google Cloud Managed Service for Prometheus.\n- Select which logs and metrics to collect.\n- Disable Cloud Logging, Cloud Monitoring, and Google Cloud Managed Service for Prometheus for a cluster.\nFor [GKE Autopilot](/kubernetes-engine/docs/concepts/autopilot-overview) clusters, you cannot disable the Cloud Logging and Cloud Monitoring integration.\n", "content": "## Before you begin\nBefore you start, make sure you have performed the following tasks:\n- Enable    the Google Kubernetes Engine API.\n- [    Enable Google Kubernetes Engine API   ](https://console.cloud.google.com/flows/enableapi?apiid=container.googleapis.com) \n- If you want to use the Google Cloud CLI for this task, [install](/sdk/docs/install) and then [initialize](/sdk/docs/initializing) the  gcloud CLI. If you previously installed the gcloud CLI, get the latest  version by running`gcloud components update`. **Note:** For existing gcloud CLI  installations, make sure to set the`compute/region`and`compute/zone` [properties](/sdk/docs/properties#setting_properties) . By setting default locations,  you can avoid errors in gcloud CLI like the following:`One of [--zone, --region] must be supplied: Please specify location`.\n- Ensure you are an **Owner** of the project containing your cluster.\n- Ensure you have enabled the [Cloud Logging API](/logging/docs/reference/api-overview) . You can check the status of the Cloud Logging API from its [Overview page](https://console.cloud.google.com/apis/api/logging.googleapis.com/overview) .**Note:** If your [metrics scope](/monitoring/settings#concept-scope) is configured with a [VPC Service Controls](/vpc-service-controls) Service Perimeter for the Monitoring API, then Monitoring won't work for GKE clusters outside the perimeter. To learn more about Service Perimeters, see [Service perimeter details and configuration](/vpc-service-controls/docs/service-perimeters) .\n**Warning:** If you've disabled Cloud Logging or Cloud Monitoring, GKE customer support is offered on a best-effort basis and might require additional effort from your engineering team.\n## Logs and metrics\nYou have a choice whether or not to send logs and metrics from your GKE cluster to Cloud Logging and Cloud Monitoring. The following sections describe which logs and metrics are available, and which logs and metrics are enabled by default at cluster creation time.\n### Available logs\nIf you choose to send logs to Cloud Logging, you must send system logs, and you may optionally send logs from additional sources.\nLearn about [Cloud Logging pricing](/stackdriver/pricing#logging-costs) .\nThe following table indicates supported values for the `--logging` flag for the [create](/sdk/gcloud/reference/container/clusters/create) and [update](/sdk/gcloud/reference/container/clusters/update) commands.\n| Log Source   | --logging value | Logs Collected                                                                                                                 |\n|:-------------------|:-------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| nan    | NONE    | No logs sent to Cloud Logging; no log collection agent installed in the cluster. This value is not supported for GKE Autopilot clusters.                                                                                  |\n| System    | SYSTEM    | Collects logs from the following: All Pods running in namespaces kube-system, istio-system, knative-serving, gke-system, and config-management-system. Key services that are not containerized including docker/containerd runtime, kubelet, kubelet-monitor, node-problem-detector, and kube-container-runtime-monitor. The node's serial ports output, if the VM instance metadata serial-port-logging-enable is set to true. Additionally, collects Kubernetes events. |\n| Workloads   | WORKLOAD   | All logs generated by non-system containers running on user nodes.                                                                                                    |\n| API server   | API_SERVER   | All logs generated by kube-apiserver.                                                                                                           |\n| Scheduler   | SCHEDULER   | All logs generated by kube-scheduler.                                                                                                           |\n| Controller Manager | CONTROLLER_MANAGER | All logs generated by kube-controller-manager.                                                                                                         |### Available metrics\nIf you choose to send metrics to Cloud Monitoring, you must send system metrics and can optionally send additional metrics.\nLearn about [Cloud Monitoring pricing](/stackdriver/pricing#monitoring-costs) , including which metrics are non-chargeable.\nThe following table indicates supported values for the `--monitoring` flag for the [create](/sdk/gcloud/reference/container/clusters/create) and [update](/sdk/gcloud/reference/container/clusters/update) commands.\n| Source      | --monitoring value | Metrics Collected                                  |\n|:----------------------------|:---------------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------|\n| nan       | NONE     | No metrics sent to Cloud Monitoring; no metric collection agent installed in the cluster. This value is not supported for GKE Autopilot clusters.  |\n| System      | SYSTEM    | Metrics from essential system components required for Kubernetes. See a complete list of these Kubernetes metrics.          |\n| API server     | API_SERVER   | Metrics from kube-apiserver. See a complete list of API server metrics.                     |\n| Scheduler     | SCHEDULER   | Metrics from kube-scheduler. See a complete list of Scheduler metrics.                     |\n| Controller Manager   | CONTROLLER_MANAGER | Metrics from kube-controller-manager. See a complete list of Controller Manager metrics.                |\n| Persistent volume (Storage) | STORAGE    | Storage metrics from kube-state-metrics. Includes metrics for Persistent Volume and Persistent Volume Claims. See a complete list of Storage metrics. |\n| Pod       | POD     | Pod metrics from kube-state-metrics. See a complete list of Pod metrics.                    |\n| Deployment     | DEPLOYMENT   | Deployment metrics from kube-state-metrics. See a complete list of Deployment metrics.                 |\n| StatefulSet     | STATEFULSET   | StatefulSet metrics from kube-state-metrics. See a complete list of StatefulSet metrics.                |\n| DaemonSet     | DAEMONSET   | DaemonSet metrics from kube-state-metrics. See a complete list of DaemonSet metrics.                 |\n| HorizonalPodAutoscaler  | HPA     | HPA metrics from kube-state-metrics. See a complete list of HorizonalPodAutoscaler metrics.                |\nAdditionally, you can collect Prometheus-style metrics exposed by any GKE workload by using [Google Cloud Managed Service for Prometheus](/stackdriver/docs/managed-prometheus) , which lets you monitor and alert on your workloads, using Prometheus, without having to manually manage and operate Prometheus at scale.\n### Logs and metrics enabled by default\nWhen you create a new GKE cluster on Google Cloud, some logs and metrics are enabled by default during cluster creation.\n- System logs and metrics are enabled for all types of clusters and they can't be disabled.\n- Workload logs are enabled for all Autopilot clusters.\n- For GKE Enterprise edition projects, additional useful logs and metrics are enabled by default if you [register to a fleet](/anthos/fleet-management/docs/register/gke#register_your_cluster) while creating the cluster. If you want to enable those logs and metrics after a cluster is created, see [Modify your cluster](/kubernetes-engine/docs/how-to/config-logging-monitoring#upgrade-instructions) .\nIn the following tables, a checkmark ( ) indicates which logs and metrics are enabled by default when you a new cluster in a project with GKE Enterprise enabled:\n**Logs**\n| Log name   | Autopilot | Standard |\n|:-------------------|------------:|:-----------|\n| System    |   nan | nan  |\n| Workloads   |   nan | -   |\n| API server   |   nan | nan  |\n| Scheduler   |   nan | nan  |\n| Controller Manager |   nan | nan  |\nThe control plane logs (API server, Scheduler, and Controller Manager) incur Cloud Logging charges.\n**Metrics**\n| Metric name     | Autopilot | Standard |\n|:----------------------------|------------:|-----------:|\n| System      |   nan |  nan |\n| API server     |   nan |  nan |\n| Scheduler     |   nan |  nan |\n| Controller Manager   |   nan |  nan |\n| Persistent volume (Storage) |   nan |  nan |\n| Pods      |   nan |  nan |\n| Deployment     |   nan |  nan |\n| StatefulState    |   nan |  nan |\n| DaemonSet     |   nan |  nan |\n| HorizonalPodAutoscaler  |   nan |  nan |\nAll registered clusters in a project that has GKE Enterprise enabled can use [control plane metrics](/kubernetes-engine/docs/how-to/configure-metrics#control-plane-metrics) and [Kube state metrics](/kubernetes-engine/docs/how-to/configure-metrics#ksm-package) without any additional charges. Otherwise these metrics incur Cloud Monitoring charges.\nYou can choose to disable the default logs and metrics [during cluster creation](/kubernetes-engine/docs/how-to/config-logging-monitoring#installing) or [after the cluster is created](/kubernetes-engine/docs/how-to/config-logging-monitoring#upgrade-instructions) .\n## Configure monitoring and logging for a new cluster\nThe cluster-creation instructions in this section only cover the options relevant to Cloud Logging and Cloud Monitoring. For complete instructions on creating a GKE cluster, see the documentation for creating a [Standard](/kubernetes-engine/docs/how-to/creating-a-regional-cluster) or [Autopilot](/kubernetes-engine/docs/how-to/creating-an-autopilot-cluster) cluster.\nTo manually configure logging and monitoring while creating a GKE cluster, complete the following steps:\n**For an Autopilot cluster:** - On the Autopilot cluster creation page, from the navigation pane, click **Advanced settings** . [Create an Autopilot cluster](https://console.cloud.google.com/kubernetes/auto/add) \n- In the **Operations** list, select which logs and metrics you want collected.- In the **Components** list for Cloud Logging, select the components from which you want to collect logs.\n- In the **Components** list for Cloud Monitoring, select the components from which you want to collect metrics.\nAutopilot clusters always use Google's best practices for telemetry collection, meaning that system and workload logging is always enabled and system monitoring is always enabled.\n- Click **Create** .\n **For a Standard cluster:** - On the Standard cluster creation page, from the navigation pane, under **Cluster** , click **Features** . [Create a Kubernetes cluster](https://console.cloud.google.com/kubernetes/add) \n- In the **Operations** list, select which logs and metrics you want collected.- In the **Components** list for Cloud Logging, select the components from which you want to collect logs.\n- In the **Components** list for Cloud Monitoring, select the components from which you want to collect metrics.\n- To disable Cloud Logging (except for [audit logs](/kubernetes-engine/docs/how-to/audit-logging) ), clear the **Enable Cloud Logging** checkbox.\n- To disable Cloud Monitoring, clear the **Enable Cloud Monitoring** checkbox.\n- To disable Google Cloud Managed Service for Prometheus, clear the **Enable Google Cloud Managed Service for Prometheus** checkbox.\n **Note:** If you've disabled Cloud Logging or Cloud Monitoring, GKE customer support is offered on a best-effort basis and might require additional effort from your engineering team.\n- For new clusters, Cloud Logging and Cloud Monitoring are enabled by default. To create your cluster, run the following command:```\ngcloud container clusters create CLUSTER_NAME \\\u00a0 \u00a0 --location=COMPUTE_LOCATION\n```Replace the following:- ``: the name of your cluster.\n- ``: the [Compute Engine location](/compute/docs/regions-zones/viewing-regions-zones) for the cluster.\n- Alternatively, you can configure which logs are sent to Cloud Logging by passing a comma-separated list of values to the `create` command's `--logging` flag. To collect no logs, pass `--logging=NONE` . To collect system, API server, Scheduler, and Controller Manager logs, pass `--logging=SYSTEM,API_SERVER,SCHEDULER,CONTROLLER_MANAGER` . To collect both system and workload logs, pass `--logging=SYSTEM,WORKLOAD` . For example:```\ngcloud container clusters create CLUSTER_NAME \\\u00a0 \u00a0 --location=COMPUTE_LOCATION \\\u00a0 \u00a0 --logging=SYSTEM,WORKLOAD\n```\n- Similarly, you can configure which metrics are sent to Cloud Monitoring by passing a comma-separated list of values to the `--monitoring` flag. To collect no metrics, pass `--monitoring=NONE` . To collect system metrics, pass `--monitoring=SYSTEM` . To collect all metrics, pass `--monitoring=SYSTEM,API_SERVER,SCHEDULER,CONTROLLER_MANAGER,STORAGE,POD,DEPLOYMENT,STATEFULSET,` \u200b `DAEMONSET,HPA` . For example:```\ngcloud container clusters create CLUSTER_NAME \\\u00a0 \u00a0 --location=COMPUTE_LOCATION \\\u00a0 \u00a0 --monitoring=SYSTEM,API_SERVER,SCHEDULER,CONTROLLER_MANAGER,STORAGE,POD,DEPLOYMENT,STATEFULSET,DAEMONSET,HPA\n```\n- Separately, you can enable Google Cloud Managed Service for Prometheus by using the `--enable-managed-prometheus` flag. For example:```\ngcloud container clusters create CLUSTER_NAME \\\u00a0 \u00a0 --location=COMPUTE_LOCATION \\\u00a0 \u00a0 --enable-managed-prometheus\n```The `--enable-managed-prometheus` flag enables the managed collector, which must be [configured](/stackdriver/docs/managed-prometheus) .\n- To configure the collection of logs and metrics using Terraform, see the `logging_config` and `monitoring_config` blocks in the [Terraform registry for google_container_cluster](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/container_cluster) . Enabling the collection of logs from the API server, scheduler, and controller manager requires the Terraform Google Cloud provider version 4.44.0 or later.\n- For general information about using Google Cloud with Terraform, see [Terraform with Google Cloud](/docs/terraform) .\n## Configure monitoring and logging for an existing cluster\nThe following section details how to modify the Cloud Logging and Cloud Monitoring integration for an existing GKE cluster.\nChanging your monitoring and logging support, and changing the Kubernetes version of your cluster are distinct actions. Changing the Kubernetes version of your cluster doesn't change your configured monitoring and logging support.\n### Which monitoring and logging support does my cluster use?\nTo see the Cloud Logging and Cloud Monitoring integration settings for your cluster, follow these steps:\n- In the navigation panel of the Google Cloud console, select **Kubernetes Engine** , and then select **Clusters** : [Go to Kubernetes Clusters](https://console.cloud.google.com/kubernetes/list) \n- In the **Details** panel for your cluster, see the status for **Cloud Logging** , **Cloud Monitoring** , and **Google Cloud Managed Service for Prometheus** .\n### Modify your cluster\nTo change the Cloud Logging or Cloud Monitoring integration settings for an existing cluster, follow these steps:\n- In the navigation panel of the Google Cloud console, select **Kubernetes Engine** , and then select **Clusters** : [Go to Kubernetes Clusters](https://console.cloud.google.com/kubernetes/list) \n- Click the name of your cluster.\n- To modify which logs are sent to Cloud Logging, which metrics are sent to Cloud Monitoring, or whether Google Cloud Managed Service for Prometheus is enabled, click **Edit** next to Cloud Logging, Cloud Monitoring, or Google Cloud Managed Service for Prometheus.\n- Click **Save** .\nThe following `gcloud` instructions cover upgrading your cluster's monitoring and logging support using the `gcloud container clusters update` command. Notice that you use the `update` command, not the `upgrade` command.- Configure which logs are sent to Cloud Logging by passing a comma-separated list of values to the `gcloud container clusters update` command's `--logging` flag. See a full list of [available log sources](#available-logs) . For example, to collect both system and workload logs, pass `--logging=SYSTEM,WORKLOAD` . To collect only system logs, pass `--logging=SYSTEM` . Or, to collect no logs, pass `--logging=NONE` :```\ngcloud container clusters update CLUSTER_NAME \\\u00a0 \u00a0 --location=COMPUTE_LOCATION \\\u00a0 \u00a0 --logging=NONE\n```\n- Configure which metrics are sent to Cloud Monitoring by passing a comma-separated list of values to the `gcloud container clusters update` command's `--monitoring` flag. See a full list of [available metric sources](#available-metrics) . For example, to collect system metrics, pass `--monitoring=SYSTEM` . Or, to collect no metrics, pass `--monitoring=NONE` :```\ngcloud container clusters update CLUSTER_NAME \\\u00a0 \u00a0 --location=COMPUTE_LOCATION \\\u00a0 \u00a0 --monitoring=NONE\n```\n- Configure whether Google Cloud Managed Service for Prometheus is enabled by using the `--enable-managed-prometheus` or `--disable-managed-prometheus` flags. For example:```\ngcloud container clusters update CLUSTER_NAME \\\u00a0 \u00a0 --location=COMPUTE_LOCATION \\\u00a0 \u00a0 --enable-managed-prometheus\n```\n- To configure the collection of logs and metrics using Terraform, see the `logging_config` and `monitoring_config` blocks in the [Terraform registry for google_container_cluster](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/container_cluster) . Enabling the collection of logs from the API server, scheduler, and controller manager requires the Terraform Google Cloud provider version 4.44.0 or later.\n- For general information about using Google Cloud with Terraform, see [Terraform with Google Cloud](/docs/terraform) .\n## Deprecated Configuration Parameters\nIf you have previously been using the old configuration parameters to configure logging and monitoring support for your GKE cluster, those parameters are deprecated. The following table shows the equivalent configuration parameters to replace the deprecated flags.\n| Old Configuration          | Old create Arguments           | Old update Arguments                | New create and update Arguments    |\n|:-------------------------------------------------------|:-------------------------------------------------------------|:---------------------------------------------------------------------------------|:----------------------------------------------|\n| Disabled            | --no-enable-stackdriver-kubernetes       | --no-enable-stackdriver-kubernetes            | --logging=NONE --monitoring=NONE    |\n| System monitoring only (Logging disabled)    | --enable-stackdriver-kubernetes --no-enable-cloud-logging | --logging-service=none --monitoring-service=monitoring.googleapis.com/kubernetes | --logging=NONE --monitoring=SYSTEM   |\n| System and workload logging only (Monitoring disabled) | --enable-stackdriver-kubernetes --no-enable-cloud-monitoring | --logging-service=logging.googleapis.com/kubernetes --monitoring-service=none | --logging=SYSTEM,WORKLOAD --monitoring=NONE |\n| System logging and monitoring only (beta)    | --enable-logging-monitoring-system-only      | --enable-logging-monitoring-system-only           | --logging=SYSTEM --monitoring=SYSTEM   |\n| System and workload logging and monitoring    | --enable-stackdriver-kubernetes        | --enable-stackdriver-kubernetes             | --logging=SYSTEM,WORKLOAD --monitoring=SYSTEM |\n## What's next\n- Learn about the costs associated with Cloud Logging, Cloud Monitoring, and Google Cloud Managed Service for Prometheus by reading the [Pricing](/stackdriver/pricing) page.\n- Learn about [viewing your GKE logs in Cloud Logging](/kubernetes-engine/docs/how-to/view-logs) .", "guide": "Google Kubernetes Engine (GKE)"}