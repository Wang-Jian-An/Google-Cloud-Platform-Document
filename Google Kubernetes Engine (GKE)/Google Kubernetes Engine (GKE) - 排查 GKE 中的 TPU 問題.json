{"title": "Google Kubernetes Engine (GKE) - \u6392\u67e5 GKE \u4e2d\u7684 TPU \u554f\u984c", "url": "https://cloud.google.com/kubernetes-engine/docs/troubleshooting/tpus?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - \u6392\u67e5 GKE \u4e2d\u7684 TPU \u554f\u984c\n\u672c\u9801\u9762\u4ecb\u7d39\u77ad\u5982\u4f55\u89e3\u6c7a\u8207 Google Kubernetes Engine (GKE) \u4e2d\u7684 TPU \u76f8\u95dc\u7684\u554f\u984c\u3002\n[Cloud Customer Care](https://cloud.google.com/kubernetes-engine/docs/getting-support?hl=zh-cn)\n", "content": "## \u914d\u984d\u4e0d\u8db3\uff0c\u7121\u6cd5\u6eff\u8db3 TPU \u8acb\u6c42\n\u985e\u4f3c\u65bc `Insufficient quota to satisfy the request` \u7684\u932f\u8aa4\u8868\u793a Google Cloud \u9805\u76ee\u6c92\u6709\u8db3\u5920\u7684\u914d\u984d\u4f86\u6eff\u8db3\u8acb\u6c42\u3002\n\u5982\u9700\u89e3\u6c7a\u6b64\u554f\u984c\uff0c\u8acb\u6aa2\u67e5\u9805\u76ee\u7684\u914d\u984d\u9650\u5236\u548c\u7576\u524d\u4f7f\u7528\u91cf\u3002\u5982\u679c\u9700\u8981\uff0c\u60a8\u53ef\u4ee5\u7533\u8acb\u589e\u52a0 TPU \u914d\u984d\u3002\n### \u6aa2\u67e5\u914d\u984d\u9650\u5236\u548c\u7576\u524d\u4f7f\u7528\u91cf\n\u5982\u679c\u60a8\u8981\u5275\u5efa\u5305\u542b\u6309\u9700\u6216 Spot \u865b\u64ec\u6a5f\u7684 TPU \u7bc0\u9ede\u6c60\uff0c\u5247\u5fc5\u9808\u5728\u8981\u4f7f\u7528\u7684\u5340\u57df\u4e2d\u5177\u6709\u8db3\u5920\u7684 TPU \u914d\u984d\u3002\n\u5275\u5efa\u4f7f\u7528 TPU \u9810\u7559\u7684 TPU \u7bc0\u9ede\u6c60 \u4e0d\u9700\u8981\u4efb\u4f55 TPU \u914d\u984d\u3002 \u5c0d\u65bc\u9810\u7559\u7684 TPU\uff0c\u60a8\u53ef\u4ee5\u653e\u5fc3\u5730\u8df3\u904e\u6b64\u90e8\u5206\u3002\n\u5728 GKE \u4e2d\u5275\u5efa\u6309\u9700\u6216 Spot TPU \u7bc0\u9ede\u6c60\u9700\u8981 Compute Engine API \u914d\u984d\u3002Compute Engine API \u914d\u984d (compute.googleapis.com) \u8207 Cloud TPU API \u914d\u984d (tpu.googleapis.com) \u4e0d\u540c\uff0c\u4f7f\u7528 Cloud TPU API \u5275\u5efa TPU \u6642\u9700\u8981\u5f8c\u8005\u3002\n\u5982\u9700\u67e5\u770b TPU \u7684 Compute Engine API \u914d\u984d\u7684\u9650\u5236\u548c\u7576\u524d\u7528\u91cf\uff0c\u8acb\u6309\u7167\u4ee5\u4e0b\u6b65\u9a5f\u64cd\u4f5c\uff1a\n- \u8f49\u5230 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **\u914d\u984d** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u914d\u984d\u201d](https://console.cloud.google.com/iam-admin/quotas?hl=zh-cn) \n- \u5728 filter_list **\u904e\u6ffe\u689d\u4ef6** \u6846\u4e2d\uff0c\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u9078\u64c7 **\u670d\u52d9** \u5c6c\u6027\uff0c\u8f38\u5165 **Compute Engine API** \uff0c\u7136\u5f8c\u6309 **Enter** \u9375\u3002\n- \u9078\u64c7 **\u985e\u578b** \u5c6c\u6027\uff0c\u7136\u5f8c\u9078\u64c7 **\u914d\u984d** \u3002\n- \u9078\u64c7 **\u540d\u7a31** \u5c6c\u6027\uff0c\u7136\u5f8c\u6839\u64da TPU \u7248\u672c\u548c\u6a5f\u5668\u985e\u578b\u8f38\u5165\u914d\u984d\u7684\u540d\u7a31\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u8a08\u5283\u5275\u5efa\u5176\u6a5f\u5668\u985e\u578b\u4ee5 `ct5lp-` \u958b\u982d\u7684\u6309\u9700 TPU v5e \u7bc0\u9ede\uff0c\u8acb\u8f38\u5165 `TPU v5 Lite PodSlice chips` \u3002| TPU \u7248\u672c | \u6a5f\u5668\u985e\u578b\u958b\u982d\u7232 | \u6309\u9700\u5be6\u4f8b\u7684\u914d\u984d\u540d\u7a31   | Spot2 \u5be6\u4f8b\u7684\u914d\u984d\u540d\u7a31     |\n|:-----------|:-----------------|:---------------------------|:---------------------------------------|\n| TPU v4  | ct4p-   | TPU v4 PodSlice chips  | Preemptible TPU v4 PodSlice chips  |\n| TPU v5e | ct5l-   | TPU v5 Lite Device chips | Preemptible TPU v5 Lite Device chips |\n| TPU v5e | ct5lp-   | TPU v5 Lite PodSlice chips | Preemptible TPU v5 Lite PodSlice chips |\n| TPU v5p | ct5p-   | TPU v5p chips    | Preemptible TPU v5p chips    |\n- \u9078\u64c7 **\u7dad\u5ea6\uff08\u4f8b\u5982\u4f4d\u7f6e\uff09** \u5c6c\u6027\uff0c\u7136\u5f8c\u8f38\u5165 `region:` \uff0c\u5f8c\u8ddf\u60a8\u8a08\u5283\u5728 GKE \u4e2d\u5275\u5efa TPU \u7684\u5340\u57df\u7684\u540d\u7a31\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u8a08\u5283\u5728\u53ef\u7528\u5340 `us-west4-a` \u4e2d\u5275\u5efa TPU \u7bc0\u9ede\uff0c\u8acb\u8f38\u5165 `region:us-west4` \u3002TPU \u914d\u984d\u662f\u5340\u57df\u6027\u7684\uff0c\u56e0\u6b64\u540c\u4e00\u5340\u57df\u5167\u7684\u6240\u6709\u53ef\u7528\u5340\u90fd\u4f7f\u7528\u540c\u4e00 TPU \u914d\u984d\u3002\u5982\u679c\u6c92\u6709\u914d\u984d\u8207\u60a8\u8f38\u5165\u7684\u904e\u6ffe\u689d\u4ef6\u5339\u914d\uff0c\u5247\u8aaa\u660e\u9805\u76ee\u5c1a\u672a\u7372\u5f97\u6240\u9700\u5340\u57df\u7684\u4efb\u4f55\u6307\u5b9a\u914d\u984d\uff0c\u60a8\u5fc5\u9808 [\u7533\u8acb\u589e\u52a0 TPU \u914d\u984d](https://cloud.google.com/docs/quota/view-manage?hl=zh-cn#requesting_higher_quota) \u3002\n**\u6ce8\u610f\uff1a** \u5275\u5efa TPU \u9810\u7559\u5f8c\uff0c\u76f8\u61c9\u914d\u984d\u7684\u9650\u5236\u503c\u548c\u7576\u524d\u4f7f\u7528\u503c\u90fd\u6703\u589e\u52a0 TPU \u9810\u7559\u4e2d\u7684\u82af\u7247\u6578\u91cf\u3002\u4f8b\u5982\uff0c\u7232\u6a5f\u5668\u985e\u578b\u4ee5 `ct5lp-` \u958b\u982d\u7684 16 \u500b TPU v5e \u82af\u7247\u5275\u5efa\u9810\u7559\u5f8c\uff0c\u76f8\u95dc\u5340\u57df\u4e2d `TPU v5 Lite PodSlice chips` \u914d\u984d\u7684 **\u9650\u5236** \u548c **\u7576\u524d\u7528\u91cf** \u6703\u589e\u52a0 16\u3002\n- \u5275\u5efa TPU \u7bc0\u9ede\u6c60\u6642\uff0c\u8acb\u4f7f\u7528 [--reservation \u548c --reservation-affinity=specific \u6a19\u8a8c](https://cloud.google.com/sdk/gcloud/reference/container/node-pools/create?hl=zh-cn#--reservation) \u5275\u5efa\u9810\u7559\u5be6\u4f8b\u3002\u8cfc\u8cb7\u627f\u8afe\u6642\uff0cTPU \u9810\u7559\u53ef\u4f9b\u4f7f\u7528\u3002 [\u21a9](#fnref1) \n- \u5275\u5efa TPU \u7bc0\u9ede\u6c60\u6642\uff0c\u8acb\u4f7f\u7528 [--spot \u6a19\u8a8c](https://cloud.google.com/sdk/gcloud/reference/container/node-pools/create?hl=zh-cn#--spot) \u4f86\u5275\u5efa [Spot](https://cloud.google.com/spot-vms?hl=zh-cn) \u5be6\u4f8b\u3002 [\u21a9](#fnref2) ## \u5728 TPU \u7bc0\u9ede\u6c60\u4e2d\u5553\u7528\u7bc0\u9ede\u81ea\u52d5\u9810\u914d\u529f\u80fd\u6642\u51fa\u932f\n\u5728\u4e0d\u652f\u6301 TPU \u7684 GKE \u96c6\u7fa3\u4e2d\u5553\u7528\u7bc0\u9ede\u81ea\u52d5\u9810\u914d\u529f\u80fd\u6642\uff0c\u6703\u767c\u751f\u4ee5\u4e0b\u932f\u8aa4\u3002\n\u932f\u8aa4\u6d88\u606f\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a\n```\nERROR: (gcloud.container.clusters.create) ResponseError: code=400,\n message=Invalid resource: tpu-v4-podslice.\n```\n\u5982\u9700\u89e3\u6c7a\u6b64\u554f\u984c\uff0c\u8acb [\u5c07 GKE \u96c6\u7fa3\u5347\u7d1a\u5230 1.27.6 \u6216\u66f4\u9ad8\u7248\u672c](https://cloud.google.com/kubernetes-engine/docs/how-to/upgrading-a-cluster?hl=zh-cn#upgrading_the_cluster) \u3002\n## GKE \u4e0d\u6703\u81ea\u52d5\u9810\u914d TPU \u7bc0\u9ede\n\u4ee5\u4e0b\u90e8\u5206\u4ecb\u7d39\u4e86 GKE \u4e0d\u6703\u81ea\u52d5\u9810\u914d TPU \u7bc0\u9ede\u7684\u60c5\u6cc1\u4ee5\u53ca\u89e3\u6c7a\u65b9\u6cd5\u3002\n### \u9650\u5236\u914d\u7f6e\u932f\u8aa4\n\u5982\u679c\u60a8\u7232\u96c6\u7fa3\u5b9a\u7fa9\u7684\u81ea\u52d5\u9810\u914d\u9650\u5236\u904e\u4f4e\uff0c\u5247 GKE \u4e0d\u6703\u81ea\u52d5\u9810\u914d TPU \u7bc0\u9ede\u3002\u5728\u6b64\u985e\u60c5\u6cc1\u4e0b\uff0c\u60a8\u53ef\u80fd\u6703\u89c0\u5bdf\u5230\u4ee5\u4e0b\u932f\u8aa4\uff1a\n- \u5982\u679c\u5b58\u5728 TPU \u7bc0\u9ede\u6c60\uff0c\u4f46 GKE \u7531\u65bc [\u9055\u53cd\u8cc7\u6e90\u9650\u5236](https://cloud.google.com/kubernetes-engine/docs/troubleshooting/troubleshooting-autopilot-clusters?hl=zh-cn#noscaleup-resource-limits) \u800c\u7121\u6cd5\u64f4\u5bb9\u7bc0\u9ede\uff0c\u5247\u60a8\u5728\u904b\u884c `kubectl get events` \u547d\u4ee4\u6642\u6703\u770b\u5230\u4ee5\u4e0b\u932f\u8aa4\u6d88\u606f\uff1a```\n11s Normal NotTriggerScaleUp pod/tpu-workload-65b69f6c95-ccxwz pod didn't\ntrigger scale-up: 1 node(s) didn't match Pod's node affinity/selector, 1 max\ncluster cpu, memory limit reached\n```\u6b64\u5916\uff0c\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u60a8\u53ef\u4ee5\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\u7684\u8b66\u544a\u6d88\u606f\uff1a```\n\"Your cluster has one or more unschedulable Pods\"\n```\n- \u7576 GKE \u5617\u8a66\u81ea\u52d5\u9810\u914d\u8d85\u51fa\u8cc7\u6e90\u9650\u5236\u7684 TPU \u7bc0\u9ede\u6c60\u6642\uff0c\u96c6\u7fa3\u81ea\u52d5\u64f4\u7e2e\u5668\u53ef\u898b\u6027\u65e5\u8a8c\u6703\u986f\u793a\u4ee5\u4e0b\u932f\u8aa4\u6d88\u606f\uff1a```\nmessageId: \"no.scale.up.nap.pod.zonal.resources.exceeded\"\n```\u6b64\u5916\uff0c\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u60a8\u53ef\u4ee5\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\u7684\u8b66\u544a\u6d88\u606f\uff1a```\n\"Can't scale up because node auto-provisioning can't provision a node pool for\nthe Pod if it would exceed resource limits\"\n```\n\u5982\u9700\u89e3\u6c7a\u9019\u4e9b\u554f\u984c\uff0c\u8acb\u589e\u52a0\u96c6\u7fa3\u4e2d\u7684 TPU \u82af\u7247\u3001CPU \u6838\u5fc3\u548c\u5167\u5b58\u7684\u6700\u5927\u6578\u91cf\u3002\n\u8981\u5b8c\u6210\u9019\u4e9b\u6b65\u9a5f\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u8a08\u7b97\u6307\u5b9a TPU \u6a5f\u5668\u985e\u578b\u548c\u6578\u91cf\u7684\u8cc7\u6e90\u8981\u6c42\u3002\u8acb\u6ce8\u610f\uff0c\u60a8\u9700\u8981\u7232\u975e TPU \u7bc0\u9ede\u6c60\uff08\u4f8b\u5982\u7cfb\u7d71\u5de5\u4f5c\u8ca0\u8f09\uff09\u6dfb\u52a0\u8cc7\u6e90\u3002\n- \u7372\u53d6\u7279\u5b9a\u6a5f\u5668\u985e\u578b\u548c\u53ef\u7528\u5340\u7684\u53ef\u7528 TPU\u3001CPU \u548c\u5167\u5b58\u7684\u8aaa\u660e\u3002\u4f7f\u7528 gcloud CLI```\ngcloud compute machine-types describe MACHINE_TYPE \\\u00a0 \u00a0 --zone COMPUTE_ZONE\n```\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u8981\u641c\u7d22\u7684\u6a5f\u5668\u985e\u578b\u3002\n- ``\uff1a [\u8a08\u7b97\u53ef\u7528\u5340](https://cloud.google.com/compute/docs/regions-zones?hl=zh-cn#available) \u7684\u540d\u7a31\u3002\n\u8f38\u51fa\u5305\u542b\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\u7684\u8aaa\u660e\u884c\uff1a```\n description: 240 vCPUs, 407 GB RAM, 4 Google TPUs\n ```\n```\n- \u5c07 CPU \u548c\u5167\u5b58\u91cf\u4e58\u4ee5\u6240\u9700\u7bc0\u9ede\u6578\uff0c\u4f86\u8a08\u7b97 CPU \u548c\u5167\u5b58\u7e3d\u6578\u3002\u4f8b\u5982\uff0c `ct4p-hightpu-4t` \u6a5f\u5668\u985e\u578b\u4f7f\u7528 240 \u500b CPU \u6838\u5fc3\u548c 407 GB RAM\uff0c\u4e26\u914d\u5099 4 \u500b TPU \u82af\u7247\u3002\u5047\u8a2d\u60a8\u9700\u8981 20 \u500b TPU \u82af\u7247\uff08\u5c0d\u61c9\u65bc\u4e94\u500b\u7bc0\u9ede\uff09\uff0c\u5247\u5fc5\u9808\u5b9a\u7fa9\u4ee5\u4e0b\u503c\uff1a- `--max-accelerator=type=tpu-v4-podslice,count=20`\u3002\n- `CPU = 1200`(240 x 5 )\n- `memory = 2035`(407 x 5)\n\u60a8\u61c9\u8a72\u5b9a\u7fa9\u4e00\u4e9b\u5e36\u6709\u5197\u9918\u7684\u9650\u5236\uff0c\u4ee5\u9069\u61c9\u975e TPU \u7bc0\u9ede\uff0c\u4f8b\u5982\u7cfb\u7d71\u5de5\u4f5c\u8ca0\u8f09\u3002\n- \u66f4\u65b0\u96c6\u7fa3\u9650\u5236\uff1a```\ngcloud container clusters update CLUSTER_NAME \\\u00a0 \u00a0 --max-accelerator type=TPU_ACCELERATOR \\\u00a0 \u00a0 count=MAXIMUM_ACCELERATOR \\\u00a0 \u00a0 --max-cpu=MAXIMUM_CPU \\\u00a0 \u00a0 --max-memory=MAXIMUM_MEMORY\n```\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u96c6\u7fa3\u7684\u540d\u7a31\u3002\n- ``\uff1aTPU \u52a0\u901f\u5668\u7684\u540d\u7a31\u3002\n- ``\uff1a\u96c6\u7fa3\u4e2d\u7684 TPU \u82af\u7247\u6578\u91cf\u4e0a\u9650\u3002\n- ``\uff1a\u96c6\u7fa3\u4e2d\u7684\u6838\u5fc3\u6578\u4e0a\u9650\u3002\n- ``\uff1a\u96c6\u7fa3\u4e2d\u7684\u5167\u5b58\u91cf\u4e0a\u9650 (GB)\u3002\n### \u5de5\u4f5c\u8ca0\u8f09\u914d\u7f6e\u932f\u8aa4\n\u6b64\u932f\u8aa4\u662f\u7531\u65bc\u5de5\u4f5c\u8ca0\u8f09\u914d\u7f6e\u932f\u8aa4\u5c0e\u81f4\u7684\u3002\u4ee5\u4e0b\u662f\u5c0e\u81f4\u9019\u4e9b\u932f\u8aa4\u7684\u4e00\u4e9b\u6700\u5e38\u898b\u539f\u56e0\uff1a\n- Pod \u898f\u7bc4\u4e2d\u7684`cloud.google.com/gke-tpu-accelerator`\u548c`cloud.google.com/gke-tpu-topology`\u6a19\u7c64\u4e0d\u6b63\u78ba\u6216\u7f3a\u5931\u3002GKE \u4e0d\u6703\u9810\u914d TPU \u7bc0\u9ede\u6c60\uff0c\u800c\u7bc0\u9ede\u81ea\u52d5\u9810\u914d\u529f\u80fd\u5c07\u7121\u6cd5\u7e31\u5411\u64f4\u5bb9\u96c6\u7fa3\u3002\n- Pod \u898f\u7bc4\u5728\u5176\u8cc7\u6e90\u8981\u6c42\u4e2d\u672a\u6307\u5b9a`google.com/tpu`\u3002\n\u5982\u9700\u89e3\u6c7a\u6b64\u554f\u984c\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u67d0\u9805\u64cd\u4f5c\uff1a\n- \u78ba\u4fdd\u60a8\u7684\u5de5\u4f5c\u8ca0\u8f09\u7bc0\u9ede\u9078\u64c7\u5668\u4e2d\u6c92\u6709\u4e0d\u53d7\u652f\u6301\u7684\u6a19\u7c64\u3002\u4f8b\u5982\uff0c`cloud.google.com/gke-nodepool`\u6a19\u7c64\u7684\u7bc0\u9ede\u9078\u64c7\u5668\u5c07\u963b\u6b62 GKE \u7232\u60a8\u7684 Pod \u5275\u5efa\u984d\u5916\u7684\u7bc0\u9ede\u6c60\u3002\n- \u78ba\u4fdd\u904b\u884c TPU \u5de5\u4f5c\u8ca0\u8f09\u7684 Pod \u6a21\u677f\u898f\u7bc4\u5305\u542b\u4ee5\u4e0b\u503c\uff1a- `cloud.google.com/gke-tpu-accelerator`\u548c`cloud.google.com/gke-tpu-topology`\u6a19\u7c64\uff08\u5728\u5176`nodeSelector`\u4e2d\uff09\u3002\n- `google.com/tpu`\uff08\u5728\u5176\u8acb\u6c42\u4e2d\uff09\u3002\u5982\u9700\u77ad\u89e3\u5982\u4f55\u5728 GKE \u4e2d\u90e8\u7f72 TPU \u5de5\u4f5c\u8ca0\u8f09\uff0c\u8acb\u53c3\u95b1 [\u904b\u884c\u986f\u793a TPU \u7bc0\u9ede\u6c60\u4e2d\u53ef\u7528 TPU \u82af\u7247\u6578\u91cf\u7684\u5de5\u4f5c\u8ca0\u8f09](https://cloud.google.com/kubernetes-engine/docs/how-to/tpus?hl=zh-cn#tpu-chips-node-pool) \u3002\n## \u5728 GKE \u4e2d\u90e8\u7f72\u4f7f\u7528 TPU \u7684 Pod \u6642\u51fa\u73fe\u8abf\u5ea6\u932f\u8aa4\n\u5982\u679c GKE \u7121\u6cd5\u5728 TPU \u7bc0\u9ede\u4e0a\u8abf\u5ea6\u8acb\u6c42 TPU \u7684 Pod\uff0c\u5247\u6703\u51fa\u73fe\u4ee5\u4e0b\u554f\u984c\u3002\u4f8b\u5982\uff0c\u5982\u679c\u67d0\u4e9b\u975e TPU Pod \u5df2\u5728 TPU \u7bc0\u9ede\u4e0a\u8abf\u5ea6\uff0c\u5247\u53ef\u80fd\u6703\u767c\u751f\u9019\u7a2e\u60c5\u6cc1\u3002\n\u5728 Pod \u4e0a\u4f5c\u7232 `FailedScheduling` \u4e8b\u4ef6\u767c\u51fa\u7684\u932f\u8aa4\u6d88\u606f\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a\n```\nCannot schedule pods: Preemption is not helpful for scheduling.\nError message: 0/2 nodes are available: 2 node(s) had untolerated taint\n{google.com/tpu: present}. preemption: 0/2 nodes are available: 2 Preemption is\nnot helpful for scheduling\n```\n\u5982\u9700\u89e3\u6c7a\u6b64\u554f\u984c\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n\u6aa2\u67e5\u60a8\u7684\u96c6\u7fa3\u4e2d\u662f\u5426\u81f3\u5c11\u6709\u4e00\u500b CPU \u7bc0\u9ede\u6c60\uff0c\u4ee5\u4fbf\u7cfb\u7d71\u95dc\u9375 Pod \u53ef\u4ee5\u5728\u975e TPU \u7bc0\u9ede\u4e2d\u904b\u884c\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5c07 Pod \u90e8\u7f72\u5230\u7279\u5b9a\u7bc0\u9ede\u6c60](https://cloud.google.com/kubernetes-engine/docs/how-to/node-pools?hl=zh-cn#deploy) \u3002\n## TPU \u521d\u59cb\u5316\u5931\u6557\n\u5982\u679c GKE \u56e0\u7f3a\u5c11\u8a2a\u554f TPU \u8a2d\u5099\u7684\u6b0a\u9650\u800c\u7121\u6cd5\u9810\u914d\u65b0\u7684 TPU \u5de5\u4f5c\u8ca0\u8f09\uff0c\u5247\u6703\u51fa\u73fe\u4ee5\u4e0b\u554f\u984c\u3002\n\u932f\u8aa4\u6d88\u606f\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a\n```\nTPU platform initialization failed: FAILED_PRECONDITION: Couldn't mmap: Resource\ntemporarily unavailable.; Unable to create Node RegisterInterface for node 0,\nconfig: device_path: \"/dev/accel0\" mode: KERNEL debug_data_directory: \"\"\ndump_anomalies_only: true crash_in_debug_dump: false allow_core_dump: true;\ncould not create driver instance\n```\n\u5982\u9700\u89e3\u6c7a\u6b64\u554f\u984c\uff0c\u8acb\u78ba\u4fdd\u5728\u7279\u6b0a\u6a21\u5f0f\u4e0b\u904b\u884c TPU \u5bb9\u5668\uff0c\u6216\u8005\u589e\u52a0 [\u5bb9\u5668\u5167\u90e8\u7684 ulimit](https://cloud.google.com/kubernetes-engine/docs/how-to/tpus?hl=zh-cn#privileged-mode) \u3002\n## \u8abf\u5ea6\u51fa\u73fe\u6b7b\u9396\n\u5169\u500b\u6216\u66f4\u591a\u4f5c\u696d\u8abf\u5ea6\u53ef\u80fd\u56e0\u6b7b\u9396\u800c\u5931\u6557\u3002\u4f8b\u5982\uff0c\u5728\u767c\u751f\u4ee5\u4e0b\u6240\u6709\u60c5\u6cc1\u7684\u5834\u666f\u4e0b\uff1a\n- \u60a8\u6709\u5169\u500b\u4f5c\u696d\uff08\u4f5c\u696d A \u548c\u4f5c\u696d B\uff09\uff0c\u4e14\u63a1\u7528 Pod \u89aa\u548c\u6027\u898f\u5247\u3002GKE \u4f7f\u7528 TPU \u62d3\u64b2`v4-32`\u7232\u5169\u500b\u4f5c\u696d\u8abf\u5ea6 TPU \u5207\u7247\u3002\n- \u60a8\u7684\u96c6\u7fa3\u4e2d\u6709\u5169\u500b`v4-32`TPU \u5207\u7247\u3002\n- \u60a8\u7684\u96c6\u7fa3\u5177\u6709\u5145\u8db3\u7684\u5bb9\u91cf\u4f86\u8abf\u5ea6\u4f5c\u696d\uff0c\u7406\u8ad6\u4e0a\u53ef\u4ee5\u91dd\u5c0d\u6bcf\u500b TPU \u5207\u7247\u5feb\u901f\u8abf\u5ea6\u6bcf\u500b\u4f5c\u696d\u3002\n- Kubernetes \u8abf\u5ea6\u5668\u6703\u5c07\u4f5c\u696d A \u4e2d\u7684Pod \u8abf\u5ea6\u5230\u4e00\u500b\u5207\u7247\u4e0a\uff0c\u7136\u5f8c\u5c07\u4f5c\u696d B \u4e2d\u7684Pod \u8abf\u5ea6\u5230\u540c\u4e00\u5207\u7247\u4e0a\u3002\n\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u9451\u65bc\u4f5c\u696d A \u7684 Pod \u89aa\u548c\u6027\u898f\u5247\uff0c\u8abf\u5ea6\u5668\u6703\u5617\u8a66\u5c07\u4f5c\u696d A \u548c\u4f5c\u696d B \u7684\u6240\u6709\u5269\u9918 Pod \u8abf\u5ea6\u5230\u55ae\u500b TPU \u5207\u7247\u4e0a\u3002\u56e0\u6b64\uff0cGKE \u5c07\u7121\u6cd5\u5b8c\u5168\u8abf\u5ea6\u4f5c\u696d A \u6216\u4f5c\u696d B\u3002\u56e0\u6b64\uff0c\u5169\u500b\u4f5c\u696d\u5c07\u4fdd\u6301\u201c\u5f85\u8655\u7406\u201d\u72c0\u614b\u3002\n\u5982\u9700\u89e3\u6c7a\u6b64\u554f\u984c\uff0c\u8acb\u4f7f\u7528 [Pod \u53cd\u89aa\u548c\u6027](https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#node-affinity) \uff0c\u4e26\u5c07 `cloud.google.com/gke-nodepool` \u4f5c\u7232 `topologyKey` \uff0c\u5982\u4ee5\u4e0b\u793a\u4f8b\u6240\u793a\uff1a\n```\napiVersion: batch/v1kind: Jobmetadata:\u00a0name: pispec:\u00a0parallelism: 2\u00a0template:\u00a0 \u00a0metadata:\u00a0 \u00a0 \u00a0labels:\u00a0 \u00a0 \u00a0 \u00a0job: pi\u00a0 \u00a0spec:\u00a0 \u00a0 \u00a0affinity:\u00a0 \u00a0 \u00a0 \u00a0podAffinity:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0requiredDuringSchedulingIgnoredDuringExecution:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0- labelSelector:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0matchExpressions:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0- key: job\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0operator: In\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0values:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0- pi\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0topologyKey: cloud.google.com/gke-nodepool\u00a0 \u00a0 \u00a0 \u00a0podAntiAffinity:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0requiredDuringSchedulingIgnoredDuringExecution:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0- labelSelector:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0matchExpressions:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0- key: job\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0operator: NotIn\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0values:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0- pi\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0topologyKey: cloud.google.com/gke-nodepool\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0namespaceSelector:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0matchExpressions:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0- key: kubernetes.io/metadata.name\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0operator: NotIn\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0values:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0- kube-system\u00a0 \u00a0 \u00a0containers:\u00a0 \u00a0 \u00a0- name: pi\u00a0 \u00a0 \u00a0 \u00a0image: perl:5.34.0\u00a0 \u00a0 \u00a0 \u00a0command: [\"sleep\", \u00a0\"60\"]\u00a0 \u00a0 \u00a0restartPolicy: Never\u00a0backoffLimit: 4\n```\n## \u5728 us-central2 \u4e2d\u5275\u5efa\u96c6\u7fa3\u671f\u9593\u6b0a\u9650\u906d\u62d2\n\u5982\u679c\u60a8\u5617\u8a66\u5728 `us-central2` \uff08\u552f\u4e00\u63d0\u4f9b TPU v4 \u7684\u5340\u57df\uff09\u4e2d\u5275\u5efa\u96c6\u7fa3\uff0c\u5247\u53ef\u80fd\u6703\u9047\u5230\u5982\u4e0b\u6240\u793a\u7684\u932f\u8aa4\u6d88\u606f\uff1a\n```\nERROR: (gcloud.container.clusters.create) ResponseError: code=403,\nmessage=Permission denied on 'locations/us-central2' (or it may not exist).\n```\n\u51fa\u73fe\u8a72\u932f\u8aa4\u7684\u539f\u56e0\u662f\u5340\u57df `us-central2` \u662f\u5c08\u7528\u5340\u57df\u3002\n\u5982\u9700\u89e3\u6c7a\u6b64\u554f\u984c\uff0c\u8acb [\u63d0\u4ea4\u652f\u6301\u8acb\u6c42](https://cloud.google.com/support-hub?hl=zh-cn) \uff0c\u6216\u806f\u7e6b\u60a8\u7684\u5ba2\u6236\u652f\u6301\u5718\u968a\uff0c\u8981\u6c42\u5728 Google Cloud \u9805\u76ee\u4e2d\u986f\u793a `us-central2` \u3002\n## \u5728 us-central2 \u5275\u5efa TPU \u7bc0\u9ede\u6c60\u671f\u9593\u914d\u984d\u4e0d\u8db3\n\u5982\u679c\u60a8\u5617\u8a66\u5728 `us-central2` \uff08\u552f\u4e00\u63d0\u4f9b TPU v4 \u7684\u5340\u57df\uff09\u5275\u5efa TPU \u7bc0\u9ede\u6c60\uff0c\u5247\u53ef\u80fd\u9700\u8981\u5728\u9996\u6b21\u5275\u5efa TPU v4 \u7bc0\u9ede\u6c60\u6642\u589e\u52a0\u4ee5\u4e0b\u8207 GKE \u76f8\u95dc\u7684\u914d\u984d\uff1a\n- **us-central2 \u4e2d\u7684\u6c38\u4e45\u6027\u78c1\u76e4 SSD (GB) \u914d\u984d** \uff1a\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u6bcf\u500b Kubernetes \u7bc0\u9ede\u7684\u5553\u52d5\u78c1\u76e4\u9700\u8981 100 GB\u3002\u56e0\u6b64\uff0c\u6b64\u914d\u984d\u61c9\u81f3\u5c11\u8a2d\u7f6e\u7232\u60a8\u9810\u8a08\u5728`us-central2`\u4e2d\u5275\u5efa\u7684 GKE \u7bc0\u9ede\u7684\u6700\u5927\u6578\u91cf\u548c 100 GB \u7684\u4e58\u7a4d (`maximum_nodes`X`100 GB`)\u3002\n- **us-central2 \u4e2d\u4f7f\u7528\u7684 IP \u5730\u5740\u914d\u984d** \uff1a\u6bcf\u500b Kubernetes \u7bc0\u9ede\u4f7f\u7528\u4e00\u500b IP \u5730\u5740\u3002\u56e0\u6b64\uff0c\u6b64\u914d\u984d\u61c9\u81f3\u5c11\u8a2d\u7f6e\u7232\u60a8\u9810\u8a08\u5728`us-central2`\u4e2d\u5275\u5efa\u7684 GKE \u7bc0\u9ede\u6578\u4e0a\u9650\u3002## \u5275\u5efa GKE \u96c6\u7fa3\u671f\u9593\u7f3a\u5c11\u5b50\u7db2\n\u5982\u679c\u60a8\u5617\u8a66\u5728 `us-central2` \uff08\u552f\u4e00\u63d0\u4f9b TPU v4 \u7684\u5340\u57df\uff09\u4e2d\u5275\u5efa\u96c6\u7fa3\uff0c\u5247\u53ef\u80fd\u6703\u9047\u5230\u5982\u4e0b\u6240\u793a\u7684\u932f\u8aa4\u6d88\u606f\uff1a\n```\nERROR: (gcloud.container.clusters.create) ResponseError: code=404,\nmessage=Not found: project <PROJECT> does not have an auto-mode subnetwork\nfor network \"default\" in region <REGION>.\n```\nVPC \u7db2\u7d61\u4e2d\u9700\u8981\u6709\u4e00\u500b\u5b50\u7db2\u4f86\u63d0\u4f9b\u8207 GKE \u7bc0\u9ede\u7684\u9023\u63a5\u3002\u4f46\u662f\uff0c\u5728 `us-central2` \u7b49\u7279\u5b9a\u5340\u57df\u4e2d\uff0c\u5373\u4f7f\u60a8\u5728\u81ea\u52d5\u6a21\u5f0f\u4e0b\u4f7f\u7528\u9ed8\u8a8d VPC \u7db2\u7d61\uff08\u7528\u65bc\u5275\u5efa\u5b50\u7db2\uff09\uff0c\u4e5f\u53ef\u80fd\u7121\u6cd5\u5275\u5efa\u9ed8\u8a8d\u5b50\u7db2\u3002\n\u5982\u9700\u89e3\u6c7a\u6b64\u554f\u984c\uff0c\u8acb\u78ba\u4fdd\u5728\u5275\u5efa GKE \u96c6\u7fa3\u4e4b\u524d [\u5df2\u5728\u8a72\u5340\u57df\u4e2d\u5275\u5efa\u81ea\u5b9a\u7fa9\u5b50\u7db2](https://cloud.google.com/vpc/docs/create-modify-vpc-networks?hl=zh-cn#add-subnets) \u3002\u6b64\u5b50\u7db2\u4e0d\u5f97\u8207\u540c\u4e00 VPC \u7db2\u7d61\u7684\u5176\u4ed6\u5340\u57df\u4e2d\u5275\u5efa\u7684\u5176\u4ed6\u5b50\u7db2\u91cd\u758a\u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n[Cloud Customer Care](https://cloud.google.com/kubernetes-engine/docs/getting-support?hl=zh-cn)", "guide": "Google Kubernetes Engine (GKE)"}