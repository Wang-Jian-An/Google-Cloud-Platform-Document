{"title": "Google Kubernetes Engine (GKE) - \u5275\u5efa\u57fa\u65bc\u5f8c\u7aef\u670d\u52d9\u7684\u5916\u90e8\u8ca0\u8f09\u5747\u8861\u5668", "url": "https://cloud.google.com/kubernetes-engine/docs/how-to/external-svc-lb-rbs?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - \u5275\u5efa\u57fa\u65bc\u5f8c\u7aef\u670d\u52d9\u7684\u5916\u90e8\u8ca0\u8f09\u5747\u8861\u5668\n\u672c\u9801\u9762\u986f\u793a\u5982\u4f55\u90e8\u7f72\u5916\u90e8 LoadBalancer \u670d\u52d9\uff0c\u4ee5\u69cb\u5efa\u57fa\u65bc\u5f8c\u7aef\u670d\u52d9\u7684\u5916\u90e8\u76f4\u901a\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u3002\u5728\u95b1\u8b80\u672c\u9801\u9762\u4e4b\u524d\uff0c\u60a8\u61c9\u8a72\u5148\u719f\u6089\u4ee5\u4e0b\u6982\u5ff5\uff1a\n- [LoadBalancer \u670d\u52d9](https://cloud.google.com/kubernetes-engine/docs/concepts/service-load-balancer?hl=zh-cn) \u3002\n- [\u57fa\u65bc\u5f8c\u7aef\u670d\u52d9\u7684\u5916\u90e8\u76f4\u901a\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668](https://cloud.google.com/load-balancing/docs/network/networklb-backend-service?hl=zh-cn) \u3002", "content": "## \u57fa\u65bc\u5f8c\u7aef\u670d\u52d9\u7684\u5916\u90e8\u76f4\u901a\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\n\u4f5c\u7232\u96c6\u7fa3\u7ba1\u7406\u54e1\uff0c\u60a8\u53ef\u4ee5\u5275\u5efa\u5916\u90e8 LoadBalancer \u670d\u52d9\uff0c\u4ee5\u4fbf\u96c6\u7fa3\u5916\u90e8\u7684\u5ba2\u6236\u7aef\u53ef\u4ee5\u5c07\u6578\u64da\u5305\u767c\u9001\u5230\u670d\u52d9\u7684 Pod\u3002\u4e0b\u5716\u5c55\u793a\u4e86\u7232\u5169\u500b\u5916\u90e8 LoadBalancer \u670d\u52d9\uff08 `store-v1-lb-svc` \u548c `store-v2-lb-svc` \uff09\u5275\u5efa\u7684\u5169\u500b\u57fa\u65bc\u5f8c\u7aef\u670d\u52d9\u7684\u5916\u90e8\u76f4\u901a\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u3002\u9019\u5169\u500b\u8ca0\u8f09\u5747\u8861\u5668\u90fd\u5c07\u6578\u64da\u5305\u5206\u767c\u5230\u96c6\u7fa3\u4e2d\u7684\u7bc0\u9ede\uff0c\u4e4b\u5f8c\u9019\u4e9b\u7bc0\u9ede\u4fbf\u6703\u5c07\u6578\u64da\u5305\u8def\u7531\u5230\u670d\u52d9 Pod\u3002\n\u672c\u6307\u5357\u4ecb\u7d39\u77ad\u5982\u4f55\u901a\u904e\u4ee5\u4e0b\u6b65\u9a5f\u8a2d\u7f6e\u540d\u7232 `store-v1-lb-svc` \u7684\u5916\u90e8 LoadBalancer \u670d\u52d9\uff1a\n- \u5275\u5efa\u4e00\u500b\u5553\u7528\u4e86`HttpLoadBalancing`\u63d2\u4ef6\u7684\u96c6\u7fa3\u3002\n- \u5275\u5efa\u4e00\u500b\u5305\u542b`cloud.google.com/l4-rbs`\u8a3b\u91cb\u7684\u670d\u52d9\u3002 \u8a72\u8a3b\u91cb\u6703\u6307\u793a GKE \u5275\u5efa\u4f7f\u7528\u5340\u57df\u7d1a\u5f8c\u7aef\u670d\u52d9\u7684\u57fa\u65bc\u5f8c\u7aef\u670d\u52d9\u7684\u5916\u90e8\u76f4\u901a\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u3002\n- \u9a57\u8b49\u8ca0\u8f09\u5747\u8861\u5668\u662f\u5426\u80fd\u5920\u6210\u529f\u5c07\u6578\u64da\u5305\u50b3\u9001\u5230 `store-v1-lb-svc` \u670d\u52d9\u7684 Pod\u3002\u6b64\u5916\uff0c\u9a57\u8b49 GKE \u662f\u5426\u5275\u5efa\u4e86\u57fa\u65bc\u5f8c\u7aef\u670d\u52d9\u7684\u5916\u90e8\u76f4\u901a\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u7684\u5404\u500b\u7d44\u4ef6\uff1a- \u8f49\u767c\u898f\u5247\n- \u5340\u57df\u7d1a\u5f8c\u7aef\u670d\u52d9\n- \u5be6\u4f8b\u7d44\n- \u5065\u5eb7\u6aa2\u67e5\n- VPC \u9632\u706b\u7246\u898f\u5247\n- \u522a\u9664 `store-v1-lb-svc` \u5916\u90e8 LoadBalancer \u670d\u52d9\u3002## \u6e96\u5099\u5de5\u4f5c\n\u5728\u958b\u59cb\u4e4b\u524d\uff0c\u8acb\u78ba\u4fdd\u60a8\u5df2\u57f7\u884c\u4ee5\u4e0b\u4efb\u52d9\uff1a\n- \u5553\u7528 Google Kubernetes Engine API\u3002\n- [  \u5553\u7528 Google Kubernetes Engine API ](https://console.cloud.google.com/flows/enableapi?apiid=container.googleapis.com&hl=zh-cn) \n- \u5982\u679c\u60a8\u8981\u4f7f\u7528 Google Cloud CLI \u57f7\u884c\u6b64\u4efb\u52d9\uff0c\u8acb [\u5b89\u88dd](https://cloud.google.com/sdk/docs/install?hl=zh-cn) \u4e26 [\u521d\u59cb\u5316](https://cloud.google.com/sdk/docs/initializing?hl=zh-cn) gcloud CLI\u3002 \u5982\u679c\u60a8\u4e4b\u524d\u5b89\u88dd\u4e86 gcloud CLI\uff0c\u8acb\u904b\u884c`gcloud components update`\u4ee5\u7372\u53d6\u6700\u65b0\u7248\u672c\u3002 **\u6ce8\u610f** \uff1a\u5c0d\u65bc\u73fe\u6709 gcloud CLI \u5b89\u88dd\uff0c\u8acb\u52d9\u5fc5\u8a2d\u7f6e`compute/region`\u548c`compute/zone` [\u5c6c\u6027](https://cloud.google.com/sdk/docs/properties?hl=zh-cn#setting_properties) \u3002\u901a\u904e\u8a2d\u7f6e\u9ed8\u8a8d\u4f4d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u907f\u514d gcloud CLI \u4e2d\u51fa\u73fe\u4ee5\u4e0b\u932f\u8aa4\uff1a`One of [--zone, --region] must be supplied: Please specify location`\u3002## \u8a2d\u7f6e\u96c6\u7fa3\n### \u5275\u5efa\u96c6\u7fa3\n\u4f7f\u7528 gcloud CLI \u5275\u5efa\u4e00\u500b\u65b0\u96c6\u7fa3\uff0c\u8a72\u96c6\u7fa3\u61c9\u652f\u6301\u5275\u5efa\u57fa\u65bc\u5f8c\u7aef\u670d\u52d9\u7684\u5916\u90e8\u76f4\u901a\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\uff1a\n```\ngcloud container clusters create-auto CLUSTER_NAME \\\u00a0 \u00a0 --release-channel=RELEASE_CHANNEL \\\u00a0 \u00a0 --cluster-version=VERSION \\\u00a0 \u00a0 --location=COMPUTE_LOCATION\n```\n\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a\n- ``\uff1a\u65b0\u96c6\u7fa3\u7684\u540d\u7a31\u3002\n- ``\uff1a\u96c6\u7fa3\u7684 GKE [\u767c\u4f48\u6e20\u9053](https://cloud.google.com/kubernetes-engine/docs/concepts/release-channels?hl=zh-cn) \u7684\u540d\u7a31\u3002\n- ``\uff1a\u96c6\u7fa3\u7684 GKE \u7248\u672c\uff0c\u5fc5\u9808\u7232 1.24.9 \u6216\u66f4\u9ad8\u7248\u672c\u3002\n- ``\uff1a\u96c6\u7fa3\u7684 [Compute Engine \u5340\u57df](https://cloud.google.com/compute/docs/regions-zones?hl=zh-cn#available) \u3002\n\u60a8\u7684\u65b0\u96c6\u7fa3\u9ed8\u8a8d\u5553\u7528 `HttpLoadBalancing` \u63d2\u4ef6\u3002\u6b64\u63d2\u4ef6\u662f\u5fc5\u9700\u7684\uff0c\u4ee5\u4fbf\u63a7\u5236\u5e73\u9762\u53ef\u4ee5\u5275\u5efa\u548c\u7ba1\u7406\u57fa\u65bc\u5f8c\u7aef\u670d\u52d9\u7684\u5916\u90e8\u76f4\u901a\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u3002\n### \u5347\u7d1a\u73fe\u6709\u96c6\u7fa3\n\u4f7f\u7528 gcloud CLI \u66f4\u65b0\u73fe\u6709\u96c6\u7fa3\uff0c\u4ee5\u4f7f\u96c6\u7fa3\u652f\u6301\u5275\u5efa\u57fa\u65bc\u5f8c\u7aef\u670d\u52d9\u7684\u5916\u90e8\u76f4\u901a\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u3002\n- \u5c07\u63a7\u5236\u5e73\u9762\u5347\u7d1a\u5230 GKE 1.24.9 \u6216\u66f4\u9ad8\u7248\u672c\uff1a```\ngcloud container clusters upgrade CLUSTER_NAME \\\u00a0 \u00a0 --cluster-version=VERSION \\\u00a0 \u00a0 --master \\\u00a0 \u00a0 --location=COMPUTE_LOCATION\n```\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u60a8\u7684\u96c6\u7fa3\u7684\u540d\u7a31\u3002\n- ``\uff1aGKE \u7248\u672c\uff0c\u5fc5\u9808\u7232 1.24.9 \u6216\u66f4\u9ad8\u7248\u672c\u3002\u7248\u672c\u5fc5\u9808\u662f\u96c6\u7fa3\u767c\u4f48\u6e20\u9053\u4e2d\u7684\u6709\u6548\u6b21\u8981\u7248\u672c\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u624b\u52d5\u5347\u7d1a\u63a7\u5236\u5e73\u9762](https://cloud.google.com/kubernetes-engine/docs/how-to/upgrading-a-cluster?hl=zh-cn#upgrade_cp) \u3002\n- ``\uff1a\u65b0\u96c6\u7fa3\u7684 [Compute Engine \u4f4d\u7f6e](https://cloud.google.com/compute/docs/regions-zones/viewing-regions-zones?hl=zh-cn) \u3002\n## \u5275\u5efa\u5916\u90e8 LoadBalancer \u670d\u52d9\n- \u5c07\u4ee5\u4e0b\u793a\u4f8b Deployment \u4fdd\u5b58\u7232 `store-deployment.yaml` \uff1a```\napiVersion: apps/v1kind: Deploymentmetadata:\u00a0 name: storespec:\u00a0 replicas: 2\u00a0 selector:\u00a0 \u00a0 matchLabels:\u00a0 \u00a0 \u00a0 app: store\u00a0 template:\u00a0 \u00a0 metadata:\u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 app: store\u00a0 \u00a0 spec:\u00a0 \u00a0 \u00a0 containers:\u00a0 \u00a0 \u00a0 - image: gcr.io/google_containers/echoserver:1.10\u00a0 \u00a0 \u00a0 \u00a0 imagePullPolicy: Always\u00a0 \u00a0 \u00a0 \u00a0 name: echoserver\u00a0 \u00a0 \u00a0 \u00a0 ports:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - name: http\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 containerPort: 8080\u00a0 \u00a0 \u00a0 \u00a0 readinessProbe:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 httpGet:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 path: /healthz\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 port: 8080\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 scheme: HTTP\n```\n- \u5c07\u6e05\u55ae\u61c9\u7528\u65bc\u96c6\u7fa3\uff1a```\nkubectl apply -f store-deployment.yaml\n```\n- \u9a57\u8b49\u8a72 Deployment \u662f\u5426\u6709\u5169\u500b\u670d\u52d9 Pod\uff1a```\nkubectl get pods\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nNAME      READY STATUS RESTARTS AGE\nstore-cdb9bb4d6-s25vw  1/1  Running 0   10s\nstore-cdb9bb4d6-vck6s  1/1  Running 0   10s\n```\n- \u5c07\u4ee5\u4e0b\u670d\u52d9\u6e05\u55ae\u4fdd\u5b58\u7232 `store-v1-lb-svc.yaml` \uff1a```\napiVersion: v1kind: Servicemetadata:\u00a0 name: store-v1-lb-svc\u00a0 annotations:\u00a0 \u00a0 cloud.google.com/l4-rbs: \"enabled\"spec:\u00a0 type: LoadBalancer\u00a0 externalTrafficPolicy: Cluster\u00a0 selector:\u00a0 \u00a0 app: store\u00a0 ports:\u00a0 - name: tcp-port\u00a0 \u00a0 protocol: TCP\u00a0 \u00a0 port: 8080\u00a0 \u00a0 targetPort: 8080\n```\u6b64\u5916\u90e8 LoadBalancer \u670d\u52d9\u4f7f\u7528 `Cluster` \u7684\u9ed8\u8a8d `externalTrafficPolicy` \u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3 `externalTrafficPolicy` \u5982\u4f55\u5b9a\u7fa9\u7bc0\u9ede\u5206\u7d44\u3001\u6709\u54ea\u4e9b\u7bc0\u9ede\u901a\u904e\u4e86\u8ca0\u8f09\u5747\u8861\u5668\u7684\u5065\u5eb7\u6aa2\u67e5\u4ee5\u53ca\u6578\u64da\u5305\u7684\u8655\u7406\u65b9\u5f0f\uff0c\u8acb\u53c3\u95b1 [LoadBalancer \u670d\u52d9\u6982\u5ff5](https://cloud.google.com/kubernetes-engine/docs/concepts/service-load-balancer?hl=zh-cn) \u3002\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f [IPv4/IPv6 \u96d9\u68e7\u96c6\u7fa3](https://cloud.google.com/kubernetes-engine/docs/how-to/alias-ips?hl=zh-cn#dual-stack) \uff0c\u8acb\u6dfb\u52a0 `spec.ipFamilyPolicy` \u548c `ipFamilies` \u4ee5\u5b9a\u7fa9 GKE \u5982\u4f55\u5c07 IP \u5730\u5740\u5206\u914d\u7d66\u8a72\u670d\u52d9\u3002\u4f7f\u7528 `ipFamilyPolicy` \u548c `ipFamilies` \u898f\u7bc4\u6642\uff0c\u8acb\u8003\u616e\u4ee5\u4e0b\u689d\u4ef6\uff1a- \u7576\u60a8\u5275\u5efa\u57fa\u65bc\u5f8c\u7aef\u670d\u52d9\u7684\u5916\u90e8\u76f4\u901a\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u6642\uff0cGKE \u6703\u81ea\u52d5\u5c07`cloud.google.com/l4-rbs`\u8a3b\u89e3\u6dfb\u52a0\u5230\u5728 IPv4/IPv6 \u96d9\u68e7\u96c6\u7fa3\u4e0a\u5275\u5efa\u7684\u65b0\u670d\u52d9\u4e2d\u3002\u4f46\u662f\uff0c\u5982\u679c\u60a8\u5c07`cloud.google.com/l4-rbs: \"enabled\"`\u8a3b\u89e3\u6dfb\u52a0\u5230\u73fe\u6709\u670d\u52d9\u6e05\u55ae\uff0c\u5247\u96c6\u7fa3\u4e2d\u5df2\u5b58\u5728\u7684 LoadBalancer \u670d\u52d9\u5c07\u7e7c\u7e8c\u4f7f\u7528\u57fa\u65bc\u76ee\u6a19\u6c60\u7684\u5916\u90e8\u76f4\u901a\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\uff08\u50c5 IPv4\uff09\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7bc0\u9ede\u5206\u7d44](https://cloud.google.com/kubernetes-engine/docs/concepts/service-load-balancer?hl=zh-cn#endpoint-grouping) \u3002\n- GKE \u53ef\u4ee5\u5206\u914d\u55ae\u68e7\uff08\u50c5 IPv4 \u6216\u50c5 IPv6\uff09\u6216\u96d9\u68e7 LoadBalancer \u670d\u52d9\u3002\u96d9\u68e7 LoadBalancer \u670d\u52d9\u7531\u5169\u500b\u55ae\u7368\u7684\u5916\u90e8\u76f4\u901a\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u8f49\u767c\u898f\u5247\u5be6\u73fe\uff1a\u4e00\u500b\u7528\u65bc\u8655\u7406\u57fa\u65bc IPv4 \u7684 TCP \u6d41\u91cf\uff0c\u53e6\u4e00\u500b\u7528\u65bc\u8655\u7406\u57fa\u65bc IPv6 \u7684 TCP \u6d41\u91cf\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u670d\u52d9](https://kubernetes.io/docs/concepts/services-networking/dual-stack/#services) \u3002\n- \u5c07\u6e05\u55ae\u61c9\u7528\u65bc\u96c6\u7fa3\uff1a```\nkubectl apply -f store-v1-lb-svc.yaml\n```\n- \u9a57\u8b49\u60a8\u7684\u670d\u52d9\u662f\u5426\u6b63\u5728\u904b\u884c\uff1a```\nkubectl get svc store-v1-lb-svc\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nNAME    TYPE   CLUSTER-IP  EXTERNAL-IP  PORT(S)   AGE\nstore-v1-lb-svc LoadBalancer 10.44.196.160  35.193.28.231 8080:32466/TCP 11m\n```GKE \u7232\u5916\u90e8\u76f4\u901a\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u5206\u914d\u4e86\u4e00\u500b `` \u3002 **\u6ce8\u610f** \uff1a\u5728\u8ca0\u8f09\u5747\u8861\u5668\u6e96\u5099\u597d\u7232\u61c9\u7528\u63d0\u4f9b\u670d\u52d9\u4e4b\u524d\uff0cGKE \u53ef\u80fd\u9700\u8981\u5e7e\u5206\u9418\u7684\u6642\u9593\u4f86\u5206\u914d\u5916\u90e8 IP \u5730\u5740\u3002\n- \u6e2c\u8a66\u8207\u8ca0\u8f09\u5747\u8861\u5668\u4e4b\u9593\u7684\u9023\u63a5\uff1a```\ncurl EXTERNAL_IP:PORT\n```\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u7232\u5916\u90e8\u76f4\u901a\u5f0f\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u5206\u914d\u7684 IP \u5730\u5740\u3002\n- ``\uff1a\u7232\u5916\u90e8\u76f4\u901a\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u5206\u914d\u7684\u7aef\u53e3\u865f\u3002\n\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nHostname: store-v1-lb-svc-cdb9bb4d6-hflxd\nPod Information:\n -no pod information available\nServer values:\n server_version=nginx: 1.13.3 - lua: 10008\nRequest Information:\n client_address=10.128.0.50\n method=GET\n real path=/\n query=\n request_version=1.1\n request_scheme=http\n request_uri=EXTERNAL_IP\nRequest Headers:\n accept=*/*\n host=EXTERNAL_IP\n user-agent=curl/7.81.0\nRequest Body:\n -no body in request\n```## \u9a57\u8b49\u5916\u90e8 LoadBalancer \u670d\u52d9\u53ca\u5176\u7d44\u4ef6\n- \u6aa2\u67e5\u60a8\u7684 LoadBalancer \u670d\u52d9\u4ee5\u53ca\u63cf\u8ff0\u5176 Google Cloud \u8cc7\u6e90\u7684\u4e00\u7d44\u8a3b\u91cb\uff1a```\nkubectl describe svc store-v1-lb-svc\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nName:      store-v1-lb-svc\nNamespace:    default\nLabels:     <none>\nAnnotations:    cloud.google.com/l4-rbs: enabled\n       service.kubernetes.io/backend-service: k8s2-c086604n-default-store-v1-lb-svc-aip4ty1x\n       service.kubernetes.io/firewall-rule: k8s2-c086604n-default-store-v1-lb-svc-aip4ty1x\n       service.kubernetes.io/firewall-rule-for-hc: k8s2-c086604n-l4-shared-hc-fw\n       service.kubernetes.io/healthcheck: k8s2-c086604n-l4-shared-hc\n       service.kubernetes.io/tcp-forwarding-rule: a683373f85bfe433ba929a50ca8d72e2\nSelector:     app=store\nType:      LoadBalancer\nIP Family Policy:   SingleStack\nIP Families:    IPv4\nIP:      10.44.196.160\nIPs:      10.44.196.160\nLoadBalancer Ingress:  35.193.28.231\nPort:      tcp-port 8080/TCP\nTargetPort:    8080/TCP\nNodePort:     tcp-port 32466/TCP\nEndpoints:    10.48.0.5:8080,10.48.2.8:8080\nSession Affinity:   None\nExternal Traffic Policy: Cluster\nEvents:\n Type Reason    Age     From      Message\n ---- ------    ----     ----      ------ Normal ADD     2m42s     loadbalancer-controller default/store-v1-lb-svc\n Normal EnsuringLoadBalancer 102s (x2 over 2m42s) service-controller  Ensuring load balancer\n Normal Annotations   102s     loadbalancer-controller map[cloud.google.com/l4-rbs:enabled kubectl.kubernetes.io/last-applied-configuration:{\"apiVersion\":\"v1\",\"kind\":\"Service\",\"metadata\":{\"annotations\":\n{\"cloud.google.com/l4-rbs\":\"enabled\"},\"name\":\"store-v1-lb-svc\",\"namespace\":\"default\"}\n,\"spec\":{\"externalTrafficPolicy\":\"Cluster\",\"ports\":\n[{\"name\":\"tcp-port\",\"port\":8080,\"protocol\":\"TCP\",\"targetPort\":8080}],\n\"selector\":{\"app\":\"store\"},\"type\":\"LoadBalancer\"}}\n] -> map[cloud.google.com/l4-rbs:enabled\nkubectl.kubernetes.io/last-applied-configuration:{\"apiVersion\":\"v1\",\"kind\":\n\"Service\",\"metadata\":{\"annotations\":{\"cloud.google.com/l4-rbs\":\"enabled\"},\n\"name\":\"store-v1-lb-svc\",\"namespace\":\"default\"},\"spec\":{\"externalTrafficPolicy\"\n:\"Cluster\",\"ports\":[{\"name\":\"tcp-port\",\"port\":8080,\"protocol\":\"TCP\",\"targetPort\"\n:8080}],\"selector\":{\"app\":\"store\"},\"type\":\"LoadBalancer\"}}\nservice.kubernetes.io/backend-service:k8s2-c086604n-default-store-v1-lb-svc-aip4ty1x\nservice.kubernetes.io/firewall-rule:k8s2-c086604n-default-store-v1-lb-svc-aip4ty1x\nservice.kubernetes.io/firewall-rule-for-hc:k8s2-c086604n-l4-shared-hc-fw\nservice.kubernetes.io/healthcheck:k8s2-c086604n-l4-shared-hc\nservice.kubernetes.io/tcp-forwarding-rule:a683373f85bfe433ba929a50ca8d72e2]\nNormal SyncLoadBalancerSuccessful 16s (x3 over 102s) loadbalancer-controller Successfully ensured L4 External LoadBalancer resources\n```\u6709\u5e7e\u500b\u5b57\u6bb5\u8868\u660e\u5df2\u6210\u529f\u5275\u5efa\u57fa\u65bc\u5f8c\u7aef\u670d\u52d9\u7684\u5916\u90e8\u76f4\u901a\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u53ca\u5176 Google Cloud \u8cc7\u6e90\uff1a- `Events`\u5b57\u6bb5\u3002\u5982\u679c LoadBalancer \u670d\u52d9\u53ca\u5176\u8cc7\u6e90\u5275\u5efa\u6210\u529f\uff0c\u5247\u8a72\u5b57\u6bb5\u7232\u7a7a\u3002\u5982\u679c\u767c\u751f\u932f\u8aa4\uff0c\u5247\u6703\u5728\u8a72\u5b57\u6bb5\u5217\u51fa\u3002\n- \u5df2\u5553\u7528 `Annotations` \u7684\u5217\u8868\uff1aGKE \u6703\u5c07\u4ee5\u4e0b\u53ea\u8b80\u8a3b\u91cb\u7684\u5217\u8868\u6dfb\u52a0\u5230\u670d\u52d9\u6e05\u55ae\u3002\u540d\u7a31\u4ee5 `service.kubernetes.io/` \u958b\u982d\u7684\u6bcf\u500b\u8a3b\u91cb\u90fd\u7528\u65bc\u6307\u793a\u4f5c\u7232\u8ca0\u8f09\u5747\u8861\u5668\u7684\u4e00\u90e8\u5206\u5275\u5efa\u6216\u7232\u4e86\u652f\u6301\u8ca0\u8f09\u5747\u8861\u5668\u800c\u5275\u5efa\u7684 Google Cloud \u8cc7\u6e90\u7684\u540d\u7a31\u3002\n- `service.kubernetes.io/backend-service` \u8a3b\u91cb\u6307\u793a\u8ca0\u8f09\u5747\u8861\u5668\u7684\u5f8c\u7aef\u670d\u52d9\u7684\u540d\u7a31\u3002\n- `service.kubernetes.io/healthcheck` \u8a3b\u91cb\u6307\u793a\u5f8c\u7aef\u670d\u52d9\u4f7f\u7528\u7684\u8ca0\u8f09\u5747\u8861\u5668\u5065\u5eb7\u6aa2\u67e5\u7684\u540d\u7a31\u3002\n- `service.kubernetes.io/tcp-forwarding-rule` \u6216 `service.kubernetes.io/udp-forwarding-rule` \u8a3b\u91cb\u6307\u793a\u8ca0\u8f09\u5747\u8861\u5668\u7684\u8f49\u767c\u898f\u5247\u7684\u540d\u7a31\u3002\n- `service.kubernetes.io/firewall-rule` \u8a3b\u91cb\u6307\u793a\u7232\u5141\u8a31\u6d41\u5411\u96c6\u7fa3\u7bc0\u9ede\u7684\u6d41\u91cf\u800c\u5275\u5efa\u7684\u9632\u706b\u7246\u898f\u5247\u7684\u540d\u7a31\u3002\u6b64\u9632\u706b\u7246\u898f\u5247\u7684\u4f86\u6e90\u7bc4\u570d\u53ef\u4f7f\u7528 `spec.loadBalancerSourceRanges[]` \u9032\u884c\u81ea\u5b9a\u7fa9\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3 LoadBalancer \u670d\u52d9\u7684\u9632\u706b\u7246\u898f\u5247\uff0c\u8acb\u53c3\u95b1 [\u9632\u706b\u7246\u898f\u5247\u548c\u4f86\u6e90 IP \u5730\u5740\u8a31\u53ef\u540d\u55ae](https://cloud.google.com/kubernetes-engine/docs/concepts/service-load-balancer-parameters?hl=zh-cn#fw_ip_address) \u3002\n- `service.kubernetes.io/firewall-rule-for-hc` \u8a3b\u91cb\u6307\u793a\u8ca0\u8f09\u5747\u8861\u5668\u5065\u5eb7\u6aa2\u67e5\u6240\u9700\u7684\u9632\u706b\u7246\u898f\u5247\u7684\u540d\u7a31\u3002\n- \u9a57\u8b49\u662f\u5426\u5df2\u7232\u5916\u90e8 LoadBalancer \u670d\u52d9\u5275\u5efa\u8ca0\u8f09\u5747\u8861\u5668\u8cc7\u6e90\u548c\u9632\u706b\u7246\u898f\u5247\uff1a\n- \u5982\u9700\u67e5\u770b\u8f49\u767c\u898f\u5247\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\n\u00a0 gcloud compute forwarding-rules describe FWD_RULE_NAME \\\u00a0 \u00a0 --region=REGION_NAME\n```\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u7531`service.kubernetes.io/tcp-forwarding-rule`\u6216`service.kubernetes.io/udp-forwarding-rule`\u53ea\u8b80\u8a3b\u91cb\u63d0\u4f9b\u7684\u8f49\u767c\u898f\u5247\u540d\u7a31\u3002\u5982\u9700\u67e5\u770b\u9019\u4e9b\u8a3b\u91cb\uff0c\u8acb\u904b\u884c`kubectl describe svc SERVICE_NAME`\u3002\n- ``\uff1a\u5305\u542b\u96c6\u7fa3\u7684 Google Cloud \u5340\u57df\u3002\u5c0d\u65bc\u53ef\u7528\u5340\u7d1a\u96c6\u7fa3\uff0c\u8a72\u5340\u57df\u5305\u542b\u96c6\u7fa3\u4f7f\u7528\u7684\u53ef\u7528\u5340\u3002\n- \u5982\u9700\u67e5\u770b\u5f8c\u7aef\u670d\u52d9\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud compute backend-services describe BACKEND_SERVICE_NAME \\\u00a0 --region=REGION_NAME\n```\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u7531`service.kubernetes.io/backend-service`\u53ea\u8b80\u8a3b\u91cb\u63d0\u4f9b\u7684\u5f8c\u7aef\u670d\u52d9\u540d\u7a31\u3002\u5982\u9700\u67e5\u770b\u6b64\u53ea\u8b80\u8a3b\u91cb\uff0c\u8acb\u904b\u884c`kubectl describe svc SERVICE_NAME`\u3002\n- ``\uff1a\u5305\u542b\u96c6\u7fa3\u7684 Google Cloud \u5340\u57df\u3002\u5c0d\u65bc\u53ef\u7528\u5340\u7d1a\u96c6\u7fa3\uff0c\u8a72\u5340\u57df\u5305\u542b\u96c6\u7fa3\u4f7f\u7528\u7684\u53ef\u7528\u5340\u3002\n- \u5982\u9700\u67e5\u770b\u8ca0\u8f09\u5747\u8861\u5668\u5065\u5eb7\u6aa2\u67e5\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud compute health-checks describe HEALTH_CHECK_NAME \\\u00a0 --region=REGION_NAME\n```\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u8ca0\u8f09\u5747\u8861\u5668\u5065\u5eb7\u6aa2\u67e5\u7684\u540d\u7a31\u3002\u5065\u5eb7\u6aa2\u67e5\u7684\u540d\u7a31\u7531`service.kubernetes.io/healthcheck`\u53ea\u8b80\u8a3b\u91cb\u63d0\u4f9b\u3002\u5982\u9700\u67e5\u770b\u6b64\u53ea\u8b80\u8a3b\u91cb\uff0c\u8acb\u904b\u884c`kubectl describe svc SERVICE_NAME`\u3002\n- ``\uff1a\u5305\u542b\u96c6\u7fa3\u7684 Google Cloud \u5340\u57df\u3002\u5c0d\u65bc\u53ef\u7528\u5340\u7d1a\u96c6\u7fa3\uff0c\u8a72\u5340\u57df\u5305\u542b\u96c6\u7fa3\u4f7f\u7528\u7684\u53ef\u7528\u5340\u3002\n- \u5982\u9700\u67e5\u770b\u9632\u706b\u7246\u898f\u5247\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud compute firewall-rules describe FIREWALL_RULE_NAME \\gcloud compute firewall-rules describe HEALTH_CHECK_FIREWALL_RULE_NAME\n```\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u5141\u8a31\u6d41\u91cf\u6d41\u5411\u8ca0\u8f09\u5747\u8861\u5668\u7684\u9632\u706b\u7246\u898f\u5247\u7684\u540d\u7a31\u3002\u6b64\u9632\u706b\u7246\u898f\u5247\u7684\u540d\u7a31\u7531`service.kubernetes.io/firewall-rule`\u53ea\u8b80\u8a3b\u91cb\u63d0\u4f9b\u3002\u5982\u9700\u67e5\u770b\u6b64\u53ea\u8b80\u8a3b\u91cb\uff0c\u8acb\u904b\u884c`kubectl describe svc SERVICE_NAME`\u3002\n- ``\uff1a\u5141\u8a31\u5c0d\u8ca0\u8f09\u5747\u8861\u5668\u5f8c\u7aef\uff08\u96c6\u7fa3\u7bc0\u9ede\uff09\u9032\u884c\u5065\u5eb7\u6aa2\u67e5\u7684\u9632\u706b\u7246\u898f\u5247\u7684\u540d\u7a31\u3002\u6b64\u9632\u706b\u7246\u898f\u5247\u7684\u540d\u7a31\u7531`service.kubernetes.io/firewall-rule-for-hc`\u53ea\u8b80\u8a3b\u91cb\u63d0\u4f9b\u3002\u5982\u9700\u67e5\u770b\u6b64\u53ea\u8b80\u8a3b\u91cb\uff0c\u8acb\u904b\u884c`kubectl describe svc SERVICE_NAME`\u3002\n## \u522a\u9664\u5916\u90e8 LoadBalancer \u670d\u52d9\u53ca\u5176\u7d44\u4ef6\n\u522a\u9664 `store-v1-lb-svc` \u5916\u90e8 LoadBalancer \u670d\u52d9\u3002\n```\nkubectl delete service store-v1-lb-svc\n```\nGKE \u6703\u522a\u9664\u4ee5\u4e0b\u8cc7\u6e90\uff1a\n- \u8ca0\u8f09\u5747\u8861\u5668\u7684\u8f49\u767c\u898f\u5247\u3002\n- \u8ca0\u8f09\u5747\u8861\u5668\u7684\u5f8c\u7aef\u670d\u52d9\u3002\n- \u8ca0\u8f09\u5747\u8861\u5668\u7684\u5065\u5eb7\u6aa2\u67e5\u3002\n- \u8ca0\u8f09\u5747\u8861\u5668\u53ca\u5176\u5065\u5eb7\u6aa2\u67e5\u7684\u6d41\u91cf\u6240\u9700\u7684 VPC \u9632\u706b\u7246\u898f\u5247\u3002\n- \u53ef\u7528\u5340\u7d1a\u975e\u4ee3\u7ba1\u5f0f\u5be6\u4f8b\u7d44\u5f8c\u7aef\uff0c\u524d\u63d0\u662f GKE \u4e0d\u9700\u8981\u5c07\u9019\u4e9b\u5f8c\u7aef\u7528\u4f5c\u96c6\u7fa3\u5275\u5efa\u7684\u5176\u4ed6\u8ca0\u8f09\u5747\u8861\u5668\u7684\u5f8c\u7aef\u3002\n**\u91cd\u8981\u63d0\u793a** \uff1a\u79fb\u9664 `cloud.google.com/l4-rbs: \"enabled\"` \u8a3b\u91cb\u4e0d\u6703\u5c0e\u81f4 GKE \u5c07\u57fa\u65bc\u5f8c\u7aef\u670d\u52d9\u7684\u73fe\u6709\u5916\u90e8\u76f4\u901a\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u8f49\u63db\u7232\u57fa\u65bc\u76ee\u6a19\u6c60\u7684\u5916\u90e8\u76f4\u901a\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u3002\u5982\u9700\u5207\u63db\u7232\u57fa\u65bc\u76ee\u6a19\u6c60\u7684\u5916\u90e8\u76f4\u901a\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\uff0c\u60a8\u5fc5\u9808\u522a\u9664\u4e26\u66ff\u63db\u670d\u52d9\u6e05\u55ae\u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u5982\u9700\u5927\u81f4\u77ad\u89e3\u8ca0\u8f09\u5747\u8861\u5668\u670d\u52d9\uff0c\u8acb\u53c3\u95b1 [LoadBalancer \u670d\u52d9](https://cloud.google.com/kubernetes-engine/docs/concepts/service-load-balancer?hl=zh-cn) \u3002\n- \u5982\u9700\u77ad\u89e3\u8ca0\u8f09\u5747\u8861\u5668\u670d\u52d9\u53c3\u6578\uff0c\u8acb\u53c3\u95b1 [LoadBalancer \u670d\u52d9\u53c3\u6578](https://cloud.google.com/kubernetes-engine/docs/concepts/service-load-balancer-parameters?hl=zh-cn) \u3002", "guide": "Google Kubernetes Engine (GKE)"}