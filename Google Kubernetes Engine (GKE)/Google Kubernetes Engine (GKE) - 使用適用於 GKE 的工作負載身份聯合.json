{"title": "Google Kubernetes Engine (GKE) - \u4f7f\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408", "url": "https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - \u4f7f\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\n\u672c\u6587\u6a94\u4ecb\u7d39\u5982\u4f55\u5728 Google Kubernetes Engine (GKE) \u96c6\u7fa3\u4e0a\u5553\u7528\u548c\u914d\u7f6e\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u5141\u8a31 GKE \u96c6\u7fa3\u4e2d\u7684\u5de5\u4f5c\u8ca0\u8f09\u6a21\u64ec (impersonate) Identity and Access Management (IAM) \u670d\u52d9\u8cec\u865f\u4f86\u8a2a\u554f Google Cloud \u670d\u52d9\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u7684\u5de5\u4f5c\u539f\u7406\u4ee5\u53ca\u9650\u5236\uff0c\u8acb\u53c3\u95b1 [\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408](https://cloud.google.com/kubernetes-engine/docs/concepts/workload-identity?hl=zh-cn) \u3002\n", "content": "## \u6e96\u5099\u5de5\u4f5c\n\u5728\u958b\u59cb\u4e4b\u524d\uff0c\u8acb\u78ba\u4fdd\u60a8\u5df2\u57f7\u884c\u4ee5\u4e0b\u4efb\u52d9\uff1a\n- \u5553\u7528 Google Kubernetes Engine API\u3002\n- [  \u5553\u7528 Google Kubernetes Engine API ](https://console.cloud.google.com/flows/enableapi?apiid=container.googleapis.com&hl=zh-cn) \n- \u5982\u679c\u60a8\u8981\u4f7f\u7528 Google Cloud CLI \u57f7\u884c\u6b64\u4efb\u52d9\uff0c\u8acb [\u5b89\u88dd](https://cloud.google.com/sdk/docs/install?hl=zh-cn) \u4e26 [\u521d\u59cb\u5316](https://cloud.google.com/sdk/docs/initializing?hl=zh-cn) gcloud CLI\u3002 \u5982\u679c\u60a8\u4e4b\u524d\u5b89\u88dd\u4e86 gcloud CLI\uff0c\u8acb\u904b\u884c`gcloud components update`\u4ee5\u7372\u53d6\u6700\u65b0\u7248\u672c\u3002 **\u6ce8\u610f** \uff1a\u5c0d\u65bc\u73fe\u6709 gcloud CLI \u5b89\u88dd\uff0c\u8acb\u52d9\u5fc5\u8a2d\u7f6e`compute/region`\u548c`compute/zone` [\u5c6c\u6027](https://cloud.google.com/sdk/docs/properties?hl=zh-cn#setting_properties) \u3002\u901a\u904e\u8a2d\u7f6e\u9ed8\u8a8d\u4f4d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u907f\u514d gcloud CLI \u4e2d\u51fa\u73fe\u4ee5\u4e0b\u932f\u8aa4\uff1a`One of [--zone, --region] must be supplied: Please specify location`\u3002\n- \u78ba\u4fdd\u60a8\u5df2\u5553\u7528 IAM Service Account Credentials API\u3002 [\u5553\u7528 IAM Credentials API](https://console.cloud.google.com/apis/api/iamcredentials.googleapis.com/overview?hl=zh-cn) \n- \u78ba\u4fdd\u60a8\u64c1\u6709\u4ee5\u4e0b [IAM \u89d2\u8272](https://cloud.google.com/iam/docs/understanding-roles?hl=zh-cn#kubernetes-engine-roles) \uff1a- `roles/container.admin`\n- `roles/iam.serviceAccountAdmin`\n- \u78ba\u4fdd\u60a8\u77ad\u89e3 [\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u7684\u9650\u5236](https://cloud.google.com/kubernetes-engine/docs/concepts/workload-identity?hl=zh-cn#restrictions) \u3002## \u5553\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\n\u60a8\u53ef\u4ee5\u4f7f\u7528 Google Cloud CLI \u6216 Google Cloud \u63a7\u5236\u6aaf\u5728\u96c6\u7fa3\u548c\u7bc0\u9ede\u6c60\u4e0a\u5553\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002 **\u5fc5\u9808** \u5148\u5728\u96c6\u7fa3\u7d1a\u5c64\u5553\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u7136\u5f8c\u624d\u80fd\u5728\u7bc0\u9ede\u6c60\u4e0a\u5553\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\n\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cAutopilot \u96c6\u7fa3\u6703\u5553\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\u5982\u9700\u5c07 Autopilot Pod \u914d\u7f6e\u7232\u4f7f\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u8acb\u8df3\u8f49\u81f3 [\u5c07\u61c9\u7528\u914d\u7f6e\u7232\u4f7f\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408](#authenticating_to) \u3002\n### \u5275\u5efa\u65b0\u96c6\u7fa3\n\u60a8\u53ef\u4ee5\u4f7f\u7528 gcloud CLI \u6216 Google Cloud \u63a7\u5236\u6aaf\u5728\u65b0\u7684\u6a19\u6e96\u96c6\u7fa3\u4e0a\u5553\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u6fc0\u6d3b Cloud Shell\u3002 [\u6fc0\u6d3b Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn)  [Cloud Shell](https://cloud.google.com/shell/docs/how-cloud-shell-works?hl=zh-cn) \u6703\u8a71\u96a8\u5373\u6703\u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5e95\u90e8\u5553\u52d5\uff0c\u4e26\u986f\u793a\u547d\u4ee4\u884c\u63d0\u793a\u7b26\u3002Cloud Shell \u662f\u4e00\u500b\u5df2\u5b89\u88dd Google Cloud CLI \u4e14\u5df2\u7232\u7576\u524d\u9805\u76ee\u8a2d\u7f6e\u503c\u7684 Shell \u74b0\u5883\u3002\u8a72\u6703\u8a71\u53ef\u80fd\u9700\u8981\u5e7e\u79d2\u9418\u6642\u9593\u4f86\u5b8c\u6210\u521d\u59cb\u5316\u3002\n- \u5982\u9700\u5728\u65b0\u96c6\u7fa3\u4e0a\u5553\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud container clusters create CLUSTER_NAME \\\u00a0 \u00a0 --region=COMPUTE_REGION \\\u00a0 \u00a0 --workload-pool=PROJECT_ID.svc.id.goog\n```\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u65b0\u96c6\u7fa3\u7684\u540d\u7a31\u3002\n- ``\uff1a\u96c6\u7fa3\u7684 Compute Engine [\u5340\u57df](https://cloud.google.com/compute/docs/regions-zones?hl=zh-cn#available) \u3002\u5c0d\u65bc\u53ef\u7528\u5340\u7d1a\u96c6\u7fa3\uff0c\u8acb\u4f7f\u7528`--zone=` ``\u3002\n- ``\uff1a\u60a8\u7684 Google Cloud \u9805\u76ee ID\u3002\n\u5982\u9700\u5728\u65b0\u96c6\u7fa3\u4e0a\u5553\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u8f49\u5230 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **Google Kubernetes Engine** \u9801\u9762\u3002 [\u8f49\u5230 Google Kubernetes Engine](https://console.cloud.google.com/kubernetes/list?hl=zh-cn) \n- \u9ede\u64ca **\u5275\u5efa** \u3002\n- \u5728 **\u5275\u5efa\u96c6\u7fa3** \u5c0d\u8a71\u6846\u4e2d\uff0c\u5c0d\u65bc GKE Standard\uff0c\u9ede\u64ca **\u914d\u7f6e** \u3002\n- \u5728\u5c0e\u822a\u83dc\u55ae\u7684 **\u96c6\u7fa3** \u90e8\u5206\u4e2d\uff0c\u9ede\u64ca **\u5b89\u5168** \u3002\n- \u9078\u4e2d **\u5553\u7528 Workload Identity** \u8907\u9078\u6846\u3002\n- \u7e7c\u7e8c\u914d\u7f6e\u8a72\u96c6\u7fa3\uff0c\u7136\u5f8c\u9ede\u64ca **\u5275\u5efa** \u3002\n### \u66f4\u65b0\u73fe\u6709\u96c6\u7fa3\n\u60a8\u53ef\u4ee5\u4f7f\u7528 gcloud CLI \u6216 Google Cloud \u63a7\u5236\u6aaf\u5728\u73fe\u6709\u6a19\u6e96\u96c6\u7fa3\u4e0a\u5553\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\u73fe\u6709\u7bc0\u9ede\u6c60\u4e0d\u53d7\u5f71\u97ff\uff0c\u4f46\u96c6\u7fa3\u4e2d\u7684\u4efb\u4f55\u65b0\u7bc0\u9ede\u6c60\u90fd\u4f7f\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u6fc0\u6d3b Cloud Shell\u3002 [\u6fc0\u6d3b Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn)  [Cloud Shell](https://cloud.google.com/shell/docs/how-cloud-shell-works?hl=zh-cn) \u6703\u8a71\u96a8\u5373\u6703\u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5e95\u90e8\u5553\u52d5\uff0c\u4e26\u986f\u793a\u547d\u4ee4\u884c\u63d0\u793a\u7b26\u3002Cloud Shell \u662f\u4e00\u500b\u5df2\u5b89\u88dd Google Cloud CLI \u4e14\u5df2\u7232\u7576\u524d\u9805\u76ee\u8a2d\u7f6e\u503c\u7684 Shell \u74b0\u5883\u3002\u8a72\u6703\u8a71\u53ef\u80fd\u9700\u8981\u5e7e\u79d2\u9418\u6642\u9593\u4f86\u5b8c\u6210\u521d\u59cb\u5316\u3002\n- \u5982\u9700\u5728\u73fe\u6709\u96c6\u7fa3\u4e0a\u5553\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud container clusters update CLUSTER_NAME \\\u00a0 \u00a0 --region=COMPUTE_REGION \\\u00a0 \u00a0 --workload-pool=PROJECT_ID.svc.id.goog\n```\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u73fe\u6709\u96c6\u7fa3\u7684\u540d\u7a31\u3002\n- ``\uff1a\u96c6\u7fa3\u7684 Compute Engine [\u5340\u57df](https://cloud.google.com/compute/docs/regions-zones?hl=zh-cn#available) \u3002\u5c0d\u65bc\u53ef\u7528\u5340\u7d1a\u96c6\u7fa3\uff0c\u8acb\u4f7f\u7528`--zone=` ``\u3002\n- ``\uff1a\u60a8\u7684 Google Cloud \u9805\u76ee ID\u3002\n\u5982\u9700\u5728\u73fe\u6709\u96c6\u7fa3\u4e0a\u5553\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u8f49\u5230 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **Google Kubernetes Engine** \u9801\u9762\u3002 [\u8f49\u5230 Google Kubernetes Engine](https://console.cloud.google.com/kubernetes/list?hl=zh-cn) \n- \u5728\u96c6\u7fa3\u5217\u8868\u4e2d\uff0c\u9ede\u64ca\u60a8\u8981\u4fee\u6539\u7684\u96c6\u7fa3\u7684\u540d\u7a31\u3002\n- \u5728\u96c6\u7fa3\u8a73\u60c5\u9801\u9762\u7684 **\u5b89\u5168** \u90e8\u5206\u4e2d\uff0c\u9ede\u64ca edit **\u4fee\u6539\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408** \u3002\n- \u5728 **\u4fee\u6539 Workload Identity** \u5c0d\u8a71\u6846\u4e2d\uff0c\u9078\u4e2d **\u5553\u7528 Workload Identity** \u8907\u9078\u6846\u3002\n- \u9ede\u64ca **\u4fdd\u5b58\u66f4\u6539** \u3002## \u5c07\u73fe\u6709\u5de5\u4f5c\u8ca0\u8f09\u9077\u79fb\u5230\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\n\u5728\u73fe\u6709\u96c6\u7fa3\u4e0a\u5553\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u5f8c\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u9077\u79fb\u6b63\u5728\u904b\u884c\u7684\u5de5\u4f5c\u8ca0\u8f09\uff0c\u4ee5\u4f7f\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\u9078\u64c7\u6700\u9069\u5408\u60a8\u7684\u74b0\u5883\u7684\u9077\u79fb\u7b56\u7565\u3002\u60a8\u53ef\u4ee5\u5275\u5efa\u65b0\u7684\u7bc0\u9ede\u6c60\u4e26\u5553\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u4e5f\u53ef\u4ee5\u66f4\u65b0\u73fe\u6709\u7684\u7bc0\u9ede\u6c60\u4ee5\u5553\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\n**\u6ce8\u610f\uff1a** \u53ea\u6709\u5728\u96c6\u7fa3\u4e0a\u5553\u7528\u4e86\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u624d\u80fd\u5728\u7bc0\u9ede\u6c60\u4e0a\u5553\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\n\u5982\u679c\u60a8\u9084\u9700\u8981\u4fee\u6539\u61c9\u7528\u4ee5\u8207\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u517c\u5bb9\uff0c\u6211\u5011\u5efa\u8b70\u60a8\u5275\u5efa\u65b0\u7684\u7bc0\u9ede\u6c60\u3002\n### \u5275\u5efa\u65b0\u7684\u7bc0\u9ede\u6c60\n\u5982\u679c\u96c6\u7fa3\u5553\u7528\u4e86\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u5247\u60a8\u5275\u5efa\u7684\u6240\u6709\u65b0\u7bc0\u9ede\u6c60\u9ed8\u8a8d\u4f7f\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\u5982\u9700\u5275\u5efa\u5553\u7528\u4e86\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u7684\u65b0\u7bc0\u9ede\u6c60\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ngcloud container node-pools create NODEPOOL_NAME \\\u00a0 \u00a0 --cluster=CLUSTER_NAME \\\u00a0 \u00a0 --region=COMPUTE_REGION \\\u00a0 \u00a0 --workload-metadata=GKE_METADATA\n```\n\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a\n- ``\uff1a\u65b0\u7bc0\u9ede\u6c60\u7684\u540d\u7a31\u3002\n- ``\uff1a\u5553\u7528\u4e86\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u7684\u73fe\u6709\u96c6\u7fa3\u7684\u540d\u7a31\u3002\n`--workload-metadata=GKE_METADATA` \u6a19\u8a8c\u5c07\u7bc0\u9ede\u6c60\u914d\u7f6e\u7232\u4f7f\u7528 GKE \u5143\u6578\u64da\u670d\u52d9\u5668\u3002\u6211\u5011\u5efa\u8b70\u60a8\u6dfb\u52a0\u8a72\u6a19\u8a8c\uff0c\u9019\u6a23\u4e00\u4f86\uff0c\u672a\u5728\u96c6\u7fa3\u4e0a\u5553\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u6642\uff0c\u7bc0\u9ede\u6c60\u5275\u5efa\u5c07\u6703\u5931\u6557\u3002\n### \u66f4\u65b0\u73fe\u6709\u7bc0\u9ede\u6c60\n\u5728\u96c6\u7fa3\u4e0a\u5553\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5728\u73fe\u6709\u7bc0\u9ede\u6c60\u4e0a\u624b\u52d5\u5553\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\n**\u6ce8\u610f\uff1a** \u4fee\u6539\u7bc0\u9ede\u6c60\u6703\u7acb\u5373\u7232\u5728\u7bc0\u9ede\u6c60\u4e2d\u904b\u884c\u7684\u4efb\u4f55\u5de5\u4f5c\u8ca0\u8f09\u5553\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\u9019\u53ef\u9632\u6b62\u5de5\u4f5c\u8ca0\u8f09\u4f7f\u7528 [Compute Engine \u9ed8\u8a8d\u670d\u52d9\u8cec\u865f](https://cloud.google.com/compute/docs/access/service-accounts?hl=zh-cn) \uff0c\u4e26\u4e14\u53ef\u80fd\u6703\u5c0e\u81f4\u4e2d\u65b7\u3002\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u6fc0\u6d3b Cloud Shell\u3002 [\u6fc0\u6d3b Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn)  [Cloud Shell](https://cloud.google.com/shell/docs/how-cloud-shell-works?hl=zh-cn) \u6703\u8a71\u96a8\u5373\u6703\u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5e95\u90e8\u5553\u52d5\uff0c\u4e26\u986f\u793a\u547d\u4ee4\u884c\u63d0\u793a\u7b26\u3002Cloud Shell \u662f\u4e00\u500b\u5df2\u5b89\u88dd Google Cloud CLI \u4e14\u5df2\u7232\u7576\u524d\u9805\u76ee\u8a2d\u7f6e\u503c\u7684 Shell \u74b0\u5883\u3002\u8a72\u6703\u8a71\u53ef\u80fd\u9700\u8981\u5e7e\u79d2\u9418\u6642\u9593\u4f86\u5b8c\u6210\u521d\u59cb\u5316\u3002\n- \u5982\u9700\u4fee\u6539\u73fe\u6709\u7bc0\u9ede\u6c60\u4ee5\u4f7f\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud container node-pools update NODEPOOL_NAME \\\u00a0 \u00a0 --cluster=CLUSTER_NAME \\\u00a0 \u00a0 --region=COMPUTE_REGION \\\u00a0 \u00a0 --workload-metadata=GKE_METADATA\n```\u5982\u679c\u96c6\u7fa3\u5553\u7528\u4e86\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u660e\u78ba\u6307\u5b9a `--workload-metadata=GCE_METADATA` \u5728\u7279\u5b9a\u7bc0\u9ede\u6c60\u4e2d\u9078\u64c7\u6027\u5730\u505c\u7528\u5b83\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u4fdd\u8b77\u96c6\u7fa3\u5143\u6578\u64da](https://cloud.google.com/kubernetes-engine/docs/how-to/protecting-cluster-metadata?hl=zh-cn) \u3002\n\u5982\u9700\u4fee\u6539\u73fe\u6709\u7bc0\u9ede\u6c60\u4ee5\u4f7f\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u6b65\u9a5f\uff1a- \u8f49\u5230 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **Google Kubernetes Engine** \u9801\u9762\u3002 [\u8f49\u5230 Google Kubernetes Engine](https://console.cloud.google.com/kubernetes/list?hl=zh-cn) \n- \u5728\u96c6\u7fa3\u5217\u8868\u4e2d\uff0c\u9ede\u64ca\u60a8\u8981\u4fee\u6539\u7684\u96c6\u7fa3\u7684\u540d\u7a31\u3002\n- \u9ede\u64ca **\u7bc0\u9ede** \u6a19\u7c64\u9801\u3002\n- \u5728 **\u7bc0\u9ede\u6c60** \u90e8\u5206\u4e2d\uff0c\u9ede\u64ca\u8981\u4fee\u6539\u7684\u7bc0\u9ede\u6c60\u7684\u540d\u7a31\u3002\n- \u5728 **\u7bc0\u9ede\u6c60\u8a73\u60c5** \u9801\u9762\u4e2d\uff0c\u9ede\u64ca edit **\u4fee\u6539** \u3002\n- \u5728 **\u4fee\u6539\u7bc0\u9ede\u6c60** \u9801\u9762\u7684 **\u5b89\u5168** \u90e8\u5206\u4e2d\uff0c\u9078\u4e2d **\u5553\u7528 GKE \u5143\u6578\u64da\u670d\u52d9\u5668** \u8907\u9078\u6846\u3002\n- \u9ede\u64ca **\u4fdd\u5b58** \u3002## \u5c07\u61c9\u7528\u914d\u7f6e\u7232\u4f7f\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\n\u5553\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u5f8c\uff0c\u60a8\u61c9\u8a72\u5c07\u61c9\u7528\u914d\u7f6e\u7232\u4f7f\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u5411 Google Cloud \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u7136\u5f8c\u518d\u5c07\u61c9\u7528\u9077\u79fb\u5230\u65b0\u7684\u7bc0\u9ede\u6c60\u3002\n\u60a8\u5fc5\u9808\u7232\u61c9\u7528\u5206\u914d [Kubernetes \u670d\u52d9\u8cec\u865f](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/) \uff0c\u4e26\u5c07\u8a72 Kubernetes \u670d\u52d9\u8cec\u865f\u914d\u7f6e\u7232\u5145\u7576 [IAM \u670d\u52d9\u8cec\u865f](https://cloud.google.com/iam/docs/service-accounts?hl=zh-cn) \u3002\n\u4ee5\u4e0b\u6b65\u9a5f\u6f14\u793a\u77ad\u5982\u4f55\u5c07\u61c9\u7528\u914d\u7f6e\u7232\u4f7f\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff08\u5982\u679c\u96c6\u7fa3\u4e0a\u5553\u7528\u4e86\u8a72\u529f\u80fd\uff09\u3002\n- \u7372\u53d6\u96c6\u7fa3\u7684\u6191\u64da\uff1a```\ngcloud container clusters get-credentials CLUSTER_NAME \\\u00a0 \u00a0 --region=COMPUTE_REGION\n```\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u5553\u7528\u4e86\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u7684\u96c6\u7fa3\u7684\u540d\u7a31\u3002\n- ``\uff1a\u96c6\u7fa3\u7684 Compute Engine \u5340\u57df\u3002\n- \u5275\u5efa\u7528\u65bc Kubernetes \u670d\u52d9\u8cec\u865f\u7684\u547d\u540d\u7a7a\u9593\u3002\u60a8\u9084\u53ef\u4ee5\u4f7f\u7528\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u6216\u4efb\u4f55\u73fe\u6709\u547d\u540d\u7a7a\u9593\u3002```\nkubectl create namespace NAMESPACE\n```\n- \u7232\u60a8\u7684\u61c9\u7528\u5275\u5efa Kubernetes \u670d\u52d9\u8cec\u865f\uff1a\u60a8\u9084\u53ef\u4ee5\u5728\u4efb\u4f55\u547d\u540d\u7a7a\u9593\u4e2d\u4f7f\u7528\u4efb\u4f55\u73fe\u6709\u7684 Kubernetes \u670d\u52d9\u8cec\u865f\uff0c\u5305\u62ec `default` \u670d\u52d9\u8cec\u865f\u3002```\nkubectl create serviceaccount KSA_NAME \\\u00a0 \u00a0 --namespace NAMESPACE\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u65b0 Kubernetes \u670d\u52d9\u8cec\u865f\u7684\u540d\u7a31\u3002\n- ``\uff1a\u670d\u52d9\u8cec\u865f\u7684 Kubernetes \u547d\u540d\u7a7a\u9593\u7684\u540d\u7a31\u3002\n- \u7232\u60a8\u7684\u61c9\u7528\u5275\u5efa IAM \u670d\u52d9\u8cec\u865f\uff0c\u6216\u4f7f\u7528\u73fe\u6709 IAM \u670d\u52d9\u8cec\u865f\u3002\u60a8\u53ef\u4ee5\u5728\u7d44\u7e54\u4e2d\u7684\u4efb\u4f55\u9805\u76ee\u4e2d\u4f7f\u7528\u4efb\u4f55 IAM \u670d\u52d9\u8cec\u865f\u3002\u5c0d\u65bc Config Connector\uff0c\u8acb\u7232\u6240\u9078\u670d\u52d9\u8cec\u865f\u61c9\u7528 `IAMServiceAccount` \u5c0d\u8c61\u3002\n - Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u6fc0\u6d3b Cloud Shell\u3002 [\u6fc0\u6d3b Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn)  [Cloud Shell](https://cloud.google.com/shell/docs/how-cloud-shell-works?hl=zh-cn) \u6703\u8a71\u96a8\u5373\u6703\u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5e95\u90e8\u5553\u52d5\uff0c\u4e26\u986f\u793a\u547d\u4ee4\u884c\u63d0\u793a\u7b26\u3002Cloud Shell \u662f\u4e00\u500b\u5df2\u5b89\u88dd Google Cloud CLI \u4e14\u5df2\u7232\u7576\u524d\u9805\u76ee\u8a2d\u7f6e\u503c\u7684 Shell \u74b0\u5883\u3002\u8a72\u6703\u8a71\u53ef\u80fd\u9700\u8981\u5e7e\u79d2\u9418\u6642\u9593\u4f86\u5b8c\u6210\u521d\u59cb\u5316\u3002\n- \u5982\u9700\u4f7f\u7528 gcloud CLI \u5275\u5efa\u65b0\u7684 IAM \u670d\u52d9\u8cec\u865f\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u3002 **\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u8981\u5c07\u73fe\u6709 IAM \u670d\u52d9\u8cec\u865f\u8207 gcloud CLI \u7d50\u5408\u4f7f\u7528\uff0c\u8acb\u8df3\u904e\u6b64\u6b65\u9a5f\u3002```\ngcloud iam service-accounts create GSA_NAME \\\u00a0 \u00a0 --project=GSA_PROJECT\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u65b0 IAM \u670d\u52d9\u8cec\u865f\u7684\u540d\u7a31\u3002\n- ``\uff1a\u60a8\u7684 IAM \u670d\u52d9\u8cec\u865f\u7684 Google Cloud \u9805\u76ee\u7684\u9805\u76ee ID\u3002\n\u5982\u9700\u5c07\u65b0\u7684\u6216\u73fe\u6709\u7684 IAM \u670d\u52d9\u8cec\u865f\u8207 Config Connector \u7d50\u5408\u4f7f\u7528\uff0c\u8acb\u61c9\u7528\u4ee5\u4e0b\u914d\u7f6e\u6587\u4ef6\u3002\n **\u6ce8\u610f** \uff1a\u5373\u4f7f\u60a8\u4f7f\u7528\u73fe\u6709 IAM \u670d\u52d9\u8cec\u865f\uff0c\u4e5f\u5fc5\u9808\u4f7f\u7528 `kubectl` \u5c07 `IAMServiceAccount` \u5c0d\u8c61\u61c9\u7528\u65bc\u96c6\u7fa3\u3002\u5c07\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684 `GSA_NAME` \u66ff\u63db\u7232\u8981\u4f7f\u7528\u7684\u670d\u52d9\u8cec\u865f\u7684\u540d\u7a31\u3002\n **\u6ce8\u610f** \uff1a\u6b64\u6b65\u9a5f\u9700\u8981\u4f7f\u7528 [\u914d\u7f6e\u9023\u63a5\u5668](https://cloud.google.com/config-connector/docs/overview?hl=zh-cn) \u3002\u6309\u7167 [\u5b89\u88dd\u8aaa\u660e](https://cloud.google.com/config-connector/docs/how-to/install-upgrade-uninstall?hl=zh-cn) \u5728\u60a8\u7684\u96c6\u7fa3\u4e0a\u5b89\u88dd\u914d\u7f6e\u9023\u63a5\u5668\u3002\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/k8s-config-connector/blob/HEAD/config/samples/tutorials/workload-identity/service-account.yaml) \n```\napiVersion: iam.cnrm.cloud.google.com/v1beta1kind: IAMServiceAccountmetadata:\u00a0 name: [GSA_NAME]spec:\u00a0 displayName: [DISPLAY_NAME]\n```\n\u5982\u9700\u90e8\u7f72\u6b64\u6e05\u55ae\uff0c\u8acb\u5c07\u5b83\u4ee5\n`service-account.yaml`\n\u7684\u5f62\u5f0f\u4e0b\u8f09\u5230\u60a8\u7684\u6a5f\u5668\u4e0a\u3002\n\u4f7f\u7528 `kubectl` \u61c9\u7528\u6e05\u55ae\uff1a\n```\nkubectl apply -f service-account.yaml\n```\n\u5982\u9700\u77ad\u89e3\u5982\u4f55\u6388\u6b0a IAM \u670d\u52d9\u8cec\u865f\u8a2a\u554f Google Cloud API\uff0c\u8acb\u53c3\u95b1 [\u77ad\u89e3\u670d\u52d9\u8cec\u865f](https://cloud.google.com/iam/docs/understanding-service-accounts?hl=zh-cn) \u3002\n- \u78ba\u4fdd\u60a8\u7684 IAM \u670d\u52d9\u8cec\u865f\u5177\u6709\u60a8\u6240\u9700\u7684 [\u89d2\u8272](https://cloud.google.com/iam/docs/understanding-roles?hl=zh-cn) \u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6388\u4e88\u5176\u4ed6\u89d2\u8272\uff1a```\ngcloud projects add-iam-policy-binding GSA_PROJECT \\\u00a0 \u00a0 --member \"serviceAccount:GSA_NAME@GSA_PROJECT.iam.gserviceaccount.com\" \\\u00a0 \u00a0 --role \"ROLE_NAME\"\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u60a8\u7684 IAM \u670d\u52d9\u8cec\u865f\u7684 Google Cloud \u9805\u76ee\u7684\u9805\u76ee ID\u3002\n- ``\uff1a\u60a8\u7684 IAM \u670d\u52d9\u8cec\u865f\u7684\u540d\u7a31\u3002\n- ``\uff1a\u8981\u5206\u914d\u7d66\u670d\u52d9\u8cec\u865f\u7684 IAM \u89d2\u8272\uff0c\u5982`roles/spanner.viewer`\u3002\n- \u901a\u904e\u5728\u5169\u500b\u670d\u52d9\u8cec\u865f\u4e4b\u9593\u6dfb\u52a0 [IAM \u653f\u7b56\u7d81\u5b9a](https://cloud.google.com/sdk/gcloud/reference/iam/service-accounts/add-iam-policy-binding?hl=zh-cn) \uff0c\u5141\u8a31 Kubernetes \u670d\u52d9\u8cec\u865f\u6a21\u64ec IAM \u670d\u52d9\u8cec\u865f\u3002\u6b64\u7d81\u5b9a\u5141\u8a31 Kubernertes \u670d\u52d9\u8cec\u865f\u5145\u7576 IAM \u670d\u52d9\u8cec\u865f\u3002\n - Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u6fc0\u6d3b Cloud Shell\u3002 [\u6fc0\u6d3b Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn)  [Cloud Shell](https://cloud.google.com/shell/docs/how-cloud-shell-works?hl=zh-cn) \u6703\u8a71\u96a8\u5373\u6703\u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5e95\u90e8\u5553\u52d5\uff0c\u4e26\u986f\u793a\u547d\u4ee4\u884c\u63d0\u793a\u7b26\u3002Cloud Shell \u662f\u4e00\u500b\u5df2\u5b89\u88dd Google Cloud CLI \u4e14\u5df2\u7232\u7576\u524d\u9805\u76ee\u8a2d\u7f6e\u503c\u7684 Shell \u74b0\u5883\u3002\u8a72\u6703\u8a71\u53ef\u80fd\u9700\u8981\u5e7e\u79d2\u9418\u6642\u9593\u4f86\u5b8c\u6210\u521d\u59cb\u5316\u3002\n- \u5728\u958b\u767c\u74b0\u5883\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud iam service-accounts add-iam-policy-binding GSA_NAME@GSA_PROJECT.iam.gserviceaccount.com \\\u00a0 \u00a0 --role roles/iam.workloadIdentityUser \\\u00a0 \u00a0 --member \"serviceAccount:PROJECT_ID.svc.id.goog[NAMESPACE/KSA_NAME]\"\n``` **\u6ce8\u610f** \uff1a\u6b64\u6b65\u9a5f\u9700\u8981\u4f7f\u7528 [\u914d\u7f6e\u9023\u63a5\u5668](https://cloud.google.com/config-connector/docs/overview?hl=zh-cn) \u3002\u6309\u7167 [\u5b89\u88dd\u8aaa\u660e](https://cloud.google.com/config-connector/docs/how-to/install-upgrade-uninstall?hl=zh-cn) \u5728\u60a8\u7684\u96c6\u7fa3\u4e0a\u5b89\u88dd\u914d\u7f6e\u9023\u63a5\u5668\u3002\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/k8s-config-connector/blob/HEAD/config/samples/tutorials/workload-identity/policy-binding.yaml) \n```\napiVersion: iam.cnrm.cloud.google.com/v1beta1kind: IAMPolicymetadata:\u00a0 name: iampolicy-workload-identity-samplespec:\u00a0 resourceRef:\u00a0 \u00a0 apiVersion: iam.cnrm.cloud.google.com/v1beta1\u00a0 \u00a0 kind: IAMServiceAccount\u00a0 \u00a0 name: [GSA_NAME]\u00a0 bindings:\u00a0 \u00a0 - role: roles/iam.workloadIdentityUser\u00a0 \u00a0 \u00a0 members:\u00a0 \u00a0 \u00a0 \u00a0 - serviceAccount:[PROJECT_ID].svc.id.goog[[K8S_NAMESPACE]/[KSA_NAME]]\n```\n\u5982\u9700\u90e8\u7f72\u6b64\u6e05\u55ae\uff0c\u8acb\u5c07\u5b83\u4ee5\n`policy-binding.yaml`\n\u7684\u5f62\u5f0f\u4e0b\u8f09\u5230\u60a8\u7684\u6a5f\u5668\u4e0a\u3002\u5c07\n`GSA_NAME`\n\u3001\n`PROJECT_ID`\n\u3001\n`NAMESPACE`\n\u548c\n`KSA_NAME`\n\u66ff\u63db\u7232\u60a8\u7684\u74b0\u5883\u4e2d\u7684\u503c\uff0c\u7136\u5f8c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\nkubectl apply -f policy-binding.yaml\n```\n- \u4f7f\u7528 IAM \u670d\u52d9\u8cec\u865f\u7684\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\u7232 Kubernetes \u670d\u52d9\u8cec\u865f\u6dfb\u52a0\u8a3b\u89e3\u3002\n - Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u6fc0\u6d3b Cloud Shell\u3002 [\u6fc0\u6d3b Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn)  [Cloud Shell](https://cloud.google.com/shell/docs/how-cloud-shell-works?hl=zh-cn) \u6703\u8a71\u96a8\u5373\u6703\u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5e95\u90e8\u5553\u52d5\uff0c\u4e26\u986f\u793a\u547d\u4ee4\u884c\u63d0\u793a\u7b26\u3002Cloud Shell \u662f\u4e00\u500b\u5df2\u5b89\u88dd Google Cloud CLI \u4e14\u5df2\u7232\u7576\u524d\u9805\u76ee\u8a2d\u7f6e\u503c\u7684 Shell \u74b0\u5883\u3002\u8a72\u6703\u8a71\u53ef\u80fd\u9700\u8981\u5e7e\u79d2\u9418\u6642\u9593\u4f86\u5b8c\u6210\u521d\u59cb\u5316\u3002\n- \u5728\u958b\u767c\u74b0\u5883\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\nkubectl annotate serviceaccount KSA_NAME \\\u00a0 \u00a0 --namespace NAMESPACE \\\u00a0 \u00a0 iam.gke.io/gcp-service-account=GSA_NAME@GSA_PROJECT.iam.gserviceaccount.com\n```\n```\napiVersion: v1kind: ServiceAccountmetadata:\u00a0 annotations:\u00a0 \u00a0 iam.gke.io/gcp-service-account: GSA_NAME@PROJECT_ID.iam.gserviceaccount.com\u00a0 name: KSA_NAME\u00a0 namespace: NAMESPACE\n```\n **\u6ce8\u610f** \uff1a\u6b64\u8a3b\u91cb\u672c\u8eab\u4e0d\u6703\u6388\u4e88\u6a21\u64ec IAM \u670d\u52d9\u8cec\u865f\u7684\u6b0a\u9650\u3002\u5982\u679c IAM \u7d81\u5b9a\u4e0d\u5b58\u5728\uff0c\u5247 Pod \u5c07\u7121\u6cd5\u4f7f\u7528 IAM \u670d\u52d9\u8cec\u865f\u3002\n- \u66f4\u65b0\u60a8\u7684 Pod \u898f\u7bc4\uff0c\u4ee5\u5728\u4f7f\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u7684\u7bc0\u9ede\u4e0a\u5b89\u6392\u5de5\u4f5c\u8ca0\u8f09\u4e26\u4f7f\u7528\u5df2\u6dfb\u52a0\u8a3b\u89e3\u7684 Kubernetes \u670d\u52d9\u8cec\u865f\u3002 **\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u7232\u9ed8\u8a8d\u7684 Kubernetes \u670d\u52d9\u8cec\u865f\u6dfb\u52a0\u4e86\u8a3b\u89e3\uff0c\u8acb\u7701\u7565 `spec.serviceAccountName` \u3002\u5c0d\u65bc Autopilot \u96c6\u7fa3\uff0c\u8acb\u7701\u7565 `nodeSelector` \u5b57\u6bb5\u3002Autopilot \u6703\u62d2\u7d55\u6b64 nodeSelector\uff0c\u56e0\u7232\u6240\u6709\u7bc0\u9ede\u90fd\u4f7f\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002```\nspec:\u00a0 serviceAccountName: KSA_NAME\u00a0 nodeSelector:\u00a0 \u00a0 iam.gke.io/gke-metadata-server-enabled: \"true\"\n```\n- \u5c07\u66f4\u65b0\u5f8c\u7684\u914d\u7f6e\u61c9\u7528\u5230\u96c6\u7fa3\uff1a```\nkubectl apply -f DEPLOYMENT_FILE\n```\u5c07 `` \u66ff\u63db\u7232\u66f4\u65b0\u5f8c\u7684 Pod \u898f\u7bc4\u7684\u8def\u5f91\u3002\n### \u9a57\u8b49\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u8a2d\u7f6e\n\u901a\u904e\u4f7f\u7528\u904b\u884c\u7279\u5b9a\u65bc\u64cd\u4f5c\u7cfb\u7d71\u7684\u5bb9\u5668\u6620\u50cf\u7684 Kubernetes \u670d\u52d9\u8cec\u865f\u5275\u5efa Pod\uff0c\u7136\u5f8c\u901a\u904e\u4ea4\u4e92\u5f0f\u6703\u8a71\u9023\u63a5\u5230\u8a72\u670d\u52d9\u8cec\u865f\uff0c\u9a57\u8b49\u670d\u52d9\u8cec\u865f\u662f\u5426\u914d\u7f6e\u6b63\u78ba\u3002\n\u5275\u5efa\u4f7f\u7528\u8a3b\u89e3\u7684 Kubernetes \u670d\u52d9\u8cec\u865f\u7684 Pod \u4e26 `curl` `service-accounts` \u7aef\u9ede\u3002- \u5c07\u4ee5\u4e0b\u914d\u7f6e\u4fdd\u5b58\u7232 `wi-test.yaml` \uff1a```\napiVersion: v1kind: Podmetadata:\u00a0 name: workload-identity-test\u00a0 namespace: NAMESPACEspec:\u00a0 containers:\u00a0 - image: google/cloud-sdk:slim\u00a0 \u00a0 name: workload-identity-test\u00a0 \u00a0 command: [\"sleep\",\"infinity\"]\u00a0 serviceAccountName: KSA_NAME\u00a0 nodeSelector:\u00a0 \u00a0 iam.gke.io/gke-metadata-server-enabled: \"true\"\n````google/cloud-sdk` \u6620\u50cf\u4e2d\u5305\u542b Google Cloud CLI\uff0c\u9019\u662f\u4f7f\u7528 Google Cloud API \u7684\u4fbf\u6377\u65b9\u5f0f\u3002\u6620\u50cf\u4e0b\u8f09\u53ef\u80fd\u9700\u8981\u4e00\u6bb5\u6642\u9593\u3002 **\u6ce8\u610f** \uff1a\u5c0d\u65bc Autopilot \u96c6\u7fa3\uff0c\u8acb\u7701\u7565 `nodeSelector` \u5b57\u6bb5\u3002Autopilot \u6703\u62d2\u7d55\u6b64 nodeSelector\uff0c\u56e0\u7232\u6240\u6709\u7bc0\u9ede\u90fd\u4f7f\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\n- \u5275\u5efa Pod\uff1a```\nkubectl apply -f wi-test.yaml\n```\n- \u5728 Pod \u4e2d\u6253\u958b\u4ea4\u4e92\u5f0f\u6703\u8a71\uff1a```\nkubectl exec -it workload-identity-test \\\u00a0 --namespace NAMESPACE \\\u00a0 -- /bin/bash\n```\n- \u5728 Pod \u4e2d\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u7372\u53d6\u670d\u52d9\u8cec\u865f\u96fb\u5b50\u90f5\u4ef6\uff1a```\ncurl -H \"Metadata-Flavor: Google\" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email\n```\u5982\u679c\u670d\u52d9\u8cec\u865f\u6b63\u78ba\u914d\u7f6e\uff0c\u5247 IAM \u670d\u52d9\u8cec\u865f\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\u6703\u5217\u7232\u6d3b\u8e8d\uff08\u4e5f\u662f\u552f\u4e00\uff09\u7684\u8eab\u4efd\u3002\u9019\u8868\u660e\u5728\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cPod \u6703\u5728\u8abf\u7528 Google Cloud API \u6642\u5145\u7576 IAM \u670d\u52d9\u8cec\u865f\u7684\u6b0a\u9650\u3002\n- \u5728 Pod \u4e2d\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u7372\u53d6\u4ee4\u724c\uff1a```\ncurl -H \"Metadata-Flavor: Google\" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token\n```\u5982\u679c\u8fd4\u56de\u4efb\u4f55\u932f\u8aa4\uff0c\u8acb\u53c3\u95b1 [\u554f\u984c\u6392\u67e5](#troubleshoot) \n \n\u4f7f\u7528\u904b\u884c `servercore` \u5bb9\u5668\u6620\u50cf\u7684 Kubernetes \u670d\u52d9\u8cec\u865f\u5275\u5efa Pod\u3002- \u4fdd\u5b58\u4ee5\u4e0b\u6e05\u55ae\uff1a```\napiVersion: v1kind: Podmetadata:\u00a0 name: workload-identity-test\u00a0 namespace: NAMESPACEspec:\u00a0 containers:\u00a0 - image: IMAGE_NAME\u00a0 \u00a0 name: workload-identity-test\u00a0 \u00a0 command: [\"powershell.exe\", \"sleep\", \"3600\"]\u00a0 serviceAccountName: KSA_NAME\u00a0 nodeSelector:\u00a0 \u00a0 kubernetes.io/os: windows\u00a0 \u00a0 cloud.google.com/gke-os-distribution: windows_ltsc\u00a0 \u00a0 iam.gke.io/gke-metadata-server-enabled: \"true\"\n```\u5c07 `` \u66ff\u63db\u7232\u4ee5\u4e0b\u5bb9\u5668 servercore \u6620\u50cf\u503c\u4e4b\u4e00\uff1a| Windows Server \u7bc0\u9ede\u6620\u50cf    | \u5bb9\u5668 servercore \u6620\u50cf                                                                                       |\n|:--------------------------------------|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| WINDOWS_LTSC, WINDOWS_LTSC_CONTAINERD | mcr.microsoft.com/windows/servercore:ltsc2019                                                                                |\n| WINDOWS_SAC, WINDOWS_SAC_CONTAINERD | \u8b66\u544a\uff1a2022 \u5e74 8 \u6708 9 \u65e5\u4e4b\u5f8c\u4e0d\u652f\u6301 Windows Server \u534a\u5e74\u6e20\u9053 (SAC) \u6620\u50cf\uff0c\u56e0\u7232 Microsoft \u5c07\u79fb\u9664\u5c0d SAC \u7684\u652f\u6301\u3002\u5982\u9700\u77ad\u89e3\u6f5b\u5728\u7684\u5f71\u97ff\u548c\u9077\u79fb\u8aaa\u660e\uff0c\u8acb\u53c3\u95b1 Windows Server \u534a\u5e74\u6e20\u9053\u670d\u52d9\u7d42\u6b62\u3002 \u6aa2\u67e5 GKE \u7bc0\u9ede\u7248\u672c\u548c Windows SAC \u7248\u672c\u4e4b\u9593\u7684\u7248\u672c\u6620\u5c04\u3002\u5c0d\u65bc Windows Server 1909 \u7248\uff0c\u8acb\u6307\u5b9a mcr.microsoft.com/windows/servercore:1909\uff1b\u5426\u5247\uff0c\u8acb\u6307\u5b9a mcr.microsoft.com/windows/servercore:20H2\u3002 |\n- \u5728 Pod \u4e2d\u6253\u958b\u4ea4\u4e92\u5f0f\u6703\u8a71\uff1a```\nkubectl exec -it workload-identity-test \\\u00a0 --namespace NAMESPACE -- powershell\n```\n- \u5728 Pod \u4e2d\u904b\u884c\u4ee5\u4e0b Powershell \u547d\u4ee4\u4ee5\u7372\u53d6\u670d\u52d9\u8cec\u865f\u96fb\u5b50\u90f5\u4ef6\uff1a```\nInvoke-WebRequest \u00a0-Headers @{\"Metadata-Flavor\"=\"Google\"} -Uri \u00a0http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/email \u00a0-UseBasicParsing\n```\u5982\u679c\u670d\u52d9\u8cec\u865f\u6b63\u78ba\u914d\u7f6e\uff0c\u5247 IAM \u670d\u52d9\u8cec\u865f\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\u6703\u5217\u7232\u6d3b\u8e8d\uff08\u4e5f\u662f\u552f\u4e00\uff09\u7684\u8eab\u4efd\u3002\u9019\u8868\u660e\u5728\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cPod \u6703\u5728\u8abf\u7528 Google Cloud API \u6642\u4f7f\u7528 IAM \u670d\u52d9\u8cec\u865f\u7684\u6b0a\u9650\u3002\n- \u5728 Pod \u4e2d\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u7372\u53d6\u4ee4\u724c\uff1a```\nInvoke-WebRequest \u00a0-Headers @{\"Metadata-Flavor\"=\"Google\"} -Uri \u00a0http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token \u00a0-UseBasicParsing\n```\u5982\u679c\u8fd4\u56de\u4efb\u4f55\u932f\u8aa4\uff0c\u8acb\u53c3\u95b1 [\u554f\u984c\u6392\u67e5](#troubleshoot) \n### \u901a\u904e\u4ee3\u78bc\u4f7f\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\n\u901a\u904e\u4ee3\u78bc\u5411 Google Cloud \u670d\u52d9\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u904e\u7a0b\uff0c\u8207\u4f7f\u7528 [Compute Engine \u5143\u6578\u64da\u670d\u52d9\u5668](https://cloud.google.com/compute/docs/storing-retrieving-metadata?hl=zh-cn) \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u904e\u7a0b\u76f8\u540c\u3002\u4f7f\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u6642\uff0c\u60a8\u5c0d\u5be6\u4f8b\u5143\u6578\u64da\u670d\u52d9\u5668\u767c\u51fa\u7684\u8acb\u6c42\u5c07\u8def\u7531\u5230 [GKE \u5143\u6578\u64da\u670d\u52d9\u5668](https://cloud.google.com/kubernetes-engine/docs/concepts/workload-identity?hl=zh-cn#metadata_server) \u3002 \u4f7f\u7528\u5be6\u4f8b\u5143\u6578\u64da\u670d\u52d9\u5668\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u73fe\u6709\u4ee3\u78bc\uff08\u5982\u4f7f\u7528 [Google Cloud \u5ba2\u6236\u7aef\u5eab](https://cloud.google.com/docs/authentication/client-libraries?hl=zh-cn) \u7684\u4ee3\u78bc\uff09\u5728\u904b\u884c\u6642\u4e0d\u61c9\u9032\u884c\u4efb\u4f55\u4fee\u6539\u3002\n## \u5728\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u4e2d\u4f7f\u7528\u5176\u4ed6\u9805\u76ee\u7684\u914d\u984d\n\u5728\u904b\u884c GKE 1.24 \u7248\u6216\u66f4\u9ad8\u7248\u672c\u7684\u96c6\u7fa3\u4e0a\uff0c\u60a8\u53ef\u4ee5\u5728\u8abf\u7528 [IAM Service Account Credentials API](https://cloud.google.com/iam/docs/reference/credentials/rest?hl=zh-cn#rest-resource:-v1.projects.serviceaccounts) \u4e2d\u7684 `GenerateAccessToken` \u548c `GenerateIdToken` \u65b9\u6cd5\u6642\uff0c\u8996\u9700\u8981\u5c07 Kubernetes \u670d\u52d9\u8cec\u865f\u914d\u7f6e\u7232\u4f7f\u7528\u5176\u4ed6 Google Cloud \u9805\u76ee\u4e2d\u7684\u914d\u984d\u3002\u9019\u6a23\uff0c\u60a8\u5c31\u7121\u9700\u5b8c\u5168\u4f7f\u7528\u4e3b\u9805\u76ee\u4e2d\u7684\u914d\u984d\uff0c\u800c\u662f\u53ef\u4ee5\u7232\u96c6\u7fa3\u4e2d\u7684\u9019\u4e9b\u670d\u52d9\u4f7f\u7528\u5176\u4ed6\u9805\u76ee\u4e2d\u7684\u914d\u984d\u3002\n\u5982\u9700\u914d\u7f6e\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u7684\u914d\u984d\u9805\u76ee \uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u5c07\u914d\u984d\u9805\u76ee\u7684 `serviceusage.services.use` \u6b0a\u9650\u6388\u4e88 Kubernetes \u670d\u52d9\u8cec\u865f\u3002```\ngcloud projects add-iam-policy-binding \\--role=roles/serviceusage.serviceUsageConsumer \\--member=serviceAccount:PROJECT_ID.svc.id.goog[NAMESPACE/KSA_NAME] \\QUOTA_PROJECT_ID\n```\u5c07 `` \u66ff\u63db\u7232\u914d\u984d\u9805\u76ee\u7684 ID\u3002\n- \u4f7f\u7528\u914d\u984d\u9805\u76ee\u7232 Kubernetes \u670d\u52d9\u8cec\u865f\u6dfb\u52a0\u8a3b\u91cb\uff1a```\nkubectl annotate serviceaccount KSA_NAME \\--namespace NAMESPACE \\iam.gke.io/credential-quota-project=QUOTA_PROJECT_ID\n```\n\u5982\u9700\u9a57\u8b49\u914d\u7f6e\u662f\u5426\u751f\u6548\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u6309\u7167 [\u9a57\u8b49\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u8a2d\u7f6e](#verify_the_setup) \u4e2d\u7684\u8aaa\u660e\uff0c\u5275\u5efa\u4e00\u500b Pod \u4e26\u5553\u52d5 shell \u6703\u8a71\u3002\n- \u767c\u51fa\u670d\u52d9\u8cec\u865f\u4ee4\u724c\u8acb\u6c42\uff1a```\ncurl -H \"Metadata-Flavor: Google\" http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token\n```\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u9032\u5165\u914d\u984d\u9805\u76ee\u7684 **IAM Service Accounts Credentials API** \u9801\u9762\uff1a [\u9032\u5165\u201cAPI\u201d](https://console.cloud.google.com/apis/api/iamcredentials.googleapis.com/metrics?hl=zh-cn) \n- \u6aa2\u67e5\u6d41\u91cf\u8b8a\u5316\u60c5\u6cc1\u3002## \u6e05\u7406\n\u5982\u9700\u505c\u6b62\u4f7f\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u8acb\u64a4\u6d88\u5c0d IAM \u670d\u52d9\u8cec\u865f\u7684\u8a2a\u554f\u6b0a\u9650\u4e26\u5728\u96c6\u7fa3\u4e0a\u505c\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\n### \u64a4\u6d88\u8a2a\u554f\u6b0a\u9650\n- \u64a4\u6d88\u5c0d IAM \u670d\u52d9\u8cec\u865f\u7684\u8a2a\u554f\u6b0a\u9650\uff1a\n - Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u6fc0\u6d3b Cloud Shell\u3002 [\u6fc0\u6d3b Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn)  [Cloud Shell](https://cloud.google.com/shell/docs/how-cloud-shell-works?hl=zh-cn) \u6703\u8a71\u96a8\u5373\u6703\u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5e95\u90e8\u5553\u52d5\uff0c\u4e26\u986f\u793a\u547d\u4ee4\u884c\u63d0\u793a\u7b26\u3002Cloud Shell \u662f\u4e00\u500b\u5df2\u5b89\u88dd Google Cloud CLI \u4e14\u5df2\u7232\u7576\u524d\u9805\u76ee\u8a2d\u7f6e\u503c\u7684 Shell \u74b0\u5883\u3002\u8a72\u6703\u8a71\u53ef\u80fd\u9700\u8981\u5e7e\u79d2\u9418\u6642\u9593\u4f86\u5b8c\u6210\u521d\u59cb\u5316\u3002\n- \u5728\u958b\u767c\u74b0\u5883\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud iam service-accounts remove-iam-policy-binding GSA_NAME@GSA_PROJECT.iam.gserviceaccount.com \\\u00a0 \u00a0 --role roles/iam.workloadIdentityUser \\\u00a0 \u00a0 --member \"serviceAccount:PROJECT_ID.svc.id.goog[NAMESPACE/KSA_NAME]\"\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1aGKE \u96c6\u7fa3\u7684\u9805\u76ee ID\u3002\n- ``\uff1a\u60a8\u7684 Kubernetes \u670d\u52d9\u8cec\u865f\u6240\u5728\u7684 Kubernetes \u547d\u540d\u7a7a\u9593\u7684\u540d\u7a31\u3002\n- ``\uff1a\u5c07\u64a4\u6d88\u5176\u8a2a\u554f\u6b0a\u9650\u7684 Kubernetes \u670d\u52d9\u8cec\u865f\u7684\u540d\u7a31\u3002\n- ``\uff1aIAM \u670d\u52d9\u8cec\u865f\u7684\u540d\u7a31\u3002\n- ``\uff1aIAM \u670d\u52d9\u8cec\u865f\u7684\u9805\u76ee ID\u3002\n\u5982\u679c\u60a8\u4f7f\u7528 Config Connector \u5275\u5efa\u670d\u52d9\u8cec\u865f\uff0c\u8acb\u901a\u904e `kubectl` \u522a\u9664\u670d\u52d9\u8cec\u865f\u3002\n```\nkubectl delete -f service-account.yaml\n```\n\u7de9\u5b58\u7684\u4ee4\u724c\u6700\u9577\u53ef\u80fd\u9700\u8981 30 \u5206\u9418\u7e94\u6703\u904e\u671f\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u6b64\u547d\u4ee4\u6aa2\u67e5\u7de9\u5b58\u7684\u4ee4\u724c\u662f\u5426\u5df2\u904e\u671f\uff1a```\ngcloud auth list\n```\u5982\u679c\u6b64\u547d\u4ee4\u7684\u8f38\u51fa\u7d50\u679c\u4e2d\u4e0d\u518d\u5305\u542b `` `@` `` `.iam.gserviceaccount.com` \uff0c\u5247\u8868\u660e\u7de9\u5b58\u7684\u4ee4\u724c\u5df2\u7d93\u904e\u671f\u3002\n- \u5f9e Kubernetes \u670d\u52d9\u8cec\u865f\u4e2d\u79fb\u9664\u8a3b\u91cb\u3002\u9019\u662f\u53ef\u9078\u6b65\u9a5f\uff0c\u56e0\u7232\u8a2a\u554f\u6b0a\u9650\u5df2\u88ab IAM \u64a4\u6d88\u3002```\nkubectl annotate serviceaccount KSA_NAME \\\u00a0 \u00a0 --namespace NAMESPACE iam.gke.io/gcp-service-account``` **\u6ce8\u610f\uff1a** \u5982\u679c\u60a8\u4e0d\u79fb\u9664\u8a3b\u91cb\uff0c\u5247\u7576\u60a8\u904b\u884c `gcloud auth list` \u6642\uff0c\u8207\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u7d50\u5408\u4f7f\u7528\u7684 IAM \u670d\u52d9\u8cec\u865f\u53ef\u80fd\u6703\u7e7c\u7e8c\u986f\u793a\u3002\u4f46\u662f\uff0cGKE \u4e0d\u6703\u4f7f\u7528 IAM \u670d\u52d9\u8cec\u865f\u5411 Google Cloud \u670d\u52d9\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\n### \u505c\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\n\u60a8\u53ea\u80fd\u5728 GKE Standard \u96c6\u7fa3\u4e0a\u505c\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u6fc0\u6d3b Cloud Shell\u3002 [\u6fc0\u6d3b Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn)  [Cloud Shell](https://cloud.google.com/shell/docs/how-cloud-shell-works?hl=zh-cn) \u6703\u8a71\u96a8\u5373\u6703\u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5e95\u90e8\u5553\u52d5\uff0c\u4e26\u986f\u793a\u547d\u4ee4\u884c\u63d0\u793a\u7b26\u3002Cloud Shell \u662f\u4e00\u500b\u5df2\u5b89\u88dd Google Cloud CLI \u4e14\u5df2\u7232\u7576\u524d\u9805\u76ee\u8a2d\u7f6e\u503c\u7684 Shell \u74b0\u5883\u3002\u8a72\u6703\u8a71\u53ef\u80fd\u9700\u8981\u5e7e\u79d2\u9418\u6642\u9593\u4f86\u5b8c\u6210\u521d\u59cb\u5316\u3002\n- \u5728\u6bcf\u500b\u7bc0\u9ede\u6c60\u4e0a\u505c\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff1a```\ngcloud container node-pools update NODEPOOL_NAME \\\u00a0 \u00a0 --cluster=CLUSTER_NAME \\\u00a0 \u00a0 --workload-metadata=GCE_METADATA\n```\u5c0d\u96c6\u7fa3\u4e2d\u7684\u6bcf\u500b\u7bc0\u9ede\u6c60\u91cd\u8907\u6b64\u547d\u4ee4\u3002\n- \u5728\u96c6\u7fa3\u4e2d\u505c\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff1a```\ngcloud container clusters update CLUSTER_NAME \\\u00a0 \u00a0 --disable-workload-identity\n```\n- \u8f49\u5230 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **Google Kubernetes Engine** \u9801\u9762\u3002 [\u8f49\u5230 Google Kubernetes Engine](https://console.cloud.google.com/kubernetes/list?hl=zh-cn) \n- \u5728\u96c6\u7fa3\u5217\u8868\u4e2d\uff0c\u9ede\u64ca\u60a8\u8981\u4fee\u6539\u7684\u96c6\u7fa3\u7684\u540d\u7a31\u3002\n- \u9ede\u64ca **\u7bc0\u9ede** \u6a19\u7c64\u9801\u3002\n- \u5982\u9700\u5728\u6bcf\u500b\u7bc0\u9ede\u6c60\u4e0a\u505c\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u8acb\u5c0d **\u7bc0\u9ede\u6c60** \u90e8\u5206\u4e2d\u7684\u6bcf\u500b\u7bc0\u9ede\u6c60\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u9ede\u64ca\u8981\u4fee\u6539\u7684\u7bc0\u9ede\u6c60\u7684\u540d\u7a31\u3002\n- \u5728 **\u7bc0\u9ede\u6c60\u8a73\u60c5** \u9801\u9762\u4e2d\uff0c\u9ede\u64caedit **\u4fee\u6539** \u3002\n- \u5728 **\u4fee\u6539\u7bc0\u9ede\u6c60** \u9801\u9762\u7684 **\u5b89\u5168** \u90e8\u5206\u4e2d\uff0c\u6e05\u9664 **\u5553\u7528 GKE \u5143\u6578\u64da\u670d\u52d9\u5668** \u8907\u9078\u6846\u3002\n- \u9ede\u64ca **\u4fdd\u5b58** \u3002\n- \u5982\u9700\u7232\u96c6\u7fa3\u505c\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u9ede\u64ca **\u8a73\u60c5** \u6a19\u7c64\u9801\u3002\n- \u5728 **\u5b89\u5168** \u90e8\u5206\u4e2d\uff0c\u9ede\u64ca **Workload Identity** \u65c1\u908a\u7684edit **\u4fee\u6539** \u3002\n- \u5728 **\u4fee\u6539 Workload Identity** \u5c0d\u8a71\u6846\u4e2d\uff0c\u6e05\u9664 **\u5553\u7528 Workload Identity** \u8907\u9078\u6846\u3002\n- \u9ede\u64ca **\u4fdd\u5b58\u66f4\u6539** \u3002\n## \u5728\u7d44\u7e54\u4e2d\u505c\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\n\u5f9e\u5b89\u5168\u89d2\u5ea6\u4f86\u770b\uff0c\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u652f\u6301 GKE \u8072\u660e\u53ef\u5411 Google Cloud \u8cc7\u6e90\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u4e26\u7372\u5f97 Google Cloud \u8cc7\u6e90\u6388\u6b0a\u7684 Kubernetes \u670d\u52d9\u8cec\u865f\u8eab\u4efd\u3002\u5982\u679c\u60a8\u662f\u5df2\u63a1\u53d6\u63aa\u65bd\uff08\u4f8b\u5982 [\u7981\u6b62\u5275\u5efa\u670d\u52d9\u8cec\u865f](https://cloud.google.com/resource-manager/docs/organization-policy/restricting-service-accounts?hl=zh-cn#disable_service_account_creation) \u6216 [\u7981\u6b62\u5275\u5efa\u670d\u52d9\u8cec\u865f\u5bc6\u9470](https://cloud.google.com/resource-manager/docs/organization-policy/restricting-service-accounts?hl=zh-cn#disable_service_account_creation) \uff09\u5c07\u5de5\u4f5c\u8ca0\u8f09\u8207 Google Cloud \u8cc7\u6e90\u9694\u96e2\u7684\u7ba1\u7406\u54e1\uff0c\u53ef\u80fd\u9084\u9700\u8981\u7232\u7d44\u7e54\u505c\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\n\u8acb\u53c3\u95b1 [\u9019\u4e9b\u8aaa\u660e\u4ee5\u77ad\u89e3\u5982\u4f55\u7232\u7d44\u7e54\u505c\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408](https://cloud.google.com/resource-manager/docs/organization-policy/restricting-service-accounts?hl=zh-cn#disable_workload_identity_cluster_creation) \u3002\n## \u554f\u984c\u6392\u67e5\n\u5982\u9700\u77ad\u89e3\u554f\u984c\u6392\u67e5\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 [\u6392\u67e5\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u554f\u984c](https://cloud.google.com/kubernetes-engine/docs/troubleshooting/troubleshooting-security?hl=zh-cn#workload-identity) \u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u8a73\u7d30\u77ad\u89e3 [\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408](https://cloud.google.com/kubernetes-engine/docs/concepts/workload-identity?hl=zh-cn) \u3002\n- \u95b1\u8b80 [GKE \u5b89\u5168\u6982\u89bd](https://cloud.google.com/kubernetes-engine/docs/concepts/security-overview?hl=zh-cn) \u3002\n- \u77ad\u89e3\u5982\u4f55 [\u4fdd\u8b77\u96c6\u7fa3\u5143\u6578\u64da](https://cloud.google.com/kubernetes-engine/docs/how-to/protecting-cluster-metadata?hl=zh-cn) \u3002\n- \u77ad\u89e3 [IAM \u670d\u52d9\u8cec\u865f](https://cloud.google.com/iam/docs/understanding-service-accounts?hl=zh-cn) \u3002", "guide": "Google Kubernetes Engine (GKE)"}