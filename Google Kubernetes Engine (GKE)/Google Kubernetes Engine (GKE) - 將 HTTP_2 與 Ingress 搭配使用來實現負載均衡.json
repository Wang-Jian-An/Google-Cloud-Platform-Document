{"title": "Google Kubernetes Engine (GKE) - \u5c07 HTTP/2 \u8207 Ingress \u642d\u914d\u4f7f\u7528\u4f86\u5be6\u73fe\u8ca0\u8f09\u5747\u8861", "url": "https://cloud.google.com/kubernetes-engine/docs/how-to/ingress-http2?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - \u5c07 HTTP/2 \u8207 Ingress \u642d\u914d\u4f7f\u7528\u4f86\u5be6\u73fe\u8ca0\u8f09\u5747\u8861\n\u672c\u9801\u9762\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528 Kubernetes [Ingress](https://kubernetes.io/docs/concepts/services-networking/ingress/) \u548c [Service](https://kubernetes.io/docs/concepts/services-networking/service/) \u5c0d\u8c61\u914d\u7f6e\u5916\u90e8\u61c9\u7528\u8ca0\u8f09\u5747\u8861\u5668\uff0c\u4ee5\u4f7f\u7528 [HTTP/2](https://http2.github.io/) \u8207\u5f8c\u7aef\u670d\u52d9\u9032\u884c\u901a\u4fe1\u3002\n", "content": "## \u6982\u89bd\n\u61c9\u7528\u8ca0\u8f09\u5747\u8861\u5668\u5145\u7576\u60a8\u7684\u5ba2\u6236\u7aef\u548c\u61c9\u7528\u4e4b\u9593\u7684\u4ee3\u7406\u3002\u5ba2\u6236\u7aef\u53ef\u4ee5\u4f7f\u7528 HTTP/1.1 \u6216 HTTP/2 \u8207\u8ca0\u8f09\u5747\u8861\u5668\u4ee3\u7406\u9032\u884c\u901a\u4fe1\u3002\u4f46\u662f\uff0c\u5f9e\u8ca0\u8f09\u5747\u8861\u5668\u4ee3\u7406\u5230\u61c9\u7528\u7684\u9023\u63a5\u9ed8\u8a8d\u4f7f\u7528 HTTP/1.1\u3002\u5982\u679c\u5728 Google Kubernetes Engine (GKE) Pod \u4e2d\u904b\u884c\u7684\u61c9\u7528\u80fd\u5920\u63a5\u6536 HTTP/2 \u8acb\u6c42\uff0c\u5247\u53ef\u4ee5\u5c07\u5916\u90e8\u8ca0\u8f09\u5747\u8861\u5668\u914d\u7f6e\u7232\u5728\u56ae\u61c9\u7528\u8f49\u767c\u8acb\u6c42\u6642\u4f7f\u7528 HTTP/2\u3002\n\u5728\u672c\u7df4\u7fd2\u4e2d\uff0c\u60a8\u5c07\u5275\u5efa Deployment\u3001Service \u548c Ingress\u3002\u60a8\u5728 Service \u6e05\u55ae\u4e2d\u6dfb\u52a0\u4e86\u4e00\u500b `cloud.google.com/app-protocols` \u8a3b\u91cb\uff0c\u6307\u5b9a\u8ca0\u8f09\u5747\u8861\u5668\u61c9\u4f7f\u7528 HTTP/2 \u8207\u60a8\u7684\u61c9\u7528\u9032\u884c\u901a\u4fe1\u3002 \u7136\u5f8c\uff0c\u8abf\u7528\u670d\u52d9\u4e26\u9a57\u8b49\u61c9\u7528\u5df2\u6536\u5230 HTTP/2 \u8acb\u6c42\u3002\n## \u6e96\u5099\u5de5\u4f5c\n\u5728\u958b\u59cb\u4e4b\u524d\uff0c\u8acb\u78ba\u4fdd\u60a8\u5df2\u57f7\u884c\u4ee5\u4e0b\u4efb\u52d9\uff1a\n- \u5553\u7528 Google Kubernetes Engine API\u3002\n- [  \u5553\u7528 Google Kubernetes Engine API ](https://console.cloud.google.com/flows/enableapi?apiid=container.googleapis.com&hl=zh-cn) \n- \u5982\u679c\u60a8\u8981\u4f7f\u7528 Google Cloud CLI \u57f7\u884c\u6b64\u4efb\u52d9\uff0c\u8acb [\u5b89\u88dd](https://cloud.google.com/sdk/docs/install?hl=zh-cn) \u4e26 [\u521d\u59cb\u5316](https://cloud.google.com/sdk/docs/initializing?hl=zh-cn) gcloud CLI\u3002 \u5982\u679c\u60a8\u4e4b\u524d\u5b89\u88dd\u4e86 gcloud CLI\uff0c\u8acb\u904b\u884c`gcloud components update`\u4ee5\u7372\u53d6\u6700\u65b0\u7248\u672c\u3002 **\u6ce8\u610f** \uff1a\u5c0d\u65bc\u73fe\u6709 gcloud CLI \u5b89\u88dd\uff0c\u8acb\u52d9\u5fc5\u8a2d\u7f6e`compute/region`\u548c`compute/zone` [\u5c6c\u6027](https://cloud.google.com/sdk/docs/properties?hl=zh-cn#setting_properties) \u3002\u901a\u904e\u8a2d\u7f6e\u9ed8\u8a8d\u4f4d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u907f\u514d gcloud CLI \u4e2d\u51fa\u73fe\u4ee5\u4e0b\u932f\u8aa4\uff1a`One of [--zone, --region] must be supplied: Please specify location`\u3002\n- \u77ad\u89e3 Kubernetes [Ingress](https://kubernetes.io/docs/concepts/services-networking/ingress/) \u548c [Service](https://kubernetes.io/docs/concepts/services-networking/service/) \u8cc7\u6e90\u3002\n- \u77ad\u89e3 [\u5916\u90e8\u61c9\u7528\u8ca0\u8f09\u5747\u8861\u5668\u7684 HTTP/2 \u9650\u5236](https://cloud.google.com/load-balancing/docs/https?hl=zh-cn#HTTP2-limitations) \u3002## \u5275\u5efa Deployment\n- \u5c07\u4ee5\u4e0b\u6e05\u55ae\u8907\u88fd\u5230\u540d\u7232 `my-deployment.yaml` \u7684\u6587\u4ef6\u4e2d\uff1a```\napiVersion: apps/v1kind: Deploymentmetadata:\u00a0 name: echoheadersspec:\u00a0 replicas: 2\u00a0 selector:\u00a0 \u00a0 matchLabels:\u00a0 \u00a0 \u00a0 app: echoheaders\u00a0 template:\u00a0 \u00a0 metadata:\u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 app: echoheaders\u00a0 \u00a0 spec:\u00a0 \u00a0 \u00a0 containers:\u00a0 \u00a0 \u00a0 - name: echoheaders\u00a0 \u00a0 \u00a0 \u00a0 image: registry.k8s.io/echoserver:1.10\u00a0 \u00a0 \u00a0 \u00a0 ports:\u00a0 \u00a0 \u00a0 \u00a0 - containerPort: 8443\n```\u6b64\u6e05\u55ae\u63cf\u8ff0\u4e86\u4e00\u500b\u5177\u6709 `echoheaders` Web \u61c9\u7528\u7684\u5169\u500b\u526f\u672c\u7684 Deployment\u3002\n- \u5c07\u6e05\u55ae\u61c9\u7528\u5230\u60a8\u7684\u96c6\u7fa3\uff1a```\nkubectl apply -f my-deployment.yaml\n```\n**\u6ce8\u610f\uff1a** \u7232\u4e86\u78ba\u4fdd\u8ca0\u8f09\u5747\u8861\u5668\u53ef\u4ee5\u5411\u5f8c\u7aef\u767c\u51fa\u6b63\u78ba\u7684 HTTP2 \u8acb\u6c42\uff0c\u5f8c\u7aef\u5fc5\u9808\u901a\u904e SSL \u9032\u884c\u914d\u7f6e\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u63a5\u53d7\u7684\u8b49\u66f8\u985e\u578b\uff0c\u8acb\u53c3\u95b1 [\u5f9e\u8ca0\u8f09\u5747\u8861\u5668\u5230\u5f8c\u7aef\u7684\u52a0\u5bc6](https://cloud.google.com/load-balancing/docs/ssl-certificates?hl=zh-cn#backend-encryption) \u3002\n## \u5275\u5efa Service\n- \u5c07\u4ee5\u4e0b\u6e05\u55ae\u8907\u88fd\u5230\u540d\u7232 `my-service.yaml` \u7684\u6587\u4ef6\u4e2d\uff1a```\napiVersion: v1kind: Servicemetadata:\u00a0 annotations:\u00a0 \u00a0 cloud.google.com/app-protocols: '{\"my-port\":\"HTTP2\"}'\u00a0 name: echoheaders\u00a0 labels:\u00a0 \u00a0 app: echoheadersspec:\u00a0 type: NodePort\u00a0 ports:\u00a0 - port: 443\u00a0 \u00a0 targetPort: 8443\u00a0 \u00a0 protocol: TCP\u00a0 \u00a0 name: my-port\u00a0 selector:\u00a0 \u00a0 app: echoheaders\n```\u6b64\u6e05\u55ae\u63cf\u8ff0\u4e86\u5177\u6709\u4ee5\u4e0b\u5c6c\u6027\u7684 Service\uff1a- `type: NodePort`\uff1a\u6307\u5b9a\u9019\u662f [NodePort](https://kubernetes.io/docs/concepts/services-networking/service/#publishing-services-service-types) \u985e\u578b\u7684 Service\u3002\n- `app: echoheaders`\uff1a\u6307\u5b9a\u5177\u6709\u6b64\u6a19\u7c64\u7684\u4efb\u4f55 Pod \u90fd\u662f Service \u7684\u6210\u54e1\u3002\n- `cloud.google.com/app-protocols`\uff1a\u6307\u5b9a`my-port`\u61c9\u4f7f\u7528 HTTP/2 \u5354\u8b70\u3002\n- `port: 443`\u3001`protocol: TCP`\u548c`targetPort: 8433`\uff1a\u6307\u5b9a\u5b9a\u5411\u5230 TCP \u7aef\u53e3 443 \u4e0a\u7684 Service \u7684\u6d41\u91cf\u61c9\u8def\u7531\u5230\u5176\u4e2d\u4e00\u500b\u6210\u54e1 Pod \u4e0a\u7684 TCP \u7aef\u53e3 8422\u3002\n- \u5c07\u6e05\u55ae\u61c9\u7528\u5230\u60a8\u7684\u96c6\u7fa3\uff1a```\nkubectl apply -f my-service.yaml\n```\n- \u67e5\u770b Service\uff1a```\nkubectl get service echoheaders --output yaml\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\napiVersion: v1\nkind: Service\nmetadata:\n annotations:\n cloud.google.com/app-protocols: '{\"my-port\":\"HTTP2\"}'\n ...\n labels:\n app: echoheaders\n name: echoheaders\n ...\nspec:\n clusterIP: 10.39.251.148\n ...\n ports:\n - name: my-port\n nodePort: 30647\n port: 443\n protocol: TCP\n targetPort: 8443\n selector:\n app: echoheaders\n ...\n type: NodePort\n...\n```## \u5275\u5efa Ingress\n- \u5c07\u4ee5\u4e0b\u6e05\u55ae\u8907\u88fd\u5230\u540d\u7232 `my-ingress.yaml` \u7684\u6587\u4ef6\u4e2d\uff1a```\napiVersion: networking.k8s.io/v1kind: Ingressmetadata:\u00a0 name: echomapspec:\u00a0 defaultBackend:\u00a0 \u00a0 service:\u00a0 \u00a0 \u00a0 name: echoheaders\u00a0 \u00a0 \u00a0 port:\u00a0 \u00a0 \u00a0 \u00a0 number: 443\n```\u6b64\u6e05\u55ae\u63cf\u8ff0\u4e86\u4e00\u500b Ingress\uff0c\u6307\u5b9a\u50b3\u5165\u8acb\u6c42\u6703\u767c\u9001\u5230 `echoheaders` Service \u7684\u6210\u54e1 Pod\u3002\u8acb\u6c42\u6703\u8def\u7531\u5230\u5728 `echoheaders` Service \u6e05\u55ae\u4e2d\u6307\u5b9a\u7684 `targetPort` \u4e0a\u7684 Pod\u3002\u5728\u672c\u7df4\u7fd2\u4e2d\uff0cPod `targetPort` \u7232 `8443` \u3002\n- \u5c07\u6e05\u55ae\u61c9\u7528\u5230\u60a8\u7684\u96c6\u7fa3\uff1a```\nkubectl apply -f my-ingress.yaml\n```Kubernetes Ingress \u63a7\u5236\u5668\u914d\u7f6e\u61c9\u7528\u8ca0\u8f09\u5747\u8861\u5668\u6642\uff0c\u6b64\u547d\u4ee4\u53ef\u80fd\u9700\u8981\u5e7e\u5206\u9418\u624d\u80fd\u5b8c\u6210\u3002\n- \u67e5\u770b Ingress\uff1a```\nkubectl get ingress echomap --output yaml\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nkind: Ingress\nmetadata:\n ...\n name: echomap\n ...\nspec:\n backend:\n serviceName: echoheaders\n servicePort: 443\nstatus:\n loadBalancer:\n ingress:\n - ip: 203.0.113.2\n```\u5728\u6b64\u8f38\u51fa\u4e2d\uff0cIngress \u7684 IP \u5730\u5740\u7232 `203.0.113.2` \u3002## \u6e2c\u8a66\u8ca0\u8f09\u5747\u8861\u5668\n- \u5217\u51fa\u60a8\u7684\u5f8c\u7aef\u670d\u52d9\uff1a```\ngcloud compute backend-services list\n```\n- \u63cf\u8ff0\u60a8\u7684\u5f8c\u7aef\u670d\u52d9\uff1a```\ngcloud beta compute backend-services describe BACKEND_SERVICE_NAME --global\n```\u5c07 `` \u66ff\u63db\u7232\u60a8\u7684\u5f8c\u7aef\u670d\u52d9\u7684\u540d\u7a31\u3002\u8f38\u51fa\u6307\u5b9a `protocol` \u7232 `HTTP2` \uff1a```\nbackends:\n...\ndescription: '{...,\"kubernetes.io/service-port\":\"443\",\"x-features\":[\"HTTP2\"]}'\n...\nkind: compute#backendService\nloadBalancingScheme: EXTERNAL\nprotocol: HTTP2\n...\n```\n- \u9032\u5165 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **\u8ca0\u8f09\u5747\u8861** \u9801\u9762\u3002 [\u9032\u5165\u201c\u8ca0\u8f09\u5747\u8861\u201d](https://console.cloud.google.com/networking/loadbalancing/loadBalancers/list?hl=zh-cn) \n- \u5728 **\u540d\u7a31** \u4e0b\uff0c\u627e\u5230\u60a8\u7684\u8ca0\u8f09\u5747\u8861\u5668\u3002\n- \u9ede\u64ca\u8ca0\u8f09\u5747\u8861\u5668\u7684\u540d\u7a31\u4ee5\u67e5\u770b\u5f8c\u7aef\u670d\u52d9\u3002\n- \u9a57\u8b49\u5f8c\u7aef\u670d\u52d9\u7684 **\u7aef\u9ede\u5354\u8b70** \u662f\u5426\u7232 **HTTP/2** \u3002## \u8abf\u7528 Service\n\u7b49\u5f85\u5e7e\u5206\u9418\uff0c\u8b93 GKE \u914d\u7f6e\u8ca0\u8f09\u5747\u8861\u5668\u548c\u5f8c\u7aef\u670d\u52d9\uff0c\u7136\u5f8c\u5728\u700f\u89bd\u5668\u7684\u5730\u5740\u6b04\u4e2d\u8f38\u5165\u8ca0\u8f09\u5747\u8861\u5668\u7684\u5916\u90e8 IP \u5730\u5740\u3002\n\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a\n```\nHostname: echoheaders-7886d5bc68-xnrwj\n...\nRequest Information:\n ...\n method=GET\n real path=/\n query=\n request_version=2\n request_scheme=https\n ...\nRequest Headers:\n ...\n x-forwarded-for=[YOUR_IP_ADDRESS], 203.0.113.2\n x-forwarded-proto=http\n...\n```\n\u6b64\u8f38\u51fa\u6709\u95dc\u5f9e\u8ca0\u8f09\u5747\u8861\u5668\u5230 Pod \u7684\u8acb\u6c42\u7684\u4fe1\u606f\uff1a\n- `request_version=2`\uff1a\u8868\u793a\u8ca0\u8f09\u5747\u8861\u5668\u8207 Pod \u4e4b\u9593\u7684\u8acb\u6c42\u4f7f\u7528\u4e86 HTTP/2\u3002\n- `x-forwarded-proto=http`\uff1a\u8868\u793a\u700f\u89bd\u5668\u8207\u8ca0\u8f09\u5747\u8861\u5668\u4e4b\u9593\u7684\u8acb\u6c42\u4f7f\u7528\u4e86 HTTP 1.1\uff0c\u800c\u4e0d\u662f HTTP/2\u3002## \u5f8c\u7e8c\u6b65\u9a5f\n- [\u4f7f\u7528 Ingress \u8a2d\u7f6e\u5916\u90e8\u61c9\u7528\u8ca0\u8f09\u5747\u8861\u5668](https://cloud.google.com/kubernetes-engine/docs/tutorials/http-balancer?hl=zh-cn) \u3002\n- \u4f7f\u7528 Ingress \u7232\u61c9\u7528\u914d\u7f6e [\u975c\u614b IP \u5730\u5740\u548c\u57df\u540d](https://cloud.google.com/kubernetes-engine/docs/tutorials/configuring-domain-name-static-ip?hl=zh-cn) \u3002\n- \u7232 Ingress \u8ca0\u8f09\u5747\u8861\u5668\u914d\u7f6e [SSL \u8b49\u66f8](https://cloud.google.com/kubernetes-engine/docs/how-to/ingress-multi-ssl?hl=zh-cn) \u3002", "guide": "Google Kubernetes Engine (GKE)"}