{"title": "Google Kubernetes Engine (GKE) - \u4f7f\u7528 Filestore Multishares for GKE \u512a\u5316\u5b58\u5132\u7a7a\u9593\u3002", "url": "https://cloud.google.com/kubernetes-engine/docs/tutorials/optimize-multishares?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - \u4f7f\u7528 Filestore Multishares for GKE \u512a\u5316\u5b58\u5132\u7a7a\u9593\u3002\n\u672c\u6307\u5357\u4ecb\u7d39\u5982\u4f55\u5c07 Filestore Multishares for Google Kubernetes Engine \u8207 GKE Filestore CSI \u9a45\u52d5\u7a0b\u5e8f\u642d\u914d\u4f7f\u7528\u3002\n", "content": "## \u9808\u77e5\u4e8b\u9805\n- \u5728\u958b\u59cb\u4e4b\u524d\uff0c\u8acb\u5b8c\u6210\u4f7f\u7528 Filestore \u6240\u9700\u7684 [\u8a2d\u7f6e\u6b65\u9a5f](https://cloud.google.com/filestore/docs/install?hl=zh-cn) \u3002\n- \u5553\u7528 [GKE Filestore CSI \u9a45\u52d5\u7a0b\u5e8f](https://cloud.google.com/kubernetes-engine/docs/how-to/persistent-volumes/filestore-csi-driver?hl=zh-cn) 1.23 \u7248\u6216\u66f4\u9ad8\u7248\u672c\uff1a- \u9a45\u52d5\u7a0b\u5e8f 1.23 \u81f3 1.26 \u7248\u652f\u6301\u6bcf\u500b\u5be6\u4f8b\u6700\u591a 10 \u500b\u5171\u4eab\u3002\n- \u9a45\u52d5\u7a0b\u5e8f 1.27 \u7248\u6216\u66f4\u9ad8\u7248\u672c\u652f\u6301\u6bcf\u500b\u5be6\u4f8b\u6700\u591a 80 \u500b\u5171\u4eab\u3002\n## \u5c07 Filestore Multishares \u8207\u591a\u500b\u61c9\u7528\u642d\u914d\u4f7f\u7528\n\u672c\u90e8\u5206\u4ecb\u7d39\u5982\u4f55\u90e8\u7f72\u5169\u500b\u61c9\u7528\uff0c\u5373\u4e00\u500b [Deployment](https://cloud.google.com/kubernetes-engine/docs/concepts/deployment?hl=zh-cn) \u548c\u4e00\u500b [Statefulset](https://cloud.google.com/kubernetes-engine/docs/concepts/statefulset?hl=zh-cn) \uff0c\u6bcf\u500b\u61c9\u7528\u90fd\u4f7f\u7528 Filestore Multishares [StorageClass](https://kubernetes.io/docs/concepts/storage/storage-classes/) \u3002\u60a8\u9084\u5c07\u77ad\u89e3 GKE \u5982\u4f55 [\u5c01\u88dd](https://cloud.google.com/blog/products/containers-kubernetes/gke-best-practices-to-lessen-over-provisioning?hl=zh-cn) \uff08\u4e00\u500b\u9ad8\u6548\u5730\u5c07\u61c9\u7528\u6253\u5305\u5230 GKE \u7bc0\u9ede\u7684\u904e\u7a0b\uff09\u540c\u4e00\u5e95\u5c64 Filestore Enterprise \u5be6\u4f8b\u4e2d\u7684\u6240\u6709\u5377\u3002\n- \u4f7f\u7528 GKE \u63d0\u4f9b\u7684 StorageClass `enterprise-multishare-rwx` \u5275\u5efa\u6700\u591a\u652f\u6301 10 \u500b\u5171\u4eab\u7684\u5be6\u4f8b\u3002- \u5982\u679c\u8981\u5275\u5efa\u6700\u591a\u652f\u6301 80 \u500b\u5171\u4eab\u7684\u5be6\u4f8b\uff0c\u60a8\u9700\u8981 [\u5275\u5efa\u81ea\u5b9a\u7fa9 StorageClass](#create_a_custom_storageclass) \u3002\u5728\u672c\u6307\u5357\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528\u5177\u6709\u6bcf\u500b\u5be6\u4f8b 10 \u500b\u5171\u4eab\u9650\u5236\u7684 StorageClass\u3002\n\u5553\u7528 GKE Filestore CSI \u9a45\u52d5\u7a0b\u5e8f\u5f8c\uff0c\u7528\u6236\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u914d\u7f6e\u8a2a\u554f GKE \u63d0\u4f9b\u7684\u591a\u5171\u4eab StorageClass `enterprise-multishare-rwx` \u3002\u901a\u904e\u5f15\u7528\u6b64 StorageClass\uff0cGKE Filestore CSI \u9a45\u52d5\u7a0b\u5e8f\u53ef\u4f7f\u7528 [\u52d5\u614b\u5377\u9810\u914d](https://kubernetes.io/docs/concepts/storage/dynamic-provisioning/) \u81ea\u52d5\u7232\u65b0\u7684\u6c38\u4e45\u6027\u5377\u8072\u660e (PVC) \u5275\u5efa\u6c38\u4e45\u6027\u5377 (PV) \u4ee5\u6eff\u8db3\u4ee5\u4e0b GKE \u5de5\u4f5c\u8ca0\u8f09\u9700\u6c42\uff1a```\nkubectl describe sc enterprise-multishare-rwxName: \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0enterprise-multishare-rwxIsDefaultClass: \u00a0 \u00a0 \u00a0 \u00a0NoAnnotations: \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 components.gke.io/component-name=filestorecsi,components.gke.io/component-version=0.7.2,components.gke.io/layer=addonProvisioner: \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 filestore.csi.storage.gke.ioParameters: \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0instance-storageclass-label=enterprise-multishare-rwx,multishare=true,tier=enterpriseAllowVolumeExpansion: \u00a0TrueMountOptions: \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<none>ReclaimPolicy: \u00a0 \u00a0 \u00a0 \u00a0 DeleteVolumeBindingMode: \u00a0 \u00a0 WaitForFirstConsumerEvents: \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0<none>\n```\n### \u5275\u5efa\u81ea\u5b9a\u7fa9 StorageClass\n\u5982\u679c\u60a8\u60f3\u8981\u5229\u7528\u6bcf\u500b Filestore \u5be6\u4f8b\u7684\u6700\u65b0\u5bb9\u91cf\u9650\u5236\uff08\u6700\u591a 80 \u500b\u5171\u4eab\uff09\uff0c\u8acb\u6839\u64da\u4ee5\u4e0b\u6a21\u677f\u5275\u5efa\u81ea\u5b9a\u7fa9 StorageClass\uff1a\n```\n\u00a0 apiVersion: storage.k8s.io/v1\u00a0 kind: StorageClass\u00a0 metadata:\u00a0 \u00a0 name: csi-filestore-multishare-128\u00a0 provisioner: filestore.csi.storage.gke.io\u00a0 parameters:\u00a0 \u00a0 tier: enterprise\u00a0 \u00a0 multishare: \"true\"\u00a0 \u00a0 max-volume-size: \"128Gi\"\u00a0 \u00a0 network: default\u00a0 allowVolumeExpansion: true\n```\n\u91cd\u547d\u540d StorageClass \u6642\uff0c\u8acb\u8003\u616e\u4ee5\u4e0b\u8981\u6c42\uff1a\n- StorageClass \u540d\u7a31\u5fc5\u9808\u662f\u6709\u6548\u7684 [DNS \u5b50\u57df\u540d](https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#dns-subdomain-names) \u3002\n- \u591a\u5171\u4eab StorageClass \u540d\u7a31\u4e5f\u7528\u4f5c\u5be6\u4f8b\u6a19\u7c64\uff0c\u61c9\u9075\u5faa [\u6a19\u7c64\u547d\u540d\u6e96\u5247](https://cloud.google.com/filestore/docs/managing-labels?hl=zh-cn) \u3002\n- \u5982\u679c\u60a8\u7684\u61c9\u7528\u9700\u8981\u7acb\u5373\u9810\u914d\u5377\uff0c\u8acb\u5305\u542b `Immediate` \u5377\u7d81\u5b9a\u6a21\u5f0f\uff1a`volumeBindingMode: Immediate`\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u4e0d\u5e0c\u671b\u5377\u9810\u914d\u4f9d\u8cf4\u65bc GKE \u96c6\u7fa3\u4e2d\u7684 Pod \u5275\u5efa\uff0c\u8acb\u4f7f\u7528\u6b64\u898f\u7bc4\u3002\n- \u5f9e\u9a45\u52d5\u7a0b\u5e8f 1.27 \u7248\u958b\u59cb\uff0c\u5982\u679c\u8981\u7232\u6bcf\u500b\u5be6\u4f8b\u5206\u914d\u8d85\u904e 10 \u500b\u5171\u4eab\uff0c\u8acb\u5305\u542b `max-volume-size` \u53c3\u6578\u4f75\u7232\u5176\u5206\u914d\u7b2c\u4e00\u5217\u4e2d\u63a5\u53d7\u7684\u503c\u4e4b\u4e00\uff1a| \u5377\u5927\u5c0f\u4e0a\u9650\uff08\u5171\u4eab\u5927\u5c0f\uff09 | \u6bcf\u500b\u5be6\u4f8b\u7684\u5171\u4eab\u6578\u4e0a\u9650 |\n|:-------------------------|-----------------------:|\n| 128\u00a0GiB     |      80 |\n| 256\u00a0GiB     |      40 |\n| 512\u00a0GiB     |      20 |\n| 1024\u00a0GiB     |      10 |\u4f8b\u5982\uff0c\u6dfb\u52a0\u9375\u503c\u5c0d `max-volume-size: \"128Gi\"` \u53ef\u78ba\u4fdd StorageClass \u6700\u591a\u5c07 80 \u500b\u5171\u4eab\uff08\u6bcf\u500b\u7bc4\u570d\u5f9e 10\u00a0GiB \u5230 128\u00a0GiB\uff09\u6620\u5c04\u5230\u55ae\u500b 10\u00a0TiB \u4f01\u696d\u5c64\u7d1a\u5be6\u4f8b\u3002- \u6b64\u529f\u80fd\u5411\u5f8c\u517c\u5bb9 GKE Filestore CSI \u9a45\u52d5\u7a0b\u5e8f 1.23 \u81f3 1.26 \u7248\u5275\u5efa\u7684 Filestore \u5be6\u4f8b\u3002\n- \u73fe\u6709\u5be6\u4f8b\u53ef\u4ee5\u5275\u5efa\u65b0\u7684 PVC \u6216\u5171\u4eab\uff0c\u64f4\u5c55\u7684\u6700\u5c0f\u5171\u4eab\u5927\u5c0f\u7232 10\u00a0GiB\u3002\n- GKE Filestore CSI \u9a45\u52d5\u7a0b\u5e8f 1.27 \u7248\u53ef\u8b58\u5225\u820a\u7248\u4f01\u696d\u5be6\u4f8b\uff0c\u4f75\u7232\u5176\u5206\u914d\u9ed8\u8a8d\u7684\u6700\u5927\u5171\u4eab\u5927\u5c0f 1024\u00a0GiB (1\u00a0TiB)\u3002\u56e0\u6b64\uff0c\u820a\u5be6\u4f8b\u7684\u6700\u5927\u5171\u4eab\u6578\u9650\u5236\u7232\u6bcf\u500b\u5be6\u4f8b 10 \u500b\u5171\u4eab\u3002\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [Filestore Multishares for GKE](https://cloud.google.com/filestore/docs/multishares?hl=zh-cn) \u3002\n- \u4f7f\u7528\u55ae\u500b PVC \u5275\u5efa\u5177\u6709\u591a\u500b pod \u526f\u672c\u7684 Deployment\u3002\u5275\u5efa\u4e00\u500b\u985e\u4f3c\u5982\u4e0b\u6240\u793a\u7684 YAML \u914d\u7f6e\u6587\u4ef6\uff1a```\ncat <<EOF | kubectl apply -f -apiVersion: apps/v1kind: Deploymentmetadata:\u00a0 name: web-server-multishare\u00a0 labels:\u00a0 \u00a0 app: nginxspec:\u00a0 replicas: 5\u00a0 selector:\u00a0 \u00a0 matchLabels:\u00a0 \u00a0 \u00a0 app: nginx\u00a0 template:\u00a0 \u00a0 metadata:\u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 app: nginx\u00a0 \u00a0 spec:\u00a0 \u00a0 \u00a0 containers:\u00a0 \u00a0 \u00a0 - name: nginx\u00a0 \u00a0 \u00a0 \u00a0 image: nginx\u00a0 \u00a0 \u00a0 \u00a0 volumeMounts:\u00a0 \u00a0 \u00a0 \u00a0 - mountPath: /usr/share/nginx/html\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 name: mypvc\u00a0 \u00a0 \u00a0 volumes:\u00a0 \u00a0 \u00a0 - name: mypvc\u00a0 \u00a0 \u00a0 \u00a0 persistentVolumeClaim:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 claimName: test-pvc-fs---kind: PersistentVolumeClaimapiVersion: v1metadata:\u00a0 name: test-pvc-fsspec:\u00a0 accessModes:\u00a0 \u00a0 - ReadWriteMany\u00a0 storageClassName: enterprise-multishare-rwx\u00a0 resources:\u00a0 \u00a0 requests:\u00a0 \u00a0 \u00a0 storage: 100GiEOF\n```\n- \u6aa2\u67e5 Pod \u526f\u672c\u3002a. \u5f9e\u547d\u4ee4\u884c\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u6aa2\u67e5 PVC \u72c0\u614b\uff1a```\nkubectl get pvc\n```\u60a8\u61c9\u8a72\u6703\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u97ff\u61c9\u7684\u5167\u5bb9\uff1a```\nNAME \u00a0 \u00a0 \u00a0 \u00a0 \u00a0STATUS \u00a0 VOLUME \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 CAPACITY \u00a0 ACCESS MODES \u00a0 STORAGECLASS \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 AGEtest-pvc-fs \u00a0 Bound \u00a0 \u00a0pvc-056d769d-a709-4bb2-b6d3-0361871b27a2 \u00a0 100Gi \u00a0 \u00a0 \u00a0RWX \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0enterprise-multishare-rwx \u00a035m\n```b. \u5f9e\u547d\u4ee4\u884c\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u6aa2\u67e5 pod \u72c0\u614b\uff1a```\nkubectl get pod\n```\u60a8\u61c9\u8a72\u6703\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u97ff\u61c9\u7684\u5167\u5bb9\uff1a```\nNAME \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 READY \u00a0 STATUS \u00a0 \u00a0RESTARTS \u00a0 AGEweb-server-multishare-76c9ffb4b5-2dhml \u00a0 1/1 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a035mweb-server-multishare-76c9ffb4b5-7mtcb \u00a0 1/1 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a035mweb-server-multishare-76c9ffb4b5-csdbd \u00a0 1/1 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a035mweb-server-multishare-76c9ffb4b5-rgx82 \u00a0 1/1 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a035mweb-server-multishare-76c9ffb4b5-zjl27 \u00a0 1/1 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a035m\n```\n- \u64f4\u7e2e\u526f\u672c\u3002a. \u5f9e\u547d\u4ee4\u884c\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u4fee\u6539 Deployment\uff1a```\nkubectl edit deployment web-server-multishare\n```b. \u6587\u4ef6\u5c07\u5728\u547d\u4ee4\u884c\u4e2d\u6253\u958b\u3002\u627e\u5230 `spec.replicas` \u5b57\u6bb5\uff0c\u4e26\u5c07\u503c\u66f4\u65b0\u7232 `10` \u3002c. \u5f9e\u547d\u4ee4\u884c\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u67e5\u770b\u61c9\u7528\u7684\u66f4\u6539\uff1a```\nkubectl get pod\n```\u60a8\u61c9\u8a72\u6703\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u97ff\u61c9\u7684\u5167\u5bb9\uff1a```\nNAME \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 READY \u00a0 STATUS \u00a0 \u00a0RESTARTS \u00a0 AGEweb-server-multishare-76c9ffb4b5-2dhml \u00a0 1/1 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a036mweb-server-multishare-76c9ffb4b5-5ctkf \u00a0 1/1 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a03sweb-server-multishare-76c9ffb4b5-7mtcb \u00a0 1/1 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a036mweb-server-multishare-76c9ffb4b5-8dwmw \u00a0 1/1 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a02sweb-server-multishare-76c9ffb4b5-csdbd \u00a0 1/1 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a036mweb-server-multishare-76c9ffb4b5-lndcq \u00a0 1/1 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a02sweb-server-multishare-76c9ffb4b5-rgx82 \u00a0 1/1 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a036mweb-server-multishare-76c9ffb4b5-vtd6p \u00a0 1/1 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a03sweb-server-multishare-76c9ffb4b5-xm49s \u00a0 1/1 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a03sweb-server-multishare-76c9ffb4b5-zjl27 \u00a0 1/1 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a036m\n```\u8acb\u6ce8\u610f\uff0c\u6709 10 \u500b pod \u6b63\u5728\u904b\u884c\u3002d. \u5f9e\u547d\u4ee4\u884c\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\nkubectl get deployment\n```\u60a8\u61c9\u8a72\u6703\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u97ff\u61c9\u7684\u5167\u5bb9\uff1a```\nNAME \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0READY \u00a0 UP-TO-DATE \u00a0 AVAILABLE \u00a0 AGEweb-server-multishare \u00a0 10/10 \u00a0 10 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 10 \u00a0 \u00a0 \u00a0 \u00a0 \u00a036m\n```e\u3002 \u5f9e\u547d\u4ee4\u884c\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u6aa2\u67e5 PVC \u7d81\u5b9a\u72c0\u614b\uff1a```\nkubectl get pvc\n```\u60a8\u61c9\u8a72\u6703\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u97ff\u61c9\u7684\u5167\u5bb9\uff1a```\nNAME \u00a0 \u00a0 \u00a0 \u00a0 \u00a0STATUS \u00a0 VOLUME \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 CAPACITY \u00a0 ACCESS MODES \u00a0 STORAGECLASS \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 AGEtest-pvc-fs \u00a0 Bound \u00a0 \u00a0pvc-056d769d-a709-4bb2-b6d3-0361871b27a2 \u00a0 100Gi \u00a0 \u00a0 \u00a0RWX \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0enterprise-multishare-rwx \u00a037m\n```f. \u5f9e\u547d\u4ee4\u884c\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u4fee\u6539 Deployment\uff1a```\nkubectl edit deployment web-server-multishare\n```g.\u6587\u4ef6\u5c07\u5728\u547d\u4ee4\u884c\u4e2d\u6253\u958b\u3002\u627e\u5230 `spec.replicas` \u5b57\u6bb5\uff0c\u4e26\u5c07\u503c\u66f4\u65b0\u7232 `2` \u3002h.\u5f9e\u547d\u4ee4\u884c\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u67e5\u770b\u61c9\u7528\u7684\u66f4\u6539\uff1a```\nkubectl get pod\n```\u60a8\u61c9\u8a72\u6703\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u97ff\u61c9\u7684\u5167\u5bb9\uff1a```\nNAME \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 READY \u00a0 STATUS \u00a0 \u00a0RESTARTS \u00a0 AGEweb-server-multishare-76c9ffb4b5-2dhml \u00a0 1/1 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a038mweb-server-multishare-76c9ffb4b5-7mtcb \u00a0 1/1 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a038m\n```\n- \u90e8\u7f72 Statefulset\u3002\u90e8\u7f72\u5171\u4eab\u5e95\u5c64 Filestore \u5be6\u4f8b\u7684\u7b2c\u4e8c\u500b\u61c9\u7528\u3002\u7232\u6b64\uff0c\u8acb\u9810\u914d 200 GiB \u7684\u7a7a\u9593\uff0c\u4e26\u9a57\u8b49\u8a72\u7a7a\u9593\u4f7f\u7528\u8207\u7b2c\u4e00\u500b\u61c9\u7528\u76f8\u540c\u7684\u5e95\u5c64 Filestore \u5be6\u4f8b\u3002\u7136\u5f8c\uff0c\u4f7f\u7528\u7e3d\u5171 900 GiB \u5c07\u61c9\u7528\u64f4\u5bb9\u5230\u4e5d\u500b\u526f\u672c\uff089 \u526f\u672c\u5404\u4f7f\u7528 100 GiB\uff09\uff0c\u4e26\u9a57\u8b49 GKE \u662f\u5426\u4f7f\u7528\u5171\u4eab\u5be6\u4f8b\u7684\u76f8\u540c Filestore \u5be6\u4f8b\u3002\u5275\u5efa\u4e00\u500b\u985e\u4f3c\u5982\u4e0b\u6240\u793a\u7684 YAML \u914d\u7f6e\u6587\u4ef6\uff1a```\ncat <<EOF | kubectl apply -f -apiVersion: apps/v1kind: StatefulSetmetadata:\u00a0 name: webspec:\u00a0 serviceName: \"nginx\"\u00a0 replicas: 2\u00a0 selector:\u00a0 \u00a0 matchLabels:\u00a0 \u00a0 \u00a0 app: nginx\u00a0 template:\u00a0 \u00a0 metadata:\u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 app: nginx\u00a0 \u00a0 spec:\u00a0 \u00a0 \u00a0 containers:\u00a0 \u00a0 \u00a0 - name: nginx\u00a0 \u00a0 \u00a0 \u00a0 image: registry.k8s.io/nginx-slim:0.8\u00a0 \u00a0 \u00a0 \u00a0 ports:\u00a0 \u00a0 \u00a0 \u00a0 - containerPort: 80\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 name: web\u00a0 \u00a0 \u00a0 \u00a0 volumeMounts:\u00a0 \u00a0 \u00a0 \u00a0 - name: test-pvc-multishare\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 mountPath: /usr/share/nginx/html\u00a0 volumeClaimTemplates:\u00a0 - metadata:\u00a0 \u00a0 \u00a0 name: test-pvc-multishare\u00a0 \u00a0 spec:\u00a0 \u00a0 \u00a0 accessModes: [ \"ReadWriteMany\" ]\u00a0 \u00a0 \u00a0 storageClassName: enterprise-multishare-rwx\u00a0 \u00a0 \u00a0 resources:\u00a0 \u00a0 \u00a0 \u00a0 requests:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 storage: 100GiEOF\n```\n- \u6aa2\u67e5 Statefulset \u526f\u672c\u548c\u5377\u3002\u5f9e\u547d\u4ee4\u884c\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\nkubectl get pod\n```\u60a8\u61c9\u8a72\u6703\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u97ff\u61c9\u7684\u5167\u5bb9\uff1a```\nNAME \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 READY \u00a0 STATUS \u00a0 \u00a0RESTARTS \u00a0 AGEweb-0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a01/1 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a04m48sweb-1 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a01/1 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a03m32sweb-server-multishare-76c9ffb4b5-2dhml \u00a0 1/1 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a057mweb-server-multishare-76c9ffb4b5-7mtcb \u00a0 1/1 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a057m\n```\u8acb\u6ce8\u610f\uff0c\u524d\u5169\u500b pod \u8207 Statefulset \u76f8\u95dc\u806f\u3002\u6700\u5f8c\u5169\u500b pod \u8207 Deployment \u76f8\u95dc\u806f\u3002\u5f9e\u547d\u4ee4\u884c\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\nkubectl get statefulset\n```\u60a8\u61c9\u8a72\u6703\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u97ff\u61c9\u7684\u5167\u5bb9\uff1a```\nNAME \u00a0 READY \u00a0 AGEweb \u00a0 \u00a02/2 \u00a0 \u00a0 2m8s\n```\u5f9e\u547d\u4ee4\u884c\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\nkubectl get pvc\n```\u60a8\u61c9\u8a72\u6703\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u97ff\u61c9\u7684\u5167\u5bb9\uff1a```\nNAME \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0STATUS \u00a0 VOLUME \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 CAPACITY \u00a0 ACCESS MODES \u00a0 STORAGECLASS \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 AGEtest-pvc-fs \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Bound \u00a0 \u00a0pvc-056d769d-a709-4bb2-b6d3-0361871b27a2 \u00a0 100Gi \u00a0 \u00a0 \u00a0RWX \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0enterprise-multishare-rwx \u00a0 54mtest-pvc-multishare-web-0 \u00a0 Bound \u00a0 \u00a0pvc-7aa21b5a-5343-4547-b7d7-414c16af15a7 \u00a0 100Gi \u00a0 \u00a0 \u00a0RWX \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0enterprise-multishare-rwx \u00a0 114stest-pvc-multishare-web-1 \u00a0 Bound \u00a0 \u00a0pvc-8b37cd6e-d764-4d38-80d7-d74228536cfe \u00a0 100Gi \u00a0 \u00a0 \u00a0RWX \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0enterprise-multishare-rwx \u00a0 38s\n```PVC `test-pvc-fs` \u8207 Deployment `web-server-multishare` \u76f8\u95dc\u806f\u3002PVC `test-pvc-multishare-web-0` \u548c `test-pvc-multishare-web-1` \u8207 Statefulset \u76f8\u95dc\u806f\u3002\n- \u64f4\u7e2e Statefulset \u526f\u672c\u3002\u5c07\u526f\u672c\u6578\u91cf\u589e\u52a0\u5230\u4e5d\u500b\u3002\u96a8\u7740\u6578\u91cf\u589e\u52a0\uff0c\u7cfb\u7d71\u6703\u5275\u5efa\u76f8\u61c9\u7684 PVC\u3002a. \u5f9e\u547d\u4ee4\u884c\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\nkubectl \u00a0edit statefulset web\n```b. \u6587\u4ef6\u5c07\u5728\u547d\u4ee4\u884c\u4e2d\u6253\u958b\u3002\u627e\u5230 `spec.replicas` \u5b57\u6bb5\uff0c\u4e26\u5c07\u503c\u66f4\u65b0\u7232 `9` \u3002c. \u5f9e\u547d\u4ee4\u884c\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u67e5\u770b\u61c9\u7528\u7684\u66f4\u6539\uff1a```\nkubectl get statefulset\n```\u60a8\u61c9\u8a72\u6703\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u97ff\u61c9\u7684\u5167\u5bb9\uff1a```\nNAME \u00a0 READY \u00a0 AGEweb \u00a0 \u00a09/9 \u00a0 \u00a0 13m\n```d. \u5f9e\u547d\u4ee4\u884c\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\nkubectl get deployment\n```\u60a8\u61c9\u8a72\u6703\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u97ff\u61c9\u7684\u5167\u5bb9\uff1a```\nNAME \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0READY \u00a0 UP-TO-DATE \u00a0 AVAILABLE \u00a0 AGEweb-server-multishare \u00a0 2/2 \u00a0 \u00a0 2 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a02 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 65m\n```e\u3002 \u5f9e\u547d\u4ee4\u884c\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\nkubectl get pvc\n```\u60a8\u61c9\u8a72\u6703\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u97ff\u61c9\u7684\u5167\u5bb9\uff1a```\nNAME \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0STATUS \u00a0 VOLUME \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 CAPACITY \u00a0 ACCESS MODES \u00a0 STORAGECLASS \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 AGEtest-pvc-fs \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Bound \u00a0 \u00a0pvc-056d769d-a709-4bb2-b6d3-0361871b27a2 \u00a0 100Gi \u00a0 \u00a0 \u00a0RWX \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0enterprise-multishare-rwx \u00a0 65mtest-pvc-multishare-web-0 \u00a0 Bound \u00a0 \u00a0pvc-7aa21b5a-5343-4547-b7d7-414c16af15a7 \u00a0 100Gi \u00a0 \u00a0 \u00a0RWX \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0enterprise-multishare-rwx \u00a0 13mtest-pvc-multishare-web-1 \u00a0 Bound \u00a0 \u00a0pvc-8b37cd6e-d764-4d38-80d7-d74228536cfe \u00a0 100Gi \u00a0 \u00a0 \u00a0RWX \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0enterprise-multishare-rwx \u00a0 12mtest-pvc-multishare-web-2 \u00a0 Bound \u00a0 \u00a0pvc-3fcbd132-939f-4364-807a-7c8ac6a3e64e \u00a0 100Gi \u00a0 \u00a0 \u00a0RWX \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0enterprise-multishare-rwx \u00a0 5m12stest-pvc-multishare-web-3 \u00a0 Bound \u00a0 \u00a0pvc-5894afa5-2502-4ee7-9d5c-b7378cb85479 \u00a0 100Gi \u00a0 \u00a0 \u00a0RWX \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0enterprise-multishare-rwx \u00a0 4m57stest-pvc-multishare-web-4 \u00a0 Bound \u00a0 \u00a0pvc-ebbe452b-bc8f-4624-a830-a2094cce0d67 \u00a0 100Gi \u00a0 \u00a0 \u00a0RWX \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0enterprise-multishare-rwx \u00a0 4m36stest-pvc-multishare-web-5 \u00a0 Bound \u00a0 \u00a0pvc-5a73a698-d174-44cb-a3a1-e767966c3417 \u00a0 100Gi \u00a0 \u00a0 \u00a0RWX \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0enterprise-multishare-rwx \u00a0 4m20stest-pvc-multishare-web-6 \u00a0 Bound \u00a0 \u00a0pvc-102da6a9-2ca6-4f9e-9896-8fe14709db7a \u00a0 100Gi \u00a0 \u00a0 \u00a0RWX \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0enterprise-multishare-rwx \u00a0 3m55stest-pvc-multishare-web-7 \u00a0 Bound \u00a0 \u00a0pvc-160e81cd-c5bf-4ae6-966e-518e8249e02d \u00a0 100Gi \u00a0 \u00a0 \u00a0RWX \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0enterprise-multishare-rwx \u00a0 3m38stest-pvc-multishare-web-8 \u00a0 Bound \u00a0 \u00a0pvc-9b52d773-2e9a-40de-881c-dc06945ba3d7 \u00a0 100Gi \u00a0 \u00a0 \u00a0RWX \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0enterprise-multishare-rwx \u00a0 118s\n```\n- \u9a57\u8b49 Filestore \u5be6\u4f8b\u72c0\u614b\u3002\u60a8\u73fe\u5728\u6709\u4e00\u500b\u5177\u6709\u5169\u500b\u526f\u672c pod \u7684 Deployment\u3001\u4e00\u500b\u5177\u6709\u4e5d\u500b\u526f\u672c pod \u7684 Statefulset\uff0c\u4ee5\u53ca\u7e3d\u5171 10 \u500b PVC\uff0c\u6bcf\u500b PVC \u5927\u5c0f\u7232 100 GiB\u3002\u6240\u6709\u5377\u90fd\u6253\u5305\u5230\u55ae\u500b Filestore Multishare \u5be6\u4f8b\u4e0a\u3002a. \u5f9e\u547d\u4ee4\u884c\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b [instances list](https://cloud.google.com/sdk/gcloud/reference/beta/filestore/instances/list?hl=zh-cn) \u547d\u4ee4\uff1a```\ngcloud beta filestore instances list --project=YOUR_PROJECT_ID --region=REGION\n```\u5176\u4e2d\uff1a- \u662f\u6240\u4f7f\u7528\u7684 [\u9805\u76ee](https://cloud.google.com/filestore/docs/install?hl=zh-cn) \u7684\u540d\u7a31\u3002\u4f8b\u5982 `my-project` \u3002\n- \u662f\u6240\u4f7f\u7528\u7684 [\u5340\u57df](https://cloud.google.com/filestore/docs/regions?hl=zh-cn) \u7684\u540d\u7a31\u3002\u4f8b\u5982 `us-central1` \u3002\n\u60a8\u61c9\u8a72\u6703\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u97ff\u61c9\u7684\u5167\u5bb9\uff1a```\nINSTANCE_NAME \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0LOCATION \u00a0 \u00a0 TIER \u00a0 \u00a0 \u00a0 \u00a0CAPACITY_GB \u00a0FILE_SHARE_NAME \u00a0IP_ADDRESS \u00a0 STATE \u00a0CREATE_TIMEfs-a767cef8-738e-4c8e-b70b-09cbb872d016 \u00a0us-central1 \u00a0ENTERPRISE \u00a01024 \u00a0 \u00a0 \u00a0 \u00a0 N/A \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a010.192.53.2 \u00a0READY \u00a02022-06-21T21:15:30\n```b. \u5f9e\u547d\u4ee4\u884c\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b [instances describe](https://cloud.google.com/sdk/gcloud/reference/beta/filestore/instances/describe?hl=zh-cn) \u547d\u4ee4\uff1a```\ngcloud filestore instances describe fs-a767cef8-738e-4c8e-b70b-09cbb872d016 --project=YOUR_PROJECT_ID --region=REGIONcapacityGb: '1024'capacityStepSizeGb: '256'createTime: '2022-06-21T21:15:30.464237089Z'labels:\u00a0 storage_gke_io_created-by: filestore_csi_storage_gke_io\u00a0 storage_gke_io_storage-class-id: enterprise-multishare-rwxmaxCapacityGb: '10240'maxShareCount: '10'multiShareEnabled: truename: projects/YOUR_PROJECT_ID/locations/REGION/instances/fs-a767cef8-738e-4c8e-b70b-09cbb872d016networks:- connectMode: DIRECT_PEERING\u00a0 ipAddresses:\u00a0 - 10.192.53.2\u00a0 modes:\u00a0 - MODE_IPV4\u00a0 network: csi-filestore-test-network\u00a0 reservedIpRange: 10.192.53.0/26state: READYtier: ENTERPRISE\n```\u5176\u4e2d\uff1a- \u662f\u6240\u4f7f\u7528\u7684 [\u9805\u76ee](https://cloud.google.com/filestore/docs/install?hl=zh-cn) \u7684\u540d\u7a31\u3002\u4f8b\u5982 `my-project` \u3002\n- \u662f\u6240\u4f7f\u7528\u7684 [\u5340\u57df](https://cloud.google.com/filestore/docs/regions?hl=zh-cn) \u7684\u540d\u7a31\u3002\u4f8b\u5982 `us-central1` \u3002\n## \u64f4\u5c55 PVC \u4e26\u9a57\u8b49 Filestore \u5be6\u4f8b\n\u672c\u90e8\u5206\u4ecb\u7d39\u5982\u4f55\u64f4\u5c55\u73fe\u6709 PVC \u4e26\u9a57\u8b49 Filestore \u5be6\u4f8b\u7684\u5927\u5c0f\u3002\n- \u64f4\u5c55 PVC\u3002\u7531 Filestore Multishare \u5be6\u4f8b\u4e2d\u7684\u5171\u4eab\u63d0\u4f9b\u652f\u6301\u7684 PVC \u53ef\u4ee5\u589e\u52a0\u5230 [max-volume-size](#create_a_custom_storageclass) \u53c3\u6578\u4e2d\u6307\u5b9a\u7684\u5927\u5c0f\u4e0a\u9650\u3002\u5982\u9700\u5c0d\u6b64\u9032\u884c\u9a57\u8b49\uff0c\u8acb\u5728 Pod \u4f7f\u7528 Statefulset \u6642\u64f4\u5c55\u8207 Statefulset \u95dc\u806f\u7684\u5176\u4e2d\u4e00\u500b\u5377\u3002\u5f9e\u547d\u4ee4\u884c\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u6aa2\u67e5\u526f\u672c 0 \u7684\u7576\u524d PVC \u5927\u5c0f\uff1a```\nkubectl get pvc test-pvc-multishare-web-0 -o json{\u00a0 \u00a0 \"apiVersion\": \"v1\",\u00a0 \u00a0 \"kind\": \"PersistentVolumeClaim\",\u00a0 \u00a0 \"metadata\": {\u00a0 \u00a0 \u00a0 \u00a0 \"annotations\": {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"pv.kubernetes.io/bind-completed\": \"yes\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"pv.kubernetes.io/bound-by-controller\": \"yes\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"volume.beta.kubernetes.io/storage-provisioner\": \"filestore.csi.storage.gke.io\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"volume.kubernetes.io/storage-provisioner\": \"filestore.csi.storage.gke.io\"\u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 \"creationTimestamp\": \"2022-06-21T22:07:42Z\",\u00a0 \u00a0 \u00a0 \u00a0 \"finalizers\": [\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"kubernetes.io/pvc-protection\"\u00a0 \u00a0 \u00a0 \u00a0 ],\u00a0 \u00a0 \u00a0 \u00a0 \"labels\": {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"app\": \"nginx\"\u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 \"name\": \"test-pvc-multishare-web-0\",\u00a0 \u00a0 \u00a0 \u00a0 \"namespace\": \"default\",\u00a0 \u00a0 \u00a0 \u00a0 \"resourceVersion\": \"48395\",\u00a0 \u00a0 \u00a0 \u00a0 \"uid\": \"7aa21b5a-5343-4547-b7d7-414c16af15a7\"\u00a0 \u00a0 },\u00a0 \u00a0 \"spec\": {\u00a0 \u00a0 \u00a0 \u00a0 \"accessModes\": [\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"ReadWriteMany\"\u00a0 \u00a0 \u00a0 \u00a0 ],\u00a0 \u00a0 \u00a0 \u00a0 \"resources\": {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"requests\": {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"storage\": \"100Gi\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 \"storageClassName\": \"enterprise-multishare-rwx\",\u00a0 \u00a0 \u00a0 \u00a0 \"volumeMode\": \"Filesystem\",\u00a0 \u00a0 \u00a0 \u00a0 \"volumeName\": \"pvc-7aa21b5a-5343-4547-b7d7-414c16af15a7\"\u00a0 \u00a0 },\u00a0 \u00a0 \"status\": {\u00a0 \u00a0 \u00a0 \u00a0 \"accessModes\": [\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"ReadWriteMany\"\u00a0 \u00a0 \u00a0 \u00a0 ],\u00a0 \u00a0 \u00a0 \u00a0 \"capacity\": {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"storage\": \"100Gi\"\u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 \"phase\": \"Bound\"\u00a0 \u00a0 }}\n```\n- \u5f9e\u547d\u4ee4\u884c\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u5c07\u5927\u5c0f\u589e\u52a0\u5230 500 GiB\uff1a```\nkubectl edit pvc test-pvc-multishare-web-0\n```\n- \u6587\u4ef6\u5c07\u5728\u547d\u4ee4\u884c\u4e2d\u6253\u958b\u3002\u627e\u5230 `spec.resources.requests.storage` \u5b57\u6bb5\uff0c\u4e26\u5c07\u503c\u66f4\u65b0\u7232 `500Gi` \u3002\n- \u5f9e\u547d\u4ee4\u884c\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u67e5\u770b\u61c9\u7528\u7684\u66f4\u6539\uff1a```\nkubectl get pvc test-pvc-multishare-web-0\n```\u60a8\u61c9\u8a72\u6703\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u97ff\u61c9\u7684\u5167\u5bb9\uff1a```\nNAME \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0STATUS \u00a0 VOLUME \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 CAPACITY \u00a0 ACCESS MODES \u00a0 STORAGECLASS \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 AGEtest-pvc-multishare-web-0 \u00a0 Bound \u00a0 \u00a0pvc-7aa21b5a-5343-4547-b7d7-414c16af15a7 \u00a0 500Gi \u00a0 \u00a0 \u00a0RWX \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0enterprise-multishare-rwx \u00a0 28m\n```Filestore CSI \u9a45\u52d5\u7a0b\u5e8f\u63a5\u53d7\u8acb\u6c42\uff0c\u9996\u5148\u64f4\u5c55\u5e95\u5c64 Filestore \u5be6\u4f8b\uff0c\u7136\u5f8c\u64f4\u5c55\u7232 PVC \u63d0\u4f9b\u652f\u6301\u7684\u5171\u4eab\u3002\u5177\u9ad4\u4f86\u8aaa\uff0cFilestore CSI \u9a45\u52d5\u7a0b\u5e8f\u6703\u81ea\u52d5\u5c07\u5be6\u4f8b\u64f4\u5c55\u5230 1536 Gi\uff0c\u4ee5\u9069\u61c9 500Gi \u7684\u65b0\u5171\u4eab\u5927\u5c0f\u3002\n- \u5f9e\u547d\u4ee4\u884c\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5 [instances describe](https://cloud.google.com/sdk/gcloud/reference/beta/filestore/instances/describe?hl=zh-cn) \u547d\u4ee4\u4f86\u9a57\u8b49 Filestore \u5be6\u4f8b\u7684\u5bb9\u91cf\uff1a```\ngcloud filestore instances describe fs-a767cef8-738e-4c8e-b70b-09cbb872d016 --project=YOUR_PROJECT_ID --region=REGIONcapacityGb: '1536'capacityStepSizeGb: '256'createTime: '2022-06-21T21:15:30.464237089Z'labels:\u00a0 storage_gke_io_created-by: filestore_csi_storage_gke_io\u00a0 storage_gke_io_storage-class-id: enterprise-multishare-rwxmaxCapacityGb: '10240'maxShareCount: '10'multiShareEnabled: truename: projects/YOUR_PROJECT_ID/locations/us-central1/instances/fs-a767cef8-738e-4c8e-b70b-09cbb872d016networks:- connectMode: DIRECT_PEERING\u00a0 ipAddresses:\u00a0 - 10.192.53.2\u00a0 modes:\u00a0 - MODE_IPV4\u00a0 network: csi-filestore-test-network\u00a0 reservedIpRange: 10.192.53.0/26state: READYtier: ENTERPRISE\n```\u5176\u4e2d\uff1a- \u662f\u6240\u4f7f\u7528\u7684 [\u9805\u76ee](https://cloud.google.com/filestore/docs/install?hl=zh-cn) \u7684\u540d\u7a31\u3002\u4f8b\u5982 `my-project` \u3002\n- \u662f\u6240\u4f7f\u7528\u7684 [\u5340\u57df](https://cloud.google.com/filestore/docs/regions?hl=zh-cn) \u7684\u540d\u7a31\u3002\u4f8b\u5982 `us-central1` \u3002\n## \u5728\u5171\u4eab VPC \u4e0a\u52d5\u614b\u9810\u914d\nGKE \u7684 Filestore CSI \u9a45\u52d5\u7a0b\u5e8f\u652f\u6301\u5728\u5171\u4eab VPC \u4e0b\u7684\u670d\u52d9\u9805\u76ee\u4e2d [\u52d5\u614b\u9810\u914d](https://kubernetes.io/docs/concepts/storage/dynamic-provisioning/) \u5377\u3002\u4ee5\u4e0b\u90e8\u5206\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528 Filestore CSI \u9a45\u52d5\u7a0b\u5e8f\u5728\u5171\u4eab VPC \u7db2\u7d61\u4e0b\u7684\u670d\u52d9\u9805\u76ee\u4e2d\u7684 Filestore Multishare \u5be6\u4f8b\u4e0a\u52d5\u614b\u9810\u914d\u5377\u3002\n- \u5b8c\u6210\u5171\u4eab VPC \u7db2\u7d61\u548c\u5c08\u7528\u670d\u52d9\u8a2a\u554f\u901a\u9053\u7684 [\u8a2d\u7f6e\u6b65\u9a5f](https://cloud.google.com/kubernetes-engine/docs/how-to/persistent-volumes/filestore-csi-xpn?hl=zh-cn) \u3002\n- \u5275\u5efa StorageClass\uff0c\u4ee5\u5728\u5171\u4eab VPC \u4e0a\u52d5\u614b\u9810\u914d\u7531 Filestore Multishares \u5be6\u4f8b\u63d0\u4f9b\u652f\u6301\u7684\u5377\u3002\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u90e8\u7f72 `StorageClass` \u8cc7\u6e90\uff1a```\ncat <<EOF | kubectl apply -f -apiVersion: storage.k8s.io/v1kind: StorageClassmetadata:\u00a0 name: csi-filestore-multishare-sharedvpcprovisioner: filestore.csi.storage.gke.ioparameters:\u00a0 network: \"projects/HOST_PROJECT_ID/global/networks/SHARED_VPC_NAME\"\u00a0 connect-mode: PRIVATE_SERVICE_ACCESS\u00a0 tier: enterprise\u00a0 multishare: \"true\"allowVolumeExpansion: trueEOF\n```\u5176\u4e2d\uff1a- \u662f\u5171\u4eab VPC \u7db2\u7d61\u7684\u5bbf\u4e3b [\u9805\u76ee](https://cloud.google.com/filestore/docs/install?hl=zh-cn) \u7684 ID \u6216\u540d\u7a31\u3002\u4f8b\u5982 `my-host-project` \u3002\n- \u662f [\u5171\u4eab VPC \u7db2\u7d61](https://cloud.google.com/vpc/docs/shared-vpc?hl=zh-cn) \u7684\u540d\u7a31\u3002\u4f8b\u5982 `my-shared-vpc` \u3002\n\u5982\u679c\u8981\u5728\u9810\u7559\u7684 IP \u5730\u5740\u7bc4\u570d\u5167\u90e8\u7f72\u8cc7\u6e90\uff0c\u8acb\u5c07\u4ee5\u4e0b\u884c\u6dfb\u52a0\u5230\u547d\u4ee4\u4e2d\u4f7f\u7528\u7684\u53c3\u6578\u4e2d\uff1a```\nreserved-ip-range: RESERVED_NAME\n```\u5176\u4e2d \u662f\u53ef\u4ee5\u5728\u5176\u4e2d\u9810\u914d Filestore \u5be6\u4f8b\u7684\u9810\u7559 IP \u5730\u5740\u7bc4\u570d\u7684\u540d\u7a31\u3002\u4f8b\u5982 `filestore-reserved-ip-range` \u3002\u5982\u679c\u6307\u5b9a\u4e86\u9810\u7559\u7684 IP \u7bc4\u570d\uff0c\u5247\u8a72\u7bc4\u570d\u5fc5\u9808\u662f\u5df2\u547d\u540d\u7684\u5730\u5740\u7bc4\u570d\uff0c\u800c\u975e\u76f4\u63a5 CIDR \u503c\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5206\u914d IP \u5730\u5740\u7bc4\u570d](https://cloud.google.com/vpc/docs/configure-private-services-access?hl=zh-cn#allocating-range) \u6216 [\u914d\u7f6e\u9810\u7559\u7684 IP \u5730\u5740\u7bc4\u570d](https://cloud.google.com/filestore/docs/creating-instances?hl=zh-cn#configuring_a_reserved_ip_address_range) \u3002\u5982\u9700\u67e5\u770b\u5982\u4f55\u4f7f\u7528 Google Cloud \u63a7\u5236\u6aaf\u5275\u5efa\u9810\u7559\u540d\u7a31\u7684\u793a\u4f8b\uff0c\u8acb\u53c3\u95b1 [\u5275\u5efa IP \u5206\u914d](https://cloud.google.com/vpc/docs/configure-private-services-access?hl=zh-cn#procedure) \u3002\n- \u5275\u5efa Deployment\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u5275\u5efa `Deployment` \u8cc7\u6e90\uff1a```\ncat <<EOF | kubectl apply -f -apiVersion: apps/v1kind: Deploymentmetadata:\u00a0 name: web-server-multishare\u00a0 labels:\u00a0 \u00a0 app: nginxspec:\u00a0 replicas: 5\u00a0 selector:\u00a0 \u00a0 matchLabels:\u00a0 \u00a0 \u00a0 app: nginx\u00a0 template:\u00a0 \u00a0 metadata:\u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 app: nginx\u00a0 \u00a0 spec:\u00a0 \u00a0 \u00a0 containers:\u00a0 \u00a0 \u00a0 - name: nginx\u00a0 \u00a0 \u00a0 \u00a0 image: nginx\u00a0 \u00a0 \u00a0 \u00a0 volumeMounts:\u00a0 \u00a0 \u00a0 \u00a0 - mountPath: /usr/share/nginx/html\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 name: mypvc\u00a0 \u00a0 \u00a0 volumes:\u00a0 \u00a0 \u00a0 - name: mypvc\u00a0 \u00a0 \u00a0 \u00a0 persistentVolumeClaim:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 claimName: test-pvc-fs-sharedvpc---kind: PersistentVolumeClaimapiVersion: v1metadata:\u00a0 name: test-pvc-fs-sharedvpcspec:\u00a0 accessModes:\u00a0 \u00a0 - ReadWriteMany\u00a0 storageClassName: csi-filestore-multishare-sharedvpc\u00a0 resources:\u00a0 \u00a0 requests:\u00a0 \u00a0 \u00a0 storage: 100GiEOF\n```## \u5553\u7528\u4e86 CMEK \u7684 Filestore \u5be6\u4f8b\n\u60a8\u53ef\u4ee5\u5275\u5efa\u8a17\u7ba1\u5728\u5553\u7528\u4e86 CMEK \u7684 Filestore Multishare \u5be6\u4f8b\u4e0a\u7684 GKE \u5377\u3002\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u77ad\u89e3\u5982\u4f55 [\u7232 Filestore \u5be6\u4f8b\u8a2d\u7f6e\u5ba2\u6236\u7ba1\u7406\u7684\u52a0\u5bc6\u5bc6\u9470 (CMEK)](https://cloud.google.com/filestore/docs/cmek?hl=zh-cn) \u3002\n\u60a8\u53ef\u4ee5\u5728 StorageClass \u4e2d\u63d0\u4f9b\u5ba2\u6236\u7ba1\u7406\u7684\u5bc6\u9470\u8a73\u7d30\u4fe1\u606f\u3002\u7531 Filestore CSI \u9a45\u52d5\u7a0b\u5e8f\u52d5\u614b\u5f15\u7528\u7684\u4efb\u4f55\u5be6\u4f8b\uff08\u5b83\u6703\u5f15\u7528\u6b64 StorageClass\uff09\u90fd\u5c07\u5553\u7528 CMEK\u3002\n- \u5275\u5efa\u5553\u7528 CMEK \u7684 StorageClass\u3002a. \u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ncat <<EOF | kubectl apply -f -apiVersion: storage.k8s.io/v1kind: StorageClassmetadata:\u00a0 name: csi-filestore-multishare-cmekprovisioner: filestore.csi.storage.gke.ioparameters:\u00a0 tier: enterprise\u00a0 multishare: \"true\"\u00a0 instance-encryption-kms-key: projects/KEY_PROJECT_ID/locations/REGION/keyRings/RING_NAME/cryptoKeys/KEY_NAMEallowVolumeExpansion: trueEOF\n```\u5176\u4e2d\uff1a- \u662f\u5bc6\u9470\u6240\u5728\u7684 [\u9805\u76ee](https://cloud.google.com/filestore/docs/install?hl=zh-cn) \u7684\u540d\u7a31\u3002\u4f8b\u5982 `my-key-project` \u3002\n- \u662f\u6240\u4f7f\u7528\u7684 [\u5340\u57df](https://cloud.google.com/filestore/docs/regions?hl=zh-cn) \u7684\u540d\u7a31\u3002\u4f8b\u5982 `us-central1` \u3002\n- \u662f\u5bc6\u9470\u74b0\u540d\u7a31\u3002\u4f8b\u5982 `my-key-ring-name` \u3002\n- \u662f\u5bc6\u9470\u540d\u7a31\u3002\u4f8b\u5982 `my-key-name` \u3002\n- \u5275\u5efa Deploymentb. \u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u5275\u5efa `Deployment` \u8cc7\u6e90\uff1a```\ncat <<EOF | kubectl apply -f -apiVersion: apps/v1kind: Deploymentmetadata:\u00a0 name: web-server-multishare\u00a0 labels:\u00a0 \u00a0 app: nginxspec:\u00a0 replicas: 5\u00a0 selector:\u00a0 \u00a0 matchLabels:\u00a0 \u00a0 \u00a0 app: nginx\u00a0 template:\u00a0 \u00a0 metadata:\u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 app: nginx\u00a0 \u00a0 spec:\u00a0 \u00a0 \u00a0 containers:\u00a0 \u00a0 \u00a0 - name: nginx\u00a0 \u00a0 \u00a0 \u00a0 image: nginx\u00a0 \u00a0 \u00a0 \u00a0 volumeMounts:\u00a0 \u00a0 \u00a0 \u00a0 - mountPath: /usr/share/nginx/html\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 name: mypvc\u00a0 \u00a0 \u00a0 volumes:\u00a0 \u00a0 \u00a0 - name: mypvc\u00a0 \u00a0 \u00a0 \u00a0 persistentVolumeClaim:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 claimName: test-pvc-fs-cmek---kind: PersistentVolumeClaimapiVersion: v1metadata:\u00a0 name: test-pvc-fs-cmekspec:\u00a0 accessModes:\u00a0 \u00a0 - ReadWriteMany\u00a0 storageClassName: csi-filestore-multishare-cmek\u00a0 resources:\u00a0 \u00a0 requests:\u00a0 \u00a0 \u00a0 storage: 100GiEOF\n```## \u5c07 PVC \u6620\u5c04\u5230 Filestore \u5be6\u4f8b\n**\u6ce8\u610f** \uff1aFilestore Multishare \u5be6\u4f8b\u662f\u4f7f\u7528 CSI \u52d5\u614b\u9810\u914d\u9032\u884c\u7ba1\u7406\u7684\u3002\u5b8c\u6210\u5275\u5efa\u5be6\u4f8b\u6216\u5171\u4eab\u7684\u64cd\u4f5c\u53ef\u80fd\u9700\u8981\u5e7e\u5206\u9418\u7684\u6642\u9593\u3002\u5275\u5efa Filestore \u8cc7\u6e90\u5f8c\uff0cKubernetes \u6703\u5275\u5efa\u95dc\u806f\u7684 PV\u3002\u9019\u610f\u5473\u7740\u5728 CSI \u9a45\u52d5\u7a0b\u5e8f\u5553\u52d5\u7684\u5275\u5efa\u64cd\u4f5c\u5b8c\u6210\u4e4b\u524d\uff0c\u5377\u4e0d\u6703\u986f\u793a\u3002\n\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u77ad\u89e3\u5982\u4f55\u5c07 PVC \u6620\u5c04\u5230 Filestore \u5be6\u4f8b\u3002\n\u5c0d\u65bc Filestore Multishare \u5be6\u4f8b\uff0c\u6bcf\u500b PVC \u90fd\u7531 Filestore CSI \u9a45\u52d5\u7a0b\u5e8f\u8a17\u7ba1\u5728 Filestore \u5be6\u4f8b\u4e0a\u3002\u8a17\u7ba1\u5377\u7684\u5e95\u5c64 Filestore \u5be6\u4f8b\u4ee5\u53ca\u8868\u793a Kubernetes \u5377\u7684\u5171\u4eab\u7684\u8a73\u7d30\u4fe1\u606f\u53ef\u5728\u6c38\u4e45\u6027\u5377\u898f\u7bc4\u7684 `volumeHandle` \u5b57\u6bb5\u4e2d\u6355\u7372\u3002\u5377\u53e5\u67c4\u683c\u5f0f\u5982\u4e0b\uff1a\n```\nmodeMultishare/<storageclass-prefix>/<project>/<region>/<filestore-instance-name>/<filestore-share-name>\n```\n\u4ee5\u4e0b `kubectl` \u547d\u4ee4\u53ef\u7528\u65bc\u5feb\u901f\u78ba\u5b9a PVC\u3001PV\u3001Filestore \u5be6\u4f8b\u548c Filestore \u5171\u4eab\u4e4b\u9593\u7684\u6620\u5c04\u3002\n\u5f9e\u547d\u4ee4\u884c\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\nkubectl get pv -o jsonpath='{range .items[*]}{\"pv=\"}{.metadata.name}{\",pvc=\"}{.spec.claimRef.name}{\",volumeHandle=\"}{.spec.csi.volumeHandle}{\"\\n\"}{end}'\n```\n\u60a8\u61c9\u8a72\u6703\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u97ff\u61c9\u7684\u5167\u5bb9\uff1a\n```\npv=pvc-67ad9abd-f25e-4130-b7ca-64d28bd29525,pvc=test-pvc-multishare,volumeHandle=modeMultishare/csi-filestore-multishare-sharedvpc/YOUR_PROJECT_ID/us-central1/fs-2109f680-3f04-4ada-b4bc-2a1c7fc47b88/pvc_67ad9abd_f25e_4130_b7ca_64d28bd29525pv=pvc-c80f4de0-9916-4957-b8ae-b21206650ac0,pvc=test-pvc-fs-sharedvpc,volumeHandle=modeMultishare/csi-filestore-multishare-sharedvpc/YOUR_PROJECT_ID/us-central1/fs-2109f680-3f04-4ada-b4bc-2a1c7fc47b88/pvc_c80f4de0_9916_4957_b8ae_b21206650ac0\n```\n\u5176\u4e2d\uff1a\n- \u662f\u6240\u4f7f\u7528\u7684 [\u9805\u76ee](https://cloud.google.com/filestore/docs/install?hl=zh-cn) \u7684\u540d\u7a31\u3002\u4f8b\u5982`my-project`\u3002\n\u8acb\u6ce8\u610f\uff0c\u96c6\u7fa3\u4e2d\u7684\u5169\u500b\u6c38\u4e45\u6027\u5377\u8a17\u7ba1\u5728\u55ae\u500b Filestore \u5be6\u4f8b\u4e0a\u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n- [\u5728\u670d\u52d9\u9805\u76ee\u4e2d\u7684\u5171\u4eab VPC \u7db2\u7d61\u4e0a\u5275\u5efa\u5be6\u4f8b](https://cloud.google.com/filestore/docs/shared-vpc?hl=zh-cn) \n- [\u6bd4\u8f03\u584a\u5b58\u5132\u3001\u6587\u4ef6\u5b58\u5132\u548c\u5c0d\u8c61\u5b58\u5132\u7684\u76f8\u5c0d\u512a\u52e2](https://cloud.google.com/architecture/storage-advisor?hl=zh-cn#review_the_storage_options) \u3002\n- [Google Cloud \u4e2d\u9069\u7528\u65bc HPC \u5de5\u4f5c\u8ca0\u8f09\u7684\u5b58\u5132\u65b9\u6848](https://cloud.google.com/architecture/parallel-file-systems-for-hpc?hl=zh-cn#storage-options-for-hpc-workloads-in-google-cloud)", "guide": "Google Kubernetes Engine (GKE)"}