{"title": "Google Kubernetes Engine (GKE) - \u4f7f\u7528 Ingress \u8a2d\u7f6e\u5916\u90e8\u61c9\u7528\u8ca0\u8f09\u5747\u8861\u5668", "url": "https://cloud.google.com/kubernetes-engine/docs/tutorials/http-balancer?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - \u4f7f\u7528 Ingress \u8a2d\u7f6e\u5916\u90e8\u61c9\u7528\u8ca0\u8f09\u5747\u8861\u5668\n\u672c\u6559\u7a0b\u4ecb\u7d39\u5982\u4f55\u901a\u904e\u914d\u7f6e [Ingress](https://cloud.google.com/kubernetes-engine/docs/concepts/ingress?hl=zh-cn) \u8cc7\u6e90\u5728\u4f7f\u7528 [\u5916\u90e8\u61c9\u7528\u8ca0\u8f09\u5747\u8861\u5668](https://cloud.google.com/load-balancing/docs/https?hl=zh-cn) \u7684\u60c5\u6cc1\u4e0b\u904b\u884c Web \u61c9\u7528\u3002\n **\u6ce8\u610f** \uff1a\u6b64\u904e\u7a0b\u4e0d\u9069\u7528\u65bc [NGINX Ingress \u63a7\u5236\u5668](https://github.com/kubernetes/ingress-nginx) \u3002", "content": "## \u80cc\u666fGoogle Kubernetes Engine (GKE) \u7232\u53ef\u516c\u958b\u8a2a\u554f\u7684\u61c9\u7528\u63d0\u4f9b\u4e86\u5c0d\u5169\u7a2e\u985e\u578b\u7684 Cloud Load Balancing \u7684\u96c6\u6210\u652f\u6301\uff1a- [\u5165\u7ad9\u6d41\u91cf](https://cloud.google.com/kubernetes-engine/docs/concepts/ingress?hl=zh-cn) \n- [\u5916\u90e8\u76f4\u901a\u5f0f\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668](https://cloud.google.com/load-balancing/docs/network?hl=zh-cn) \n\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 [Ingress](https://cloud.google.com/kubernetes-engine/docs/concepts/ingress?hl=zh-cn) \u3002\n### Ingress\u5728\u8cc7\u6e90\u6e05\u55ae\u4e2d\u6307\u5b9a `kind: Ingress` \u6642\uff0c\u60a8\u9700\u8981\u6307\u793a GKE \u4f86\u5275\u5efa [Ingress](https://cloud.google.com/kubernetes-engine/docs/concepts/ingress?hl=zh-cn) \u8cc7\u6e90\u3002\u901a\u904e\u6dfb\u52a0\u8a3b\u91cb\u4e26\u652f\u6301\u5de5\u4f5c\u8ca0\u8f09\u548c Service\uff0c\u60a8\u53ef\u4ee5\u5275\u5efa\u81ea\u5b9a\u7fa9 Ingress \u63a7\u5236\u5668\u3002\u5426\u5247\uff0cGKE \u6703\u9032\u884c\u9069\u7576\u7684 Google Cloud API \u8abf\u7528\uff0c\u4ee5\u5275\u5efa [\u5916\u90e8\u61c9\u7528\u8ca0\u8f09\u5747\u8861\u5668](https://cloud.google.com/load-balancing/docs/https?hl=zh-cn) \u3002\u8ca0\u8f09\u5747\u8861\u5668\u7684\u7db2\u5740\u6620\u5c04\u7684\u4e3b\u6a5f\u898f\u5247\u548c\u8def\u5f91\u5339\u914d\u5668\u6703\u5f15\u7528\u4e00\u500b\u6216\u591a\u500b\u5f8c\u7aef\u670d\u52d9\uff0c\u5176\u4e2d\uff0c\u6bcf\u500b\u5f8c\u7aef\u670d\u52d9\u5c0d\u61c9\u65bc\u4e00\u500b\u985e\u578b\u7232 `NodePort` \u7684 GKE [Service](https://kubernetes.io/docs/concepts/services-networking/service/) \uff0c\u5982 `Ingress` \u4e2d\u5f15\u7528\u7684\u90a3\u6a23\u3002\u6bcf\u500b\u5f8c\u7aef\u670d\u52d9\u7684\u5f8c\u7aef\u662f\u5be6\u4f8b\u7d44\u6216\u7db2\u7d61\u7aef\u9ede\u7d44 (NEG)\u3002\u5728\u914d\u7f6e Ingress \u7684\u904e\u7a0b\u4e2d\uff0c\u914d\u7f6e [\u5bb9\u5668\u539f\u751f\u8ca0\u8f09\u5747\u8861](https://cloud.google.com/kubernetes-engine/docs/how-to/container-native-load-balancing?hl=zh-cn) \u6642\uff0c\u7cfb\u7d71\u6703\u5275\u5efa NEG\u3002\u5c0d\u65bc\u6bcf\u500b\u5f8c\u7aef\u670d\u52d9\uff0cGKE \u90fd\u6703\u6839\u64da\u76f8\u61c9 GKE [Service](https://kubernetes.io/docs/concepts/services-networking/service/) \u5f15\u7528\u7684\u5de5\u4f5c\u8ca0\u8f09\u7684\u5c31\u7dd2\u6027\u63a2\u6e2c\u8a2d\u7f6e\u5275\u5efa Google Cloud \u5065\u5eb7\u6aa2\u67e5\u3002\n\u5982\u679c\u8981\u516c\u958b\u5728 GKE \u4e0a\u8a17\u7ba1\u7684 HTTP(S) \u670d\u52d9\uff0c\u5247\u5efa\u8b70\u4f7f\u7528 [HTTP(S) \u8ca0\u8f09\u5e73\u8861](https://cloud.google.com/compute/docs/load-balancing/http?hl=zh-cn) \u65b9\u6cd5\u4f86\u5be6\u73fe\u8ca0\u8f09\u5e73\u8861\u3002\n **\u6ce8\u610f** \uff1aGKE \u5275\u5efa\u7684\u8ca0\u8f09\u5747\u8861\u5668\u6309\u7167\u5e38\u898f [Cloud Load Balancing \u50f9\u683c](https://cloud.google.com/vpc/network-pricing?hl=zh-cn#lb) \u8a08\u8cbb\u3002\n **\u6ce8\u610f** \uff1a\u5982\u9700\u4f7f\u7528 Ingress\uff0c\u60a8\u5fc5\u9808\u5553\u7528\u5916\u90e8\u61c9\u7528\u8ca0\u8f09\u5747\u8861\u5668\u63d2\u4ef6\u3002GKE \u96c6\u7fa3\u9ed8\u8a8d\u5553\u7528\u4e86\u5916\u90e8\u61c9\u7528\u8ca0\u8f09\u5747\u8861\u5668\uff1b\u60a8\u4e0d\u5f97\u5c07\u5176\u505c\u7528\u3002\n **\u6ce8\u610f** \uff1aGoogle Kubernetes Engine \u4f9d\u8cf4\u65bc\u5065\u5eb7\u6aa2\u67e5\u6a5f\u5236\u4f86\u78ba\u5b9a\u5f8c\u7aef\u670d\u52d9\u7684\u5065\u5eb7\u72c0\u6cc1\u3002\u6b64\u6a5f\u5236\u7121\u6cd5\u7528\u65bc\u57f7\u884c\u9ed1\u76d2\u76e3\u63a7\u3002\u5982\u9700\u57f7\u884c\u9ed1\u76d2\u76e3\u63a7\uff0c\u8acb\u5275\u5efa\u4e00\u500b\u6b63\u5e38\u904b\u884c\u6642\u9593\u6aa2\u67e5\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\uff08\u53ef\u9078\uff09\u76e3\u63a7\u670d\u52d9\u7684\u53ef\u7528\u6027\u548c\u5ef6\u9072\u6642\u9593](#monitor) \u3002\n## \u76ee\u6a19\n- \u5275\u5efa GKE \u96c6\u7fa3\u3002\n- \u5c07\u793a\u4f8b Web \u61c9\u7528\u90e8\u7f72\u5230\u96c6\u7fa3\u3002\n- \u5c07\u5916\u90e8\u61c9\u7528\u8ca0\u8f09\u5747\u8861\u5668\u5f8c\u7684\u793a\u4f8b\u61c9\u7528\u516c\u958b\u5230\u4e92\u806f\u7db2\u3002\n## \u8cbb\u7528\nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728\u672c\u6587\u6a94\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Google Cloud \u7684\u4ee5\u4e0b\u6536\u8cbb\u7d44\u4ef6\uff1a- [GKE](https://cloud.google.com/kubernetes-engine/pricing?hl=zh-cn) \n\u60a8\u53ef\u4f7f\u7528 [\u50f9\u683c\u8a08\u7b97\u5668](https://cloud.google.com/products/calculator?hl=zh-cn) \u6839\u64da\u60a8\u7684\u9810\u8a08\u4f7f\u7528\u60c5\u6cc1\u4f86\u4f30\u7b97\u8cbb\u7528\u3002 \nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5b8c\u6210\u672c\u6587\u6a94\u4e2d\u63cf\u8ff0\u7684\u4efb\u52d9\u5f8c\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u522a\u9664\u6240\u5275\u5efa\u7684\u8cc7\u6e90\u4f86\u907f\u514d\u7e7c\u7e8c\u8a08\u8cbb\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u6e05\u7406](#clean-up) \u3002## \u6e96\u5099\u5de5\u4f5c\n\u8acb\u6309\u7167\u4ee5\u4e0b\u6b65\u9a5f\u5553\u7528 Kubernetes Engine API\uff1a\n- \u8a2a\u554f Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 [Kubernetes Engine \u9801\u9762](https://console.cloud.google.com/projectselector/kubernetes?hl=zh-cn) \u3002\n- \u5275\u5efa\u6216\u9078\u64c7\u9805\u76ee\u3002\n- \u7a0d\u4f5c\u7b49\u5f85\uff0c\u8b93 API \u548c\u76f8\u95dc\u670d\u52d9\u5b8c\u6210\u5553\u7528\u904e\u7a0b\u3002  \u6b64\u904e\u7a0b\u53ef\u80fd\u8017\u6642\u5e7e\u5206\u9418\u3002\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- [\u78ba\u4fdd\u60a8\u7684 Google Cloud \u9805\u76ee\u5df2\u5553\u7528\u7d50\u7b97\u529f\u80fd](https://cloud.google.com/billing/docs/how-to/verify-billing-enabled?hl=zh-cn#console) \u3002\n\u5b89\u88dd\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528\u7684\u4ee5\u4e0b\u547d\u4ee4\u884c\u5de5\u5177\uff1a- `gcloud`\u7528\u65bc\u5275\u5efa\u548c\u522a\u9664 Kubernetes Engine \u96c6\u7fa3\u3002`gcloud`\u5305\u542b\u5728 [gcloud CLI](https://cloud.google.com/sdk/docs/install?hl=zh-cn) \u4e2d\u3002\n- `kubectl`\u7528\u65bc\u7ba1\u7406 Kubernetes\uff08\u5373 Kubernetes Engine \u4f7f\u7528\u7684\u96c6\u7fa3\u7de8\u6392\u7cfb\u7d71\uff09\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528`gcloud`\u5b89\u88dd`kubectl`\uff1a```\ngcloud components install kubectl\n```\n\u5f9e GitHub \u514b\u9686\u793a\u4f8b\u4ee3\u78bc\uff1a\n```\ngit clone https://github.com/GoogleCloudPlatform/kubernetes-engine-samples\ncd kubernetes-engine-samples/networking/load-balancing\n```\n### \u7232 gcloud \u547d\u4ee4\u884c\u5de5\u5177\u8a2d\u7f6e\u9ed8\u8a8d\u503c\n\u5982\u9700\u7bc0\u7701\u5728\n`gcloud`\n\u547d\u4ee4\u884c\u5de5\u5177\u4e2d\u8f38\u5165\n [\u9805\u76ee ID](https://support.google.com/cloud/answer/6158840?hl=zh-cn) \n\u548c\n [Compute Engine \u5730\u5340](https://cloud.google.com/compute/docs/zones?hl=zh-cn#available) \n\u9078\u9805\u7684\u6642\u9593\uff0c\u60a8\u53ef\u4ee5\u8a2d\u7f6e\u4ee5\u4e0b\u9ed8\u8a8d\u503c\uff1a\n```\ngcloud config set project project-id\ngcloud config set compute/zone compute-zone\n```\n### \u5275\u5efa GKE \u96c6\u7fa3\u5275\u5efa GKE Autopilot \u96c6\u7fa3\uff1a\n```\ngcloud container clusters create-auto loadbalancedcluster\n```## \u90e8\u7f72 Web \u61c9\u7528\u4e0b\u9762\u7684\u6e05\u55ae\u63cf\u8ff0\u4e86\u4e86\u4e00\u500b\u5728\u7aef\u53e3 8080 \u7684 HTTP \u670d\u52d9\u5668\u4e0a\u904b\u884c\u793a\u4f8b Web \u61c9\u7528\u5bb9\u5668\u6620\u50cf\u7684 [Deployment](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/) \uff1a\n [  networking/load-balancing/web-deployment.yaml ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/networking/load-balancing/web-deployment.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/networking/load-balancing/web-deployment.yaml) \n```\napiVersion: apps/v1kind: Deploymentmetadata:\u00a0 name: web\u00a0 namespace: defaultspec:\u00a0 selector:\u00a0 \u00a0 matchLabels:\u00a0 \u00a0 \u00a0 run: web\u00a0 template:\u00a0 \u00a0 metadata:\u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 run: web\u00a0 \u00a0 spec:\u00a0 \u00a0 \u00a0 containers:\u00a0 \u00a0 \u00a0 - image: us-docker.pkg.dev/google-samples/containers/gke/hello-app:1.0\u00a0 \u00a0 \u00a0 \u00a0 imagePullPolicy: IfNotPresent\u00a0 \u00a0 \u00a0 \u00a0 name: web\u00a0 \u00a0 \u00a0 \u00a0 ports:\u00a0 \u00a0 \u00a0 \u00a0 - containerPort: 8080\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 protocol: TCP\n```\n\u5c07\u8cc7\u6e90\u61c9\u7528\u5230\u96c6\u7fa3\uff1a\n```\nkubectl apply -f web-deployment.yaml\n```## \u5728\u96c6\u7fa3\u5167\u516c\u958b Deployment\u4e0b\u9762\u7684\u6e05\u55ae\u63cf\u8ff0\u4e86\u4e86\u4f7f `web` \u90e8\u7f72\u53ef\u5728\u5bb9\u5668\u96c6\u7fa3\u4e2d\u8a2a\u554f\u7684 [Service](https://kubernetes.io/docs/concepts/services-networking/service/) \uff1a\n [  networking/load-balancing/web-service.yaml ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/networking/load-balancing/web-service.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/networking/load-balancing/web-service.yaml) \n```\napiVersion: v1kind: Servicemetadata:\u00a0 name: web\u00a0 namespace: defaultspec:\u00a0 ports:\u00a0 - port: 8080\u00a0 \u00a0 protocol: TCP\u00a0 \u00a0 targetPort: 8080\u00a0 selector:\u00a0 \u00a0 run: web\u00a0 type: NodePort\n```- \u5c07\u8cc7\u6e90\u61c9\u7528\u5230\u96c6\u7fa3\uff1a```\nkubectl apply -f web-service.yaml\n```\u4f7f\u7528\u6b64\u547d\u4ee4\u5275\u5efa [NodePort](https://kubernetes.io/docs/concepts/services-networking/service/#nodeport) \u985e\u578b\u7684 Service \u6642\uff0cGKE \u6703\u4f7f\u60a8\u7684 Service \u5728\u96c6\u7fa3\u4e2d\u6240\u6709\u7bc0\u9ede\u4e0a\u96a8\u6a5f\u9078\u64c7\u7684\u8f03\u5927\u7aef\u53e3\u865f\uff08\u4f8b\u5982 32640\uff09\u4e0a\u53ef\u7528\u3002\n- \u9a57\u8b49\u662f\u5426\u5df2\u5275\u5efa Service \u4ee5\u53ca\u662f\u5426\u5206\u914d\u4e86\u7bc0\u9ede\u7aef\u53e3\uff1a```\nkubectl get service web\n```\u8f38\u51fa\uff1a```\nNAME  TYPE  CLUSTER-IP  EXTERNAL-IP PORT(S)   AGE\nweb  NodePort 10.35.245.219 <none>  8080:32640/TCP 5m\n```\u5728\u793a\u4f8b\u8f38\u51fa\u7d50\u679c\u4e2d\uff0c `web` Service \u7684\u7bc0\u9ede\u7aef\u53e3\u662f `32640` \u3002\u53e6\u8acb\u6ce8\u610f\uff0c\u6211\u5011\u672a\u7232\u6b64 Service \u5206\u914d\u5916\u90e8 IP \u5730\u5740\u3002\u7531\u65bc\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\u7121\u6cd5\u5f9e\u5916\u90e8\u8a2a\u554f GKE \u7bc0\u9ede\uff0c\u56e0\u6b64\u5275\u5efa\u6b64 Service \u5f8c\uff0c\u4ecd\u7121\u6cd5\u901a\u904e\u4e92\u806f\u7db2\u8a2a\u554f\u60a8\u7684\u61c9\u7528\u3002\n\u8981\u4f7f HTTP(S) \u7db2\u7d61\u670d\u52d9\u5668\u61c9\u7528\u53ef\u516c\u958b\u8a2a\u554f\uff0c\u60a8\u5fc5\u9808\u5275\u5efa Ingress \u8cc7\u6e90\u3002## \u5275\u5efa Ingress \u8cc7\u6e90 [Ingress](https://cloud.google.com/kubernetes-engine/docs/concepts/ingress?hl=zh-cn) \u662f\u4e00\u7a2e Kubernetes \u8cc7\u6e90\uff0c\u5b83\u5c01\u88dd\u4e86\u4e00\u7cfb\u5217\u898f\u5247\u548c\u914d\u7f6e\uff0c\u53ef\u5c07\u5916\u90e8 HTTP(S) \u6d41\u91cf\u8def\u7531\u5230\u5167\u90e8\u670d\u52d9\u3002\n\u5728 GKE \u4e0a\uff0cIngress \u662f\u4f7f\u7528 [Cloud Load Balancing](https://cloud.google.com/load-balancing?hl=zh-cn) \u5be6\u73fe\u7684\u3002\u7576\u60a8\u5728\u96c6\u7fa3\u4e2d\u5275\u5efa Ingress \u6642\uff0cGKE \u6703\u5275\u5efa\u4e00\u500b [HTTP(S) \u8ca0\u8f09\u5747\u8861\u5668](https://cloud.google.com/compute/docs/load-balancing/http?hl=zh-cn) \uff0c\u4e26\u5c07\u5176\u914d\u7f6e\u7232\u5c07\u6d41\u91cf\u8def\u7531\u5230\u60a8\u7684\u61c9\u7528\u3002\n\u4e0b\u9762\u7684\u6e05\u55ae\u63cf\u8ff0\u4e86\u5c07\u6d41\u91cf\u5b9a\u5411\u5230 `web` Service \u7684 Ingress \u8cc7\u6e90\uff1a\n [  networking/load-balancing/basic-ingress.yaml ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/networking/load-balancing/basic-ingress.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/networking/load-balancing/basic-ingress.yaml) \n```\napiVersion: networking.k8s.io/v1kind: Ingressmetadata:\u00a0 name: basic-ingressspec:\u00a0 defaultBackend:\u00a0 \u00a0 service:\u00a0 \u00a0 \u00a0 name: web\u00a0 \u00a0 \u00a0 port:\u00a0 \u00a0 \u00a0 \u00a0 number: 8080\n```\n\u5c07\u8cc7\u6e90\u61c9\u7528\u5230\u96c6\u7fa3\uff1a\n```\nkubectl apply -f basic-ingress.yaml\n```\n\u90e8\u7f72\u6b64\u6e05\u55ae\u5f8c\uff0cKubernetes \u6703\u5728\u60a8\u7684\u96c6\u7fa3\u4e0a\u5275\u5efa\u4e00\u500b Ingress \u8cc7\u6e90\u3002GKE Ingress \u63a7\u5236\u5668\u6839\u64da Ingress \u4e2d\u7684\u4fe1\u606f\u5275\u5efa\u4e26\u914d\u7f6e [HTTP(S) \u8ca0\u8f09\u5747\u8861\u5668](https://cloud.google.com/compute/docs/load-balancing/http?hl=zh-cn) \uff0c\u5c07\u7aef\u53e3 80 \u4e0a\u7684\u6240\u6709\u5916\u90e8 HTTP \u6d41\u91cf\u8def\u7531\u5230\u60a8\u516c\u958b\u7684 `web` NodePort Service\u3002\n **\u6ce8\u610f** \uff1a\u5982\u9700\u4f7f\u7528 Ingress\uff0c\u60a8\u5fc5\u9808\u5553\u7528\u5916\u90e8\u61c9\u7528\u8ca0\u8f09\u5747\u8861\u5668\u63d2\u4ef6\u3002GKE \u96c6\u7fa3\u9ed8\u8a8d\u5553\u7528\u4e86\u5916\u90e8\u61c9\u7528\u8ca0\u8f09\u5747\u8861\u5668\uff1b\u60a8\u4e0d\u5f97\u5c07\u5176\u505c\u7528\u3002\n## \u8a2a\u554f\u61c9\u7528\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u627e\u51fa\u7232\u61c9\u7528\u63d0\u4f9b\u670d\u52d9\u7684\u8ca0\u8f09\u5747\u8861\u5668\u7684\u5916\u90e8 IP \u5730\u5740\uff1a\n```\nkubectl get ingress basic-ingress\n```\n\u8f38\u51fa\uff1a\n```\nNAME   HOSTS  ADDRESS   PORTS  AGE\nbasic-ingress *   203.0.113.12 80  2m\n```\n **\u6ce8\u610f** \uff1a\u5728\u8ca0\u8f09\u5747\u8861\u5668\u6e96\u5099\u597d\u8655\u7406\u61c9\u7528\u4e4b\u524d\uff0cGKE \u53ef\u80fd\u9700\u8981\u5e7e\u5206\u9418\u7684\u6642\u9593\u4f86\u5206\u914d\u5916\u90e8 IP \u5730\u5740\u548c\u8a2d\u7f6e\u8f49\u767c\u898f\u5247\u3002\u5728\u5168\u7403\u7bc4\u570d\u50b3\u64ad\u8ca0\u8f09\u5747\u8861\u5668\u914d\u7f6e\u4e4b\u524d\uff0c\u60a8\u53ef\u80fd\u6703\u6536\u5230 HTTP 404 \u6216 HTTP 500 \u7b49\u932f\u8aa4\u3002\n\u5728\u700f\u89bd\u5668\u4e2d\u6253\u958b\u61c9\u7528\u7684\u5916\u90e8 IP \u5730\u5740\uff0c\u67e5\u770b\u7d14\u6587\u672c HTTP \u97ff\u61c9\uff0c\u5982\u4e0b\u6240\u793a\uff1a\n```\nHello, world!\nVersion: 1.0.0\nHostname: web-6498765b79-fq5q5\n```\n\u60a8\u53ef\u4ee5\u8a2a\u554f Google Cloud \u63a7\u5236\u6aaf\u4e0a\u7684 [\u8ca0\u8f09\u5747\u8861](https://console.cloud.google.com/networking/loadbalancing?hl=zh-cn) \uff0c\u4e26\u6aa2\u67e5 GKE Ingress \u63a7\u5236\u5668\u5275\u5efa\u7684\u7db2\u7d61\u8cc7\u6e90\u3002## \uff08\u53ef\u9078\uff09\u914d\u7f6e\u975c\u614b IP \u5730\u5740\u5728\u57df\u540d\u4e0a\u516c\u958b\u7db2\u7d61\u670d\u52d9\u5668\u6642\uff0c\u60a8\u9700\u8981\u78ba\u4fdd\u61c9\u7528\u7684\u5916\u90e8 IP \u5730\u5740\u662f\u4e0d\u6703\u66f4\u6539\u7684\u975c\u614b IP\u3002\n\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cGKE \u6703\u7232\u901a\u904e Ingress \u516c\u958b\u7684 HTTP \u61c9\u7528\u5206\u914d [\u81e8\u6642\u5916\u90e8 IP \u5730\u5740](https://cloud.google.com/compute/docs/ip-addresses?hl=zh-cn#ephemeraladdress) \u3002 \u81e8\u6642\u5730\u5740\u96a8\u6642\u53ef\u80fd\u66f4\u6539\u3002\u5982\u679c\u60a8\u6253\u7b97\u9577\u6642\u9593\u904b\u884c\u61c9\u7528\uff0c\u5247\u5fc5\u9808\u4f7f\u7528 [\u975c\u614b\u5916\u90e8 IP \u5730\u5740](https://cloud.google.com/compute/docs/ip-addresses/reserve-static-external-ip-address?hl=zh-cn) \u3002\n\u8acb\u6ce8\u610f\uff0c\u7232 Ingress \u8cc7\u6e90\u914d\u7f6e\u975c\u614b IP \u5730\u5740\u5f8c\uff0c\u522a\u9664 Ingress \u6642\u5c07\u4e0d\u6703\u522a\u9664\u8207\u4e4b\u95dc\u806f\u7684\u975c\u614b IP \u5730\u5740\u3002\u5982\u679c\u4e0d\u518d\u6253\u7b97\u518d\u6b21\u4f7f\u7528\u6240\u914d\u7f6e\u7684\u975c\u614b IP \u5730\u5740\uff0c\u8acb\u52d9\u5fc5\u6e05\u7406\u8a72 IP \u5730\u5740\u3002\n **\u8b66\u544a** \uff1a\u4ee5\u4e0b\u8aaa\u660e\u6703\u5275\u5efa\u4e00\u500b\u975c\u614b IP \u5730\u5740\uff0c\u7136\u5f8c\u5728 Ingress \u6e05\u55ae\u4e2d\u5f15\u7528\u8a72 IP \u5730\u5740\u3002\u5982\u679c\u60a8\u4fee\u6539\u73fe\u6709 Ingress \u4ee5\u4f7f\u7528\u975c\u614b IP \u5730\u5740\u800c\u4e0d\u662f\u81e8\u6642 IP \u5730\u5740\uff0c\u5247 GKE \u53ef\u80fd\u6703\u5728 GKE \u91cd\u65b0\u5275\u5efa\u8ca0\u8f09\u5747\u8861\u5668\u7684\u8f49\u767c\u898f\u5247\u6642\u66f4\u6539\u8ca0\u8f09\u5747\u8861\u5668\u7684 IP \u5730\u5740\u3002\n\u5982\u9700\u914d\u7f6e\u975c\u614b IP \u5730\u5740\uff0c\u8acb\u5b8c\u6210\u4ee5\u4e0b\u6b65\u9a5f\uff1a- \u9810\u7559\u540d\u7232 `web-static-ip` \u7684 [\u975c\u614b\u5916\u90e8 IP \u5730\u5740](https://cloud.google.com/compute/docs/ip-addresses/reserve-static-external-ip-address?hl=zh-cn) \uff1a\n```\ngcloud compute addresses create web-static-ip --global\n```\n **\u6ce8\u610f** \uff1a\u6b64\u6b65\u9a5f\u9700\u8981\u4f7f\u7528 [\u914d\u7f6e\u9023\u63a5\u5668](https://cloud.google.com/config-connector/docs/overview?hl=zh-cn) \u3002\u6309\u7167 [\u5b89\u88dd\u8aaa\u660e](https://cloud.google.com/config-connector/docs/how-to/install-upgrade-uninstall?hl=zh-cn) \u5728\u60a8\u7684\u96c6\u7fa3\u4e0a\u5b89\u88dd\u914d\u7f6e\u9023\u63a5\u5668\u3002\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/k8s-config-connector/blob/HEAD/config/samples/tutorials/http-balancer/compute-address.yaml) \n```\napiVersion: compute.cnrm.cloud.google.com/v1beta1kind: ComputeAddressmetadata:\u00a0 name: web-static-ipspec:\u00a0 location: global\n```\n\u5982\u9700\u90e8\u7f72\u6b64\u6e05\u55ae\uff0c\u8acb\u5c07\u5b83\u4ee5 compute-address.yaml \u7684\u5f62\u5f0f\u4e0b\u8f09\u5230\u60a8\u7684\u6a5f\u5668\u4e0a\uff0c\u7136\u5f8c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\nkubectl apply -f compute-address.yaml\n```\n- `basic-ingress-static.yaml` \u6e05\u55ae\u6703\u5728 Ingress \u4e2d\u6dfb\u52a0\u8a3b\u91cb\uff0c\u4ee5\u4f7f\u7528\u540d\u7232 `web-static-ip` \u7684\u975c\u614b IP \u5730\u5740\u8cc7\u6e90\uff1a [  networking/load-balancing/basic-ingress-static.yaml ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/networking/load-balancing/basic-ingress-static.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/networking/load-balancing/basic-ingress-static.yaml) ```\napiVersion: networking.k8s.io/v1kind: Ingressmetadata:\u00a0 name: basic-ingress\u00a0 annotations:\u00a0 \u00a0 kubernetes.io/ingress.global-static-ip-name: \"web-static-ip\"spec:\u00a0 defaultBackend:\u00a0 \u00a0 service:\u00a0 \u00a0 \u00a0 name: web\u00a0 \u00a0 \u00a0 port:\u00a0 \u00a0 \u00a0 \u00a0 number: 8080\n```\u67e5\u770b\u6e05\u55ae\uff1a```\ncat basic-ingress-static.yaml\n```\n- \u5c07\u8cc7\u6e90\u61c9\u7528\u5230\u96c6\u7fa3\uff1a```\nkubectl apply -f basic-ingress-static.yaml\n```\n- \u6aa2\u67e5\u5916\u90e8 IP \u5730\u5740\uff1a```\nkubectl get ingress basic-ingress\n```\u7b49\u5f85\u61c9\u7528\u7684 IP \u5730\u5740\u767c\u751f\u66f4\u6539\uff0c\u4ee5\u4f7f\u7528 `web-static-ip` \u8cc7\u6e90\u7684\u9810\u7559 IP \u5730\u5740\u3002\u66f4\u65b0\u73fe\u6709 Ingress \u8cc7\u6e90\u3001\u91cd\u65b0\u914d\u7f6e\u8ca0\u8f09\u5747\u8861\u5668\u4e26\u5728\u5168\u7403\u7bc4\u570d\u50b3\u64ad\u8ca0\u8f09\u5747\u8861\u898f\u5247\u53ef\u80fd\u9700\u8981\u5e7e\u5206\u9418\u7684\u6642\u9593\u3002\u5b8c\u6210\u6b64\u64cd\u4f5c\u5f8c\uff0cGKE \u6703\u91cb\u653e\u4e4b\u524d\u5206\u914d\u7d66\u61c9\u7528\u7684\u81e8\u6642 IP \u5730\u5740\u3002 **\u6ce8\u610f** \uff1a\u672a\u7528\u7684\u975c\u614b\u5916\u90e8 IP \u5730\u5740\u6309\u5e38\u898f [IP \u5730\u5740\u7d50\u7b97](https://cloud.google.com/compute/pricing?hl=zh-cn#ipaddress) \u8a08\u8cbb\u3002## \uff08\u53ef\u9078\uff09\u5728\u8ca0\u8f09\u5747\u8861\u5668\u4e0a\u8655\u7406\u591a\u500b\u61c9\u7528\u60a8\u53ef\u4ee5\u901a\u904e\u5c0d Ingress \u914d\u7f6e\u8def\u7531\u898f\u5247\uff0c\u5728\u55ae\u500b\u8ca0\u8f09\u5747\u8861\u5668\u548c\u516c\u5171 IP \u4e0a\u904b\u884c\u591a\u500b\u670d\u52d9\u3002\u901a\u904e\u5728\u540c\u4e00 Ingress \u4e0a\u8a17\u7ba1\u591a\u500b\u670d\u52d9\uff0c\u60a8\u5c31\u4e0d\u5fc5\u7232\u516c\u958b\u7d66\u4e92\u806f\u7db2\u7684\u6bcf\u4e00\u500b Service \u5275\u5efa\u984d\u5916\u7684\u8ca0\u8f09\u5747\u8861\u5668\uff08\u6b64\u7232\u8a08\u8cbb\u8cc7\u6e90\uff09\u3002\n\u4e0b\u9762\u7684\u6e05\u55ae\u63cf\u8ff0\u4e86\u540c\u4e00 Web \u61c9\u7528\u7684 `2.0` \u7248 Deployment\uff1a\n [  networking/load-balancing/web-deployment-v2.yaml ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/networking/load-balancing/web-deployment-v2.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/networking/load-balancing/web-deployment-v2.yaml) \n```\napiVersion: apps/v1kind: Deploymentmetadata:\u00a0 name: web2\u00a0 namespace: defaultspec:\u00a0 selector:\u00a0 \u00a0 matchLabels:\u00a0 \u00a0 \u00a0 run: web2\u00a0 template:\u00a0 \u00a0 metadata:\u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 run: web2\u00a0 \u00a0 spec:\u00a0 \u00a0 \u00a0 containers:\u00a0 \u00a0 \u00a0 - image: us-docker.pkg.dev/google-samples/containers/gke/hello-app:2.0\u00a0 \u00a0 \u00a0 \u00a0 imagePullPolicy: IfNotPresent\u00a0 \u00a0 \u00a0 \u00a0 name: web2\u00a0 \u00a0 \u00a0 \u00a0 ports:\u00a0 \u00a0 \u00a0 \u00a0 - containerPort: 8080\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 protocol: TCP\n```\n\u5c07\u8cc7\u6e90\u61c9\u7528\u5230\u96c6\u7fa3\uff1a\n```\nkubectl apply -f web-deployment-v2.yaml\n```\n\u4e0b\u9762\u7684\u6e05\u55ae\u63cf\u8ff0\u4e86\u4e00\u500b\u5728\u5167\u90e8\u5c07 `web2` \u516c\u958b\u7d66\u540d\u7232 `web2` \u7684 NodePort Service \u4e0a\u7684\u96c6\u7fa3\uff1a\n [  networking/load-balancing/web-service-v2.yaml ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/networking/load-balancing/web-service-v2.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/networking/load-balancing/web-service-v2.yaml) \n```\napiVersion: v1kind: Servicemetadata:\u00a0 name: web2\u00a0 namespace: defaultspec:\u00a0 ports:\u00a0 - port: 8080\u00a0 \u00a0 protocol: TCP\u00a0 \u00a0 targetPort: 8080\u00a0 selector:\u00a0 \u00a0 run: web2\u00a0 type: NodePort\n```\n\u5c07\u8cc7\u6e90\u61c9\u7528\u5230\u96c6\u7fa3\uff1a\n```\nkubectl apply -f web-service-v2.yaml\n```\n\u4e0b\u9762\u7684\u6e05\u55ae\u63cf\u8ff0\u4e86\u5177\u5099\u4ee5\u4e0b\u7279\u9ede\u7684 Ingress \u8cc7\u6e90\uff1a- \u4f7f\u7528\u4ee5`/v2/`\u958b\u982d\u7684\u8def\u5f91\u5c07\u8acb\u6c42\u8def\u7531\u5230`web2`Service\n- \u5c07\u5176\u4ed6\u6240\u6709\u8acb\u6c42\u8def\u7531\u5230`web`Service\n [  networking/load-balancing/fanout-ingress.yaml ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/networking/load-balancing/fanout-ingress.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/networking/load-balancing/fanout-ingress.yaml) \n```\napiVersion: networking.k8s.io/v1kind: Ingressmetadata:\u00a0 name: fanout-ingressspec:\u00a0 rules:\u00a0 - http:\u00a0 \u00a0 \u00a0 paths:\u00a0 \u00a0 \u00a0 - path: /*\u00a0 \u00a0 \u00a0 \u00a0 pathType: ImplementationSpecific\u00a0 \u00a0 \u00a0 \u00a0 backend:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 service:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 name: web\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 port:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 number: 8080\u00a0 \u00a0 \u00a0 - path: /v2/*\u00a0 \u00a0 \u00a0 \u00a0 pathType: ImplementationSpecific\u00a0 \u00a0 \u00a0 \u00a0 backend:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 service:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 name: web2\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 port:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 number: 8080\n```\n\u5c07\u8cc7\u6e90\u61c9\u7528\u5230\u96c6\u7fa3\uff1a\n```\nkubectl create -f fanout-ingress.yaml\n```\n\u90e8\u7f72 Ingress \u5f8c\uff0c\u8acb\u904b\u884c `kubectl get ingress fanout-ingress` \u4f86\u67e5\u627e\u96c6\u7fa3\u7684\u516c\u5171 IP \u5730\u5740\u3002\n **\u6ce8\u610f** \uff1aGKE \u5206\u914d\u5916\u90e8 IP \u5730\u5740\u548c\u6e96\u5099\u8ca0\u8f09\u5747\u8861\u5668\u53ef\u80fd\u9700\u8981\u5e7e\u5206\u9418\u7684\u6642\u9593\u3002\u5728\u8ca0\u8f09\u5747\u8861\u5668\u6e96\u5099\u597d\u8655\u7406\u6d41\u91cf\u4e4b\u524d\uff0c\u60a8\u53ef\u80fd\u6703\u6536\u5230 HTTP 404 \u548c HTTP 500 \u7b49\u932f\u8aa4\u3002\n\u7136\u5f8c\uff0c\u8a2a\u554f\u8a72 IP \u5730\u5740\uff0c\u78ba\u5b9a\u80fd\u5426\u5728\u540c\u4e00\u8ca0\u8f09\u5747\u8861\u5668\u4e0a\u8a2a\u554f\u9019\u5169\u500b\u61c9\u7528\uff1a- \u8a2a\u554f`http://<IP_ADDRESS>/`\u4e26\u6ce8\u610f\u97ff\u61c9\u5305\u542b`Version: 1.0.0`\uff08\u56e0\u7232\u8a72\u8acb\u6c42\u88ab\u8def\u7531\u5230`web`Service\uff09\n- \u8a2a\u554f`http://<IP_ADDRESS>/v2/`\u4e26\u6ce8\u610f\u97ff\u61c9\u5305\u542b`Version: 2.0.0`\uff08\u56e0\u7232\u8a72\u8acb\u6c42\u88ab\u8def\u7531\u5230`web2`Service\uff09\nIngress \u7684 `path` \u5b57\u6bb5\u552f\u4e00\u652f\u6301\u7684\u901a\u914d\u7b26\u662f `*` \u5b57\u7b26\u3002 `*` \u5b57\u7b26\u5fc5\u9808\u7dca\u8ddf\u5728\u6b63\u659c\u7dda ( `/` ) \u4e4b\u5f8c\uff0c\u4e26\u4e14\u5fc5\u9808\u662f\u683c\u5f0f\u4e2d\u7684\u6700\u5f8c\u4e00\u500b\u5b57\u7b26\u3002\u4f8b\u5982\uff0c `/*` \u3001 `/foo/*` \u3001 `/foo/bar/*` \u662f\u6709\u6548\u683c\u5f0f\uff0c\u4f46 `*` \u3001 `/foo/bar*` \u3001 `/foo/*/bar` \u4e0d\u662f\u6709\u6548\u683c\u5f0f\u3002\n\u8f03\u5177\u9ad4\u7684\u683c\u5f0f\u512a\u5148\u65bc\u4e0d\u592a\u5177\u9ad4\u7684\u683c\u5f0f\u3002\u5982\u679c\u60a8\u540c\u6642\u64c1\u6709 `/foo/*` \u548c `/foo/bar/*` \uff0c\u5247\u9078\u64c7 `/foo/bar/bat` \u4f86\u5339\u914d `/foo/bar/*` \u3002\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u8def\u5f91\u9650\u5236\u548c\u683c\u5f0f\u5339\u914d\uff0c\u8acb\u53c3\u95b1 [\u7db2\u5740\u6620\u5c04\u6587\u6a94](https://cloud.google.com/load-balancing/docs/url-map?hl=zh-cn) \u3002## \uff08\u53ef\u9078\uff09\u76e3\u63a7\u670d\u52d9\u7684\u53ef\u7528\u6027\u548c\u5ef6\u9072\u6642\u9593Google Cloud [\u64a5\u6e2c](https://cloud.google.com/monitoring/uptime-checks?hl=zh-cn) \u5f9e\u7528\u6236\u7684\u89d2\u5ea6\u5c0d\u61c9\u7528\u9032\u884c\u9ed1\u76d2\u76e3\u63a7\uff0c\u78ba\u5b9a\u5f9e\u591a\u500b\u5916\u90e8 IP \u5230\u8ca0\u8f09\u5747\u8861\u5668 IP \u5730\u5740\u7684\u5ef6\u9072\u6642\u9593\u548c\u53ef\u7528\u6027\u3002\u76f8\u6bd4\u4e4b\u4e0b\uff0cGoogle Cloud \u5065\u5eb7\u6aa2\u67e5\u6703\u5c0d Pod IP \u57f7\u884c\u5167\u90e8\u6aa2\u67e5\uff0c\u78ba\u5b9a\u5be6\u4f8b\u7d1a\u5c64\u7684\u53ef\u7528\u6027\u3002\u9019\u5169\u9805\u6aa2\u67e5\u662f\u76f8\u8f14\u76f8\u6210\u7684\uff0c\u5b83\u5011\u53ef\u8b93\u60a8\u5168\u9762\u77ad\u89e3\u61c9\u7528\u7684\u904b\u884c\u72c0\u6cc1\u3002\n\u60a8\u53ef\u4ee5\u4f7f\u7528 Google Cloud \u63a7\u5236\u6aaf\u3001Cloud Monitoring API \u6216\u4f7f\u7528 Cloud Monitoring \u5ba2\u6236\u7aef\u5eab\u4f86\u5275\u5efa\u64a5\u6e2c\u3002 \u5982\u9700\u77ad\u89e3\u76f8\u95dc\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 [\u7ba1\u7406\u64a5\u6e2c](https://cloud.google.com/monitoring/uptime-checks?hl=zh-cn) \u3002 \u5982\u9700\u4f7f\u7528 Google Cloud \u63a7\u5236\u6aaf\u5275\u5efa\u64a5\u6e2c\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u8f49\u5230 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **Service \u548c Ingress** \u9801\u9762\u3002 [\u6253\u958b\u201cService \u548c Ingress\u201d](https://console.cloud.google.com/kubernetes/discovery?hl=zh-cn) \n- \u9ede\u64ca\u8981\u7232\u5176\u5275\u5efa\u64a5\u6e2c\u7684 Service \u7684\u540d\u7a31\u3002\n- \u9ede\u64ca **\u5275\u5efa\u64a5\u6e2c** \u3002\n- \u5728 **\u5275\u5efa\u64a5\u6e2c** \u7a97\u683c\u4e2d\uff0c\u8f38\u5165\u64a5\u6e2c\u7684\u6a19\u984c\uff0c\u7136\u5f8c\u9ede\u64ca **\u4e0b\u4e00\u6b65** \u524d\u5f80 **\u76ee\u6a19** \u8a2d\u7f6e\u3002\u64a5\u6e2c\u7684 **\u76ee\u6a19** \u5b57\u6bb5\u81ea\u52d5\u586b\u5145 Service \u8ca0\u8f09\u5e73\u8861\u5668\u4e2d\u7684\u4fe1\u606f\u3002\u5982\u9700\u67e5\u770b\u6709\u95dc\u64a5\u6e2c\u4e2d\u6240\u6709\u5b57\u6bb5\u7684\u5b8c\u6574\u6587\u6a94\uff0c\u8acb\u53c3\u95b1 [\u5275\u5efa\u64a5\u6e2c](https://cloud.google.com/monitoring/uptime-checks?hl=zh-cn#create) \u3002\n- \u9ede\u64ca **\u4e0b\u4e00\u6b65** \u524d\u5f80 **\u97ff\u61c9\u9a57\u8b49** \u8a2d\u7f6e\u3002\n- \u9ede\u64ca **\u4e0b\u4e00\u6b65** \u524d\u5f80 **\u63d0\u9192\u548c\u901a\u77e5** \u90e8\u5206\u3002\u5982\u9700\u76e3\u63a7\u64a5\u6e2c\uff0c\u60a8\u53ef\u4ee5\u5275\u5efa\u4e00\u500b\u63d0\u9192\u653f\u7b56\u6216\u67e5\u770b\u64a5\u6e2c\u4fe1\u606f\u4e2d\u5fc3\u3002\u5982\u679c\u60a8\u7684\u6b63\u5e38\u904b\u884c\u6642\u9593\u6aa2\u67e5\u5931\u6557\uff0c\u63d0\u9192\u653f\u7b56\u53ef\u4ee5\u901a\u904e\u96fb\u5b50\u90f5\u4ef6\u6216\u5176\u4ed6\u6e20\u9053\u901a\u77e5\u60a8\u3002\u5982\u9700\u77ad\u89e3\u6709\u95dc\u63d0\u9192\u653f\u7b56\u7684\u5e38\u898f\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 [\u63d0\u9192\u7c21\u4ecb](https://cloud.google.com/monitoring/alerts?hl=zh-cn) \u3002 **\u6ce8\u610f** \uff1a\u5728\u5275\u5efa\u6b63\u5e38\u904b\u884c\u6642\u9593\u6aa2\u67e5\u7684\u904e\u7a0b\u4e2d\uff0c\u60a8\u53ef\u4ee5\u7232\u6b63\u5e38\u904b\u884c\u6642\u9593\u6aa2\u67e5\u5275\u5efa\u63d0\u9192\u653f\u7b56\u3002\u5275\u5efa\u63d0\u9192\u653f\u7b56\u662f\u53ef\u9078\u64cd\u4f5c\uff0c\u4f46\u5efa\u8b70\u60a8\u9019\u6a23\u505a\u3002\u5982\u9700\u77ad\u89e3\u5982\u4f55\u4ee5\u7368\u7acb\u64cd\u4f5c\u7684\u5f62\u5f0f\u5275\u5efa\u63d0\u9192\u653f\u7b56\uff0c\u8acb\u53c3\u95b1 [\u64a5\u6e2c\u63d0\u9192](https://cloud.google.com/monitoring/uptime-checks/uptime-alerting-policies?hl=zh-cn) \n- \u9ede\u64ca **\u5275\u5efa** \u3002\n## \u5099\u8a3b\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cIngress \u901a\u904e\u5728 `/` \u8def\u5f91\u4e0a\u767c\u51fa `GET` \u8acb\u6c42\u4f86\u57f7\u884c\u5b9a\u671f\u5065\u5eb7\u6aa2\u67e5\uff0c\u4ee5\u78ba\u5b9a\u61c9\u7528\u7684\u5065\u5eb7\u72c0\u6cc1\uff0c\u4e26\u9810\u671f\u7372\u5f97 HTTP 200 \u97ff\u61c9\u3002\u5982\u679c\u8981\u6aa2\u67e5\u5176\u4ed6\u8def\u5f91\u6216\u9810\u671f\u7372\u5f97\u5176\u4ed6\u97ff\u61c9\u4ee3\u78bc\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 [\u81ea\u5b9a\u7fa9\u5065\u5eb7\u6aa2\u67e5\u8def\u5f91](https://cloud.google.com/kubernetes-engine/docs/concepts/ingress?hl=zh-cn#health_checks) \u3002\nIngress \u652f\u6301\u66f4\u9ad8\u7d1a\u7684\u7528\u4f8b\uff0c\u4f8b\u5982\uff1a- **\u57fa\u65bc\u540d\u7a31\u7684\u865b\u64ec\u8a17\u7ba1** \uff1a\u60a8\u53ef\u4ee5\u4f7f\u7528 Ingress \u5c0d\u591a\u500b\u57df\u540d\u3001\u5b50\u57df\u540d\u91cd\u8907\u4f7f\u7528\u8ca0\u8f09\u5747\u8861\u5668\uff0c\u4e26\u5728\u55ae\u500b IP \u5730\u5740\u548c\u8ca0\u8f09\u5747\u8861\u5668\u4e0a\u516c\u958b\u591a\u500b Service\u3002\u5982\u9700\u77ad\u89e3\u5982\u4f55\u7232\u9019\u4e9b\u4efb\u52d9\u914d\u7f6e Ingress\uff0c\u8acb\u67e5\u770b [\u7c21\u55ae\u6247\u51fa](https://kubernetes.io/docs/concepts/services-networking/ingress/#simple-fanout) \u548c [\u57fa\u65bc\u540d\u7a31\u7684\u865b\u64ec\u8a17\u7ba1](https://kubernetes.io/docs/concepts/services-networking/ingress/#name-based-virtual-hosting) \u793a\u4f8b\u3002\n- [HTTPS \u7d42\u6b62](https://cloud.google.com/compute/docs/load-balancing/http?hl=zh-cn#tls_support) \uff1a\u60a8\u53ef\u4f7f\u7528 Cloud Load Balancing \u8ca0\u8f09\u5747\u8861\u5668 [\u914d\u7f6e Ingress](https://kubernetes.io/docs/concepts/services-networking/ingress/#tls) \u4f86\u7d42\u6b62 HTTPS \u6d41\u91cf\u3002\n **\u6ce8\u610f\uff1a** \u8acb\u59cb\u7d42\u4f7f\u7528 Ingress \u5c0d\u8c61\u4fee\u6539\u8ca0\u8f09\u5747\u8861\u5668\u7684\u5c6c\u6027\u3002\u5982\u679c\u76f4\u63a5\u5728\u8ca0\u8f09\u5747\u8861\u8cc7\u6e90\u4e0a\u9032\u884c\u66f4\u6539\uff0c\u5247\u53ef\u80fd\u5c0e\u81f4\u66f4\u6539\u4e1f\u5931\u6216\u88ab GKE Ingress \u63a7\u5236\u5668\u66ff\u63db\u3002\n\u522a\u9664 Ingress \u5f8c\uff0cGKE Ingress \u63a7\u5236\u5668\u6703\u81ea\u52d5\u6e05\u7406\u76f8\u95dc\u8cc7\u6e90\uff08\u9810\u7559\u7684\u975c\u614b IP \u5730\u5740\u9664\u5916\uff09\u3002## \u6e05\u7406\u7232\u907f\u514d\u56e0\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528\u7684\u8cc7\u6e90\u5c0e\u81f4\u60a8\u7684 Google Cloud \u8cec\u865f\u7522\u751f\u8cbb\u7528\uff0c\u8acb\u522a\u9664\u5305\u542b\u9019\u4e9b\u8cc7\u6e90\u7684\u9805\u76ee\uff0c\u6216\u8005\u4fdd\u7559\u9805\u76ee\u4f46\u522a\u9664\u5404\u500b\u8cc7\u6e90\u3002- **\u522a\u9664\u6240\u6709\u624b\u52d5\u5275\u5efa\u7684\u8f49\u767c\u898f\u5247\u548c\u5f15\u7528 Ingress \u7684\u76ee\u6a19\u4ee3\u7406\uff1a** **\u6ce8\u610f** \uff1a\u50c5\u7576\u4f7f\u7528 Google Kubernetes Engine API \u6216 Google Cloud \u63a7\u5236\u6aaf\u624b\u52d5\u66f4\u65b0\u8207 Ingress \u95dc\u806f\u7684\u8ca0\u8f09\u5e73\u8861\u5668\u6642\uff0c\u624d\u9700\u8981\u57f7\u884c\u6b64\u6b65\u9a5f\u3002\u5f15\u7528 Ingress \u63a7\u5236\u5668\u8a17\u7ba1\u7684\u7db2\u5740\u6620\u5c04\u7684\u61f8\u5782\u76ee\u6a19\u4ee3\u7406\u5c07\u5c0e\u81f4 GKE 1.15.4-gke.22+ \u7248\u672c\u4e2d\u7684 GKE Ingress \u522a\u9664\u5931\u6557\u3002\u60a8\u53ef\u4ee5\u6aa2\u67e5 Ingress \u8cc7\u6e90\uff0c\u4ee5\u67e5\u627e\u5305\u542b\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\u7684\u932f\u8aa4\u6d88\u606f\u7684\u4e8b\u4ef6\uff1a```\n Error during GC: error running load balancer garbage collection routine: googleapi: Error 400: The url_map resource 'projects/project-id/global/urlMaps/k8s2-um-tlw9rhgp-default-my-ingress-9ifnni82' is already being used by 'projects/project-id/global/targetHttpsProxies/k8s2-um-tlw9rhgp-default-my82-target-proxy', resourceInUseByAnotherResource\n \n```\u5728\u4e0a\u9762\u7684\u932f\u8aa4\u6d88\u606f\u4e2d\uff0c `k8s2-um-tlw9rhgp-default-my82-target-proxy` \u662f\u4e00\u500b\u624b\u52d5\u5275\u5efa\u7684\u76ee\u6a19 https \u4ee3\u7406\uff0c\u8a72\u4ee3\u7406\u4ecd\u7136\u5f15\u7528\u7531 Ingress \u63a7\u5236\u5668\u5275\u5efa\u548c\u7ba1\u7406\u7684\u7db2\u5740\u6620\u5c04 `k8s2-um-tlw9rhgp-default-my-ingress-9ifnni82` \u3002\u5728\u522a\u9664 Ingress \u4e4b\u524d\uff0c\u5fc5\u9808\u5148\u522a\u9664\u9019\u4e9b\u624b\u52d5\u5275\u5efa\u7684\u524d\u7aef\u8cc7\u6e90\uff08\u5305\u62ec\u8f49\u767c\u898f\u5247\u548c\u76ee\u6a19\u4ee3\u7406\uff09\u3002\n- **\u522a\u9664 Ingress** \uff1a\u6b64\u6b65\u9a5f\u5c07\u91cb\u653e\u81e8\u6642\u5916\u90e8 IP \u5730\u5740\u548c\u8207\u60a8\u7684\u61c9\u7528\u95dc\u806f\u7684\u8ca0\u8f09\u5747\u8861\u8cc7\u6e90\uff1a```\nkubectl delete ingress basic-ingress\n```\u5982\u679c\u60a8\u9075\u5faa\u53ef\u9078\u7684\u6b65\u9a5f\u5275\u5efa Ingress \u4ee5\u6309\u8def\u5f91\u8def\u7531\u8acb\u6c42\uff0c\u5247\u8acb\u522a\u9664 Ingress\uff1a```\nkubectl delete ingress fanout-ingress\n```\n- **\u522a\u9664\u975c\u614b IP \u5730\u5740** \uff1a\u50c5\u5728\u60a8\u9075\u5faa\u4e86\u53ef\u9078\u6b65\u9a5f\u4f86\u5275\u5efa\u975c\u614b IP \u5730\u5740\u6642\uff0c\u624d\u9700\u8981\u5b8c\u6210\u6b64\u6b65\u9a5f\u3002- \u5982\u679c\u60a8\u5df2\u6309\u7167\u201c\u9078\u9805 1\u201d\u5c07\u73fe\u6709\u81e8\u6642 IP \u5730\u5740\u8f49\u63db\u7232\u975c\u614b IP \u5730\u5740\uff0c\u8acb\u8a2a\u554f [Google Cloud \u63a7\u5236\u6aaf](https://console.cloud.google.com/networking/addresses/list?hl=zh-cn) \u4f86\u522a\u9664\u8a72\u975c\u614b IP \u5730\u5740\u3002\n- \u5982\u679c\u60a8\u5df2\u6309\u7167\u201c\u9078\u9805 2\u201d\u5275\u5efa\u65b0\u7684\u975c\u614b IP \u5730\u5740\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4f86\u522a\u9664\u975c\u614b IP \u5730\u5740\uff1a```\ngcloud compute addresses delete web-static-ip --global\n```\n- **\u522a\u9664\u96c6\u7fa3** \uff1a\u6b64\u6b65\u9a5f\u5c07\u522a\u9664\u5bb9\u5668\u96c6\u7fa3\u7684 [\u8a08\u7b97\u7bc0\u9ede](https://cloud.google.com/compute?hl=zh-cn) \u4ee5\u53ca\u96c6\u7fa3\u4e2d\u7684 Deployment \u7b49\u5176\u4ed6\u8cc7\u6e90\uff1a```\ngcloud container clusters delete loadbalancedcluster\n```\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u5982\u9700\u8a73\u7d30\u77ad\u89e3 Ingress \u529f\u80fd\uff0c\u8acb\u67e5\u770b [Ingress \u7528\u6236\u6307\u5357](https://kubernetes.io/docs/concepts/services-networking/ingress/) \u3002\n- \u4f7f\u7528 Ingress \u7232 Ingress \u61c9\u7528\u914d\u7f6e [\u975c\u614b IP \u548c\u57df\u540d](https://cloud.google.com/kubernetes-engine/docs/tutorials/configuring-domain-name-static-ip?hl=zh-cn) \u3002\n- \u7232 Ingress \u8ca0\u8f09\u5747\u8861\u5668\u914d\u7f6e [SSL \u8b49\u66f8](https://cloud.google.com/kubernetes-engine/docs/how-to/ingress-multi-ssl?hl=zh-cn) \u3002\n- \u77ad\u89e3\u5982\u4f55 [\u5c07 Google \u7ba1\u7406\u7684 SSL \u8b49\u66f8\u8207 Ingress \u642d\u914d\u4f7f\u7528](https://cloud.google.com/kubernetes-engine/docs/how-to/managed-certs?hl=zh-cn) \u3002\n- \u5982\u679c\u61c9\u7528\u5728\u4e0d\u540c\u5340\u57df\u7684\u591a\u500b Kubernetes Engine \u96c6\u7fa3\u4e0a\u904b\u884c\uff0c\u8acb\u8a2d\u7f6e [\u591a\u96c6\u7fa3 Ingress](https://cloud.google.com/kubernetes-engine/docs/how-to/multi-cluster-ingress?hl=zh-cn) \uff0c\u4ee5\u5c07\u6d41\u91cf\u8def\u7531\u5230\u96e2\u7528\u6236\u6700\u8fd1\u7684\u5340\u57df\u4e2d\u7684\u96c6\u7fa3\u3002\n- \u700f\u89bd\u5176\u4ed6 [Kubernetes Engine \u6559\u7a0b](https://cloud.google.com/kubernetes-engine/docs/tutorials?hl=zh-cn) \u3002\n- \u63a2\u7d22\u6709\u95dc Google Cloud \u7684\u53c3\u8003\u67b6\u69cb\u3001\u5716\u8868\u548c\u6700\u4f73\u5be6\u8e10\u3002\u67e5\u770b\u6211\u5011\u7684 [Cloud Architecture Center](https://cloud.google.com/architecture?hl=zh-cn) \u3002", "guide": "Google Kubernetes Engine (GKE)"}