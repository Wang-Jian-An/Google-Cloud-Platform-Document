{"title": "Google Kubernetes Engine (GKE) - \u8de8 VPC \u7db2\u7d61\u5275\u5efa\u5167\u90e8\u8ca0\u8f09\u5747\u8861\u5668", "url": "https://cloud.google.com/kubernetes-engine/docs/how-to/internal-load-balancing-across-vpc-net?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - \u8de8 VPC \u7db2\u7d61\u5275\u5efa\u5167\u90e8\u8ca0\u8f09\u5747\u8861\u5668\n\u672c\u9801\u9762\u4ecb\u7d39\u5982\u4f55\u8de8 VPC \u7db2\u7d61\u5728 Google Kubernetes Engine (GKE) \u4e0a\u5275\u5efa [\u5167\u90e8\u76f4\u901a\u5f0f\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668](https://cloud.google.com/compute/docs/load-balancing/internal?hl=zh-cn) \u3002\u5728\u95b1\u8b80\u672c\u9801\u9762\u4e4b\u524d\uff0c\u60a8\u61c9\u8a72\u5148\u719f\u6089\u4ee5\u4e0b\u6982\u5ff5\uff1a\n- [LoadBalancer \u670d\u52d9](https://cloud.google.com/kubernetes-engine/docs/concepts/service-load-balancer?hl=zh-cn) \u3002\n- [LoadBalancer Service \u53c3\u6578](https://cloud.google.com/kubernetes-engine/docs/concepts/service-load-balancer-parameters?hl=zh-cn) \u3002\n- [Private Service Connect](https://cloud.google.com/vpc/docs/private-service-connect?hl=zh-cn) \u3002", "content": "## \u6e96\u5099\u5de5\u4f5c\n\u5728\u958b\u59cb\u4e4b\u524d\uff0c\u8acb\u78ba\u4fdd\u60a8\u5df2\u57f7\u884c\u4ee5\u4e0b\u4efb\u52d9\uff1a\n- \u5553\u7528 Google Kubernetes Engine API\u3002\n- [  \u5553\u7528 Google Kubernetes Engine API ](https://console.cloud.google.com/flows/enableapi?apiid=container.googleapis.com&hl=zh-cn) \n- \u5982\u679c\u60a8\u8981\u4f7f\u7528 Google Cloud CLI \u57f7\u884c\u6b64\u4efb\u52d9\uff0c\u8acb [\u5b89\u88dd](https://cloud.google.com/sdk/docs/install?hl=zh-cn) \u4e26 [\u521d\u59cb\u5316](https://cloud.google.com/sdk/docs/initializing?hl=zh-cn) gcloud CLI\u3002 \u5982\u679c\u60a8\u4e4b\u524d\u5b89\u88dd\u4e86 gcloud CLI\uff0c\u8acb\u904b\u884c`gcloud components update`\u4ee5\u7372\u53d6\u6700\u65b0\u7248\u672c\u3002 **\u6ce8\u610f** \uff1a\u5c0d\u65bc\u73fe\u6709 gcloud CLI \u5b89\u88dd\uff0c\u8acb\u52d9\u5fc5\u8a2d\u7f6e`compute/region`\u548c`compute/zone` [\u5c6c\u6027](https://cloud.google.com/sdk/docs/properties?hl=zh-cn#setting_properties) \u3002\u901a\u904e\u8a2d\u7f6e\u9ed8\u8a8d\u4f4d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u907f\u514d gcloud CLI \u4e2d\u51fa\u73fe\u4ee5\u4e0b\u932f\u8aa4\uff1a`One of [--zone, --region] must be supplied: Please specify location`\u3002## \u4f7f\u7528 Private Service Connect \u5275\u5efa\u5167\u90e8\u8ca0\u8f09\u5747\u8861\u5668\n\u4f5c\u7232\u670d\u52d9\u63d0\u4f9b\u65b9\uff0c\u60a8\u53ef\u4ee5\u85c9\u52a9\u670d\u52d9\u9023\u63a5\uff0c\u901a\u904e [Private Service Connect](https://cloud.google.com/vpc/docs/private-service-connect?hl=zh-cn) \u5c07\u670d\u52d9\u63d0\u4f9b\u7d66\u5176\u4ed6 VPC \u7db2\u7d61\u4e2d\u7684\u670d\u52d9\u4f7f\u7528\u65b9\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528 `ServiceAttachment` \u81ea\u5b9a\u7fa9\u8cc7\u6e90\u5275\u5efa\u3001\u7ba1\u7406\u548c\u522a\u9664\u670d\u52d9\u9023\u63a5\u3002\n### \u8981\u6c42\u548c\u9650\u5236\n- \u9700\u8981\u9075\u5faa [Private Service Connect](https://cloud.google.com/vpc/docs/about-vpc-hosted-services?hl=zh-cn#limitations) \u7684\u9650\u5236\u3002\n- \u60a8\u53ef\u4ee5\u5728 GKE 1.21.4-gke.300 \u53ca\u66f4\u9ad8\u7248\u672c\u4e2d\u5275\u5efa\u670d\u52d9\u9023\u63a5\u3002\n- \u60a8\u4e0d\u80fd\u5728\u591a\u500b\u670d\u52d9\u9023\u63a5\u914d\u7f6e\u4e2d\u4f7f\u7528\u540c\u4e00\u500b\u5b50\u7db2\u3002\n- \u60a8\u5fc5\u9808\u5275\u5efa\u4f7f\u7528\u5167\u90e8\u76f4\u901a\u5f0f\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u7684 GKE \u670d\u52d9\u3002\n- \u60a8\u4e0d\u80fd\u7232 1.22.4-gke.100 \u4e4b\u524d\u7684 GKE \u7248\u672c\u6307\u5b9a\u5176\u4ed6\u9805\u76ee\uff08\u5171\u4eab VPC\uff09\u4e2d\u7684\u5b50\u7db2\u3002\u5c0d\u65bc\u5171\u4eab VPC\uff0c\u8acb\u78ba\u4fdd\u6eff\u8db3 [\u5171\u4eab VPC \u7684\u6240\u6709\u8981\u6c42](https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-shared-vpc?hl=zh-cn#before_you_begin) \u3002\n### \u5275\u5efa ServiceAttachment\n- \u5275\u5efa\u5b50\u7db2\u3002\u60a8\u5fc5\u9808\u7232\u6bcf\u500b `ServiceAttachment` \u5275\u5efa\u4e00\u500b [\u65b0\u5b50\u7db2](https://cloud.google.com/vpc/docs/configure-private-service-connect-producer?hl=zh-cn#add-subnet-psc) \u3002```\ngcloud beta compute networks subnets create SUBNET_NAME \\\u00a0 \u00a0 --project PROJECT_ID \\\u00a0 \u00a0 --network NETWORK_NAME \\\u00a0 \u00a0 --region REGION \\\u00a0 \u00a0 --range SUBNET_RANGE \\\u00a0 \u00a0 --purpose PRIVATE_SERVICE_CONNECT\n```\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u65b0\u5b50\u7db2\u7684\u540d\u7a31\u3002 \u5728 GKE 1.22.4-gke.100 \u53ca\u66f4\u9ad8\u7248\u672c\u4e2d\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u6b64\u5b57\u6bb5\u7684\u5b8c\u5168\u9650\u5b9a\u8cc7\u6e90\u7db2\u5740\u4f86\u6307\u5b9a\u5176\u4ed6\u9805\u76ee\u4e2d\u7684\u5b50\u7db2\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528 [gcloud compute networks subnets describe](https://cloud.google.com/sdk/gcloud/reference/compute/networks/subnets/describe?hl=zh-cn) \u547d\u4ee4\u7372\u53d6\u5b8c\u5168\u9650\u5b9a\u7684\u8cc7\u6e90\u7db2\u5740\u3002\n- ``\uff1a\u60a8\u7684 Google Cloud \u9805\u76ee\u7684 ID\u3002\n- ``\uff1a\u5b50\u7db2\u7684 VPC \u7db2\u7d61\u7684\u540d\u7a31\u3002\n- ``\uff1a\u65b0\u5b50\u7db2\u7684\u5340\u57df\u3002\u60a8\u5fc5\u9808\u4f7f\u7528\u60a8\u5275\u5efa\u7684\u670d\u52d9\u6240\u5728\u7684\u5340\u57df\u3002\n- ``\uff1a\u8981\u7528\u65bc\u5b50\u7db2\u7684 IP \u5730\u5740\u7bc4\u570d\u3002\n- \u90e8\u7f72\u5de5\u4f5c\u8ca0\u8f09\u3002\u4ee5\u4e0b\u6e05\u55ae\u63cf\u8ff0\u4e86\u4e00\u500b\u904b\u884c\u793a\u4f8b Web \u61c9\u7528\u5bb9\u5668\u6620\u50cf\u7684 Deployment\u3002\u5c07\u6e05\u55ae\u4fdd\u5b58\u7232 `my-deployment.yaml` \uff1a```\napiVersion: apps/v1kind: Deploymentmetadata:\u00a0 name: psc-ilbspec:\u00a0 replicas: 3\u00a0 selector:\u00a0 \u00a0 matchLabels:\u00a0 \u00a0 \u00a0 app: psc-ilb\u00a0 template:\u00a0 \u00a0 metadata:\u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 app: psc-ilb\u00a0 \u00a0 spec:\u00a0 \u00a0 \u00a0 containers:\u00a0 \u00a0 \u00a0 - name: whereami\u00a0 \u00a0 \u00a0 \u00a0 image: us-docker.pkg.dev/google-samples/containers/gke/whereami:v1.2.19\u00a0 \u00a0 \u00a0 \u00a0 ports:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - name: http\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 containerPort: 8080\u00a0 \u00a0 \u00a0 \u00a0 readinessProbe:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 httpGet:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 path: /healthz\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 port: 8080\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 scheme: HTTP\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 initialDelaySeconds: 5\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 timeoutSeconds: 1\n```\n- \u5c07\u6e05\u55ae\u61c9\u7528\u5230\u60a8\u7684\u96c6\u7fa3\uff1a```\nkubectl apply -f my-deployment.yaml\n```\n- \u5275\u5efa\u4e00\u9805\u670d\u52d9\u3002\u4ee5\u4e0b\u6e05\u55ae\u63cf\u8ff0\u4e86\u4e00\u9805\u5728 TCP \u7aef\u53e3 8080 \u4e0a\u5275\u5efa\u5167\u90e8\u76f4\u901a\u5f0f\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u7684\u670d\u52d9\u3002\u5c07\u6e05\u55ae\u4fdd\u5b58\u7232 `my-service.yaml` \uff1a```\n\u00a0apiVersion: v1\u00a0kind: Service\u00a0metadata:\u00a0 \u00a0name: SERVICE_NAME\u00a0 \u00a0annotations:\u00a0 \u00a0 \u00a0networking.gke.io/load-balancer-type: \"Internal\"\u00a0spec:\u00a0 \u00a0type: LoadBalancer\u00a0 \u00a0selector:\u00a0 \u00a0 \u00a0app: psc-ilb\u00a0 \u00a0ports:\u00a0 \u00a0- port: 80\u00a0 \u00a0 \u00a0targetPort: 8080\u00a0 \u00a0 \u00a0protocol: TCP\n```\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u65b0\u670d\u52d9\u7684\u540d\u7a31\u3002\n- \u5c07\u6e05\u55ae\u61c9\u7528\u5230\u60a8\u7684\u96c6\u7fa3\uff1a```\nkubectl apply -f my-service.yaml\n```\n- \u5275\u5efa `ServiceAttachment` \u3002\u4ee5\u4e0b\u6e05\u55ae\u63cf\u8ff0\u4e86\u5411\u670d\u52d9\u4f7f\u7528\u65b9\u516c\u958b\u60a8\u5275\u5efa\u7684\u670d\u52d9\u7684 `ServiceAttachment` \u3002\u5c07\u6e05\u55ae\u4fdd\u5b58\u7232 `my-psc.yaml` \uff1a```\napiVersion: networking.gke.io/v1kind: ServiceAttachmentmetadata:\u00a0name: SERVICE_ATTACHMENT_NAME\u00a0namespace: defaultspec:\u00a0connectionPreference: ACCEPT_AUTOMATIC\u00a0natSubnets:\u00a0- SUBNET_NAME\u00a0proxyProtocol: false\u00a0resourceRef:\u00a0 \u00a0kind: Service\u00a0 \u00a0name: SERVICE_NAME\n``` **\u6ce8\u610f** \uff1a\u5c0d\u65bc\u4f4e\u65bc 1.23.3-gke.900 \u7684 GKE \u7248\u672c\uff0c\u8acb\u4f7f\u7528 `networking.gke.io/v1beta1` \u800c\u4e0d\u662f `networking.gke.io/v1` \u3002\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u65b0\u670d\u52d9\u9023\u63a5\u7684\u540d\u7a31\u3002\n- ``\uff1a\u65b0\u5b50\u7db2\u7684\u540d\u7a31\u3002\u5728 GKE 1.22.4-gke.100 \u53ca\u66f4\u9ad8\u7248\u672c\u4e2d\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u6b64\u5b57\u6bb5\u7684\u5b8c\u5168\u9650\u5b9a\u8cc7\u6e90\u7db2\u5740\u4f86\u6307\u5b9a\u5176\u4ed6\u9805\u76ee\u4e2d\u7684\u5b50\u7db2\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528 [gcloud compute networks subnets describe](https://cloud.google.com/sdk/gcloud/reference/compute/networks/subnets/describe?hl=zh-cn) \u547d\u4ee4\u7372\u53d6\u5b8c\u5168\u9650\u5b9a\u7684\u8cc7\u6e90\u7db2\u5740\u3002 \u5c0d\u65bc\u5171\u4eab VPC \u914d\u7f6e\uff0c\u8acb\u4f7f\u7528\u4ee5\u4e0b\u683c\u5f0f\uff1a`projects/` `` `/regions/` `` `/subnetworks/` ``\u3002\n **\u6ce8\u610f** \uff1a\u5728 GKE \u63a7\u5236\u5668\u5275\u5efa\u670d\u52d9\u5b9a\u7fa9\u7684\u5167\u90e8\u76f4\u901a\u5f0f\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u4e4b\u524d\uff0c `ServiceAttachment` \u8cc7\u6e90\u5c07\u5305\u542b\u932f\u8aa4\u4e8b\u4ef6\u3002\u9810\u914d\u5167\u90e8\u76f4\u901a\u5f0f\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u5f8c\uff0c\u9019\u4e9b\u932f\u8aa4\u5c07\u4e0d\u518d\u767c\u5e03\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u6e05\u55ae\u5b57\u6bb5\uff0c\u8acb\u53c3\u95b1 [\u670d\u52d9\u9023\u63a5\u5b57\u6bb5](#fields) \u3002\n- \u5c07\u6e05\u55ae\u61c9\u7528\u5230\u60a8\u7684\u96c6\u7fa3\uff1a```\nkubectl apply -f my-psc.yaml\n```\n- \u9a57\u8b49 Private Service Connect \u63a7\u5236\u5668\u662f\u5426\u5df2\u5275\u5efa\u670d\u52d9\u9023\u63a5\uff1a```\ngcloud beta compute service-attachments list\n```\u8f38\u51fa\u6703\u986f\u793a\u5177\u6709\u81ea\u52d5\u751f\u6210\u7684\u540d\u7a31\u7684\u670d\u52d9\u9023\u63a5\uff1a```\nNAME  REGION  PRODUCER_FORWARDING_RULE   CONNECTION_PREFERENCE\nk8s1-sa-... REGION_NAME a3fea439c870148bdba5e59c9ea9451a ACCEPT_AUTOMATIC\n```\n### \u67e5\u770b ServiceAttachment\n\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b `ServiceAttachment` \u7684\u8a73\u7d30\u4fe1\u606f\uff1a\n```\nkubectl describe serviceattachment SERVICE_ATTACHMENT_NAME\n```\n\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a\n```\n kubectl describe serviceattachment foo-sa\nName:  <sa-name>\nNamespace: default\nLabels:  <none>\nAnnotations: <none>\nAPI Version: networking.gke.io/v1beta1\nKind:   ServiceAttachment\nMetadata:\n ...\nStatus:\n Forwarding Rule URL:  https://www.googleapis.com/compute/beta/projects/<project>/regions/<region>/forwardingRules/<fr-name>\n Last Modified Timestamp: 2021-07-08T01:32:39Z\n Service Attachment URL: https://www.googleapis.com/compute/beta/projects/<projects>/regions/<region>/serviceAttachments/<gce-service-attachment-name>\nEvents:      <none>\n```\n### \u4f7f\u7528 ServiceAttachment\n\u5982\u9700\u4f7f\u7528\u5176\u4ed6\u9805\u76ee\u4e2d\u7684\u670d\u52d9\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u6b65\u9a5f\uff1a\n- \u7372\u53d6 `ServiceAttachment` \u7684\u7db2\u5740\uff1a```\nkubectl get serviceattachment SERVICE_ATTACHMENT_NAME -o=jsonpath=\"{.status.serviceAttachmentURL}\"\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\n serviceAttachmentURL: https://www.googleapis.com/compute/alpha/projects/<project>/region/<region>/serviceAttachments/k8s1-...my-sa\n```\n- \u4f7f\u7528 `ServiceAttachment` \u7684\u7db2\u5740 [\u5275\u5efa Private Service Connect \u7aef\u9ede](https://cloud.google.com/vpc/docs/configure-private-service-connect-services?hl=zh-cn#create-endpoint) \u3002\n- \u5f9e\u4f7f\u7528\u65b9\u9805\u76ee\u4e2d\u7684\u865b\u64ec\u6a5f\u4f7f\u7528 `curl` \u547d\u4ee4\uff0c\u9a57\u8b49\u60a8\u53ef\u4ee5\u9023\u63a5\u5230\u5728\u63d0\u4f9b\u65b9\u9805\u76ee\u4e2d\u90e8\u7f72\u7684 Service\uff1a```\ncurl PSC_IP_ADDRESS\n```\u5c07 `` \u66ff\u63db\u7232\u4f7f\u7528\u65b9\u9805\u76ee\u4e2d\u8f49\u767c\u898f\u5247\u7684 IP \u5730\u5740\u3002\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\n{\n \"cluster_name\":\"cluster\",\n \"host_header\":\"10.128.15.200\",\n \"node_name\":\"gke-psc-default-pool-be9b6e0e-dvxg.c.gke_project.internal\",\n \"pod_name\":\"foo-7bf648dcfd-l5jf8\",\n \"pod_name_emoji\":\"\ud83d\udc5a\",\n \"project_id\":\"gke_project\",\n \"timestamp\":\"2021-06-29T21:32:03\",\n \"zone\":\"ZONE_NAME\"\n}\n```\n### \u66f4\u65b0 ServiceAttachment\n\u60a8\u53ef\u4ee5\u6309\u7167\u4ee5\u4e0b\u6b65\u9a5f\u66f4\u65b0 `ServiceAttachment` \uff1a\n**\u6ce8\u610f** \uff1a\u60a8\u7121\u6cd5\u66f4\u65b0 `resourceRef` \u5b57\u6bb5\uff0c\u53ea\u80fd\u5411 `natSubnets` \u5b57\u6bb5\u6dfb\u52a0\u5b50\u7db2\u3002\u60a8\u7121\u6cd5\u79fb\u9664\u5b50\u7db2\u3002\u5982\u679c\u60a8\u9700\u8981\u66f4\u65b0 `resourceRef` \u5b57\u6bb5\u6216\u5f9e `natSubnets` \u5b57\u6bb5\u4e2d\u79fb\u9664\u5b50\u7db2\uff0c\u5247\u5fc5\u9808\u522a\u9664 `ServiceAttachment` \uff0c\u7136\u5f8c\u91cd\u65b0\u5275\u5efa\u3002\n- \u4fee\u6539 `my-psc.yaml` \u4e2d\u7684 `ServiceAttachment` \u6e05\u55ae\uff1a```\napiVersion: networking.gke.io/v1kind: ServiceAttachmentmetadata:\u00a0 name: my-sa\u00a0 namespace: defaultspec:\u00a0 connectionPreference: ACCEPT_AUTOMATIC\u00a0 natSubnets:\u00a0 - my-nat-subnet\u00a0 proxyProtocol: false\u00a0 resourceRef:\u00a0 \u00a0 kind: Service\u00a0 \u00a0 name: ilb-service\n``` **\u6ce8\u610f** \uff1a\u5c0d\u65bc\u4f4e\u65bc 1.23.3-gke.900 \u7684 GKE \u7248\u672c\uff0c\u8acb\u4f7f\u7528 `networking.gke.io/v1beta1` \u800c\u4e0d\u662f `networking.gke.io/v1` \u3002\n- \u5c07\u6e05\u55ae\u61c9\u7528\u5230\u60a8\u7684\u96c6\u7fa3\uff1a```\nkubectl apply -f my-psc.yaml\n```\n### \u522a\u9664 ServiceAttachment\n\u60a8\u7121\u6cd5\u522a\u9664\u9023\u63a5\u5230\u670d\u52d9\u9023\u63a5\u7684\u5167\u90e8\u76f4\u901a\u5f0f\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u3002\u60a8\u5fc5\u9808\u55ae\u7368\u522a\u9664\u670d\u52d9\u9023\u63a5\u548c GKE Service\u3002\n- \u522a\u9664\u670d\u52d9\u9023\u63a5\uff1a```\nkubectl delete serviceattachment SERVICE_ATTACHMENT_NAME --wait=false\n```\u6b64\u547d\u4ee4\u5c07\u670d\u52d9\u9023\u63a5\u6a19\u8a18\u7232\u522a\u9664\uff0c\u4f46\u8cc7\u6e90\u4ecd\u7136\u5b58\u5728\u3002\u60a8\u4e5f\u53ef\u4ee5\u901a\u904e\u7701\u7565 `--wait` \u6a19\u8a8c\u4f86\u7b49\u5f85\u522a\u9664\u5b8c\u6210\u3002\n- \u522a\u9664 Service\uff1a```\nkubectl delete svc SERVICE_NAME\n```\n- \u522a\u9664\u5b50\u7db2\uff1a```\ngcloud compute networks subnets delete SUBNET_NAME\n```## ServiceAttachment \u5b57\u6bb5\u6578\n`ServiceAttachment` \u5177\u6709\u4ee5\u4e0b\u5b57\u6bb5\uff1a\n- `connectionPreference`\uff1a\u7528\u65bc\u78ba\u5b9a\u5ba2\u6236\u5982\u4f55\u9023\u63a5\u5230\u670d\u52d9\u7684\u9023\u63a5\u504f\u597d\u8a2d\u7f6e\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528`ACCEPT_AUTOMATIC`\u81ea\u52d5\u9805\u76ee\u5be9\u6279\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528`ACCEPT_MANUAL`\u660e\u78ba\u9032\u884c\u9805\u76ee\u5be9\u6279\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528 Private Service Connect \u767c\u4f48\u670d\u52d9](https://cloud.google.com/vpc/docs/configure-private-service-connect-producer?hl=zh-cn) \u3002\n- `natSubnets`\uff1a\u7528\u65bc\u670d\u52d9\u9023\u63a5\u7684\u5b50\u7db2\u8cc7\u6e90\u540d\u7a31\u5217\u8868\u3002\n- `proxyProtocol`\uff1a\u5982\u679c\u8a2d\u7f6e\u7232 true\uff0c\u5247\u8acb\u6c42\u4e2d\u63d0\u4f9b\u4f7f\u7528\u65b9\u4f86\u6e90 IP \u548c Private Service Connect \u9023\u63a5 ID\u3002\u9019\u662f\u53ef\u9078\u5b57\u6bb5\uff0c\u5982\u679c\u672a\u63d0\u4f9b\uff0c\u5247\u9ed8\u8a8d\u7232 false\u3002\n- `consumerAllowList`\uff1a\u5141\u8a31\u9023\u63a5\u5230`ServiceAttachment`\u7684\u4f7f\u7528\u65b9\u9805\u76ee\u5217\u8868\u3002\u50c5\u7576`connectionPreference`\u7232`ACCEPT_MANUAL`\u6642\u624d\u80fd\u4f7f\u7528\u6b64\u5b57\u6bb5\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u6b64\u5b57\u6bb5\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528 Private Service Connect \u767c\u4f48\u670d\u52d9](https://cloud.google.com/vpc/docs/configure-private-service-connect-producer?hl=zh-cn) \u3002- `project`\uff1a\u4f7f\u7528\u65b9\u9805\u76ee\u7684\u9805\u76ee ID \u6216\u7de8\u865f\u3002\n- `connectionLimit`\uff1a\u4f7f\u7528\u65b9\u9805\u76ee\u7684\u9023\u63a5\u9650\u5236\u3002\u6b64\u5b57\u6bb5\u662f\u53ef\u9078\u5b57\u6bb5\u3002\n- `forceSendFields`\uff1a\u8981\u767c\u9001\u4ee5\u5305\u542b\u5728 API \u8acb\u6c42\u4e2d\u7684\u5b57\u6bb5\u540d\u7a31\u3002\u6b64\u5b57\u6bb5\u662f\u53ef\u9078\u5b57\u6bb5\u3002\n- `nullFields`\uff1a\u8981\u5305\u542b\u5728\u5177\u6709 null \u503c\u7684 API \u8acb\u6c42\u4e2d\u7684\u5b57\u6bb5\u540d\u7a31\u3002\u6b64\u5b57\u6bb5\u662f\u53ef\u9078\u5b57\u6bb5\u3002\n- `consumerRejectList`\uff1a\u4e0d\u5141\u8a31\u9023\u63a5\u5230`ServiceAttachment`\u7684\u4f7f\u7528\u65b9\u9805\u76ee ID \u6216\u7de8\u865f\u5217\u8868\u3002\u50c5\u7576`connectionPreference`\u7232`ACCEPT_MANUAL`\u6642\u624d\u80fd\u4f7f\u7528\u6b64\u5b57\u6bb5\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u6b64\u5b57\u6bb5\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528 Private Service Connect \u767c\u4f48\u670d\u52d9](https://cloud.google.com/vpc/docs/configure-private-service-connect-producer?hl=zh-cn) \u3002\n- `resourceRef` \uff1a\u5c0d Kubernetes \u8cc7\u6e90\u7684\u5f15\u7528\u3002- `kind`\uff1aKubernetes \u8cc7\u6e90\u985e\u578b\u3002\u60a8\u5fc5\u9808\u4f7f\u7528`Service`\u3002\n- `name`\uff1aKubernetes \u8cc7\u6e90\u7684\u540d\u7a31\uff0c\u8a72\u8cc7\u6e90\u5fc5\u9808\u8207\u5167\u90e8\u76f4\u901a\u5f0f\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u4f4d\u65bc\u540c\u4e00\u547d\u540d\u7a7a\u9593\u4e2d\u3002\n **\u6ce8\u610f** \uff1a\u670d\u52d9\u9023\u63a5\u8207\u5167\u90e8\u76f4\u901a\u5f0f\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u9023\u63a5\u5f8c\uff0c\u60a8\u7121\u6cd5\u522a\u9664\u6216\u66f4\u65b0\u5167\u90e8\u76f4\u901a\u5f0f\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u3002\u5982\u679c\u60a8\u5617\u8a66\u522a\u9664\u6216\u66f4\u65b0\u5167\u90e8\u76f4\u901a\u5f0f\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\uff0c\u7cfb\u7d71\u6703\u986f\u793a\u932f\u8aa4\u6d88\u606f\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u554f\u984c\u6392\u67e5](#psc-troubleshooting) \u3002## \u554f\u984c\u6392\u67e5\n\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\u932f\u8aa4\u6d88\u606f\uff1a\n```\nkubectl get events -n NAMESPACE\n```\n\u5c07 `` \u66ff\u63db\u7232\u5167\u90e8\u76f4\u901a\u5f0f\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u7684\u547d\u540d\u7a7a\u9593\u3002\n\u5982\u679c\u60a8\u5617\u8a66\u522a\u9664\u670d\u52d9\u9023\u63a5\u6b63\u5728\u4f7f\u7528\u7684\u5167\u90e8\u76f4\u901a\u5f0f\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\uff0c\u5247\u6703\u51fa\u73fe\u5982\u4e0b\u6240\u793a\u7684\u932f\u8aa4\u6d88\u606f\u3002\u60a8\u5fc5\u9808\u5148\u522a\u9664 `ServiceAttachment` \uff0c\u7136\u5f8c\u624d\u80fd\u522a\u9664\u5167\u90e8\u76f4\u901a\u5f0f\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u3002\n```\nError syncing load balancer: failed to ensure load balancer: googleapi:\nError 400: The forwarding_rule resource '<fwd-rule-URL>' is already being used\nby '<svc-attachment-URL>', resourceInUseByAnotherResource.\n```\n## \u5f8c\u7e8c\u6b65\u9a5f\n- [\u95b1\u8b80 GKE \u7db2\u7d61\u6982\u89bd](https://cloud.google.com/kubernetes-engine/docs/concepts/network-overview?hl=zh-cn) \u3002\n- [\u8a73\u7d30\u77ad\u89e3 Compute Engine \u8ca0\u8f09\u5747\u8861\u5668](https://cloud.google.com/compute/docs/load-balancing?hl=zh-cn) \u3002\n- [\u77ad\u89e3\u5982\u4f55\u5275\u5efa VPC \u539f\u751f\u96c6\u7fa3](https://cloud.google.com/kubernetes-engine/docs/how-to/alias-ips?hl=zh-cn) \u3002\n- [\u77ad\u89e3\u5982\u4f55\u914d\u7f6e\u6388\u6b0a\u7db2\u7d61](https://cloud.google.com/kubernetes-engine/docs/how-to/authorized-networks?hl=zh-cn) \u3002", "guide": "Google Kubernetes Engine (GKE)"}