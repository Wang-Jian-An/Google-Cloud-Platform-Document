{"title": "Google Kubernetes Engine (GKE) - \u6c38\u4e45\u6027\u5377\u548c\u52d5\u614b\u9810\u914d", "url": "https://cloud.google.com/kubernetes-engine/docs/concepts/persistent-volumes?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - \u6c38\u4e45\u6027\u5377\u548c\u52d5\u614b\u9810\u914d\n\u672c\u9801\u9762\u7c21\u8981\u4ecb\u7d39\u4e86 Kubernetes \u4e2d\u7684\u6c38\u4e45\u6027\u5377\u548c\u8072\u660e\uff0c\u53ca\u5176\u5728 Google Kubernetes Engine (GKE) \u4e2d\u7684\u7528\u6cd5\u3002\u672c\u9801\u9762\u91cd\u9ede\u4ecb\u7d39\u7531 [Compute Engine \u6c38\u4e45\u6027\u78c1\u76e4](https://cloud.google.com/compute/docs/disks?hl=zh-cn) \u652f\u6301\u7684\u5b58\u5132\u3002\n", "content": "## PersistentVolume\n`PersistentVolume` \u8cc7\u6e90\u7528\u65bc\u7ba1\u7406\u96c6\u7fa3\u4e2d\u7684\u6301\u4e45\u6027\u5b58\u5132\u3002\u5728 GKE \u4e2d\uff0c `PersistentVolume` \u901a\u5e38\u7531\u6c38\u4e45\u6027\u78c1\u76e4\u652f\u6301\u3002\u60a8\u9084\u53ef\u4ee5\u4f7f\u7528\u5176\u4ed6\u5b58\u5132\u89e3\u6c7a\u65b9\u6848\uff0c\u4f8b\u5982 NFS\u3002 [Filestore](https://cloud.google.com/filestore/docs?hl=zh-cn) \u662f Google Cloud \u4e0a\u7684 NFS \u89e3\u6c7a\u65b9\u6848\u3002\u5982\u9700\u77ad\u89e3\u5982\u4f55\u5c07 Filestore \u5be6\u4f8b\u8a2d\u7f6e\u7232 GKE \u96c6\u7fa3\u7684 NFS PV \u89e3\u6c7a\u65b9\u6848\uff0c\u8acb\u53c3\u95b1 Filestore \u6587\u6a94\u4e2d\u7684 [\u8a2a\u554f\u4f7f\u7528 Filestore CSI \u9a45\u52d5\u7a0b\u5e8f\u7684 Filestore \u5be6\u4f8b](https://cloud.google.com/filestore/docs/csi-driver?hl=zh-cn) \u3002\n\u53e6\u4e00\u500b\u5b58\u5132\u9078\u9805\u662f [Cloud Volumes Service](https://cloud.google.com/architecture/partners/netapp-cloud-volumes/overview?hl=zh-cn) \u3002\u6b64\u7522\u54c1\u662f\u4e00\u9805\u5168\u4ee3\u7ba1\u5f0f\u96f2\u7aef\u6578\u64da\u5b58\u5132\u670d\u52d9\uff0c\u53ef\u63d0\u4f9b\u9ad8\u7d1a\u6578\u64da\u7ba1\u7406\u529f\u80fd\u548c\u64f4\u7e2e\u6027\u6975\u5f37\u7684\u6027\u80fd\u3002\u5982\u9700\u67e5\u770b\u793a\u4f8b\uff0c\u8acb\u53c3\u95b1 [\u9069\u7528\u65bc Google Cloud \u7684 Cloud Volumes \u670d\u52d9](https://netapp-trident.readthedocs.io/en/stable-v20.01/kubernetes/operations/tasks/backends/cvs_gcp.html) \u3002\n`PersistentVolume` \u751f\u547d\u9031\u671f\u7531 Kubernetes \u7ba1\u7406\u3002 `PersistentVolume` \u53ef\u4ee5\u52d5\u614b\u9810\u914d\uff1b\u60a8\u4e0d\u5fc5\u624b\u52d5\u5275\u5efa\u548c\u522a\u9664\u5099\u4efd\u5b58\u5132\u3002\n`PersistentVolume` \u662f\u7368\u7acb\u65bc [Pods](https://kubernetes.io/docs/concepts/workloads/pods) \u5b58\u5728\u7684\u96c6\u7fa3\u8cc7\u6e90\u3002 \u9019\u610f\u5473\u7740\u5728\u96c6\u7fa3\u66f4\u6539\u6642\u4ee5\u53ca\u5728\u522a\u9664\u4e26\u91cd\u65b0\u5275\u5efa Pod \u6642\uff0c `PersistentVolume` \u8868\u793a\u7684\u78c1\u76e4\u548c\u6578\u64da\u5c07\u7e7c\u7e8c\u5b58\u5728\u3002 `PersistentVolume` \u8cc7\u6e90\u53ef\u4ee5\u901a\u904e `PersistentVolumeClaims` \u52d5\u614b\u9810\u914d\uff0c\u4e5f\u53ef\u4ee5\u7531\u96c6\u7fa3\u7ba1\u7406\u54e1\u660e\u78ba\u5275\u5efa\u3002\n**\u6ce8\u610f** \uff1a\u5c07 [[fsGroup] \u8a2d\u7f6e](https://kubernetes.io/docs/concepts/policy/pod-security-policy/#volumes-and-file-systems) \u8207\u5927\u578b `PersistentVolumes` \u642d\u914d\u4f7f\u7528\u53ef\u80fd\u6703\u5c0e\u81f4\u88dd\u8f09\u5931\u6557\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u6392\u67e5\u5377\u88dd\u8f09\u6545\u969c](https://cloud.google.com/kubernetes-engine/docs/troubleshooting/troubleshooting-gke-storage?hl=zh-cn#mounting_a_volume_stops_responding_due_to_the_fsgroup_setting) \u3002\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3 `PersistentVolume` \u8cc7\u6e90\uff0c\u8acb\u53c3\u95b1 Kubernetes [\u6c38\u4e45\u6027\u5377\u6587\u6a94](https://kubernetes.io/docs/concepts/storage/persistent-volumes/) \u548c [Persistent Volumes API \u53c3\u8003\u6587\u6a94](https://kubernetes.io/docs/reference/kubernetes-api/config-and-storage-resources/persistent-volume-v1/) \u3002\n## PersistentVolumeClaims\n`PersistentVolumeClaim` \u8868\u793a\u91dd\u5c0d `PersistentVolume` \u8cc7\u6e90\u7684\u8acb\u6c42\u548c\u8072\u660e\u3002 `PersistentVolumeClaim` \u5c0d\u8c61\u6703\u91dd\u5c0d `PersistentVolume` \u8acb\u6c42\u7279\u5b9a\u5927\u5c0f\u3001\u8a2a\u554f\u6a21\u5f0f\u548c [StorageClass](https://kubernetes.io/docs/concepts/storage/storage-classes/) \u3002\u5982\u679c\u5b58\u5728\u6eff\u8db3\u8acb\u6c42\u7684 `PersistentVolume` \u6216\u8005\u53ef\u4ee5\u9810\u914d\uff0c\u5247 `PersistentVolumeClaim` \u6703\u7d81\u5b9a\u5230\u8a72 `PersistentVolume` \u3002\nPod \u5c07\u8072\u660e\u7528\u4f5c\u5377\u3002\u96c6\u7fa3\u6703\u6aa2\u67e5\u8072\u660e\u4ee5\u627e\u5230\u7d81\u5b9a\u7684\u5377\u4f75\u7232 Pod \u88dd\u8f09\u8a72\u5377\u3002\n\u53ef\u79fb\u690d\u6027\u662f\u4f7f\u7528 `PersistentVolumes` \u548c `PersistentVolumeClaims` \u7684\u53e6\u4e00\u500b\u512a\u9ede\u3002\u60a8\u53ef\u4ee5\u5728\u4e0d\u540c\u96c6\u7fa3\u548c\u74b0\u5883\u4e2d\u8f15\u9b06\u4f7f\u7528\u76f8\u540c\u7684 [Pod \u898f\u7bc4](https://kubernetes.io/docs/concepts/workloads/pods/#pod-templates) \uff0c\u56e0\u7232 `PersistentVolume` \u662f\u5be6\u969b\u5f8c\u5099\u5b58\u5132\u7684\u63a5\u53e3\u3002\n## StorageClass\n\u8af8\u5982 [Compute Engine \u6c38\u4e45\u6027\u78c1\u76e4\u5bb9\u5668\u5b58\u5132\u63a5\u53e3 (CSI) \u9a45\u52d5\u7a0b\u5e8f](https://github.com/kubernetes-sigs/gcp-compute-persistent-disk-csi-driver) \u7b49\u5377\u5be6\u73fe\u662f\u901a\u904e [StorageClass](https://kubernetes.io/docs/concepts/storage/storage-classes/) \u8cc7\u6e90\u914d\u7f6e\u7684\u3002\nGKE \u6703\u7232\u60a8\u5275\u5efa\u4e00\u500b\u4f7f\u7528\u5747\u8861\u6c38\u4e45\u6027\u78c1\u76e4\u985e\u578b (ext4) \u7684\u9ed8\u8a8d `StorageClass` \u3002\u7576 `PersistentVolumeClaim` \u672a\u6307\u5b9a `StorageClassName` \u6642\uff0c\u5c07\u4f7f\u7528\u9ed8\u8a8d\u7684 `StorageClass` \u3002\u60a8\u53ef\u4ee5\u5c07\u63d0\u4f9b\u7684\u9ed8\u8a8d `StorageClass` \u66ff\u63db\u7232\u60a8\u81ea\u5df1\u7684\u3002\u6709\u95dc\u8aaa\u660e\uff0c\u8acb\u53c3\u95b1 [\u66f4\u6539\u9ed8\u8a8d StorageClass](https://kubernetes.io/docs/tasks/administer-cluster/change-default-storage-class/) \u3002\n\u60a8\u53ef\u4ee5\u5275\u5efa\u81ea\u5df1\u7684 `StorageClass` \u8cc7\u6e90\u4f86\u8aaa\u660e\u4e0d\u540c\u985e\u5225\u7684\u5b58\u5132\u3002\u4f8b\u5982\uff0c\u985e\u53ef\u80fd\u8207\u670d\u52d9\u8cea\u91cf\u7b49\u7d1a\u6216\u5099\u4efd\u653f\u7b56\u76f8\u5c0d\u61c9\u3002\u5728\u5176\u4ed6\u5b58\u5132\u7cfb\u7d71\u4e2d\uff0c\u6b64\u6982\u5ff5\u6709\u6642\u7a31\u7232\u201c\u914d\u7f6e\u6587\u4ef6\u201d\u3002\n\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f [\u5177\u6709 Windows \u7bc0\u9ede\u6c60\u7684\u96c6\u7fa3](https://cloud.google.com/kubernetes-engine/docs/how-to/creating-a-cluster-windows?hl=zh-cn) \uff0c\u5247\u5fc5\u9808\u5275\u5efa `StorageClass` \u4e26\u5728 `PersistentVolumeClaim` \u4e2d\u6307\u5b9a `StorageClassName` \uff0c\u56e0\u7232\u9ed8\u8a8d fstype (ext4) \u4e0d\u53d7 Windows \u652f\u6301\u3002\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f Compute Engine \u6c38\u4e45\u6027\u78c1\u76e4\uff0c\u5247\u5fc5\u9808\u4f7f\u7528 NTFS \u4f5c\u7232\u6587\u4ef6\u5b58\u5132\u985e\u578b\u3002\n\u5b9a\u7fa9 `StorageClass` \u6642\uff0c\u60a8\u5fc5\u9808\u5217\u51fa\u9810\u914d\u5de5\u5177\u3002\u5728 GKE \u4e0a\uff0c\u6211\u5011\u5efa\u8b70\u60a8\u4f7f\u7528\u4ee5\u4e0b\u9810\u914d\u5de5\u5177\u4e4b\u4e00\uff1a\n- [Compute Engine \u6c38\u4e45\u6027\u78c1\u76e4 CSI](https://cloud.google.com/kubernetes-engine/docs/how-to/persistent-volumes/gce-pd-csi-driver?hl=zh-cn) \n- [Kubernetes Filestore CSI](https://cloud.google.com/kubernetes-engine/docs/how-to/persistent-volumes/filestore-csi-driver?hl=zh-cn) \n**\u6ce8\u610f** \uff1a [Cloud Customer Care](https://cloud.google.com/support/docs?hl=zh-cn) \u672a\u6db5\u84cb\u6240\u5217\u9810\u914d\u5de5\u5177\u4e4b\u5916\u7684\u652f\u6301\uff0c\u4f46\u958b\u6e90\u7684 [SMB CSI Driver for Kubernetes](https://github.com/kubernetes-csi/csi-driver-smb) \u9664\u5916\uff0c\u8a72\u9a45\u52d5\u7a0b\u5e8f\u662f\u5728\u76e1\u6700\u5927\u52aa\u529b\u7684\u57fa\u790e\u4e0a\u63d0\u4f9b\u7684\u3002\u60a8\u4e5f\u53ef\u4ee5\u4f7f\u7528\u5176\u4ed6\u7b2c\u4e09\u65b9\u652f\u6301\u7684\u9810\u914d\u5de5\u5177\u3002\n## \u52d5\u614b\u9810\u914d PersistentVolume\n\u5728\u5927\u591a\u6578\u60c5\u6cc1\u4e0b\uff0c\u60a8\u4e0d\u9700\u8981\u76f4\u63a5\u914d\u7f6e `PersistentVolume` \u5c0d\u8c61\u6216\u5275\u5efa Compute Engine \u6c38\u4e45\u6027\u78c1\u76e4\u3002\u60a8\u53ef\u4ee5\u6539\u7232\u5275\u5efa `PersistentVolumeClaim` \uff0cKubernetes \u6703\u81ea\u52d5\u7232\u60a8\u9810\u914d\u6c38\u4e45\u6027\u78c1\u76e4\u3002\n\u4ee5\u4e0b\u6e05\u55ae\u63cf\u8ff0\u4e86\u5c0d\u5177\u6709 30 \u5409\u6bd4\u5b57\u7bc0 (GiB) \u5b58\u5132\u7a7a\u9593\u7684\u78c1\u76e4\u7684\u8acb\u6c42\uff0c\u8a72\u78c1\u76e4\u7684\u8a2a\u554f\u6a21\u5f0f\u5141\u8a31\u55ae\u500b\u7bc0\u9ede\u4ee5\u8b80\u5beb\u65b9\u5f0f\u88dd\u8f09\u78c1\u76e4\u3002\u6b64\u5916\uff0c\u8a72\u6e05\u55ae\u9084\u6703\u5275\u5efa\u4e00\u500b\u5c07 `PersistentVolumeClaim` \u7528\u4f5c\u5377\u7684 Pod\u3002\n```\n# pvc-pod-demo.yamlapiVersion: v1kind: PersistentVolumeClaimmetadata:\u00a0 name: pvc-demospec:\u00a0 accessModes:\u00a0 \u00a0 - ReadWriteOnce\u00a0 resources:\u00a0 \u00a0 requests:\u00a0 \u00a0 \u00a0 storage: 30Gi\u00a0 storageClassName: standard-rwo---kind: PodapiVersion: v1metadata:\u00a0 name: pod-demospec:\u00a0 volumes:\u00a0 \u00a0 - name: pvc-demo-vol\u00a0 \u00a0 \u00a0 persistentVolumeClaim:\u00a0 \u00a0 \u00a0 \u00a0claimName: pvc-demo\u00a0 containers:\u00a0 \u00a0 - name: pod-demo\u00a0 \u00a0 \u00a0 image: nginx\u00a0 \u00a0 \u00a0 resources:\u00a0 \u00a0 \u00a0 \u00a0 limits:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 cpu: 10m\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 memory: 80Mi\u00a0 \u00a0 \u00a0 \u00a0 requests:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 cpu: 10m\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 memory: 80Mi\u00a0 \u00a0 \u00a0 ports:\u00a0 \u00a0 \u00a0 \u00a0 - containerPort: 80\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 name: \"http-server\"\u00a0 \u00a0 \u00a0 volumeMounts:\u00a0 \u00a0 \u00a0 \u00a0 - mountPath: \"/usr/share/nginx/html\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 name: pvc-demo-vol\n```\n\u5728\u60a8\u4f7f\u7528 `kubectl apply -f pvc-pod-demo.yaml` \u5275\u5efa\u6b64 `PersistentVolumeClaim` \u5c0d\u8c61\u6642\uff0cKubernetes \u6703\u52d5\u614b\u5275\u5efa\u76f8\u61c9\u7684 `PersistentVolume` \u5c0d\u8c61\u3002\n\u7531\u65bc\u5b58\u5132\u985e\u5225 `standard-rwo` \u4f7f\u7528\u5377\u7d81\u5b9a\u6a21\u5f0f [WaitForFirstConsumer](#waitforfirstconsumer) \uff0c\u56e0\u6b64\u5728\u5b89\u6392 Pod \u4f7f\u7528\u8a72\u5377\u4e4b\u524d\uff0c\u4e0d\u6703\u5275\u5efa `PersistentVolume` \u3002\n\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u4e86\u5df2\u5275\u5efa\u7684 `PersistentVolume` \u3002\n```\napiVersion: v1kind: PersistentVolumemetadata:\u00a0 annotations:\u00a0 \u00a0 pv.kubernetes.io/provisioned-by: pd.csi.storage.gke.io\u00a0 finalizers:\u00a0 - kubernetes.io/pv-protection\u00a0 - external-attacher/pd-csi-storage-gke-io\u00a0 name: pvc-c9a44c07-cffa-4cd8-b92b-15bac9a9b984\u00a0 uid: d52af557-edf5-4f96-8e89-42a3008209e6spec:\u00a0 accessModes:\u00a0 - ReadWriteOnce\u00a0 capacity:\u00a0 \u00a0 storage: 30Gi\u00a0 claimRef:\u00a0 \u00a0 apiVersion: v1\u00a0 \u00a0 kind: PersistentVolumeClaim\u00a0 \u00a0 name: pvc-demo\u00a0 \u00a0 namespace: default\u00a0 \u00a0 uid: c9a44c07-cffa-4cd8-b92b-15bac9a9b984\u00a0 csi:\u00a0 \u00a0 driver: pd.csi.storage.gke.io\u00a0 \u00a0 csi.storage.k8s.io/fstype: ext4\u00a0 \u00a0 volumeAttributes:\u00a0 \u00a0 \u00a0 storage.kubernetes.io/csiProvisionerIdentity: 1660085000920-8081-pd.csi.storage.gke.io\u00a0 \u00a0 volumeHandle: projects/xxx/zones/us-central1-c/disks/pvc-c9a44c07-cffa-4cd8-b92b-15bac9a9b984\u00a0 nodeAffinity:\u00a0 \u00a0 required:\u00a0 \u00a0 \u00a0 nodeSelectorTerms:\u00a0 \u00a0 \u00a0 - matchExpressions:\u00a0 \u00a0 \u00a0 \u00a0 - key: topology.gke.io/zone\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 operator: In\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 values:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - us-central1-c\u00a0 persistentVolumeReclaimPolicy: Delete\u00a0 storageClassName: standard-rwo\u00a0 volumeMode: Filesystemstatus:\u00a0 phase: Bound\n```\n\u5047\u8a2d\u60a8\u5c1a\u672a\u66ff\u63db\u5b58\u5132\u985e\u5225 `standard-rwo` \uff0c\u5247\u6b64 `PersistentVolume` \u6703\u7531\u4e00\u500b\u65b0\u7684\u7a7a Compute Engine \u6c38\u4e45\u6027\u78c1\u76e4\u652f\u6301\u3002\n**\u6ce8\u610f\uff1a** \u5728 PersistentVolume \u7684\u751f\u547d\u9031\u671f\u5167\u4fee\u6539 `topology.kubernetes.io/zone` \u6a19\u7c64\u53ef\u80fd\u6703\u5c0e\u81f4\u88dd\u8f09\u5931\u6557\u3002\n## \u522a\u9664\u6c38\u4e45\u6027\u5b58\u5132\n\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u522a\u9664\u52d5\u614b\u9810\u914d\u7684\u5377\uff08\u5982 Compute Engine \u6c38\u4e45\u6027\u78c1\u76e4\uff09\u7684 PersistentVolumeClaim \u6703\u540c\u6642\u522a\u9664 PersistentVolume \u5c0d\u8c61\u548c\u5be6\u969b\u5099\u4efd\u78c1\u76e4\u3002\u6b64\u884c\u7232\u7531 StorageClass \u548c PersistentVolume \u4e2d\u7684\u6536\u56de\u653f\u7b56\u63a7\u5236\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u958b\u6e90 Kubernetes \u6587\u6a94](https://kubernetes.io/docs/concepts/storage/persistent-volumes/#delete) \u3002\n## \u8a2a\u554f\u6a21\u5f0f\n`PersistentVolume` \u8cc7\u6e90\u652f\u6301\u4ee5\u4e0b [\u8a2a\u554f\u6a21\u5f0f](https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes) \uff1a\n- **ReadWriteOnce** \uff1a\u5377\u53ef\u4ee5\u7531\u55ae\u500b\u7bc0\u9ede\u4ee5\u8b80\u5beb\u65b9\u5f0f\u88dd\u8f09\u3002\n- **ReadOnlyMany** \uff1a\u5377\u53ef\u4ee5\u7531\u591a\u500b\u7bc0\u9ede\u4ee5\u53ea\u8b80\u65b9\u5f0f\u88dd\u8f09\u3002\n- **ReadWriteMany** \uff1a\u5377\u53ef\u4ee5\u7531\u591a\u500b\u7bc0\u9ede\u4ee5\u8b80\u5beb\u65b9\u5f0f\u88dd\u8f09\u3002 \u7531 Compute Engine \u6c38\u4e45\u6027\u78c1\u76e4\u652f\u6301\u7684`PersistentVolume`\u8cc7\u6e90\u4e0d\u652f\u6301\u6b64\u8a2a\u554f\u6a21\u5f0f\u3002\n### \u4ee5 ReadOnlyMany \u65b9\u5f0f\u4f7f\u7528 Compute Engine \u6c38\u4e45\u6027\u78c1\u76e4\nReadWriteOnce \u662f\u6c38\u4e45\u6027\u78c1\u76e4\u6700\u5e38\u898b\u7684\u4f7f\u7528\u5834\u666f\uff0c\u7528\u4f5c\u5927\u591a\u6578\u61c9\u7528\u7684\u9ed8\u8a8d\u8a2a\u554f\u6a21\u5f0f\u3002Compute Engine \u6c38\u4e45\u6027\u78c1\u76e4\u4e5f\u652f\u6301 ReadOnlyMany \u6a21\u5f0f\uff0c\u4ee5\u4fbf\u591a\u500b\u61c9\u7528\u6216\u540c\u4e00\u61c9\u7528\u7684\u591a\u500b\u526f\u672c\u53ef\u4ee5\u540c\u6642\u4f7f\u7528\u540c\u4e00\u78c1\u76e4\u3002\u4e00\u500b\u793a\u4f8b\u4f7f\u7528\u5834\u666f\u662f\u8de8\u591a\u500b\u526f\u672c\u50b3\u9001\u975c\u614b\u5167\u5bb9\u3002\n**\u6ce8\u610f** \uff1a\u60a8\u4e0d\u80fd\u540c\u6642\u5728\u591a\u500b\u7bc0\u9ede\u4e0a\u4ee5\u5beb\u5165\u6a21\u5f0f\u639b\u63a5\u6c38\u4e45\u6027\u78c1\u76e4\u3002\u8acb\u53c3\u95b1 [Deployment \u8207 StatefulSet](#deployments_vs_statefulsets) \u3002\n\u5982\u9700\u77ad\u89e3\u76f8\u95dc\u8aaa\u660e\uff0c\u8acb\u53c3\u95b1 [\u5c07\u6c38\u4e45\u6027\u78c1\u76e4\u8207\u591a\u500b\u8b80\u53d6\u5668\u7d50\u5408\u4f7f\u7528](https://cloud.google.com/kubernetes-engine/docs/how-to/persistent-volumes/readonlymany-disks?hl=zh-cn) \u3002\n## \u5c07\u9810\u5148\u5b58\u5728\u7684\u6c38\u4e45\u6027\u78c1\u76e4\u7528\u4f5c PersistentVolume\n\u52d5\u614b\u9810\u914d\u7684 `PersistentVolume` \u5728\u5275\u5efa\u6642\u662f\u7a7a\u7684\u3002\u5982\u679c\u60a8\u5df2\u7d93\u6709\u4e00\u500b\u586b\u5145\u4e86\u6578\u64da\u7684\u73fe\u5b58 Compute Engine \u6c38\u4e45\u6027\u78c1\u76e4\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u624b\u52d5\u5275\u5efa\u5c0d\u61c9\u7684 `PersistentVolume` \u8cc7\u6e90\u5c07\u8a72\u78c1\u76e4\u5f15\u5165\u60a8\u7684\u96c6\u7fa3\u3002\u6c38\u4e45\u6027\u78c1\u76e4\u5fc5\u9808\u8207\u96c6\u7fa3\u7bc0\u9ede\u4f4d\u65bc\u540c\u4e00 [\u53ef\u7528\u5340](https://cloud.google.com/compute/docs/regions-zones?hl=zh-cn) \u4e2d\u3002\n\u8acb\u53c3\u95b1 [\u5982\u4f55\u5275\u5efa\u7531\u9810\u5148\u5b58\u5728\u7684\u6c38\u4e45\u6027\u78c1\u76e4\u652f\u6301\u7684\u6c38\u4e45\u6027\u5377\u7684\u76f8\u95dc\u793a\u4f8b](https://cloud.google.com/kubernetes-engine/docs/how-to/persistent-volumes/preexisting-pd?hl=zh-cn) \u3002\n**\u6ce8\u610f** \uff1a\u4e0d\u652f\u6301\u5c07\u5176\u4ed6 Google Cloud \u9805\u76ee\u4e2d\u7684\u6c38\u4e45\u6027\u78c1\u76e4\u88dd\u8f09\u5230\u7576\u524d Google Cloud \u9805\u76ee\u4e2d\u7684 Pod\u3002\n## Deployment \u8207 StatefulSet\n\u60a8\u53ef\u4ee5\u5728\u66f4\u9ad8\u7d1a\u5c64\u7684\u63a7\u5236\u5668\uff08\u5982 [Deployment](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/) \u6216 [StatefulSet](https://cloud.google.com/kubernetes-engine/docs/concepts/statefulset?hl=zh-cn) \uff09\u4e2d\u5206\u5225\u4f7f\u7528 `PersistentVolumeClaim` \u6216 `VolumeClaim` \u6a21\u677f\u3002\nDeployment \u662f\u5c08\u7232 [\u7121\u72c0\u614b\u61c9\u7528](https://cloud.google.com/kubernetes-engine/docs/how-to/stateless-apps?hl=zh-cn) \u8a2d\u8a08\u7684\uff0c\u56e0\u6b64 Deployment \u7684\u6240\u6709\u526f\u672c\u5171\u7528\u540c\u4e00\u500b `PersistentVolumeClaim` \u3002\u7531\u65bc\u5275\u5efa\u7684\u526f\u672c Pod \u5f7c\u6b64\u76f8\u540c\uff0c\u56e0\u6b64\u53ea\u6709\u5177\u6709 ReadWriteMany \u6a21\u5f0f\u7684\u5377\u624d\u80fd\u9069\u7528\u65bc\u6b64\u8a2d\u7f6e\u3002\n\u5373\u4f7f\u662f\u5177\u6709\u4e00\u500b\u4f7f\u7528 ReadWriteOnce \u5377\u7684\u526f\u672c\u7684 Deployment\uff0c\u4e5f\u4e0d\u5efa\u8b70\u63a1\u7528\u3002\u9019\u662f\u56e0\u7232\u9ed8\u8a8d Deployment \u7b56\u7565\u6703\u5728\u91cd\u65b0\u5275\u5efa\u6642\u5148\u5275\u5efa\u7b2c\u4e8c\u500b Pod\uff0c\u7136\u5f8c\u518d\u95dc\u9589\u7b2c\u4e00\u500b Pod\u3002\u7b2c\u4e8c\u500b Pod \u7121\u6cd5\u5553\u52d5\u6642\uff0cDeployment \u53ef\u80fd\u6703\u56e0\u6b7b\u9396\u800c\u5931\u6557\uff0c\u9019\u662f\u56e0\u7232 ReadWriteOnce \u5377\u5df2\u5728\u4f7f\u7528\u4e2d\uff0c\u800c\u7b2c\u4e00\u500b Pod \u7531\u65bc\u7b2c\u4e8c\u500b Pod \u5c1a\u672a\u5553\u52d5\u800c\u7121\u6cd5\u79fb\u9664\u3002\u61c9\u6539\u7232\u91dd\u5c0d ReadWriteOnce \u5377\u4f7f\u7528 StatefulSet\u3002\n\u5efa\u8b70\u4f7f\u7528 StatefulSet \u90e8\u7f72\u6709\u72c0\u614b\u61c9\u7528\uff0c\u9019\u4e9b\u61c9\u7528\u9700\u8981\u6bcf\u500b\u526f\u672c\u5177\u6709\u552f\u4e00\u5377\u3002\u901a\u904e\u5c07 StatefulSet \u8207 PersistentVolumeClaim \u6a21\u677f\u7d50\u5408\u4f7f\u7528\uff0c\u60a8\u7684\u61c9\u7528\u53ef\u4ee5\u96a8\u8207\u6bcf\u500b\u526f\u672c Pod \u95dc\u806f\u7684\u552f\u4e00 PersistentVolumesClaim \u81ea\u52d5\u7e31\u5411\u64f4\u5bb9\u3002\n## \u5340\u57df\u6c38\u4e45\u6027\u78c1\u76e4\n[\u5340\u57df\u6c38\u4e45\u6027\u78c1\u76e4](https://cloud.google.com/compute/docs/disks?hl=zh-cn#repds) \u662f\u591a\u53ef\u7528\u5340\u8cc7\u6e90\uff0c\u5728\u540c\u4e00\u5340\u57df\u4e2d\u7684\u5169\u500b\u53ef\u7528\u5340\u4e4b\u9593\u8907\u88fd\u6578\u64da\uff0c\u4e26\u4e14\u4f7f\u7528\u65b9\u5f0f\u8207\u53ef\u7528\u5340\u6c38\u4e45\u6027\u78c1\u76e4\u985e\u4f3c\u3002\u5982\u679c\u767c\u751f\u53ef\u7528\u5340\u4e2d\u65b7\uff0c\u6216\u8005\u67d0\u500b\u53ef\u7528\u5340\u7684\u96c6\u7fa3\u7bc0\u9ede\u7121\u6cd5\u5b89\u6392\uff0cKubernetes \u53ef\u9032\u884c\u6545\u969c\u5207\u63db\uff0c\u5c07\u4f7f\u7528\u8a72\u5377\u7684\u5de5\u4f5c\u8ca0\u8f09\u5206\u914d\u5230\u5176\u4ed6\u53ef\u7528\u5340\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u5340\u57df\u6c38\u4e45\u6027\u78c1\u76e4\u7232 GKE \u4e0a\u7684\u6709\u72c0\u614b\u5de5\u4f5c\u8ca0\u8f09\u69cb\u5efa\u9ad8\u53ef\u7528\u6027\u89e3\u6c7a\u65b9\u6848\u3002\u60a8\u5fc5\u9808\u78ba\u4fdd\u4e3b\u8981\u53ef\u7528\u5340\u548c\u6545\u969c\u5207\u63db\u53ef\u7528\u5340\u90fd\u914d\u7f6e\u4e86\u8db3\u5920\u7684\u8cc7\u6e90\u5bb9\u91cf\u4f86\u904b\u884c\u5de5\u4f5c\u8ca0\u8f09\u3002\n\u5340\u57df SSD \u6c38\u4e45\u6027\u78c1\u76e4\u662f\u61c9\u7528\uff08\u4f8b\u5982\u540c\u6642\u8981\u6c42\u9ad8\u53ef\u7528\u6027\u548c\u9ad8\u6027\u80fd\u7684\u6578\u64da\u5eab\uff09\u7684\u4e00\u500b\u9078\u9805\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u584a\u5b58\u5132\u6027\u80fd\u6bd4\u8f03](https://cloud.google.com/compute/docs/disks/performance?hl=zh-cn#type_comparison) \u3002\n\u8207\u53ef\u7528\u5340\u6c38\u4e45\u6027\u78c1\u76e4\u4e00\u6a23\uff0c\u5340\u57df\u6c38\u4e45\u6027\u78c1\u76e4\u53ef\u4ee5\u6839\u64da\u9700\u8981\u52d5\u614b\u9810\u914d\uff0c\u4e5f\u53ef\u4ee5\u7531\u96c6\u7fa3\u7ba1\u7406\u54e1\u63d0\u524d\u9810\u914d\u3002\u5982\u9700\u77ad\u89e3\u5982\u4f55\u6dfb\u52a0\u5340\u57df\u6c38\u4e45\u6027\u78c1\u76e4\uff0c\u8acb\u53c3\u95b1 [\u9810\u914d\u5340\u57df\u6c38\u4e45\u6027\u78c1\u76e4](https://cloud.google.com/kubernetes-engine/docs/how-to/persistent-volumes/regional-pd?hl=zh-cn) \u3002\n## \u6c38\u4e45\u6027\u78c1\u76e4\u4e2d\u7684\u53ef\u7528\u5340\n[\u53ef\u7528\u5340\u6c38\u4e45\u6027\u78c1\u76e4](https://cloud.google.com/compute/docs/disks?hl=zh-cn#pdspecs) \u662f\u53ef\u7528\u5340\u7d1a\u8cc7\u6e90\uff0c\u800c\u5340\u57df\u6c38\u4e45\u6027\u78c1\u76e4\u662f\u591a\u53ef\u7528\u5340\u8cc7\u6e90\u3002\u5728\u5411\u96c6\u7fa3 [\u6dfb\u52a0\u6c38\u4e45\u6027\u5b58\u5132](https://cloud.google.com/kubernetes-engine/docs/how-to/stateful-apps?hl=zh-cn#requesting_persistent_storage_in_a_statefulset) \u6642\uff0c\u9664\u975e\u6307\u5b9a\u4e86\u53ef\u7528\u5340\uff0c\u5426\u5247 GKE \u6703\u5c07\u78c1\u76e4\u5206\u914d\u7d66\u55ae\u500b\u53ef\u7528\u5340\u3002GKE \u6703\u96a8\u6a5f\u9078\u64c7\u53ef\u7528\u5340\u3002\u9810\u914d\u6c38\u4e45\u6027\u78c1\u76e4\u5f8c\uff0c\u4efb\u4f55\u5f15\u7528\u78c1\u76e4\u7684 Pod \u90fd\u5c07\u88ab\u5b89\u6392\u5230\u78c1\u76e4\u6240\u5728\u7684\u5340\u57df\u3002\n## \u5377\u7d81\u5b9a\u6a21\u5f0f WaitForFirstConsumer\n\u5982\u679c\u60a8\u5728\u96c6\u7fa3\u4e2d\u52d5\u614b\u9810\u914d\u6c38\u4e45\u6027\u78c1\u76e4\uff0c\u6211\u5011\u5efa\u8b70\u60a8\u5728 StorageClass \u4e0a\u8a2d\u7f6e `WaitForFirstConsumer` [\u5377\u7d81\u5b9a\u6a21\u5f0f](https://kubernetes.io/docs/concepts/storage/storage-classes/#volume-binding-mode) \u3002\u6b64\u8a2d\u7f6e\u6307\u793a Kubernetes \u5728\u8207 Pod \u8abf\u5ea6\u5230\u7684\u76f8\u540c\u53ef\u7528\u5340\u4e2d\u9810\u914d\u6c38\u4e45\u6027\u78c1\u76e4\u3002\u5b83\u9075\u5faa Pod \u8abf\u5ea6\u9650\u5236\u689d\u4ef6\uff0c\u4f8b\u5982 [\u53cd\u89aa\u548c\u6027](https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#affinity-and-anti-affinity) \u8207\u7bc0\u9ede\u9078\u64c7\u5668\u3002\u53ef\u7528\u5340\u4e0a\u7684\u53cd\u89aa\u548c\u6027\u5141\u8a31\u5c07 StatefulSet Pod \u4ee5\u53ca\u5c0d\u61c9\u7684\u78c1\u76e4\u5206\u4f48\u5728\u5404\u500b\u53ef\u7528\u5340\u4e2d\u3002\n\u4ee5\u4e0b\u662f\u7528\u65bc\u9810\u914d\u53ef\u7528\u5340\u6c38\u4e45\u6027\u78c1\u76e4\u4e14\u8a2d\u7f6e `WaitForFirstConsumer` \u7684\u793a\u4f8b `StorageClass` \uff1a\n```\napiVersion: storage.k8s.io/v1kind: StorageClassmetadata:\u00a0 name: slowprovisioner: pd.csi.storage.gke.ioparameters:\u00a0 type: pd-balanced\u00a0 csi.storage.k8s.io/fstype: ext4volumeBindingMode: WaitForFirstConsumer\n```\n\u5982\u9700\u67e5\u770b\u4f7f\u7528\u5340\u57df\u6c38\u4e45\u6027\u78c1\u76e4\u7684\u793a\u4f8b\uff0c\u8acb\u53c3\u95b1 [\u9810\u914d\u5340\u57df\u6c38\u4e45\u6027\u78c1\u76e4](https://cloud.google.com/kubernetes-engine/docs/how-to/persistent-volumes/regional-pd?hl=zh-cn) \u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n- [\u77ad\u89e3 StatefulSet](https://cloud.google.com/kubernetes-engine/docs/concepts/statefulset?hl=zh-cn) \uff0c\u5efa\u8b70\u4f7f\u7528\u6b64\u65b9\u6cd5\u90e8\u7f72\u6709\u72c0\u614b\u61c9\u7528\u3002\n- [\u77ad\u89e3\u5982\u4f55\u4f7f\u7528 StatefulSet \u90e8\u7f72\u6709\u72c0\u614b\u61c9\u7528](https://cloud.google.com/kubernetes-engine/docs/how-to/stateful-apps?hl=zh-cn) \u3002\n- [\u77ad\u89e3\u5982\u4f55\u5728\u96c6\u7fa3\u4e2d\u4f7f\u7528\u6c38\u4e45\u6027\u78c1\u76e4](https://cloud.google.com/kubernetes-engine/docs/tutorials/persistent-disk?hl=zh-cn) \u3002\n- [\u77ad\u89e3\u5982\u4f55\u5275\u5efa\u53ef\u4ee5\u5f9e\u591a\u500b\u7bc0\u9ede\u8b80\u53d6\u7684\u78c1\u76e4](https://cloud.google.com/kubernetes-engine/docs/how-to/persistent-volumes/readonlymany-disks?hl=zh-cn) \u3002\n- [\u77ad\u89e3\u5982\u4f55\u5275\u5efa\u7531 SSD \u652f\u6301\u7684\u6c38\u4e45\u6027\u78c1\u76e4](https://cloud.google.com/kubernetes-engine/docs/how-to/persistent-volumes/ssd-pd?hl=zh-cn) \u3002\n- [\u77ad\u89e3\u5982\u4f55\u9810\u914d\u5340\u57df\u6c38\u4e45\u6027\u78c1\u76e4](https://cloud.google.com/kubernetes-engine/docs/how-to/persistent-volumes/regional-pd?hl=zh-cn) \u3002", "guide": "Google Kubernetes Engine (GKE)"}