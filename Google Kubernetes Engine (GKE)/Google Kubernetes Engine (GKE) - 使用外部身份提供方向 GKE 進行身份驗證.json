{"title": "Google Kubernetes Engine (GKE) - \u4f7f\u7528\u5916\u90e8\u8eab\u4efd\u63d0\u4f9b\u65b9\u5411 GKE \u9032\u884c\u8eab\u4efd\u9a57\u8b49", "url": "https://cloud.google.com/kubernetes-engine/docs/how-to/oidc?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - \u4f7f\u7528\u5916\u90e8\u8eab\u4efd\u63d0\u4f9b\u65b9\u5411 GKE \u9032\u884c\u8eab\u4efd\u9a57\u8b49\n\u672c\u9801\u9762\u4ecb\u7d39\u5982\u4f55\u914d\u7f6e\u5916\u90e8\u8eab\u4efd\u63d0\u4f9b\u5546\u4ee5\u5411 Google Kubernetes Engine (GKE) \u96c6\u7fa3\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\n", "content": "## \u6982\u89bd\nIdentity Service for GKE \u53ef\u5c07\u73fe\u6709\u8eab\u4efd\u9a57\u8b49\u89e3\u6c7a\u65b9\u6848\u64f4\u5c55\u5230 GKE \u96c6\u7fa3\u3002\u85c9\u52a9 [OpenID Connect](https://developers.google.com/identity/protocols/OpenIDConnect?hl=zh-cn) (OIDC) \u652f\u6301\uff0c\u60a8\u53ef\u4ee5\u6309\u7167\u7d44\u7e54\u4e2d\u5275\u5efa\u3001\u5553\u7528\u548c\u505c\u7528\u7528\u6236\u8cec\u865f\u7684\u6a19\u6e96\u7a0b\u5e8f\u4f86\u7ba1\u7406\u5c0d Kubernetes \u96c6\u7fa3\u7684\u8a2a\u554f\u6b0a\u9650\u3002Identity Service for GKE \u50c5\u9650\u65bc OIDC \u8eab\u4efd\u63d0\u4f9b\u5546\u3002\n## \u6e96\u5099\u5de5\u4f5c\n- \u672c\u4e3b\u984c\u5047\u5b9a\u60a8\u719f\u6089\u4ee5\u4e0b\u8eab\u4efd\u9a57\u8b49\u548c OpenID \u6982\u5ff5\uff1a- [OAuth 2.0](https://oauth.net/2/) \n- [OpenID Connect](https://openid.net/connect/) \n- [\u7bc4\u570d](https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims) \n- [\u8072\u660e](https://openid.net/specs/openid-connect-core-1_0.html#IDToken) \n- \u4e0d\u652f\u6301\u7121\u982d\u7cfb\u7d71\u3002\u57fa\u65bc\u700f\u89bd\u5668\u7684\u8eab\u4efd\u9a57\u8b49\u6d41\u7a0b\u7528\u65bc\u63d0\u793a\u60a8\u540c\u610f\u4e26\u6388\u6b0a\u60a8\u7684\u7528\u6236\u8cec\u865f\u3002\n\u5728\u958b\u59cb\u4e4b\u524d\uff0c\u8acb\u78ba\u4fdd\u60a8\u5df2\u57f7\u884c\u4ee5\u4e0b\u4efb\u52d9\uff1a\n- \u5553\u7528 Google Kubernetes Engine API\u3002\n- [  \u5553\u7528 Google Kubernetes Engine API ](https://console.cloud.google.com/flows/enableapi?apiid=container.googleapis.com&hl=zh-cn) \n- \u5982\u679c\u60a8\u8981\u4f7f\u7528 Google Cloud CLI \u57f7\u884c\u6b64\u4efb\u52d9\uff0c\u8acb [\u5b89\u88dd](https://cloud.google.com/sdk/docs/install?hl=zh-cn) \u4e26 [\u521d\u59cb\u5316](https://cloud.google.com/sdk/docs/initializing?hl=zh-cn) gcloud CLI\u3002 \u5982\u679c\u60a8\u4e4b\u524d\u5b89\u88dd\u4e86 gcloud CLI\uff0c\u8acb\u904b\u884c`gcloud components update`\u4ee5\u7372\u53d6\u6700\u65b0\u7248\u672c\u3002 **\u6ce8\u610f** \uff1a\u5c0d\u65bc\u73fe\u6709 gcloud CLI \u5b89\u88dd\uff0c\u8acb\u52d9\u5fc5\u8a2d\u7f6e`compute/region`\u548c`compute/zone` [\u5c6c\u6027](https://cloud.google.com/sdk/docs/properties?hl=zh-cn#setting_properties) \u3002\u901a\u904e\u8a2d\u7f6e\u9ed8\u8a8d\u4f4d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u907f\u514d gcloud CLI \u4e2d\u51fa\u73fe\u4ee5\u4e0b\u932f\u8aa4\uff1a`One of [--zone, --region] must be supplied: Please specify location`\u3002## \u8ab0\u4f7f\u7528 Identity Service for GKE\n\u5982\u679c\u60a8\u662f\u4ee5\u4e0b\u4eba\u54e1\u4e4b\u4e00\uff0c\u5247\u672c\u6587\u6a94\u4e2d\u7684\u4efb\u52d9\u9069\u7528\u65bc\u60a8\uff1a\n- **\u96c6\u7fa3\u7ba1\u7406\u54e1** \uff1a\u5275\u5efa\u4e00\u500b\u6216\u591a\u500b\u7528\u6236\u96c6\u7fa3\uff0c\u4f75\u7232\u4f7f\u7528\u9019\u4e9b\u96c6\u7fa3\u7684\u958b\u767c\u8005\u5275\u5efa\u8eab\u4efd\u9a57\u8b49\u914d\u7f6e\u6587\u4ef6\u3002\n- **\u958b\u767c\u8005** \uff1a\u5728\u4e00\u500b\u6216\u591a\u500b\u96c6\u7fa3\u4e0a\u904b\u884c\u5de5\u4f5c\u8ca0\u8f09\uff0c\u4e26\u4f7f\u7528 OIDC \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002## \u5de5\u4f5c\u539f\u7406\n\u5982\u9700\u5728 GKE \u96c6\u7fa3\u4e0a\u8a2d\u7f6e\u548c\u4f7f\u7528 Identity Service for GKE\uff0c **\u96c6\u7fa3\u7ba1\u7406\u54e1** \u5fc5\u9808\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- [\u5728\u96c6\u7fa3\u4e0a\u5553\u7528 Identity Service for GKE](#enable-oidc) \u3002\n- [\u914d\u7f6e Identity Service for GKE](#configuring_on_a_cluster) \u3002\n- [\u7232\u60a8\u7684\u96c6\u7fa3\u5275\u5efa RBAC \u653f\u7b56](#rbac) \u3002\n\u96c6\u7fa3\u7ba1\u7406\u54e1\u914d\u7f6e Identity Service for GKE \u5f8c\uff0c **\u958b\u767c\u8005** \u53ef\u4ee5 [\u767b\u9304\u96c6\u7fa3\u4e26\u9032\u884c\u8eab\u4efd\u9a57\u8b49](#logging_in_and_authenticating_to_the_cluster) \u3002\n## \u5728\u96c6\u7fa3\u4e0a\u5553\u7528 Identity Service for GKE\n\u672c\u90e8\u5206\u9762\u5411 [\u96c6\u7fa3\u7ba1\u7406\u54e1](#personas) \u3002\n\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cIdentity and Access Management (IAM) \u914d\u7f6e\u7232\u96c6\u7fa3\u8eab\u4efd\u9a57\u8b49\u7684\u8eab\u4efd\u63d0\u4f9b\u65b9\u3002\u5982\u679c\u60a8\u5e0c\u671b\u5c07 OIDC \u8207\u7b2c\u4e09\u65b9\u8eab\u4efd\u63d0\u4f9b\u65b9\u642d\u914d\u4f7f\u7528\uff0c\u5247\u53ef\u4ee5\u4f7f\u7528 Google Cloud CLI \u5728\u65b0\u96c6\u7fa3\u6216\u73fe\u6709\u96c6\u7fa3\u4e0a\u5553\u7528 Identity Service for GKE\u3002\n**\u6ce8\u610f** \uff1a\u7232\u4e86\u4f7f Identity Service for GKE \u6b63\u78ba\u904b\u884c\uff0cGKE \u6703\u5c07 Pod \u90e8\u7f72\u5230\u5177\u6709\u63d0\u5347\u7684 [RBAC \u6b0a\u9650](https://kubernetes.io/docs/reference/access-authn-authz/authorization/#determine-the-request-verb) \u7684\u7bc0\u9ede\uff0c\u4f8b\u5982\u6a21\u64ec\u7528\u6236\u548c\u7fa3\u7d44\u7684\u6b0a\u9650\u3002Identity Service for GKE \u9700\u8981\u9019\u4e9b\u6b0a\u9650\u4ee5\u6839\u64da\u60a8\u7684\u914d\u7f6e\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u548c\u901a\u4fe1\u3002\n### \u5728\u65b0\u96c6\u7fa3\u4e0a\u5553\u7528 Identity Service for GKE\n\u5982\u9700\u5275\u5efa\u5553\u7528 Identity Service for GKE \u7684\u96c6\u7fa3\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ngcloud container clusters create CLUSTER_NAME \\\u00a0 \u00a0 --enable-identity-service\n```\n\u5c07 `` \u66ff\u63db\u7232\u65b0\u96c6\u7fa3\u7684\u540d\u7a31\u3002\n### \u5728\u73fe\u6709\u96c6\u7fa3\u4e0a\u5553\u7528 Identity Service for GKE\n\u8981\u5728\u73fe\u6709\u96c6\u7fa3\u4e0a\u5553\u7528 Identity Service for GKE\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ngcloud container clusters update CLUSTER_NAME \\\u00a0 \u00a0 --enable-identity-service\n```\n\u5c07 `` \u66ff\u63db\u7232\u60a8\u7684\u96c6\u7fa3\u540d\u7a31\u3002\n## Identity Service for GKE \u5275\u5efa\u7684 Kubernetes \u5c0d\u8c61\n\u4e0b\u8868\u4ecb\u7d39\u4e86\u5728\u96c6\u7fa3\u4e0a\u5553\u7528 Identity Service for GKE \u6642\u5275\u5efa\u7684 Kubernetes \u5c0d\u8c61\uff1a\n| Kubernetes \u5c0d\u8c61   | Kubernetes \u5c0d\u8c61.1                                                  |\n|:------------------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| anthos-identity-service | Namespace \u7528\u65bc Identity Service for GKE \u90e8\u7f72\u3002                                           |\n| kube-public    | Namespace \u7528\u65bc default \u5ba2\u6236\u7aef\u914d\u7f6e\u6587\u4ef6\u3002                                            |\n| gke-oidc-envoy   | LoadBalancer OIDC \u8acb\u6c42\u7684\u7aef\u9ede\u3002\u9ed8\u8a8d\u7232\u5916\u90e8\u7aef\u9ede\u3002\u5982\u679c\u60a8\u5728\u5c08\u7528\u96c6\u7fa3\u6216\u5be6\u65bd\u56b4\u683c\u7db2\u7d61\u653f\u7b56\u7684\u96c6\u7fa3\u4e2d\u5275\u5efa\u4e86\u8a72\u7aef\u9ede\uff0c\u5247\u5b83\u662f\u96c6\u7fa3 Virtual Private Cloud \u7684\u5167\u90e8\u7aef\u9ede\u3002 \u5728 anthos-identity-service \u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa\u3002      |\n| gke-oidc-service  | ClusterIP \u65b9\u4fbf\u5728 gke-oidc-envoy Deployment \u548c gke-oidc-service Deployment \u4e4b\u9593\u9032\u884c\u901a\u4fe1\u3002 \u5728 anthos-identity-service \u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa\u3002                     |\n| gke-oidc-envoy   | Deployment \u904b\u884c\u5411 gke-oidc-envoy LoadBalancer \u516c\u958b\u7684\u4ee3\u7406\u3002\u8207 gke-oidc-service \u901a\u4fe1\u4ee5\u9a57\u8b49\u8eab\u4efd\u4ee4\u724c\u3002\u5145\u7576 Kubernetes API \u670d\u52d9\u5668\u7684\u4ee3\u7406\uff0c\u4e26\u5728\u5411 API \u670d\u52d9\u5668\u50b3\u905e\u8acb\u6c42\u6642\u6a21\u64ec\u7528\u6236\u3002 \u5728 anthos-identity-service \u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa\u3002 |\n| gke-oidc-service  | Deployment \u9a57\u8b49\u8eab\u4efd\u4ee4\u724c\uff0c\u4f75\u7232 ClientConfig \u8cc7\u6e90\u63d0\u4f9b\u9a57\u8b49\u51c6\u5165\u7db2\u7d61\u9264\u5b50\u3002 \u5728 anthos-identity-service \u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa\u3002                          |\n| gke-oidc-operator  | Deployment \u5354\u8abf\u5ba2\u6236\u7aef\u914d\u7f6e\u548c gke-oidc-envoy LoadBalancer\u3002 \u5728 anthos-identity-service \u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa\u3002                             |\n| gke-oidc-certs   | Secret \u5305\u542b LoadBalancer \u7684\u96c6\u7fa3\u8b49\u66f8\u6388\u6b0a\u6a5f\u69cb (CA) \u548c TLS \u8b49\u66f8\u3002 \u5728 anthos-identity-service \u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa                            |\n| default     | ClientConfig CRD \u5305\u542b OIDC \u53c3\u6578\uff0c\u4f8b\u5982\u9996\u9078\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3001\u8eab\u4efd\u63d0\u4f9b\u5546\u914d\u7f6e\u4ee5\u53ca\u7528\u6236\u548c\u7fa3\u7d44\u8072\u660e\u6620\u5c04\u3002\u7528\u65bc\u8eab\u4efd\u4ee4\u724c\u9a57\u8b49\u3002\u4f9b\u96c6\u7fa3\u7ba1\u7406\u54e1\u7528\u65bc\u5728\u5206\u767c\u7d66\u958b\u767c\u8005\u4e4b\u524d\u914d\u7f6e OIDC \u8a2d\u7f6e\u3002 \u5728 kube-public \u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa      |\n## \u914d\u7f6e Identity Service for GKE\n\u672c\u90e8\u5206\u9762\u5411 [\u96c6\u7fa3\u7ba1\u7406\u54e1](#personas) \u3002\n\u60a8\u53ef\u4ee5\u901a\u904e\u4e0b\u8f09\u548c\u4fee\u6539 `default` ClientConfig \u4f86\u914d\u7f6e Identity Service for GKE \u53c3\u6578\u3002\n- \u4e0b\u8f09 `default` ClientConfig\uff1a```\nkubectl get clientconfig default -n kube-public -o yaml > client-config.yaml\n```\n- \u4f7f\u7528\u9996\u9078\u8a2d\u7f6e\u4f86\u66f4\u65b0 `spec.authentication` \u90e8\u5206\uff1a```\napiVersion: authentication.gke.io/v2alpha1kind: ClientConfigmetadata:\u00a0 name: default\u00a0 namespace: kube-publicspec:\u00a0 name: cluster-name\u00a0 server: https://192.168.0.1:6443\u00a0 authentication:\u00a0 - name: oidc\u00a0 \u00a0 oidc:\u00a0 \u00a0 \u00a0 clientID: CLIENT_ID\u00a0 \u00a0 \u00a0 certificateAuthorityData: OIDC_PROVIDER_CERTIFICATE\u00a0 \u00a0 \u00a0 extraParams: EXTRA_PARAMS\u00a0 \u00a0 \u00a0 issuerURI: \u00a0ISSUER_URI\u00a0 \u00a0 \u00a0 cloudConsoleRedirectURI: https://console.cloud.google.com/kubernetes/oidc\u00a0 \u00a0 \u00a0 kubectlRedirectURI: KUBECTL_REDIRECT_URL\u00a0 \u00a0 \u00a0 scopes: SCOPES\u00a0 \u00a0 \u00a0 userClaim: USER\u00a0 \u00a0 \u00a0 groupsClaim: GROUPS\u00a0 \u00a0 \u00a0 userPrefix: USER_PREFIX\u00a0 \u00a0 \u00a0 groupPrefix: GROUP_PREFIX\n```\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u5411 OIDC \u63d0\u4f9b\u5546\u767c\u51fa\u8eab\u4efd\u9a57\u8b49\u8acb\u6c42\u7684\u5ba2\u6236\u7aef\u61c9\u7528\u7684 ID\u3002\n- ``\uff1a\uff08\u53ef\u9078\uff09OIDC \u63d0\u4f9b\u65b9\u7684 [PEM \u8b49\u66f8](https://wikipedia.org/wiki/Privacy-Enhanced_Mail) \u3002\u5982\u679c\u60a8\u7684 OIDC \u63d0\u4f9b\u65b9\u4f7f\u7528\u81ea\u7c3d\u540d\u8b49\u66f8\uff0c\u5247\u6b64\u5b57\u6bb5\u53ef\u80fd\u6709\u7528\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cIdentity Service for GKE \u5305\u542b\u4e00\u7d44\u516c\u5171\u6839\u76ee\u9304\u3002\n- ``\uff1a\u8981\u767c\u9001\u5230 OIDC \u63d0\u4f9b\u5546\u7684\u5176\u4ed6\u9375\u503c\u5c0d\u53c3\u6578\u3002\n- \u4f7f\u7528`resource=token-groups-claim`\u5411\u7fa3\u7d44\u6388\u6b0a\u3002\n- \u4f7f\u7528`prompt=consent`\u5c0d Microsoft Azure \u548c Okta \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\n- \u5c0d\u65bc Cloud Identity\uff0c\u8acb\u4f7f\u7528`prompt=consent,access_type=offline`\u3002\n- ``\uff1a\u7528\u65bc\u767c\u9001 OIDC \u6388\u6b0a\u8acb\u6c42\u7684\u7db2\u5740\uff0c\u4f8b\u5982`https://example.com/adfs`\u3002Kubernetes API \u670d\u52d9\u5668\u4f7f\u7528\u6b64\u7db2\u5740\u4f86\u767c\u73fe\u7528\u65bc\u9a57\u8b49\u4ee4\u724c\u7684\u516c\u9470\u3002URI \u5fc5\u9808\u4f7f\u7528 HTTPS\u3002\u5c0d\u65bc Cloud Identity\uff0c\u8acb\u4f7f\u7528`https://accounts.google.com`\u3002\n- ``\uff1a`kubectl oidc login`\u7528\u65bc\u6388\u6b0a\u7684\u91cd\u5b9a\u5411\u7db2\u5740\u3002\u683c\u5f0f\u901a\u5e38\u7232`http://localhost:` `` `/callback`\uff0c\u5176\u4e2d``\u662f\u5c07\u5728\u958b\u767c\u8005\u5de5\u4f5c\u7ad9\u4e0a\u53ef\u7528\u7684\u9ad8\u65bc`1024`\u7684\u4efb\u610f\u7aef\u53e3\uff0c\u4f8b\u5982`http://localhost:10000/callback`\u3002\u60a8\u5fc5\u9808\u5411 OIDC \u63d0\u4f9b\u5546\u5c07\u8a72\u7db2\u5740\u8a3b\u518a\u7232\u5ba2\u6236\u7aef\u61c9\u7528\u7684\u6388\u6b0a\u91cd\u5b9a\u5411\u7db2\u5740\u3002\u5982\u679c\u60a8\u5c07 Google Identity \u7528\u4f5c OIDC \u63d0\u4f9b\u5546\uff0c\u8acb\u53c3\u95b1 [\u8a2d\u7f6e\u91cd\u5b9a\u5411 URI](https://developers.google.com/identity/protocols/oauth2/openid-connect?hl=zh-cn) \u4ee5\u77ad\u89e3\u8aaa\u660e\u3002\n- ``\uff1a\u8981\u767c\u9001\u5230 OIDC \u63d0\u4f9b\u5546\u7684\u5176\u4ed6\u7bc4\u570d\u3002- Microsoft Azure \u548c Okta \u9700\u8981`offline_access`\u7bc4\u570d\u3002\n- \u5c0d\u65bc Cloud Identity\uff0c\u8acb\u4f7f\u7528`openid, email`\u7372\u53d6\u5305\u542b`email`\u8072\u660e\u4e2d\u7684\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\u7684 ID \u4ee4\u724c\u3002\n- ``\uff1a\u8eab\u4efd\u4ee4\u724c\u4e2d\u7684\u7528\u6236\u8072\u660e\u3002\n- ``\uff1a\u8eab\u4efd\u4ee4\u724c\u4e2d\u7684\u7fa3\u7d44\u8072\u660e\u3002\n- ``\uff1a\u9644\u52a0\u5230\u7528\u6236\u8072\u660e\u7684\u524d\u7db4\uff0c\u4ee5\u9632\u6b62\u8207\u73fe\u6709\u540d\u7a31\u885d\u7a81\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u9812\u767c\u8005\u524d\u7db4\u6703\u9644\u52a0\u5230\u63d0\u4f9b\u7d66 Kubernetes API \u670d\u52d9\u5668\u7684`userID`\uff08\u9664\u975e\u7528\u6236\u8072\u660e\u7232`email`\uff09\u3002\u751f\u6210\u7684\u7528\u6236\u6a19\u8b58\u7b26\u7232`` `#` ``\u3002\u6211\u5011\u5efa\u8b70\u60a8\u4f7f\u7528\u524d\u7db4\uff0c\u4f46\u60a8\u53ef\u4ee5\u901a\u904e\u5c07``\u8a2d\u7f6e\u7232`-`\u4f86\u505c\u7528\u8a72\u524d\u7db4\u3002\n- ``\uff1a\u9644\u52a0\u5230\u7fa3\u7d44\u8072\u660e\u7684\u524d\u7db4\uff0c\u4ee5\u9632\u6b62\u8207\u73fe\u6709\u540d\u7a31\u885d\u7a81\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u6709\u5169\u500b\u540d\u7232`foobar`\u7684\u7fa3\u7d44\uff0c\u8acb\u6dfb\u52a0\u524d\u7db4`gid-`\u3002\u751f\u6210\u7684\u7fa3\u7d44\u7232`gid-foobar`\u3002\n- \u61c9\u7528\u66f4\u65b0\u5f8c\u7684\u914d\u7f6e\uff1a```\nkubectl apply -f client-config.yaml\n```\u61c9\u7528\u6b64\u914d\u7f6e\u5f8c\uff0cIdentity Service for GKE \u6703\u5728\u96c6\u7fa3\u5167\u90e8\u904b\u884c\uff0c\u4e26\u901a\u904e `gke-oidc-envoy` \u8ca0\u8f09\u5747\u8861\u5668\u8655\u7406\u8acb\u6c42\u3002 `spec.server` \u5b57\u6bb5\u4e2d\u7684 IP \u5730\u5740\u5fc5\u9808\u662f\u8ca0\u8f09\u5747\u8861\u5668\u7684 IP \u5730\u5740\u3002\u5982\u679c\u60a8\u66f4\u6539 `spec.server` \u5b57\u6bb5\uff0c\u5247 `kubectl` \u547d\u4ee4\u53ef\u80fd\u6703\u5931\u6557\u3002\n- \u5275\u5efa `client-config.yaml` \u914d\u7f6e\u6587\u4ef6\u7684\u526f\u672c\uff1a```\ncp client-config.yaml login-config.yaml\n```\n- \u4f7f\u7528 `spec.authentication.oidc` \u90e8\u5206\u4e2d\u7684 `clientSecret` \u8a2d\u7f6e\u66f4\u65b0 `login-config.yaml` \u914d\u7f6e\u6587\u4ef6\u3002```\nclientSecret: CLIENT_SECRET\n```\u5c07 `` \u66ff\u63db\u7232 OIDC \u5ba2\u6236\u7aef\u61c9\u7528\u548c OIDC \u63d0\u4f9b\u65b9\u4e4b\u9593\u7684\u5171\u4eab\u5bc6\u9470\u3002\n- \u5c07\u66f4\u65b0\u7684 `login-config.yaml` \u6587\u4ef6\u5206\u767c\u7d66\u958b\u767c\u8005\u3002\n### \u5728\u5be6\u65bd\u56b4\u683c\u653f\u7b56\u7684\u96c6\u7fa3\u4e0a\u914d\u7f6e Identity Service for GKE\n\u5982\u9700\u5c07 Identity Service for GKE \u914d\u7f6e\u7232\u5728\u5be6\u65bd\u56b4\u683c\u7db2\u7d61\u653f\u7b56\u7684\u96c6\u7fa3\uff08\u4f8b\u5982\u5c08\u7528\u96c6\u7fa3\uff09\u4e0a\u6309\u9810\u671f\u5de5\u4f5c\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u7232 TCP \u7aef\u53e3`15000` [\u6dfb\u52a0\u9632\u706b\u7246\u898f\u5247](https://cloud.google.com/kubernetes-engine/docs/how-to/private-clusters?hl=zh-cn#add_firewall_rules) \uff0c\u4ee5\u5141\u8a31\u60a8\u7684\u63a7\u5236\u5e73\u9762\u8207`ClientConfig`\u9a57\u8b49\u7db2\u7d61\u9264\u5b50\u9032\u884c\u901a\u4fe1\u3002\n- \u5982\u679c`gke-oidc-envoy`\u5275\u5efa\u7232\u5167\u90e8\u8ca0\u8f09\u5747\u8861\u5668\uff0c\u8acb [\u5728 VPC \u4e0a\u516c\u958b\u5b83](https://cloud.google.com/load-balancing/docs/internal/internal-tcp-udp-lb-and-other-networks?hl=zh-cn) \u3002\n- \u5982\u679c\u60a8\u7684\u653f\u7b56\u62d2\u7d55\u96c6\u7fa3\u5167\u90e8\u7684\u6d41\u91cf\uff0c\u8acb\u7232 TCP \u7aef\u53e3`8443`\u6dfb\u52a0\u9632\u706b\u7246\u898f\u5247\uff0c\u4ee5\u5141\u8a31`gke-oidc-envoy`\u90e8\u7f72\u8207`gke-oidc-service`\u90e8\u7f72\u9032\u884c\u901a\u4fe1\u3002\nIdentity Service for GKE \u7d44\u4ef6 0.2.20 \u53ca\u66f4\u9ad8\u7248\u672c\u4e0d\u4f7f\u7528 TCP \u7aef\u53e3 `15000` \u3002\u5982\u679c\u60a8\u7684\u7d44\u4ef6\u7248\u672c\u7232 0.2.20 \u6216\u66f4\u9ad8\u7248\u672c\uff0c\u5247\u7121\u9700\u7232\u7aef\u53e3 `15000` \u6dfb\u52a0\u9632\u706b\u7246\u898f\u5247\u3002\u5982\u9700\u6aa2\u67e5\u7d44\u4ef6\u7248\u672c\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\nkubectl describe deployment gke-oidc-envoy -n anthos-identity-service \\\u00a0 \u00a0 | grep \"components.gke.io/component-name: gke-oidc\" -A1\n```\n### \u5411\u8ca0\u8f09\u5747\u8861\u5668\u6dfb\u52a0\u81ea\u5b9a\u7fa9\u5c6c\u6027\n\u914d\u7f6e Identity Service for GKE \u5f8c\uff0c\u60a8\u53ef\u4ee5\u5c07\u81ea\u5b9a\u7fa9\u8a3b\u89e3\u548c\u5c6c\u6027\uff08\u4f8b\u5982\u975c\u614b IP \u5730\u5740\uff09\u6dfb\u52a0\u5230 `gke-oidc-envoy` \u8ca0\u8f09\u5747\u8861\u5668\u3002\u8981\u7de8\u8f2f `gke-oidc-envoy` Service\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\nkubectl edit service gke-oidc-envoy -n anthos-identity-service\n```\n\u8acb\u53c3\u95b1\u76f8\u95dc\u6587\u6a94\u4ee5\u77ad\u89e3\u5982\u4f55 [\u7232 GKE \u914d\u7f6e TCP/UDP \u8ca0\u8f09\u5747\u8861](https://cloud.google.com/kubernetes-engine/docs/how-to/service-parameters?hl=zh-cn) \u3002\n## \u7232\u60a8\u7684\u96c6\u7fa3\u5275\u5efa RBAC \u653f\u7b56\n\u672c\u90e8\u5206\u9762\u5411 [\u96c6\u7fa3\u7ba1\u7406\u54e1](#personas) \u3002\n\u7ba1\u7406\u54e1\u4f7f\u7528 [Kubernetes \u57fa\u65bc\u89d2\u8272\u7684\u8a2a\u554f\u6b0a\u9650\u63a7\u5236 (RBAC)](https://kubernetes.io/docs/reference/access-authn-authz/rbac/) \u5411\u7d93\u904e\u8eab\u4efd\u9a57\u8b49\u7684\u96c6\u7fa3\u7528\u6236\u6388\u4e88\u8a2a\u554f\u6b0a\u9650\u3002\u5982\u9700\u7232\u96c6\u7fa3\u914d\u7f6e RBAC\uff0c\u60a8\u5fc5\u9808\u7232\u6bcf\u500b\u958b\u767c\u8005\u6388\u4e88 RBAC \u89d2\u8272\u3002\u8981\u6388\u4e88\u5c0d\u7279\u5b9a\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u8cc7\u6e90\u7684\u8a2a\u554f\u6b0a\u9650\uff0c\u8acb\u5275\u5efa [Role](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.25/#role-v1-rbac-authorization-k8s-io) \u548c [RoleBinding](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.25/#rolebinding-v1-rbac-authorization-k8s-io) \u8981\u6388\u4e88\u5c0d\u6574\u500b\u96c6\u7fa3\u7684\u8cc7\u6e90\u7684\u8a2a\u554f\u6b0a\u9650\uff0c\u8acb\u5275\u5efa [ClusterRole](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.25/#clusterrole-v1-rbac-authorization-k8s-io) \u548c [ClusterRoleBinding](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.25/#clusterrolebinding-v1-rbac-authorization-k8s-io) \u3002\n\u6bd4\u65b9\u8aaa\uff0c\u5047\u8a2d\u4e00\u500b\u7528\u6236\u9700\u8981\u67e5\u770b\u96c6\u7fa3\u4e2d\u7684\u6240\u6709 Secret \u5c0d\u8c61\u3002\u4ee5\u4e0b\u6b65\u9a5f\u6703\u5411\u6b64\u7528\u6236\u6388\u4e88\u6240\u9700\u7684 RBAC \u89d2\u8272\u3002\n- \u5c07\u4ee5\u4e0b ClusterRole \u6e05\u55ae\u53e6\u5b58\u7232 `secret-viewer-cluster-role.yaml` \u3002\u88ab\u6388\u4e88\u6b64\u89d2\u8272\u7684\u4eba\u54e1\u53ef\u4ee5\u7372\u53d6\u3001\u67e5\u770b\u548c\u5217\u51fa\u96c6\u7fa3\u4e2d\u7684\u4efb\u4f55 Secret\u3002```\napiVersion: rbac.authorization.k8s.io/v1kind: ClusterRolemetadata:\u00a0 name: secret-viewerrules:- apiGroups: [\"\"]\u00a0 # The resource type for which access is granted\u00a0 resources: [\"secrets\"]\u00a0 # The permissions granted by the ClusterRole\u00a0 verbs: [\"get\", \"watch\", \"list\"]\n```\n- \u61c9\u7528 ClusterRole \u6e05\u55ae\uff1a```\nkubectl apply -f secret-viewer-cluster-role.yaml\n```\n- \u5c07\u4ee5\u4e0b ClusterRoleBinding \u6e05\u55ae\u53e6\u5b58\u7232 `secret-viewer-cluster-role-binding.yaml` \u3002\u7d81\u5b9a\u6703\u5c07 `secret-viewer` \u89d2\u8272\u6388\u4e88\u5ba2\u6236\u7aef\u914d\u7f6e\u6587\u4ef6\u4e2d\u5b9a\u7fa9\u7684\u7528\u6236\u540d\u3002```\napiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata:\u00a0 name: \u00a0people-who-view-secretssubjects:- kind: User\u00a0 name: ISSUER_URI#USER\u00a0 apiGroup: rbac.authorization.k8s.ioroleRef:\u00a0 kind: ClusterRole\u00a0 name: secret-viewer\u00a0 apiGroup: rbac.authorization.k8s.io\n```\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u5ba2\u6236\u7aef\u914d\u7f6e\u6587\u4ef6\u7684`spec.authentication.oidc.issuerURI`\u4e2d\u7684\u9812\u767c\u8005 URI\u3002\n- ``\uff1a\u4ee4\u724c\u4e2d\u7684\u7528\u6236\u6a19\u8b58\u7b26\uff0c\u8a72\u4ee4\u724c\u4f4d\u65bc\u5ba2\u6236\u7aef\u914d\u7f6e\u6587\u4ef6\u7684`spec.authentication.oidc.userClaim`\u4e2d\u914d\u7f6e\u7684\u8072\u660e\u540d\u7a31\u4e4b\u4e0b\u3002\n- \u61c9\u7528 ClusterRoleBinding \u6e05\u55ae\uff1a```\nkubectl apply -f secret-viewer-cluster-role-binding.yaml\n```## \u767b\u9304\u96c6\u7fa3\u4e26\u9032\u884c\u8eab\u4efd\u9a57\u8b49\n\u672c\u90e8\u5206\u9762\u5411 [\u958b\u767c\u8005](#personas) \u3002\n\u5f9e\u7ba1\u7406\u54e1\u8655\u6536\u5230 OIDC \u914d\u7f6e\u6587\u4ef6\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5411\u96c6\u7fa3\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\n- \u4e0b\u8f09\u7ba1\u7406\u54e1\u63d0\u4f9b\u7684 `login-config.yaml` \u6587\u4ef6\u3002\n- \u5b89\u88dd [Google Cloud CLI](https://cloud.google.com/sdk/install?hl=zh-cn) SDK\uff0c\u5b83\u63d0\u4f9b\u4e86\u55ae\u7368\u7684 OIDC \u7d44\u4ef6\u3002\u60a8\u53ef\u4ee5\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u6307\u4ee4\u4f86\u5b89\u88dd\u6b64\u7d44\u4ef6\uff1a```\ngcloud components install kubectl-oidc\n```\n- \u5411\u60a8\u7684\u96c6\u7fa3\u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff1a```\nkubectl oidc login --cluster=CLUSTER_NAME --login-config=login-config.yaml\n```\u7cfb\u7d71\u6703\u6253\u958b\u7db2\u7d61\u700f\u89bd\u5668\u4ee5\u5b8c\u6210\u8eab\u4efd\u9a57\u8b49\u904e\u7a0b\u3002\n- \u5b8c\u6210\u8eab\u4efd\u9a57\u8b49\u5f8c\uff0c\u60a8\u53ef\u4ee5\u904b\u884c `kubectl` \u547d\u4ee4\uff0c\u4f8b\u5982\uff1a```\nkubectl get pods\n```## \u505c\u7528 Identity Service for GKE\n\u672c\u90e8\u5206\u9762\u5411 [\u96c6\u7fa3\u7ba1\u7406\u54e1](#personas) \u3002\n\u60a8\u53ef\u4ee5\u4f7f\u7528 gcloud CLI \u505c\u7528 Identity Service for GKE\u3002\u8981\u505c\u7528 Identity Service for GKE\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ngcloud container clusters update CLUSTER_NAME \\\u00a0 \u00a0 --no-enable-identity-service\n```\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u8a73\u7d30\u77ad\u89e3\u5982\u4f55 [\u90e8\u7f72\u5de5\u4f5c\u8ca0\u8f09](https://cloud.google.com/kubernetes-engine/docs/how-to/deploying-workloads-overview?hl=zh-cn) \u3002\n- \u8a73\u7d30\u77ad\u89e3 [OpenID Connect](https://openid.net/connect/) \u3002\n- \u8a73\u7d30\u77ad\u89e3 [\u7bc4\u570d\u548c\u8072\u660e](https://developer.okta.com/blog/2017/07/25/oidc-primer-part-1#key-concepts-scopes-claims-and-response-types) \u3002", "guide": "Google Kubernetes Engine (GKE)"}