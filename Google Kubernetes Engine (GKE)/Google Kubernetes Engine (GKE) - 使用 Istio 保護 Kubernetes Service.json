{"title": "Google Kubernetes Engine (GKE) - \u4f7f\u7528 Istio \u4fdd\u8b77 Kubernetes Service", "url": "https://cloud.google.com/kubernetes-engine/docs/tutorials/secure-services-istio?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - \u4f7f\u7528 Istio \u4fdd\u8b77 Kubernetes Service\n\u672c\u6559\u7a0b\u9069\u7528\u65bc\u6709\u610f\u4f7f\u7528 [Istio \u670d\u52d9\u7db2\u683c](https://istio.io/latest/about/service-mesh/) \u5b89\u5168\u5730\u90e8\u7f72 Kubernetes Service \u4e26\u5553\u7528\u96d9\u5411 TLS (mTLS) \u901a\u4fe1\u7684 Kubernetes \u7528\u6236\u548c\u7ba1\u7406\u54e1\u3002\n#", "content": "## Istio \u548c Anthos Service MeshIstio \u4e0d\u662f\u53d7\u652f\u6301\u7684 Google \u7522\u54c1\u3002\u6211\u5011\u5efa\u8b70\u6539\u7232\u904b\u884c\u8a17\u7ba1\u5f0f Anthos Service Mesh\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5728 GKE Autopilot \u96c6\u7fa3\u4e0a\u9810\u914d Anthos Service Mesh](https://cloud.google.com/kubernetes-engine/docs/tutorials/service-mesh?hl=zh-cn) \u3002\n\u5982\u9700\u5728 GKE Autopilot \u96c6\u7fa3\u4e0a\u904b\u884c Istio\uff0c\u60a8\u5fc5\u9808\u5728\u5bb9\u5668\u4e2d\u5553\u7528`NET_ADMIN`\u548c`NET_RAW`Linux \u529f\u80fd\u3002\u9019\u4e9b\u662f\u7372\u5f97\u7279\u6b0a\u7684 Linux \u529f\u80fd\u3002`NET_ADMIN`\u529f\u80fd\u53ef\u4ee5\u6388\u4e88\u5ee3\u6cdb\u7684\u7db2\u7d61\u64cd\u4f5c\u8a2a\u554f\u6b0a\u9650\uff0c\u4f8b\u5982\u8def\u7531\u8868\u548c\u9632\u706b\u7246\u7684\u5beb\u5165\u6b0a\u9650\u3002\u653b\u64ca\u8005\u53ef\u80fd\u6703\u5229\u7528\u6b64\u8a2a\u554f\u6b0a\u9650\u5728\u60a8\u7684\u96c6\u7fa3\u4e2d\u57f7\u884c\u63d0\u5347\u6b0a\u9650\u653b\u64ca\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [CAP_NET_ADMIN \u806f\u6a5f\u5e6b\u52a9\u9801](https://man7.org/linux/man-pages/man7/capabilities.7.html) \u3002\nAnthos Service Mesh \u5177\u6709\u4ee5\u4e0b\u512a\u52e2\uff1a- \u60a8\u53ef\u4ee5\u4f7f\u7528 [Fleet API](https://cloud.google.com/anthos/fleet-management/docs/fleet-creation?hl=zh-cn) \u9810\u914d\u8a17\u7ba1\u5f0f Anthos Service Mesh\uff0c\u800c\u7121\u9700`istioctl`\u7b49\u5ba2\u6236\u7aef\u5de5\u5177\u3002\n- Anthos Service Mesh \u6703\u81ea\u52d5\u5c07\u908a\u8eca\u4ee3\u7406\u6ce8\u5165\u5230\u5de5\u4f5c\u8ca0\u8f09\u4e2d\uff0c\u800c\u7121\u9700\u5411\u5bb9\u5668\u6388\u4e88\u63d0\u5347\u7684\u6b0a\u9650\u3002\n- \u60a8\u7121\u9700\u9032\u884c\u4efb\u4f55\u984d\u5916\u914d\u7f6e\uff0c\u5373\u53ef\u67e5\u770b\u9069\u7528\u65bc\u7db2\u683c\u548c\u670d\u52d9\u7684\u8c50\u5bcc\u4fe1\u606f\u4e2d\u5fc3\uff0c\u7136\u5f8c\u4f7f\u7528\u9019\u4e9b\u6307\u6a19\u914d\u7f6e\u670d\u52d9\u7b49\u7d1a\u76ee\u6a19 (SLO) \u548c\u63d0\u9192\uff0c\u4ee5\u76e3\u63a7\u61c9\u7528\u7684\u904b\u884c\u72c0\u6cc1\u3002\n- \u8a17\u7ba1\u5f0f Anthos Service Mesh \u63a7\u5236\u5c64\u9762\u6703\u81ea\u52d5\u5347\u7d1a\uff0c\u4ee5\u78ba\u4fdd\u60a8\u7372\u5f97\u6700\u65b0\u7684\u5b89\u5168\u88dc\u4e01\u548c\u529f\u80fd\u3002\n- Anthos Service Mesh \u8a17\u7ba1\u5f0f\u6578\u64da\u5e73\u9762\u6703\u81ea\u52d5\u5347\u7d1a\u5de5\u4f5c\u8ca0\u8f09\u4e2d\u7684\u908a\u8eca\u4ee3\u7406\uff0c\u4ee5\u4fbf\u5728\u4ee3\u7406\u5347\u7d1a\u548c\u5b89\u5168\u88dc\u4e01\u53ef\u7528\u6642\uff0c\u60a8\u7121\u9700\u81ea\u884c\u91cd\u5553\u670d\u52d9\u3002\n- Anthos Service Mesh \u662f\u53d7\u652f\u6301\u7684\u7522\u54c1\uff0c\u53ef\u4ee5\u4f7f\u7528\u6a19\u6e96\u958b\u6e90 Istio API \u9032\u884c\u914d\u7f6e\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u652f\u6301\u7684\u529f\u80fd](https://cloud.google.com/service-mesh/docs/managed/supported-features-mcp?hl=zh-cn) \u3002\n## \u76ee\u6a19\u672c\u6559\u7a0b\u5305\u62ec\u4ee5\u4e0b\u6b65\u9a5f\uff1a- \u5275\u5efa GKE Autopilot \u96c6\u7fa3\u3002\n- \u4f7f\u7528`istioctl`\u547d\u4ee4\u884c\u5de5\u5177\u5b89\u88dd Istio\u3002\n- \u90e8\u7f72\u4e00\u500b\u793a\u4f8b\u61c9\u7528\u4ee5\u6e2c\u8a66\u96d9\u5411 TLS (mTLS) \u8eab\u4efd\u9a57\u8b49\u3002\n- \u4f7f\u7528`PeerAuthentication`\u81ea\u5b9a\u7fa9\u8cc7\u6e90\u5c07 Istio \u914d\u7f6e\u7232\u4f7f\u7528 mTLS \u8eab\u4efd\u9a57\u8b49\u9032\u884c\u670d\u52d9\u5230\u670d\u52d9\u901a\u4fe1\u3002\n- \u4f7f\u7528 Kiali \u4fe1\u606f\u4e2d\u5fc3\u9a57\u8b49 mTLS \u8eab\u4efd\u9a57\u8b49\u3002\n## \u8cbb\u7528  Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them \n\u5728\u672c\u6587\u6a94\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Google Cloud \u7684\u4ee5\u4e0b\u6536\u8cbb\u7d44\u4ef6\uff1a\n- [GKE](https://cloud.google.com/kubernetes-engine/pricing?hl=zh-cn) \n- [Managed Service for Prometheus](https://cloud.google.com/stackdriver/pricing?hl=zh-cn#mgd-prometheus-pricing-summary) \n- [Cloud Load Balancing](https://cloud.google.com/vpc/network-pricing?hl=zh-cn#lb) \n\u60a8\u53ef\u4f7f\u7528 [\u50f9\u683c\u8a08\u7b97\u5668](https://cloud.google.com/products/calculator?hl=zh-cn) \u6839\u64da\u60a8\u7684\u9810\u8a08\u4f7f\u7528\u60c5\u6cc1\u4f86\u4f30\u7b97\u8cbb\u7528\u3002 \nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5b8c\u6210\u672c\u6587\u6a94\u4e2d\u63cf\u8ff0\u7684\u4efb\u52d9\u5f8c\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u522a\u9664\u6240\u5275\u5efa\u7684\u8cc7\u6e90\u4f86\u907f\u514d\u7e7c\u7e8c\u8a08\u8cbb\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u6e05\u7406](#clean-up) \u3002## \u6e96\u5099\u5de5\u4f5c [Cloud Shell](https://cloud.google.com/shell?hl=zh-cn) \u9810\u5b89\u88dd\u4e86\u672c\u6559\u7a0b\u6240\u9700\u7684\u8edf\u4ef6\uff0c\u5305\u62ec [kubectl](https://kubernetes.io/docs/reference/kubectl/) \u3001 [gcloud CLI](https://cloud.google.com/sdk/gcloud?hl=zh-cn) \u548c [Terraform](https://cloud.google.com/docs/terraform?hl=zh-cn) \u3002\u5982\u679c\u60a8\u4e0d\u4f7f\u7528 Cloud Shell\uff0c\u5247\u5fc5\u9808\u5b89\u88dd gcloud CLI\u3002- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- \u5411\u60a8\u7684 Google \u8cec\u865f\u6388\u4e88\u89d2\u8272\u3002\u5c0d\u4ee5\u4e0b\u6bcf\u500b IAM \u89d2\u8272\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4e00\u6b21\uff1a `roles/container.clusterAdmin````\ngcloud projects add-iam-policy-binding PROJECT_ID --member=\"user:EMAIL_ADDRESS\" --role=ROLE\n```- \u5c07``\u66ff\u63db\u7232\u60a8\u7684\u9805\u76ee ID\u3002\n- \u5c07``\u66ff\u63db\u7232\u60a8\u7684\u96fb\u5b50\u90f5\u4ef6\u5730\u5740\u3002\n- \u5c07``\u66ff\u63db\u7232\u6bcf\u500b\u89d2\u8272\u3002## \u6e96\u5099\u74b0\u5883\u5982\u9700\u8a2d\u7f6e\u60a8\u7684\u74b0\u5883\uff0c\u8acb\u6309\u4ee5\u4e0b\u6b65\u9a5f\u64cd\u4f5c\uff1a- \u8a2d\u7f6e\u74b0\u5883\u8b8a\u91cf\uff1a```\nexport PROJECT_ID=PROJECT_ID\ngcloud config set project $PROJECT_ID\ngcloud config set compute/region us-central1\n```\u5c07 `` \u66ff\u63db\u7232\u60a8\u7684 Google Cloud [\u9805\u76ee ID](https://cloud.google.com/resource-manager/docs/creating-managing-projects?hl=zh-cn#identifying_projects) \u3002\n- \u514b\u9686 GitHub \u4ee3\u78bc\u5eab\uff1a```\ngit clone https://github.com/GoogleCloudPlatform/kubernetes-engine-samples.git\n```\n- \u5207\u63db\u5230\u5de5\u4f5c\u76ee\u9304\uff1a```\ncd kubernetes-engine-samples/service-mesh/istio-tutorial\n```\n## \u5275\u5efa GKE \u96c6\u7fa3\u5553\u7528 Istio \u6240\u9700\u7684 Linux \u529f\u80fd\uff1a `NET_RAW` \u548c `NET_ADMIN` \u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cGKE Autopilot \u4e0d\u5141\u8a31\u4f7f\u7528 `NET_ADMIN` \uff0c\u4f46\u60a8\u53ef\u4ee5\u5728 GKE 1.27 \u7248\u53ca\u66f4\u9ad8\u7248\u672c\u4e2d\u4f7f\u7528 `--workload-policies=allow-net-admin` \u547d\u4ee4\u5553\u7528 `NET_ADMIN` \uff1a\n```\ngcloud container clusters create-auto istio-cluster \\\u00a0 \u00a0 --location=\"us-central1\" \\\u00a0 \u00a0 --workload-policies=\"allow-net-admin\"\n```\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3 GKE Autopilot \u5b89\u5168\uff0c\u8acb\u53c3\u95b1 [\u5167\u7f6e\u5b89\u5168\u914d\u7f6e](https://cloud.google.com/kubernetes-engine/docs/concepts/autopilot-security?hl=zh-cn#built-in-security) \u3002## \u5b89\u88dd Istio\u60a8\u53ef\u4ee5\u4f7f\u7528 [Istioctl](https://istio.io/latest/docs/setup/install/istioctl/) \u5728 GKE \u96c6\u7fa3\u4e0a\u5b89\u88dd Istio\u3002\n\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528\u5efa\u8b70\u7528\u65bc\u751f\u7522\u90e8\u7f72\u7684\u9ed8\u8a8d [\u914d\u7f6e\u6587\u4ef6](https://istio.io/latest/docs/setup/additional-setup/config-profiles/) \u5b89\u88dd Istio\u3002- \u5b89\u88dd Istio\uff1a```\nexport ISTIO_VERSION=1.20.2curl -L https://istio.io/downloadIstio | TARGET_ARCH=$(uname -m) sh ```\n- \u5c07 `istioctl` \u547d\u4ee4\u884c\u5de5\u5177\u6dfb\u52a0\u5230 PATH\uff1a```\ncd istio-${ISTIO_VERSION}export PATH=$PWD/bin:$PATH\n```\n- \u5728\u96c6\u7fa3\u4e0a\u5b89\u88dd Istio\uff1a```\nistioctl install --set profile=\"default\" -y\n```\u6b64\u6b65\u9a5f\u53ef\u80fd\u9700\u8981\u5e7e\u5206\u9418\u6642\u9593\u3002\n- \u7b49\u5f85 Istio Pod \u6e96\u5099\u5c31\u7dd2\uff1a```\nwatch kubectl get pods -n istio-system\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nNAME         READY STATUS  RESTARTS AGE\nistio-ingressgateway-5c47bff876-wjm96 1/1  Running  0   2m54s\nistiod-5fc7cb65cd-k8cp4     1/1  Running  0   2m57s\n```\u7576 Istio Pod \u8655\u65bc `Running` \u72c0\u614b\u6642\uff0c\u6309 `Ctrl+C` \u8fd4\u56de\u5230\u547d\u4ee4\u884c\u3002\n## \u90e8\u7f72\u793a\u4f8b\u61c9\u7528\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 [Bank of Anthos](https://github.com/GoogleCloudPlatform/bank-of-anthos) \u793a\u4f8b\u61c9\u7528\u5275\u5efa\u5177\u6709 mTLS \u8eab\u4efd\u9a57\u8b49\u7684\u670d\u52d9\u7db2\u683c\u3002- \u6dfb\u52a0\u547d\u540d\u7a7a\u9593\u6a19\u7c64\uff0c\u4ee5\u6307\u793a Istio \u5553\u7528 Envoy \u908a\u8eca\u4ee3\u7406\u7684\u81ea\u52d5\u6ce8\u5165\uff1a```\nkubectl label namespace default istio-injection=enabled\n```\n- \u90e8\u7f72\u793a\u4f8b\u61c9\u7528\uff1a```\ncd ..git clone https://github.com/GoogleCloudPlatform/bank-of-anthos.gitkubectl apply -f bank-of-anthos/extras/jwt/jwt-secret.yamlkubectl apply -f bank-of-anthos/kubernetes-manifests/\n```\n- \u7b49\u5f85\u61c9\u7528\u6e96\u5099\u5c31\u7dd2\uff1a```\nwatch kubectl get pods\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nNAME         READY STATUS RESTARTS AGE\naccounts-db-0      2/2  Running 0   2m16s\nbalancereader-5c695f78f5-x4wlz  2/2  Running 0   3m8s\ncontacts-557fc79c5-5d7fg    2/2  Running 0   3m7s\nfrontend-7dd589c5d7-b4cgq   2/2  Running 0   3m7s\nledger-db-0       2/2  Running 0   3m6s\nledgerwriter-6497f5cf9b-25c6x  2/2  Running 0   3m5s\nloadgenerator-57f6896fd6-lx5df  2/2  Running 0   3m5s\ntransactionhistory-6c498965f-tl2sk 2/2  Running 0   3m4s\nuserservice-95f44b65b-mlk2p   2/2  Running 0   3m4s\n```\u7576 Pod \u8655\u65bc `Running` \u72c0\u614b\u6642\uff0c\u6309 `Ctrl+C` \u8fd4\u56de\u5230\u547d\u4ee4\u884c\u3002\n- \u8acb\u67e5\u770b\u4ee5\u4e0b\u6e05\u55ae\uff1a [  extras/istio/frontend-ingress.yaml ](https://github.com/GoogleCloudPlatform/bank-of-anthos/blob/HEAD/extras/istio/frontend-ingress.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/bank-of-anthos/blob/HEAD/extras/istio/frontend-ingress.yaml) ```\n# Copyright 2020 Google LLC\n## Licensed under the Apache License, Version 2.0 (the \"License\");# you may not use this file except in compliance with the License.# You may obtain a copy of the License at\n## \u00a0 \u00a0 \u00a0http://www.apache.org/licenses/LICENSE-2.0\n## Unless required by applicable law or agreed to in writing, software# distributed under the License is distributed on an \"AS IS\" BASIS,# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.# See the License for the specific language governing permissions and# limitations under the License.apiVersion: networking.istio.io/v1alpha3kind: Gatewaymetadata:\u00a0 name: frontend-gatewayspec:\u00a0 selector:\u00a0 \u00a0 istio: ingressgateway # use Istio default gateway implementation\u00a0 servers:\u00a0 - port:\u00a0 \u00a0 \u00a0 number: 80\u00a0 \u00a0 \u00a0 name: http\u00a0 \u00a0 \u00a0 protocol: HTTP\u00a0 \u00a0 hosts:\u00a0 \u00a0 - \"*\"---apiVersion: networking.istio.io/v1alpha3kind: VirtualServicemetadata:\u00a0 name: frontend-ingressspec:\u00a0 hosts:\u00a0 - \"*\"\u00a0 gateways:\u00a0 - frontend-gateway\u00a0 http:\u00a0 - route:\u00a0 \u00a0 - destination:\u00a0 \u00a0 \u00a0 \u00a0 host: frontend\u00a0 \u00a0 \u00a0 \u00a0 port:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 number: 80\n```\u6b64\u6e05\u55ae\u63cf\u8ff0\u4e86\u516c\u958b\u61c9\u7528\u4e26\u4f7f\u7528 Istio \u4f5c\u7232 Ingress \u63a7\u5236\u5668\u7684 Istio [\u7db2\u95dc\u548c VirtualService](https://istio.io/latest/docs/tasks/traffic-management/ingress/ingress-control/) \u8cc7\u6e90\u3002\n- \u5c07\u6e05\u55ae\u61c9\u7528\u5230\u60a8\u7684\u96c6\u7fa3\uff1a```\nkubectl apply -f bank-of-anthos/extras/istio/frontend-ingress.yaml\n```\n## \u914d\u7f6e mTLS\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cIstio \u4e2d\u6703\u5553\u7528\u96d9\u5411 TLS (mTLS) \u8eab\u4efd\u9a57\u8b49\u3002\u9019\u610f\u5473\u7740 Istio \u6703\u76e3\u63a7\u5df2\u9077\u79fb\u5230 Istio \u4ee3\u7406\u7684\u670d\u52d9\u5668\u5de5\u4f5c\u8ca0\u8f09\uff0c\u4e26\u81ea\u52d5\u914d\u7f6e\u5ba2\u6236\u7aef\u4ee3\u7406\u4ee5\u8207\u9019\u4e9b\u5de5\u4f5c\u8ca0\u8f09\u5efa\u7acb mTLS \u9023\u63a5\u3002Istio \u9084\u6703\u5c07\u5ba2\u6236\u7aef\u4ee3\u7406\u914d\u7f6e\u7232\u5728\u9023\u63a5\u5230\u6c92\u6709\u908a\u8eca\u4ee3\u7406\u7684\u5de5\u4f5c\u8ca0\u8f09\u6642\u4e0d\u4f7f\u7528 mTLS\u3002\nIstio \u53ef\u4ee5\u5c07 mTLS \u914d\u7f6e\u7232\u5728\u4e09\u7a2e\u6a21\u5f0f\u4e0b\u5de5\u4f5c\uff1a- `PERMISSIVE`\uff1a\u5de5\u4f5c\u8ca0\u8f09\u540c\u6642\u63a5\u53d7 mTLS \u548c\u7d14\u6587\u672c\u6d41\u91cf\u3002\n- `STRICT`\uff1a\u5de5\u4f5c\u8ca0\u8f09\u50c5\u63a5\u53d7 mTLS \u6d41\u91cf\u3002\n- `DISABLE`\uff1amTLS \u8655\u65bc\u505c\u7528\u72c0\u614b\u3002\u5982\u679c\u8981\u4f7f\u7528\u81ea\u5df1\u7684\u5b89\u5168\u89e3\u6c7a\u65b9\u6848\uff0c\u8acb\u4f7f\u7528\u6b64\u6a21\u5f0f\u3002\n\u60a8\u53ef\u4ee5\u5728\u5168\u5c40\u3001\u6309\u547d\u540d\u7a7a\u9593\u6216\u6309\u5de5\u4f5c\u8ca0\u8f09\u61c9\u7528 mTLS \u914d\u7f6e\u3002\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 `STRICT` mTLS \u6a21\u5f0f\u6309\u547d\u540d\u7a7a\u9593\u61c9\u7528\u914d\u7f6e\u3002- \u8acb\u67e5\u770b\u4ee5\u4e0b\u6e05\u55ae\uff1a [  service-mesh/istio-tutorial/peer-authentication.yaml ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/service-mesh/istio-tutorial/peer-authentication.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/service-mesh/istio-tutorial/peer-authentication.yaml) ```\napiVersion: security.istio.io/v1beta1kind: PeerAuthenticationmetadata:\u00a0 name: defaultspec:\u00a0 mtls:\u00a0 \u00a0 \u00a0 mode: STRICT\n```\u6b64\u6e05\u55ae\u63cf\u8ff0\u4e86\u4e00\u500b\u5c0d\u7b49\u8eab\u4efd\u9a57\u8b49 Istio \u81ea\u5b9a\u7fa9\u8cc7\u6e90\u3002\n- \u5c07\u6e05\u55ae\u61c9\u7528\u5230\u60a8\u7684\u96c6\u7fa3\uff1a```\nkubectl apply -f peer-authentication.yaml\n```\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3 Istio \u4e2d\u7684 mTLS\uff0c\u8acb\u53c3\u95b1 [\u96d9\u5411 TLS \u8eab\u4efd\u9a57\u8b49](https://istio.io/latest/docs/concepts/security/#mutual-tls-authentication) \u3002## \u9a57\u8b49 mTLS \u662f\u5426\u5df2\u5553\u7528 [Kiali](https://kiali.io/) \u662f\u9069\u7528\u65bc Istio \u670d\u52d9\u7db2\u683c\u7684\u57fa\u65bc\u7db2\u7d61\u7684\u53ef\u89c0\u6e2c\u6027\u4fe1\u606f\u4e2d\u5fc3\uff0c\u63d0\u4f9b\u5fae\u670d\u52d9\u74b0\u5883\u7684\u5716\u5f62\u8996\u5716\uff0c\u53ef\u8b93\u60a8\u76e3\u63a7\u61c9\u7528\u4e26\u9032\u884c\u554f\u984c\u6392\u67e5\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528 Kiali \u9a57\u8b49 mTLS \u8eab\u4efd\u9a57\u8b49\u662f\u5426\u5df2\u5553\u7528\u4e14\u5728 Istio \u670d\u52d9\u7db2\u683c\u4e2d\u6b63\u5e38\u904b\u884c\u3002Kiali \u8981\u6c42\u5c07 Prometheus \u4f5c\u7232\u9059\u6e2c\u6578\u64da\u6e90\u3002\u672c\u6559\u7a0b\u4f7f\u7528 [Google Cloud Managed Service for Prometheus](https://cloud.google.com/stackdriver/docs/managed-prometheus?hl=zh-cn) \u3002\n### \u5b89\u88dd\u67e5\u8a62\u63a5\u53e3\n- \u4f7f\u7528 `roles/monitoring.viewer` \u5275\u5efa IAM \u670d\u52d9\u8cec\u865f\u4ee5\u5141\u8a31\u67e5\u8a62\u63a5\u53e3\u8a2a\u554f\u6307\u6a19\uff1a```\ngcloud iam service-accounts create monitoring \\\u00a0 \u00a0 --display-name=\"Service account for query interface\"gcloud projects add-iam-policy-binding PROJECT_ID \\\u00a0 \u00a0 --member \"serviceAccount:monitoring@PROJECT_ID.iam.gserviceaccount.com\" \\\u00a0 \u00a0 --role roles/monitoring.viewergcloud iam service-accounts add-iam-policy-binding \\\u00a0 monitoring@PROJECT_ID.iam.gserviceaccount.com \\\u00a0 \u00a0 --role roles/iam.workloadIdentityUser \\\u00a0 \u00a0 --member \"serviceAccount:PROJECT_ID.svc.id.goog[monitoring/default]\"\n```\n- \u5275\u5efa Kubernetes \u547d\u540d\u7a7a\u9593\uff1a```\nkubectl create namespace monitoring\n```\n- \u7232\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u9ed8\u8a8d Kubernetes \u670d\u52d9\u8cec\u865f\u6dfb\u52a0\u8a3b\u89e3\uff0c\u4ee5\u914d\u7f6e [\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408](https://cloud.google.com/kubernetes-engine/docs/concepts/workload-identity?hl=zh-cn) \uff1a```\nkubectl annotate serviceaccount -n monitoring default \\\u00a0 \u00a0 iam.gke.io/gcp-service-account=monitoring@PROJECT_ID.iam.gserviceaccount.com --overwrite\n```\n- \u90e8\u7f72\u67e5\u8a62\u63a5\u53e3\u5de5\u4f5c\u8ca0\u8f09\uff1a```\nkubectl -n monitoring apply -f https://raw.githubusercontent.com/GoogleCloudPlatform/prometheus-engine/v0.7.1/examples/frontend.yaml\n```\n- \u8acb\u67e5\u770b\u4ee5\u4e0b\u6e05\u55ae\uff1a [  service-mesh/istio-tutorial/pod-monitorings.yaml ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/service-mesh/istio-tutorial/pod-monitorings.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/service-mesh/istio-tutorial/pod-monitorings.yaml) ```\napiVersion: monitoring.googleapis.com/v1kind: PodMonitoringmetadata:\u00a0 name: istiod\u00a0 namespace: istio-systemspec:\u00a0 selector:\u00a0 \u00a0 matchLabels:\u00a0 \u00a0 \u00a0 app: istiod\u00a0 endpoints:\u00a0 - port: 15014\u00a0 \u00a0 path: /metrics\u00a0 \u00a0 timeout: 30s\u00a0 \u00a0 interval: 60s\n```\u6b64\u6e05\u55ae\u63cf\u8ff0\u4e86\u4e00\u500b\u6536\u96c6 Istio \u548c Envoy \u4ee3\u7406\u6307\u6a19\u7684 `PodMonitoring` \u8cc7\u6e90\u3002\n- \u5c07\u6e05\u55ae\u61c9\u7528\u5230\u60a8\u7684\u96c6\u7fa3\uff1a```\nkubectl apply -f pod-monitorings.yaml\n```\n- \u7372\u53d6\u793a\u4f8b\u61c9\u7528\u7684\u93c8\u63a5\uff1a```\nINGRESS_HOST=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.status.loadBalancer.ingress[0].ip}')echo \"http://$INGRESS_HOST\"\n```\n- \u6253\u958b\u93c8\u63a5\u4ee5\u67e5\u770b\u793a\u4f8b\u61c9\u7528\u3002\u4f7f\u7528\u9ed8\u8a8d\u7528\u6236\u540d\u548c\u5bc6\u78bc\u767b\u9304\uff0c\u4ee5\u5728\u5fae\u670d\u52d9\u4e4b\u9593\u751f\u6210\u6d41\u91cf\u3002\n### \u5b89\u88dd Kiali\u6211\u5011\u5efa\u8b70\u60a8\u4f7f\u7528 Kiali Operator \u5b89\u88dd Kiali\u3002- \u5b89\u88dd Kiali Operator\uff1a```\nhelm repo add kiali https://kiali.org/helm-chartshelm repo updatehelm install \\\u00a0 \u00a0 --namespace kiali-operator \\\u00a0 \u00a0 --create-namespace \\\u00a0 \u00a0 kiali-operator \\\u00a0 \u00a0 kiali/kiali-operator\n```\n- \u8acb\u67e5\u770b\u4ee5\u4e0b\u6e05\u55ae\uff1a [  service-mesh/istio-tutorial/kiali.yaml ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/service-mesh/istio-tutorial/kiali.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/service-mesh/istio-tutorial/kiali.yaml) ```\napiVersion: kiali.io/v1alpha1kind: Kialimetadata:\u00a0 name: kiali\u00a0 namespace: istio-systemspec:\u00a0 deployment:\u00a0 \u00a0 namespace: istio-system\u00a0 auth:\u00a0 \u00a0 strategy: anonymous\u00a0 external_services:\u00a0 \u00a0 custom_dashboards:\u00a0 \u00a0 \u00a0 prometheus:\u00a0 \u00a0 \u00a0 \u00a0 url: \"http://frontend.monitoring:9090/\"\u00a0 \u00a0 \u00a0 \u00a0 auth:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 type: none\u00a0 \u00a0 prometheus:\u00a0 \u00a0 \u00a0 url: \"http://frontend.monitoring:9090/\"\u00a0 \u00a0 \u00a0 auth:\u00a0 \u00a0 \u00a0 \u00a0 type: none\u00a0 \u00a0 tracing:\u00a0 \u00a0 \u00a0 enabled: false\u00a0 \u00a0 grafana:\u00a0 \u00a0 \u00a0 enabled: false\n```\u6b64\u6e05\u55ae\u63cf\u8ff0\u4e86\u4e00\u500b\u5b9a\u7fa9 Kiali \u670d\u52d9\u5668\u7684 Operator \u81ea\u5b9a\u7fa9\u8cc7\u6e90\u3002\n- \u5c07\u6e05\u55ae\u61c9\u7528\u5230\u60a8\u7684\u96c6\u7fa3\uff1a```\nkubectl apply -f kiali.yaml\n```\n- \u7b49\u5f85 Kiali \u670d\u52d9\u5668\u6e96\u5099\u5c31\u7dd2\uff1a```\nwatch kubectl get pods -n istio-system\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nNAME         READY STATUS RESTARTS AGE\nistio-ingressgateway-6845466857-92zp8 1/1  Running 0   9m11s\nistiod-6b47d84cf-4cqlt     1/1  Running 0   12m\n```\u7576 Pod \u8655\u65bc `Running` \u72c0\u614b\u6642\uff0c\u6309 `Ctrl+C` \u8fd4\u56de\u5230\u547d\u4ee4\u884c\u3002\n- \u5728 Kiali \u670d\u52d9\u5668\u670d\u52d9\u4e0a\u8a2d\u7f6e\u7aef\u53e3\u8f49\u767c\u4ee5\u8a2a\u554f\u4fe1\u606f\u4e2d\u5fc3\uff1a```\nkubectl -n istio-system port-forward svc/kiali 8080:20001\n```\n- \u6253\u958b\u7db2\u9801\u9810\u89bd\u3002\u5728 Kiali \u4e2d\uff0c\u8f49\u5230 **\u5716\u8868** \u90e8\u5206\uff0c\u7136\u5f8c\u5728 **\u986f\u793a** \u4e0b\u62c9\u5217\u8868\u4e2d\u9078\u64c7 **\u5b89\u5168\u6027** \u9078\u9805\u3002\u6b64\u8996\u5716\u986f\u793a\u5716\u8868\u4e2d\u6bcf\u500b\u7bc0\u9ede\u7684\u5b89\u5168\u6027\u72c0\u614b\u3002\u5e36\u6709 **\u5df2\u5553\u7528 mTLS** \u6a19\u8a18\u7684\u7bc0\u9ede\u8868\u793a\u5df2\u7232\u8a72\u670d\u52d9\u5553\u7528\u4e86 mTLS\uff0c\u800c\u4e0d\u5e36\u8a72\u6a19\u8a18\u7684\u7bc0\u9ede\u8868\u793a\u672a\u5553\u7528 mTLS\u3002\n## \u6e05\u7406\u7232\u907f\u514d\u56e0\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528\u7684\u8cc7\u6e90\u5c0e\u81f4\u60a8\u7684 Google Cloud \u8cec\u865f\u7522\u751f\u8cbb\u7528\uff0c\u8acb\u522a\u9664\u5305\u542b\u9019\u4e9b\u8cc7\u6e90\u7684\u9805\u76ee\uff0c\u6216\u8005\u4fdd\u7559\u9805\u76ee\u4f46\u522a\u9664\u5404\u500b\u8cc7\u6e90\u3002\n### \u522a\u9664\u9805\u76ee- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- **\u8b66\u544a** \uff1a\u522a\u9664\u9805\u76ee\u6703\u7522\u751f\u4ee5\u4e0b\u5f71\u97ff- **\u9805\u76ee\u4e2d\u7684\u6240\u6709\u5167\u5bb9\u90fd\u6703\u88ab\u522a\u9664\u3002** \u5982\u679c\u60a8\u5c07\u73fe\u6709\u9805\u76ee\u7528\u65bc\u672c\u6587\u6a94\u4e2d\u7684\u4efb\u52d9\uff0c\u5247\u522a\u9664\u8a72\u9805\u76ee\u5f8c\uff0c\u9084\u5c07\u522a\u9664\u60a8\u5df2\u5728\u8a72\u9805\u76ee\u4e2d\u5b8c\u6210\u7684\u4efb\u4f55\u5176\u4ed6\u5de5\u4f5c\u3002\n- **\u81ea\u5b9a\u7fa9\u9805\u76ee ID \u4e1f\u5931\u3002** \u5275\u5efa\u6b64\u9805\u76ee\u6642\uff0c\u60a8\u53ef\u80fd\u5275\u5efa\u4e86\u8981\u5728\u5c07\u4f86\u4f7f\u7528\u7684\u81ea\u5b9a\u7fa9\u9805\u76ee ID\u3002\u8981\u4fdd\u7559\u4f7f\u7528\u8a72\u9805\u76ee ID \u7684\u7db2\u5740\uff08\u4f8b\u5982`appspot.com`\u7db2\u5740\uff09\uff0c\u8acb\u522a\u9664\u9805\u76ee\u5167\u7684\u6240\u9078\u8cc7\u6e90\uff0c\u800c\u4e0d\u662f\u522a\u9664\u6574\u500b\u9805\u76ee\u3002\n\u5982\u679c\u60a8\u6253\u7b97\u63a2\u7d22\u591a\u500b\u67b6\u69cb\u3001\u6559\u7a0b\u6216\u5feb\u901f\u5165\u9580\uff0c\u5247\u91cd\u8907\u4f7f\u7528\u9805\u76ee\u53ef\u4ee5\u5e6b\u52a9\u60a8\u907f\u514d\u8d85\u51fa\u9805\u76ee\u914d\u984d\u9650\u5236\u3002\n- \u522a\u9664 Google Cloud \u9805\u76ee\uff1a\n- ```\ngcloud projects delete PROJECT_ID\n```\n### \u9010\u500b\u522a\u9664\u8cc7\u6e90\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f\u73fe\u6709\u9805\u76ee\uff0c\u4e26\u4e14\u4e0d\u60f3\u5c07\u5176\u522a\u9664\uff0c\u8acb\u9010\u500b\u522a\u9664\u8cc7\u6e90\u3002- \u522a\u9664 Kiali\uff1a```\nkubectl -n istio-system delete kiali kialihelm uninstall --namespace kiali-operator kiali-operator\n```\n- \u522a\u9664\u76e3\u63a7\u8cc7\u6e90\uff1a```\nkubectl -n monitoring delete -f https://raw.githubusercontent.com/GoogleCloudPlatform/prometheus-engine/v0.7.1/examples/frontend.yaml\n```\n- \u522a\u9664\u793a\u4f8b\u61c9\u7528\uff1a```\nkubectl delete -f bank-of-anthos/extras/istio/frontend-ingress.yamlkubectl delete -f bank-of-anthos/kubernetes-manifests\n```\n- \u5378\u8f09 Istio\uff1a```\nistioctl uninstall --purge -y\n```\n- \u522a\u9664 GKE \u96c6\u7fa3\uff1a```\ngcloud container clusters delete --region us-central1 istio-cluster --quiet\n```\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u63a2\u7d22\u6709\u95dc Google Cloud \u7684\u53c3\u8003\u67b6\u69cb\u3001\u5716\u8868\u548c\u6700\u4f73\u505a\u6cd5\u3002\u67e5\u770b\u6211\u5011\u7684 [Cloud Architecture Center](https://cloud.google.com/architecture?hl=zh-cn) \u3002", "guide": "Google Kubernetes Engine (GKE)"}