{"title": "Google Kubernetes Engine (GKE) - \u7232\u57fa\u672c\u751f\u7522\u96c6\u7fa3\u914d\u7f6e\u7db2\u7d61", "url": "https://cloud.google.com/kubernetes-engine/docs/tutorials/configure-networking?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - \u7232\u57fa\u672c\u751f\u7522\u96c6\u7fa3\u914d\u7f6e\u7db2\u7d61\n\u672c\u6559\u7a0b\u9069\u7528\u65bc\u5e0c\u671b\u5c07 Web \u61c9\u7528\u90e8\u7f72\u5230 Google Kubernetes Engine (GKE) \u96c6\u7fa3\u4e26\u4f7f\u7528 HTTPS \u8ca0\u8f09\u5747\u8861\u5668\u516c\u958b\u7684\u96f2\u67b6\u69cb\u5e2b\u548c\u904b\u7dad\u7ba1\u7406\u54e1\u3002", "content": "## \u76ee\u6a19\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u5b78\u7fd2\u5982\u4f55\u5b8c\u6210\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u5275\u5efa GKE \u96c6\u7fa3\u3002\n- \u4f7f\u7528 Terraform \u5275\u5efa\u5168\u5c40 IP \u5730\u5740\u548c Cloud DNS \u5340\u57df\u3002\n- \u914d\u7f6e HTTPS \u8ca0\u8f09\u5747\u8861\u3002\n- \u90e8\u7f72\u793a\u4f8b Web \u61c9\u7528\u3002\n## \u8cbb\u7528\nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728\u672c\u6587\u6a94\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Google Cloud \u7684\u4ee5\u4e0b\u6536\u8cbb\u7d44\u4ef6\uff1a- [GKE](https://cloud.google.com/kubernetes-engine/pricing?hl=zh-cn) \n- [Cloud Load Balancing](https://cloud.google.com/load-balancing/pricing?hl=zh-cn) \n- [\u5916\u90e8 IP \u5730\u5740](https://cloud.google.com/vpc/network-pricing?hl=zh-cn#ipaddress) \n\u60a8\u53ef\u4f7f\u7528 [\u50f9\u683c\u8a08\u7b97\u5668](https://cloud.google.com/products/calculator?hl=zh-cn) \u6839\u64da\u60a8\u7684\u9810\u8a08\u4f7f\u7528\u60c5\u6cc1\u4f86\u4f30\u7b97\u8cbb\u7528\u3002 \nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5b8c\u6210\u672c\u6587\u6a94\u4e2d\u63cf\u8ff0\u7684\u4efb\u52d9\u5f8c\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u522a\u9664\u6240\u5275\u5efa\u7684\u8cc7\u6e90\u4f86\u907f\u514d\u7e7c\u7e8c\u8a08\u8cbb\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u6e05\u7406](#clean-up) \u3002## \u9808\u77e5\u4e8b\u9805\n### \u8a2d\u7f6e\u9805\u76ee\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them- \u60a8\u5fc5\u9808\u64c1\u6709\u57df\u540d\u3002\u57df\u540d\u9577\u5ea6\u4e0d\u5f97\u8d85\u904e 63 \u500b\u5b57\u7b26\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528 [Google Domains](https://domains.google.com/?hl=zh-cn) \u6216\u5176\u4ed6\u8a3b\u518a\u5546\u3002\n### \u8a2d\u7f6e\u60a8\u7684\u74b0\u5883\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 [Cloud Shell](https://cloud.google.com/shell?hl=zh-cn) \u4f86\u7ba1\u7406 Google Cloud \u4e0a\u8a17\u7ba1\u7684\u8cc7\u6e90\u3002Cloud Shell \u4e2d\u9810\u5b89\u88dd\u4e86\u672c\u6559\u7a0b\u6240\u9700\u7684\u8edf\u4ef6\uff0c\u5305\u62ec [Terraform](https://cloud.google.com/docs/terraform/get-started-with-terraform?hl=zh-cn) \u3001 [kubectl](https://kubernetes.io/docs/reference/kubectl/) \u548c [gcloud CLI](https://cloud.google.com/sdk/gcloud?hl=zh-cn) \u3002- \u8a2d\u7f6e\u74b0\u5883\u8b8a\u91cf\uff1a```\nPROJECT_ID=$(gcloud config get-value project)gcloud config set project $PROJECT_IDgcloud config set compute/region us-central1\n```\n- \u514b\u9686\u4ee3\u78bc\u5eab\uff1a```\ngit clone https://github.com/GoogleCloudPlatform/kubernetes-engine-samples.git\n```\n- \u5207\u63db\u5230\u5de5\u4f5c\u76ee\u9304\uff1a```\ncd kubernetes-engine-samples/autopilot/networking-tutorial\n```\n## \u5275\u5efa GKE \u96c6\u7fa3\u4ee5\u4e0b Terraform \u6587\u4ef6\u6703\u5275\u5efa\u4e00\u500b GKE \u96c6\u7fa3\uff1a\n [  autopilot/networking-tutorial/main.tf ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/autopilot/networking-tutorial/main.tf) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/autopilot/networking-tutorial/main.tf) \n```\nterraform {\u00a0 required_version = \"~> 1.3\"}provider \"google\" {}variable \"region\" {\u00a0 type \u00a0 \u00a0 \u00a0 \u00a0= string\u00a0 description = \"Region where the cluster will be created.\"\u00a0 default \u00a0 \u00a0 = \"us-central1\"}variable \"cluster_name\" {\u00a0 type \u00a0 \u00a0 \u00a0 \u00a0= string\u00a0 description = \"Name of the cluster\"\u00a0 default \u00a0 \u00a0 = \"networking-cluster\"}resource \"google_container_cluster\" \"default\" {\u00a0 name \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 = var.cluster_name\u00a0 description \u00a0 \u00a0 \u00a0= \"Cluster for sample web application\"\u00a0 location \u00a0 \u00a0 \u00a0 \u00a0 = var.region\u00a0 enable_autopilot = true\u00a0 ip_allocation_policy {}}output \"region\" {\u00a0 value \u00a0 \u00a0 \u00a0 = var.region\u00a0 description = \"Compute region\"}output \"cluster_name\" {\u00a0 value \u00a0 \u00a0 \u00a0 = google_container_cluster.default.name\u00a0 description = \"Cluster name\"}\n```\n\u4ee5\u4e0b Terraform \u6587\u4ef6\u6703\u5275\u5efa\u5168\u5c40 IP \u5730\u5740\u548c Cloud DNS \u5340\u57df\uff1a\n [  autopilot/networking-tutorial/dns.tf ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/autopilot/networking-tutorial/dns.tf) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/autopilot/networking-tutorial/dns.tf) \n```\nterraform {\u00a0 required_version = \"~> 1.3\"}variable \"base_domain\" {\u00a0 type \u00a0 \u00a0 \u00a0 \u00a0= string\u00a0 description = \"Your base domain\"}variable \"name\" {\u00a0 type \u00a0 \u00a0 \u00a0 \u00a0= string\u00a0 description = \"Name of resources\"\u00a0 default \u00a0 \u00a0 = \"networking-tutorial\"}data \"google_client_config\" \"current\" {}resource \"google_compute_global_address\" \"default\" {\u00a0 name = var.name}resource \"google_dns_managed_zone\" \"default\" {\u00a0 name \u00a0 \u00a0 \u00a0 \u00a0= var.name\u00a0 dns_name \u00a0 \u00a0= \"${var.name}.${var.base_domain}.\"\u00a0 description = \"DNS Zone for web application\"}resource \"google_dns_record_set\" \"a\" {\u00a0 name \u00a0 \u00a0 \u00a0 \u00a0 = google_dns_managed_zone.default.dns_name\u00a0 type \u00a0 \u00a0 \u00a0 \u00a0 = \"A\"\u00a0 ttl \u00a0 \u00a0 \u00a0 \u00a0 \u00a0= 300\u00a0 managed_zone = google_dns_managed_zone.default.name\u00a0 rrdatas = [google_compute_global_address.default.address]}resource \"google_dns_record_set\" \"cname\" {\u00a0 name \u00a0 \u00a0 \u00a0 \u00a0 = join(\".\", compact([\"www\", google_dns_record_set.a.name]))\u00a0 type \u00a0 \u00a0 \u00a0 \u00a0 = \"CNAME\"\u00a0 ttl \u00a0 \u00a0 \u00a0 \u00a0 \u00a0= 300\u00a0 managed_zone = google_dns_managed_zone.default.name\u00a0 rrdatas = [google_dns_record_set.a.name]}output \"dns_zone_name_servers\" {\u00a0 value \u00a0 \u00a0 \u00a0 = google_dns_managed_zone.default.name_servers\u00a0 description = \"Write these virtual name servers in your base domain.\"}output \"domain\" {\u00a0 value = trim(google_dns_record_set.a.name, \".\")}\n```- \u521d\u59cb\u5316 Terraform\uff1a```\nterraform init\n```\n- \u67e5\u770b\u57fa\u790e\u67b6\u69cb\u66f4\u6539\uff1a```\nterraform plan\n```\u51fa\u73fe\u63d0\u793a\u6642\uff0c\u8acb\u8f38\u5165\u60a8\u7684\u7db2\u57df\uff0c\u4f8b\u5982 `my-domain.net` \u3002\n- \u61c9\u7528 Terraform \u914d\u7f6e\uff1a```\nterraform apply --auto-approve\n```\u51fa\u73fe\u63d0\u793a\u6642\uff0c\u8acb\u8f38\u5165\u60a8\u7684\u7db2\u57df\uff0c\u4f8b\u5982 `my-domain.net` \u3002\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nApply complete! Resources: 1 added, 0 changed, 0 destroyed.\nOutputs:\ncluster_name = \"networking-cluster\"\nregion = \"us-central1\"\n```\n## \u5275\u5efa\u5916\u90e8\u61c9\u7528\u8ca0\u8f09\u5747\u8861\u5668\n- \u4ee5\u4e0b\u6e05\u55ae\u63cf\u8ff0\u4e86 ManagedCertificate\u3001FrontendConfig\u3001Deployment\u3001Service \u548c Ingress\uff1a [  autopilot/networking-tutorial/kubernetes-manifests.yaml ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/autopilot/networking-tutorial/kubernetes-manifests.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/autopilot/networking-tutorial/kubernetes-manifests.yaml) ```\n---apiVersion: networking.gke.io/v1kind: ManagedCertificatemetadata:\u00a0 name: networking-managed-certspec:\u00a0 domains:\u00a0 \u00a0 - DOMAIN_NAME\u00a0 \u00a0 - www.DOMAIN_NAME---apiVersion: networking.gke.io/v1beta1kind: FrontendConfigmetadata:\u00a0 name: networking-fcspec:\u00a0 redirectToHttps:\u00a0 \u00a0 enabled: true\u00a0 \u00a0 responseCodeName: MOVED_PERMANENTLY_DEFAULT---apiVersion: apps/v1kind: Deploymentmetadata:\u00a0 name: frontendspec:\u00a0 selector:\u00a0 \u00a0 matchLabels:\u00a0 \u00a0 \u00a0 app: frontend\u00a0 replicas: 2\u00a0 template:\u00a0 \u00a0 metadata:\u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 app: frontend\u00a0 \u00a0 spec:\u00a0 \u00a0 \u00a0 containers:\u00a0 \u00a0 \u00a0 - name: echo-amd64\u00a0 \u00a0 \u00a0 \u00a0 image: us-docker.pkg.dev/google-samples/containers/gke/hello-app-cdn:1.0---apiVersion: v1kind: Servicemetadata:\u00a0 name: frontendspec:\u00a0 type: LoadBalancer\u00a0 selector:\u00a0 \u00a0 app: frontend\u00a0 ports:\u00a0 - name: http\u00a0 \u00a0 port: 80\u00a0 \u00a0 targetPort: 8080---apiVersion: networking.k8s.io/v1kind: Ingressmetadata:\u00a0 name: frontend\u00a0 annotations:\u00a0 \u00a0 networking.gke.io/managed-certificates: networking-managed-cert\u00a0 \u00a0 networking.gke.io/v1beta1.FrontendConfig: networking-fc\u00a0 \u00a0 kubernetes.io/ingress.global-static-ip-name: networking-tutorial\u00a0 \u00a0 kubernetes.io/ingress.class: gce\u00a0 labels:\u00a0 \u00a0 app: frontendspec:\u00a0 defaultBackend:\u00a0 \u00a0 service:\u00a0 \u00a0 \u00a0 name: frontend\u00a0 \u00a0 \u00a0 port:\u00a0 \u00a0 \u00a0 \u00a0 number: 80\n```\u5c07 `` \u66ff\u63db\u7232\u60a8\u7684\u57df\u540d\uff0c\u4f8b\u5982 `my-domain.net` \u3002\u6b64\u6e05\u55ae\u5177\u6709\u4ee5\u4e0b\u5c6c\u6027\uff1a- `networking.gke.io/managed-certificates`\uff1aManagedCertificate \u7684\u540d\u7a31\u3002\n- `networking.gke.io/v1beta1.FrontendConfig`\uff1aFrontendConfig \u8cc7\u6e90\u7684\u540d\u7a31\u3002\n- `kubernetes.io/ingress.global-static-ip-name`\uff1aIP \u5730\u5740\u7684\u540d\u7a31\u3002\n- `kubernetes.io/ingress.class`\uff1a\u6307\u793a GKE Ingress \u63a7\u5236\u5668\u5275\u5efa\u5916\u90e8\u61c9\u7528\u8ca0\u8f09\u5747\u8861\u5668\u3002\n- \u5c07\u6e05\u55ae\u61c9\u7528\u5230\u60a8\u7684\u96c6\u7fa3\uff1a```\nkubectl apply -f kubernetes-manifests.yaml\n```\n- \u9a57\u8b49 Ingress \u5df2\u5275\u5efa\uff1a```\nkubectl describe ingress frontend\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\n...\n Events:\n Type Reason Age From      Message\n ---- ------ ---- ----      ------ Normal ADD  2m loadbalancer-controller default/frontend\n Normal CREATE 1m loadbalancer-controller ip: 203.0.113.2\n...\n```Ingress \u53ef\u80fd\u9700\u8981\u5e7e\u5206\u9418\u624d\u80fd\u5b8c\u6210\u9810\u914d\u3002\n## \u6e2c\u8a66\u61c9\u7528\n- \u6aa2\u67e5 SSL \u8b49\u66f8\u7684\u72c0\u614b\uff1a```\nkubectl get managedcertificates.networking.gke.io networking-managed-cert\n```SSL \u8b49\u66f8\u6700\u591a\u53ef\u80fd\u9700\u8981 30 \u5206\u9418\u624d\u80fd\u5b8c\u6210\u9810\u914d\u3002\u4ee5\u4e0b\u8f38\u51fa\u8868\u660e SSL \u8b49\u66f8\u5df2\u6e96\u5099\u5c31\u7dd2\uff1a```\nNAME      AGE STATUS\nnetworking-managed-cert 28m Active\n```\n- \u904b\u884c `curl` \u547d\u4ee4\uff1a```\ncurl -Lv https://DOMAIN_NAME\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\n* Trying 34.160.115.33:443...\n* Connected to DOMAIN_NAME (34.160.115.33) port 443 (#0)\n...\n* TLSv1.3 (IN), TLS handshake, Certificate (11):\n...\n* Server certificate:\n* subject: CN=DOMAIN_NAME\n...\n> Host: DOMAIN_NAME\n```\n## \u6e05\u7406\u7232\u907f\u514d\u56e0\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528\u7684\u8cc7\u6e90\u5c0e\u81f4\u60a8\u7684 Google Cloud \u8cec\u865f\u7522\u751f\u8cbb\u7528\uff0c\u8acb\u522a\u9664\u5305\u542b\u9019\u4e9b\u8cc7\u6e90\u7684\u9805\u76ee\uff0c\u6216\u8005\u4fdd\u7559\u9805\u76ee\u4f46\u522a\u9664\u5404\u500b\u8cc7\u6e90\u3002\n### \u522a\u9664\u9805\u76ee- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- **\u8b66\u544a** \uff1a\u522a\u9664\u9805\u76ee\u6703\u7522\u751f\u4ee5\u4e0b\u5f71\u97ff- **\u9805\u76ee\u4e2d\u7684\u6240\u6709\u5167\u5bb9\u90fd\u6703\u88ab\u522a\u9664\u3002** \u5982\u679c\u60a8\u5c07\u73fe\u6709\u9805\u76ee\u7528\u65bc\u672c\u6587\u6a94\u4e2d\u7684\u4efb\u52d9\uff0c\u5247\u522a\u9664\u8a72\u9805\u76ee\u5f8c\uff0c\u9084\u5c07\u522a\u9664\u60a8\u5df2\u5728\u8a72\u9805\u76ee\u4e2d\u5b8c\u6210\u7684\u4efb\u4f55\u5176\u4ed6\u5de5\u4f5c\u3002\n- **\u81ea\u5b9a\u7fa9\u9805\u76ee ID \u4e1f\u5931\u3002** \u5275\u5efa\u6b64\u9805\u76ee\u6642\uff0c\u60a8\u53ef\u80fd\u5275\u5efa\u4e86\u8981\u5728\u5c07\u4f86\u4f7f\u7528\u7684\u81ea\u5b9a\u7fa9\u9805\u76ee ID\u3002\u8981\u4fdd\u7559\u4f7f\u7528\u8a72\u9805\u76ee ID \u7684\u7db2\u5740\uff08\u4f8b\u5982`appspot.com`\u7db2\u5740\uff09\uff0c\u8acb\u522a\u9664\u9805\u76ee\u5167\u7684\u6240\u9078\u8cc7\u6e90\uff0c\u800c\u4e0d\u662f\u522a\u9664\u6574\u500b\u9805\u76ee\u3002\n\u5982\u679c\u60a8\u6253\u7b97\u63a2\u7d22\u591a\u500b\u67b6\u69cb\u3001\u6559\u7a0b\u6216\u5feb\u901f\u5165\u9580\uff0c\u5247\u91cd\u8907\u4f7f\u7528\u9805\u76ee\u53ef\u4ee5\u5e6b\u52a9\u60a8\u907f\u514d\u8d85\u51fa\u9805\u76ee\u914d\u984d\u9650\u5236\u3002\n- \u522a\u9664 Google Cloud \u9805\u76ee\uff1a\n- ```\ngcloud projects delete PROJECT_ID\n```\n### \u522a\u9664\u5404\u500b\u8cc7\u6e90- \u522a\u9664 kubernetes \u8cc7\u6e90\uff1a```\nkubectl delete -f kubernetes-manifests.yaml\n```\n- \u522a\u9664 Terraform \u8cc7\u6e90\uff1a```\nterraform destroy --auto-approve\n```\u51fa\u73fe\u63d0\u793a\u6642\uff0c\u8acb\u8f38\u5165\u60a8\u7684\u7db2\u57df\uff0c\u4f8b\u5982 `my-domain.net` \u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u8a73\u7d30\u77ad\u89e3 [GKE \u7db2\u7d61](https://cloud.google.com/kubernetes-engine/docs/concepts/network-overview?hl=zh-cn) \u3002", "guide": "Google Kubernetes Engine (GKE)"}