{"title": "Google Kubernetes Engine (GKE) - \u5275\u5efa\u5c08\u7528\u96c6\u7fa3", "url": "https://cloud.google.com/kubernetes-engine/docs/how-to/private-clusters?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - \u5275\u5efa\u5c08\u7528\u96c6\u7fa3\n\u672c\u9801\u9762\u4ecb\u7d39\u5982\u4f55\u5275\u5efa\u5c08\u7528 Google Kubernetes Engine (GKE) \u96c6\u7fa3\uff0c\u8a72\u96c6\u7fa3\u662f\u4e00\u7a2e VPC \u539f\u751f\u96c6\u7fa3\u3002\u5728\u5c08\u7528\u96c6\u7fa3\u4e2d\uff0c\u7bc0\u9ede\u50c5\u5177\u6709 [\u5167\u90e8 IP \u5730\u5740](https://cloud.google.com/vpc/docs/ip-addresses?hl=zh-cn) \uff0c\u9019\u610f\u5473\u7740\u7bc0\u9ede\u548c Pod \u9ed8\u8a8d\u8207\u4e92\u806f\u7db2\u9694\u96e2\u3002\n\u7bc0\u9ede\u7684\u5167\u90e8 IP \u5730\u5740\u4f86\u81ea\u60a8\u7232\u96c6\u7fa3\u9078\u64c7\u7684\u5b50\u7db2\u7684\u4e3b\u8981 IP \u5730\u5740\u7bc4\u570d\u3002Pod IP \u5730\u5740\u548c Service IP \u5730\u5740\u4f86\u81ea\u540c\u4e00\u5b50\u7db2\u7684\u5169\u500b\u5b50\u7db2\u6b21\u8981 IP \u5730\u5740\u7bc4\u570d\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [VPC \u539f\u751f\u96c6\u7fa3\u7684 IP \u5730\u5740\u7bc4\u570d](https://cloud.google.com/kubernetes-engine/docs/concepts/alias-ips?hl=zh-cn#cluster_sizing) \u3002\nGKE 1.14.2 \u7248\u53ca\u66f4\u9ad8\u7248\u672c\u652f\u6301\u4efb\u4f55\u5167\u90e8 IP \u5730\u5740\u7bc4\u570d\uff0c\u5305\u62ec\u5c08\u7528\u7bc4\u570d\uff08RFC 1918 \u548c\u5176\u4ed6\u5c08\u7528\u7bc4\u570d\uff09\u4ee5\u53ca\u5c08\u9580\u4f7f\u7528\u7684\u516c\u5171 IP \u5730\u5740\u7bc4\u570d\u3002\u5982\u9700\u67e5\u770b [\u6709\u6548\u5167\u90e8 IP \u5730\u5740\u7bc4\u570d](https://cloud.google.com/vpc/docs/subnets?hl=zh-cn#valid-ranges) \u7684\u5217\u8868\uff0c\u8acb\u53c3\u95b1 VPC \u6587\u6a94\u3002\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5c08\u7528\u96c6\u7fa3\u7684\u5de5\u4f5c\u539f\u7406\uff0c\u8acb\u53c3\u95b1 [\u5c08\u7528\u96c6\u7fa3](https://cloud.google.com/kubernetes-engine/docs/concepts/private-cluster-concept?hl=zh-cn) \u3002\n", "content": "## \u6e96\u5099\u5de5\u4f5c\n\u5728\u9032\u884c\u4e0b\u4e00\u6b65\u9a5f\u4e4b\u524d\uff0c\u8acb\u5148\u719f\u6089 [\u8981\u6c42\u3001\u9650\u5236\u548c\u4fb7\u9650](#req_res_lim) \u3002\n\u5728\u958b\u59cb\u4e4b\u524d\uff0c\u8acb\u78ba\u4fdd\u60a8\u5df2\u57f7\u884c\u4ee5\u4e0b\u4efb\u52d9\uff1a\n- \u5553\u7528 Google Kubernetes Engine API\u3002\n- [  \u5553\u7528 Google Kubernetes Engine API ](https://console.cloud.google.com/flows/enableapi?apiid=container.googleapis.com&hl=zh-cn) \n- \u5982\u679c\u60a8\u8981\u4f7f\u7528 Google Cloud CLI \u57f7\u884c\u6b64\u4efb\u52d9\uff0c\u8acb [\u5b89\u88dd](https://cloud.google.com/sdk/docs/install?hl=zh-cn) \u4e26 [\u521d\u59cb\u5316](https://cloud.google.com/sdk/docs/initializing?hl=zh-cn) gcloud CLI\u3002 \u5982\u679c\u60a8\u4e4b\u524d\u5b89\u88dd\u4e86 gcloud CLI\uff0c\u8acb\u904b\u884c`gcloud components update`\u4ee5\u7372\u53d6\u6700\u65b0\u7248\u672c\u3002 **\u6ce8\u610f** \uff1a\u5c0d\u65bc\u73fe\u6709 gcloud CLI \u5b89\u88dd\uff0c\u8acb\u52d9\u5fc5\u8a2d\u7f6e`compute/region`\u548c`compute/zone` [\u5c6c\u6027](https://cloud.google.com/sdk/docs/properties?hl=zh-cn#setting_properties) \u3002\u901a\u904e\u8a2d\u7f6e\u9ed8\u8a8d\u4f4d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u907f\u514d gcloud CLI \u4e2d\u51fa\u73fe\u4ee5\u4e0b\u932f\u8aa4\uff1a`One of [--zone, --region] must be supplied: Please specify location`\u3002\n- \u78ba\u4fdd\u60a8\u5177\u6709\u5275\u5efa\u96c6\u7fa3\u7684\u6b63\u78ba\u6b0a\u9650\u3002\u60a8\u81f3\u5c11\u61c9\u662f [Kubernetes Engine Cluster Admin](https://cloud.google.com/iam/docs/understanding-roles?hl=zh-cn#kubernetes-engine-roles) \u3002\n- \u78ba\u4fdd\u60a8\u6709\u901a\u5411\u9ed8\u8a8d\u4e92\u806f\u7db2\u7db2\u95dc\u7684\u8def\u7531\u3002## \u5275\u5efa\u7121\u6cd5\u901a\u904e\u5ba2\u6236\u7aef\u8a2a\u554f\u516c\u5171\u7aef\u9ede\u7684\u5c08\u7528\u96c6\u7fa3\n\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u5275\u5efa\u4ee5\u4e0b\u8cc7\u6e90\uff1a\n- \u540d\u7232`private-cluster-0`\u7684\u5c08\u7528\u96c6\u7fa3\uff0c\u8a72\u96c6\u7fa3\u5177\u6709\u5c08\u7528\u7bc0\u9ede\uff0c\u4f46\u6c92\u6709\u5c0d\u516c\u5171\u7aef\u9ede\u7684\u5ba2\u6236\u7aef\u8a2a\u554f\u6b0a\u9650\u3002\n- \u540d\u7232`my-net-0`\u7684\u7db2\u7d61\u3002\n- \u540d\u7232`my-subnet-0`\u7684\u5b50\u7db2\u3002\n**\u91cd\u8981\u63d0\u793a** \uff1a\u5373\u4f7f\u60a8\u505c\u7528\u5c0d\u516c\u5171\u7aef\u9ede\u7684\u8a2a\u554f\u6b0a\u9650\uff0cGKE \u4e5f\u53ef\u4ee5\u4f7f\u7528\u63a7\u5236\u5e73\u9762\u7684\u516c\u5171\u7aef\u9ede\u9032\u884c\u96c6\u7fa3\u7ba1\u7406\uff08\u4f8b\u5982 [\u8a08\u5283\u6027\u7dad\u8b77](https://cloud.google.com/kubernetes-engine/docs/scheduled-maintenance?hl=zh-cn) \u548c [\u81ea\u52d5\u5347\u7d1a](https://cloud.google.com/kubernetes-engine/versioning-and-upgrades?hl=zh-cn#automatic_cp_upgrades) \uff09\u3002\n### \u5275\u5efa\u7db2\u7d61\u548c\u5b50\u7db2\n- \u524d\u5f80 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **VPC \u7db2\u7d61** \u9801\u9762\u3002 [\u9032\u5165\u201cVPC \u7db2\u7d61\u201d](https://console.cloud.google.com/networking/networks/list?hl=zh-cn) \n- \u9ede\u64ca **\u5275\u5efa VPC \u7db2\u7d61** \u3002\n- \u5c0d\u65bc **\u540d\u7a31** \uff0c\u8f38\u5165 `my-net-0` \u3002\n- \u5c0d\u65bc **\u5b50\u7db2\u5275\u5efa\u6a21\u5f0f** \uff0c\u9078\u64c7 **\u81ea\u5b9a\u7fa9** \u3002\n- \u5728 **\u65b0\u5b50\u7db2** \u90e8\u5206\u7684 **\u540d\u7a31** \u4e2d\uff0c\u8f38\u5165 `my-subnet-0` \u3002\n- \u5728 **\u5730\u5340** \u5217\u8868\u4e2d\uff0c\u9078\u64c7\u6240\u9700\u7684\u5730\u5340\u3002\n- \u5c0d\u65bc **IP \u5730\u5740\u7bc4\u570d** \uff0c\u8f38\u5165 `10.2.204.0/22` \u3002\n- \u5c07 **\u5c08\u7528 Google \u8a2a\u554f\u901a\u9053** \u8a2d\u7f6e\u7232 **\u958b\u5553** \u3002\n- \u9ede\u64ca **\u5b8c\u6210** \u3002\n- \u9ede\u64ca **\u5275\u5efa** \u3002\n### \u5275\u5efa\u5c08\u7528\u96c6\u7fa3\n- \u8f49\u5230 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **Google Kubernetes Engine** \u9801\u9762\u3002 [\u8f49\u5230 Google Kubernetes Engine](https://console.cloud.google.com/kubernetes/list?hl=zh-cn) \n- \u9ede\u64ca add_box **\u5275\u5efa** \uff0c\u7136\u5f8c\u5728Standard \u6216 Autopilot \u90e8\u5206\u4e2d\u9ede\u64ca **\u914d\u7f6e** \u3002\n- \u5c0d\u65bc **\u540d\u7a31** \uff0c\u6307\u5b9a `private-cluster-0` \u3002\n- \u5728\u5c0e\u822a\u7a97\u683c\u4e2d\uff0c\u9ede\u64ca **\u7db2\u7d61** \u3002\n- \u5728 **\u7db2\u7d61** \u5217\u8868\u4e2d\uff0c\u9078\u64c7 **my-net-0** \u3002\n- \u5728 **\u7bc0\u9ede\u5b50\u7db2** \u5217\u8868\u4e2d\uff0c\u9078\u64c7 **my-subnet-0** \u3002\n- \u9078\u64c7 **\u5c08\u7528\u96c6\u7fa3** \u55ae\u9078\u6309\u9215\u3002\n- \u53d6\u6d88\u9078\u4e2d **\u4f7f\u7528\u5916\u90e8 IP \u5730\u5740\u7684\u63a7\u5236\u5e73\u9762** \u8907\u9078\u6846\u3002\n- \uff08\u5c0d\u65bc Autopilot \u800c\u8a00\u7232\u53ef\u9078\uff09\uff1a\u5c07 **\u63a7\u5236\u5c64\u9762 IP \u5730\u5740\u7bc4\u570d** \u8a2d\u7f6e\u7232 `172.16.0.32/28` \u3002\n- \u9ede\u64ca **\u5275\u5efa** \u3002\n- \u5c0d\u65bc Autopilot \u96c6\u7fa3\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud container clusters create-auto private-cluster-0 \\\u00a0 \u00a0 --create-subnetwork name=my-subnet-0 \\\u00a0 \u00a0 --enable-master-authorized-networks \\\u00a0 \u00a0 --enable-private-nodes \\\u00a0 \u00a0 --enable-private-endpoint\n```\n- \u5c0d\u65bc Standard \u96c6\u7fa3\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud container clusters create private-cluster-0 \\\u00a0 \u00a0 --create-subnetwork name=my-subnet-0 \\\u00a0 \u00a0 --enable-master-authorized-networks \\\u00a0 \u00a0 --enable-ip-alias \\\u00a0 \u00a0 --enable-private-nodes \\\u00a0 \u00a0 --enable-private-endpoint \\\u00a0 \u00a0 --master-ipv4-cidr 172.16.0.32/28\n```\n\u5176\u4e2d\uff1a- `--create-subnetwork name=my-subnet-0`\u4f7f GKE \u81ea\u52d5\u5275\u5efa\u540d\u7232`my-subnet-0`\u7684\u5b50\u7db2\u3002\n- `--enable-master-authorized-networks`\u7528\u65bc\u6307\u5b9a\u50c5\u9650\u60a8\u6388\u6b0a\u7684 IP \u5730\u5740\u7bc4\u570d\u8a2a\u554f\u516c\u5171\u7aef\u9ede\u3002\n- `--enable-ip-alias`\u4f7f\u96c6\u7fa3\u6210\u7232 VPC \u539f\u751f\u96c6\u7fa3\uff08\u5c0d\u65bc Autopilot \u800c\u8a00\u4e26\u975e\u5fc5\u9700\uff09\u3002\n- `--enable-private-nodes`\u8868\u793a\u96c6\u7fa3\u7684\u7bc0\u9ede\u6c92\u6709\u5916\u90e8 IP \u5730\u5740\u3002\n- `--enable-private-endpoint`\u8868\u793a\u4f7f\u7528\u63a7\u5236\u5c64\u9762 API \u7aef\u9ede\u7684\u5c08\u7528 IP \u5730\u5740\u7ba1\u7406\u96c6\u7fa3\u3002\n- `--master-ipv4-cidr 172.16.0.32/28`\u6307\u5b9a\u63a7\u5236\u5c64\u9762\u7684\u5167\u90e8 IP \u5730\u5740\u7bc4\u570d\uff08\u5c0d\u65bc Autopilot \u800c\u8a00\u53ef\u9078\uff09\u3002\u6b64\u8a2d\u7f6e\u5c0d\u65bc\u8a72\u96c6\u7fa3\u662f\u6c38\u4e45\u6027\u7684\uff0c\u4e26\u4e14\u5728 VPC \u4e2d\u5fc5\u9808\u662f\u552f\u4e00\u7684\u3002\u7cfb\u7d71\u652f\u6301 [\u4f7f\u7528\u975e RFC 1918 \u5167\u90e8 IP \u5730\u5740](https://cloud.google.com/kubernetes-engine/docs/concepts/alias-ips?hl=zh-cn#internal_ip_addresses) \u3002\n\u5982\u9700\u5275\u5efa\u4e0d\u5177\u5099\u53ef\u516c\u958b\u8a2a\u554f\u7684\u63a7\u5236\u5c64\u9762\u7684\u96c6\u7fa3\uff0c\u8acb\u5728 `privateClusterConfig` \u8cc7\u6e90\u4e2d\u6307\u5b9a `enablePrivateEndpoint: true` \u5b57\u6bb5\u3002\n**\u6ce8\u610f** \uff1a\u5728 Autopilot \u96c6\u7fa3\u4e2d\uff0c\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u7cfb\u7d71\u6703\u7232 `--master-ipv4-cidr` \u53c3\u6578\u5206\u914d 172.16.0.0/16 \u7bc4\u570d\u5167\u7684\u5b50\u7db2\u3002\u6b64\u7bc4\u570d\u652f\u6301\u5404\u7a2e\u5b50\u7db2\u5927\u5c0f\u3002\n\u6b64\u6642\uff0c\u53ea\u6709\u4ee5\u4e0b\u7bc4\u570d\u5167\u7684\u5730\u5740\u624d\u80fd\u8a2a\u554f\u63a7\u5236\u5c64\u9762\uff1a\n- `my-subnet-0`\u7684\u4e3b\u8981\u7bc4\u570d\u3002\n- \u7528\u65bc Pod \u7684\u6b21\u8981\u7bc4\u570d\u3002\n\u4f8b\u5982\uff0c\u5047\u8a2d\u60a8\u5728 `my-subnet-0` \u7684\u4e3b\u8981\u7bc4\u570d\u5167\u5275\u5efa\u4e86\u4e00\u500b\u865b\u64ec\u6a5f\u3002 \u5728\u8a72\u865b\u64ec\u6a5f\u4e0a\uff0c\u60a8\u53ef\u4ee5 [\u914d\u7f6e kubectl \u4ee5\u4f7f\u7528\u63a7\u5236\u5c64\u9762\u7684\u5167\u90e8 IP \u5730\u5740](https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-access-for-kubectl?hl=zh-cn#internal_ip) \u3002\n\u5982\u679c\u60a8\u60f3\u5f9e `my-subnet-0` \u5916\u90e8\u8a2a\u554f\u63a7\u5236\u5c64\u9762\uff0c\u5247\u5fc5\u9808\u81f3\u5c11\u6388\u6b0a\u4e00\u500b\u5730\u5740\u7bc4\u570d\u8a2a\u554f\u5c08\u7528\u7aef\u9ede\u3002\n\u5047\u8a2d\u60a8\u7684\u865b\u64ec\u6a5f\u4f4d\u65bc\u9ed8\u8a8d\u7db2\u7d61\u4e2d\uff0c\u4e26\u4e14\u8207\u60a8\u7684\u96c6\u7fa3\u4f4d\u65bc\u540c\u4e00\u5340\u57df\uff0c\u4f46\u4e0d\u5728 `my-subnet-0` \u4e2d\u3002\n\u4f8b\u5982\uff1a\n- `my-subnet-0`\uff1a`10.0.0.0/22`\n- Pod \u6b21\u8981\u7bc4\u570d\uff1a`10.52.0.0/14`\n- \u865b\u64ec\u6a5f\u5730\u5740\uff1a`10.128.0.3`\n\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6388\u6b0a\u865b\u64ec\u6a5f\u8a2a\u554f\u63a7\u5236\u5c64\u9762\uff1a\n```\ngcloud container clusters update private-cluster-0 \\\u00a0 \u00a0 --enable-master-authorized-networks \\\u00a0 \u00a0 --master-authorized-networks 10.128.0.3/32\n```\n## \u5275\u5efa\u5c0d\u516c\u5171\u7aef\u9ede\u7684\u8a2a\u554f\u53d7\u9650\u7684\u5c08\u7528\u96c6\u7fa3\n\u4f7f\u7528\u6b64\u914d\u7f6e\u5275\u5efa\u5c08\u7528\u96c6\u7fa3\u6642\uff0c\u60a8\u53ef\u4ee5\u9078\u64c7\u4f7f\u7528\u81ea\u52d5\u751f\u6210\u7684\u5b50\u7db2\u6216\u81ea\u5b9a\u7fa9\u7684\u5b50\u7db2\u3002\n### \u4f7f\u7528\u81ea\u52d5\u751f\u6210\u7684\u5b50\u7db2\n\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u5275\u5efa\u4e00\u500b\u540d\u7232 `private-cluster-1` \u7684\u5c08\u7528\u96c6\u7fa3\uff0c\u5176\u4e2d GKE \u6703\u81ea\u52d5\u7232\u60a8\u7684\u96c6\u7fa3\u7bc0\u9ede\u751f\u6210\u5b50\u7db2\u3002\u8a72\u5b50\u7db2\u5553\u7528\u4e86\u5c08\u7528 Google \u8a2a\u554f\u901a\u9053\u3002\u5728\u8a72\u5b50\u7db2\u4e2d\uff0cGKE \u6703\u81ea\u52d5\u5275\u5efa\u5169\u500b\u6b21\u8981\u7bc4\u570d\uff1a\u4e00\u500b\u7528\u65bc Pod\uff0c\u53e6\u4e00\u500b\u7528\u65bc Service\u3002\n\u60a8\u53ef\u4ee5\u4f7f\u7528 Google Cloud CLI \u6216 GKE API\u3002\n- \u5c0d\u65bc Autopilot \u96c6\u7fa3\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud container clusters create-auto private-cluster-1 \\\u00a0 \u00a0 --create-subnetwork name=my-subnet-1 \\\u00a0 \u00a0 --enable-master-authorized-networks \\\u00a0 \u00a0 --enable-private-nodes\n```\n- \u5c0d\u65bc Standard \u96c6\u7fa3\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud container clusters create private-cluster-1 \\\u00a0 \u00a0 --create-subnetwork name=my-subnet-1 \\\u00a0 \u00a0 --enable-master-authorized-networks \\\u00a0 \u00a0 --enable-ip-alias \\\u00a0 \u00a0 --enable-private-nodes \\\u00a0 \u00a0 --master-ipv4-cidr 172.16.0.0/28\n```\n\u5176\u4e2d\uff1a- `--create-subnetwork name=my-subnet-1`\u4f7f GKE \u81ea\u52d5\u5275\u5efa\u540d\u7232`my-subnet-1`\u7684\u5b50\u7db2\u3002\n- `--enable-master-authorized-networks`\u7528\u65bc\u6307\u5b9a\u50c5\u9650\u60a8\u6388\u6b0a\u7684 IP \u5730\u5740\u7bc4\u570d\u8a2a\u554f\u516c\u5171\u7aef\u9ede\u3002\n- `--enable-ip-alias`\u4f7f\u96c6\u7fa3\u6210\u7232 VPC \u539f\u751f\u96c6\u7fa3\uff08\u5c0d\u65bc Autopilot \u800c\u8a00\u4e26\u975e\u5fc5\u9700\uff09\u3002\n- `--enable-private-nodes`\u8868\u793a\u96c6\u7fa3\u7684\u7bc0\u9ede\u6c92\u6709\u5916\u90e8 IP \u5730\u5740\u3002\n- `--master-ipv4-cidr 172.16.0.0/28`\u6307\u5b9a\u63a7\u5236\u5c64\u9762\u7684\u5167\u90e8 IP \u5730\u5740\u7bc4\u570d\uff08\u5c0d\u65bc Autopilot \u800c\u8a00\u53ef\u9078\uff09\u3002\u6b64\u8a2d\u7f6e\u5c0d\u65bc\u8a72\u96c6\u7fa3\u662f\u6c38\u4e45\u6027\u7684\uff0c\u4e26\u4e14\u5728 VPC \u4e2d\u5fc5\u9808\u662f\u552f\u4e00\u7684\u3002\u7cfb\u7d71\u652f\u6301 [\u4f7f\u7528\u975e RFC 1918 \u5167\u90e8 IP \u5730\u5740](https://cloud.google.com/kubernetes-engine/docs/concepts/alias-ips?hl=zh-cn#internal_ip_addresses) \u3002\n\u5728 `Cluster` API \u8cc7\u6e90\u4e2d\u6307\u5b9a `privateClusterConfig` \u5b57\u6bb5\uff1a\n```\n{\u00a0 \"name\": \"private-cluster-1\",\u00a0 ...\u00a0 \"ipAllocationPolicy\": {\u00a0 \u00a0 \"createSubnetwork\": true,\u00a0 },\u00a0 ...\u00a0 \u00a0 \"privateClusterConfig\" {\u00a0 \u00a0 \u00a0 \"enablePrivateNodes\": boolean # Creates nodes with internal IP addresses only\u00a0 \u00a0 \u00a0 \"enablePrivateEndpoint\": boolean # false creates a cluster control plane with a publicly-reachable endpoint\u00a0 \u00a0 \u00a0 \"masterIpv4CidrBlock\": string # CIDR block for the cluster control plane\u00a0 \u00a0 \u00a0 \"privateEndpoint\": string # Output only\u00a0 \u00a0 \u00a0 \"publicEndpoint\": string # Output only\u00a0 }}\n```\n\u6b64\u6642\uff0c\u53ea\u6709\u4ee5\u4e0b\u7bc4\u570d\u5167\u7684\u5730\u5740\u624d\u80fd\u8a2a\u554f\u96c6\u7fa3\u63a7\u5236\u5c64\u9762\uff1a\n- `my-subnet-1`\u7684\u4e3b\u8981\u7bc4\u570d\u3002\n- \u7528\u65bc Pod \u7684\u6b21\u8981\u7bc4\u570d\u3002\n\u5047\u8a2d\u60a8\u6709\u4e00\u7d44\u6a5f\u5668\u4f4d\u65bc VPC \u7db2\u7d61\u4e4b\u5916\uff0c\u5b83\u5011\u7684\u5730\u5740\u5728\u7bc4\u570d `203.0.113.0/29` \u5167\u3002\u60a8\u53ef\u4ee5\u901a\u904e\u8f38\u5165\u4ee5\u4e0b\u547d\u4ee4\u5411\u9019\u4e9b\u6a5f\u5668\u6388\u4e88\u5c0d\u516c\u5171\u7aef\u9ede\u7684\u8a2a\u554f\u6b0a\u9650\uff1a\n```\ngcloud container clusters update private-cluster-1 \\\u00a0 \u00a0 --enable-master-authorized-networks \\\u00a0 \u00a0 --master-authorized-networks 203.0.113.0/29\n```\n\u73fe\u5728\uff0c\u53ea\u6709\u4ee5\u4e0b\u7bc4\u570d\u5167\u7684\u5730\u5740\u624d\u80fd\u8a2a\u554f\u63a7\u5236\u5c64\u9762\uff1a\n- `my-subnet-1`\u7684\u4e3b\u8981\u7bc4\u570d\u3002\n- \u7528\u65bc Pod \u7684\u6b21\u8981\u7bc4\u570d\u3002\n- \u60a8\u5df2\u6388\u6b0a\u7684\u5730\u5740\u7bc4\u570d\uff0c\u4f8b\u5982`203.0.113.0/29`\u3002\n### \u4f7f\u7528\u81ea\u5b9a\u7fa9\u5b50\u7db2\n\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u5275\u5efa\u4ee5\u4e0b\u8cc7\u6e90\uff1a\n- \u540d\u7232`private-cluster-2`\u7684\u5c08\u7528\u96c6\u7fa3\u3002\n- \u540d\u7232`my-net-2`\u7684\u7db2\u7d61\u3002\n- \u7528\u65bc\u96c6\u7fa3\u7bc0\u9ede\u7684\u4e3b\u7bc4\u570d\u7232`192.168.0.0/20`\u7684`my-subnet-2`\u5b50\u7db2\u3002\u60a8\u7684\u5b50\u7db2\u5177\u6709\u4ee5\u4e0b\u6b21\u8981\u5730\u5740\u7bc4\u570d\uff1a- `my-pods`\uff08\u5c0d\u65bc Pod IP \u5730\u5740\uff09\u3002\n- `my-services`\uff08\u5c0d\u65bc Service IP \u5730\u5740\uff09\u3002\n- \u524d\u5f80 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **VPC \u7db2\u7d61** \u9801\u9762\u3002 [\u9032\u5165\u201cVPC \u7db2\u7d61\u201d](https://console.cloud.google.com/networking/networks/list?hl=zh-cn) \n- \u9ede\u64ca **\u5275\u5efa VPC \u7db2\u7d61** \u3002\n- \u5c0d\u65bc **\u540d\u7a31** \uff0c\u8f38\u5165 `my-net-2` \u3002\n- \u5c0d\u65bc **\u5b50\u7db2\u5275\u5efa\u6a21\u5f0f** \uff0c\u9078\u64c7 **\u81ea\u5b9a\u7fa9** \u3002\n- \u5728 **\u65b0\u5b50\u7db2** \u90e8\u5206\u7684 **\u540d\u7a31** \u4e2d\uff0c\u8f38\u5165 `my-subnet-2` \u3002\n- \u5728 **\u5730\u5340** \u5217\u8868\u4e2d\uff0c\u9078\u64c7\u6240\u9700\u7684\u5730\u5340\u3002\n- \u5c0d\u65bc **IP \u5730\u5740\u7bc4\u570d** \uff0c\u8f38\u5165 `192.168.0.0/20` \u3002\n- \u9ede\u64ca **\u5275\u5efa\u6b21\u8981 IP \u7bc4\u570d** \u3002\u5728 **\u5b50\u7db2\u7bc4\u570d\u540d\u7a31** \u90e8\u5206\uff0c\u8f38\u5165 `my-services` \uff1b\u5728 **\u6b21\u8981 IP \u7bc4\u570d** \u90e8\u5206\uff0c\u8f38\u5165 `10.0.32.0/20` \u3002\n- \u9ede\u64ca **\u6dfb\u52a0 IP \u7bc4\u570d** \u3002\u5728 **\u5b50\u7db2\u7bc4\u570d\u540d\u7a31** \u90e8\u5206\uff0c\u8f38\u5165 `my-pods` \uff1b\u5728 **\u6b21\u8981 IP \u7bc4\u570d** \u90e8\u5206\uff0c\u8f38\u5165 `10.4.0.0/14` \u3002\n- \u5c07 **\u5c08\u7528 Google \u8a2a\u554f\u901a\u9053** \u8a2d\u7f6e\u7232 **\u958b\u5553** \u3002\n- \u9ede\u64ca **\u5b8c\u6210** \u3002\n- \u9ede\u64ca **\u5275\u5efa** \u3002\n\u5275\u5efa\u4f7f\u7528\u5b50\u7db2\u7684\u5c08\u7528\u96c6\u7fa3\uff1a- \u8f49\u5230 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **Google Kubernetes Engine** \u9801\u9762\u3002 [\u8f49\u5230 Google Kubernetes Engine](https://console.cloud.google.com/kubernetes/list?hl=zh-cn) \n- \u9ede\u64ca add_box **\u5275\u5efa** \uff0c\u7136\u5f8c\u5728Standard \u6216 Autopilot \u90e8\u5206\u4e2d\u9ede\u64ca **\u914d\u7f6e** \u3002\n- \u5c0d\u65bc **\u540d\u7a31** \uff0c\u8acb\u8f38\u5165 `private-cluster-2` \u3002\n- \u5728\u5c0e\u822a\u7a97\u683c\u4e2d\uff0c\u9ede\u64ca **\u7db2\u7d61** \u3002\n- \u9078\u64c7 **\u5c08\u7528\u96c6\u7fa3** \u55ae\u9078\u6309\u9215\u3002\n- \u5982\u9700\u5275\u5efa\u53ef\u5f9e\u6388\u6b0a\u5916\u90e8 IP \u7bc4\u570d\u8a2a\u554f\u7684\u63a7\u5236\u5c64\u9762\uff0c\u8acb\u4fdd\u6301 **\u4f7f\u7528\u5916\u90e8 IP \u5730\u5740\u8a2a\u554f\u4e3b\u7bc0\u9ede** \u8907\u9078\u6846\u8655\u65bc\u9078\u4e2d\u72c0\u614b\u3002\n- \uff08\u5c0d\u65bc Autopilot \u800c\u8a00\u7232\u53ef\u9078\uff09\uff1a\u5c07 **\u63a7\u5236\u5c64\u9762 IP \u5730\u5740\u7bc4\u570d** \u8a2d\u7f6e\u7232 `172.16.0.16/28` \u3002\n- \u5728 **\u7db2\u7d61** \u5217\u8868\u4e2d\uff0c\u9078\u64c7 **my-net-2** \u3002\n- \u5728 **\u7bc0\u9ede\u5b50\u7db2** \u5217\u8868\u4e2d\uff0c\u9078\u64c7 **my-subnet-2** \u3002\n- \u6e05\u9664 **\u81ea\u52d5\u5275\u5efa\u6b21\u8981\u7bc4\u570d** \u8907\u9078\u6846\u3002\n- \u5728 **Pod \u6b21\u8981 CIDR \u7bc4\u570d** \u5217\u8868\u4e2d\uff0c\u9078\u64c7 **my-pods** \u3002\n- \u5728 **Service \u6b21\u8981 CIDR \u7bc4\u570d** \u5217\u8868\u4e2d\uff0c\u9078\u64c7 **my-services** \u3002\n- \u9078\u4e2d **\u5553\u7528\u63a7\u5236\u5e73\u9762\u6388\u6b0a\u7db2\u7d61** \u8907\u9078\u6846\u3002\n- \u9ede\u64ca **\u5275\u5efa** \u3002\n\u9996\u5148\uff0c\u7232\u60a8\u7684\u96c6\u7fa3\u5275\u5efa\u4e00\u500b\u7db2\u7d61\u3002\u4ee5\u4e0b\u547d\u4ee4\u6703\u5275\u5efa\u4e00\u500b\u7db2\u7d61 `my-net-2` \uff1a\n```\ngcloud compute networks create my-net-2 \\\u00a0 \u00a0 --subnet-mode custom\n```\u63a5\u4e0b\u4f86\uff0c\u5728 `my-net-2` \u7db2\u7d61\u4e2d\u5275\u5efa\u4e00\u500b\u5b50\u7db2 `my-subnet-2` \uff0c\u5176\u6b21\u8981\u7bc4\u570d\u7232 `my-pods` \uff08\u7528\u65bc Pod\uff09\u548c `my-services` \uff08\u7528\u65bc Service\uff09\uff1a\n```\ngcloud compute networks subnets create my-subnet-2 \\\u00a0 \u00a0 --network my-net-2 \\\u00a0 \u00a0 --range 192.168.0.0/20 \\\u00a0 \u00a0 --secondary-range my-pods=10.4.0.0/14,my-services=10.0.32.0/20 \\\u00a0 \u00a0 --enable-private-ip-google-access\n```\u73fe\u5728\uff0c\u4f7f\u7528\u60a8\u5275\u5efa\u7684\u7db2\u7d61\u3001\u5b50\u7db2\u4ee5\u53ca\u6b21\u8981\u7bc4\u570d\u5275\u5efa\u4e00\u500b\u5c08\u7528\u96c6\u7fa3 `private-cluster-2` \u3002- \u5c0d\u65bc Autopilot \u96c6\u7fa3\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud container clusters create-auto private-cluster-2 \\\u00a0 \u00a0 --enable-master-authorized-networks \\\u00a0 \u00a0 --network my-net-2 \\\u00a0 \u00a0 --subnetwork my-subnet-2 \\\u00a0 \u00a0 --cluster-secondary-range-name my-pods \\\u00a0 \u00a0 --services-secondary-range-name my-services \\\u00a0 \u00a0 --enable-private-nodes\n```\n- \u5c0d\u65bc Standard \u96c6\u7fa3\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud container clusters create private-cluster-2 \\\u00a0 \u00a0 --enable-master-authorized-networks \\\u00a0 \u00a0 --network my-net-2 \\\u00a0 \u00a0 --subnetwork my-subnet-2 \\\u00a0 \u00a0 --cluster-secondary-range-name my-pods \\\u00a0 \u00a0 --services-secondary-range-name my-services \\\u00a0 \u00a0 --enable-private-nodes \\\u00a0 \u00a0 --enable-ip-alias \\\u00a0 \u00a0 --master-ipv4-cidr 172.16.0.16/28 \\\u00a0 \u00a0 --no-enable-basic-auth \\\u00a0 \u00a0 --no-issue-client-certificate\n```\u6b64\u6642\uff0c\u53ea\u6709\u4ee5\u4e0b\u7bc4\u570d\u5167\u7684\u5730\u5740\u624d\u80fd\u8a2a\u554f\u63a7\u5236\u5c64\u9762\uff1a\n- `my-subnet-2`\u7684\u4e3b\u8981\u7bc4\u570d\u3002\n- \u6b21\u8981\u7bc4\u570d`my-pods`\u3002\n\u5047\u8a2d\u60a8\u6709\u4e00\u7d44\u6a5f\u5668\u4f4d\u65bc `my-net-2` \u4e4b\u5916\uff0c\u5b83\u5011\u7684\u5730\u5740\u5728\u7bc4\u570d `203.0.113.0/29` \u5167\u3002\u60a8\u53ef\u4ee5\u901a\u904e\u8f38\u5165\u4ee5\u4e0b\u547d\u4ee4\u5411\u9019\u4e9b\u6a5f\u5668\u6388\u4e88\u5c0d\u516c\u5171\u7aef\u9ede\u7684\u8a2a\u554f\u6b0a\u9650\uff1a\n```\ngcloud container clusters update private-cluster-2 \\\u00a0 \u00a0 --enable-master-authorized-networks \\\u00a0 \u00a0 --master-authorized-networks 203.0.113.0/29\n```\n\u6b64\u6642\uff0c\u53ea\u6709\u4ee5\u4e0b\u7bc4\u570d\u5167\u7684\u5730\u5740\u624d\u80fd\u8a2a\u554f\u63a7\u5236\u5c64\u9762\uff1a\n- `my-subnet-2`\u7684\u4e3b\u8981\u7bc4\u570d\u3002\n- \u6b21\u8981\u7bc4\u570d`my-pods`\u3002\n- \u60a8\u5df2\u6388\u6b0a\u7684\u5730\u5740\u7bc4\u570d\uff0c\u4f8b\u5982`203.0.113.0/29`\u3002\n### \u4f7f\u7528 Cloud Shell \u8a2a\u554f\u5c08\u7528\u96c6\u7fa3\n**\u91cd\u8981\u63d0\u793a** \uff1a\u5982\u679c\u60a8\u5553\u7528\u4e86\u5c08\u7528\u7aef\u9ede\uff0c\u5247\u7121\u6cd5\u901a\u904e Cloud Shell \u8a2a\u554f GKE \u63a7\u5236\u5c64\u9762\u3002\n\u60a8\u5728 [\u4f7f\u7528\u81ea\u52d5\u751f\u6210\u7684\u5b50\u7db2](#auto_subnet) \u90e8\u5206\u4e2d\u5275\u5efa\u7684\u5c08\u7528\u96c6\u7fa3 `private-cluster-1` \u5177\u6709\u516c\u5171\u7aef\u9ede\uff0c\u4e26\u4e14\u5553\u7528\u4e86\u5df2\u7372\u6388\u6b0a\u7684\u7db2\u7d61\u3002\u5982\u679c\u8981\u4f7f\u7528 [Cloud Shell](https://cloud.google.com/shell/docs/quickstart?hl=zh-cn) \u8a2a\u554f\u96c6\u7fa3\uff0c\u5247\u5fc5\u9808\u5c07 Cloud Shell \u7684\u516c\u5171 IP \u5730\u5740\u6dfb\u52a0\u5230\u96c6\u7fa3\u7684\u5df2\u7372\u6388\u6b0a\u7684\u7db2\u7d61\u5217\u8868\u4e2d\u3002\n\u7232\u6b64\uff0c\u8acb\u6309\u4ee5\u4e0b\u8aaa\u660e\u64cd\u4f5c\uff1a\n- \u5728 Cloud Shell \u547d\u4ee4\u884c\u7a97\u53e3\u4e2d\uff0c\u4f7f\u7528 `dig` \u67e5\u627e Cloud Shell \u7684\u5916\u90e8 IP \u5730\u5740\uff1a```\ndig +short myip.opendns.com @resolver1.opendns.com\n```\n- \u5c07 Cloud Shell \u7684\u5916\u90e8\u5730\u5740\u6dfb\u52a0\u5230\u96c6\u7fa3\u7684\u6388\u6b0a\u7db2\u7d61\u5217\u8868\u4e2d\uff1a```\ngcloud container clusters update private-cluster-1 \\\u00a0 \u00a0 --enable-master-authorized-networks \\\u00a0 \u00a0 --master-authorized-networks EXISTING_AUTH_NETS,SHELL_IP/32\n```\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- `` \uff1a\u73fe\u6709\u7684\u5df2\u7372\u6388\u6b0a\u7684\u7db2\u7d61\u5217\u8868\u7684 IP \u5730\u5740\u3002\u60a8\u53ef\u4ee5\u5728\u63a7\u5236\u6aaf\u4e2d\u67e5\u627e\u6388\u6b0a\u7db2\u7d61\uff0c\u4e5f\u53ef\u4ee5\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4f86\u67e5\u627e\uff1a```\ngcloud container clusters describe private-cluster-1 --format \"flattened(masterAuthorizedNetworksConfig.cidrBlocks[])\"\n```\n- `` \uff1a\u60a8\u7684 Cloud Shell \u7684\u5916\u90e8 IP \u5730\u5740\u3002\n- \u7372\u53d6\u6191\u64da\uff0c\u4ee5\u4fbf\u4f7f\u7528 `kubectl` \u8a2a\u554f\u96c6\u7fa3\uff1a```\ngcloud container clusters get-credentials private-cluster-1 \\\u00a0 \u00a0 --project=PROJECT_ID \\\u00a0 \u00a0 --internal-ip\n```\u5c07 `` \u66ff\u63db\u7232\u60a8\u7684\u9805\u76ee ID\u3002\n- \u5728 Cloud Shell \u4e2d\u4f7f\u7528 `kubectl` \u8a2a\u554f\u5c08\u7528\u96c6\u7fa3\uff1a```\nkubectl get nodes\n```\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\nNAME            STATUS ROLES AGE VERSION\ngke-private-cluster-1-default-pool-7d914212-18jv Ready <none> 104m v1.21.5-gke.1302\ngke-private-cluster-1-default-pool-7d914212-3d9p Ready <none> 104m v1.21.5-gke.1302\ngke-private-cluster-1-default-pool-7d914212-wgqf Ready <none> 104m v1.21.5-gke.1302\n```## \u5275\u5efa\u5c0d\u516c\u5171\u7aef\u9ede\u5177\u6709\u4e0d\u53d7\u9650\u5236\u7684\u8a2a\u554f\u6b0a\u9650\u7684\u5c08\u7528\u96c6\u7fa3\n\u5728\u672c\u90e8\u5206\u4e2d\uff0c\u60a8\u5c07\u5275\u5efa\u4e00\u500b\u5c08\u7528\u96c6\u7fa3\uff0c\u4f7f\u5f97\u4efb\u4f55 IP \u5730\u5740\u90fd\u53ef\u4ee5\u8a2a\u554f\u63a7\u5236\u5c64\u9762\u3002\n- \u8f49\u5230 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **Google Kubernetes Engine** \u9801\u9762\u3002 [\u8f49\u5230 Google Kubernetes Engine](https://console.cloud.google.com/kubernetes/list?hl=zh-cn) \n- \u9ede\u64ca add_box **\u5275\u5efa** \uff0c\u7136\u5f8c\u5728Standard \u6216 Autopilot \u90e8\u5206\u4e2d\u9ede\u64ca **\u914d\u7f6e** \u3002\n- \u5c0d\u65bc **\u540d\u7a31** \uff0c\u8acb\u8f38\u5165 `private-cluster-3` \u3002\n- \u5728\u5c0e\u822a\u7a97\u683c\u4e2d\uff0c\u9ede\u64ca **\u7db2\u7d61** \u3002\n- \u9078\u64c7 **\u5c08\u7528\u96c6\u7fa3** \u9078\u9805\u3002\n- \u4fdd\u6301 **\u4f7f\u7528\u5916\u90e8 IP \u5730\u5740\u7684\u8a2a\u554f\u6b0a\u9650\u63a7\u5236** \u8907\u9078\u6846\u8655\u65bc\u9078\u4e2d\u72c0\u614b\u3002\n- \uff08\u5c0d\u65bc Autopilot \u800c\u8a00\u7232\u53ef\u9078\uff09\uff1a\u5c07 **\u63a7\u5236\u5c64\u9762 IP \u5730\u5740\u7bc4\u570d** \u8a2d\u7f6e\u7232 `172.16.0.32/28` \u3002\n- \u5c07 **\u7db2\u7d61** \u548c **\u7bc0\u9ede\u5b50\u7db2** \u4fdd\u7559\u8a2d\u7f6e\u7232 `default` \u3002\u9019\u6703\u4f7f GKE \u7232\u60a8\u7684\u96c6\u7fa3\u751f\u6210\u5b50\u7db2\u3002\n- \u53d6\u6d88\u9078\u4e2d **\u5553\u7528\u63a7\u5236\u5e73\u9762\u6388\u6b0a\u7db2\u7d61** \u8907\u9078\u6846\u3002\n- \u9ede\u64ca **\u5275\u5efa** \u3002\n- \u5c0d\u65bc Autopilot \u96c6\u7fa3\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud container clusters create-auto private-cluster-3 \\\u00a0 \u00a0 --create-subnetwork name=my-subnet-3 \\\u00a0 \u00a0 --no-enable-master-authorized-networks \\\u00a0 \u00a0 --enable-private-nodes\n```\n- \u5c0d\u65bc Standard \u96c6\u7fa3\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud container clusters create private-cluster-3 \\\u00a0 \u00a0 --create-subnetwork name=my-subnet-3 \\\u00a0 \u00a0 --no-enable-master-authorized-networks \\\u00a0 \u00a0 --enable-ip-alias \\\u00a0 \u00a0 --enable-private-nodes \\\u00a0 \u00a0 --master-ipv4-cidr 172.16.0.32/28\n```\n\u5176\u4e2d\uff1a- `--create-subnetwork name=my-subnet-3`\u4f7f GKE \u81ea\u52d5\u5275\u5efa\u540d\u7232`my-subnet-3`\u7684\u5b50\u7db2\u3002\n- `--no-enable-master-authorized-networks`\u7528\u65bc\u7232\u96c6\u7fa3\u505c\u7528\u5df2\u6388\u6b0a\u7684\u7db2\u7d61\u3002\n- `--enable-ip-alias`\u4f7f\u96c6\u7fa3\u6210\u7232 VPC \u539f\u751f\u96c6\u7fa3\uff08\u5c0d\u65bc Autopilot \u800c\u8a00\u4e26\u975e\u5fc5\u9700\uff09\u3002\n- `--enable-private-nodes`\u8868\u793a\u96c6\u7fa3\u7684\u7bc0\u9ede\u6c92\u6709\u5916\u90e8 IP \u5730\u5740\u3002\n- `--master-ipv4-cidr 172.16.0.32/28`\u6307\u5b9a\u63a7\u5236\u5c64\u9762\u7684\u5167\u90e8 IP \u5730\u5740\u7bc4\u570d\uff08\u5c0d\u65bc Autopilot \u800c\u8a00\u53ef\u9078\uff09\u3002\u6b64\u8a2d\u7f6e\u5c0d\u65bc\u8a72\u96c6\u7fa3\u662f\u6c38\u4e45\u6027\u7684\uff0c\u4e26\u4e14\u5728 VPC \u4e2d\u5fc5\u9808\u662f\u552f\u4e00\u7684\u3002\u7cfb\u7d71\u652f\u6301 [\u4f7f\u7528\u975e RFC 1918 \u5167\u90e8 IP \u5730\u5740](https://cloud.google.com/kubernetes-engine/docs/concepts/alias-ips?hl=zh-cn#internal_ip_addresses) \u3002\n## \u5176\u4ed6\u5c08\u7528\u96c6\u7fa3\u914d\u7f6e\n\u9664\u4e0a\u8ff0\u914d\u7f6e\u5916\uff0c\u60a8\u9084\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u914d\u7f6e\u904b\u884c\u5c08\u7528\u96c6\u7fa3\u3002\n### \u6388\u4e88\u5c08\u7528\u7bc0\u9ede\u51fa\u7ad9\u4e92\u806f\u7db2\u8a2a\u554f\u6b0a\u9650\n\u5982\u9700\u7232\u5c08\u7528\u7bc0\u9ede\u63d0\u4f9b\u51fa\u7ad9\u4e92\u806f\u7db2\u8a2a\u554f\u6b0a\u9650\uff08\u4f8b\u5982\u5f9e\u5916\u90e8\u8a3b\u518a\u8868\u62c9\u53d6\u6620\u50cf\uff09\uff0c\u8acb\u4f7f\u7528 [Cloud NAT](https://cloud.google.com/nat/docs/overview?hl=zh-cn) \u5275\u5efa\u4e26\u914d\u7f6e\u4e00\u500b Cloud Router \u8def\u7531\u5668\u3002Cloud NAT \u5141\u8a31\u5c08\u7528\u96c6\u7fa3\u901a\u904e\u4e92\u806f\u7db2\u5efa\u7acb\u51fa\u7ad9\u9023\u63a5\uff0c\u4ee5\u767c\u9001\u548c\u63a5\u6536\u6578\u64da\u5305\u3002\nCloud Router \u8def\u7531\u5668\u5141\u8a31\u5340\u57df\u5167\u7684\u6240\u6709\u7bc0\u9ede\u5c07 Cloud NAT \u7528\u65bc\u6240\u6709\u4e3b\u8981 IP \u7bc4\u570d\u548c [\u5225\u540d IP \u7bc4\u570d](https://cloud.google.com/vpc/docs/alias-ip?hl=zh-cn) \u3002\u6b64\u5916\uff0c\u5b83\u9084\u6703\u7232 NAT \u7db2\u95dc\u81ea\u52d5\u5206\u914d\u5916\u90e8 IP \u5730\u5740\u3002\n\u6709\u95dc\u5275\u5efa\u548c\u914d\u7f6e Cloud Router \u8def\u7531\u5668\u7684\u8aaa\u660e\uff0c\u8acb\u53c3\u95b1 Cloud NAT \u6587\u6a94\u4e2d\u7684 [\u5275\u5efa\u4f7f\u7528 Cloud Router \u8def\u7531\u5668\u7684 Cloud NAT \u914d\u7f6e](https://cloud.google.com/nat/docs/gke-example?hl=zh-cn#create-nat) \u3002\n**\u6ce8\u610f** \uff1a\u5982\u9700\u7232\u60a8\u7684 Pod \u548c Service \u63d0\u4f9b\u51fa\u7ad9\u4e92\u806f\u7db2\u8a2a\u554f\u6b0a\u9650\uff0c\u8acb\u914d\u7f6e Cloud NAT \u4ee5 [\u7232 NAT \u6307\u5b9a\u5b50\u7db2\u7bc4\u570d](https://cloud.google.com/nat/docs/set-up-manage-network-address-translation?hl=zh-cn#specify_subnet_ranges_for_nat)\n### \u5728\u5171\u4eab VPC \u7db2\u7d61\u4e2d\u5275\u5efa\u5c08\u7528\u96c6\u7fa3\n\u5982\u9700\u77ad\u89e3\u5982\u4f55\u5728\u5171\u4eab VPC \u7db2\u7d61\u4e2d\u5275\u5efa\u5c08\u7528\u96c6\u7fa3\uff0c\u8acb\u53c3\u95b1 [\u5728\u5171\u4eab VPC \u4e2d\u5275\u5efa\u5c08\u7528\u96c6\u7fa3](https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-shared-vpc?hl=zh-cn#create_private_cluster) \u3002\n### \u5c07 Windows Server \u5bb9\u5668\u61c9\u7528\u90e8\u7f72\u5230\u5c08\u7528\u96c6\u7fa3\n\u5982\u9700\u77ad\u89e3\u5982\u4f55\u5c07 Windows Server \u5bb9\u5668\u61c9\u7528\u90e8\u7f72\u5230\u5c08\u7528\u96c6\u7fa3\uff0c\u8acb\u53c3\u95b1 [Windows \u7bc0\u9ede\u6c60\u6587\u6a94](https://cloud.google.com/kubernetes-engine/docs/how-to/deploying-windows-app?hl=zh-cn#deploying_a_windows_server_application_to_a_private_cluster) \u3002\n### \u5728\u5168\u7403\u7bc4\u570d\u5167\u8a2a\u554f\u63a7\u5236\u5c64\u9762\u7684\u5c08\u7528\u7aef\u9ede\n\u63a7\u5236\u5e73\u9762\u7684\u5c08\u7528\u7aef\u9ede\u7531\u63a7\u5236\u5e73\u9762\u7684 VPC \u7db2\u7d61\u4e2d\u7684\u5167\u90e8\u76f4\u901a\u5f0f\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u5be6\u73fe\u3002\u5167\u90e8\u5ba2\u6236\u7aef\u6216\u901a\u904e Cloud VPN \u96a7\u9053\u548c Cloud Interconnect VLAN \u9023\u63a5\u9032\u884c\u9023\u63a5\u7684\u5ba2\u6236\u7aef\u53ef\u4ee5\u8a2a\u554f\u5167\u90e8\u76f4\u901a\u5f0f\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u3002\n\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u9019\u4e9b\u5ba2\u6236\u7aef\u5fc5\u9808\u8207\u8ca0\u8f09\u5747\u8861\u5668 [\u4f4d\u65bc\u540c\u4e00\u5340\u57df](https://cloud.google.com/load-balancing/docs/internal?hl=zh-cn#client-access) \u3002\n\u5553\u7528\u63a7\u5236\u5e73\u9762\u5168\u7403\u8a2a\u554f\u6b0a\u9650\u6642\uff0c\u53ef\u5728\u5168\u7403\u7bc4\u570d\u5167\u8a2a\u554f\u5167\u90e8\u76f4\u901a\u5f0f\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\uff1a\u5ba2\u6236\u7aef\u865b\u64ec\u6a5f\u548c\u672c\u5730\u7cfb\u7d71\u53ef\u4ee5\u5f9e\u4efb\u610f\u5340\u57df\u9023\u63a5\u5230\u63a7\u5236\u5e73\u9762\u7684\u5c08\u7528\u7aef\u9ede\uff08\u53d7\u6388\u6b0a\u7db2\u7d61\u914d\u7f6e\u7684\u9650\u5236\uff09\u3002\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5167\u90e8\u76f4\u901a\u5f0f\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u548c\u5168\u7403\u8a2a\u554f\u6b0a\u9650\uff0c\u8acb\u53c3\u95b1 [\u5167\u90e8\u8ca0\u8f09\u5747\u8861\u5668\u548c\u9023\u63a5\u7684\u7db2\u7d61](https://cloud.google.com/load-balancing/docs/internal/internal-tcp-udp-lb-and-other-networks?hl=zh-cn) \u3002\n**\u6ce8\u610f** \uff1aGoogle Cloud \u7db2\u7d61\u4e2d\u5404\u5730\u5340\u4e4b\u9593\u7684\u6d41\u91cf\u9700\u8981\u652f\u4ed8\u51fa\u7ad9\u6d41\u91cf\u8cbb\u7528\uff0c\u56e0\u6b64\uff0c\u5f9e\u5176\u4ed6\u5730\u5340\u8a2a\u554f\u63a7\u5236\u5c64\u9762\u7684\u5c08\u7528\u7aef\u9ede\u6703\u7522\u751f [\u6a19\u6e96\u8de8\u5730\u5340\u51fa\u7ad9\u6d41\u91cf\u8cbb\u7528](https://cloud.google.com/vpc/network-pricing?hl=zh-cn#general) \u3002\n\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u5728\u5275\u5efa\u5c08\u7528\u96c6\u7fa3\u6642\uff0c\u7cfb\u7d71\u4e0d\u6703\u7232\u63a7\u5236\u5c64\u9762\u7684\u5c08\u7528\u7aef\u9ede\u5553\u7528\u5168\u7403\u8a2a\u554f\u6b0a\u9650\u3002\u5982\u9700\u5553\u7528\u63a7\u5236\u5c64\u9762\u5168\u7403\u8a2a\u554f\u6b0a\u9650\uff0c\u8acb\u6839\u64da\u60a8\u7684\u96c6\u7fa3\u6a21\u5f0f\u4f7f\u7528\u4ee5\u4e0b\u5de5\u5177\uff1a\n- \u5c0d\u65bc\u6a19\u6e96\u96c6\u7fa3\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528`Google Cloud CLI`\u6216 Google Cloud \u63a7\u5236\u6aaf\u3002\n- \u5c0d\u65bc Autopilot \u96c6\u7fa3\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528`google_container_cluster`Terraform \u8cc7\u6e90\u3002\n\u5982\u9700\u5275\u5efa\u5553\u7528\u4e86\u63a7\u5236\u5c64\u9762\u5168\u7403\u8a2a\u554f\u6b0a\u9650\u7684\u65b0\u5c08\u7528\u96c6\u7fa3\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u6b65\u9a5f\uff1a- \u8f49\u5230 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **Google Kubernetes Engine** \u9801\u9762\u3002 [\u8f49\u5230 Google Kubernetes Engine](https://console.cloud.google.com/kubernetes/list?hl=zh-cn) \n- \u9ede\u64ca add_box **\u5275\u5efa** \uff0c\u7136\u5f8c\u5728Standard \u6216 Autopilot \u90e8\u5206\u4e2d\u9ede\u64ca **\u914d\u7f6e** \u3002\n- \u8f38\u5165 **\u540d\u7a31** \u3002\n- \u5728\u5c0e\u822a\u7a97\u683c\u4e2d\uff0c\u9ede\u64ca **\u7db2\u7d61** \u3002\n- \u9078\u64c7 **\u5c08\u7528\u96c6\u7fa3** \u3002\n- \u9078\u4e2d **\u5553\u7528\u63a7\u5236\u5c64\u9762\u5168\u5c40\u8a2a\u554f\u6b0a\u9650** \u8907\u9078\u6846\u3002\n- \u6839\u64da\u9700\u8981\u914d\u7f6e\u5176\u4ed6\u5b57\u6bb5\u3002\n- \u9ede\u64ca **\u5275\u5efa** \u3002\n\u5982\u9700\u7232\u73fe\u6709\u5c08\u7528\u96c6\u7fa3\u5553\u7528\u63a7\u5236\u5c64\u9762\u5168\u7403\u8a2a\u554f\u6b0a\u9650\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u6b65\u9a5f\uff1a- \u8f49\u5230 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **Google Kubernetes Engine** \u9801\u9762\u3002 [\u8f49\u5230 Google Kubernetes Engine](https://console.cloud.google.com/kubernetes/list?hl=zh-cn) \n- \u5728\u8981\u4fee\u6539\u7684\u96c6\u7fa3\u65c1\u908a\uff0c\u9ede\u64ca **\u64cd\u4f5c** \uff0c\u7136\u5f8c\u9ede\u64ca **\u4fee\u6539** \u3002\n- \u5728 **\u7db2\u7d61** \u90e8\u5206\u7684 **\u63a7\u5236\u5e73\u9762\u5168\u7403\u8a2a\u554f\u6b0a\u9650** \u65c1\u908a\uff0c\u9ede\u64ca **\u4fee\u6539** \u3002\n- \u5728 **\u4fee\u6539\u63a7\u5236\u5e73\u9762\u5168\u7403\u8a2a\u554f\u6b0a\u9650** \u5c0d\u8a71\u6846\u4e2d\uff0c\u9078\u4e2d **\u5553\u7528\u63a7\u5236\u5e73\u9762\u5168\u7403\u8a2a\u554f\u6b0a\u9650** \u8907\u9078\u6846\u3002\n- \u9ede\u64ca **\u4fdd\u5b58\u66f4\u6539** \u3002\n\u6dfb\u52a0 `--enable-master-global-access` \u6a19\u8a8c\u4ee5\u5275\u5efa\u5553\u7528\u4e86\u63a7\u5236\u5c64\u9762\u5c08\u7528\u7aef\u9ede\u7684\u5168\u7403\u8a2a\u554f\u6b0a\u9650\u7684\u5c08\u7528\u96c6\u7fa3\uff1a\n```\ngcloud container clusters create CLUSTER_NAME \\\u00a0 \u00a0 --enable-private-nodes \\\u00a0 \u00a0 --enable-master-global-access\n```\n\u60a8\u9084\u53ef\u4ee5\u7232\u73fe\u6709\u5c08\u7528\u96c6\u7fa3\u5553\u7528\u63a7\u5236\u5c64\u9762\u5c08\u7528\u7aef\u9ede\u7684\u5168\u7403\u8a2a\u554f\u6b0a\u9650\uff1a\n```\ngcloud container clusters update CLUSTER_NAME \\\u00a0 \u00a0 --enable-master-global-access\n```\n **\u6ce8\u610f** \uff1a\u5982\u9700\u505c\u7528\u63a7\u5236\u5e73\u9762\u5c08\u7528\u7aef\u9ede\u5168\u7403\u8a2a\u554f\u6b0a\u9650\uff0c\u8acb\u4f7f\u7528 `--no-enable-master-global-access` \u6a19\u8a8c\u3002\n\u5982\u9700\u9a57\u8b49\u662f\u5426\u5553\u7528\u4e86\u63a7\u5236\u5c64\u9762\u5c08\u7528\u7aef\u9ede\u7684\u5168\u7403\u8a2a\u554f\u6b0a\u9650\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4e26\u67e5\u770b\u5176\u8f38\u51fa\u3002\n```\ngcloud container clusters describe CLUSTER_NAME\n```\n\u8f38\u51fa\u5305\u62ec `privateClusterConfig` \u90e8\u5206\uff0c\u60a8\u53ef\u4ee5\u5728\u5176\u4e2d\u67e5\u770b `masterGlobalAccessConfig` \u7684\u72c0\u614b\u3002\n```\nprivateClusterConfig:\n enablePrivateNodes: true\n masterIpv4CidrBlock: 172.16.1.0/28\n peeringName: gke-1921aee31283146cdde5-9bae-9cf1-peer\n privateEndpoint: 172.16.1.2\n publicEndpoint: 34.68.128.12\n masterGlobalAccessConfig:\n enabled: true\n```\n### \u5f9e\u5176\u4ed6\u7db2\u7d61\u8a2a\u554f\u63a7\u5236\u5e73\u9762\u7684\u5c08\u7528\u7aef\u9ede\n\u5275\u5efa [GKE \u5c08\u7528\u96c6\u7fa3](https://cloud.google.com/kubernetes-engine/docs/how-to/private-clusters?hl=zh-cn) \u4e26\u505c\u7528\u63a7\u5236\u5e73\u9762\u7684\u516c\u5171\u7aef\u9ede\u5f8c\uff0c\u60a8\u5fc5\u9808\u4f7f\u7528 `kubectl` \u7b49\u5de5\u5177\u901a\u904e\u63a7\u5236\u5e73\u9762\u7684\u5c08\u7528\u7aef\u9ede\u4f86\u7ba1\u7406\u8a72\u96c6\u7fa3\u3002\u60a8\u53ef\u4ee5\u5f9e\u5176\u4ed6\u7db2\u7d61\u8a2a\u554f\u96c6\u7fa3\u63a7\u5236\u5e73\u9762\u7684\u5c08\u7528\u7aef\u9ede\uff0c\u5305\u62ec\uff1a\n- \u4f7f\u7528 Cloud VPN \u96a7\u9053\u6216 Cloud Interconnect VLAN \u9023\u63a5\u4f86\u9023\u63a5\u5230\u96c6\u7fa3\u7684 VPC \u7db2\u7d61\u7684\u672c\u5730\u7db2\u7d61\n- \u4f7f\u7528 Cloud VPN \u96a7\u9053\u9023\u63a5\u5230\u96c6\u7fa3\u7684 VPC \u7db2\u7d61\u7684\u53e6\u4e00\u500b VPC \u7db2\u7d61\n\u4e0b\u5716\u5c55\u793a\u4e86\u672c\u5730\u7db2\u7d61\u548c GKE \u63a7\u5236\u5c64\u9762\u7bc0\u9ede\u4e4b\u9593\u7684\u8def\u7531\u8def\u5f91\uff1a\n\u5982\u9700\u5141\u8a31\u5176\u4ed6\u7db2\u7d61\u4e2d\u7684\u7cfb\u7d71\u9023\u63a5\u5230\u96c6\u7fa3\u7684\u63a7\u5236\u5e73\u9762\u5c08\u7528\u7aef\u9ede\uff0c\u8acb\u5b8c\u6210\u4ee5\u4e0b\u8981\u6c42\uff1a\n- \u8b58\u5225\u4e26\u8a18\u9304\u96c6\u7fa3\u53ca\u5176\u63a7\u5236\u5e73\u9762\u5c08\u7528\u7aef\u9ede\u7684\u76f8\u95dc\u7db2\u7d61\u4fe1\u606f\u3002```\ngcloud container clusters describe CLUSTER_NAME \\\u00a0 \u00a0--location=COMPUTE_LOCATION \\\u00a0 \u00a0--format=\"yaml(network, privateClusterConfig)\"\n```\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u96c6\u7fa3\u7684\u540d\u7a31\u3002\n- ``\uff1a\u96c6\u7fa3\u7684 [Compute Engine \u4f4d\u7f6e](https://cloud.google.com/compute/docs/regions-zones/viewing-regions-zones?hl=zh-cn) \n\u5728\u8a72\u547d\u4ee4\u7684\u8f38\u51fa\u4e2d\uff0c\u627e\u5230\u4e26\u8a18\u9304\u4ee5\u4e0b\u4fe1\u606f\u4ee5\u5728\u5f8c\u7e8c\u6b65\u9a5f\u4e2d\u4f7f\u7528\uff1a- `network`\uff1a\u96c6\u7fa3\u7684 VPC \u7db2\u7d61\u7684\u540d\u7a31\u6216 URI\u3002\n- `privateEndpoint`\uff1a\u63a7\u5236\u5e73\u9762\u5c08\u7528\u7aef\u9ede\u7684 IPv4 \u5730\u5740\u6216\u6240\u5c6c\u7684 IPv4 CIDR \u7bc4\u570d (`masterIpv4CidrBlock`)\u3002\n- `peeringName`\uff1a\u7528\u65bc\u5c07\u96c6\u7fa3\u7684 VPC \u7db2\u7d61\u9023\u63a5\u5230\u63a7\u5236\u5e73\u9762\u7684 VPC \u7db2\u7d61\u7684 VPC \u7db2\u7d61\u5c0d\u7b49\u4e92\u9023\u9023\u63a5\u7684\u540d\u7a31\u3002\n\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nnetwork: cluster-networkprivateClusterConfig:\u00a0 enablePrivateNodes: true\u00a0 masterGlobalAccessConfig:\u00a0 \u00a0 enabled: true\u00a0 masterIpv4CidrBlock: 172.16.1.0/28\u00a0 peeringName: gke-1921aee31283146cdde5-9bae-9cf1-peer\u00a0 privateEndpoint: 172.16.1.2\u00a0 publicEndpoint: 34.68.128.12\n```\n- \u8003\u616e [\u5553\u7528\u63a7\u5236\u5e73\u9762\u5c08\u7528\u7aef\u9ede\u5168\u7403\u8a2a\u554f\u6b0a\u9650](#cp-global-access-enable) \uff0c\u4ee5\u5141\u8a31\u6578\u64da\u5305\u5f9e\u96c6\u7fa3\u7684 VPC \u7db2\u7d61\u4e2d\u7684\u4efb\u4f55\u5340\u57df\u9032\u5165\u3002\u5553\u7528\u63a7\u5236\u5e73\u9762\u5c08\u7528\u7aef\u9ede\u5168\u7403\u8a2a\u554f\u6b0a\u9650\u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4f4d\u65bc\u4efb\u4f55\u5340\u57df\uff08\u800c\u4e0d\u50c5\u50c5\u662f\u96c6\u7fa3\u6240\u5728\u5340\u57df\uff09\u7684 Cloud VPN \u96a7\u9053\u6216 Cloud Interconnect VLAN \u9023\u63a5\u4f86\u9023\u63a5\u5230\u5c08\u7528\u7aef\u9ede\u3002\n- \u7232\u53e6\u4e00\u500b\u7db2\u7d61\u4e2d\u7684 `privateEndpoint` IP \u5730\u5740\u6216 `masterIpv4CidrBlock` IP \u5730\u5740\u7bc4\u570d\u5275\u5efa\u8def\u7531\u3002\u7531\u65bc\u63a7\u5236\u5e73\u9762\u7684\u5c08\u7528\u7aef\u9ede IP \u5730\u5740\u59cb\u7d42\u5728 `masterIpv4CidrBlock` IPv4 \u5730\u5740\u7bc4\u570d\u5167\uff0c\u7232 `privateEndpoint` IP \u5730\u5740\u6216\u5176\u6240\u5c6c\u7bc4\u570d\u5275\u5efa\u8def\u7531\u53ef\u7232\u6578\u64da\u5305\u63d0\u4f9b\u5f9e\u5176\u4ed6\u7db2\u7d61\u5230\u63a7\u5236\u5e73\u9762\u5c08\u7528\u7aef\u9ede\u7684\u8def\u5f91\uff1a- **\u53e6\u4e00\u500b\u7db2\u7d61\u4f7f\u7528 Cloud Interconnect VLAN \u9023\u63a5\u6216\u4f7f\u7528\u52d5\u614b (BGP) \u8def\u7531\u7684 Cloud VPN \u96a7\u9053\u9023\u63a5\u5230\u96c6\u7fa3\u7684 VPC \u7db2\u7d61** \uff1a\u4f7f\u7528 Cloud Router \u8def\u7531\u5668\u81ea\u5b9a\u7fa9\u8def\u7531\u901a\u544a\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 Cloud Router \u6587\u6a94\u4e2d\u7684 [\u901a\u544a\u81ea\u5b9a\u7fa9 IP \u7bc4\u570d](https://cloud.google.com/network-connectivity/docs/router/docs/how-to/advertising-custom-ip?hl=zh-cn) \u3002\n- **\u53e6\u4e00\u500b\u7db2\u7d61\u4f7f\u7528\u4e0d\u4f7f\u7528\u52d5\u614b\u8def\u7531\u7684\u50b3\u7d71 VPN \u96a7\u9053\u9023\u63a5\u5230\u96c6\u7fa3\u7684 VPC \u7db2\u7d61** \uff1a\u60a8\u5fc5\u9808\u5728\u53e6\u4e00\u500b\u7db2\u7d61\u4e2d\u914d\u7f6e\u975c\u614b\u8def\u7531\u3002 \n **\u91cd\u8981\u63d0\u793a** \uff1a\u5982\u679c\u505c\u7528 [\u63a7\u5236\u5e73\u9762\u5168\u7403\u8a2a\u554f\u6b0a\u9650](#cp-global-access) \uff0c\u5c07\u96c6\u7fa3\u7684 VPC \u7db2\u7d61\u9023\u63a5\u5230\u53e6\u4e00\u500b\u7db2\u7d61\u7684 Cloud VPN \u96a7\u9053\u6216 Cloud Interconnect VLAN \u9023\u63a5\u5fc5\u9808\u4f4d\u65bc\u96c6\u7fa3\u6240\u5728\u7684\u5340\u57df\u3002\n- \u914d\u7f6e\u96c6\u7fa3\u7684 VPC \u7db2\u7d61\uff0c\u4ee5\u5c07\u5176\u5728\u5c0d\u7b49\u4e92\u9023\u95dc\u4fc2\u4e2d\u7684\u81ea\u5b9a\u7fa9\u8def\u7531\u5c0e\u51fa\u5230\u63a7\u5236\u5e73\u9762\u7684 VPC \u7db2\u7d61\u3002Google Cloud \u59cb\u7d42\u6703\u5c07\u63a7\u5236\u5e73\u9762\u7684 VPC \u7db2\u7d61\u914d\u7f6e\u7232\u5f9e\u96c6\u7fa3\u7684 VPC \u7db2\u7d61\u5c0e\u5165\u81ea\u5b9a\u7fa9\u8def\u7531\u3002 \u6b64\u6b65\u9a5f\u7232\u6578\u64da\u5305\u63d0\u4f9b\u4e86\u5f9e\u63a7\u5236\u5e73\u9762\u7684\u5c08\u7528\u7aef\u9ede\u8fd4\u56de\u53e6\u4e00\u500b\u7db2\u7d61\u7684\u8def\u5f91\u3002\u5982\u9700\u5553\u7528\u5f9e\u96c6\u7fa3\u7684 VPC \u7db2\u7d61\u5c0e\u51fa\u7684\u81ea\u5b9a\u7fa9\u8def\u7531\uff0c\u8acb\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud compute networks peerings update PEERING_NAME \\\u00a0 \u00a0 --network=CLUSTER_VPC_NETWORK \\\u00a0 \u00a0 --export-custom-routes\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u5c07\u96c6\u7fa3\u7684 VPC \u7db2\u7d61\u9023\u63a5\u5230\u63a7\u5236\u5e73\u9762 VPC \u7db2\u7d61\u7684\u5c0d\u7b49\u4e92\u9023\u7684\u540d\u7a31\n- ``\uff1a\u96c6\u7fa3\u7684 VPC \u7db2\u7d61\u7684\u540d\u7a31\u6216 URI\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u66f4\u65b0\u73fe\u6709 VPC \u7db2\u7d61\u5c0d\u7b49\u4e92\u9023\u9023\u63a5\u7684\u8def\u7531\u4ea4\u63db\uff0c\u8acb\u53c3\u95b1 [\u66f4\u65b0\u5c0d\u7b49\u4e92\u9023\u9023\u63a5](https://cloud.google.com/vpc/docs/using-vpc-peering?hl=zh-cn#update-peer-connection) \u3002\u96c6\u7fa3\u7684 VPC \u7db2\u7d61\u4e2d\u7684\u81ea\u5b9a\u7fa9\u8def\u7531\u5305\u62ec\u76ee\u7684\u5730\u7232\u5176\u4ed6\u7db2\u7d61\uff08\u4f8b\u5982\u672c\u5730\u7db2\u7d61\uff09\u4e2d\u7684 IP \u5730\u5740\u7bc4\u570d\u7684\u8def\u7531\u3002\u5982\u9700\u78ba\u4fdd\u9019\u4e9b\u8def\u7531\u6210\u7232\u63a7\u5236\u5e73\u9762\u7684 VPC \u7db2\u7d61\u4e2d\u7684\u6709\u6548\u5c0d\u7b49\u4e92\u9023\u81ea\u5b9a\u7fa9\u8def\u7531\uff0c\u8acb\u53c3\u95b1 [\u4f86\u81ea\u5176\u4ed6\u7db2\u7d61\u7684\u53d7\u652f\u6301\u76ee\u7684\u5730](#to_on_prem) \u3002 \u53e6\u4e00\u500b\u7db2\u7d61\u5411\u96c6\u7fa3 VPC \u7db2\u7d61\u4e2d\u7684 Cloud Router \u8def\u7531\u5668\u767c\u9001\u7684\u5730\u5740\u7bc4\u570d\u5fc5\u9808\u9075\u5faa\u4ee5\u4e0b\u689d\u4ef6\uff1a\n- \u96d6\u7136\u96c6\u7fa3\u7684 VPC \u53ef\u4ee5\u63a5\u53d7\u9ed8\u8a8d\u8def\u7531 ( `0.0.0.0/0` )\uff0c\u4f46\u63a7\u5236\u5e73\u9762\u7684 VPC \u7db2\u7d61\u59cb\u7d42\u62d2\u7d55\u9ed8\u8a8d\u8def\u7531\uff0c\u56e0\u7232\u5b83\u5df2\u7d93\u6709\u672c\u5730\u9ed8\u8a8d\u8def\u7531\u3002 \u5982\u679c\u53e6\u4e00\u500b\u7db2\u7d61\u5411\u60a8\u7684 VPC \u7db2\u7d61\u767c\u9001\u9ed8\u8a8d\u8def\u7531\uff0c\u5247\u53e6\u4e00\u500b\u7db2\u7d61\u9084\u5fc5\u9808\u767c\u9001\u9700\u8981\u9023\u63a5\u5230\u63a7\u5236\u5e73\u9762\u5c08\u7528\u7aef\u9ede\u7684\u7cfb\u7d71\u7684\u7279\u5b9a\u76ee\u7684\u5730\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u8def\u7531\u9806\u5e8f](https://cloud.google.com/vpc/docs/routes?hl=zh-cn#routeselection) \u3002\n- \u5982\u679c\u63a7\u5236\u5e73\u9762\u7684 VPC \u7db2\u7d61\u63a5\u53d7\u6709\u6548\u66ff\u63db\u9ed8\u8a8d\u8def\u7531\u7684\u8def\u7531\uff0c\u5247\u9019\u4e9b\u8def\u7531\u6703\u4e2d\u65b7\u8207 Google Cloud API \u548c\u670d\u52d9\u7684\u9023\u63a5\uff0c\u5f9e\u800c\u4e2d\u65b7\u96c6\u7fa3\u63a7\u5236\u5e73\u9762\u3002\u4f5c\u7232\u4ee3\u8868\u6027\u793a\u4f8b\uff0c\u53e6\u4e00\u500b\u7db2\u7d61\u4e0d\u5f97\u901a\u544a\u76ee\u7684\u5730\u7232 `0.0.0.0/1` \u548c `128.0.0.0/1` \u7684\u8def\u7531\u3002\u5982\u9700\u77ad\u89e3\u66ff\u4ee3\u65b9\u6cd5\uff0c\u8acb\u53c3\u95b1\u4e0a\u4e00\u9ede\u3002\n\u8acb\u76e3\u63a7 [Cloud Router \u8def\u7531\u5668\u9650\u5236](https://cloud.google.com/router/quotas?hl=zh-cn#limits) \uff0c\u7279\u5225\u662f\u5df2\u77e5\u8def\u7531\u7684\u552f\u4e00\u76ee\u7684\u5730\u6578\u91cf\u4e0a\u9650\u3002\n## \u9a57\u8b49\u7bc0\u9ede\u6c92\u6709\u5916\u90e8 IP \u5730\u5740\n\u5275\u5efa\u5c08\u7528\u96c6\u7fa3\u540e\uff0c\u8acb\u9a57\u8b49\u96c6\u7fa3\u7684\u7bc0\u9ede\u662f\u5426\u6c92\u6709\u5916\u90e8 IP \u5730\u5740\u3002\n- \u8f49\u5230 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **Google Kubernetes Engine** \u9801\u9762\u3002 [\u8f49\u5230 Google Kubernetes Engine](https://console.cloud.google.com/kubernetes/list?hl=zh-cn) \n- \u5728\u96c6\u7fa3\u5217\u8868\u4e2d\uff0c\u9ede\u64ca\u96c6\u7fa3\u540d\u7a31\u3002\n- \u5c0d\u65bc Autopilot \u96c6\u7fa3\uff0c\u5728 **\u96c6\u7fa3\u57fa\u672c\u4fe1\u606f** \u90e8\u5206\u4e2d\uff0c\u67e5\u770b **\u5916\u90e8\u7aef\u9ede** \u5b57\u6bb5\u3002\u5176\u503c\u7232 **\u5df2\u505c\u7528** \u3002\n\u5c0d\u65bc Standard \u96c6\u7fa3\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u5728 **\u96c6\u7fa3** \u9801\u9762\u4e0a\uff0c\u9ede\u64ca **\u7bc0\u9ede** \u6a19\u7c64\u9801\u3002\n- \u5728 **\u7bc0\u9ede\u6c60** \u4e0b\uff0c\u9ede\u64ca\u7bc0\u9ede\u6c60\u540d\u7a31\u3002\n- \u5728 **\u7bc0\u9ede\u6c60\u8a73\u60c5** \u9801\u9762\u7684 **\u5be6\u4f8b\u7d44** \u4e0b\uff0c\u9ede\u64ca\u5be6\u4f8b\u7d44\u7684\u540d\u7a31\u3002\u4f8b\u5982 gke-private-cluster-0-default-pool-5c5add1f-grp`\u3002\n- \u5728\u5be6\u4f8b\u5217\u8868\u4e2d\uff0c\u78ba\u8a8d\u5be6\u4f8b\u6c92\u6709\u5916\u90e8 IP \u5730\u5740\u3002\n\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\nkubectl get nodes --output wide\n```\n\u8f38\u51fa\u7684 `EXTERNAL-IP` \u5217\u7232\u7a7a\uff1a\n```\nSTATUS ... VERSION  EXTERNAL-IP OS-IMAGE ...\nReady  v.8.7-gke.1     Container-Optimized OS\nReady  v1.8.7-gke.1    Container-Optimized OS\nReady  v1.8.7-gke.1    Container-Optimized OS\n```\n## \u67e5\u770b\u96c6\u7fa3\u7684\u5b50\u7db2\u548c\u6b21\u8981\u5730\u5740\u7bc4\u570d\n\u5275\u5efa\u5c08\u7528\u96c6\u7fa3\u540e\uff0c\u60a8\u53ef\u4ee5\u67e5\u770b\u60a8\u6216 GKE \u7232\u96c6\u7fa3\u9810\u914d\u7684\u5b50\u7db2\u548c\u6b21\u8981\u5730\u5740\u7bc4\u570d\u3002\n- \u8f49\u5230 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **VPC \u7db2\u7d61** \u9801\u9762\u3002 [\u9032\u5165\u201cVPC \u7db2\u7d61\u201d](https://console.cloud.google.com/networking/networks/list?hl=zh-cn) \n- \u9ede\u64ca\u5b50\u7db2\u7684\u540d\u7a31\u3002\u4f8b\u5982 `gke-private-cluster-0-subnet-163e3c97` \u3002\n- \u5728 **IP \u5730\u5740\u7bc4\u570d** \u4e0b\uff0c\u60a8\u53ef\u4ee5\u770b\u5230\u5b50\u7db2\u7684\u4e3b\u8981\u5730\u5740\u7bc4\u570d\u3002\u9019\u662f\u7528\u65bc\u7bc0\u9ede\u7684\u7bc4\u570d\u3002\n- \u5728 **\u6b21\u8981 IP \u7bc4\u570d** \u4e0b\uff0c\u60a8\u53ef\u4ee5\u770b\u5230 Pod \u548c Service \u7684 IP \u5730\u5740\u7bc4\u570d\u3002\n\u5982\u9700\u5217\u51fa\u96c6\u7fa3\u7db2\u7d61\u4e2d\u7684\u5b50\u7db2\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ngcloud compute networks subnets list \\\u00a0 \u00a0 --network NETWORK_NAME\n```\n\u5c07 `` \u66ff\u63db\u7232\u5c08\u7528\u96c6\u7fa3\u7684\u7db2\u7d61\u3002\u5982\u679c\u60a8\u4f7f\u7528\u4e86\u81ea\u52d5\u5275\u5efa\u7684\u5b50\u7db2\u5275\u5efa\u96c6\u7fa3\uff0c\u8acb\u4f7f\u7528 `default` \u3002\n\u5728\u547d\u4ee4\u8f38\u51fa\u4e2d\uff0c\u627e\u5230\u96c6\u7fa3\u5b50\u7db2\u7684\u540d\u7a31\u3002\u7372\u53d6\u81ea\u52d5\u5275\u5efa\u7684\u5b50\u7db2\u7684\u76f8\u95dc\u4fe1\u606f\uff1a\n```\ngcloud compute networks subnets describe SUBNET_NAME\n```\n\u5c07 `` \u66ff\u63db\u7232\u5b50\u7db2\u7684\u540d\u7a31\u3002\n\u8f38\u51fa\u7d50\u679c\u986f\u793a\u7bc0\u9ede\u7684\u4e3b\u8981\u5730\u5740\u7bc4\u570d\uff08\u7b2c\u4e00\u500b `ipCidrRange` \u5b57\u6bb5\uff09\u4ee5\u53ca Pod \u548c Service \u7684\u6b21\u8981\u7bc4\u570d\uff08\u5728 `secondaryIpRanges` \u4e0b\uff09\uff1a\n```\n...\nipCidrRange: 10.0.0.0/22\nkind: compute#subnetwork\nname: gke-private-cluster-1-subnet-163e3c97\n...\nprivateIpGoogleAccess: true\n...\nsecondaryIpRanges:\n- ipCidrRange: 10.40.0.0/14\n rangeName: gke-private-cluster-1-pods-163e3c97\n- ipCidrRange: 10.0.16.0/20\n rangeName: gke-private-cluster-1-services-163e3c97\n...\n```\n## \u67e5\u770b\u5c08\u7528\u96c6\u7fa3\u7684\u7aef\u9ede\n\u60a8\u53ef\u4ee5\u4f7f\u7528 gcloud CLI \u6216 Google Cloud \u63a7\u5236\u6aaf\u67e5\u770b\u5c08\u7528\u96c6\u7fa3\u7684\u7aef\u9ede\u3002\n- \u8f49\u5230 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **Google Kubernetes Engine** \u9801\u9762\u3002 [\u8f49\u5230 Google Kubernetes Engine](https://console.cloud.google.com/kubernetes/list?hl=zh-cn) \n- \u5728\u96c6\u7fa3\u5217\u8868\u4e2d\uff0c\u9ede\u64ca\u96c6\u7fa3\u540d\u7a31\u3002\n- \u5728 **\u96c6\u7fa3\u57fa\u672c\u4fe1\u606f** \u4e0b\u7684 **\u8a73\u60c5** \u6a19\u7c64\u9801\u4e2d\uff0c\u627e\u5230 **\u7aef\u9ede** \u5b57\u6bb5\u3002\n\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ngcloud container clusters describe CLUSTER_NAME\n```\n\u8f38\u51fa\u5167\u5bb9\u6703\u986f\u793a\u5c08\u7528\u548c\u516c\u5171\u7aef\u9ede\uff1a\n```\n...\nprivateClusterConfig:\nenablePrivateEndpoint: true\nenablePrivateNodes: true\nmasterIpv4CidrBlock: 172.16.0.32/28\nprivateEndpoint: 172.16.0.34\npublicEndpoint: 35.239.154.67\n```\n## \u5f9e\u6620\u50cf\u8a3b\u518a\u8868\u4e2d\u62c9\u53d6\u5bb9\u5668\u6620\u50cf\n\u5728\u5c08\u7528\u96c6\u7fa3\u4e2d\uff0c\u5bb9\u5668\u904b\u884c\u6642\u53ef\u4ee5\u5f9e [Artifact Registry](https://cloud.google.com/artifact-registry/docs?hl=zh-cn) \u4e2d\u62c9\u53d6\u5bb9\u5668\u6620\u50cf\uff0c\u4e0d\u80fd\u5f9e\u4e92\u806f\u7db2\u4e0a\u7684\u4efb\u4f55\u5176\u4ed6\u5bb9\u5668\u6620\u50cf\u8a3b\u518a\u8868\u4e2d\u62c9\u53d6\u6620\u50cf\u3002\u9019\u662f\u56e0\u7232\u5c08\u7528\u96c6\u7fa3\u4e2d\u7684\u7bc0\u9ede\u6c92\u6709\u5916\u90e8 IP \u5730\u5740\uff0c\u56e0\u6b64\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\u7bc0\u9ede\u7121\u6cd5\u8207 Google Cloud \u7db2\u7d61\u5916\u90e8\u7684\u670d\u52d9\u901a\u4fe1\u3002\n\u5c08\u7528\u96c6\u7fa3\u4e2d\u7684\u7bc0\u9ede\u5982\u679c\u4f4d\u65bc\u5df2\u5553\u7528 [\u5c08\u7528 Google \u8a2a\u554f\u901a\u9053](https://cloud.google.com/vpc/docs/private-google-access?hl=zh-cn) \u7684\u5b50\u7db2\u4e2d\uff0c\u5247\u53ef\u4ee5\u8207 Google Cloud \u670d\u52d9\uff08\u4f8b\u5982 Artifact Registry\uff09\u901a\u4fe1\u3002\n\u4ee5\u4e0b\u547d\u4ee4\u6703\u5275\u5efa\u4e00\u500b Deployment\uff0c\u4ee5\u5f9e Artifact Registry \u4ee3\u78bc\u5eab\u4e2d\u62c9\u53d6\u793a\u4f8b\u6620\u50cf\uff1a\n```\nkubectl run hello-deployment --image=us-docker.pkg.dev/google-samples/containers/gke/hello-app:1.0\n```\n**\u6ce8\u610f** \uff1a\u96d6\u7136\u53ef\u5f9e\u5c08\u7528\u96c6\u7fa3\u8a2a\u554f [Docker Hub \u93e1\u50cf](https://cloud.google.com/container-registry/docs/using-dockerhub-mirroring?hl=zh-cn) `mirror.gcr.io` \uff0c\u5247\u4e0d\u61c9\u50c5\u4f9d\u8cf4\u65bc\u5b83\u3002\u93e1\u50cf\u53ea\u662f\u7de9\u5b58\uff0c\u56e0\u6b64\u6703\u5b9a\u671f\u79fb\u9664\u6620\u50cf\uff0c\u5c08\u7528\u96c6\u7fa3\u7121\u6cd5\u56de\u9000\u5230 Docker Hub\u3002\n## \u91dd\u5c0d\u7279\u5b9a\u7528\u4f8b\u6dfb\u52a0\u9632\u706b\u7246\u898f\u5247\n\u672c\u90e8\u5206\u4ecb\u7d39\u5982\u4f55\u5411\u5c08\u7528\u96c6\u7fa3\u6dfb\u52a0\u9632\u706b\u7246\u898f\u5247\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u9632\u706b\u7246\u898f\u5247\u5c07\u96c6\u7fa3\u63a7\u5236\u5c64\u9762\u9650\u5236\u7232\u53ea\u80fd\u5553\u52d5\u8207\u7aef\u53e3 `443` (HTTPS) \u548c `10250` (kubelet) \u4e0a\u7684\u7bc0\u9ede\u548c Pod \u7684 TCP \u9023\u63a5\u3002\u5c0d\u65bc\u67d0\u4e9b Kubernetes \u529f\u80fd\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u6dfb\u52a0\u9632\u706b\u7246\u898f\u5247\u4ee5\u5141\u8a31\u5728\u5176\u4ed6\u7aef\u53e3\u4e0a\u9032\u884c\u8a2a\u554f\u3002\n**\u6ce8\u610f** \uff1a\u5141\u8a31\u7684\u7aef\u53e3\uff08 `443` \u548c `10250` \uff09\u662f\u6307\u7bc0\u9ede\u548c Pod \u516c\u958b\u7684\u7aef\u53e3\uff0c\u800c\u4e0d\u662f \u4efb\u4f55 Kubernetes \u670d\u52d9\u516c\u958b\u7684\u7aef\u53e3\u3002\u4f8b\u5982\uff0c\u5982\u679c\u96c6\u7fa3\u63a7\u5236\u5c64\u9762\u5617\u8a66\u4f7f\u7528\u7aef\u53e3 `443` \u8a2a\u554f\u670d\u52d9\uff0c\u4f46\u8a72\u670d\u52d9\u4f7f\u7528\u7aef\u53e3 `9443` \u901a\u904e pod \u5be6\u73fe \uff0c\u9664\u975e\u60a8\u6dfb\u52a0\u9632\u706b\u7246\u898f\u5247\u4f86\u660e\u78ba\u5141\u8a31\u5165\u7ad9\u8a2a\u554f\u7aef\u53e3 `9443` \uff0c\u5426\u5247\u9632\u706b\u7246\u5c07\u963b\u6b62\u9019\u4e9b\u9023\u63a5\u3002\n\u9700\u8981\u984d\u5916\u9632\u706b\u7246\u898f\u5247\u7684 Kubernetes \u529f\u80fd\u5305\u62ec\uff1a\n- [\u51c6\u5165\u7db2\u7d61\u9264\u5b50](https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/) \n- [\u805a\u5408 API \u670d\u52d9\u5668](https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/) \n- [\u7db2\u7d61\u9264\u5b50\u8f49\u63db](https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/#webhook-conversion) \n- [\u52d5\u614b\u5be9\u8988\u914d\u7f6e](https://kubernetes.io/docs/tasks/debug/debug-cluster/audit/#service-reference) \n- \u901a\u5e38\u60c5\u6cc1\u4e0b\uff0c\u5177\u6709 ServiceReference \u5b57\u6bb5\u7684\u4efb\u4f55 API \u90fd\u9700\u8981\u984d\u5916\u7684\u9632\u706b\u7246\u898f\u5247\u3002\n\u6dfb\u52a0\u9632\u706b\u7246\u898f\u5247\uff0c\u5141\u8a31\u6d41\u91cf\u5f9e\u96c6\u7fa3\u63a7\u5236\u5c64\u9762\u50b3\u8f38\u5230\u4ee5\u4e0b\u6240\u6709\u7aef\u53e3\uff1a\n- \u6bcf\u500b\u7bc0\u9ede\u7684\u6307\u5b9a\u7aef\u53e3 (hostPort)\u3002\n- \u5728\u9019\u4e9b\u7bc0\u9ede\u4e0a\u904b\u884c\u7684\u6bcf\u500b Pod \u7684\u6307\u5b9a\u7aef\u53e3\u3002\n- \u5728\u9019\u4e9b\u7bc0\u9ede\u4e0a\u904b\u884c\u7684\u6bcf\u500b Service \u7684\u6307\u5b9a\u7aef\u53e3\u3002\n\u5982\u9700\u77ad\u89e3\u9632\u706b\u7246\u898f\u5247\uff0c\u8acb\u53c3\u95b1 Cloud Load Balancing \u6587\u6a94\u4e2d\u7684 [\u9632\u706b\u7246\u898f\u5247](https://cloud.google.com/load-balancing/docs/https?hl=zh-cn#firewall_rules) \u3002\n\u5982\u9700\u5728\u5c08\u7528\u96c6\u7fa3\u4e2d\u6dfb\u52a0\u9632\u706b\u7246\u898f\u5247\uff0c\u60a8\u9700\u8981\u8a18\u9304\u96c6\u7fa3\u63a7\u5236\u5c64\u9762\u7684 CIDR \u584a\u548c\u4f7f\u7528\u7684\u76ee\u6a19\u3002\u8a18\u9304\u5b8c\u6210\u5f8c\uff0c\u5c31\u53ef\u4ee5\u5275\u5efa\u898f\u5247\u4e86\u3002\n### \u7b2c 1 \u6b65\uff1a\u67e5\u770b\u63a7\u5236\u5c64\u9762\u7684 CIDR \u584a\n\u7232\u4e86\u6dfb\u52a0\u9632\u706b\u7246\u898f\u5247\uff0c\u60a8\u9700\u8981\u4f7f\u7528\u96c6\u7fa3\u63a7\u5236\u5c64\u9762\u7684 CIDR \u584a\u3002\n- \u8f49\u5230 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **Google Kubernetes Engine** \u9801\u9762\u3002 [\u8f49\u5230 Google Kubernetes Engine](https://console.cloud.google.com/kubernetes/list?hl=zh-cn) \n- \u5728\u96c6\u7fa3\u5217\u8868\u4e2d\uff0c\u9ede\u64ca\u96c6\u7fa3\u540d\u7a31\u3002\n\u5728 **\u7db2\u7d61** \u4e0b\u7684 **\u8a73\u7d30\u4fe1\u606f** \u6a19\u7c64\u9801\u4e2d\uff0c\u8a18\u4e0b **\u63a7\u5236\u5e73\u9762\u5730\u5740\u7bc4\u570d** \u5b57\u6bb5\u4e2d\u7684\u503c\u3002\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ngcloud container clusters describe CLUSTER_NAME\n```\n\u5c07 `` \u66ff\u63db\u7232\u60a8\u7684\u5c08\u7528\u96c6\u7fa3\u540d\u7a31\u3002\n\u5728\u547d\u4ee4\u8f38\u51fa\u4e2d\uff0c\u8a18\u4e0b **masterIpv4CidrBlock** \u5b57\u6bb5\u4e2d\u7684\u503c\u3002### \u7b2c 2 \u6b65\uff1a\u67e5\u770b\u73fe\u6709\u9632\u706b\u7246\u898f\u5247\n\u60a8\u9700\u8981\u6307\u5b9a\u96c6\u7fa3\u7684\u73fe\u6709\u9632\u706b\u7246\u898f\u5247\u91dd\u5c0d\u7684 [\u76ee\u6a19](https://cloud.google.com/vpc/docs/firewalls?hl=zh-cn#rule_assignment) \uff08\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u5c31\u662f\u76ee\u6a19\u7bc0\u9ede\uff09\u3002\n- \u9032\u5165 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **\u9632\u706b\u7246\u653f\u7b56** \u9801\u9762\u3002 [\u524d\u5f80\u201c\u9632\u706b\u7246\u653f\u7b56\u201d](https://console.cloud.google.com/net-security/firewall-manager/firewall-policies/list?hl=zh-cn) \n- \u5728 **VPC \u9632\u706b\u7246\u898f\u5247** \u7684 **\u904e\u6ffe\u8868** \u90e8\u5206\uff0c\u8f38\u5165 `gke-` `` \u3002\n\u5728\u7d50\u679c\u4e2d\uff0c\u8a18\u4e0b **\u76ee\u6a19** \u5b57\u6bb5\u4e2d\u7684\u503c\u3002\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ngcloud compute firewall-rules list \\\u00a0 \u00a0 --filter 'name~^gke-CLUSTER_NAME' \\\u00a0 \u00a0 --format 'table(\u00a0 \u00a0 \u00a0 \u00a0 name,\u00a0 \u00a0 \u00a0 \u00a0 network,\u00a0 \u00a0 \u00a0 \u00a0 direction,\u00a0 \u00a0 \u00a0 \u00a0 sourceRanges.list():label=SRC_RANGES,\u00a0 \u00a0 \u00a0 \u00a0 allowed[].map().firewall_rule().list():label=ALLOW,\u00a0 \u00a0 \u00a0 \u00a0 targetTags.list():label=TARGET_TAGS\u00a0 \u00a0 )'\n```\n\u5728\u547d\u4ee4\u8f38\u51fa\u4e2d\uff0c\u8a18\u4e0b **\u76ee\u6a19** \u5b57\u6bb5\u4e2d\u7684\u503c\u3002\n **\u6ce8\u610f** \uff1a\u5982\u9700\u67e5\u770b\u5171\u4eab VPC \u7684\u9632\u706b\u7246\u898f\u5247\uff0c\u8acb\u5728\u547d\u4ee4\u4e2d\u6dfb\u52a0`--project` ``\u6a19\u8a8c\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5171\u4eab VPC\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528\u5171\u4eab VPC \u8a2d\u7f6e\u96c6\u7fa3](https://cloud.google.com/kubernetes-engine/docs/how-to/private-clusters?hl=zh-cn#add_firewall_rules) \u3002### \u7b2c 3 \u6b65\uff1a\u6dfb\u52a0\u9632\u706b\u7246\u898f\u5247\n- \u9032\u5165 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **\u9632\u706b\u7246\u653f\u7b56** \u9801\u9762\u3002 [\u524d\u5f80\u201c\u9632\u706b\u7246\u653f\u7b56\u201d](https://console.cloud.google.com/net-security/firewall-manager/firewall-policies/list?hl=zh-cn) \n- \u9ede\u64ca **\u5275\u5efa\u9632\u706b\u7246\u898f\u5247** \u3002\n- \u5c0d\u65bc **\u540d\u7a31** \uff0c\u8f38\u5165\u9632\u706b\u7246\u898f\u5247\u7684\u540d\u7a31\u3002\n- \u5728 **\u7db2\u7d61** \u5217\u8868\u4e2d\uff0c\u9078\u64c7\u76f8\u95dc\u7db2\u7d61\u3002\n- \u5728 **\u6d41\u91cf\u65b9\u5411** \u4e2d\uff0c\u9ede\u64ca **\u5165\u7ad9** \u3002\n- \u5728 **\u5c0d\u5339\u914d\u9805\u57f7\u884c\u7684\u64cd\u4f5c** \u4e2d\uff0c\u9ede\u64ca **\u5141\u8a31** \u3002\n- \u5728 **\u76ee\u6a19** \u5217\u8868\u4e2d\uff0c\u9078\u64c7 **\u6307\u5b9a\u7684\u76ee\u6a19\u6a19\u8a18** \u3002\n- \u5728 **\u76ee\u6a19\u6a19\u8a18** \u90e8\u5206\uff0c\u8f38\u5165\u60a8\u4e4b\u524d\u8a18\u4e0b\u7684\u76ee\u6a19\u503c\u3002\n- \u5728 **\u4f86\u6e90\u904e\u6ffe\u689d\u4ef6** \u5217\u8868\u4e2d\uff0c\u9078\u64c7 **IPv4 \u7bc4\u570d** \u3002\n- \u5728 **\u4f86\u6e90 IPv4 \u7bc4\u570d** \u90e8\u5206\uff0c\u8f38\u5165\u96c6\u7fa3\u63a7\u5236\u5e73\u9762\u7684 CIDR \u5730\u5740\u584a\u3002\n- \u5728 **\u5354\u8b70\u548c\u7aef\u53e3** \u4e2d\uff0c\u9ede\u64ca **\u6307\u5b9a\u7684\u5354\u8b70\u548c\u7aef\u53e3** \uff0c\u9078\u4e2d\u76f8\u95dc\u5354\u8b70\uff08 **tcp** \u6216 **udp** \uff09\uff0c\u7136\u5f8c\u5728\u5354\u8b70\u5b57\u6bb5\u4e2d\u8f38\u5165\u7aef\u53e3\u865f\u3002\n- \u9ede\u64ca **\u5275\u5efa** \u3002\n\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\ngcloud compute firewall-rules create FIREWALL_RULE_NAME \\\u00a0 \u00a0 --action ALLOW \\\u00a0 \u00a0 --direction INGRESS \\\u00a0 \u00a0 --source-ranges CONTROL_PLANE_RANGE \\\u00a0 \u00a0 --rules PROTOCOL:PORT \\\u00a0 \u00a0 --target-tags TARGET\n```\n\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u60a8\u7232\u9632\u706b\u7246\u898f\u5247\u9078\u64c7\u7684\u540d\u7a31\u3002\n- ``\uff1a\u60a8\u4e4b\u524d\u6536\u96c6\u7684\u96c6\u7fa3\u63a7\u5236\u5e73\u9762 IP \u5730\u5740\u7bc4\u570d (`masterIpv4CidrBlock`)\u3002\n- `` `:` ``\uff1a\u7aef\u53e3\u53ca\u5176\u5354\u8b70\uff08`tcp`\u6216`udp`\uff09\u3002\n- ``\uff1a\u60a8\u5148\u524d\u6536\u96c6\u7684\u76ee\u6a19 (`Targets`) \u503c\u3002\n **\u6ce8\u610f** \uff1a\u82e5\u8981\u7232\u5171\u4eab VPC \u6dfb\u52a0\u9632\u706b\u7246\u898f\u5247\uff0c\u8acb\u5728\u547d\u4ee4\u4e2d\u6dfb\u52a0\u4ee5\u4e0b\u6a19\u8a8c\uff1a```\n--project HOST_PROJECT_ID\n--network NETWORK_ID\n```\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5171\u4eab VPC\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528\u5171\u4eab VPC \u8a2d\u7f6e\u96c6\u7fa3](https://cloud.google.com/kubernetes-engine/docs/how-to/private-clusters?hl=zh-cn#add_firewall_rules) \u3002\n## \u4f7f\u7528 VPC Service Controls \u4fdd\u8b77\u5c08\u7528\u96c6\u7fa3\n\u7232\u9032\u4e00\u6b65\u4fdd\u969c GKE \u5c08\u7528\u96c6\u7fa3\u7684\u5b89\u5168\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 VPC Service Controls \u4f86\u4fdd\u8b77\u5b83\u5011\u3002\nVPC Service Controls \u53ef\u7232 GKE \u5c08\u7528\u96c6\u7fa3\u63d0\u4f9b\u984d\u5916\u7684\u5b89\u5168\u4fdd\u8b77\uff0c\u6709\u52a9\u65bc\u964d\u4f4e\u767c\u751f\u6578\u64da\u6ef2\u6f0f\u7684\u98a8\u96aa\u3002\u4f7f\u7528 VPC Service Controls\uff0c\u60a8\u53ef\u4ee5\u5c07\u9805\u76ee\u6dfb\u52a0\u5230\u670d\u52d9\u908a\u754c\uff0c\u5f9e\u800c\u9632\u6b62\u8cc7\u6e90\u548c\u670d\u52d9\u53d7\u5230\u6e90\u81ea\u908a\u754c\u5916\u90e8\u7684\u8acb\u6c42\u7684\u5f71\u97ff\u3002\n\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u670d\u52d9\u908a\u754c\uff0c\u8acb\u53c3\u95b1 [\u670d\u52d9\u908a\u754c\u8a73\u60c5\u548c\u914d\u7f6e](https://cloud.google.com/vpc-service-controls/docs/service-perimeters?hl=zh-cn) \u3002\n\u5982\u679c\u60a8\u5728 VPC Service Controls \u670d\u52d9\u908a\u754c\u5167\u5c07 Artifact Registry \u8207 GKE \u5c08\u7528\u96c6\u7fa3\u642d\u914d\u4f7f\u7528\uff0c\u5247\u5fc5\u9808 [\u914d\u7f6e\u5230\u53d7\u9650\u865b\u64ec IP \u7684\u8def\u7531](https://cloud.google.com/vpc-service-controls/docs/set-up-gke?hl=zh-cn) \u4ee5\u9632\u6b62\u6578\u64da\u6ef2\u6f0f\u3002\n## \u91cd\u8907\u4f7f\u7528 VPC \u5c0d\u7b49\u4e92\u9023\n\u60a8\u5728 2020 \u5e74 1 \u6708 15 \u65e5\u4e4b\u5f8c\u5275\u5efa\u7684\u6240\u6709\u5c08\u7528\u96c6\u7fa3\u6703 [\u91cd\u8907\u4f7f\u7528 VPC \u7db2\u7d61\u5c0d\u7b49\u4e92\u9023\u9023\u63a5](https://cloud.google.com/kubernetes-engine/docs/concepts/private-cluster-concept?hl=zh-cn#network_peering_reuse) \u3002\n\u60a8\u5728 2020 \u5e74 1 \u6708 15 \u65e5\u4e4b\u524d\u5275\u5efa\u7684\u6240\u6709\u5c08\u7528\u96c6\u7fa3\u6703\u4f7f\u7528\u552f\u4e00\u7684 VPC \u7db2\u7d61\u5c0d\u7b49\u4e92\u9023\u9023\u63a5\u3002\u6bcf\u500b VPC \u7db2\u7d61\u53ef\u4ee5\u8207\u591a\u9054 25 \u500b\u5176\u4ed6 VPC \u7db2\u7d61\u5c0d\u7b49\u4e92\u9023\uff0c\u9019\u610f\u5473\u7740\u5c0d\u65bc\u9019\u4e9b\u96c6\u7fa3\uff0c\u6bcf\u500b\u7db2\u7d61\u6700\u591a\u96bb\u80fd\u6709 25 \u500b\u5c08\u7528\u96c6\u7fa3\uff08\u5047\u8a2d\u5c0d\u7b49\u4e92\u9023\u4e0d\u7528\u65bc\u5176\u4ed6\u76ee\u7684\uff09\u3002\n\u6b64\u529f\u80fd\u4e0d\u6703\u53cd\u5411\u79fb\u690d\u5230\u4e4b\u524d\u7684\u7248\u672c\u3002\u5982\u9700\u5728\u820a\u7684\u5c08\u7528\u96c6\u7fa3\u4e0a\u5553\u7528 VPC \u7db2\u7d61\u5c0d\u7b49\u4e92\u9023\u91cd\u8907\u4f7f\u7528\u529f\u80fd\uff0c\u60a8\u53ef\u4ee5\u522a\u9664\u96c6\u7fa3\u4e26\u91cd\u65b0\u5275\u5efa\u3002\u5347\u7d1a\u96c6\u7fa3\u4e26\u4e0d\u6703\u4f7f\u5176\u91cd\u7528\u73fe\u6709\u7684 VPC \u7db2\u7d61\u5c0d\u7b49\u4e92\u9023\u9023\u63a5\u3002\n\u5982\u679c\u96c6\u7fa3\u5553\u7528\u4e86 VPC \u7db2\u7d61\u5c0d\u7b49\u4e92\u9023\u91cd\u8907\u4f7f\u7528\u529f\u80fd\uff0c\u5247\u6bcf\u500b\u4f4d\u7f6e\u6700\u591a\u53ef\u4ee5\u652f\u6301 75 \u500b\u5c08\u7528\u96c6\u7fa3\u3002\u53ef\u7528\u5340\u548c\u5340\u57df\u88ab\u8996\u7232\u4e0d\u540c\u7684\u4f4d\u7f6e\u3002\n\u4f8b\u5982\uff0c\u60a8\u6700\u591a\u53ef\u5728 `us-east1-a` \u4e2d\u5275\u5efa 75 \u500b\u5730\u5340\u7d1a\u5c08\u7528\u96c6\u7fa3\uff0c\u53e6\u5916\u5728 `us-east1` \u4e2d\u5275\u5efa 75 \u500b\u5340\u57df\u7d1a\u5c08\u7528\u96c6\u7fa3\u3002\u5982\u679c\u5728\u5171\u4eab VPC \u7db2\u7d61\u4e2d\u4f7f\u7528\u5c08\u7528\u96c6\u7fa3\uff0c\u9019\u540c\u6a23\u9069\u7528\u3002 [\u55ae\u500b VPC \u7db2\u7d61\u7684\u9023\u63a5\u6578\u4e0a\u9650\u7232 25](https://cloud.google.com/vpc/docs/quota?hl=zh-cn#vpc-peering) \uff0c\u9019\u610f\u5473\u7740\u60a8\u53ea\u80fd\u4f7f\u7528 25 \u500b\u975e\u91cd\u8907\u7684\u4f4d\u7f6e\u5275\u5efa\u5c08\u7528\u96c6\u7fa3\u3002\nVPC \u7db2\u7d61\u5c0d\u7b49\u4e92\u9023\u91cd\u8907\u4f7f\u7528\u529f\u80fd\u50c5\u9069\u7528\u65bc\u540c\u4e00\u4f4d\u7f6e\u7684\u96c6\u7fa3\uff0c\u4f8b\u5982\u540c\u4e00\u5340\u57df\u4e2d\u7684\u5340\u57df\u7d1a\u96c6\u7fa3\u6216\u540c\u4e00\u53ef\u7528\u5340\u4e2d\u7684\u53ef\u7528\u5340\u7d1a\u96c6\u7fa3\u3002\u5982\u679c\u60a8\u5728\u6bcf\u500b\u5340\u57df\u7684\u6240\u6709\u53ef\u7528\u5340\u4e2d\u540c\u6642\u5275\u5efa\u5340\u57df\u7d1a\u96c6\u7fa3\u548c\u53ef\u7528\u5340\u7d1a\u96c6\u7fa3\uff0c\u5247\u8a72\u5340\u57df\u6700\u591a\u53ef\u4ee5\u6709\u56db\u500b VPC \u7db2\u7d61\u5c0d\u7b49\u4e92\u9023\u3002\n\u60a8\u53ef\u4ee5\u4f7f\u7528 gcloud CLI \u6216 Google Cloud \u63a7\u5236\u6aaf\u6aa2\u67e5\u5c08\u7528\u96c6\u7fa3\u662f\u5426\u6703\u91cd\u8907\u4f7f\u7528 VPC \u7db2\u7d61\u5c0d\u7b49\u4e92\u9023\u9023\u63a5\u3002\n\u6aa2\u67e5 **\u96c6\u7fa3\u8a73\u60c5** \u9801\u9762\u4e2d\u7684 **VPC \u5c0d\u7b49\u4e92\u9023** \u884c\u3002\u5982\u679c\u60a8\u7684\u96c6\u7fa3\u6b63\u5728\u91cd\u8907\u4f7f\u7528 VPC \u5c0d\u7b49\u4e92\u9023\u9023\u63a5\uff0c\u5247\u8f38\u51fa\u6703\u4ee5 `gke-n` \u958b\u982d\u3002\u4f8b\u5982 `gke-n34a117b968dee3b2221-93c6-40af-peer` \u3002```\ngcloud container clusters describe CLUSTER_NAME \\\u00a0 \u00a0 --format=\"value(privateClusterConfig.peeringName)\"\n```\n\u5982\u679c\u60a8\u7684\u96c6\u7fa3\u6b63\u5728\u91cd\u8907\u4f7f\u7528 VPC \u5c0d\u7b49\u4e92\u9023\u9023\u63a5\uff0c\u5247\u8f38\u51fa\u6703\u4ee5 `gke-n` \u958b\u982d\u3002\u4f8b\u5982 `gke-n34a117b968dee3b2221-93c6-40af-peer` \u3002\n**\u6ce8\u610f** \uff1a\u5982\u9700\u7232\u6bcf\u500b\u4f4d\u7f6e\u914d\u7f6e\u8d85\u904e 75 \u500b\u5c08\u7528\u96c6\u7fa3\uff0c\u8acb\u8207 Google Cloud \u652f\u6301\u5718\u968a\u806f\u7e6b\u3002\u9019\u50c5\u9069\u7528\u65bc\u96c6\u7fa3\u5553\u7528\u4e86 VPC \u7db2\u7d61\u5c0d\u7b49\u4e92\u9023\u91cd\u8907\u4f7f\u7528\u529f\u80fd\u7684\u60c5\u6cc1\u3002\n## \u6e05\u7406\n**\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u5728 GKE \u96c6\u7fa3\u4e0a\u639b\u63a5\u4e86\u8cc7\u6e90\u6642\u522a\u9664 VPC \u7db2\u7d61\u5c0d\u7b49\u4e92\u9023\u9023\u63a5\uff0c\u5247\u96c6\u7fa3\u5c07\u9032\u5165\u4fee\u5fa9\u72c0\u614b\uff0c\u5f9e\u800c\u5c0e\u81f4\u6c38\u4e45\u6027\u4e1f\u5931\u9644\u52a0\u8cc7\u6e90\u3002\u60a8\u7121\u6cd5\u6062\u5fa9\u5df2\u522a\u9664\u7684\u8cc7\u6e90\u3002\u5982\u9700\u77ad\u89e3\u89e3\u6c7a\u65b9\u6cd5\uff0c\u8acb\u53c3\u95b1 [\u201c\u554f\u984c\u6392\u67e5\uff1a\u5c08\u7528\u96c6\u7fa3\u4e0a\u7684 VPC \u7db2\u7d61\u5c0d\u7b49\u4e92\u9023\u201d\u9023\u63a5\u610f\u5916\u522a\u9664](https://cloud.google.com/kubernetes-engine/docs/how-to/private-clusters?hl=zh-cn#vpc_peering_network) \u3002\n\u5b8c\u6210\u672c\u9801\u9762\u4e0a\u7684\u4efb\u52d9\u5f8c\uff0c\u8acb\u6309\u7167\u4ee5\u4e0b\u6b65\u9a5f\u79fb\u9664\u8cc7\u6e90\uff0c\u4ee5\u9632\u6b62\u60a8\u7684\u8cec\u865f\u7522\u751f\u4e0d\u5fc5\u8981\u7684\u8cbb\u7528\uff1a\n### \u522a\u9664\u96c6\u7fa3\n- \u8f49\u5230 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **Google Kubernetes Engine** \u9801\u9762\u3002 [\u8f49\u5230 Google Kubernetes Engine](https://console.cloud.google.com/kubernetes/list?hl=zh-cn) \n- \u9078\u64c7\u6bcf\u500b\u96c6\u7fa3\u3002\n- \u9ede\u64ca **\u522a\u9664** \u3002\n```\ngcloud container clusters delete -q private-cluster-0 private-cluster-1 private-cluster-2 private-cluster-3\n```### \u522a\u9664\u7db2\u7d61\n- \u8f49\u5230 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **VPC \u7db2\u7d61** \u9801\u9762\u3002 [\u9032\u5165\u201cVPC \u7db2\u7d61\u201d](https://console.cloud.google.com/networking/networks/list?hl=zh-cn) \n- \u5728\u7db2\u7d61\u5217\u8868\u4e2d\uff0c\u9ede\u64ca `my-net-0` \u3002\n- \u5728 **VPC \u7db2\u7d61\u8a73\u7d30\u4fe1\u606f** \u9801\u9762\u4e0a\uff0c\u9ede\u64ca **\u522a\u9664 VPC \u7db2\u7d61** \u3002\n- \u5728 **\u522a\u9664\u7db2\u7d61** \u5c0d\u8a71\u6846\u4e2d\uff0c\u9ede\u64ca **\u522a\u9664** \u3002\n```\ngcloud compute networks delete my-net-0\n```\n## \u8981\u6c42\u3001\u9650\u5236\u548c\u4fb7\u9650\n\u5c08\u7528\u96c6\u7fa3\u5177\u6709\u4ee5\u4e0b\u8981\u6c42\uff1a\n- \u5c08\u7528\u96c6\u7fa3\u5fc5\u9808\u662f [VPC \u539f\u751f\u96c6\u7fa3](https://cloud.google.com/kubernetes-engine/docs/how-to/alias-ips?hl=zh-cn) \u3002 VPC \u539f\u751f\u96c6\u7fa3\u4e0d\u652f\u6301 [\u820a\u7248\u7db2\u7d61](https://cloud.google.com/vpc/docs/legacy?hl=zh-cn) \u3002\n\u5c08\u7528\u96c6\u7fa3\u5b58\u5728\u4ee5\u4e0b\u9650\u5236\uff1a\n- \u60a8\u4e0d\u80fd\u5c07\u73fe\u6709\u975e\u5c08\u7528\u96c6\u7fa3\u8f49\u63db\u7232\u5c08\u7528\u96c6\u7fa3\u3002\n- \u5c07`172.17.0.0/16`\u7528\u4f5c\u63a7\u5236\u5e73\u9762 IP \u5730\u5740\u7bc4\u570d\u6642\uff0c\u4e0d\u80fd\u5c07\u6b64\u7bc4\u570d\u7528\u65bc\u7bc0\u9ede\u3001Pod \u6216 Service IP \u5730\u5740\u3002\n- \u5982\u679c\u522a\u9664\u96c6\u7fa3\u63a7\u5236\u5c64\u9762\u8207\u96c6\u7fa3\u7bc0\u9ede\u4e4b\u9593\u7684 VPC \u5c0d\u7b49\u4e92\u9023\u3001\u522a\u9664\u5141\u8a31\u5165\u7ad9\u6d41\u91cf\u5f9e\u96c6\u7fa3\u63a7\u5236\u5c64\u9762\u50b3\u8f38\u5230\u7aef\u53e3 10250 \u4e0a\u7684\u7bc0\u9ede\u7684\u9632\u706b\u7246\u898f\u5247\uff0c\u6216\u8005\u522a\u9664\u901a\u5f80\u9ed8\u8a8d\u4e92\u806f\u7db2\u7db2\u95dc\u7684\u9ed8\u8a8d\u8def\u7531\uff0c\u5247\u6703\u5c0e\u81f4\u5c08\u7528\u96c6\u7fa3\u505c\u6b62\u904b\u884c\u3002\u5982\u679c\u60a8\u522a\u9664\u9ed8\u8a8d\u8def\u7531\uff0c\u5247\u5fc5\u9808\u78ba\u4fdd\u5c07\u6d41\u91cf\u8def\u7531\u5230\u5fc5\u8981\u7684 Google Cloud \u670d\u52d9\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u81ea\u5b9a\u7fa9\u8def\u7531](https://cloud.google.com/vpc/docs/configure-private-google-access?hl=zh-cn#config-routing-custom) \u3002\n- \u7232 VPC \u5553\u7528\u81ea\u5b9a\u7fa9\u8def\u7531\u5c0e\u51fa\u6642\uff0c\u5275\u5efa\u8207 [Google Cloud IP \u7bc4\u570d](https://cloud.google.com/vpc/docs/configure-private-google-access?hl=zh-cn#ip-addr-defaults) \u91cd\u758a\u7684\u8def\u7531\u53ef\u80fd\u6703\u7834\u58de\u60a8\u7684\u96c6\u7fa3\u3002\n- \u60a8\u6700\u591a\u53ef\u5728\u4e00\u500b\u9805\u76ee\u4e2d\u6dfb\u52a0 50 \u500b\u6388\u6b0a\u7db2\u7d61\uff08\u5141\u8a31\u7684 CIDR \u584a\uff09\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5c07\u5df2\u7372\u6388\u6b0a\u7684\u7db2\u7d61\u6dfb\u52a0\u5230\u73fe\u6709\u96c6\u7fa3](https://cloud.google.com/kubernetes-engine/docs/how-to/authorized-networks?hl=zh-cn#add) \u3002\n\u5c08\u7528\u96c6\u7fa3\u5b58\u5728\u4ee5\u4e0b\u9650\u5236\uff1a\n- \u96c6\u7fa3\u63a7\u5236\u5c64\u9762\u7684 RFC 1918 \u584a\u7684\u5927\u5c0f\u5fc5\u9808\u7232`/28`\u3002\n- \u96d6\u7136 GKE \u53ef\u4ee5\u6aa2\u6e2c\u5230\u8207\u63a7\u5236\u5c64\u9762\u5730\u5740\u584a\u7684\u91cd\u758a\uff0c\u4f46\u5b83\u7121\u6cd5\u6aa2\u6e2c\u5230\u5171\u4eab VPC \u7db2\u7d61\u4e2d\u7684\u91cd\u758a\u3002\n- \u5c08\u7528\u96c6\u7fa3\u4e2d\u7684\u6240\u6709\u7bc0\u9ede\u90fd\u662f\u5728\u6c92\u6709\u516c\u5171 IP \u5730\u5740\u7684\u60c5\u6cc1\u4e0b\u5275\u5efa\u7684\uff1b\u5b83\u5011\u5c0d Google Cloud API \u548c\u670d\u52d9\u7684\u8a2a\u554f\u53d7\u9650\u3002\u5982\u9700\u7232\u5c08\u7528\u7bc0\u9ede\u63d0\u4f9b\u51fa\u7ad9\u4e92\u806f\u7db2\u8a2a\u554f\u6b0a\u9650\uff0c\u53ef\u4ee5\u4f7f\u7528 [Cloud NAT](https://cloud.google.com/nat/docs/overview?hl=zh-cn#NATwithGKE) \u3002\n- \u5275\u5efa\u5c08\u7528\u96c6\u7fa3\u6642\uff0c\u7cfb\u7d71\u6703\u81ea\u52d5\u5553\u7528 [\u5c08\u7528 Google \u8a2a\u554f\u901a\u9053](https://cloud.google.com/vpc/docs/private-google-access?hl=zh-cn) \uff0c\u9664\u975e\u60a8\u4f7f\u7528\u5171\u4eab VPC\u3002\u9664\u975e\u60a8\u4f7f\u7528 NAT \u8a2a\u554f\u4e92\u806f\u7db2\uff0c\u5426\u5247\u4e0d\u5f97\u505c\u7528\u5c08\u7528 Google \u8a2a\u554f\u901a\u9053\u3002\n- \u5c0d\u65bc\u60a8\u5728 2020 \u5e74 1 \u6708 15 \u65e5\u4e4b\u524d\u5275\u5efa\u7684\u6240\u6709\u5c08\u7528\u96c6\u7fa3\uff0c\u6bcf\u500b\u7db2\u7d61\u6700\u591a\u96bb\u80fd\u6709 25 \u500b\u5c08\u7528\u96c6\u7fa3\uff08\u5047\u8a2d\u5c0d\u7b49\u4e92\u9023\u4e0d\u7528\u65bc\u5176\u4ed6\u76ee\u7684\uff09\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u91cd\u8907\u4f7f\u7528 VPC \u5c0d\u7b49\u4e92\u9023](https://cloud.google.com/kubernetes-engine/docs/how-to/private-clusters?hl=zh-cn#vpc_peering_reuse) \u3002\n- \u6bcf\u500b\u5c08\u7528\u96c6\u7fa3\u90fd\u8981\u6c42 VPC \u4e4b\u9593\u5b58\u5728\u5c0d\u7b49\u4e92\u9023\u8def\u7531\uff0c\u4f46\u4e00\u6b21\u53ea\u80fd\u57f7\u884c\u4e00\u9805\u5c0d\u7b49\u4e92\u9023\u64cd\u4f5c\u3002\u5982\u679c\u60a8\u5617\u8a66\u540c\u6642\u5275\u5efa\u591a\u500b\u5c08\u7528\u96c6\u7fa3\uff0c\u5247\u5275\u5efa\u96c6\u7fa3\u7684\u64cd\u4f5c\u53ef\u80fd\u6703\u8d85\u6642\u3002\u7232\u907f\u514d\u9019\u7a2e\u60c5\u6cc1\uff0c\u8acb\u4f9d\u6b21\u5275\u5efa\u65b0\u7684\u5c08\u7528\u96c6\u7fa3\uff0c\u4ee5\u4fbf\u6bcf\u500b\u5f8c\u7e8c\u5c08\u7528\u96c6\u7fa3\u90fd\u5b58\u5728 VPC \u5c0d\u7b49\u4e92\u9023\u8def\u7531\u3002\u5982\u679c VPC \u4e0a\u6709\u64cd\u4f5c\u6b63\u5728\u904b\u884c\uff0c\u5247\u5617\u8a66\u5275\u5efa\u55ae\u500b\u5c08\u7528\u96c6\u7fa3\u7684\u64cd\u4f5c\u4e5f\u53ef\u80fd\u6703\u8d85\u6642\u3002\n- \u5982\u679c\u60a8 [\u64f4\u5c55\u5b50\u7db2\u7684\u4e3b\u8981 IP \u5730\u5740\u7bc4\u570d](https://cloud.google.com/vpc/docs/create-modify-vpc-networks?hl=zh-cn#expand-subnet) \u4ee5\u5bb9\u7d0d\u5176\u4ed6\u7bc0\u9ede\uff0c\u5247\u5fc5\u9808 [\u5c07\u64f4\u5c55\u5b50\u7db2\u7684\u4e3b\u8981 IP \u5730\u5740\u7bc4\u570d\u6dfb\u52a0\u5230\u96c6\u7fa3\u7684\u6388\u6b0a\u7db2\u7d61\u5217\u8868\u4e2d](https://cloud.google.com/kubernetes-engine/docs/how-to/authorized-networks?hl=zh-cn#add) \u3002\u5426\u5247\uff0c\u7cfb\u7d71\u4e0d\u6703\u66f4\u65b0\u8207\u63a7\u5236\u5e73\u9762\u76f8\u95dc\u7684\u5165\u7ad9\u5141\u8a31\u9632\u706b\u7246\u898f\u5247\uff0c\u4e26\u4e14\u5728\u64f4\u5c55 IP \u5730\u5740\u7a7a\u9593\u4e2d\u5275\u5efa\u7684\u65b0\u7bc0\u9ede\u5c07\u7121\u6cd5\u5411\u63a7\u5236\u5e73\u9762\u8a3b\u518a\u3002\u9019\u53ef\u80fd\u6703\u5c0e\u81f4\u7cfb\u7d71\u6301\u7e8c\u522a\u9664\u4e26\u66ff\u63db\u65b0\u7bc0\u9ede\u7684\u670d\u52d9\u4e2d\u65b7\u73fe\u8c61\u3002\u5728\u57f7\u884c\u7bc0\u9ede\u6c60\u5347\u7d1a\u6216\u7bc0\u9ede\u56e0\u6d3b\u8e8d\u63a2\u6e2c\u5931\u6557\u800c\u81ea\u52d5\u66ff\u63db\u6642\uff0c\u53ef\u80fd\u6703\u767c\u751f\u6b64\u985e\u670d\u52d9\u4e2d\u65b7\u73fe\u8c61\u3002\n- \u8acb\u52ff\u5275\u5efa [\u512a\u5148\u7d1a](https://cloud.google.com/vpc/docs/firewalls?hl=zh-cn#priority_order_for_firewall_rules) \u9ad8\u65bc [\u81ea\u52d5\u5275\u5efa\u7684\u9632\u706b\u7246\u898f\u5247](https://cloud.google.com/kubernetes-engine/docs/concepts/firewall-rules?hl=zh-cn#cluster-fws) \u7684\u9632\u706b\u7246\u898f\u5247\u6216 [\u5206\u5c64\u9632\u706b\u7246\u653f\u7b56\u898f\u5247](https://cloud.google.com/vpc/docs/firewall-policies?hl=zh-cn#hierarchical_firewall_policy_rule_details) \u3002## \u554f\u984c\u6392\u67e5\n\u4ee5\u4e0b\u90e8\u5206\u4ecb\u7d39\u77ad\u5982\u4f55\u89e3\u6c7a\u8207\u5c08\u7528\u96c6\u7fa3\u76f8\u95dc\u7684\u5e38\u898b\u554f\u984c\u3002\n### \u5c08\u7528\u96c6\u7fa3\u4e0a\u7684 VPC \u7db2\u7d61\u5c0d\u7b49\u4e92\u9023\u9023\u63a5\u610f\u5916\u522a\u9664### \u96c6\u7fa3\u8207\u6d3b\u52d5\u5c0d\u7b49\u4e92\u9023\u91cd\u758a### \u7121\u6cd5\u8a2a\u554f\u5c08\u7528\u96c6\u7fa3\u7684\u63a7\u5236\u5e73\u9762\n\u901a\u904e\u5be6\u73fe\u4efb\u4e00\u96c6\u7fa3\u7aef\u9ede\u8a2a\u554f\u914d\u7f6e\uff0c\u63d0\u9ad8\u96c6\u7fa3\u63a7\u5236\u5c64\u9762\u7684\u53ef\u9054\u6027\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u96c6\u7fa3\u7aef\u9ede\u8a2a\u554f\u6b0a\u9650](https://cloud.google.com/kubernetes-engine/docs/concepts/private-cluster-concept?hl=zh-cn#overview) \u3002### \u7531\u65bc IPv4 CIDR \u584a\u91cd\u758a\u800c\u7121\u6cd5\u5275\u5efa\u96c6\u7fa3### \u7531\u65bc\u670d\u52d9\u7bc4\u570d\u5df2\u88ab\u5176\u4ed6\u96c6\u7fa3\u4f7f\u7528\uff0c\u56e0\u6b64\u7121\u6cd5\u5275\u5efa\u96c6\u7fa3### \u7121\u6cd5\u5275\u5efa\u5b50\u7db2### \u7121\u6cd5\u5f9e\u516c\u5171 Docker Hub \u4e2d\u62c9\u53d6\u6620\u50cf### \u89f8\u767c\u51c6\u5165\u7db2\u7d61\u9264\u5b50\u8d85\u6642\u7684 API \u8acb\u6c42### \u7531\u65bc\u5065\u5eb7\u6aa2\u67e5\u5931\u6557\uff0c\u56e0\u6b64\u7121\u6cd5\u5275\u5efa\u96c6\u7fa3### kubelet \u7121\u6cd5\u5275\u5efa pod \u6c99\u76d2### \u5df2\u5275\u5efa\u5c08\u7528\u96c6\u7fa3\u7bc0\u9ede\uff0c\u4f46\u672a\u52a0\u5165\u96c6\u7fa3\n\u901a\u5e38\uff0c\u5728\u5c08\u7528\u96c6\u7fa3\u6240\u7528\u7684 VPC \u4e0a\u4f7f\u7528\u81ea\u5b9a\u7fa9\u8def\u7531\u548c\u7b2c\u4e09\u65b9\u7db2\u7d61\u8a2d\u5099\u6642\uff0c\u9ed8\u8a8d\u8def\u7531 ( `0.0.0.0/0` ) \u6703\u91cd\u5b9a\u5411\u5230\u8a2d\u5099\uff0c\u800c\u4e0d\u662f\u9ed8\u8a8d\u4e92\u806f\u7db2\u7db2\u95dc\u3002\u9664\u4e86\u63a7\u5236\u5c64\u9762\u9023\u63a5\u5916\uff0c\u60a8\u9084\u9700\u8981\u78ba\u4fdd\u53ef\u4ee5\u5230\u9054\u4ee5\u4e0b\u76ee\u7684\u5730\uff1a\n- *.googleapis.com\n- *.gcr.io\n- gcr.io\n\u7232\u6240\u6709\u4e09\u500b\u7db2\u57df\u914d\u7f6e [\u5c08\u7528 Google \u8a2a\u554f\u901a\u9053](https://cloud.google.com/vpc/docs/configure-private-google-access?hl=zh-cn) \u3002\u5229\u7528\u6b64\u6700\u4f73\u505a\u6cd5\uff0c\u65b0\u7bc0\u9ede\u53ef\u4ee5\u5553\u52d5\u4e26\u52a0\u5165\u96c6\u7fa3\uff0c\u540c\u6642\u4f7f\u4e92\u806f\u7db2\u51fa\u7ad9\u6d41\u91cf\u53d7\u5230\u9650\u5236\u3002\n### \u5c08\u7528 GKE \u96c6\u7fa3\u4e0a\u7684\u5de5\u4f5c\u8ca0\u8f09\u7121\u6cd5\u8a2a\u554f\u4e92\u806f\u7db2\n\u5c08\u7528 GKE \u96c6\u7fa3\u4e2d\u7684 Pod \u7121\u6cd5\u8a2a\u554f\u4e92\u806f\u7db2\u3002\u4f8b\u5982\uff0c\u5f9e Pod `exec shell` \u904b\u884c `apt update` \u547d\u4ee4\u5f8c\uff0c\u5b83\u6703\u5831\u544a\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\u7684\u932f\u8aa4\uff1a\n```\n0% [Connecting to deb.debian.org (199.232.98.132)] [Connecting to security.debian.org (151.101.130.132)]\n```\n\u5982\u679c\u672a\u5728 Cloud NAT \u7db2\u95dc\u4e0a\u914d\u7f6e\u96c6\u7fa3\u4e2d\u7528\u65bc Pod \u7684\u5b50\u7db2\u6b21\u8981 IP \u5730\u5740\u7bc4\u570d\uff0c\u5247 Pod \u7121\u6cd5\u9023\u63a5\u5230\u4e92\u806f\u7db2\uff0c\u56e0\u7232\u5b83\u5011\u6c92\u6709\u7232 Cloud NAT \u7db2\u95dc\u914d\u7f6e\u5916\u90e8 IP \u5730\u5740\u3002\n\u8acb\u52d9\u5fc5\u5c07 Cloud NAT \u7db2\u95dc\u914d\u7f6e\u7232\u81f3\u5c11\u5c0d\u96c6\u7fa3\u4f7f\u7528\u7684\u5b50\u7db2\u61c9\u7528\u4ee5\u4e0b\u5b50\u7db2 IP \u5730\u5740\u7bc4\u570d\uff1a\n- \u5b50\u7db2\u4e3b\u8981 IP \u5730\u5740\u7bc4\u570d\uff08\u7531\u7bc0\u9ede\u4f7f\u7528\uff09\n- \u96c6\u7fa3\u4e2d\u7528\u65bc Pod \u7684\u5b50\u7db2\u6b21\u8981 IP \u5730\u5740\u7bc4\u570d\n- \u96c6\u7fa3\u4e2d\u7528\u65bc Service \u7684\u5b50\u7db2\u6b21\u8981 IP \u5730\u5740\u7bc4\u570d\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5982\u4f55\u6dfb\u52a0\u7528\u65bc Pod \u7684\u6b21\u8981\u5b50\u7db2 IP \u7bc4\u570d](https://cloud.google.com/nat/docs/set-up-manage-network-address-translation?hl=zh-cn#specify_subnet_ranges_for_nat)\n## \u5f8c\u7e8c\u6b65\u9a5f\n- [\u95b1\u8b80 GKE \u7db2\u7d61\u6982\u89bd](https://cloud.google.com/kubernetes-engine/docs/concepts/network-overview?hl=zh-cn) \u3002\n- [\u77ad\u89e3\u5982\u4f55\u5275\u5efa VPC \u539f\u751f\u96c6\u7fa3](https://cloud.google.com/kubernetes-engine/docs/how-to/alias-ips?hl=zh-cn) \u3002\n- [\u8a73\u7d30\u77ad\u89e3 VPC \u7db2\u7d61\u5c0d\u7b49\u4e92\u9023](https://cloud.google.com/vpc/docs/vpc-peering?hl=zh-cn) \u3002\n- [\u6309\u7167\u6709\u95dc\u4f7f\u7528 Cloud Build \u5c08\u7528\u6c60\u8a2a\u554f\u5c08\u7528 GKE \u96c6\u7fa3\u7684\u6559\u7a0b\u64cd\u4f5c](https://cloud.google.com/architecture/accessing-private-gke-clusters-with-cloud-build-private-pools?hl=zh-cn) \u3002", "guide": "Google Kubernetes Engine (GKE)"}