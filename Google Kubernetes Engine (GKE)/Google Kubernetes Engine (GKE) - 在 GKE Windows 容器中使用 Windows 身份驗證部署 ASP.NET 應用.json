{"title": "Google Kubernetes Engine (GKE) - \u5728 GKE Windows \u5bb9\u5668\u4e2d\u4f7f\u7528 Windows \u8eab\u4efd\u9a57\u8b49\u90e8\u7f72 ASP.NET \u61c9\u7528", "url": "https://cloud.google.com/kubernetes-engine/docs/how-to/deploying-aspnet-with-windows-authentication-in-gke-windows-containers?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - \u5728 GKE Windows \u5bb9\u5668\u4e2d\u4f7f\u7528 Windows \u8eab\u4efd\u9a57\u8b49\u90e8\u7f72 ASP.NET \u61c9\u7528\n\u672c\u6559\u7a0b\u4ecb\u7d39\u5982\u4f55\u5275\u5efa\u5c07 IIS \u8207 [\u96c6\u6210\u5f0f Windows \u8eab\u4efd\u9a57\u8b49](https://docs.microsoft.com/aspnet/web-api/overview/security/integrated-windows-authentication) \u7d50\u5408\u4f7f\u7528\u7684 ASP.NET Web \u61c9\u7528\uff0c\u4ee5\u53ca\u5982\u4f55\u4f7f\u7528 Windows \u5bb9\u5668\u5c07\u5176\u90e8\u7f72\u5230\u5177\u6709\u5df2\u52a0\u5165\u7db2\u57df\u7684 Windows Server \u7bc0\u9ede\u7684 Google Kubernetes Engine (GKE) \u96c6\u7fa3\u3002\u6b64\u914d\u7f6e\u9069\u7528\u65bc\u5728 Google Cloud \u4e0a\u7684 Windows \u5bb9\u5668\u4e2d\u90e8\u7f72 ASP.NET \u61c9\u7528\uff0c\u4ee5\u4fbf\u61c9\u7528\u53ef\u4ee5\u5411\u5176\u4ed6 Windows \u8cc7\u6e90\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u672c\u6559\u7a0b\u9084\u4ecb\u7d39\u77ad\u5982\u4f55\u5728 Active Directory \u4e2d\u5275\u5efa\u7fa3\u7d44\u4ee3\u7ba1\u5f0f\u670d\u52d9\u8cec\u865f (gMSA)\uff0c\u4ee5\u53ca\u5982\u4f55\u5728 GKE \u4e2d\u914d\u7f6e Web \u61c9\u7528\u90e8\u7f72\u4ee5\u4f7f\u7528\u5b83\u3002\n\u672c\u6559\u7a0b\u9069\u7528\u65bc\u7cfb\u7d71\u7ba1\u7406\u54e1\u3002\u5176\u5047\u5b9a\u60a8\u719f\u6089 Active Directory \u4e26\u5177\u6709\u4f7f\u7528 Google Kubernetes Engine (GKE) \u7684\u7d93\u9a57\u3002\n **\u6ce8\u610f** \uff1a\u672c\u6559\u7a0b\u8981\u6c42\u60a8\u5df2\u5b8c\u6210 [\u7232\u865b\u64ec\u6a5f\u914d\u7f6e Active Directory \u4ee5\u81ea\u52d5\u52a0\u5165\u7db2\u57df](https://cloud.google.com/architecture/configuring-active-directory-for-vms-to-automatically-join-the-domain?hl=zh-cn#costs) \u76f8\u95dc\u6559\u7a0b\uff0c\u5982\u672c\u6587\u6a94\u5f8c\u9762\u90e8\u5206\u6240\u8ff0\u3002\n", "content": "## \u76ee\u6a19\n- \u5275\u5efa\u5177\u6709\u5df2\u52a0\u5165\u7db2\u57df\u7684 Windows Server \u7bc0\u9ede\u7684 GKE \u96c6\u7fa3\uff0c\u4e26\u5c0d\u8a72\u96c6\u7fa3\u9032\u884c\u914d\u7f6e\u4ee5\u652f\u6301 Active Directory gMSA\u3002\n- \u69cb\u5efa\u548c\u90e8\u7f72\u5c07 IIS \u8207\u96c6\u6210\u5f0f Windows \u8eab\u4efd\u9a57\u8b49\u7d50\u5408\u4f7f\u7528\u7684 ASP.NET Web \u61c9\u7528\u5bb9\u5668\u6620\u50cf\u3002\n## \u8cbb\u7528  Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them \n\u5728\u672c\u6587\u6a94\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Google Cloud \u7684\u4ee5\u4e0b\u6536\u8cbb\u7d44\u4ef6\uff1a\n- [Compute Engine](https://cloud.google.com/compute/pricing?hl=zh-cn) \n- [GKE](https://cloud.google.com/kubernetes-engine/pricing?hl=zh-cn) \n- [Artifact Registry](https://cloud.google.com/artifact-registry/pricing?hl=zh-cn) \n- \u8207 [\u7232\u865b\u64ec\u6a5f\u914d\u7f6e Active Directory \u4ee5\u81ea\u52d5\u52a0\u5165\u7db2\u57df](https://cloud.google.com/architecture/configuring-active-directory-for-vms-to-automatically-join-the-domain?hl=zh-cn#costs) \u76f8\u95dc\u6559\u7a0b\u95dc\u806f\u7684\u5176\u4ed6\u8cbb\u7528\u5305\u62ec\uff1a\n- [\u7121\u670d\u52d9\u5668 VPC \u8a2a\u554f\u901a\u9053](https://cloud.google.com/vpc/network-pricing?hl=zh-cn#vpc-pricing) \n- [Cloud Run](https://cloud.google.com/run/pricing?hl=zh-cn) \n- [Container Registry](https://cloud.google.com/container-registry/pricing?hl=zh-cn) \n- [Secret Manager](https://cloud.google.com/secret-manager/pricing?hl=zh-cn) \n- [Cloud Scheduler](https://cloud.google.com/scheduler/pricing?hl=zh-cn) \n\u60a8\u53ef\u4f7f\u7528 [\u50f9\u683c\u8a08\u7b97\u5668](https://cloud.google.com/products/calculator?hl=zh-cn) \u6839\u64da\u60a8\u7684\u9810\u8a08\u4f7f\u7528\u60c5\u6cc1\u4f86\u4f30\u7b97\u8cbb\u7528\u3002 \n## \u6e96\u5099\u5de5\u4f5c\n- \u6309\u7167 [\u7232\u865b\u64ec\u6a5f\u914d\u7f6e Active Directory \u4ee5\u81ea\u52d5\u52a0\u5165\u7db2\u57df](https://cloud.google.com/architecture/configuring-active-directory-for-vms-to-automatically-join-the-domain?hl=zh-cn) \u6559\u7a0b\u4e2d\u7684\u6b65\u9a5f\u5275\u5efa\u52a0\u5165 Active Directory \u57df\u7684 Cloud Run \u670d\u52d9\u3002 **\u6ce8\u610f** \uff1a\u8acb\u52ff \u57f7\u884c [\u6e05\u7406](https://cloud.google.com/architecture/configuring-active-directory-for-vms-to-automatically-join-the-domain?hl=zh-cn#clean-up) \u90e8\u5206\u4e2d\u7684\u6b65\u9a5f\uff0c\u56e0\u7232\u60a8\u9700\u8981\u5728\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528\u4e0a\u8ff0\u6559\u7a0b\u4e2d\u7684\u8cc7\u6e90\u3002\n- \u5982\u679c\u60a8\u8981\u5728\u4e0d\u540c\u65bc\u5275\u5efa\u865b\u64ec\u6a5f\u6240\u5728\u7684 Google Cloud \u9805\u76ee\u4e2d\u904b\u884c\u672c\u6559\u7a0b\u4f86\u6e2c\u8a66\u81ea\u52d5\u7db2\u57df\u52a0\u5165\uff0c\u8acb\u5728\u60a8\u7684 Google Cloud \u9805\u76ee\u4e2d\u57f7\u884c\u6709\u95dc [\u7232\u9805\u76ee\u5553\u7528\u81ea\u52d5\u7db2\u57df\u52a0\u5165\u529f\u80fd](https://cloud.google.com/architecture/configuring-active-directory-for-vms-to-automatically-join-the-domain?hl=zh-cn#enabling_a_project_for_automatic_domain_joining) \u7684\u6b65\u9a5f\u3002\u5b8c\u6210\u53e6\u4e00\u500b\u6559\u7a0b\u5f8c\uff0c\u60a8\u5c07\u64c1\u6709\u4e00\u500b\u65b0\u7684 Cloud Run \u670d\u52d9\uff0c\u4e26\u4e14\u5176\u7db2\u5740\u6703\u8f38\u51fa\u5230 PowerShell \u7a97\u53e3\uff08 `$RegisterUrl` \u8b8a\u91cf\u7684\u503c\uff09\u3002\u8acb\u8a18\u4e0b\u8a72\u670d\u52d9\u7684\u5730\u5740\uff0c\u56e0\u7232\u60a8\u5728\u672c\u6559\u7a0b\u4e2d\u6703\u7528\u5230\u5b83\u3002\n- \u78ba\u4fdd\u60a8\u5df2\u5553\u7528\u9069\u7528\u65bc Compute Engine\u3001GKE\u3001Cloud Build\u3001Artifact Registry \u7684 API \u53ca Cloud Resource Manager API\uff1a [\u5553\u7528 API](https://console.cloud.google.com/flows/enableapi?apiid=compute%2Ccontainer%2Ccloudbuild.googleapis.com%2Cartifactregistry.googleapis.com%2Ccloudresourcemanager.googleapis.com&hl=zh-cn) \u5b8c\u6210\u672c\u6559\u7a0b\u5f8c\uff0c\u60a8\u53ef\u4ee5\u522a\u9664\u60a8\u5275\u5efa\u7684\u8cc7\u6e90\u4ee5\u907f\u514d\u7e7c\u7e8c\u8a08\u8cbb\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u6e05\u7406](#additional_considerations_for_production_applications) \u3002\n## \u67b6\u69cb\u5728\u5df2\u52a0\u5165\u7db2\u57df\u7684 Windows Server \u4e2d\u904b\u884c\u7684\u57fa\u65bc Windows \u7684\u61c9\u7528\u901a\u5e38\u4f7f\u7528 Microsoft Active Directory (AD) \u8eab\u4efd\u5c0d\u7528\u6236\u548c\u61c9\u7528\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u9019\u65b9\u9762\u7684\u5e38\u898b\u7528\u4f8b\u5982\u4e0b\uff1a- \u5275\u5efa\u4f7f\u7528 [\u96c6\u6210\u5f0f Windows \u8eab\u4efd\u9a57\u8b49](https://docs.microsoft.com/aspnet/web-api/overview/security/integrated-windows-authentication) \u7684 ASP.NET Web \u61c9\u7528\uff0c\u4ee5\u5728 Active Directory \u7528\u6236\u5617\u8a66\u767b\u9304\u8a72 Web \u61c9\u7528\u6642\u5c0d\u9019\u4e9b\u7528\u6236\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\n- \u5275\u5efa\u4f7f\u7528\u670d\u52d9\u5668\u7684 Active Directory \u8a08\u7b97\u6a5f\u8cec\u865f\u901a\u904e\u7db2\u7d61\u8a2a\u554f\u8cc7\u6e90\uff08\u4f8b\u5982\u9060\u7a0b SMB \u5171\u4eab\u6216\u9060\u7a0b Microsoft SQL Server \u5be6\u4f8b\uff09\u7684\u61c9\u7528\u3002\nWindows \u5bb9\u5668\u7121\u6cd5\u52a0\u5165\u7db2\u57df\uff0c\u56e0\u6b64\u6c92\u6709 Active Directory \u4e2d\u7684\u8a08\u7b97\u6a5f\u8cec\u865f\u3002\u56e0\u6b64\uff0c\u5728 Windows \u5bb9\u5668\u4e0a\u904b\u884c\u7684 ASP.NET Web \u61c9\u7528\u7121\u6cd5\u901a\u904e\u96c6\u6210\u7684 Windows \u8eab\u4efd\u9a57\u8b49\u5c0d Active Directory \u7528\u6236\u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u56e0\u6b64\u7121\u6cd5\u8a2a\u554f\u7db2\u7d61\u4e2d\u7684\u5b89\u5168\u8cc7\u6e90\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3 ASP.NET \u5982\u4f55\u8a2a\u554f\u53d7\u4fdd\u8b77\u7684\u8cc7\u6e90\uff0c\u8acb\u53c3\u95b1 Microsoft \u6587\u6a94\u4e2d\u7684 [\u61c9\u7528\u6c60\u8eab\u4efd](https://docs.microsoft.com/iis/manage/configuring-security/application-pool-identities#accessing-the-network) \u3002\nWindows \u5bb9\u5668\u53ef\u4ee5\u4f7f\u7528 Active Directory \u7fa3\u7d44\u4ee3\u7ba1\u5f0f\u670d\u52d9\u8cec\u865f (gMSA) \u8eab\u4efd\u8a2a\u554f\u7db2\u7d61\u4e2d\u7684 Active Directory \u548c\u5176\u4ed6\u5b89\u5168\u8cc7\u6e90\uff08\u4f8b\u5982\u6587\u4ef6\u5171\u4eab\u548c SQL Server \u5be6\u4f8b\uff09\uff0c\u800c\u4e0d\u662f\u4f7f\u7528\u8a08\u7b97\u6a5f\u8cec\u865f\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 Microsoft \u6587\u6a94\u4e2d\u7684 [\u7fa3\u7d44\u4ee3\u7ba1\u5f0f\u670d\u52d9\u8cec\u865f\u6982\u89bd](https://docs.microsoft.com/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview) \u3002\n\u4ee5\u4e0b\u67b6\u69cb\u5716\u5c55\u793a\u4e86\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528\u7684\u8cc7\u6e90\uff1a\u4e0b\u5716\u5c55\u793a\u4e86\u4ee5\u4e0b\u5143\u7d20\uff1a- **\u958b\u767c\u865b\u64ec\u6a5f** \u3002\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u5275\u5efa\u4e00\u500b Windows Server \u865b\u64ec\u6a5f\uff0c\u7528\u65bc\u69cb\u5efa ASP.NET Web \u61c9\u7528\u5bb9\u5668\u6620\u50cf\u548c\u5275\u5efa gMSA\u3002\n- **GKE \u96c6\u7fa3\u548c\u7bc0\u9ede** \u3002\u672c\u6559\u7a0b\u4e2d\u7684 GKE \u96c6\u7fa3\u6709\u4e00\u500b Linux \u7bc0\u9ede\u6c60\u548c\u4e00\u500b Windows Server \u7bc0\u9ede\u6c60\uff0c\u5176\u7528\u9014\u5982\u4e0b\uff1a- Linux \u7bc0\u9ede\u904b\u884c\u50c5\u5728 Linux \u64cd\u4f5c\u7cfb\u7d71\u4e0a\u904b\u884c\u7684\u7cfb\u7d71\u7d44\u4ef6\uff0c\u4f8b\u5982 GKE \u6307\u6a19\u670d\u52d9\u5668\u3002\n- Windows Server \u7bc0\u9ede\u7528\u65bc\u8a17\u7ba1 Windows Server \u5bb9\u5668\uff0c\u4e26\u5df2\u52a0\u5165 Active Directory \u57df\u3002\n- **Active Directory \u57fa\u790e\u67b6\u69cb** \u3002\u5982\u9700\u5c07 GKE Windows \u7bc0\u9ede\u52a0\u5165\u7db2\u57df\uff0c\u8acb\u9996\u5148\u6309\u7167 [\u914d\u7f6e Active Directory \u4ee5\u4f7f\u865b\u64ec\u6a5f\u81ea\u52d5\u52a0\u5165\u7db2\u57df](https://cloud.google.com/architecture/configuring-active-directory-for-vms-to-automatically-join-the-domain?hl=zh-cn) \u6559\u7a0b\u64cd\u4f5c\u3002\u5728\u8a72\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u5275\u5efa\u4e00\u500b Cloud Run \u670d\u52d9\uff0c\u8a72\u670d\u52d9\u8ca0\u8cac\u5728 Active Directory \u4e2d\u8a3b\u518a\u65b0\u8a08\u7b97\u6a5f\uff08\u5be6\u4f8b\uff09\uff0c\u4f75\u7232\u6bcf\u500b\u65b0\u5be6\u4f8b\u63d0\u4f9b\u81e8\u6642\u5bc6\u78bc\uff0c\u4f9b\u5be6\u4f8b\u7528\u65bc\u5b8c\u6210\u7db2\u57df\u52a0\u5165\u904e\u7a0b\u3002Windows Server \u7bc0\u9ede\u6c60\u4e2d\u7684\u6bcf\u500b\u65b0\u5be6\u4f8b\u90fd\u6703\u8abf\u7528 Cloud Run \u670d\u52d9\uff0c\u4ee5\u5c07\u81ea\u8eab\u52a0\u5165 Active Directory \u57df\u3002\n- **\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668** \u3002\u7576\u672c\u5730\u7528\u6236\u6253\u958b\u5176\u700f\u89bd\u5668\u4e26\u700f\u89bd\u5230 ASP.NET Web \u61c9\u7528\u6642\uff0c\u6d41\u91cf\u6703\u901a\u904e\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u3002\u8ca0\u8f09\u5747\u8861\u5668\u662f\u5728\u60a8\u7232 Web \u61c9\u7528\u5275\u5efa GKE LoadBalancer \u670d\u52d9\u6642\u7531 GKE \u5275\u5efa\u7684\u3002\u7528\u6236\u9084\u6703\u5c07\u5176 Active Directory \u6191\u64da\u50b3\u905e\u7d66 Web \u61c9\u7528\uff0c\u4ee5\u5411 Web \u61c9\u7528\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\n## \u5275\u5efa\u57fa\u790e\u67b6\u69cb\u5b8c\u6210\u76f8\u95dc\u6559\u7a0b\u5f8c\uff0c\u60a8\u5c07\u7232\u7576\u524d\u6559\u7a0b\u5275\u5efa\u57fa\u790e\u67b6\u69cb\u7d44\u4ef6\uff0c\u5176\u4e2d\u5305\u62ec\uff1a- \u5177\u6709 ASP.NET Web \u61c9\u7528\u5bb9\u5668\u6620\u50cf\u7684 Windows Server \u865b\u64ec\u6a5f\u3002\n- \u5177\u6709 Windows Server \u7bc0\u9ede\u6c60\u7684 GKE \u96c6\u7fa3\u3002\n- \u7232 GKE Pod \u63d0\u4f9b\u5c0d Active Directory \u7684\u8a2a\u554f\u6b0a\u9650\u7684\u9632\u706b\u7246\u898f\u5247\u3002\n- GKE \u96c6\u7fa3\u4e2d\u7684\u7db2\u7d61\u9264\u5b50\uff0c\u7528\u65bc\u8655\u7406\u90e8\u7f72\u4e2d gMSA \u8cc7\u6e90\u7684\u914d\u7f6e\u548c\u586b\u5145\u3002\n### \u5275\u5efa\u958b\u767c\u865b\u64ec\u6a5f\u60a8\u5275\u5efa\u7684 Windows Server \u5bb9\u5668\u6620\u50cf\u5fc5\u9808\u8207\u60a8\u5728\u5176\u4e2d\u69cb\u5efa\u5bb9\u5668\u6620\u50cf\u7684\u865b\u64ec\u6a5f\u7684 Windows Server \u7248\u672c\u5339\u914d\u3002\u6b64\u7248\u672c\u9084\u5fc5\u9808\u8207 GKE Window Server \u7bc0\u9ede\u7684 Windows Server \u7248\u672c\u5339\u914d\u3002\u5728\u4e0d\u540c\u7248\u672c\u7684 Windows Server \u4e2d\u5275\u5efa\u5bb9\u5668\u6620\u50cf\u6216\u904b\u884c\u5bb9\u5668\u6703\u5c0e\u81f4\u932f\u8aa4\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3 Windows \u5bb9\u5668\u7684\u517c\u5bb9\u6027\u8981\u6c42\uff0c\u8acb\u53c3\u95b1 [\u5339\u914d\u5bb9\u5668\u4e3b\u6a5f\u7248\u672c\u548c\u5bb9\u5668\u6620\u50cf\u7248\u672c](https://docs.microsoft.com/virtualization/windowscontainers/deploy-containers/version-compatibility?tabs=windows-server-20H2%2Cwindows-10-20H2#matching-container-host-version-with-container-image-versions) \u3002\n\u672c\u6559\u7a0b\u5c07\u9577\u671f\u670d\u52d9\u6e20\u9053 (LTSC) 2022 \u7248\u672c\u7684 Windows Server \u7528\u65bc\u865b\u64ec\u6a5f\u3001GKE \u4e2d\u7684 Windows Server \u7bc0\u9ede\u4ee5\u53ca\u5bb9\u5668\u6620\u50cf\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 Windows Server \u7248\u672c\u548c GKE \u7248\u672c\u4e4b\u9593\u7684 [\u7248\u672c\u6620\u5c04](https://cloud.google.com/kubernetes-engine/docs/how-to/creating-a-cluster-windows?hl=zh-cn#version_mapping) \u3002\n **\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u6253\u7b97\u5728 GKE \u96c6\u7fa3\u4e2d\u4f7f\u7528\u591a\u500b Windows Server \u7248\u672c\uff0c\u5247\u53ef\u4ee5\u69cb\u5efa [Windows Server \u591a\u67b6\u69cb\u6620\u50cf](https://cloud.google.com/kubernetes-engine/docs/tutorials/building-windows-multi-arch-images?hl=zh-cn) \u3002\u672c\u6559\u7a0b\u672a\u4ecb\u7d39\u6b64\u4e3b\u984c\u3002\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u6fc0\u6d3b Cloud Shell\u3002 [\u6fc0\u6d3b Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn)  [Cloud Shell](https://cloud.google.com/shell/docs/how-cloud-shell-works?hl=zh-cn) \u6703\u8a71\u96a8\u5373\u6703\u5728 Google Cloud \u63a7\u5236\u6aaf\u7684\u5e95\u90e8\u5553\u52d5\uff0c\u4e26\u986f\u793a\u547d\u4ee4\u884c\u63d0\u793a\u7b26\u3002Cloud Shell \u662f\u4e00\u500b\u5df2\u5b89\u88dd Google Cloud CLI \u4e14\u5df2\u7232\u7576\u524d\u9805\u76ee\u8a2d\u7f6e\u503c\u7684 Shell \u74b0\u5883\u3002\u8a72\u6703\u8a71\u53ef\u80fd\u9700\u8981\u5e7e\u79d2\u9418\u6642\u9593\u4f86\u5b8c\u6210\u521d\u59cb\u5316\u3002\n- \u5982\u679c PowerShell \u5df2\u6253\u958b\uff0c\u8acb\u8f38\u5165`exit`\u5c07\u5176\u95dc\u9589\u3002\n- \u7232\u7db2\u7d61\u548c\u5b50\u7db2\u540d\u7a31\u4ee5\u53ca Active Directory \u670d\u52d9\u7db2\u5740\u8a2d\u7f6e\u74b0\u5883\u8b8a\u91cf\uff1a```\nexport NETWORK_NAME=NETWORK-NAMEexport SUBNETWORK_NAME=SUBNETWORK-NAMEexport AD_JOIN_SERVICE_URL=AD-JOIN-SERVICE-URL\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u8981\u5728\u5176\u4e2d\u90e8\u7f72\u865b\u64ec\u6a5f\u7684 VPC \u7db2\u7d61\u3002\n- ``\uff1a\u8981\u5728\u5176\u4e2d\u90e8\u7f72\u865b\u64ec\u6a5f\u7684\u5b50\u7db2\u3002\n- ``\uff1a\u60a8\u5728 [\u6e96\u5099\u5de5\u4f5c](#before-you-begin) \u90e8\u5206\u4e2d\u90e8\u7f72\u7684 Cloud Run \u670d\u52d9\u7684\u7db2\u5740\u3002\n- \u7232\u7576\u524d\u74b0\u5883\u8a2d\u7f6e Google Cloud \u9805\u76ee ID \u548c\u5340\u57df\uff1a```\ngcloud config set project PROJECT-IDgcloud config set compute/zone ZONE-NAME\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u60a8\u7684 Google Cloud \u9805\u76ee ID\u3002\n- ``\uff1a\u8981\u5728\u5176\u4e2d\u90e8\u7f72\u6240\u6709\u865b\u64ec\u6a5f\u7684\u53ef\u7528\u5340\u3002\u7232\u7e2e\u77ed\u5ef6\u9072\u6642\u9593\uff0c\u6211\u5011\u5efa\u8b70\u60a8\u5728\u5176\u4e2d\u90e8\u7f72\u4e86\u52a0\u5165 Active Directory \u57df\u7684 Cloud Run \u670d\u52d9\u7684\u5340\u57df\u4e2d\u9078\u64c7\u53ef\u7528\u5340\u3002\n- \u7232\u958b\u767c\u865b\u64ec\u6a5f\u5275\u5efa\u670d\u52d9\u8cec\u865f\uff1a```\nexport SERVICE_ACCOUNT_NAME=dev-vmexport SERVICE_ACCOUNT_EMAIL=$SERVICE_ACCOUNT_NAME@$GOOGLE_CLOUD_PROJECT.iam.gserviceaccount.comgcloud iam service-accounts create $SERVICE_ACCOUNT_NAME \\\u00a0 \u00a0 --display-name=\"Development VM Service Account\"\n```\n- \u7232\u8a72\u670d\u52d9\u8cec\u865f\u6388\u4e88\u5c0d Artifact Registry \u7684 [\u8a2a\u554f\u6b0a\u9650](https://cloud.google.com/artifact-registry/docs/access-control?hl=zh-cn) \uff1a```\ngcloud projects add-iam-policy-binding $GOOGLE_CLOUD_PROJECT \\\u00a0 \u00a0 --member=\"serviceAccount:$SERVICE_ACCOUNT_EMAIL\" \\\u00a0 \u00a0 --role=\"roles/artifactregistry.writer\"\n```\n- \u7232\u8a72\u670d\u52d9\u8cec\u865f\u6388\u4e88\u5c0d GKE \u7684\u8a2a\u554f\u6b0a\u9650\uff1a```\ngcloud projects add-iam-policy-binding $GOOGLE_CLOUD_PROJECT \\\u00a0 \u00a0 --member=\"serviceAccount:$SERVICE_ACCOUNT_EMAIL\" \\\u00a0 \u00a0 --role=\"roles/container.admin\"\n```\u8a72\u670d\u52d9\u8cec\u865f\u6703\u88ab\u6388\u4e88 `container.admin` \u89d2\u8272\uff0c\u56e0\u7232\u6b64\u89d2\u8272\u65e2\u6709\u6b0a\u5728\u9805\u76ee\u4e2d\u5275\u5efa GKE \u96c6\u7fa3\uff0c\u53c8\u6709\u6b0a\u7ba1\u7406\u96c6\u7fa3\u4e2d\u7684\u8cc7\u6e90\uff08\u5305\u62ec\u57fa\u65bc\u89d2\u8272\u7684\u8a2a\u554f\u6b0a\u9650\u63a7\u5236 (RBAC) \u8cc7\u6e90\uff09\u3002\u9700\u8981\u5177\u6709 RBAC \u8cc7\u6e90\u624d\u80fd\u63a7\u5236\u54ea\u500b Pod \u6709\u6b0a\u4f7f\u7528 gMSA\u3002\n- \u5275\u5efa\u65b0\u7684 Windows Server 2022 \u865b\u64ec\u6a5f\uff1a```\ngcloud compute instances create gmsa-dev-vm \\\u00a0 \u00a0 --image-project windows-cloud \\\u00a0 \u00a0 --image-family windows-2022-core \\\u00a0 \u00a0 --machine-type n1-standard-2 \\\u00a0 \u00a0 --boot-disk-type=pd-ssd \\\u00a0 \u00a0 --boot-disk-size=100GB \\\u00a0 \u00a0 --network $NETWORK_NAME \\\u00a0 \u00a0 --subnet $SUBNETWORK_NAME \\\u00a0 \u00a0 --service-account=$SERVICE_ACCOUNT_EMAIL \\\u00a0 \u00a0 --scopes https://www.googleapis.com/auth/cloud-platform \\\u00a0 \u00a0 --metadata sysprep-specialize-script-ps1=\"iex((New-Object System.Net.WebClient).DownloadString('$AD_JOIN_SERVICE_URL')); Add-WindowsFeature RSAT-AD-PowerShell\"\n``` **\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u7684 VPC \u4e2d\u7684\u865b\u64ec\u6a5f\u80fd\u5920\u5728\u6c92\u6709\u5916\u90e8 IP \u5730\u5740\u7684\u60c5\u6cc1\u4e0b\u901a\u904e\u5404\u7a2e\u65b9\u5f0f\u8a2a\u554f\u4e92\u806f\u7db2\uff08\u4f8b\u5982\u4f7f\u7528 [Cloud NAT](https://cloud.google.com/nat?hl=zh-cn) \uff09\uff0c\u5247\u53ef\u4ee5\u5148\u79fb\u9664\u5916\u90e8 IP \u5730\u5740\u6216\u5c07 `--no-address` \u53c3\u6578\u6dfb\u52a0\u5230\u76f8\u61c9\u547d\u4ee4\uff0c\u7136\u5f8c\u518d\u904b\u884c\u865b\u64ec\u6a5f\u3002\u5982\u679c\u60a8\u8a08\u5283\u5c07\u5bb9\u5668\u5316\u61c9\u7528\u90e8\u7f72\u5230 Windows Server 2019 \u5bb9\u5668\uff0c\u8acb\u5c07 `--image-family` \u53c3\u6578\u503c\u66f4\u6539\u7232 `windows-2019-core-for-containers` \u3002\u7bc4\u570d `https://www.googleapis.com/auth/cloud-platform` \u5141\u8a31\u5be6\u4f8b\u8a2a\u554f\u6240\u6709 Google Cloud API\uff0c\u5177\u9ad4\u53d6\u6c7a\u65bc\u7232\u5be6\u4f8b\u7684\u670d\u52d9\u8cec\u865f\u5b9a\u7fa9\u7684 IAM \u89d2\u8272\u3002\u865b\u64ec\u6a5f\u662f\u4f7f\u7528 [\u5916\u90e8 IP \u5730\u5740](https://cloud.google.com/compute/docs/ip-addresses?hl=zh-cn#externaladdresses) \u5275\u5efa\u7684\uff0c\u4f7f\u5176\u80fd\u5920\u8207\u4e92\u806f\u7db2\u901a\u4fe1\u3002\u60a8\u9700\u8981\u865b\u64ec\u6a5f\u5177\u6709\u4e92\u806f\u7db2\u8a2a\u554f\u6b0a\u9650\uff0c\u4ee5\u4fbf\u5b83\u53ef\u4ee5\u4e0b\u8f09\u591a\u500b\u5be6\u7528\u7a0b\u5e8f\uff08\u4f8b\u5982 [git](https://www.powershellgallery.com/packages/Install-Git) \u548c [kubectl](https://www.powershellgallery.com/packages/install-kubectl) \uff09\uff0c\u4e26\u4e14\u53ef\u4ee5\u5f9e GitHub \u4e0b\u8f09 ASP.NET Web \u61c9\u7528\u3002\u5728 `sysprep` \u968e\u6bb5\uff0c\u65b0\u5be6\u4f8b\u6703\u52a0\u5165 Active Directory \u57df\uff0c\u4f7f\u60a8\u80fd\u5920\u4f7f\u7528\u7db2\u57df\u8cec\u865f\u9060\u7a0b\u8a2a\u554f\u8a72\u5be6\u4f8b\u3002 `sysprep` \u547d\u4ee4\u4e2d\u7684\u8173\u672c\u9084\u6703\u7232 Active Directory \u5b89\u88dd PowerShell \u6a21\u584a\u3002\n### \u5275\u5efa Artifact Registry Docker \u4ee3\u78bc\u5eab\n- \u5728 Cloud Shell \u4e2d\uff0c\u8a2d\u7f6e\u65b0\u7684 Artifact Registry \u4ee3\u78bc\u5eab\u7684\u9ed8\u8a8d\u4f4d\u7f6e\uff1a```\ngcloud config set artifacts/location LOCATION\n```\u5c07 `` \u66ff\u63db\u7232\u8981\u5728\u5176\u4e2d\u5275\u5efa Artifact Registry \u4ee3\u78bc\u5eab\u7684 [\u5340\u57df](https://cloud.google.com/artifact-registry/docs/repositories/repo-locations?hl=zh-cn#location-r) \u3002\u7232\u4e86\u7e2e\u77ed\u5ef6\u9072\u6642\u9593\uff0c\u5efa\u8b70\u60a8\u9078\u64c7\u5728\u5176\u4e2d\u90e8\u7f72\u4e86\u958b\u767c\u865b\u64ec\u6a5f\u7684\u5340\u57df\u3002\n- \u5275\u5efa Artifact Registry Docker \u4ee3\u78bc\u5eab\uff1a```\ngcloud artifacts repositories create windows-container-images \\\u00a0 \u00a0 --repository-format=docker\n```\n### \u5275\u5efa GKE \u96c6\u7fa3\n- \u5728 Cloud Shell \u4e2d\uff0c\u7232 GKE \u96c6\u7fa3\u7684\u540d\u7a31\u8a2d\u7f6e\u74b0\u5883\u8b8a\u91cf\uff1a```\nexport GKE_CLUSTER_NAME=cluster-1\n```\n- \u5275\u5efa GKE \u96c6\u7fa3\uff1a```\ngcloud container clusters create $GKE_CLUSTER_NAME \\\u00a0 \u00a0 --release-channel rapid \\\u00a0 \u00a0 --network $NETWORK_NAME \\\u00a0 \u00a0 --subnetwork $SUBNETWORK_NAME \\\u00a0 \u00a0 --enable-ip-alias\n```\u5c07 [--release-channel \u53c3\u6578](https://cloud.google.com/kubernetes-engine/docs/concepts/release-channels?hl=zh-cn) \u8a2d\u7f6e\u7232 `rapid` \u6703\u4f7f\u7528\u6700\u65b0 Kubernetes \u7248\u672c\u90e8\u7f72 GKE \u96c6\u7fa3\u3002 `--enable-ip-alias` \u53c3\u6578\u6703\u5553\u7528 [\u5225\u540d IP \u5730\u5740](https://cloud.google.com/vpc/docs/alias-ip?hl=zh-cn) \u3002\u5225\u540d IP \u662f Windows Server \u7bc0\u9ede\u6240\u5fc5\u9700\u7684\u3002\n### \u5728 GKE \u4e2d\u5275\u5efa Windows Server \u7bc0\u9ede\u6c60\u901a\u904e CLI \u5275\u5efa\u65b0\u7684 GKE \u96c6\u7fa3\u6642\uff0c\u7cfb\u7d71\u6703\u4f7f\u7528 Linux \u7bc0\u9ede\u6c60\u5275\u5efa\u8a72\u96c6\u7fa3\u3002\u5982\u9700\u5728 GKE \u4e0a\u4f7f\u7528 Windows Server\uff0c\u60a8\u9700\u8981\u5275\u5efa Windows Server \u7bc0\u9ede\u6c60\u3002\nGKE \u96c6\u7fa3\u5fc5\u9808\u81f3\u5c11\u5177\u6709\u4e00\u500b Linux \u7bc0\u9ede\u4f86\u904b\u884c\u96c6\u7fa3\u7684\u5167\u90e8\uff08\u7cfb\u7d71\uff09\u5bb9\u5668\u3002\u7121\u6cd5\u5275\u5efa\u50c5\u5305\u542b Windows Server \u7bc0\u9ede\u7684 GKE \u96c6\u7fa3\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u7232 Windows \u670d\u52d9\u5668\u7bc0\u9ede\u6c60\u7684\u540d\u7a31\u8a2d\u7f6e\u74b0\u5883\u8b8a\u91cf\uff1a```\nexport NODE_POOL_NAME=windows-server-pool\n```\n- \u5275\u5efa GKE Windows Server \u7bc0\u9ede\u6c60\uff1a```\ngcloud container node-pools create $NODE_POOL_NAME \\\u00a0 \u00a0 --cluster $GKE_CLUSTER_NAME \\\u00a0 \u00a0 --machine-type n1-standard-2 \\\u00a0 \u00a0 --image-type WINDOWS_LTSC_CONTAINERD \\\u00a0 \u00a0 --windows-os-version=ltsc2022 \\\u00a0 \u00a0 --num-nodes 2 \\\u00a0 \u00a0 --no-enable-autoupgrade \\\u00a0 \u00a0 --metadata sysprep-specialize-script-ps1=\"iex((New-Object System.Net.WebClient).DownloadString('$AD_JOIN_SERVICE_URL'))\"\n```\u5982\u679c\u60a8\u8a08\u5283\u5c07\u5bb9\u5668\u5316\u61c9\u7528\u90e8\u7f72\u5230 Windows Server 2019 \u5bb9\u5668\uff0c\u8acb\u5c07 `--windows-os-version` \u53c3\u6578\u66f4\u6539\u7232 `ltsc2019` \u3002`sysprep-specialize-script-ps1` \u5143\u6578\u64da\u5bc6\u9470\u662f\u4e00\u500b [\u5167\u7f6e\u5bc6\u9470](https://cloud.google.com/compute/docs/instances/startup-scripts/windows?hl=zh-cn#metadata-keys) \uff0c\u6307\u5411\u5728 [GCESysprep](https://cloud.google.com/compute/docs/instances/windows/creating-windows-os-image?hl=zh-cn#create_server_image) \u6b65\u9a5f\u671f\u9593\u57f7\u884c\u7684 PowerShell \u8173\u672c\u6b65\u9a5f\uff0c\u7136\u5f8c\u5be6\u4f8b\u5c07\u9996\u6b21\u5553\u52d5\u3002 [iex](https://docs.microsoft.com/powershell/module/microsoft.powershell.utility/invoke-expression) cmdlet \u6703\u5f9e\u60a8\u90e8\u7f72\u5230 Cloud Run \u7684\u52a0\u5165 Active Directory \u57df\u7684\u670d\u52d9\u4e0b\u8f09 PowerShell \u8173\u672c\u3002\u7136\u5f8c\uff0c\u5b83\u6703\u904b\u884c\u8a72\u8173\u672c\u4ee5\u5c07\u65b0\u5be6\u4f8b\u52a0\u5165 Active Directory \u57df\u3002`--no-enable-autoupgrade` \u53c3\u6578\u53ef\u505c\u7528\u6c60\u4e2d\u6240\u6709\u7bc0\u9ede\u7684 [\u7bc0\u9ede\u81ea\u52d5\u5347\u7d1a](https://cloud.google.com/kubernetes-engine/docs/how-to/node-auto-upgrades?hl=zh-cn) \u529f\u80fd\u3002\u9019\u662f\u56e0\u7232\u5347\u7d1a\u7bc0\u9ede\u7684 Windows \u6620\u50cf\u53ef\u80fd\u6703\u5c0e\u81f4\u7bc0\u9ede\u7684 Windows Server \u7248\u672c\u8207 Pod \u7684 Windows Server \u7248\u672c\u4e4b\u9593\u4e0d\u517c\u5bb9\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5347\u7d1a Windows Server \u7bc0\u9ede\u6c60](https://cloud.google.com/kubernetes-engine/docs/how-to/creating-a-cluster-windows?hl=zh-cn#upgrading_windows_server_node_pools) \u3002\u5275\u5efa\u6bcf\u500b\u7bc0\u9ede\u5f8c\uff0c `domain-join` PowerShell \u8173\u672c\u6703\u5c07\u7bc0\u9ede\u52a0\u5165\u7db2\u57df\u3002\n- \u7b49\u5f85\u5e7e\u5206\u9418\uff0c\u76f4\u5230\u7bc0\u9ede\u6c60\u5275\u5efa\u5b8c\u6210\uff0c\u7136\u5f8c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u9a57\u8b49\u6240\u6709\u7bc0\u9ede\u662f\u5426\u5df2\u52a0\u5165\u7db2\u57df\uff1a```\nkubectl get node \\-l cloud.google.com/gke-nodepool=$NODE_POOL_NAME \\-o custom-columns=\":metadata.name\" --no-headers \\\u00a0 \u00a0 | xargs -I{} gcloud compute instances get-serial-port-output {} --port 1 \\\u00a0 \u00a0 | grep \"sysprep-specialize-script-ps1:.*success\" --ignore-case\n```\u5982\u679c\u7bc0\u9ede\u5df2\u52a0\u5165\u7db2\u57df\uff0c\u5247\u8f38\u51fa\u6703\u5982\u4e0b\u6240\u793a\uff1a```\ntimestamp GCEMetadataScripts: sysprep-specialize-script-ps1: Successfully registered computer account.\ntimestamp GCEMetadataScripts: sysprep-specialize-script-ps1: Computer successfully joined to domain\nSpecify --start=152874 in the next get-serial-port-output invocation to get only the new output starting from here.\n```\u5982\u679c\u60a8\u60f3\u67e5\u770b\u5b8c\u6574\u7684\u8173\u672c\u8f38\u51fa\uff0c\u8acb\u5f9e `grep` \u547d\u4ee4\u4e2d\u79fb\u9664 `.*success` \u3002\n### \u7232 GKE Pod \u6388\u4e88\u5c0d Active Directory \u7684\u8a2a\u554f\u6b0a\u9650\u60a8\u9700\u8981\u5275\u5efa\u4e00\u689d\u9632\u706b\u7246\u898f\u5247\uff0c\u4ee5\u5141\u8a31 GKE \u96c6\u7fa3\u7684 Pod \u4f7f\u7528\u4ee5\u4e0b\u5354\u8b70\u8a2a\u554f\u60a8\u7684\u7db2\u57df\u63a7\u5236\u5668\uff1a- Kerberos\uff08UDP/88\u3001TCP/88\uff09\n- NTP (UDP/123)\n- RPC\uff08TCP/135\u3001TCP/49152-65535\uff09\n- LDAP\uff08UDP/389\u3001TCP/389\uff09\n- SMB\uff08UDP/445\u3001TCP/445\uff09\n- LDAP GC (TCP/3268)\n- Active Directory Web \u670d\u52d9 (TCP/9389)\n\u60a8\u53ef\u4ee5\u6839\u64da\u5df2\u5206\u914d\u7d66\u7db2\u57df\u63a7\u5236\u5668\u7684\u670d\u52d9\u8cec\u865f\u61c9\u7528\u898f\u5247\uff0c\u4e5f\u53ef\u4ee5\u50cf\u672c\u6559\u7a0b\u90a3\u6a23\u4f7f\u7528\u7db2\u7d61\u6a19\u8a18\u4f86\u61c9\u7528\u898f\u5247\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3 Active Directory \u76f8\u95dc\u7aef\u53e3\uff0c\u8acb\u53c3\u95b1\u95dc\u65bc [Active Directory \u7aef\u53e3\u548c\u5354\u8b70\u8981\u6c42](https://docs.microsoft.com/troubleshoot/windows-server/networking/service-overview-and-network-port-requirements#active-directory-port-and-protocol-requirements) \u4ee5\u53ca [\u8de8\u9632\u706b\u7246\u4f7f\u7528 Active Directory](https://cloud.google.com/managed-microsoft-ad/docs/firewalls?hl=zh-cn) \u7684\u6587\u6a94\u3002\n\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f [Managed Service for Microsoft Active Directory](https://cloud.google.com/managed-microsoft-ad/docs/overview?hl=zh-cn) \uff08\u4ee3\u7ba1\u5f0f Microsoft AD\uff09\uff0c\u5247\u53ef\u4ee5\u8df3\u904e\u6b64\u6b65\u9a5f\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u7372\u53d6 GKE \u96c6\u7fa3\u7684 Pod IP \u5730\u5740\u7bc4\u570d\uff1a```\nCLUSTER_IP_RANGE=`gcloud container clusters describe $GKE_CLUSTER_NAME --format=\"value(clusterIpv4Cidr)\"`\n```\n- \u5275\u5efa\u4e00\u689d\u9632\u706b\u7246\u898f\u5247\uff0c\u4ee5\u4fbf\u7232 GKE Pod \u63d0\u4f9b\u5c0d Active Directory \u7684\u8a2a\u554f\u6b0a\u9650\uff1a```\ngcloud compute firewall-rules create allow-gke-pods-to-ad \\\u00a0 \u00a0 --network $NETWORK_NAME \\\u00a0 \u00a0 --allow udp:88,tcp:88,udp:123,tcp:135,tcp:49152-65535,udp:389,tcp:389,udp:445,tcp:445,tcp:3268,tcp:9389 \\\u00a0 \u00a0 --source-ranges=$CLUSTER_IP_RANGE \\\u00a0 \u00a0 --target-tags DC-TAG\n```\u5c07 `` \u66ff\u63db\u7232\u5206\u914d\u7d66\u60a8\u7684\u7db2\u57df\u63a7\u5236\u5668\u865b\u64ec\u6a5f\u7684\u7db2\u7d61\u6a19\u8a18\u3002\n### \u914d\u7f6e GKE \u4ee5\u652f\u6301\u4f7f\u7528 gMSA\u5982\u9700\u5728 Windows Server \u7bc0\u9ede\u4e2d\u4f7f\u7528 gMSA\uff0c\u60a8\u9700\u8981\u5728 Active Directory \u4e2d\u5275\u5efa gMSA \u5c0d\u8c61\uff0c\u5728 GKE \u4e2d\u5275\u5efa\u5339\u914d\u7684 gMSA \u8cc7\u6e90\uff0c\u4e26\u5553\u7528\u65b0\u5275\u5efa\u7684 Pod \u4ee5\u63d0\u53d6\u5176 gMSA \u6191\u64da\u3002- \u5728 Cloud Shell \u4e2d\uff0c\u4e0b\u8f09\u4e26\u904b\u884c gMSA \u7db2\u7d61\u9264\u5b50\u8173\u672c\uff1a```\nexport K8S_GMSA_DEPLOY_DOWNLOAD_REV=b685a27adc40511bb5756dfb3ada2e8578ee72e1curl https://raw.githubusercontent.com/kubernetes-sigs/windows-gmsa/$K8S_GMSA_DEPLOY_DOWNLOAD_REV/admission-webhook/deploy/deploy-gmsa-webhook.sh -o deploy-gmsa-webhook.sh && chmod +x deploy-gmsa-webhook.sh./deploy-gmsa-webhook.sh --file ./gmsa-webhook.yml --namespace gmsa-webhook --overwriterm -drf gmsa-webhook-certs\n```\u8a72\u8173\u672c\u6703\u5c07 gMSA [\u81ea\u5b9a\u7fa9\u8cc7\u6e90\u5b9a\u7fa9](https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/) (CRD) \u6e05\u55ae\u6dfb\u52a0\u5230 GKE \u96c6\u7fa3\uff0c\u4e26\u90e8\u7f72\u7db2\u7d61\u9264\u5b50\u4ee5\u5c07 gMSA \u898f\u7bc4\u63d0\u4f9b\u7d66 Pod\u3002\u60a8\u73fe\u5728\u53ef\u4ee5\u5c07 gMSA \u898f\u7bc4\u5b58\u5132\u5728\u96c6\u7fa3\u4e2d\uff0c\u4f75\u7232 Pod \u548c\u5bb9\u5668\u914d\u7f6e gMSA\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3 Kubernetes \u548c gMSA\uff0c\u8acb\u53c3\u95b1 [\u7232 Windows Pod \u548c\u5bb9\u5668\u914d\u7f6e GMSA](https://kubernetes.io/docs/tasks/configure-pod-container/configure-gmsa/) \u3002\n\u60a8\u7684 GKE \u96c6\u7fa3\u73fe\u5df2\u6e96\u5099\u597d\u904b\u884c\u9700\u8981\u4f7f\u7528 gMSA \u7684 Windows \u61c9\u7528\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u5728 Windows Server \u7bc0\u9ede\u4e2d\u904b\u884c ASP.NET Web \u61c9\u7528\u3002\u60a8\u53ef\u4ee5\u914d\u7f6e\u61c9\u7528\uff0c\u8b93\u7528\u6236\u4f7f\u7528 Windows \u8eab\u4efd\u9a57\u8b49\u767b\u9304\uff0c\u6216\u8005\u8b93\u61c9\u7528\u4f7f\u7528 Pod \u7684 gMSA \u8a2a\u554f\u9060\u7a0b\u7db2\u7d61\u5171\u4eab\u6216 SQL Server \u6578\u64da\u5eab\u3002## \u8207 Active Directory \u96c6\u6210\u63a5\u4e0b\u4f86\uff0c\u60a8\u5c07\u5728 Active Directory \u4e2d\u7232 ASP.NET Web \u61c9\u7528\u5275\u5efa gMSA\uff0c\u914d\u7f6e gMSA \u7684\u4f7f\u7528\u65b9\u5f0f\u548c\u4f7f\u7528\u8005\uff0c\u7136\u5f8c\u5c07\u5176\u914d\u7f6e\u6dfb\u52a0\u5230 GKE\u3002\n### \u767b\u9304\u4e26\u5553\u52d5 PowerShell\n- [\u9023\u63a5\u5230](https://cloud.google.com/compute/docs/instances/connecting-to-windows?hl=zh-cn) `gmsa-dev-vm`\u865b\u64ec\u6a5f\u3002\n- \u4f7f\u7528\u6709\u6b0a\u5275\u5efa gMSA \u7684 Active Directory \u8cec\u865f\u767b\u9304 Windows\u3002\u60a8\u7684\u8cec\u865f\u9700\u8981\u662f `Domain Admins` \u7fa3\u7d44\u7684\u6210\u54e1\uff0c\u6216\u8005\u5fc5\u9808\u80fd\u5920\u5275\u5efa `msDS-GroupManagedServiceAccount` \u5c0d\u8c61\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u9810\u914d\u7fa3\u7d44\u4ee3\u7ba1\u5f0f\u670d\u52d9\u8cec\u865f](https://docs.microsoft.com/windows-server/security/group-managed-service-accounts/getting-started-with-group-managed-service-accounts#BKMK_Step1) \u3002\u5982\u679c\u60a8\u4f7f\u7528\u4ee3\u7ba1\u5f0f Microsoft AD\uff0c\u5247\u60a8\u7684\u8cec\u865f\u9700\u8981\u662f `Cloud Service Managed Service Account Administrators` \u7fa3\u7d44\u7684\u6210\u54e1\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u59d4\u6d3e\u4ee3\u7ba1\u5f0f\u670d\u52d9\u8cec\u865f\u7684\u7ba1\u7406](https://cloud.google.com/managed-microsoft-ad/docs/create-gmsa?hl=zh-cn#delegate-administration) \u3002\n- \u8f38\u5165 `15` \u4ee5\u9000\u51fa\u547d\u4ee4\u884c (PowerShell) \u83dc\u55ae\u3002\n### \u5b89\u88dd\u5bb9\u5668\u904b\u884c\u6642Windows Server 2022 \u9700\u8981\u4f7f\u7528\u5bb9\u5668\u904b\u884c\u6642\uff0c\u4f8b\u5982 Docker \u793e\u5340\u7248 (CE)\uff0c\u4f86\u5275\u5efa\u548c\u904b\u884c Windows \u5bb9\u5668\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u5728 Windows Server \u4e0a\u5b89\u88dd\u5bb9\u5668\u904b\u884c\u6642\uff0c\u8acb\u53c3\u95b1 Microsoft \u6587\u6a94\u4e2d\u7684 [\u4f7f\u7528\u5165\u9580\uff1a\u7232\u5bb9\u5668\u6e96\u5099 Windows](https://learn.microsoft.com/virtualization/windowscontainers/quick-start/set-up-environment?tabs=dockerce#windows-server-1) \u3002\n\u5982\u679c\u60a8\u662f\u4f7f\u7528 `windows-2019-core-for-containers` \u6620\u50cf\u5275\u5efa\u7684\u958b\u767c\u865b\u64ec\u6a5f\uff0c\u5247\u53ef\u4ee5\u8df3\u904e\u4ee5\u4e0b\u6b65\u9a5f\uff0c\u56e0\u7232\u8a72\u6620\u50cf\u5df2\u5b89\u88dd Docker\u3002- \u5b89\u88dd Docker \u793e\u5340\u7248 (CE)\uff1a```\nInvoke-WebRequest -UseBasicParsing -o install-docker-ce.ps1 `\u00a0 \u00a0\"https://raw.githubusercontent.com/microsoft/Windows-Containers/Main/helpful_tools/Install-DockerCE/install-docker-ce.ps1\".\\install-docker-ce.ps1\n```\u5982\u679c\u5728\u5b89\u88dd\u904e\u7a0b\u4e2d\uff0c\u9060\u7a0b\u684c\u9762\u9023\u63a5\u95dc\u9589\uff0c\u8acb\u91cd\u65b0\u9023\u63a5\u5230\u865b\u64ec\u6a5f\u3002\n- \u7b49\u5f85\u5b89\u88dd\u904e\u7a0b\u5b8c\u6210\uff0c\u7136\u5f8c\u8f38\u5165 `exit` \u4ee5\u95dc\u9589\u65b0\u7684 PowerShell \u7a97\u53e3\u3002\n- \u8f38\u5165 `15` \u4ee5\u9000\u51fa\u547d\u4ee4\u884c (PowerShell) \u83dc\u55ae\u3002\n### \u5275\u5efa KDS \u6839\u5bc6\u9470\u5275\u5efa gMSA \u4e4b\u524d\uff0c\u60a8\u5fc5\u9808\u78ba\u4fdd Active Directory \u57df\u63a7\u5236\u5668\u5177\u6709 [\u5bc6\u9470\u5206\u767c\u670d\u52d9 (KDS) \u6839\u5bc6\u9470](https://docs.microsoft.com/windows-server/security/group-managed-service-accounts/create-the-key-distribution-services-kds-root-key) \u3002Active Directory \u4f7f\u7528 KDS \u6839\u5bc6\u9470\u7232 gMSA \u751f\u6210\u5bc6\u78bc\u3002\n\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f\u4ee3\u7ba1\u5f0f Microsoft AD\uff0c\u5247\u53ef\u4ee5\u8df3\u904e\u4ee5\u4e0b\u6b65\u9a5f\uff0c\u56e0\u7232\u4ee3\u7ba1\u5f0f Microsoft AD \u6703\u5728\u60a8\u5275\u5efa\u7db2\u57df\u6642\u5275\u5efa KDS \u6839\u5bc6\u9470\u3002- \u5728 `gmsa-dev-vm` \u4e0a\uff0c\u6aa2\u67e5 Active Directory \u662f\u5426\u5df2\u5177\u6709 KDS \u6839\u5bc6\u9470\uff1a```\nGet-KdsRootKey\n```\u6b64\u547d\u4ee4\u6703\u986f\u793a\u5bc6\u9470 ID\uff08\u5982\u679c\u5b58\u5728\uff09\u3002\n- \u5982\u679c\u60a8\u672a\u5728\u97ff\u61c9\u4e2d\u6536\u5230\u5bc6\u9470 ID\uff0c\u8acb\u5275\u5efa\u5bc6\u9470\uff1a```\nAdd-KdsRootKey -EffectiveTime ((get-date).addhours(-10))\n```\n### \u5275\u5efa gMSA\u5275\u5efa gMSA \u6642\uff0c\u60a8\u9700\u8981\u63d0\u4f9b\u6709\u6b0a\u8a2a\u554f gMSA \u7684\u8a08\u7b97\u6a5f\u7684\u540d\u7a31\u3002\u7232\u4fdd\u8b49\u5b89\u5168\u6027\uff0c\u5efa\u8b70\u60a8\u50c5\u5411\u5728\u5176\u4e2d\u904b\u884c\u61c9\u7528\u7684\u5be6\u4f8b\u6388\u4e88\u5c0d gMSA \u7684\u6b0a\u9650\u3002\u5275\u5efa\u5df2\u52a0\u5165\u7db2\u57df\u7684 Windows Server \u7bc0\u9ede\u6c60\u6642\uff0c\u7cfb\u7d71\u6703\u7232\u8a72\u7bc0\u9ede\u6c60\u7684\u8a08\u7b97\u6a5f\u5275\u5efa\u65b0\u7684 Active Directory \u7fa3\u7d44\u3002\u8a72\u7fa3\u7d44\u7684\u540d\u7a31\u8207 GKE \u7232\u7bc0\u9ede\u6c60\u5275\u5efa\u7684\u4ee3\u7ba1\u5f0f\u5be6\u4f8b\u7d44 (MIG) \u7684\u540d\u7a31\u5339\u914d\u3002- \u5728 PowerShell \u4e2d\uff0c\u7232 Google Cloud \u9805\u76ee ID\u3001\u96c6\u7fa3\u540d\u7a31\u3001Windows \u7bc0\u9ede\u6c60\u540d\u7a31\u3001gMSA \u540d\u7a31\u548c AD \u57df\u8a2d\u7f6e\u8b8a\u91cf\uff1a```\n$ProjectId = \"PROJECT-ID\"$GkeClusterName = \"cluster-1\"$PermittedNodePool = \"windows-server-pool\"$GmsaName = \"WebApp-01\"$AdDomain = (Get-ADDomain).DNSRoot\n```\u5c07 `` \u66ff\u63db\u7232\u60a8\u7684 Google Cloud \u9805\u76ee ID\u3002\n- \u7232 `gcloud` \u5de5\u5177\u8a2d\u7f6e\u96c6\u7fa3\u914d\u7f6e\uff1a```\ngcloud config set project $ProjectIdgcloud config set compute/zone \"ZONE-NAME\"\n```\u5c07 `` \u66ff\u63db\u7232\u5728\u5176\u4e2d\u90e8\u7f72 GKE \u96c6\u7fa3\u7684\u53ef\u7528\u5340\u3002\n- \u6aa2\u7d22\u7232\u7bc0\u9ede\u6c60\u5275\u5efa\u7684 Active Directory \u7fa3\u7d44\u7684\u57df\u540d\uff1a```\n$InstanceGroupUri = gcloud container node-pools describe $PermittedNodePool `\u00a0 \u00a0 --cluster $GkeClusterName `\u00a0 \u00a0 --format=\"value(instanceGroupUrls)\"$InstanceGroupName=([System.Uri]$instanceGroupUri).Segments[-1]$GroupDN=(Get-ADGroup -Filter \"name -eq '$InstanceGroupName'\")Write-Host $GroupDN.DistinguishedName\n```\n- \u5275\u5efa gMSA\uff1a```\nNew-ADServiceAccount -Name $GmsaName `-DNSHostName \"$GmsaName.$AdDomain\" `-PrincipalsAllowedToRetrieveManagedPassword $GroupDN\n```\n- \u9a57\u8b49\u662f\u5426\u5df2\u5275\u5efa gMSA\uff1a```\nGet-ADServiceAccount -Identity $GmsaName\n```\u5982\u679c\u5df2\u5275\u5efa gMSA\uff0c\u5247\u8f38\u51fa\u6703\u5982\u4e0b\u6240\u793a\uff1a```\nDistinguishedName : CN=WebApp01,CN=Managed Service Accounts,DC=corp,DC=example,DC=com\nEnabled   : True\nName    : WebApp01\nObjectClass  : msDS-GroupManagedServiceAccount\nObjectGUID  : 5afcff45-cf15-467d-aaeb-d65e53288253\nSamAccountName : WebApp01$\nSID    : S-1-5-21-780151012-601164977-3226406772-2103\nUserPrincipalName :\n```\n### \u5c07 gMSA \u6dfb\u52a0\u5230 GKE\u5982\u9700\u5728 Kubernetes \u96c6\u7fa3\u4e2d\u4f7f\u7528 gMSA\uff0c\u60a8\u9700\u8981\u5728 Kubernetes \u4e2d\u5275\u5efa gMSA \u8cc7\u6e90\uff0c\u4e26\u914d\u7f6e\u54ea\u4e9b\u547d\u540d\u7a7a\u9593\u548c\u8cec\u865f\u6709\u6b0a\u4f7f\u7528\u8a72 gMSA \u8cc7\u6e90\u3002- \u5728 `gmsa-dev-vm` \u4e0a\u7684 PowerShell \u4e2d\u5b89\u88dd `git` \u5de5\u5177\uff1a```\nInstall-Script -Name Install-Git -ForceInstall-Git.ps1$env:Path += \";c:\\program files\\git\\bin\"\n```\n- \u5b89\u88dd `kubectl` \u5de5\u5177\u3002```\n$version = (Invoke-WebRequest -UseBasicParsing -Uri \"https://dl.k8s.io/release/stable.txt\").Content$uri = \"https://dl.k8s.io/release/$version/bin/windows/amd64/kubectl.exe\"New-Item -Type Directory $env:ProgramFiles\\kubectlStart-BitsTransfer -Source $uri -Destination $env:ProgramFiles\\kubectl\\$env:Path += \";$env:ProgramFiles\\kubectl\"\n```\n- \u5b89\u88dd `gke-gcloud-auth-plugin` \u4e8c\u9032\u5236\u6587\u4ef6\uff1a```\ngcloud components install gke-gcloud-auth-plugin\n```\u7b49\u5f85\u6578\u5206\u9418\uff0c\u4ee5\u4fbf\u5b89\u88dd\u904e\u7a0b\u5b8c\u6210\u3002\n- \u4f7f\u7528 GKE \u96c6\u7fa3\u7684\u6191\u64da\u521d\u59cb\u5316 `kubectl` \u5de5\u5177\uff1a```\ngcloud container clusters get-credentials $GkeClusterName\n```\n- \u5275\u5efa [gMSA \u6191\u64da\u898f\u7bc4](https://kubernetes.io/docs/tasks/configure-pod-container/configure-gmsa/#create-gmsa-credential-spec-resources) \u6587\u4ef6\uff1a```\nInstall-Module CredentialSpec -Force$GmsaName = $GmsaName.ToLower()$CredSpecFile = Join-Path $env:TEMP \"$GmsaName-credspec.json\"New-CredentialSpec -AccountName $GmsaName -Path $CredSpecFile$CredentialsSpec=@{\"apiVersion\" = \"windows.k8s.io/v1\";\"kind\" = \"GMSACredentialSpec\";\"metadata\" = @{\"name\" = $GmsaName}\"credspec\" = (Get-Content $CredSpecFile | ConvertFrom-Json)}$CredentialsSpec | ConvertTo-Json -Depth 5 | Set-Content $CredSpecFile\n```Kubernetes \u4e2d `GMSACredentialSpec` \u8cc7\u6e90\u7684\u540d\u7a31 [\u5fc5\u9808\u4f7f\u7528\u5c0f\u5beb\u5b57\u7b26](https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#dns-subdomain-names) \u3002\u8173\u672c\u6703\u66f4\u6539 `$GmsaName` \u8b8a\u91cf\u7684\u5927\u5beb\u5b57\u6bcd\uff0c\u4ee5\u7b26\u5408\u6b64\u9650\u5236\u3002\u8173\u672c\u6703\u986f\u793a\u4e00\u689d\u8b66\u544a\u6d88\u606f\uff0c\u8868\u793a\u6e2c\u8a66\u4ee3\u7ba1\u5f0f\u670d\u52d9\u8cec\u865f\u5931\u6557\uff0c\u9019\u5728\u610f\u6599\u4e4b\u5167\u3002\u60a8\u7684\u958b\u767c\u865b\u64ec\u6a5f\u4e0d\u662f\u5206\u914d\u7d66 gMSA \u7684\u7fa3\u7d44\u7684\u6210\u54e1\uff0c\u56e0\u6b64\u7121\u6cd5\u5f9e\u865b\u64ec\u6a5f\u6e2c\u8a66 gMSA\u3002\u8a72\u8b66\u544a\u6d88\u606f\u4e0d\u6703\u963b\u6b62\u547d\u4ee4\u751f\u6210 gMSA \u6191\u64da\u898f\u7bc4\u3002\n- \u5c07 gMSA \u6191\u64da\u898f\u7bc4\u6dfb\u52a0\u5230 GKE \u96c6\u7fa3\uff1a```\nkubectl apply -f $CredSpecFile\n```\n- \u514b\u9686 GitHub \u4ee3\u78bc\u5eab\uff1a```\ngit clone https://github.com/GoogleCloudPlatform/gke-aspnet-gmsa.gitcd gke-aspnet-gmsa\n```\n- \u5c07 gMSA RBAC \u5c0d\u8c61\u6dfb\u52a0\u5230\u96c6\u7fa3\uff1a```\nkubectl apply -f gmsa-rbac-webapp-01.yaml\n````gmsa-rbac-webapp-01.yaml` \u6703\u7232 gMSA \u5275\u5efa `ClusterRole` RBAC \u5c0d\u8c61\uff0c\u7136\u5f8c\u5c07\u65b0\u96c6\u7fa3\u89d2\u8272\u7d81\u5b9a\u5230 `default` \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u9ed8\u8a8d\u670d\u52d9\u8cec\u865f\u3002\u5982\u679c\u60a8\u8981\u5c07\u61c9\u7528\u90e8\u7f72\u5230\u5176\u4ed6\u547d\u540d\u7a7a\u9593\uff0c\u8acb\u4fee\u6539 `gmsa-rbac-webapp-01.yaml` \u6587\u4ef6\u4e26\u66f4\u6539\u89d2\u8272\u7d81\u5b9a\u548c\u670d\u52d9\u8cec\u865f\u7684\u547d\u540d\u7a7a\u9593\u3002\n## \u90e8\u7f72\u548c\u4f7f\u7528 Web \u61c9\u7528\u63a5\u4e0b\u4f86\uff0c\u60a8\u5c07\u69cb\u5efa Web \u61c9\u7528\u548c\u5bb9\u5668\u6620\u50cf\uff0c\u5c07\u65b0\u7684\u5bb9\u5668\u6620\u50cf\u90e8\u7f72\u5230 GKE \u96c6\u7fa3\uff0c\u4e26\u5728\u700f\u89bd\u5668\u4e2d\u6253\u958b Web \u61c9\u7528\u4f86\u9a57\u8b49 Web \u61c9\u7528\u662f\u5426\u53ef\u4ee5\u4f7f\u7528 gMSA\u3002\n### \u69cb\u5efa\u548c\u90e8\u7f72 ASP.NET Web \u61c9\u7528\n- \u5728 `gmsa-dev-vm` \u4e0a\u7684 PowerShell \u4e2d\uff0c\u7232\u8a3b\u518a\u8868\u4f4d\u7f6e\u3001\u8a3b\u518a\u8868\u540d\u7a31\u548c\u6620\u50cf\u6a19\u8a18\u8a2d\u7f6e\u8b8a\u91cf\uff1a```\n$RegistryLocation = \"LOCATION-docker.pkg.dev\"$ProjectsRegistry = \"$RegistryLocation/$ProjectId\"$ImageTag = \"$ProjectsRegistry/windows-container-images/test-gmsa:latest\"\n```\u5c07 `` \u66ff\u63db\u7232\u5275\u5efa\u4e86 Artifact Registry \u4ee3\u78bc\u5eab\u7684\u4f4d\u7f6e\u3002\n- \u69cb\u5efa\u5bb9\u5668\u6620\u50cf\uff1a```\ndocker build -t $ImageTag -f Dockerfile-WINDOWS_LTSC2022 .\n```\u5982\u9700\u7232 Windows Server 2019 \u69cb\u5efa\u5bb9\u5668\u6620\u50cf\uff0c\u8acb\u5c07 `-f` \u53c3\u6578\u503c\u8a2d\u7f6e\u7232 `Dockerfile-WINDOWS_LTSC2019` \u3002\n- \u5c07\u5bb9\u5668\u6620\u50cf\u63a8\u9001\u5230 Artifact Registry\uff1a```\ngcloud auth configure-docker $RegistryLocation --quietdocker push $ImageTag\n```\n- \u4e0b\u8f09\u61c9\u7528\u7684 YAML \u6587\u4ef6\uff0c\u4e26\u4f7f\u7528 gMSA \u914d\u7f6e\u9032\u884c\u66f4\u65b0\uff1a```\n$ApplicationYaml = Join-Path $env:TEMP \"gmsa-test-webapp-01.yaml\"(Get-Content gmsa-test-webapp-01.yaml.template) `-Replace '\\${image_path}',$ImageTag | `Set-Content $ApplicationYaml\n```\u5982\u679c\u60a8\u8981\u5728 GKE \u4e2d\u5275\u5efa Windows Server 2019 \u7bc0\u9ede\uff0c\u8acb\u4fee\u6539\u61c9\u7528\u7684 YAML \u6587\u4ef6\uff0c\u4e26\u5c07 `cloud.google.com/gke-windows-os-version` \u7684\u503c\u7531 `2022` \u66f4\u6539\u7232 `2019` \u3002\n- \u5c07 Web \u61c9\u7528\u90e8\u7f72\u5230 GKE \u96c6\u7fa3\uff1a```\nkubectl apply -f $ApplicationYaml\n```\n### \u9a57\u8b49 ASP.NET Web \u61c9\u7528\u662f\u5426\u6b63\u5728\u904b\u884cWeb \u61c9\u7528\u4f7f\u7528 `LoadBalancer` \u670d\u52d9\u5728\u4e92\u806f\u7db2\u4e0a\u516c\u958b\u3002\u60a8\u9700\u8981\u7b49\u5f85 Pod \u548c\u670d\u52d9\u5b8c\u6210\u90e8\u7f72\uff0c\u7136\u5f8c\u624d\u80fd\u700f\u89bd\u5230 Web \u61c9\u7528\u3002\u90e8\u7f72 Pod \u53ef\u80fd\u9700\u8981\u5e7e\u5206\u9418\u6642\u9593\uff0c\u56e0\u7232 Windows Server Core \u5bb9\u5668\u6620\u50cf\u5f88\u5927\uff08Web \u61c9\u7528\u6620\u50cf\u5927\u65bc 7 GB\uff09\uff0c\u4e26\u4e14\u7bc0\u9ede\u4e0b\u8f09\u6620\u50cf\u4e26\u5275\u5efa\u5bb9\u5668\u4e5f\u9700\u8981\u4e00\u4e9b\u6642\u9593\u3002- \u6aa2\u67e5 Pod \u7684\u72c0\u614b\uff1a```\nkubectl get pods --selector=app=gmsa-test-webapp-01\n```\u91cd\u8907\u8a72\u547d\u4ee4\uff0c\u76f4\u5230\u8f38\u51fa\u986f\u793a Pod \u72c0\u614b\u7232 **\u6b63\u5728\u904b\u884c** \uff1a```\nNAME \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 READY \u00a0 \u00a0 STATUS \u00a0 \u00a0RESTARTS \u00a0 AGEgmsa-test-webapp-01-76c6d64975-zrtgq \u00a0 1/1 \u00a0 \u00a0 \u00a0 Running \u00a0 0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a028s\n```\u5982\u679c Pod \u7684\u72c0\u614b\u4ecd\u7232 **\u5f85\u8655\u7406** \u4e26\u4e14\u672a\u66f4\u6539\u7232 **\u6b63\u5728\u5275\u5efa\u5bb9\u5668** \u6216 **\u6b63\u5728\u904b\u884c** \uff0c\u5247 [\u6aa2\u67e5 Windows \u7bc0\u9ede\u7684\u4f86\u6e90\u6620\u50cf](https://cloud.google.com/compute/docs/instances/view-vm-image?hl=zh-cn#viewing_source_image) \uff0c\u78ba\u4fdd\u5b83\u662f Windows Server 2022\u3002\u60a8\u9084\u53ef\u4ee5\u67e5\u770b [\u7248\u672c\u6620\u5c04](https://cloud.google.com/kubernetes-engine/docs/how-to/creating-a-cluster-windows?hl=zh-cn#version_mapping) \u8868\uff0c\u77ad\u89e3 GKE \u7248\u672c\u8207 Windows Server \u7248\u672c\u4e4b\u9593\u7684\u5339\u914d\u95dc\u4fc2\u3002\u5982\u679c\u7248\u672c\u4e0d\u5339\u914d\uff0c\u8acb\u8907\u88fd `Dockerfile-WINDOWS_LTSC2022` \u6587\u4ef6\uff0c\u5728\u65b0\u6587\u4ef6\u4e2d\u8a2d\u7f6e [\u57fa\u790e\u5bb9\u5668\u6620\u50cf](https://hub.docker.com/_/microsoft-dotnet-framework-aspnet/) \u4ee5\u8207\u7bc0\u9ede\u7684 Windows Server \u7248\u672c\u76f8\u5339\u914d\uff0c\u7136\u5f8c\u91cd\u8907 [\u69cb\u5efa\u548c\u90e8\u7f72 ASP.NET Web \u61c9\u7528](#build_and_deploy_the_aspnet_web_application) \u7684\u6b65\u9a5f\u3002\n- \u6aa2\u67e5\u670d\u52d9\u7684\u72c0\u614b\uff1a```\nkubectl get service --selector=app=gmsa-test-webapp-01\n```\u91cd\u8907\u904b\u884c\u8a72\u547d\u4ee4\uff0c\u76f4\u5230\u8f38\u51fa\u986f\u793a\u670d\u52d9\u5177\u6709\u5916\u90e8 IP \u5730\u5740\uff1a```\nNAME     TYPE   CLUSTER-IP EXTERNAL-IP  PORT(S)  AGE\ngmsa-test-webapp-01 LoadBalancer 10.44.2.112 external-ip 80:32233/TCP 17s\n```\n- \u8a18\u4e0b\u8f38\u51fa\u4e2d **external-ip** \u7684\u503c\uff1b\u60a8\u7a0d\u5f8c\u9700\u8981\u7528\u5230\u6b64\u503c\u3002\n### \u5728 ASP.NET Web \u61c9\u7528\u4e2d\u904b\u884c\u521d\u6b65\u6e2c\u8a66Pod \u76ee\u524d\u6b63\u5728\u904b\u884c\uff0c\u53ef\u901a\u904e\u7db2\u7d61\u8ca0\u8f09\u5747\u8861\u5668\u5f9e\u4e92\u806f\u7db2\u9032\u884c\u8a2a\u554f\u3002\u63a5\u4e0b\u4f86\uff0c\u60a8\u5c07\u904b\u884c\u521d\u6b65\u6e2c\u8a66\uff0c\u4ee5\u9a57\u8b49\u5bb9\u5668\u662f\u5426\u5df2\u6210\u529f\u90e8\u7f72\u4ee5\u53ca\u5b83\u662f\u5426\u6709\u6b0a\u4f7f\u7528 gMSA\u3002- \u5728\u700f\u89bd\u5668\u4e2d\uff0c\u8f49\u5230 `http://` `` \u4ee5\u67e5\u770b gMSA \u6e2c\u8a66 Web \u61c9\u7528\u3002\u5c07 `` \u66ff\u63db\u7232\u60a8\u5728\u4e0a\u4e00\u904e\u7a0b\u4e2d\u7372\u5f97\u7684 IP \u5730\u5740\u3002\n- \u6efe\u52d5\u5230 **\u9810\u6aa2\u6aa2\u67e5** (Preflight Checks) \u90e8\u5206\uff0c\u7136\u5f8c\u9ede\u64ca **\u904b\u884c\u9810\u6aa2\u6aa2\u67e5** (Run Preflight Checks) \u6309\u9215\uff0c\u4ee5\u9a57\u8b49\u6240\u6709\u6e2c\u8a66\u662f\u5426\u90fd\u5df2\u901a\u904e\u3002\u5982\u679c\u6e2c\u8a66\u901a\u904e\uff0c\u5247\u8f38\u51fa\u6703\u5982\u4e0b\u6240\u793a\uff1a```\n[PASS] Active Directory RSAT PowerShell Module Installed\n[PASS] IIS Document Root found\n  C:\\inetpub\\wwwroot\\\n[PASS] PowerShell Scripts Folder found\n  C:\\inetpub\\wwwroot\\Powershell\\\n[PASS] Container Diagnostic Script found\n  C:\\inetpub\\wwwroot\\Powershell\\\\containerDiag.ps1\n[PASS] Domain Diagnostic Script found\n  C:\\inetpub\\wwwroot\\Powershell\\\\domainDiag.ps1\n[RES] Result: PASS All checks passed! Please proceed to run the different tests.\n```\n- \u6efe\u52d5\u5230 **\u5bb9\u5668\u4fe1\u606f** \u90e8\u5206\uff0c\u7136\u5f8c\u9ede\u64ca **\u904b\u884c\u8173\u672c** \u6309\u9215\u3002\u9a57\u8b49\u60a8\u662f\u5426\u770b\u5230\u6709\u95dc\u5bb9\u5668\u548c\u7bc0\u9ede\u7684\u4fe1\u606f\uff0c\u4e26\u4e14\u672a\u986f\u793a\u4efb\u4f55\u932f\u8aa4\u3002\n### \u5728 Windows \u5bb9\u5668\u4e2d\u4f7f\u7528 gMSA\u73fe\u5728\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u5728 Web \u61c9\u7528\u4e2d\u904b\u884c\u591a\u9805\u6e2c\u8a66\u4f86\u9a57\u8b49 gMSA \u8a2d\u7f6e\u662f\u5426\u6b63\u5e38\u5de5\u4f5c\u3002\u6bcf\u500b\u6e2c\u8a66\u6703\u5c07 gMSA \u7528\u65bc\u4e0d\u540c\u7684\u7528\u9014\u3002\u5982\u679c\u6240\u6709\u6e2c\u8a66\u90fd\u6210\u529f\uff0c\u5247\u8868\u793a\u60a8\u6b63\u78ba\u914d\u7f6e\u4e86 gMSA\u3002\n- \u6efe\u52d5\u5230 **\u7db2\u57df\u9023\u63a5** \u90e8\u5206\uff0c\u5728 **\u8cec\u865f\u540d** \u6846\u4e2d\u8f38\u5165 gMSA \u7684\u540d\u7a31 ( `WebApp-01` )\uff0c\u7136\u5f8c\u9ede\u64ca **\u904b\u884c\u8173\u672c** \u3002\u7b49\u5f85\u5e7e\u79d2\u9418\uff0c\u8b93\u6e2c\u8a66\u5b8c\u6210\u3002\u8f38\u51fa\u5167\u5bb9\u985e\u4f3c\u5982\u4e0b\uff1a```\n***** C O N T A I N E R D I A G N O S T I C S *****\n[INFO] Starting script execution at 01-05-2021-13:53:11\n[INFO] Using gMSA: WebApp-01\n[PASS] gMSA Account found in Active Directory\n  CN=WebApp01,CN=Managed Service Accounts,DC=corp,DC=example,DC=com\n[PASS] This Container (gmsa-test-webapp01-5bc485b8d5-9lbb7) is running on a GKE Windows Node that is authorized to use WebApp01\n[INFO] Script execution complete at 01-05-2021-13:53:12\n*****  E N D O F D I A G N O S T I C S  *****\n```\u8173\u672c\u4f7f\u7528\u5169\u500b PowerShell cmdlet \u6e2c\u8a66\u5c0d gMSA \u7684\u8a2a\u554f\u6b0a\u9650\uff1a- [Get-ADServiceAccount](https://docs.microsoft.com/powershell/module/activedirectory/get-adserviceaccount) \uff1a\u6b64 cmdlet \u6aa2\u7d22 gMSA \u7684\u76f8\u95dc\u4fe1\u606f\u3002\u5982\u679c\u6b64 cmdlt \u904b\u884c\u6210\u529f\uff0c\u5247\u5bb9\u5668\u6b63\u5728\u4f7f\u7528\u6709\u6548\u7684 gMSA \u904b\u884c\u3002\n- [Test-ADServiceAccount](https://docs.microsoft.com/powershell/module/activedirectory/test-adserviceaccount) \uff1a\u6b64 cmdlet \u6e2c\u8a66\u5b83\u662f\u5426\u53ef\u4ee5\u6aa2\u7d22 gMSA \u6191\u64da\u3002\u5982\u679c cmdlt \u904b\u884c\u6210\u529f\uff0c\u5247\u5bb9\u5668\u6b63\u5728\u88ab\u8a31\u53ef\u8a2a\u554f gMSA \u6191\u64da\u7684 Windows Server \u7bc0\u9ede\u4e2d\u904b\u884c\u3002\n- \u5728\u9801\u9762\u7684\u9802\u90e8\u5c0e\u822a\u6b04\u4e2d\uff0c\u9ede\u64ca **\u767b\u9304** \u3002\n- \u7576\u7cfb\u7d71\u63d0\u793a\u60a8\u8f38\u5165\u6191\u64da\u6642\uff0c\u8acb\u8f38\u5165\u7db2\u57df\u7528\u6236\u540d\u548c\u5bc6\u78bc\u3002\n- \u5982\u679c\u60a8\u770b\u5230\u5305\u542b\u8cec\u865f\u4fe1\u606f\u7684 **\u5b89\u5168** \u9801\u9762\uff0c\u4e14\u7cfb\u7d71\u672a\u63d0\u793a\u60a8\u8f38\u5165\u6191\u64da\uff0c\u5247\u700f\u89bd\u5668\u6703\u4f7f\u7528\u60a8\u7576\u524d\u8eab\u4efd\u8b93\u60a8\u81ea\u52d5\u767b\u9304\u3002\u5728\u60a8\u7d93\u904e\u8eab\u4efd\u9a57\u8b49\u5f8c\uff0c\u60a8\u6703\u770b\u5230 **\u5b89\u5168** \u9801\u9762\u3002\u8acb\u78ba\u4fdd\u770b\u5230\u4ee5\u4e0b\u4e09\u500b\u90e8\u5206\uff1a- **\u7528\u6236\u4fe1\u606f** \uff1a\u986f\u793a\u6240\u4f7f\u7528\u7684\u8eab\u4efd\u9a57\u8b49\u7684\u7528\u6236\u540d\u548c\u985e\u578b\u3002\n- **\u7fa3\u7d44** \uff1a\u986f\u793a\u60a8\u6240\u5c6c\u7684\u7fa3\u7d44\u7684\u5217\u8868\u3002\u7cfb\u7d71\u6703\u5f9e Active Directory \u4e2d\u6aa2\u7d22\u5217\u8868\u4e2d\u7684\u7fa3\u7d44\u540d\u7a31\u3002\n- **\u7528\u6236\u8072\u660e** \uff1a\u986f\u793a\u5728\u767b\u9304\u904e\u7a0b\u4e2d Active Directory \u63d0\u4f9b\u7684\u7528\u6236\u8072\u660e\u7684\u5217\u8868\u3002\u7fa3\u7d44\u6210\u54e1\u8cc7\u683c\u8072\u660e\u986f\u793a Active Directory \u7fa3\u7d44 [SID](https://wikipedia.org/wiki/Security_Identifier) \uff0c\u800c\u4e0d\u662f\u5176\u540d\u7a31\u3002\n\u9664\u4e86\u652f\u6301\u96c6\u6210\u5f0f Windows \u8eab\u4efd\u9a57\u8b49\u4e4b\u5916\uff0cASP.NET Web \u61c9\u7528\u9084\u53ef\u4ee5\u5728\u8abf\u7528\u9060\u7a0b\u670d\u52d9\u5668\u6642\u4f7f\u7528\u5176 gMSA \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u4f7f\u7528 gMSA \u6642\uff0cWeb \u61c9\u7528\u4ee5\u53ca Windows \u5bb9\u5668\u4e2d\u904b\u884c\u7684\u4efb\u4f55\u5176\u4ed6\u61c9\u7528\u90fd\u53ef\u4ee5\u8a2a\u554f\u7db2\u7d61\u4e2d\u9700\u8981 Windows \u8eab\u4efd\u9a57\u8b49\u7684\u8cc7\u6e90\uff0c\u4f8b\u5982 SQL Server \u5be6\u4f8b\u548c\u57fa\u65bc SMB \u7684\u7db2\u7d61\u5171\u4eab\u3002## \u554f\u984c\u6392\u67e5\u5982\u679c\u60a8\u5728\u8a2d\u7f6e\u904e\u7a0b\u4e2d\u6216\u5728\u6e2c\u8a66 Web \u61c9\u7528\u6642\u9047\u5230\u4efb\u4f55\u932f\u8aa4\u6d88\u606f\uff0c\u8acb\u53c3\u95b1\u4ee5\u4e0b\u554f\u984c\u6392\u67e5\u9801\u9762\uff1a- [\u6392\u67e5 GKE \u4e0a\u7684 Windows Server \u554f\u984c](https://cloud.google.com/kubernetes-engine/docs/how-to/creating-a-cluster-windows?hl=zh-cn#troubleshooting) \n- \u6709\u95dc [\u6392\u67e5 Windows Server \u5bb9\u5668\u554f\u984c](https://kubernetes.io/docs/tasks/configure-pod-container/configure-gmsa/#troubleshooting) \u7684 Kubernetes \u6587\u6a94\n- \u6709\u95dc [\u7232 Windows \u5bb9\u5668\u6392\u67e5 gMSA \u554f\u984c](https://docs.microsoft.com/virtualization/windowscontainers/manage-containers/gmsa-troubleshooting) \u7684 Microsoft \u6587\u6a94\n## \u6709\u95dc\u751f\u7522\u61c9\u7528\u7684\u5176\u4ed6\u6ce8\u610f\u4e8b\u9805\u60a8\u9075\u5faa\u7684\u8aaa\u660e\u65e8\u5728\u7232\u672c\u6559\u7a0b\u63d0\u4f9b\u6700\u4f73\u8def\u5f91\u3002\u5c0d\u65bc\u751f\u7522\u74b0\u5883\uff0c\u60a8\u53ef\u80fd\u6703\u5c0d\u67d0\u4e9b\u6d41\u7a0b\u9032\u884c\u66f4\u6539\uff0c\u4ee5\u4f7f\u7d50\u679c\u66f4\u53ef\u9760\uff0c\u5982\u4ee5\u4e0b\u90e8\u5206\u6240\u8ff0\u3002\n### Windows Server \u7bc0\u9ede\u6c60\u6ce8\u610f\u4e8b\u9805\u5982\u679c\u60a8\u8a08\u5283\u90e8\u7f72\u81ea\u5df1\u7684\u61c9\u7528\u4f86\u4f7f\u7528 gMSA\uff0c\u4e26\u4e14\u8a72\u61c9\u7528\u652f\u6301\u5ba2\u6236\u7aef\u6703\u8a71\uff0c\u5247\u6211\u5011\u5efa\u8b70\u60a8\u5728\u7bc0\u9ede\u6c60\u4e2d\u81f3\u5c11\u5275\u5efa\u5169\u500b\u7bc0\u9ede\u3002\u85c9\u52a9\u591a\u500b\u7bc0\u9ede\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u9032\u7a0b\u5916\u6703\u8a71\u5b58\u5132\u4f86\u9a57\u8b49\u61c9\u7528\u662f\u5426\u53ef\u4ee5\u6b63\u78ba\u8655\u7406\u5206\u4f48\u5f0f\u6703\u8a71\u3002\n\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u5275\u5efa\u4e00\u500b Windows Server \u7bc0\u9ede\u6c60\u4f86\u8a17\u7ba1\u60a8\u7684\u61c9\u7528\u3002\u4f46\u5728\u67d0\u4e9b\u60c5\u6cc1\u4e0b\uff0c\u60a8\u53ef\u80fd\u5e0c\u671b\u5728\u96c6\u7fa3\u4e2d\u5275\u5efa\u591a\u500b Windows Server \u7bc0\u9ede\u6c60 - \u4f8b\u5982\uff0c\u4e00\u500b\u4f7f\u7528 HDD \u6c38\u4e45\u6027\u78c1\u76e4\u7684\u7bc0\u9ede\u6c60\u548c\u4e00\u500b\u4f7f\u7528 SSD \u6c38\u4e45\u6027\u78c1\u76e4\u7684\u7bc0\u9ede\u6c60\u3002\u5982\u679c\u60a8\u9700\u8981\u5c07\u61c9\u7528\u90e8\u7f72\u5230\u591a\u500b\u7bc0\u9ede\u6c60\uff0c\u8acb\u5728\u4f7f\u7528 `New-ADServiceAccount` cmdlet [\u5275\u5efa gMSA](#create_the_gmsa) \u6642\uff0c\u5411 `PrincipalsAllowedToRetrieveManagedPassword` \u53c3\u6578\u63d0\u4f9b\u4e00\u7d44 Active Directory \u7fa3\u7d44\u5c0d\u8c61\u3002\n### gMSA \u548c\u670d\u52d9\u4e3b\u9ad4\u540d\u7a31 (SPN) \u6ce8\u610f\u4e8b\u9805\u5982\u679c\u60a8\u7684\u61c9\u7528\u8981\u6c42\u60a8\u4f7f\u7528 Kerberos \u5c0d\u7528\u6236\u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff08\u4f8b\u5982\uff0c\u7232\u4e86\u652f\u6301\u8eab\u4efd\u59d4\u8a17\uff09\uff0c\u5247\u9700\u8981\u4f7f\u7528\u81ea\u5b9a\u7fa9 DNS \u8a2a\u554f\u60a8\u7684\u61c9\u7528\uff0c\u4e26\u4f7f\u7528 [\u670d\u52d9\u4e3b\u9ad4\u540d\u7a31 (SPN)](https://docs.microsoft.com/windows/win32/ad/service-principal-names) \u914d\u7f6e gMSA\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u7684\u8ca0\u8f09\u5747\u8861\u5668\u901a\u904e `https://my-web-app/` \u5728 GKE \u4e0a\u516c\u958b\u61c9\u7528\uff0c\u5247\u60a8\u9700\u8981\u901a\u904e\u4ee5\u4e0b\u65b9\u5f0f\u4e4b\u4e00\u5275\u5efa\u4e00\u500b\u540d\u7232 `HTTP/my-web-app` \u7684 SPN\uff1a- \u5c0d\u65bc\u65b0\u7684 gMSA\uff0c\u8acb\u4f7f\u7528\u6240\u9700\u7684 SPN \u5275\u5efa gMSA\u3002\u4f8b\u5982\uff1a```\nNew-ADServiceAccount -Name $GmsaName `-DNSHostName \"$GmsaName.$AdDomain\" `-PrincipalsAllowedToRetrieveManagedPassword $Groups `-ServicePrincipalNames \"HTTP/my-web-app\", \"HTTP/my-web-app.$AdDomain\"\n```\n- \u5c0d\u65bc\u73fe\u6709 gMSA\uff0c\u8acb\u8abf\u7528 `Set-ADServiceAccount` \u4ee5\u5411 gMSA \u6dfb\u52a0\u6240\u9700\u7684 SPN\u3002\u4f8b\u5982\uff1a```\nSet-ADServiceAccount $GmsaName -ServicePrincipalNames @{Add=\"HTTP/my-web-app\", \"HTTP/my-web-app.$AdDomain\"}\n```\n\u6839\u64da DNS \u914d\u7f6e\uff0c\u60a8\u53ef\u80fd\u9084\u9700\u8981\u7232 `HTTP/www.my-web-app` \u548c `HTTP/www.my-web-app.$AdDomain` \u5275\u5efa SPN\u3002\n\u5c0d\u65bc\u975e HTTP \u5354\u8b70\uff08\u4f8b\u5982\u914d\u7f6e\u4e86 TCP \u7d81\u5b9a\u548c Windows \u8eab\u4efd\u9a57\u8b49\u7684 WCF \u670d\u52d9\uff09\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u5275\u5efa\u5176\u4ed6\u985e\u578b\u7684 SPN\uff0c\u4f8b\u5982 `HOST/` SPN\u3002\n### \u9078\u64c7 IIS \u61c9\u7528\u6c60\u8eab\u4efdASP.NET Web \u61c9\u7528\u5728 IIS Web \u670d\u52d9\u5668\u7684 Windows \u4e2d\u904b\u884c\u3002\u5728 IIS \u4e2d\uff0c\u60a8\u53ef\u4ee5\u914d\u7f6e\u5171\u4eab\u76f8\u540c\u9032\u7a0b\u7684 Web \u61c9\u7528\u7fa3\u7d44\u3002\u6b64\u7fa3\u7d44\u7a31\u7232 [\u61c9\u7528\u6c60](https://docs.microsoft.com/iis/configuration/system.applicationhost/applicationpools/) \u3002\u6bcf\u500b\u61c9\u7528\u6c60\u90fd\u8a17\u7ba1\u5728\u4e00\u500b\u540d\u7232 `w3wp` \u7684\u5c08\u7528\u9032\u7a0b\u4e2d\u3002IIS \u61c9\u7528\u6c60\u63d0\u4f9b\u9032\u7a0b\u914d\u7f6e\uff08\u4e0d\u8ad6\u9032\u7a0b\u662f 32 \u4f4d\u9084\u662f 64 \u4f4d\uff09\uff0c\u4e26\u4e14\u9084\u63d0\u4f9b\u9032\u7a0b\u7684\u8eab\u4efd\u3002\u5728 Windows \u5bb9\u5668\u4e2d\u904b\u884c Web \u61c9\u7528\u6642\uff0c\u8acb\u8a2d\u7f6e\u61c9\u7528\u6c60\u7684\u9032\u7a0b\u8eab\u4efd\u4ee5\u4f7f\u7528\u5167\u7f6e [\u7db2\u7d61\u670d\u52d9](https://docs.microsoft.com/virtualization/windowscontainers/manage-containers/gmsa-configure-app) \u8cec\u865f\u3002\nWindows \u5bb9\u5668\u4e0d\u9700\u8981 IIS \u540c\u6a23\u652f\u6301\u7684\u672c\u5730 [\u61c9\u7528\u6c60\u8eab\u4efd](https://docs.microsoft.com/iis/manage/configuring-security/application-pool-identities) \u8cec\u865f\u3002\u8a72\u61c9\u7528\u6c60\u8eab\u4efd\u8cec\u865f\u7531 IIS \u5275\u5efa\uff0c\u7528\u65bc\u5728\u540c\u4e00 IIS \u5be6\u4f8b\u4e0a\u904b\u884c\u591a\u500b Web \u61c9\u7528\u6642\u5f37\u5236\u57f7\u884c [\u672c\u5730\u5b89\u5168\u908a\u754c](https://docs.microsoft.com/iis/manage/configuring-security/application-pool-identities#securing-resources) \u3002\u5c0d\u65bc Windows \u5bb9\u5668\uff08\u5176\u4e2d\u6bcf\u500b Web \u61c9\u7528\u90fd\u8a17\u7ba1\u5728\u55ae\u7368\u7684\u5bb9\u5668\u4e2d\uff09\uff0c\u7121\u9700\u5728\u5bb9\u5668\u5167\u5275\u5efa\u5b89\u5168\u908a\u754c\uff0c\u56e0\u7232\u5bb9\u5668\u672c\u8eab\u53ef\u63d0\u4f9b\u5b89\u5168\u908a\u754c\u3002\n\u5373\u4f7f\u61c9\u7528\u6c60\u8eab\u4efd\u914d\u7f6e\u7232\u4f7f\u7528\u7db2\u7d61\u670d\u52d9\u8cec\u865f\uff0c\u5982\u679c\u61c9\u7528\u5411\u9700\u8981\u8eab\u4efd\u9a57\u8b49\u7684\u5916\u90e8\u8cc7\u6e90\u767c\u51fa\u8acb\u6c42\uff0c\u61c9\u7528\u4e5f\u6703\u4f7f\u7528\u60a8\u7232 Windows \u5bb9\u5668\u914d\u7f6e\u7684 gMSA \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\n **\u6ce8\u610f** \uff1a\u60a8\u4ecd\u7136\u53ef\u4ee5\u5728 IIS \u4e2d\u5c07\u61c9\u7528\u6c60\u914d\u7f6e\u7232\u4f7f\u7528\u61c9\u7528\u6c60\u8eab\u4efd\u8cec\u865f\uff0c\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u8981\u5728\u540c\u4e00\u5bb9\u5668\u4e2d\u8a17\u7ba1\u591a\u500b Web \u61c9\u7528\u4e26\u4e14\u9700\u8981\u672c\u5730\u5b89\u5168\u908a\u754c\u3002\u5982\u4e0a\u6240\u8ff0\uff0c\u7576 Web \u61c9\u7528\u5411\u5916\u90e8\u7db2\u7d61\u8cc7\u6e90\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u6642\uff0c\u7121\u8ad6\u8eab\u4efd\u8a2d\u7f6e\u7232\u61c9\u7528\u6c60\u8eab\u4efd\u8cec\u865f\u9084\u662f NetworkService \u8cec\u865f\uff0c\u8a72 Web \u61c9\u7528\u90fd\u6703\u4f7f\u7528 gMSA\u3002\n## \u6e05\u9664\u6578\u64da\u7232\u907f\u514d\u56e0\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528\u7684\u8cc7\u6e90\u5c0e\u81f4\u60a8\u7684 Google Cloud \u8cec\u865f\u7522\u751f\u8cbb\u7528\uff0c\u8acb\u522a\u9664\u5305\u542b\u9019\u4e9b\u8cc7\u6e90\u7684\u9805\u76ee\uff0c\u6216\u8005\u4fdd\u7559\u9805\u76ee\u4f46\u522a\u9664\u5404\u500b\u8cc7\u6e90\u3002\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- **\u8b66\u544a** \uff1a\u522a\u9664\u9805\u76ee\u6703\u7522\u751f\u4ee5\u4e0b\u5f71\u97ff- **\u9805\u76ee\u4e2d\u7684\u6240\u6709\u5167\u5bb9\u90fd\u6703\u88ab\u522a\u9664\u3002** \u5982\u679c\u60a8\u5c07\u73fe\u6709\u9805\u76ee\u7528\u65bc\u672c\u6587\u6a94\u4e2d\u7684\u4efb\u52d9\uff0c\u5247\u522a\u9664\u8a72\u9805\u76ee\u5f8c\uff0c\u9084\u5c07\u522a\u9664\u60a8\u5df2\u5728\u8a72\u9805\u76ee\u4e2d\u5b8c\u6210\u7684\u4efb\u4f55\u5176\u4ed6\u5de5\u4f5c\u3002\n- **\u81ea\u5b9a\u7fa9\u9805\u76ee ID \u4e1f\u5931\u3002** \u5275\u5efa\u6b64\u9805\u76ee\u6642\uff0c\u60a8\u53ef\u80fd\u5275\u5efa\u4e86\u8981\u5728\u5c07\u4f86\u4f7f\u7528\u7684\u81ea\u5b9a\u7fa9\u9805\u76ee ID\u3002\u8981\u4fdd\u7559\u4f7f\u7528\u8a72\u9805\u76ee ID \u7684\u7db2\u5740\uff08\u4f8b\u5982`appspot.com`\u7db2\u5740\uff09\uff0c\u8acb\u522a\u9664\u9805\u76ee\u5167\u7684\u6240\u9078\u8cc7\u6e90\uff0c\u800c\u4e0d\u662f\u522a\u9664\u6574\u500b\u9805\u76ee\u3002\n\u5982\u679c\u60a8\u6253\u7b97\u63a2\u7d22\u591a\u500b\u67b6\u69cb\u3001\u6559\u7a0b\u6216\u5feb\u901f\u5165\u9580\uff0c\u5247\u91cd\u8907\u4f7f\u7528\u9805\u76ee\u53ef\u4ee5\u5e6b\u52a9\u60a8\u907f\u514d\u8d85\u51fa\u9805\u76ee\u914d\u984d\u9650\u5236\u3002\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u9032\u5165 **\u7ba1\u7406\u8cc7\u6e90** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u7ba1\u7406\u8cc7\u6e90\u201d](https://console.cloud.google.com/iam-admin/projects?hl=zh-cn) \n- \u5728\u9805\u76ee\u5217\u8868\u4e2d\uff0c\u9078\u64c7\u8981\u522a\u9664\u7684\u9805\u76ee\uff0c\u7136\u5f8c\u9ede\u64ca **\u522a\u9664** \u3002\n- \u5728\u5c0d\u8a71\u6846\u4e2d\u8f38\u5165\u9805\u76ee ID\uff0c\u7136\u5f8c\u9ede\u64ca **\u95dc\u9589** \u4ee5\u522a\u9664\u9805\u76ee\u3002\n### \u9010\u500b\u79fb\u9664\u8cc7\u6e90\u5982\u679c\u60a8\u5e0c\u671b\u4fdd\u7559 Google Cloud \u9805\u76ee\uff0c\u4f46\u4e0d\u60f3\u522a\u9664\u7232\u672c\u6559\u7a0b\u5275\u5efa\u7684 Google Cloud \u8cc7\u6e90\uff0c\u5247\u53ef\u4ee5\u9010\u500b\u79fb\u9664\u9019\u4e9b\u8cc7\u6e90\u3002\n- \u9023\u63a5\u5230\u958b\u767c\u865b\u64ec\u6a5f\uff0c\u7136\u5f8c\u4ee5\u5c0d Active Directory \u57df\u64c1\u6709\u7ba1\u7406\u54e1\u6b0a\u9650\u7684\u7528\u6236\u8eab\u4efd\u767b\u9304\u3002\n- \u5728 `gmsa-dev-vm` \u865b\u64ec\u6a5f\u4e2d\uff0c\u5982\u679c PowerShell \u5c1a\u672a\u6253\u958b\uff0c\u8acb\u5c07\u5176\u6253\u958b\uff1a```\nPowerShell\n```\n- \u522a\u9664 gMSA\uff1a```\nRemove-ADServiceAccount -Identity \"WebApp-01\" -Confirm:$false\n```\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u6fc0\u6d3b Cloud Shell\u3002 [\u6fc0\u6d3b Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn) \n- \u521d\u59cb\u5316 `gcloud` \u74b0\u5883\uff1a```\ngcloud config set project PROJECT-IDgcloud config set compute/zone ZONE-NAMEgcloud config set artifacts/location LOCATION\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u60a8\u7684 Google Cloud \u9805\u76ee ID\u3002\n- ``\uff1a\u60a8\u5728\u5176\u4e2d\u90e8\u7f72 GKE \u96c6\u7fa3\u548c\u958b\u767c\u865b\u64ec\u6a5f\u7684\u53ef\u7528\u5340\u3002\n- ``\uff1a\u60a8\u5728\u5176\u4e2d\u90e8\u7f72 Artifact Registry \u4ee3\u78bc\u5eab\u7684\u5340\u57df\u3002\n- \u522a\u9664\u958b\u767c\u865b\u64ec\u6a5f\uff1a```\ngcloud compute instances delete gmsa-dev-vm --quiet\n```\n- \u522a\u9664\u670d\u52d9\u8cec\u865f\uff1a```\ngcloud iam service-accounts delete dev-vm@$GOOGLE_CLOUD_PROJECT.iam.gserviceaccount.com --quiet\n```\n- \u522a\u9664 GKE \u96c6\u7fa3\uff1a```\ngcloud container clusters delete cluster-1 --quiet\n```\n- \u5982\u679c\u60a8\u7232 Active Directory \u63a7\u5236\u5668\u5275\u5efa\u4e86\u9632\u706b\u7246\u898f\u5247\uff0c\u8acb\u5c07\u5176\u522a\u9664\uff1a```\ngcloud compute firewall-rules delete allow-gke-pods-to-ad --quiet\n```\n- \u522a\u9664 Artifact Registry Docker \u4ee3\u78bc\u5eab\uff1a```\ngcloud artifacts repositories delete windows-container-images --quiet\n```\n\u7232\u5b8c\u6210\u522a\u9664\uff0c\u8acb\u6309\u7167 [\u7232\u865b\u64ec\u6a5f\u914d\u7f6e Active Directory \u4ee5\u81ea\u52d5\u52a0\u5165\u7db2\u57df](https://cloud.google.com/architecture/configuring-active-directory-for-vms-to-automatically-join-the-domain?hl=zh-cn#clean-up) \u4e2d\u7684\u6e05\u7406\u6b65\u9a5f\u9032\u884c\u64cd\u4f5c\u3002## \u5f8c\u7e8c\u6b65\u9a5f\n- \u77ad\u89e3 [GKE \u4e0a\u7684 Windows Server \u5bb9\u5668](https://cloud.google.com/kubernetes-engine/docs/concepts/windows-server-gke?hl=zh-cn) \u3002\n- \u77ad\u89e3\u5982\u4f55 [\u4f7f\u7528 Windows Server \u7bc0\u9ede\u6c60\u5275\u5efa GKE \u96c6\u7fa3](https://cloud.google.com/kubernetes-engine/docs/how-to/creating-a-cluster-windows?hl=zh-cn) \u3002\n- \u77ad\u89e3 [\u90e8\u7f72 Windows Server \u61c9\u7528](https://cloud.google.com/kubernetes-engine/docs/how-to/deploying-windows-app?hl=zh-cn) \u7684\u5176\u4ed6\u65b9\u6cd5\u3002\n- \u67e5\u770b\u6211\u5011\u7684 [\u5728 Google Cloud \u4e0a\u90e8\u7f72 Active Directory \u8cc7\u6e90\u6797\u7684\u6700\u4f73\u505a\u6cd5](https://cloud.google.com/compute/docs/instances/windows/best-practices?hl=zh-cn) \u3002\n- \u5728 [GitHub](https://github.com/GoogleCloudPlatform/gke-aspnet-gmsa/tree/master/dotnetdemoappMVC/Powershell) \u4e0a\u63a2\u7d22 ASP.NET Web \u61c9\u7528\u4f7f\u7528\u7684\u6e2c\u8a66\u8173\u672c\u3002", "guide": "Google Kubernetes Engine (GKE)"}