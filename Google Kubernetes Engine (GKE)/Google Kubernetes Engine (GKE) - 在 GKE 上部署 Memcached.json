{"title": "Google Kubernetes Engine (GKE) - \u5728 GKE \u4e0a\u90e8\u7f72 Memcached", "url": "https://cloud.google.com/kubernetes-engine/docs/tutorials/deploying-memcached-on-kubernetes-engine?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - \u5728 GKE \u4e0a\u90e8\u7f72 Memcached\n\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u5b78\u7fd2\u5982\u4f55\u4f7f\u7528 [Kubernetes](https://kubernetes.io/) \u3001 [Helm](https://helm.sh) \u548c [Mcrouter](https://github.com/facebook/mcrouter) \u5728 Google Kubernetes Engine (GKE) \u4e0a\u90e8\u7f72\u5206\u4f48\u5f0f [Memcached](https://memcached.org/) \u670d\u52d9\u5668\u96c6\u7fa3\u3002 Memcached \u662f\u4e00\u7a2e\u6d41\u884c\u7684\u958b\u6e90\u3001\u591a\u7528\u9014\u7de9\u5b58\u7cfb\u7d71\u3002 \u5b83\u901a\u5e38\u7528\u4f5c\u5e38\u7528\u6578\u64da\u7684\u81e8\u6642\u5b58\u5132\uff0c\u4ee5\u52a0\u901f Web \u61c9\u7528\u7684\u901f\u5ea6\u4e26\u6e1b\u8f15\u6578\u64da\u5eab\u8ca0\u8f09\u3002", "content": "## Memcached \u7684\u7279\u9edeMemcached \u6709\u5169\u5927\u8a2d\u8a08\u76ee\u6a19\uff1a- **\u7c21\u55ae\u6027** \uff1aMemcached \u529f\u80fd\u985e\u4f3c\u65bc\u4e00\u500b\u5927\u578b\u7684 [\u54c8\u5e0c\u8868](https://wikipedia.org/wiki/Hash_table) \uff0c\u4e26\u4e14\u6703\u63d0\u4f9b\u4e00\u500b\u7c21\u55ae\u7684 API \u4ee5\u6309\u7167\u9375\u4f86\u5b58\u5132\u548c\u6aa2\u7d22\u4efb\u610f\u5f62\u72c0\u7684\u5c0d\u8c61\u3002\n- **\u901f\u5ea6** \uff1aMemcached \u5c08\u9580\u5728\u96a8\u6a5f\u5b58\u53d6\u5b58\u5132\u5668 (RAM) \u4e0a\u4fdd\u5b58\u7de9\u5b58\u6578\u64da\uff0c\u5f9e\u800c\u5be6\u73fe\u6975\u5feb\u901f\u6578\u64da\u8a2a\u554f\u3002\nMemcached \u662f\u4e00\u500b\u5206\u4f48\u5f0f\u7cfb\u7d71\uff0c\u53ef\u8b93\u5176\u54c8\u5e0c\u8868\u7684\u5bb9\u91cf\u5728\u670d\u52d9\u5668\u6c60\u4e2d\u6a6b\u5411\u64f4\u7e2e\u3002\u7531\u65bc\u6bcf\u81fa Memcached \u670d\u52d9\u5668\u90fd\u5728\u8207\u6c60\u4e2d\u7684\u5176\u4ed6\u670d\u52d9\u5668\u5b8c\u5168\u9694\u96e2\u7684\u74b0\u5883\u4e2d\u904b\u884c\uff0c \u56e0\u6b64\uff0c\u670d\u52d9\u5668\u4e4b\u9593\u7684\u8def\u7531\u548c\u8ca0\u8f09\u5e73\u8861\u5fc5\u9808\u5728\u5ba2\u6236\u7aef\u5c64\u7d1a\u57f7\u884c\u3002\u6b64\u5916\uff0cMemcached \u5ba2\u6236\u7aef\u4f7f\u7528 [\u4e00\u81f4\u7684\u54c8\u5e0c\u6280\u8853](https://wikipedia.org/wiki/Consistent_hashing) \u67b6\u69cb\u76f8\u61c9\u5730\u9078\u64c7\u76ee\u6a19\u670d\u52d9\u5668\u3002\u6b64\u67b6\u69cb\u4fdd\u8b49\u53ef\u6eff\u8db3\u4ee5\u4e0b\u689d\u4ef6\uff1a- \u59cb\u7d42\u7232\u540c\u4e00\u500b\u9375\u9078\u64c7\u540c\u4e00\u81fa\u670d\u52d9\u5668\u3002\n- \u5728\u670d\u52d9\u5668\u4e4b\u9593\u4fdd\u6301\u5167\u5b58\u4f7f\u7528\u91cf\u7684\u5e73\u8861\u3002\n- \u670d\u52d9\u5668\u6c60\u7e2e\u5c0f\u6216\u64f4\u5927\u6642\uff0c\u50c5\u9700\u91cd\u5b9a\u4f4d\u6700\u5c11\u6578\u91cf\u7684\u9375\u3002\n\u4e0b\u5716\u6982\u62ec\u8aaa\u660e\u4e86 Memcached \u5ba2\u6236\u7aef\u8207\u5206\u4f48\u5f0f Memcached \u670d\u52d9\u5668\u6c60\u4e4b\u9593\u7684\u4ea4\u4e92\u3002## \u76ee\u6a19\n- \u77ad\u89e3 Memcached \u7684\u5206\u4f48\u5f0f\u67b6\u69cb\u7684\u4e00\u4e9b\u7279\u9ede\u3002\n- \u4f7f\u7528 Kubernetes \u548c Helm \u5c07 Memcached \u670d\u52d9\u90e8\u7f72\u81f3 GKE\u3002\n- \u90e8\u7f72\u958b\u6e90 Memcached \u4ee3\u7406 Mcrouter\uff0c\u63d0\u9ad8\u7cfb\u7d71\u7684\u6027\u80fd\u3002\n## \u8cbb\u7528\nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728\u672c\u6587\u6a94\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Google Cloud \u7684\u4ee5\u4e0b\u6536\u8cbb\u7d44\u4ef6\uff1a- Compute Engine\n\u60a8\u53ef\u4f7f\u7528 [\u50f9\u683c\u8a08\u7b97\u5668](https://cloud.google.com/products/calculator?hl=zh-cn) \u6839\u64da\u60a8\u7684\u9810\u8a08\u4f7f\u7528\u60c5\u6cc1\u4f86\u4f30\u7b97\u8cbb\u7528\u3002 \n## \u6e96\u5099\u5de5\u4f5c\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- \u5553\u52d5 Cloud Shell \u5be6\u4f8b\u3002 [\u6253\u958b Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn) \n## \u90e8\u7f72 Memcached \u670d\u52d9\u5c07 Memcached \u670d\u52d9\u90e8\u7f72\u81f3 GKE \u7684\u4e00\u500b\u7c21\u55ae\u65b9\u6cd5\u662f\u4f7f\u7528 [Helm](https://helm.sh) \u5716\u8868\u3002\u8981\u7e7c\u7e8c\u9032\u884c\u90e8\u7f72\uff0c\u8acb\u5728 Cloud Shell \u4e2d\u57f7\u884c\u4ee5\u4e0b\u6b65\u9a5f\uff1a- \u5275\u5efa\u4e00\u500b\u65b0\u7684\u6709\u4e09\u500b\u7bc0\u9ede\u7684 GKE \u96c6\u7fa3\uff1a```\ngcloud container clusters create demo-cluster --num-nodes 3 --zone us-central1-f\n``` **\u6ce8\u610f** \uff1a\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u6b64\u8655\u6307\u5b9a\u7684\u96c6\u7fa3\u5730\u5340\u662f\u4efb\u610f\u7684\u3002\u60a8\u53ef\u4ee5\u5f9e [\u53ef\u7528\u5730\u5340](https://cloud.google.com/compute/docs/regions-zones/regions-zones?hl=zh-cn#available) \u4e2d\u7232\u96c6\u7fa3\u9078\u64c7\u53e6\u4e00\u500b\u5730\u5340\u3002\n- \u4e0b\u8f09 `helm` \u4e8c\u9032\u5236\u5b58\u6a94\u6587\u4ef6\uff1a```\nHELM_VERSION=3.7.1cd ~wget https://get.helm.sh/helm-v${HELM_VERSION}-linux-amd64.tar.gz\n```\n- \u5c07\u5b58\u6a94\u6587\u4ef6\u89e3\u58d3\u7e2e\u5230\u672c\u5730\u7cfb\u7d71\uff1a```\nmkdir helm-v${HELM_VERSION}tar zxfv helm-v${HELM_VERSION}-linux-amd64.tar.gz -C helm-v${HELM_VERSION}\n```\n- \u5c07 `helm` \u4e8c\u9032\u5236\u6587\u4ef6\u7684\u76ee\u9304\u6dfb\u52a0\u5230 `PATH` \u74b0\u5883\u8b8a\u91cf\u4e2d\uff1a```\nexport PATH=\"$(echo ~)/helm-v${HELM_VERSION}/linux-amd64:$PATH\"\n```\u4f7f\u7528\u6b64\u547d\u4ee4\uff0c\u53ef\u5728\u7576\u524d Cloud Shell \u6703\u8a71\u671f\u9593\u8b93 `helm` \u4e8c\u9032\u5236\u8b8a\u5f97\u53ef\u6aa2\u6e2c\u5230\u3002\u8981\u4f7f\u6b64\u914d\u7f6e\u5b58\u5728\u65bc\u591a\u500b\u6703\u8a71\u4e2d\uff0c\u8acb\u5c07\u8a72\u547d\u4ee4\u6dfb\u52a0\u5230 Cloud Shell \u7528\u6236\u7684 `~/.bashrc` \u6587\u4ef6\u4e2d\u3002\n- \u5b89\u88dd\u5177\u6709\u9ad8\u53ef\u7528\u6027\u67b6\u69cb\u7684\u65b0 [Memcached Helm \u5716\u8868](https://artifacthub.io/packages/helm/bitnami/memcached) \u7248\u672c\uff1a```\nhelm repo add bitnami https://charts.bitnami.com/bitnamihelm install mycache bitnami/memcached --set architecture=\"high-availability\" --set autoscaling.enabled=\"true\"\n```Memcached Helm \u5716\u8868\u4f7f\u7528 [StatefulSet \u63a7\u5236\u5668](https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/) \u3002 \u9019\u6a23\u505a\u7684\u597d\u8655\u4e4b\u4e00\u662f pod \u7684\u540d\u7a31\u8b8a\u5f97\u6709\u689d\u7406\u3001\u53ef\u9810\u6e2c\u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u540d\u7a31\u662f `mycache-memcached-{0..2}` \u3002\u9019\u7a2e\u6392\u5e8f\u4f7f Memcached \u5ba2\u6236\u7aef\u5f15\u7528\u670d\u52d9\u5668\u8b8a\u5f97\u66f4\u5bb9\u6613\u3002\n- \u8981\u67e5\u770b\u6b63\u5728\u904b\u884c\u7684 pod\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\nkubectl get pods\n```Google Cloud Console \u8f38\u51fa\u5982\u4e0b\u6240\u793a\uff1a```\nNAME     READY  STATUS RESTARTS AGE\nmycache-memcached-0 1/1  Running 0   45s\nmycache-memcached-1 1/1  Running 0   35s\nmycache-memcached-2 1/1  Running 0   25s\n``` **\u6ce8\u610f** \uff1a\u4e0a\u4e00\u6b65\u4e2d\u7684\u5b89\u88dd\u547d\u4ee4\u9700\u8981\u4e00\u4e9b\u6642\u9593\u624d\u80fd\u5b8c\u6210\u3002\u6240\u6709\u4e09\u500b pod \u90fd\u6e96\u5099\u5c31\u7dd2\u4e26\u958b\u59cb\u904b\u884c\u4e4b\u524d\uff0c\u53ef\u80fd\u9700\u8981\u7b49\u5f85\u5927\u7d04\u4e00\u5206\u9418\u6642\u9593\u3002\n## \u767c\u73fe Memcached \u670d\u52d9\u7aef\u9edeMemcached Helm \u5716\u8868\u4f7f\u7528 [\u7121\u982d\u670d\u52d9](https://kubernetes.io/docs/concepts/services-networking/service/#headless-services) \u3002 \u7121\u982d\u670d\u52d9\u516c\u958b\u5176\u6240\u6709 pod \u7684 IP \u5730\u5740\uff0c\u4ee5\u4fbf\u5b83\u5011\u53ef\u4ee5\u4e00\u500b\u4e00\u500b\u5730\u88ab\u767c\u73fe\u3002- \u9a57\u8b49\u6240\u90e8\u7f72\u7684\u670d\u52d9\u662f\u5426\u7121\u982d\uff1a```\nkubectl get service mycache-memcached -o jsonpath=\"{.spec.clusterIP}\"\n```\u8f38\u51fa `None` \u78ba\u8a8d\u8a72\u670d\u52d9\u6c92\u6709 `clusterIP` \uff0c\u56e0\u6b64\u662f\u7121\u982d\u7684\u3002\u670d\u52d9\u7232\u4ee5\u4e0b\u683c\u5f0f\u7684\u4e3b\u6a5f\u540d\u5275\u5efa DNS \u8a18\u9304\uff1a```\n[SERVICE_NAME].[NAMESPACE].svc.cluster.local\n```\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u670d\u52d9\u540d\u7a31\u7232 `mycache-memcached` \u3002\u7531\u65bc\u547d\u540d\u7a7a\u9593\u672a\u660e\u78ba\u5b9a\u7fa9\uff0c\u56e0\u6b64\u4f7f\u7528\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\uff0c\u5b8c\u6574\u7684\u4e3b\u6a5f\u540d\u7232 `mycache-memcached.default.svc.cluster.local` \u3002\u6b64\u4e3b\u6a5f\u540d\u6703\u89e3\u6790\u7232\u670d\u52d9\u6240\u516c\u958b\u7684\u4e09\u500b pod \u7684\u4e00\u7d44 IP \u5730\u5740\u548c\u57df\u540d\u3002\u5982\u679c\u5c07\u4f86\u67d0\u4e9b pod \u88ab\u6dfb\u52a0\u5230\u6c60\u4e2d\uff0c\u6216\u8005\u820a\u7684 pod \u88ab\u79fb\u9664\uff0c\u5247 [kube-dns](https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/) \u6703\u81ea\u52d5\u66f4\u65b0 DNS \u8a18\u9304\u3002\u5ba2\u6236\u7aef\u6703\u767c\u73fe Memcached \u670d\u52d9\u7aef\u9ede\uff0c\u5982\u5f8c\u7e8c\u6b65\u9a5f\u6240\u8ff0\u3002\n- \u6aa2\u7d22\u7aef\u9ede\u7684 IP \u5730\u5740\uff1a```\nkubectl get endpoints mycache-memcached\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nNAME    ENDPOINTS           AGE\nmycache-memcached 10.36.0.32:11211,10.36.0.33:11211,10.36.1.25:11211 3m\n```\u8acb\u6ce8\u610f\uff0c\u6bcf\u500b Memcached \u7684 pod \u90fd\u6709\u4e00\u500b\u7368\u7acb\u7684 IP \u5730\u5740\uff0c\u5206\u5225\u7232 `10.36.0.32` \u3001 `10.36.0.33` \u548c `10.36.1.25` \u3002\u5c0d\u65bc\u60a8\u81ea\u5df1\u7684\u670d\u52d9\u5668\u5be6\u4f8b\uff0c\u9019\u4e9b IP \u5730\u5740\u53ef\u80fd\u4e0d\u540c\u3002\u6bcf\u500b pod \u90fd\u6703\u5075\u807d Memcached \u7684\u9ed8\u8a8d\u7aef\u53e3 `11211` \u3002\n- \u5982\u679c\u8981\u4f7f\u7528\u4e0d\u540c\u7684\u65b9\u6cd5\u5b8c\u6210\u7b2c 2 \u6b65\u64cd\u4f5c\uff0c\u53ef\u4f7f\u7528 Python \u7b49\u7de8\u7a0b\u8a9e\u8a00\u57f7\u884c DNS \u6aa2\u67e5\uff1a- \u5553\u52d5\u96c6\u7fa3\u5167\u7684 Python \u4ea4\u4e92\u5f0f\u63a7\u5236\u6aaf\uff1a```\nkubectl run -it --rm python --image=python:3.10-alpine --restart=Never python\n```\n- \u5728 Python \u63a7\u5236\u6aaf\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\nimport socketprint(socket.gethostbyname_ex('mycache-memcached.default.svc.cluster.local'))exit()\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\n('mycache-memcached.default.svc.cluster.local', ['mycache-memcached.default.svc.cluster.local'], ['10.36.0.32', '10.36.0.33', '10.36.1.25'])\n```\n- \u901a\u904e\u6253\u958b\u8207\u7aef\u53e3 `11211` \u4e0a\u6b63\u5728\u904b\u884c\u7684\u4e00\u500b Memcached \u670d\u52d9\u5668\u5efa\u7acb\u7684 `telnet` \u6703\u8a71\uff0c\u6e2c\u8a66\u90e8\u7f72\uff1a```\nkubectl run -it --rm busybox --image=busybox:1.33 --restart=Never telnet mycache-memcached-0.mycache-memcached.default.svc.cluster.local 11211\n```\u770b\u5230 `telnet` \u63d0\u793a\u5f8c\uff0c\u4f7f\u7528 [Memcached ASCII \u5354\u8b70](https://github.com/memcached/memcached/blob/master/doc/protocol.txt) \u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\nset mykey 0 0 5\nhello\nget mykey\nquit\n```\u751f\u6210\u7684\u8f38\u51fa\u4ee5\u7c97\u9ad4\u986f\u793a\uff1a```\nset mykey 0 0 5\nhello\nSTORED\nget mykey\nVALUE mykey 0 5\nhello\nEND\nquit\n```\n### \u5be6\u73fe\u670d\u52d9\u767c\u73fe\u908f\u8f2f\u73fe\u5728\uff0c\u60a8\u53ef\u4ee5\u5be6\u73fe\u4e0b\u5716\u4e2d\u6240\u793a\u7684\u57fa\u672c\u670d\u52d9\u767c\u73fe\u908f\u8f2f\u3002\u6982\u62ec\u4f86\u8b1b\uff0c\u670d\u52d9\u767c\u73fe\u908f\u8f2f\u5305\u62ec\u4ee5\u4e0b\u6b65\u9a5f\uff1a- \u61c9\u7528\u7232`mycache-memcached.default.svc.cluster.local`\u7684 DNS \u8a18\u9304\u67e5\u8a62`kube-dns`\u3002\n- \u61c9\u7528\u6aa2\u7d22\u8207\u8a72\u8a18\u9304\u95dc\u806f\u7684 IP \u5730\u5740\u3002\n- \u61c9\u7528\u5be6\u4f8b\u5316\u65b0\u7684 Memcached \u5ba2\u6236\u7aef\uff0c\u4f75\u7232\u5176\u63d0\u4f9b\u6240\u6aa2\u7d22\u5230\u7684 IP \u5730\u5740\u3002\n- Memcached \u5ba2\u6236\u7aef\u7684\u96c6\u6210\u8ca0\u8f09\u5e73\u8861\u5668\u9023\u63a5\u5230\u6307\u5b9a IP \u5730\u5740\u4e0a\u7684 Memcached \u670d\u52d9\u5668\u3002\n\u73fe\u5728\uff0c\u60a8\u53ef\u4f7f\u7528 Python \u5be6\u73fe\u6b64\u670d\u52d9\u767c\u73fe\u908f\u8f2f\uff1a- \u5728\u60a8\u7684\u96c6\u7fa3\u4e2d\u90e8\u7f72\u65b0\u7684\u5df2\u5553\u7528 Python \u7684 pod\uff0c\u4e26\u5728\u8a72 pod \u4e2d\u958b\u5553 shell \u6703\u8a71\uff1a```\nkubectl run -it --rm python --image=python:3.10-alpine --restart=Never sh\n```\n- \u5b89\u88dd [pymemcache](https://pymemcache.readthedocs.io) \u5eab\uff1a```\npip install pymemcache\n```\n- \u901a\u904e\u904b\u884c `python` \u547d\u4ee4\u5553\u52d5 Python \u4ea4\u4e92\u5f0f\u63a7\u5236\u6aaf\u3002\n- \u5728 Python \u63a7\u5236\u6aaf\u4e2d\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\nimport socketfrom pymemcache.client.hash import HashClient_, _, ips = socket.gethostbyname_ex('mycache-memcached.default.svc.cluster.local')servers = [(ip, 11211) for ip in ips]client = HashClient(servers, use_pooling=True)client.set('mykey', 'hello')client.get('mykey')\n```\u8f38\u51fa\u5982\u4e0b\u6240\u793a\uff1a```\nb'hello'\n````b` \u524d\u7db4\u8868\u793a [\u5b57\u7bc0\u5b57\u9762\u91cf](https://docs.python.org/3/reference/lexical_analysis.html#string-and-bytes-literals) \uff0c\u5b57\u7bc0\u5b57\u9762\u91cf\u662f Memcached \u5b58\u5132\u6578\u64da\u6240\u63a1\u7528\u7684\u683c\u5f0f\u3002\n- \u9000\u51fa Python \u63a7\u5236\u6aaf\uff1a```\nexit()\n```\n- \u6309 `Control` + `D` \u9000\u51fa pod \u7684 shell \u6703\u8a71\u3002\n## \u5553\u7528\u9023\u63a5\u6c60\u96a8\u7740\u7de9\u5b58\u9700\u6c42\u7684\u589e\u9577\uff0c\u4ee5\u53ca\u6c60\u64f4\u5c55\u5230\u6578\u5341\u3001\u6578\u767e\u6216\u6578\u5343\u500b Memcached \u670d\u52d9\u5668\uff0c\u60a8\u53ef\u80fd\u6703\u9047\u5230\u4e00\u4e9b\u9650\u5236\u3002\u7279\u5225\u662f\uff0c\u5927\u91cf\u4f86\u81ea Memcached \u5ba2\u6236\u7aef\u7684\u6253\u958b\u9023\u63a5\u53ef\u80fd\u6703\u4f7f\u670d\u52d9\u5668\u8ca0\u8f09\u904e\u91cd\uff0c\u5982\u4e0b\u5716\u6240\u793a\u3002\u8981\u6e1b\u5c11\u6253\u958b\u9023\u63a5\u6578\uff0c\u60a8\u5fc5\u9808\u5f15\u5165\u4ee3\u7406\u4f86\u5553\u7528\u9023\u63a5\u6c60\uff0c\u5982\u4e0b\u5716\u6240\u793a\u3002 [Mcrouter](https://github.com/facebook/mcrouter) \uff08\u767c\u97f3\u7232\u201cmick router\u201d\uff09\u662f\u4e00\u500b\u529f\u80fd\u5f37\u5927\u7684\u958b\u6e90 Memcached \u4ee3\u7406\uff0c\u53ef\u5553\u7528\u9023\u63a5\u6c60\u3002\u96c6\u6210 Mcrouter \u662f\u7121\u7e2b\u7684\uff0c\u56e0\u7232\u5b83\u4f7f\u7528\u6a19\u6e96\u7684 Memcached ASCII \u5354\u8b70\u3002\u5c0d\u65bc Memcached \u5ba2\u6236\u7aef\uff0cMcrouter \u6703\u50cf\u4e00\u500b\u6b63\u5e38\u7684 Memcached \u670d\u52d9\u5668\u904b\u884c\u3002\u5c0d\u65bc Memcached \u670d\u52d9\u5668\uff0cMcrouter \u6703\u50cf\u4e00\u500b\u6b63\u5e38\u7684 Memcached \u5ba2\u6236\u7aef\u904b\u884c\u3002\n\u8981\u90e8\u7f72 Mcrouter\uff0c\u8acb\u5728 Cloud Shell \u4e2d\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u3002- \u522a\u9664\u4ee5\u524d\u5b89\u88dd\u7684 `mycache` Helm \u5716\u8868\u7248\u672c\uff1a```\nhelm delete mycache\n```\n- \u901a\u904e\u5b89\u88dd\u65b0\u7684 [Mcrouter Helm \u5716\u8868](https://github.com/kubernetes/charts/tree/master/stable/mcrouter) \u7248\u672c\uff0c\u90e8\u7f72\u65b0\u7684 Memcached pod \u548c Mcrouter pod\uff1a```\nhelm repo add stable https://charts.helm.sh/stablehelm install mycache stable/mcrouter --set memcached.replicaCount=3\n```\u73fe\u5728\uff0c\u4ee3\u7406 pod \u53ef\u63a5\u53d7\u4f86\u81ea\u5ba2\u6236\u7aef\u61c9\u7528\u7684\u8acb\u6c42\u3002\n- \u901a\u904e\u9023\u63a5\u5230\u5176\u4e2d\u4e00\u500b\u4ee3\u7406 pod\uff0c\u6e2c\u8a66\u6b64\u8a2d\u7f6e\u3002\u5728 Mcrouter \u7684\u9ed8\u8a8d\u7aef\u53e3 `5000` \u4e0a\u4f7f\u7528 `telnet` \u547d\u4ee4\u3002```\nMCROUTER_POD_IP=$(kubectl get pods -l app=mycache-mcrouter -o jsonpath=\"{.items[0].status.podIP}\")kubectl run -it --rm busybox --image=busybox:1.33 --restart=Never telnet $MCROUTER_POD_IP 5000\n```\u770b\u5230 `telnet` \u63d0\u793a\u5f8c\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\nset anotherkey 0 0 15\nMcrouter is fun\nget anotherkey\nquit\n```\u9019\u4e9b\u547d\u4ee4\u8a2d\u7f6e\u4e26\u56de\u986f\u60a8\u7684\u9375\u503c\u3002\n\u73fe\u5728\uff0c\u60a8\u5c31\u90e8\u7f72\u4e86\u4e00\u500b\u5553\u7528\u9023\u63a5\u6c60\u7684\u4ee3\u7406\u3002## \u964d\u4f4e\u5ef6\u6642\u8981\u63d0\u9ad8\u5f48\u6027\uff0c\u5e38\u898b\u505a\u6cd5\u662f\u4f7f\u7528\u5e36\u6709\u591a\u500b\u7bc0\u9ede\u7684\u96c6\u7fa3\u3002\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u4f7f\u7528\u4e86\u5e36\u6709\u4e09\u500b\u7bc0\u9ede\u7684\u96c6\u7fa3\u3002\u4e0d\u904e\uff0c\u4f7f\u7528\u591a\u500b\u7bc0\u9ede\u9084\u6703\u5e36\u4f86\u56e0\u7bc0\u9ede\u4e4b\u9593\u7db2\u7d61\u6d41\u91cf\u8f03\u5927\u800c\u5f15\u8d77\u7684\u5ef6\u9072\u6642\u9593\u589e\u52a0\u7684\u98a8\u96aa\u3002\n### \u4e26\u7f6e\u4ee3\u7406 pod\u60a8\u53ef\u4ee5\u901a\u904e\u5c07\u5ba2\u6236\u7aef\u61c9\u7528 pod \u50c5\u9023\u63a5\u5230\u540c\u4e00\u7bc0\u9ede\u4e0a\u7684 Memcached \u4ee3\u7406 pod \u4f86\u964d\u4f4e\u6b64\u98a8\u96aa\u3002\u4e0b\u5716\u8aaa\u660e\u4e86\u6b64\u914d\u7f6e\u3002\u57f7\u884c\u4ee5\u4e0b\u914d\u7f6e\uff1a- \u78ba\u4fdd\u6bcf\u500b\u7bc0\u9ede\u5305\u542b\u4e00\u500b\u6b63\u5728\u904b\u884c\u7684\u4ee3\u7406 pod\u3002\u4e00\u7a2e\u5e38\u898b\u65b9\u6cd5\u662f\u4f7f\u7528 [DaemonSet \u63a7\u5236\u5668](https://kubernetes.io/docs/concepts/workloads/controllers/daemonset) \u90e8\u7f72\u4ee3\u7406 pod\u3002 \u7bc0\u9ede\u6dfb\u52a0\u5230\u96c6\u7fa3\u4e2d\u5f8c\uff0c\u65b0\u7684\u4ee3\u7406 pod \u6703\u81ea\u52d5\u6dfb\u52a0\u5230\u7bc0\u9ede\u4e2d\u3002\u5f9e\u96c6\u7fa3\u4e2d\u522a\u9664\u7bc0\u9ede\u5f8c\uff0c\u6703\u5c0d\u9019\u4e9b pod \u9032\u884c\u5783\u573e\u56de\u6536\u3002\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u65e9\u4e9b\u6642\u5019\u90e8\u7f72\u7684 Mcrouter Helm \u5716\u8868\u9ed8\u8a8d [\u4f7f\u7528 DaemonSet \u63a7\u5236\u5668](https://github.com/kubernetes/charts/blob/master/stable/mcrouter/templates/daemonset.yaml) \u3002\u56e0\u6b64\uff0c\u6b64\u6b65\u9a5f\u5df2\u5b8c\u6210\u3002\n- \u5728\u4ee3\u7406\u5bb9\u5668\u7684 Kubernetes \u53c3\u6578\u4e2d\u8a2d\u7f6e`hostPort`\u503c\uff0c\u4ee5\u4f7f\u7bc0\u9ede\u5075\u807d\u8a72\u7aef\u53e3\u4e26\u5c07\u6d41\u91cf\u91cd\u5b9a\u5411\u5230\u4ee3\u7406\u3002\u5728\u672c\u6559\u7a0b\u4e2d\uff0cMcrouter Helm \u5716\u8868\u9ed8\u8a8d\u5c07\u6b64\u53c3\u6578\u7528\u65bc\u7aef\u53e3`5000`\u3002\u56e0\u6b64\uff0c\u6b64\u6b65\u9a5f\u4e5f\u5df2\u5b8c\u6210\u3002\n- \u901a\u904e\u4f7f\u7528 `spec.env` \u689d\u76ee\u4e26\u9078\u64c7 `spec.nodeName` `fieldRef` \u503c\uff0c\u5c07\u7bc0\u9ede\u540d\u7a31\u4f5c\u7232\u61c9\u7528 pod \u4e2d\u7684\u74b0\u5883\u8b8a\u91cf\u516c\u958b\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u6b64\u65b9\u6cd5\uff0c\u8acb\u53c3\u95b1 [Kubernetes \u6587\u6a94](https://kubernetes.io/docs/tasks/inject-data-application/environment-variable-expose-pod-information/) \u3002- \u90e8\u7f72\u4e00\u4e9b\u793a\u4f8b\u61c9\u7528 pod\uff1a```\ncat <<EOF | kubectl create -f -apiVersion: apps/v1kind: Deploymentmetadata:\u00a0 name: sample-applicationspec:\u00a0 selector:\u00a0 \u00a0 matchLabels:\u00a0 \u00a0 \u00a0 app: sample-application\u00a0 replicas: 9\u00a0 template:\u00a0 \u00a0 metadata:\u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 app: sample-application\u00a0 \u00a0 spec:\u00a0 \u00a0 \u00a0 containers:\u00a0 \u00a0 \u00a0 \u00a0 - name: busybox\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 image: busybox:1.33\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 command: [ \"sh\", \"-c\"]\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 args:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - while true; do sleep 10; done;\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 env:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 - name: NODE_NAME\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 valueFrom:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 fieldRef:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 fieldPath: spec.nodeNameEOF\n```\n- \u901a\u904e\u67e5\u770b\u4e00\u500b\u793a\u4f8b\u61c9\u7528 pod\uff0c\u9a57\u8b49\u662f\u5426\u5df2\u516c\u958b\u7bc0\u9ede\u540d\u7a31\uff1a```\nPOD=$(kubectl get pods -l app=sample-application -o jsonpath=\"{.items[0].metadata.name}\")kubectl exec -it $POD -- sh -c 'echo $NODE_NAME'\n```\u6b64\u547d\u4ee4\u8f38\u51fa\u5982\u4e0b\u683c\u5f0f\u7684\u7bc0\u9ede\u540d\u7a31\uff1a```\ngke-demo-cluster-default-pool-XXXXXXXX-XXXX\n```\n### \u9023\u63a5 pod\u793a\u4f8b\u61c9\u7528 pod \u73fe\u5728\u53ef\u4ee5\u9023\u63a5\u5230 Mcrouter \u7684\u9ed8\u8a8d\u7aef\u53e3 `5000` \u4e0a\u7684\u5404\u81ea\u914d\u5c0d\u7bc0\u9ede\u4e2d\u904b\u884c\u7684 Mcrouter pod\u3002- \u901a\u904e\u6253\u958b `telnet` \u6703\u8a71\uff0c\u5553\u52d5\u5176\u4e2d\u4e00\u500b pod \u9023\u63a5\uff1a```\nPOD=$(kubectl get pods -l app=sample-application -o jsonpath=\"{.items[0].metadata.name}\")kubectl exec -it $POD -- sh -c 'telnet $NODE_NAME 5000'\n```\n- \u770b\u5230 `telnet` \u63d0\u793a\u5f8c\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\nget anotherkeyquit\n```\u751f\u6210\u7684\u8f38\u51fa\u5982\u4e0b\uff1a```\nMcrouter is fun\n```\n\u6700\u5f8c\uff0c\u4f5c\u7232\u8aaa\u660e\uff0c\u4ee5\u4e0b Python \u4ee3\u78bc\u662f\u53ef\u901a\u904e\u6aa2\u7d22\u74b0\u5883\u4e2d\u7684 `NODE_NAME` \u8b8a\u91cf\u4e26\u4f7f\u7528 `pymemcache` \u5eab\u57f7\u884c\u6b64\u9023\u63a5\u7684\u4e00\u500b\u793a\u4f8b\u7a0b\u5e8f\uff1a\n```\nimport osfrom pymemcache.client.base import ClientNODE_NAME = os.environ['NODE_NAME']client = Client((NODE_NAME, 5000))client.set('some_key', 'some_value')result = client.get('some_key')\n```## \u6e05\u9664\u6578\u64da\u7232\u907f\u514d\u56e0\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528\u7684\u8cc7\u6e90\u5c0e\u81f4\u60a8\u7684 Google Cloud \u8cec\u865f\u7522\u751f\u8cbb\u7528\uff0c\u8acb\u522a\u9664\u5305\u542b\u9019\u4e9b\u8cc7\u6e90\u7684\u9805\u76ee\uff0c\u6216\u8005\u4fdd\u7559\u9805\u76ee\u4f46\u522a\u9664\u5404\u500b\u8cc7\u6e90\u3002- \u57f7\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u522a\u9664 GKE \u96c6\u7fa3\uff1a```\ngcloud container clusters delete demo-cluster --zone us-central1-f\n```\n- \uff08\u53ef\u9078\uff09\u522a\u9664 Helm \u4e8c\u9032\u5236\u6587\u4ef6\uff1a```\ncd ~rm -rf helm-v3.7.1rm helm-v3.7.1-linux-amd64.tar.gz\n```\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u63a2\u7d22\u9664\u7c21\u55ae\u9023\u63a5\u6c60\u4e4b\u5916\uff0cMcrouter \u63d0\u4f9b\u7684\u5176\u4ed6\u591a\u9805 [\u529f\u80fd](https://github.com/facebook/mcrouter/wiki#features) \uff0c\u5982\u6545\u969c\u5207\u63db\u526f\u672c\u3001\u53ef\u9760\u7684\u522a\u9664\u6d41\u3001\u51b7\u7de9\u5b58\u9810\u71b1\u3001\u591a\u96c6\u7fa3\u5ee3\u64ad\u3002\n- \u63a2\u7d22 [Memcached \u5716\u8868](https://github.com/kubernetes/charts/tree/master/stable/memcached) \u548c [Mcrouter \u5716\u8868](https://github.com/kubernetes/charts/tree/master/stable/mcrouter) \u7684\u6e90\u6587\u4ef6\uff0c\u8a73\u7d30\u77ad\u89e3\u5404\u81ea\u7684 Kubernetes \u914d\u7f6e\u3002\n- \u77ad\u89e3\u5728 App Engine \u4e0a\u4f7f\u7528 Memcached \u7684 [\u6709\u6548\u65b9\u6cd5](https://cloud.google.com/appengine/articles/scaling/memcache?hl=zh-cn) \u3002\u5176\u4e2d\u4e00\u4e9b\u65b9\u6cd5\u9084\u9069\u7528\u65bc\u5176\u4ed6\u5e73\u81fa\uff0c\u5982 GKE\u3002", "guide": "Google Kubernetes Engine (GKE)"}