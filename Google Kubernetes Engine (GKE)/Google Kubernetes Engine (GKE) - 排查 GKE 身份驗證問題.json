{"title": "Google Kubernetes Engine (GKE) - \u6392\u67e5 GKE \u8eab\u4efd\u9a57\u8b49\u554f\u984c", "url": "https://cloud.google.com/kubernetes-engine/docs/troubleshooting/authentication?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - \u6392\u67e5 GKE \u8eab\u4efd\u9a57\u8b49\u554f\u984c\n\u672c\u9801\u9762\u4ecb\u7d39\u5982\u4f55\u89e3\u6c7a\u8207 Google Kubernetes Engine (GKE) Autopilot \u548c\u6a19\u6e96\u96c6\u7fa3\u4e2d\u7684\u5b89\u5168\u914d\u7f6e\u76f8\u95dc\u7684\u554f\u984c\u3002\n[Cloud Customer Care](https://cloud.google.com/kubernetes-engine/docs/getting-support?hl=zh-cn)\n", "content": "## RBAC \u548c IAM\n### \u7d93\u904e\u8eab\u4efd\u9a57\u8b49\u7684 IAM \u8cec\u865f\u7121\u6cd5\u57f7\u884c\u96c6\u7fa3\u5167\u64cd\u4f5c\n\u5982\u679c\u60a8\u5617\u8a66\u5728\u96c6\u7fa3\u4e2d\u57f7\u884c\u64cd\u4f5c\uff0c\u4f46 GKE \u627e\u4e0d\u5230\u6388\u6b0a\u8a72\u64cd\u4f5c\u7684 RBAC \u653f\u7b56\uff0c\u5c31\u6703\u767c\u751f\u4ee5\u4e0b\u554f\u984c\u3002GKE \u6703\u5617\u8a66\u67e5\u627e\u6388\u4e88\u76f8\u540c\u6b0a\u9650\u7684 IAM \u653f\u7b56\u3002\u5982\u679c\u5931\u6557\uff0c\u60a8\u6703\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\u7684\u932f\u8aa4\u6d88\u606f\uff1a\n```\nError from server (Forbidden): roles.rbac.authorization.k8s.io is forbidden:\nUser \"example-account@example-project.iam.gserviceaccount.com\" cannot list resource \"roles\" in\nAPI group \"rbac.authorization.k8s.io\" in the namespace \"kube-system\": requires\none of [\"container.roles.list\"] permission(s).\n```\n\u5982\u9700\u89e3\u6c7a\u6b64\u554f\u984c\uff0c\u8acb\u4f7f\u7528 RBAC \u653f\u7b56\u7232\u5617\u8a66\u7684\u64cd\u4f5c\u6388\u4e88\u6b0a\u9650\u3002\u4f8b\u5982\uff0c\u5982\u9700\u89e3\u6c7a\u4e0a\u9762\u793a\u4f8b\u4e2d\u7684\u554f\u984c\uff0c\u8acb\u6388\u4e88\u4e00\u500b\u5c0d `kube-system` \u547d\u540d\u7a7a\u9593\u4e2d\u7684 `roles` \u5c0d\u8c61\u5177\u6709 `list` \u6b0a\u9650\u7684\u89d2\u8272\u3002\u5982\u9700\u77ad\u89e3\u76f8\u95dc\u8aaa\u660e\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528\u57fa\u65bc\u89d2\u8272\u7684\u8a2a\u554f\u6b0a\u9650\u63a7\u5236\u5411\u96c6\u7fa3\u4e2d\u7684\u64cd\u4f5c\u6388\u6b0a](https://cloud.google.com/kubernetes-engine/docs/how-to/role-based-access-control?hl=zh-cn) \u3002\n## \u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\n### Pod \u7121\u6cd5\u5411 Google Cloud \u9032\u884c\u8eab\u4efd\u9a57\u8b49\n\u5982\u679c\u60a8\u7684\u61c9\u7528\u7121\u6cd5\u5411 Google Cloud \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u78ba\u4fdd\u6b63\u78ba\u914d\u7f6e\u4ee5\u4e0b\u8a2d\u7f6e\uff1a\n- \u6aa2\u67e5\u60a8\u662f\u5426\u5df2\u5728\u5305\u542b GKE \u96c6\u7fa3\u7684\u9805\u76ee\u4e2d\u5553\u7528 IAM Service Account Credentials API\u3002 [\u5553\u7528 IAM Credentials API](https://console.cloud.google.com/apis/api/iamcredentials.googleapis.com/overview?hl=zh-cn) \n- \u901a\u904e\u9a57\u8b49\u96c6\u7fa3\u662f\u5426\u8a2d\u7f6e\u4e86\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u6c60\uff0c\u78ba\u8a8d\u662f\u5426\u5df2\u5728\u96c6\u7fa3\u4e0a\u5553\u7528\u4e86\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff1a```\ngcloud container clusters describe CLUSTER_NAME \\\u00a0 \u00a0 --format=\"value(workloadIdentityConfig.workloadPool)\"\n```\u5c07 `` \u66ff\u63db\u7232 GKE \u96c6\u7fa3\u7684\u540d\u7a31\u3002\u5982\u679c\u60a8\u5c1a\u672a\u6307\u5b9a [gcloud \u7684\u9ed8\u8a8d\u53ef\u7528\u5340\u6216\u5340\u57df](https://cloud.google.com/kubernetes-engine/docs/how-to/managing-clusters?hl=zh-cn#before_you_begin) \uff0c\u5247\u60a8\u9084\u53ef\u80fd\u9700\u8981\u5728\u904b\u884c\u6b64\u547d\u4ee4\u6642\u6307\u5b9a `--region` \u6216 `--zone` \u6a19\u8a8c\u3002\n- \u78ba\u4fdd\u5df2\u5728\u904b\u884c\u61c9\u7528\u7684\u7bc0\u9ede\u6c60\u4e0a\u914d\u7f6e GKE \u5143\u6578\u64da\u670d\u52d9\u5668\uff1a```\ngcloud container node-pools describe NODEPOOL_NAME \\\u00a0 \u00a0 --cluster=CLUSTER_NAME \\\u00a0 \u00a0 --format=\"value(config.workloadMetadataConfig.mode)\"\n```\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- \u5c07``\u66ff\u63db\u7232\u60a8\u7684\u7bc0\u9ede\u6c60\u7684\u540d\u7a31\u3002\n- \u5c07``\u66ff\u63db\u7232\u60a8\u7684 GKE \u96c6\u7fa3\u7684\u540d\u7a31\u3002\n- \u78ba\u8a8d\u5df2\u6b63\u78ba\u8a3b\u89e3 Kubernetes \u670d\u52d9\u8cec\u865f\uff1a```\nkubectl describe serviceaccount \\\u00a0 \u00a0 --namespace NAMESPACE KSA_NAME\n```\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- \u5c07``\u66ff\u63db\u7232\u60a8\u7684 GKE \u96c6\u7fa3\u7684\u547d\u540d\u7a7a\u9593\u3002\n- \u5c07``\u66ff\u63db\u7232\u60a8\u7684 Kubernetes \u670d\u52d9\u8cec\u865f\u7684\u540d\u7a31\u3002\n\u9810\u671f\u8f38\u51fa\u5305\u542b\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\u7684\u8a3b\u89e3\uff1a```\niam.gke.io/gcp-service-account: GSA_NAME@PROJECT_ID.iam.gserviceaccount.com\n```\n- \u6aa2\u67e5 IAM \u670d\u52d9\u8cec\u865f\u662f\u5426\u914d\u7f6e\u6b63\u78ba\uff1a```\ngcloud iam service-accounts get-iam-policy \\\u00a0 \u00a0 GSA_NAME@GSA_PROJECT.iam.gserviceaccount.com\n```\u9810\u671f\u8f38\u51fa\u5305\u542b\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\u7684\u7d81\u5b9a\uff1a```\n- members:\u00a0 - serviceAccount:PROJECT_ID.svc.id.goog[NAMESPACE/KSA_NAME]\u00a0 role: roles/iam.workloadIdentityUser\n```\n- \u5982\u679c\u60a8\u5236\u5b9a\u4e86 [\u96c6\u7fa3\u7db2\u7d61\u653f\u7b56](https://cloud.google.com/kubernetes-engine/docs/how-to/network-policy?hl=zh-cn) \uff0c\u5247\u5c0d\u65bc\u904b\u884c 1.21.0-gke.1000 \u4e4b\u524d\u7684 GKE \u7248\u672c\u7684\u96c6\u7fa3\uff0c\u60a8\u5fc5\u9808\u5141\u8a31\u7aef\u53e3 `988` \u4e0a\u6d41\u5411 `127.0.0.1/32` \u7684\u51fa\u7ad9\u6d41\u91cf\uff0c\u6216\u5c0d\u65bc\u904b\u884c GKE 1.21.0-gke.1000 \u53ca\u66f4\u9ad8\u7248\u672c\u7684\u96c6\u7fa3\uff0c\u60a8\u5fc5\u9808\u5141\u8a31\u7aef\u53e3 `988` \u4e0a\u6d41\u5411 `169.254.169.252/32` \u7684\u51fa\u7ad9\u6d41\u91cf\u3002\u5c0d\u65bc\u904b\u884c GKE Dataplane V2 \u7684\u96c6\u7fa3\uff0c\u60a8\u5fc5\u9808\u5141\u8a31\u7aef\u53e3 `80` \u4e0a\u6d41\u5411 `169.254.169.254/32` \u7684\u51fa\u7ad9\u6d41\u91cf\u3002```\nkubectl describe networkpolicy NETWORK_POLICY_NAME\n```\u5c07 `` \u66ff\u63db\u7232 GKE \u7db2\u7d61\u653f\u7b56\u7684\u540d\u7a31\u3002\n### DNS \u89e3\u6790\u554f\u984c\n\u67d0\u4e9b Google Cloud \u5ba2\u6236\u7aef\u5eab\u914d\u7f6e\u7232\u901a\u904e\u89e3\u6790 DNS \u540d\u7a31 `metadata.google.internal` \u4f86\u9023\u63a5\u5230 GKE \u548c Compute Engine \u5143\u6578\u64da\u670d\u52d9\u5668\uff1b\u5c0d\u65bc\u9019\u4e9b\u5eab\uff0c\u904b\u884c\u72c0\u6cc1\u826f\u597d\u7684\u96c6\u7fa3\u5167 DNS \u89e3\u6790\u662f\u5de5\u4f5c\u8ca0\u8f09\u5411 Google Cloud \u670d\u52d9\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u95dc\u9375\u4f9d\u8cf4\u9805\u3002\n\u5982\u4f55\u6aa2\u6e2c\u6b64\u554f\u984c\u53d6\u6c7a\u65bc\u6240\u90e8\u7f72\u7684\u61c9\u7528\u7684\u8a73\u7d30\u4fe1\u606f\uff0c\u5305\u62ec\u5176\u65e5\u8a8c\u8a18\u9304\u914d\u7f6e\u3002\u67e5\u627e\u7b26\u5408\u4ee5\u4e0b\u689d\u4ef6\u7684\u932f\u8aa4\u6d88\u606f\uff1a\n- \u544a\u77e5\u60a8\u914d\u7f6e GOOGLE_APPLICATION_CREDENTIALS\uff0c\u6216\u8005\n- \u544a\u77e5\u60a8\u5c0d Google Cloud \u670d\u52d9\u7684\u8acb\u6c42\u88ab\u62d2\u7d55\uff0c\u56e0\u7232\u8acb\u6c42\u6c92\u6709\u6191\u64da\u3002\n\u5982\u679c\u60a8\u5728 `metadata.google.internal` \u7684 DNS \u89e3\u6790\u65b9\u9762\u9047\u5230\u554f\u984c\uff0c\u53ef\u4ee5\u901a\u904e\u5c07\u74b0\u5883\u8b8a\u91cf `GCE_METADATA_HOST` \u8a2d\u7f6e\u7232 `169.254.169.254` \u4f86\u6307\u793a\u67d0\u4e9b Google Cloud \u5ba2\u6236\u7aef\u5eab\u8df3\u904e DNS \u89e3\u6790\uff1a\n```\napiVersion: v1kind: Podmetadata:\u00a0 name: example-pod\u00a0 namespace: defaultspec:\u00a0 containers:\u00a0 - image: debian\u00a0 \u00a0 name: main\u00a0 \u00a0 command: [\"sleep\", \"infinity\"]\u00a0 \u00a0 env:\u00a0 \u00a0 - name: GCE_METADATA_HOST\u00a0 \u00a0 \u00a0 value: \"169.254.169.254\"\n```\n\u9019\u662f\u786c\u7de8\u78bc IP \u5730\u5740\uff0c\u59cb\u7d42\u53ef\u901a\u904e\u8a72\u5730\u5740\u5728 Google Cloud \u8a08\u7b97\u5e73\u81fa\u4e0a\u8a2a\u554f\u5143\u6578\u64da\u670d\u52d9\u3002\n\u652f\u6301\u7684 Google Cloud \u5eab\uff1a\n- [Python](https://googleapis.dev/python/google-auth/latest/reference/google.auth.environment_vars.html#:%7E:text=SDK%E2%80%99s%20config%20files.-,GCE_METADATA_HOST,-%3D%20%27GCE_METADATA_HOST%27) \n- [Java](https://github.com/googleapis/google-auth-library-java/blob/ab872812d0f6e9ad7598ba4c4c503d5bff6c2a2b/oauth2_http/java/com/google/auth/oauth2/DefaultCredentialsProvider.java#L71) \n- [Node.js](https://cloud.google.com/nodejs/docs/reference/gcp-metadata/latest?hl=zh-cn#:~:text=Environment%20variables-,GCE_METADATA_HOST,-:%20provide%20an%20alternate) \n- [Golang](https://pkg.go.dev/cloud.google.com/go/compute/metadata#section-readme:%7E:text=If%20the-,GCE_METADATA_HOST,-environment%20variable%20is) \uff08\u4f46\u8acb\u6ce8\u610f\uff0cGolang \u5ba2\u6236\u7aef\u5eab\u5df2\u9996\u9078\u901a\u904e IP \u5730\u5740\u800c\u4e0d\u662f DNS \u540d\u7a31\u9032\u884c\u9023\u63a5\uff09\u3002\n### Pod \u5553\u52d5\u6642\u767c\u751f\u8d85\u6642\u932f\u8aa4\nGKE \u5143\u6578\u64da\u670d\u52d9\u5668\u9700\u8981\u5e7e\u79d2\u9418\u7684\u6642\u9593\u624d\u80fd\u958b\u59cb\u5728 Pod \u4e0a\u63a5\u53d7\u65b0\u8acb\u6c42\u3002\u5c0d\u65bc\u914d\u7f6e\u4e86\u8f03\u77ed\u8d85\u6642\u7684\u61c9\u7528\u548c Google Cloud \u5ba2\u6236\u7aef\u5eab\uff0c\u5617\u8a66\u5728 Pod \u751f\u547d\u9031\u671f\u5167\u7684\u524d\u5e7e\u79d2\u5167\u4f7f\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u53ef\u80fd\u6703\u5931\u6557\u3002\n\u5982\u679c\u60a8\u9047\u5230\u8d85\u6642\u932f\u8aa4\uff0c\u8acb\u5617\u8a66\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u66f4\u65b0\u5de5\u4f5c\u8ca0\u8f09\u4f7f\u7528\u7684 Google Cloud \u5ba2\u6236\u7aef\u5eab\u3002\n- \u66f4\u6539\u61c9\u7528\u4ee3\u78bc\uff0c\u7b49\u5f85\u5e7e\u79d2\u9418\uff0c\u7136\u5f8c\u91cd\u8a66\u3002\n- \u90e8\u7f72 [initContainer](https://kubernetes.io/docs/concepts/workloads/pods/init-containers/) \uff0c\u7b49\u5f85 GKE \u5143\u6578\u64da\u670d\u52d9\u5668\u904b\u884c\u5b8c\u7562\uff0c\u7136\u5f8c\u518d\u904b\u884c Pod \u7684\u4e3b\u5bb9\u5668\u3002\u4f8b\u5982\uff0c\u4ee5\u4e0b\u6e05\u55ae\u9069\u7528\u65bc\u5177\u6709 `initContainer` \u7684 Pod\uff1a```\napiVersion: v1kind: Podmetadata:\u00a0 name: pod-with-initcontainerspec:\u00a0 serviceAccountName: KSA_NAME\u00a0 initContainers:\u00a0 - image: \u00a0gcr.io/google.com/cloudsdktool/cloud-sdk:alpine\u00a0 \u00a0 name: workload-identity-initcontainer\u00a0 \u00a0 command:\u00a0 \u00a0 - '/bin/bash'\u00a0 \u00a0 - '-c'\u00a0 \u00a0 - |\u00a0 \u00a0 \u00a0 curl -sS -H 'Metadata-Flavor: Google' 'http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token' --retry 30 --retry-connrefused --retry-max-time 60 --connect-timeout 3 --fail --retry-all-errors > /dev/null && exit 0 || echo 'Retry limit exceeded. Failed to wait for metadata server to be available. Check if the gke-metadata-server Pod in the kube-system namespace is healthy.' >&2; exit 1\u00a0 containers:\u00a0 - image: gcr.io/your-project/your-image\u00a0 \u00a0 name: your-main-application-container\n```\n### \u7531\u65bc\u63a7\u5236\u5e73\u9762\u4e0d\u53ef\u7528\uff0c\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u5931\u6557\n\u7576\u96c6\u7fa3\u63a7\u5236\u5e73\u9762\u4e0d\u53ef\u7528\u6642\uff0c\u5143\u6578\u64da\u670d\u52d9\u5668\u7121\u6cd5\u8fd4\u56de\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\u5c0d\u5143\u6578\u64da\u670d\u52d9\u5668\u7684\u8abf\u7528\u6703\u8fd4\u56de\u72c0\u614b\u4ee3\u78bc 500\u3002\n\u65e5\u8a8c\u689d\u76ee\u5728\u65e5\u8a8c\u700f\u89bd\u5668\u4e2d\u53ef\u80fd\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a\n```\ndial tcp 35.232.136.58:443: connect: connection refused\n```\n\u6b64\u884c\u7232\u6703\u5c0e\u81f4\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u4e0d\u53ef\u7528\u3002\n\u5728\u96c6\u7fa3\u7dad\u8b77\uff08\u4f8b\u5982\u8f2a\u66ff IP \u5730\u5740\u3001\u5347\u7d1a\u63a7\u5236\u5e73\u9762\u865b\u64ec\u6a5f\u6216\u8005\u8abf\u6574\u96c6\u7fa3\u6216\u7bc0\u9ede\u6c60\u7684\u5927\u5c0f\uff09\u671f\u9593\uff0c\u63a7\u5236\u5e73\u9762\u53ef\u80fd\u5728\u53ef\u7528\u5340\u96c6\u7fa3\u4e0a\u7121\u6cd5\u4f7f\u7528\u3002\u8acb\u53c3\u95b1 [\u9078\u64c7\u5340\u57df\u63a7\u5236\u5e73\u9762\u6216\u53ef\u7528\u5340\u63a7\u5236\u5e73\u9762](https://cloud.google.com/kubernetes-engine/docs/concepts/planning-scalability?hl=zh-cn#choosing_a_regional_or_zonal_control_plane) \uff0c\u4ee5\u77ad\u89e3\u63a7\u5236\u5e73\u9762\u53ef\u7528\u6027\u3002\u5207\u63db\u5230\u5340\u57df\u7d1a\u96c6\u7fa3\u53ef\u4ee5\u6d88\u9664\u6b64\u554f\u984c\u3002\n### \u5728\u4f7f\u7528 Istio \u7684\u96c6\u7fa3\u4e2d\uff0c\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u8eab\u4efd\u9a57\u8b49\u5931\u6557\n\u5982\u679c GKE \u5143\u6578\u64da\u670d\u52d9\u5668\u7531\u65bc\u67d0\u7a2e\u539f\u56e0\u88ab\u963b\u6b62\uff0c\u5247\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u8eab\u4efd\u9a57\u8b49\u6703\u5931\u6557\u3002\n\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f Istio \u6216 Anthos Service Mesh\uff0c\u8acb\u5c07\u4ee5\u4e0b Pod \u7d1a\u8a3b\u89e3\u6dfb\u52a0\u5230\u4f7f\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u7684\u6240\u6709\u5de5\u4f5c\u8ca0\u8f09\uff0c\u4ee5\u5f9e\u91cd\u5b9a\u5411\u4e2d\u6392\u9664\u8a72 IP \u5730\u5740\uff1a\n```\ntraffic.sidecar.istio.io/excludeOutboundIPRanges: 169.254.169.254/32\n```\n\u60a8\u53ef\u4ee5\u66f4\u6539 `global.proxy.excludeIPRanges` [Istio ConfigMap](https://istio.io/latest/docs/tasks/traffic-management/egress/egress-control/#direct-access-to-external-services) \u9375\u4f86\u57f7\u884c\u76f8\u540c\u7684\u64cd\u4f5c\u3002\n\u6216\u8005\uff0c\u60a8\u4e5f\u53ef\u4ee5\u5c07\u4ee5\u4e0b Pod \u7d1a\u8a3b\u89e3\u6dfb\u52a0\u5230\u4f7f\u7528\u9069\u7528\u65bc GKE \u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u7684\u6240\u6709\u5de5\u4f5c\u8ca0\u8f09\uff0c\u4ee5\u5ef6\u9072\u61c9\u7528\u5bb9\u5668\u5553\u52d5\uff0c\u76f4\u5230\u8f14\u52a9\u4fe1\u606f\u6587\u4ef6\u6e96\u5099\u5c31\u7dd2\uff1a\n```\nproxy.istio.io/config: '{ \"holdApplicationUntilProxyStarts\": true }'\n```\n\u60a8\u53ef\u4ee5\u66f4\u6539 `global.proxy.holdApplicationUntilProxyStarts` [Istio ConfigMap](https://istio.io/latest/docs/reference/config/istio.mesh.v1alpha1/#ProxyConfig) \u9375\u4f86\u57f7\u884c\u76f8\u540c\u7684\u64cd\u4f5c\u3002\n**\u6ce8\u610f** \uff1a\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f\u4ee3\u7ba1\u5f0f Anthos Service Mesh\uff0c\u5247 `global.proxy.*` \u914d\u7f6e\u9078\u9805\u4e0d\u53ef\u7528\u3002\n### gke-metadata-server Pod \u5d29\u6f70\n`gke-metadata-server` \u7cfb\u7d71 DaemonSet Pod \u6709\u52a9\u65bc\u5728\u60a8\u7684\u7bc0\u9ede\u4e0a\u5be6\u73fe\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002Pod \u7684\u5167\u5b58\u8cc7\u6e90\u7528\u91cf\u8207\u96c6\u7fa3\u4e2d\u7684 Kubernetes \u670d\u52d9\u8cec\u865f\u6578\u91cf\u6210\u6b63\u6bd4\u3002\n\u7576 `gke-metadata-server` Pod \u7684\u8cc7\u6e90\u7528\u91cf\u8d85\u51fa\u5176\u9650\u5236\u6642\uff0c\u6703\u51fa\u73fe\u4ee5\u4e0b\u554f\u984c\u3002kubelet \u9010\u51fa Pod \u4e26\u5831\u544a\u5167\u5b58\u4e0d\u8db3\u932f\u8aa4\u3002\u5982\u679c\u60a8\u7684\u96c6\u7fa3\u5177\u6709\u8d85\u904e 3,000 \u500b Kubernetes \u670d\u52d9\u8cec\u865f\uff0c\u5247\u53ef\u80fd\u6703\u51fa\u73fe\u6b64\u554f\u984c\u3002\n\u5982\u9700\u627e\u51fa\u6b64\u554f\u984c\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u5728 `kube-system` \u547d\u540d\u7a7a\u9593\u4e2d\u627e\u5230\u767c\u751f\u5d29\u6f70\u7684 `gke-metadata-server` Pod\uff1a```\nkubectl get pods -n=kube-system | grep CrashLoopBackOff\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nNAMESPACE  NAME      READY  STATUS    RESTARTS AGE\nkube-system gke-metadata-server-8sm2l 0/1  CrashLoopBackOff 194  16h\nkube-system gke-metadata-server-hfs6l 0/1  CrashLoopBackOff 1369  111d\nkube-system gke-metadata-server-hvtzn 0/1  CrashLoopBackOff 669  111d\nkube-system gke-metadata-server-swhbb 0/1  CrashLoopBackOff 30   136m\nkube-system gke-metadata-server-x4bl4 0/1  CrashLoopBackOff 7   15m\n```\n- \u57f7\u884c\u4ee5\u4e0b\u547d\u4ee4\u7372\u53d6\u767c\u751f\u5d29\u6f70\u7684 Pod \u7684\u63cf\u8ff0\uff0c\u78ba\u8a8d\u5d29\u6f70\u662f\u5426\u7531\u65bc\u767c\u751f\u5167\u5b58\u4e0d\u8db3\u9010\u51fa\u6240\u5c0e\u81f4\uff1a```\nkubectl describe pod POD_NAME --namespace=kube-system | grep OOMKilled\n```\u5c07 `` \u66ff\u63db\u7232\u8981\u6aa2\u67e5\u7684 Pod \u7684\u540d\u7a31\u3002\n\u5982\u9700\u4f7f GKE \u5143\u6578\u64da\u670d\u52d9\u5668\u6062\u5fa9\u6b63\u5e38\u5de5\u4f5c\uff0c\u8acb\u5c07\u96c6\u7fa3\u4e2d\u7684\u670d\u52d9\u8cec\u865f\u6578\u91cf\u6e1b\u5c11\u5230\u5c0f\u65bc 3,000 \u500b\u3002\n### \u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u7121\u6cd5\u5553\u7528\uff0c\u4e26\u986f\u793a DeployPatch \u5931\u6557\u7684\u932f\u8aa4\u6d88\u606f\nGKE \u4f7f\u7528 Google Cloud \u7ba1\u7406\u7684 [Kubernetes Engine Service Agent](https://cloud.google.com/kubernetes-engine/docs/how-to/service-accounts?hl=zh-cn#gke-service-agents) \u5be6\u73fe\u96c6\u7fa3\u4e2d\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002\u5553\u7528 Google Kubernetes Engine API \u6642\uff0cGoogle Cloud \u6703\u81ea\u52d5\u5c31\u60a8\u7684\u9805\u76ee\u5411\u6b64\u670d\u52d9\u4ee3\u7406\u6388\u4e88 Kubernetes Engine Service Agent \u89d2\u8272 ( `roles/container.serviceAgent` )\u3002\n\u5982\u679c\u60a8\u5617\u8a66\u5728\u670d\u52d9\u4ee3\u7406\u6c92\u6709 Kubernetes Engine Service Agent \u89d2\u8272\u7684\u9805\u76ee\u4e2d\u5c0d\u96c6\u7fa3\u4e0a\u5553\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\uff0c\u64cd\u4f5c\u5c07\u5931\u6557\u4e26\u986f\u793a\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\u7684\u932f\u8aa4\u6d88\u606f\uff1a\n```\nError waiting for updating GKE cluster workload identity config: DeployPatch failed\n```\n\u5982\u9700\u89e3\u6c7a\u6b64\u554f\u984c\uff0c\u8acb\u5617\u8a66\u57f7\u884c\u4ee5\u4e0b\u6b65\u9a5f\uff1a\n- \u6aa2\u67e5\u9805\u76ee\u4e2d\u662f\u5426\u5b58\u5728\u670d\u52d9\u4ee3\u7406\uff0c\u4ee5\u53ca\u914d\u7f6e\u662f\u5426\u6b63\u78ba\uff1a```\ngcloud projects get-iam-policy PROJECT_ID \\\u00a0 \u00a0 --flatten=bindings \\\u00a0 \u00a0 --filter=bindings.role=roles/container.serviceAgent \\\u00a0 \u00a0 --format=\"value[delimiter='\\\\n'](bindings.members)\"\n```\u5c07 `` \u66ff\u63db\u7232\u60a8\u7684 Google Cloud \u9805\u76ee ID\u3002\u5982\u679c\u670d\u52d9\u4ee3\u7406\u914d\u7f6e\u6b63\u78ba\uff0c\u5247\u8f38\u51fa\u6703\u986f\u793a\u670d\u52d9\u4ee3\u7406\u7684\u5b8c\u6574\u8eab\u4efd\uff1a```\nserviceAccount:service-PROJECT_NUMBER@container-engine-robot.iam.gserviceaccount.com\n```\u5982\u679c\u8f38\u51fa\u672a\u986f\u793a\u670d\u52d9\u4ee3\u7406\uff0c\u60a8\u5fc5\u9808\u5411\u5176\u6388\u4e88 Kubernetes Engine Service Agent \u89d2\u8272\u3002 \u8981\u6388\u4e88\u6b64\u89d2\u8272\uff0c\u8acb\u5b8c\u6210\u4ee5\u4e0b\u6b65\u9a5f\u3002\n- \u7372\u53d6 Google Cloud \u9805\u76ee\u7de8\u865f\uff1a```\ngcloud projects describe PROJECT_ID \\\u00a0 \u00a0 --format=\"value(projectNumber)\"\n```\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\n123456789012\n```\n- \u5411\u8a72\u670d\u52d9\u4ee3\u7406\u6388\u4e88\u89d2\u8272\uff1a```\ngcloud projects add-iam-policy-binding PROJECT_ID \\\u00a0 \u00a0 --member=serviceAccount:service-PROJECT_NUMBER@container-engine-robot.iam.gserviceaccount.com \\\u00a0 \u00a0 --role=roles/container.serviceAgent \\\u00a0 \u00a0 --condition=None\n```\u5c07 `` \u66ff\u63db\u7232\u60a8\u7684 Google Cloud \u9805\u76ee\u7de8\u865f\u3002\n- \u5617\u8a66\u518d\u6b21\u5553\u7528\u9069\u7528\u65bc GKE \u7684\u5de5\u4f5c\u8ca0\u8f09\u8eab\u4efd\u806f\u5408\u3002## \u5f8c\u7e8c\u6b65\u9a5f\n[Cloud Customer Care](https://cloud.google.com/kubernetes-engine/docs/getting-support?hl=zh-cn)", "guide": "Google Kubernetes Engine (GKE)"}