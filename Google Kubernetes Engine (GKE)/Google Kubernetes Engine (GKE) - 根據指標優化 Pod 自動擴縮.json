{"title": "Google Kubernetes Engine (GKE) - \u6839\u64da\u6307\u6a19\u512a\u5316 Pod \u81ea\u52d5\u64f4\u7e2e", "url": "https://cloud.google.com/kubernetes-engine/docs/tutorials/autoscaling-metrics?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - \u6839\u64da\u6307\u6a19\u512a\u5316 Pod \u81ea\u52d5\u64f4\u7e2e\n\u672c\u6559\u7a0b\u6f14\u793a\u5982\u4f55\u6839\u64da\n [Cloud Monitoring](https://cloud.google.com/monitoring?hl=zh-cn) \n\u4e2d\u63d0\u4f9b\u7684\u6307\u6a19\u81ea\u52d5\u64f4\u7e2e Google Kubernetes Engine (GKE) \u5de5\u4f5c\u8ca0\u8f09\u3002\n\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u53ef\u4ee5\u6839\u64da\u4ee5\u4e0b\u56db\u500b\u4e0d\u540c\u6307\u6a19\u4e4b\u4e00\u8a2d\u7f6e\u81ea\u52d5\u64f4\u7e2e\uff1a\n **CPU \u5229\u7528\u7387** \n\u6839\u64da CPU \u5728\u5404\u7bc0\u9ede\u4e4b\u9593\u7684\u5229\u7528\u7387\u767e\u5206\u6bd4\u9032\u884c\u64f4\u7e2e\u3002\u6b64\u6307\u6a19\u7d93\u6fdf\u9ad8\u6548\uff0c\u5f9e\u800c\u6700\u5927\u9650\u5ea6\u5730\u63d0\u9ad8 CPU \u8cc7\u6e90\u5229\u7528\u7387\u3002\u4e0d\u904e\uff0c\u7531\u65bc CPU \u4f7f\u7528\u7387\u662f\u4e00\u500b\u5c3e\u96a8\u6307\u6a19\uff0c\u56e0\u6b64\u60a8\u7684\u7528\u6236\u53ef\u80fd\u6703\u5728\u7e31\u5411\u64f4\u5bb9\u904e\u7a0b\u4e2d\u9047\u5230\u5ef6\u9072\u3002\n **Pub/Sub \u7a4d\u58d3** \n\u6839\u64da [Pub/Sub \u8a02\u95b1](https://cloud.google.com/pubsub/docs/subscriber?hl=zh-cn) \u4e2d\u5269\u9918\u7684\u672a\u78ba\u8a8d\u6d88\u606f\u7684\u6578\u91cf\u9032\u884c\u64f4\u7e2e\u3002\u6b64\u6307\u6a19\u5728\u51fa\u73fe\u554f\u984c\u4e4b\u524d\u53ef\u6709\u6548\u7e2e\u77ed\u5ef6\u9072\u6642\u9593\uff0c\u4f46\u8207\u57fa\u65bc CPU \u5229\u7528\u7387\u7684\u81ea\u52d5\u64f4\u7e2e\u76f8\u6bd4\uff0c\u6240\u4f7f\u7528\u7684\u8cc7\u6e90\u53ef\u80fd\u76f8\u5c0d\u8f03\u591a\u3002\n **\u81ea\u5b9a\u7fa9 Cloud Monitoring \u6307\u6a19** \n\u6839\u64da [Cloud Monitoring \u5ba2\u6236\u7aef\u5eab](https://cloud.google.com/monitoring/docs/reference/libraries?hl=zh-cn) \u5c0e\u51fa\u7684\u81ea\u5b9a\u7fa9\u7528\u6236\u5b9a\u7fa9\u6307\u6a19\u9032\u884c\u64f4\u7e2e\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 Cloud Monitoring \u6587\u6a94\u4e2d\u7684 [\u5275\u5efa\u81ea\u5b9a\u7fa9\u6307\u6a19](https://cloud.google.com/monitoring/custom-metrics/creating-metrics?hl=zh-cn) \u3002\n **\u81ea\u5b9a\u7fa9 Prometheus \u6307\u6a19** \n\u6839\u64da\u4ee5 [Prometheus](https://prometheus.io/docs/instrumenting/exposition_formats/) \u683c\u5f0f\u5c0e\u51fa\u7684\u81ea\u5b9a\u7fa9\u7528\u6236\u5b9a\u7fa9\u6307\u6a19\u9032\u884c\u64f4\u7e2e\u3002Prometheus \u6307\u6a19\u5fc5\u9808\u662f [\u63a1\u6a23\u5e73\u5747\u503c](https://prometheus.io/docs/concepts/metric_types/#gauge) \u985e\u578b\uff0c\u4e26\u4e14\u4e0d\u5f97\u5305\u542b `custom.googleapis.com` \u524d\u7db4\u3002\u81ea\u52d5\u64f4\u7e2e\u5f9e\u6839\u672c\u4e0a\u4f86\u8aaa\u5c31\u662f\u5728\u8cbb\u7528\u548c\u5ef6\u9072\u4e4b\u9593\u627e\u5230\u53ef\u63a5\u53d7\u7684\u5e73\u8861\u3002\u60a8\u53ef\u80fd\u5e0c\u671b\u7d44\u5408\u8a66\u7528\u9019\u4e9b\u6307\u6a19 [\u548c\u5176\u4ed6\u6307\u6a19](https://cloud.google.com/monitoring/api/metrics_kubernetes?hl=zh-cn) \u4ee5\u627e\u5230\u9069\u5408\u60a8\u7684\u653f\u7b56\u3002", "content": "## \u76ee\u6a19\n\u672c\u6559\u7a0b\u4ecb\u7d39\u4e86\u4ee5\u4e0b\u4efb\u52d9\uff1a\n- \u5982\u4f55\u90e8\u7f72 [\u81ea\u5b9a\u7fa9\u6307\u6a19\u9069\u914d\u5668](https://github.com/GoogleCloudPlatform/k8s-stackdriver/tree/master/custom-metrics-stackdriver-adapter) \u3002\n- \u5982\u4f55\u5f9e\u61c9\u7528\u4ee3\u78bc\u4e2d\u5c0e\u51fa\u6307\u6a19\u3002\n- \u5982\u4f55\u5728 Cloud Monitoring \u754c\u9762\u4e0a\u67e5\u770b\u6307\u6a19\u3002\n- \u5982\u4f55\u90e8\u7f72 [HorizontalPodAutoscaler (HPA)](https://cloud.google.com/kubernetes-engine/docs/concepts/horizontalpodautoscaler?hl=zh-cn) \u8cc7\u6e90\uff0c\u4ee5\u6839\u64da Cloud Monitoring \u6307\u6a19\u64f4\u7e2e\u60a8\u7684\u61c9\u7528\u3002\n## \u8cbb\u7528\nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728\u672c\u6587\u6a94\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Google Cloud \u7684\u4ee5\u4e0b\u6536\u8cbb\u7d44\u4ef6\uff1a- [GKE](https://cloud.google.com/kubernetes-engine/pricing?hl=zh-cn) \n- [Pub/Sub](https://cloud.google.com/pubsub/pricing?hl=zh-cn) \n\u60a8\u53ef\u4f7f\u7528 [\u50f9\u683c\u8a08\u7b97\u5668](https://cloud.google.com/products/calculator?hl=zh-cn) \u6839\u64da\u60a8\u7684\u9810\u8a08\u4f7f\u7528\u60c5\u6cc1\u4f86\u4f30\u7b97\u8cbb\u7528\u3002 \nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5b8c\u6210\u672c\u6587\u6a94\u4e2d\u63cf\u8ff0\u7684\u4efb\u52d9\u5f8c\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u522a\u9664\u6240\u5275\u5efa\u7684\u8cc7\u6e90\u4f86\u907f\u514d\u7e7c\u7e8c\u8a08\u8cbb\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u6e05\u7406](#clean-up) \u3002## \u6e96\u5099\u5de5\u4f5c\n\u8acb\u6309\u7167\u4ee5\u4e0b\u6b65\u9a5f\u5553\u7528 Kubernetes Engine API\uff1a\n- \u8a2a\u554f Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 [Kubernetes Engine \u9801\u9762](https://console.cloud.google.com/projectselector/kubernetes?hl=zh-cn) \u3002\n- \u5275\u5efa\u6216\u9078\u64c7\u9805\u76ee\u3002\n- \u7a0d\u4f5c\u7b49\u5f85\uff0c\u8b93 API \u548c\u76f8\u95dc\u670d\u52d9\u5b8c\u6210\u5553\u7528\u904e\u7a0b\u3002  \u6b64\u904e\u7a0b\u53ef\u80fd\u8017\u6642\u5e7e\u5206\u9418\u3002\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- [\u78ba\u4fdd\u60a8\u7684 Google Cloud \u9805\u76ee\u5df2\u5553\u7528\u7d50\u7b97\u529f\u80fd](https://cloud.google.com/billing/docs/how-to/verify-billing-enabled?hl=zh-cn#console) \u3002\n\u60a8\u53ef\u4ee5\u4f7f\u7528 [Cloud Shell](https://cloud.google.com/shell?hl=zh-cn) \u4f86\u57f7\u884c\u672c\u6559\u7a0b\u4e2d\u6240\u8ff0\u7684\u64cd\u4f5c\uff0c\u8a72\u74b0\u5883\u4e2d\u9810\u88dd\u4e86\u672c\u6559\u7a0b\u4e2d\u7528\u5230\u7684 `gcloud` \u548c `kubectl` \u547d\u4ee4\u884c\u5de5\u5177\u3002\u5982\u679c\u4f7f\u7528 Cloud Shell\uff0c\u5247\u7121\u9700\u5728\u5de5\u4f5c\u7ad9\u4e0a\u5b89\u88dd\u9019\u4e9b\u547d\u4ee4\u884c\u5de5\u5177\u3002\n\u5982\u9700\u4f7f\u7528 Cloud Shell\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u524d\u5f80 [Google Cloud \u63a7\u5236\u6aaf](https://console.cloud.google.com/?hl=zh-cn) \u3002\n- \u9ede\u64ca Google Cloud \u63a7\u5236\u6aaf\u7a97\u53e3\u9802\u90e8\u7684 **\u6fc0\u6d3b Cloud Shell** \u6309\u9215\u3002\u4e00\u500b Cloud Shell \u6703\u8a71\u96a8\u5373\u6703\u5728 Google Cloud \u63a7\u5236\u6aaf\u5e95\u90e8\u7684\u65b0\u6846\u5167\u6253\u958b\uff0c\u4e26\u986f\u793a\u547d\u4ee4\u884c\u63d0\u793a\u7b26\u3002 \n### \u8a2d\u7f6e\u60a8\u7684\u74b0\u5883\n- \u8a2d\u7f6e Google Cloud CLI \u7684\u9ed8\u8a8d\u53ef\u7528\u5340\uff1a```\ngcloud config set compute/zone zone\n```\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u9078\u64c7\u96e2\u60a8\u6700\u8fd1\u7684\u5340\u57df\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5340\u57df\u548c\u53ef\u7528\u5340](https://cloud.google.com/compute/docs/regions-zones?hl=zh-cn) \u3002\n- \u5c07 `PROJECT_ID` \u74b0\u5883\u8b8a\u91cf\u8a2d\u7f6e\u7232\u60a8\u7684 [Google Cloud \u9805\u76ee ID](https://cloud.google.com/resource-manager/docs/creating-managing-projects?hl=zh-cn#identifying_projects) ( )\uff1a```\nexport PROJECT_ID=project-id\n```\n- \u8a2d\u7f6e Google Cloud CLI \u7684\u9ed8\u8a8d\u53ef\u7528\u5340\uff1a```\ngcloud config set project $PROJECT_ID\n```\n- \u5275\u5efa GKE [\u96c6\u7fa3](https://cloud.google.com/kubernetes-engine/docs/clusters?hl=zh-cn) ```\ngcloud container clusters create metrics-autoscaling\n``` **\u6ce8\u610f** \uff1a\u672c\u6559\u7a0b\u5c08\u7528\u65bc\u505c\u7528\u4e86 [Workload Identity](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity?hl=zh-cn) \u7684\u96c6\u7fa3\u3002 \u5982\u679c\u96c6\u7fa3\u5df2\u5553\u7528 Workload Identity\uff0c\u60a8\u5fc5\u9808\u6309\u7167\u6b64 [GitHub \u9801\u9762](https://github.com/GoogleCloudPlatform/k8s-stackdriver/tree/master/custom-metrics-stackdriver-adapter#configure-cluster) \u4e2d\u7684\u8aaa\u660e\u57f7\u884c\u5176\u4ed6\u6b65\u9a5f ## \u90e8\u7f72\u81ea\u5b9a\u7fa9\u6307\u6a19\u9069\u914d\u5668 [\u81ea\u5b9a\u7fa9\u6307\u6a19\u9069\u914d\u5668](https://github.com/GoogleCloudPlatform/k8s-stackdriver/tree/master/custom-metrics-stackdriver-adapter) \u53ef\u8b93\u60a8\u7684\u96c6\u7fa3\u4f7f\u7528 Cloud Monitoring \u767c\u9001\u548c\u63a5\u6536\u6307\u6a19\u3002\n\u4e0d\u9069\u7528\uff1aPod \u6a6b\u5411\u81ea\u52d5\u64f4\u7e2e\u5668\u53ef\u4ee5\u6839\u64da CPU \u5229\u7528\u7387\u672c\u8eab\u9032\u884c\u64f4\u7e2e\uff0c\u56e0\u6b64\u4e0d\u9700\u8981\u81ea\u5b9a\u7fa9\u6307\u6a19\u9069\u914d\u5668\u3002\n\u7232\u60a8\u7684\u7528\u6236\u6388\u4e88\u5275\u5efa\u6240\u9700\u6388\u6b0a\u89d2\u8272\u7684\u6b0a\u9650\uff1a\n```\nkubectl create clusterrolebinding cluster-admin-binding \\\u00a0 \u00a0 --clusterrole cluster-admin --user \"$(gcloud config get-value account)\"\n```\n\u5728\u60a8\u7684\u96c6\u7fa3\u4e0a\u90e8\u7f72 **\u65b0\u8cc7\u6e90\u6a21\u578b** \u9069\u914d\u5668\uff1a\n```\nkubectl apply -f https://raw.githubusercontent.com/GoogleCloudPlatform/k8s-stackdriver/master/custom-metrics-stackdriver-adapter/deploy/production/adapter_new_resource_model.yaml\n```\n\u7232\u60a8\u7684\u7528\u6236\u6388\u4e88\u5275\u5efa\u6240\u9700\u6388\u6b0a\u89d2\u8272\u7684\u6b0a\u9650\uff1a\n```\nkubectl create clusterrolebinding cluster-admin-binding \\\u00a0 \u00a0 --clusterrole cluster-admin --user \"$(gcloud config get-value account)\"\n```\n\u5728\u60a8\u7684\u96c6\u7fa3\u4e0a\u90e8\u7f72 **\u8cc7\u6e90\u6a21\u578b** \u9069\u914d\u5668\uff1a\n```\nkubectl apply -f https://raw.githubusercontent.com/GoogleCloudPlatform/k8s-stackdriver/master/custom-metrics-stackdriver-adapter/deploy/production/adapter_new_resource_model.yaml\n```\n\u7232\u60a8\u7684\u7528\u6236\u6388\u4e88\u5275\u5efa\u6240\u9700\u6388\u6b0a\u89d2\u8272\u7684\u6b0a\u9650\uff1a\n```\nkubectl create clusterrolebinding cluster-admin-binding \\\u00a0 \u00a0 --clusterrole cluster-admin --user \"$(gcloud config get-value account)\"\n```\n\u5728\u60a8\u7684\u96c6\u7fa3\u4e0a\u90e8\u7f72 **\u820a\u8cc7\u6e90\u6a21\u578b** \u9069\u914d\u5668\uff1a\n```\nkubectl apply -f https://raw.githubusercontent.com/GoogleCloudPlatform/k8s-stackdriver/master/custom-metrics-stackdriver-adapter/deploy/production/adapter.yaml\n```\n **\u6ce8\u610f** \uff1a\u9069\u914d\u5668\u6709\u5169\u500b\u7248\u672c\uff1a\u820a\u7248\u6a21\u578b\u548c\u65b0\u8cc7\u6e90\u6a21\u578b\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1\u9069\u914d\u5668\u7684 [GitHub \u9801\u9762](https://github.com/GoogleCloudPlatform/k8s-stackdriver/tree/master/custom-metrics-stackdriver-adapter#configure-cluster) \n## \u90e8\u7f72\u5177\u6709\u6307\u6a19\u7684\u61c9\u7528\u4e0b\u8f09\u5305\u542b\u672c\u6559\u7a0b\u4f7f\u7528\u7684\u61c9\u7528\u4ee3\u78bc\u7684\u4ee3\u78bc\u5eab\uff1a\n```\ngit clone https://github.com/GoogleCloudPlatform/kubernetes-engine-samples.gitcd kubernetes-engine-samples/quickstarts/hello-app\n```\n```\ngit clone https://github.com/GoogleCloudPlatform/kubernetes-engine-samples.gitcd kubernetes-engine-samples/databases/cloud-pubsub\n```\n```\ngit clone https://github.com/GoogleCloudPlatform/kubernetes-engine-samples.gitcd kubernetes-engine-samples/observability/custom-metrics-autoscaling/direct-to-sd\n```\n```\ngit clone https://github.com/GoogleCloudPlatform/kubernetes-engine-samples.gitcd kubernetes-engine-samples/observability/custom-metrics-autoscaling/prometheus-to-sd\n```\u8a72\u4ee3\u78bc\u5eab\u5305\u542b\u7528\u65bc\u5c07\u6307\u6a19\u5c0e\u51fa\u5230 Cloud Monitoring \u7684\u4ee3\u78bc\uff1a\n\u6b64\u61c9\u7528\u6703\u5c0d\u7aef\u53e3 `8080` \u4e0a\u7684\u4efb\u4f55 Web \u8acb\u6c42\u97ff\u61c9\u201cHello, world!\u201d\u3002 [Compute Engine](https://cloud.google.com/compute/docs?hl=zh-cn) CPU \u6307\u6a19\u7531 Cloud Monitoring \u81ea\u52d5\u6536\u96c6\u3002\n [  quickstarts/hello-app/main.go ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/quickstarts/hello-app/main.go) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/quickstarts/hello-app/main.go) \n```\npackage mainimport (\u00a0 \u00a0 \u00a0 \u00a0 \"fmt\"\u00a0 \u00a0 \u00a0 \u00a0 \"log\"\u00a0 \u00a0 \u00a0 \u00a0 \"net/http\"\u00a0 \u00a0 \u00a0 \u00a0 \"os\")func main() {\u00a0 \u00a0 \u00a0 \u00a0 // register hello function to handle all requests\u00a0 \u00a0 \u00a0 \u00a0 mux := http.NewServeMux()\u00a0 \u00a0 \u00a0 \u00a0 mux.HandleFunc(\"/\", hello)\u00a0 \u00a0 \u00a0 \u00a0 // use PORT environment variable, or default to 8080\u00a0 \u00a0 \u00a0 \u00a0 port := os.Getenv(\"PORT\")\u00a0 \u00a0 \u00a0 \u00a0 if port == \"\" {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 port = \"8080\"\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 // start the web server on port and accept requests\u00a0 \u00a0 \u00a0 \u00a0 log.Printf(\"Server listening on port %s\", port)\u00a0 \u00a0 \u00a0 \u00a0 log.Fatal(http.ListenAndServe(\":\"+port, mux))}// hello responds to the request with a plain-text \"Hello, world\" message.func hello(w http.ResponseWriter, r *http.Request) {\u00a0 \u00a0 \u00a0 \u00a0 log.Printf(\"Serving request: %s\", r.URL.Path)\u00a0 \u00a0 \u00a0 \u00a0 host, _ := os.Hostname()\u00a0 \u00a0 \u00a0 \u00a0 fmt.Fprintf(w, \"Hello, world!\\n\")\u00a0 \u00a0 \u00a0 \u00a0 fmt.Fprintf(w, \"Version: 1.0.0\\n\")\u00a0 \u00a0 \u00a0 \u00a0 fmt.Fprintf(w, \"Hostname: %s\\n\", host)}\n```\n\u6b64\u61c9\u7528\u6703\u8f2a\u8a62 [Pub/Sub \u8a02\u95b1](https://cloud.google.com/pubsub/docs/subscriber?hl=zh-cn) \u4ee5\u7372\u53d6\u65b0\u6d88\u606f\uff0c\u4e26\u5728\u6d88\u606f\u5230\u9054\u6642\u5c0d\u5176\u9032\u884c\u78ba\u8a8d\u3002Pub/Sub \u8a02\u95b1\u6307\u6a19\u7531 Cloud Monitoring \u81ea\u52d5\u6536\u96c6\u3002\n [  databases/cloud-pubsub/main.py ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/databases/cloud-pubsub/main.py) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/databases/cloud-pubsub/main.py) \n```\nfrom google import authfrom google.cloud import pubsub_v1def main():\u00a0 \u00a0 \"\"\"Continuously pull messages from subsciption\"\"\"\u00a0 \u00a0 # read default project ID\u00a0 \u00a0 _, project_id = auth.default()\u00a0 \u00a0 subscription_id = 'echo-read'\u00a0 \u00a0 subscriber = pubsub_v1.SubscriberClient()\u00a0 \u00a0 subscription_path = subscriber.subscription_path(\u00a0 \u00a0 \u00a0 \u00a0 project_id, subscription_id)\u00a0 \u00a0 def callback(message: pubsub_v1.subscriber.message.Message) -> None:\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"Process received message\"\"\"\u00a0 \u00a0 \u00a0 \u00a0 print(f\"Received message: ID={message.message_id} Data={message.data}\")\u00a0 \u00a0 \u00a0 \u00a0 print(f\"[{datetime.datetime.now()}] Processing: {message.message_id}\")\u00a0 \u00a0 \u00a0 \u00a0 time.sleep(3)\u00a0 \u00a0 \u00a0 \u00a0 print(f\"[{datetime.datetime.now()}] Processed: {message.message_id}\")\u00a0 \u00a0 \u00a0 \u00a0 message.ack()\u00a0 \u00a0 streaming_pull_future = subscriber.subscribe(\u00a0 \u00a0 \u00a0 \u00a0 subscription_path, callback=callback)\u00a0 \u00a0 print(f\"Pulling messages from {subscription_path}...\")\u00a0 \u00a0 with subscriber:\u00a0 \u00a0 \u00a0 \u00a0 try:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 streaming_pull_future.result()\u00a0 \u00a0 \u00a0 \u00a0 except Exception as e:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 print(e)\n```\n\u6b64\u61c9\u7528\u6703\u4f7f\u7528 [Cloud Monitoring \u5ba2\u6236\u7aef\u5eab](https://cloud.google.com/monitoring/docs/reference/libraries?hl=zh-cn) \u5c0e\u51fa\u5e38\u91cf\u503c\u6307\u6a19\u3002\n [  observability/custom-metrics-autoscaling/direct-to-sd/sd_dummy_exporter.go ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/observability/custom-metrics-autoscaling/direct-to-sd/sd_dummy_exporter.go) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/observability/custom-metrics-autoscaling/direct-to-sd/sd_dummy_exporter.go) \n```\nfunc exportMetric(stackdriverService *monitoring.Service, metricName string,\u00a0 \u00a0 \u00a0 \u00a0 metricValue int64, metricLabels map[string]string, monitoredResource string, resourceLabels map[string]string) error {\u00a0 \u00a0 \u00a0 \u00a0 dataPoint := &monitoring.Point{\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Interval: &monitoring.TimeInterval{\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 EndTime: time.Now().Format(time.RFC3339),\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Value: &monitoring.TypedValue{\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Int64Value: &metricValue,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 // Write time series data.\u00a0 \u00a0 \u00a0 \u00a0 request := &monitoring.CreateTimeSeriesRequest{\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 TimeSeries: []*monitoring.TimeSeries{\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Metric: &monitoring.Metric{\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Type: \u00a0 \"custom.googleapis.com/\" + metricName,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Labels: metricLabels,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Resource: &monitoring.MonitoredResource{\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Type: \u00a0 monitoredResource,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Labels: resourceLabels,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Points: []*monitoring.Point{\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 dataPoint,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 projectName := fmt.Sprintf(\"projects/%s\", resourceLabels[\"project_id\"])\u00a0 \u00a0 \u00a0 \u00a0 _, err := stackdriverService.Projects.TimeSeries.Create(projectName, request).Do()\u00a0 \u00a0 \u00a0 \u00a0 return err}\n```\n\u6b64\u61c9\u7528\u6703\u4f7f\u7528 [Prometheus](https://prometheus.io/docs/instrumenting/exposition_formats/) \u683c\u5f0f\u5c0e\u51fa\u5e38\u91cf\u503c\u6307\u6a19\u3002\n [  observability/custom-metrics-autoscaling/prometheus-to-sd/prometheus_dummy_exporter.go ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/observability/custom-metrics-autoscaling/prometheus-to-sd/prometheus_dummy_exporter.go) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/observability/custom-metrics-autoscaling/prometheus-to-sd/prometheus_dummy_exporter.go) \n```\nmetric := prometheus.NewGauge(\u00a0 \u00a0 \u00a0 \u00a0 prometheus.GaugeOpts{\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Name: *metricName,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Help: \"Custom metric\",\u00a0 \u00a0 \u00a0 \u00a0 },)prometheus.MustRegister(metric)metric.Set(float64(*metricValue))http.Handle(\"/metrics\", promhttp.Handler())log.Printf(\"Starting to listen on :%d\", *port)err := http.ListenAndServe(fmt.Sprintf(\":%d\", *port), nil)\n```\n\u4ee3\u78bc\u5eab\u9084\u5305\u542b\u4e00\u500b Kubernetes \u6e05\u55ae\uff0c\u7528\u65bc\u5c07\u61c9\u7528\u90e8\u7f72\u5230\u60a8\u7684\u96c6\u7fa3\uff1a [  quickstarts/hello-app/manifests/helloweb-deployment.yaml ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/quickstarts/hello-app/manifests/helloweb-deployment.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/quickstarts/hello-app/manifests/helloweb-deployment.yaml) \n```\napiVersion: apps/v1kind: Deploymentmetadata:\u00a0 name: helloweb\u00a0 labels:\u00a0 \u00a0 app: hellospec:\u00a0 selector:\u00a0 \u00a0 matchLabels:\u00a0 \u00a0 \u00a0 app: hello\u00a0 \u00a0 \u00a0 tier: web\u00a0 template:\u00a0 \u00a0 metadata:\u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 app: hello\u00a0 \u00a0 \u00a0 \u00a0 tier: web\u00a0 \u00a0 spec:\u00a0 \u00a0 \u00a0 containers:\u00a0 \u00a0 \u00a0 - name: hello-app\u00a0 \u00a0 \u00a0 \u00a0 image: us-docker.pkg.dev/google-samples/containers/gke/hello-app:1.0\u00a0 \u00a0 \u00a0 \u00a0 ports:\u00a0 \u00a0 \u00a0 \u00a0 - containerPort: 8080\u00a0 \u00a0 \u00a0 \u00a0 resources:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 requests:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 cpu: 200m\n``` [  databases/cloud-pubsub/deployment/pubsub-with-secret.yaml ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/databases/cloud-pubsub/deployment/pubsub-with-secret.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/databases/cloud-pubsub/deployment/pubsub-with-secret.yaml) \n```\napiVersion: apps/v1kind: Deploymentmetadata:\u00a0 name: pubsubspec:\u00a0 selector:\u00a0 \u00a0 matchLabels:\u00a0 \u00a0 \u00a0 app: pubsub\u00a0 template:\u00a0 \u00a0 metadata:\u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 app: pubsub\u00a0 \u00a0 spec:\u00a0 \u00a0 \u00a0 volumes:\u00a0 \u00a0 \u00a0 - name: google-cloud-key\u00a0 \u00a0 \u00a0 \u00a0 secret:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 secretName: pubsub-key\u00a0 \u00a0 \u00a0 containers:\u00a0 \u00a0 \u00a0 - name: subscriber\u00a0 \u00a0 \u00a0 \u00a0 image: us-docker.pkg.dev/google-samples/containers/gke/pubsub-sample:v2\u00a0 \u00a0 \u00a0 \u00a0 volumeMounts:\u00a0 \u00a0 \u00a0 \u00a0 - name: google-cloud-key\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 mountPath: /var/secrets/google\u00a0 \u00a0 \u00a0 \u00a0 env:\u00a0 \u00a0 \u00a0 \u00a0 - name: GOOGLE_APPLICATION_CREDENTIALS\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 value: /var/secrets/google/key.json\n``` [  observability/custom-metrics-autoscaling/direct-to-sd/custom-metrics-sd.yaml ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/observability/custom-metrics-autoscaling/direct-to-sd/custom-metrics-sd.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/observability/custom-metrics-autoscaling/direct-to-sd/custom-metrics-sd.yaml) \n```\napiVersion: apps/v1kind: Deploymentmetadata:\u00a0 labels:\u00a0 \u00a0 run: custom-metric-sd\u00a0 name: custom-metric-sd\u00a0 namespace: defaultspec:\u00a0 replicas: 1\u00a0 selector:\u00a0 \u00a0 matchLabels:\u00a0 \u00a0 \u00a0 run: custom-metric-sd\u00a0 template:\u00a0 \u00a0 metadata:\u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 run: custom-metric-sd\u00a0 \u00a0 spec:\u00a0 \u00a0 \u00a0 containers:\u00a0 \u00a0 \u00a0 - command: [\"./sd-dummy-exporter\"]\u00a0 \u00a0 \u00a0 \u00a0 args:\u00a0 \u00a0 \u00a0 \u00a0 - --use-new-resource-model=true\u00a0 \u00a0 \u00a0 \u00a0 - --use-old-resource-model=false\u00a0 \u00a0 \u00a0 \u00a0 - --metric-name=custom-metric\u00a0 \u00a0 \u00a0 \u00a0 - --metric-value=40\u00a0 \u00a0 \u00a0 \u00a0 - --pod-name=$(POD_NAME)\u00a0 \u00a0 \u00a0 \u00a0 - --namespace=$(NAMESPACE)\u00a0 \u00a0 \u00a0 \u00a0 image: us-docker.pkg.dev/google-samples/containers/gke/sd-dummy-exporter:v0.3.0\u00a0 \u00a0 \u00a0 \u00a0 name: sd-dummy-exporter\u00a0 \u00a0 \u00a0 \u00a0 resources:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 requests:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 cpu: 100m\u00a0 \u00a0 \u00a0 \u00a0 env:\u00a0 \u00a0 \u00a0 \u00a0 # save Kubernetes metadata as environment variables for use in metrics\u00a0 \u00a0 \u00a0 \u00a0 - name: POD_NAME\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 valueFrom:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 fieldRef:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 apiVersion: v1\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 fieldPath: metadata.name\u00a0 \u00a0 \u00a0 \u00a0 - name: NAMESPACE\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 valueFrom:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 fieldRef:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 apiVersion: v1\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 fieldPath: metadata.namespace\n``` [  observability/custom-metrics-autoscaling/prometheus-to-sd/custom-metrics-prometheus-sd.yaml ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/observability/custom-metrics-autoscaling/prometheus-to-sd/custom-metrics-prometheus-sd.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/observability/custom-metrics-autoscaling/prometheus-to-sd/custom-metrics-prometheus-sd.yaml) \n```\napiVersion: apps/v1kind: Deploymentmetadata:\u00a0 labels:\u00a0 \u00a0 run: custom-metric-prometheus-sd\u00a0 name: custom-metric-prometheus-sd\u00a0 namespace: defaultspec:\u00a0 replicas: 1\u00a0 selector:\u00a0 \u00a0 matchLabels:\u00a0 \u00a0 \u00a0 run: custom-metric-prometheus-sd\u00a0 template:\u00a0 \u00a0 metadata:\u00a0 \u00a0 \u00a0 labels:\u00a0 \u00a0 \u00a0 \u00a0 run: custom-metric-prometheus-sd\u00a0 \u00a0 spec:\u00a0 \u00a0 \u00a0 containers:\u00a0 \u00a0 \u00a0 # sample container generating custom metrics\u00a0 \u00a0 \u00a0 - name: prometheus-dummy-exporter\u00a0 \u00a0 \u00a0 \u00a0 image: us-docker.pkg.dev/google-samples/containers/gke/prometheus-dummy-exporter:v0.2.0\u00a0 \u00a0 \u00a0 \u00a0 command: [\"./prometheus-dummy-exporter\"]\u00a0 \u00a0 \u00a0 \u00a0 args:\u00a0 \u00a0 \u00a0 \u00a0 - --metric-name=custom_prometheus\u00a0 \u00a0 \u00a0 \u00a0 - --metric-value=40\u00a0 \u00a0 \u00a0 \u00a0 - --port=8080\u00a0 \u00a0 \u00a0 # pre-built 'prometheus-to-sd' sidecar container to export prometheus\u00a0 \u00a0 \u00a0 # metrics to Stackdriver\u00a0 \u00a0 \u00a0 - name: prometheus-to-sd\u00a0 \u00a0 \u00a0 \u00a0 image: gcr.io/google-containers/prometheus-to-sd:v0.5.0\u00a0 \u00a0 \u00a0 \u00a0 command: [\"/monitor\"]\u00a0 \u00a0 \u00a0 \u00a0 args:\u00a0 \u00a0 \u00a0 \u00a0 - --source=:http://localhost:8080\u00a0 \u00a0 \u00a0 \u00a0 - --stackdriver-prefix=custom.googleapis.com\u00a0 \u00a0 \u00a0 \u00a0 - --pod-id=$(POD_ID)\u00a0 \u00a0 \u00a0 \u00a0 - --namespace-id=$(POD_NAMESPACE)\u00a0 \u00a0 \u00a0 \u00a0 env:\u00a0 \u00a0 \u00a0 \u00a0 # save Kubernetes metadata as environment variables for use in metrics\u00a0 \u00a0 \u00a0 \u00a0 - name: POD_ID\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 valueFrom:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 fieldRef:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 apiVersion: v1\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 fieldPath: metadata.uid\u00a0 \u00a0 \u00a0 \u00a0 - name: POD_NAMESPACE\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 valueFrom:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 fieldRef:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 fieldPath: metadata.namespace\n```\n\u5c07\u61c9\u7528\u90e8\u7f72\u5230\u60a8\u7684\u96c6\u7fa3\uff1a\n```\nkubectl apply -f manifests/helloweb-deployment.yaml\n```\n\u5728\u60a8\u7684\u9805\u76ee\u4e0a\u5553\u7528 Pub/Sub API\uff1a\n```\ngcloud services enable cloudresourcemanager.googleapis.com pubsub.googleapis.com\n```\n\u5275\u5efa Pub/Sub \u4e3b\u984c\u548c\u8a02\u95b1\uff1a\n```\ngcloud pubsub topics create echogcloud pubsub subscriptions create echo-read --topic=echo\n```\n\u5275\u5efa\u64c1\u6709 Pub/Sub \u8a2a\u554f\u6b0a\u9650\u7684\u670d\u52d9\u8cec\u865f\uff1a\n```\ngcloud iam service-accounts create autoscaling-pubsub-sagcloud projects add-iam-policy-binding $PROJECT_ID \\\u00a0 --member \"serviceAccount:autoscaling-pubsub-sa@$PROJECT_ID.iam.gserviceaccount.com\" \\\u00a0 --role \"roles/pubsub.subscriber\"\n```\n **\u6ce8\u610f** \uff1a\u4e0a\u8ff0\u670d\u52d9\u8cec\u865f\u8a2d\u7f6e\u5047\u8a2d\u96c6\u7fa3\u5df2\u505c\u7528 [Workload Identity](https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity?hl=zh-cn) \u3002 \u5982\u679c\u60a8\u7684\u96c6\u7fa3\u5df2\u5553\u7528 Workload Identity \uff0c\u5247\u9700\u8981\u57f7\u884c\u7279\u5b9a\u65bc\u670d\u52d9\u8cec\u865f\u7684\u5176\u4ed6\u6b65\u9a5f\uff0c\u5982\u6b64 [GitHub \u9801\u9762](https://github.com/GoogleCloudPlatform/k8s-stackdriver/tree/master/custom-metrics-stackdriver-adapter#configure-cluster) \u6240\u8ff0\u3002\n\u4e0b\u8f09\u670d\u52d9\u8cec\u865f\u5bc6\u9470\u6587\u4ef6\uff1a\n```\ngcloud iam service-accounts keys create key.json \\\u00a0 --iam-account autoscaling-pubsub-sa@$PROJECT_ID.iam.gserviceaccount.com\n```\n\u5c07\u670d\u52d9\u8cec\u865f\u5bc6\u9470\u4f5c\u7232 [Secret](https://kubernetes.io/docs/concepts/configuration/secret/) \u5c0e\u5165\u5230\u60a8\u7684\u96c6\u7fa3\uff1a\n```\nkubectl create secret generic pubsub-key --from-file=key.json=./key.json\n```\n\u5c07\u61c9\u7528\u90e8\u7f72\u5230\u60a8\u7684\u96c6\u7fa3\uff1a\n```\nkubectl apply -f deployment/pubsub-with-secret.yaml\n```\n```\nkubectl apply -f custom-metrics-sd.yaml\n```\n```\nkubectl apply -f custom-metrics-prometheus-sd.yaml\n```\u7b49\u5f85\u61c9\u7528\u90e8\u7f72\u5f8c\uff0c\u6240\u6709 Pod \u90fd\u9054\u5230\u4e86 `Ready` \u72c0\u614b\uff1a\n```\nkubectl get pods\n```\n\u8f38\u51fa\uff1a\n```\nNAME      READY STATUS RESTARTS AGE\nhelloweb-7f7f7474fc-hzcdq 1/1  Running 0   10s\n```\n```\nkubectl get pods\n```\n\u8f38\u51fa\uff1a\n```\nNAME      READY STATUS RESTARTS AGE\npubsub-8cd995d7c-bdhqz 1/1  Running 0   58s\n```\n```\nkubectl get pods\n```\n\u8f38\u51fa\uff1a\n```\nNAME        READY STATUS RESTARTS AGE\ncustom-metric-sd-58dbf4ffc5-tm62v 1/1  Running 0   33s\n```\n```\nkubectl get pods\n```\n\u8f38\u51fa\uff1a\n```\nNAME           READY STATUS RESTARTS AGE\ncustom-metric-prometheus-sd-697bf7c7d7-ns76p 2/2  Running 0   49s\n```## \u5728 Cloud Monitoring \u4e0a\u67e5\u770b\u6307\u6a19\u61c9\u7528\u5728\u904b\u884c\u6642\uff0c\u6703\u5c07\u60a8\u7684\u6307\u6a19\u5beb\u5165 Cloud Monitoring\u3002\n\u5982\u9700\u4f7f\u7528 Metrics Explorer \u7684 [\u9810\u89bd\u7248](https://cloud.google.com/products?hl=zh-cn#product-launch-stages) \u754c\u9762\u67e5\u770b\u53d7\u76e3\u63a7\u8cc7\u6e90\u7684\u6307\u6a19\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u9078\u64c7 **Monitoring** \uff0c\u7136\u5f8c\u9078\u64c7 **Metrics Explorer** \uff0c\u6216\u9ede\u64ca\u4ee5\u4e0b\u6309\u9215\uff1a [\u8f49\u5230 Metrics Explorer](https://console.cloud.google.com/monitoring/metrics-explorer?hl=zh-cn) \n- \u5728 **\u6307\u6a19** \u5143\u7d20\u4e2d\uff0c\u5c55\u958b **\u9078\u64c7\u6307\u6a19** \u83dc\u55ae\uff0c\u7136\u5f8c\u9078\u64c7\u8cc7\u6e90\u985e\u578b\u548c\u6307\u6a19\u985e\u578b\u3002\u4f8b\u5982\uff0c\u5982\u9700\u7e6a\u88fd\u865b\u64ec\u6a5f\u7684 CPU \u5229\u7528\u7387\u5716\u8868\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \uff08\u53ef\u9078\uff09\u5982\u9700\u6e1b\u5c11\u986f\u793a\u7684\u83dc\u55ae\u9078\u9805\uff0c\u8acb\u5728 **\u904e\u6ffe\u6b04** \u4e2d\u8f38\u5165\u90e8\u5206\u6307\u6a19\u540d\u7a31\u3002\u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u8acb\u8f38\u5165`utilization`\u3002\n- \u5728 **\u6d3b\u8e8d\u8cc7\u6e90** \u83dc\u55ae\u4e2d\uff0c\u9078\u64c7 **\u865b\u64ec\u6a5f\u5be6\u4f8b** \u3002\n- \u5728 **\u6d3b\u8e8d\u6307\u6a19\u985e\u5225** \u83dc\u55ae\u4e2d\uff0c\u9078\u64c7 **\u5be6\u4f8b** \u3002\n- \u5728 **\u6d3b\u8e8d\u6307\u6a19** \u83dc\u55ae\u4e2d\uff0c\u9078\u64c7 **CPU \u5229\u7528\u7387** \uff0c\u7136\u5f8c\u9ede\u64ca **\u61c9\u7528** \u3002- \u5982\u9700\u904e\u6ffe\u986f\u793a\u7684\u6642\u5e8f\uff0c\u8acb\u4f7f\u7528 [\u904e\u6ffe\u689d\u4ef6\u5143\u7d20](https://cloud.google.com/monitoring/charts/metrics-selector?hl=zh-cn#filter-option) \u3002\n- \u5982\u9700\u7d44\u5408\u6642\u5e8f\uff0c\u8acb\u4f7f\u7528 [\u805a\u5408\u5143\u7d20](https://cloud.google.com/monitoring/charts/metrics-selector?hl=zh-cn#select_display) \u4e0a\u7684\u83dc\u55ae\u3002\u4f8b\u5982\uff0c\u5982\u9700\u6839\u64da\u865b\u64ec\u6a5f\u6240\u5728\u7684\u53ef\u7528\u5340\u986f\u793a\u865b\u64ec\u6a5f\u7684 CPU \u5229\u7528\u7387\uff0c\u8acb\u5c07\u7b2c\u4e00\u500b\u83dc\u55ae\u8a2d\u7f6e\u7232 **\u5e73\u5747\u503c** \u4e26\u5c07\u7b2c\u4e8c\u500b\u83dc\u55ae\u8a2d\u7f6e\u7232 **\u53ef\u7528\u5340** \u3002\u7576 **\u805a\u5408** \u5143\u7d20\u7684\u7b2c\u4e00\u500b\u83dc\u55ae\u8a2d\u7f6e\u7232 **\u672a\u805a\u5408** \u6642\uff0c\u7cfb\u7d71\u6703\u986f\u793a\u6240\u6709\u6642\u5e8f\u3002 **\u805a\u5408** \u5143\u7d20\u7684\u9ed8\u8a8d\u8a2d\u7f6e\u7531\u60a8\u9078\u64c7\u7684\u6307\u6a19\u985e\u578b\u6c7a\u5b9a\u3002\n\u8cc7\u6e90\u985e\u578b\u548c\u6307\u6a19\u5982\u4e0b\u6240\u793a\uff1a\n [\u6307\u6a19\u700f\u89bd\u5668](https://console.cloud.google.com/monitoring/metrics-explorer?pageState=%7B%22xyChart%22%3A%7B%22dataSets%22%3A%5B%7B%22timeSeriesFilter%22%3A%7B%22filter%22%3A%22metric.type%3D%5C%22compute.googleapis.com%2Finstance%2Fcpu%2Futilization%5C%22+resource.type%3D%5C%22gce_instance%5C%22%22%2C%22minAlignmentPeriod%22%3A%2260s%22%2C%22unitOverride%22%3A%22ratio%22%2C%22aggregations%22%3A%5B%7B%22perSeriesAligner%22%3A%22ALIGN_MEAN%22%2C%22crossSeriesReducer%22%3A%22REDUCE_NONE%22%2C%22groupByFields%22%3A%5B%5D%7D%2C%7B%22crossSeriesReducer%22%3A%22REDUCE_NONE%22%7D%5D%7D%2C%22targetAxis%22%3A%22Y1%22%2C%22plotType%22%3A%22LINE%22%7D%5D%2C%22options%22%3A%7B%22mode%22%3A%22COLOR%22%7D%2C%22constantLines%22%3A%5B%5D%2C%22timeshiftDuration%22%3A%220s%22%2C%22y1Axis%22%3A%7B%22label%22%3A%22y1Axis%22%2C%22scale%22%3A%22LINEAR%22%7D%7D%2C%22isAutoRefresh%22%3Atrue%2C%22timeSelection%22%3A%7B%22timeRange%22%3A%221h%22%7D%7D&hl=zh-cn) \n\u8cc7\u6e90\u985e\u578b\uff1a `gce_instance`\n\u6307\u6a19\uff1a `compute.googleapis.com/instance/cpu/utilization`\n [\u6307\u6a19\u700f\u89bd\u5668](https://console.cloud.google.com/monitoring/metrics-explorer?pageState=%7B%22xyChart%22%3A%7B%22dataSets%22%3A%5B%7B%22timeSeriesFilter%22%3A%7B%22filter%22%3A%22metric.type%3D%5C%22pubsub.googleapis.com%2Fsubscription%2Fnum_undelivered_messages%5C%22+resource.type%3D%5C%22pubsub_subscription%5C%22%22%2C%22minAlignmentPeriod%22%3A%2260s%22%2C%22unitOverride%22%3A%221%22%2C%22aggregations%22%3A%5B%7B%22perSeriesAligner%22%3A%22ALIGN_MEAN%22%2C%22crossSeriesReducer%22%3A%22REDUCE_NONE%22%2C%22groupByFields%22%3A%5B%5D%7D%2C%7B%22crossSeriesReducer%22%3A%22REDUCE_NONE%22%7D%5D%7D%2C%22targetAxis%22%3A%22Y1%22%2C%22plotType%22%3A%22LINE%22%7D%5D%2C%22options%22%3A%7B%22mode%22%3A%22COLOR%22%7D%2C%22constantLines%22%3A%5B%5D%2C%22timeshiftDuration%22%3A%220s%22%2C%22y1Axis%22%3A%7B%22label%22%3A%22y1Axis%22%2C%22scale%22%3A%22LINEAR%22%7D%7D%2C%22isAutoRefresh%22%3Atrue%2C%22timeSelection%22%3A%7B%22timeRange%22%3A%221h%22%7D%7D&hl=zh-cn) \n\u8cc7\u6e90\u985e\u578b\uff1a `pubsub_subscription`\n\u6307\u6a19\uff1a `pubsub.googleapis.com/subscription/num_undelivered_messages`\n [\u6307\u6a19\u700f\u89bd\u5668](https://console.cloud.google.com/monitoring/metrics-explorer?pageState=%7B%22xyChart%22%3A%7B%22dataSets%22%3A%5B%7B%22timeSeriesFilter%22%3A%7B%22filter%22%3A%22metric.type%3D%5C%22custom.googleapis.com%2Fcustom-metric%5C%22+resource.type%3D%5C%22k8s_pod%5C%22%22%2C%22minAlignmentPeriod%22%3A%2260s%22%2C%22unitOverride%22%3A%221%22%2C%22aggregations%22%3A%5B%7B%22perSeriesAligner%22%3A%22ALIGN_MEAN%22%2C%22crossSeriesReducer%22%3A%22REDUCE_NONE%22%2C%22groupByFields%22%3A%5B%5D%7D%2C%7B%22crossSeriesReducer%22%3A%22REDUCE_NONE%22%7D%5D%7D%2C%22targetAxis%22%3A%22Y1%22%2C%22plotType%22%3A%22LINE%22%7D%5D%2C%22options%22%3A%7B%22mode%22%3A%22COLOR%22%7D%2C%22constantLines%22%3A%5B%5D%2C%22timeshiftDuration%22%3A%220s%22%2C%22y1Axis%22%3A%7B%22label%22%3A%22y1Axis%22%2C%22scale%22%3A%22LINEAR%22%7D%7D%2C%22isAutoRefresh%22%3Atrue%2C%22timeSelection%22%3A%7B%22timeRange%22%3A%221h%22%7D%7D&hl=zh-cn) \n\u8cc7\u6e90\u985e\u578b\uff1a `k8s_pod`\n\u6307\u6a19\uff1a `custom.googleapis.com/custom-metric`\n [\u6307\u6a19\u700f\u89bd\u5668](https://console.cloud.google.com/monitoring/metrics-explorer?pageState=%7B%22xyChart%22%3A%7B%22dataSets%22%3A%5B%7B%22timeSeriesFilter%22%3A%7B%22filter%22%3A%22metric.type%3D%5C%22custom.googleapis.com%2Fcustom_prometheus%5C%22+resource.type%3D%5C%22gke_container%5C%22%22%2C%22minAlignmentPeriod%22%3A%2260s%22%2C%22unitOverride%22%3A%221%22%2C%22aggregations%22%3A%5B%7B%22perSeriesAligner%22%3A%22ALIGN_MEAN%22%2C%22crossSeriesReducer%22%3A%22REDUCE_NONE%22%2C%22groupByFields%22%3A%5B%5D%7D%2C%7B%22crossSeriesReducer%22%3A%22REDUCE_NONE%22%7D%5D%7D%2C%22targetAxis%22%3A%22Y1%22%2C%22plotType%22%3A%22LINE%22%7D%5D%2C%22options%22%3A%7B%22mode%22%3A%22COLOR%22%7D%2C%22constantLines%22%3A%5B%5D%2C%22timeshiftDuration%22%3A%220s%22%2C%22y1Axis%22%3A%7B%22label%22%3A%22y1Axis%22%2C%22scale%22%3A%22LINEAR%22%7D%7D%2C%22isAutoRefresh%22%3Atrue%2C%22timeSelection%22%3A%7B%22timeRange%22%3A%221h%22%7D%7D&hl=zh-cn) \n\u8cc7\u6e90\u985e\u578b\uff1a `gke_container`\n\u6307\u6a19\uff1a `custom.googleapis.com/custom_prometheus`\n **\u6ce8\u610f** \uff1a\u6839\u64da\u6307\u6a19\uff0c\u60a8\u53ef\u80fd\u5c1a\u672a\u5728 Cloud Monitoring Metrics Explorer \u4e0a\u770b\u5230\u592a\u591a\u6d3b\u52d5\u3002\u5982\u679c\u60a8\u7684\u6307\u6a19\u6c92\u6709\u66f4\u65b0\uff0c\u7121\u9700\u611f\u5230\u610f\u5916\u3002\n## \u5275\u5efa HorizontalPodAutoscaler \u5c0d\u8c61\u5728 Cloud Monitoring \u4e2d\u770b\u5230\u6307\u6a19\u5f8c\uff0c\u60a8\u53ef\u4ee5\u90e8\u7f72 `HorizontalPodAutoscaler` \u4ee5\u6839\u64da\u6307\u6a19\u8abf\u6574 Deployment \u7684\u5927\u5c0f\u3002 [  quickstarts/hello-app/manifests/helloweb-hpa.yaml ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/quickstarts/hello-app/manifests/helloweb-hpa.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/quickstarts/hello-app/manifests/helloweb-hpa.yaml) \n```\napiVersion: autoscaling/v2kind: HorizontalPodAutoscalermetadata:\u00a0 name: cpuspec:\u00a0 scaleTargetRef:\u00a0 \u00a0 apiVersion: apps/v1\u00a0 \u00a0 kind: Deployment\u00a0 \u00a0 name: helloweb\u00a0 minReplicas: 1\u00a0 maxReplicas: 5\u00a0 metrics:\u00a0 - type: Resource\u00a0 \u00a0 resource:\u00a0 \u00a0 \u00a0 name: cpu\u00a0 \u00a0 \u00a0 target:\u00a0 \u00a0 \u00a0 \u00a0 type: Utilization\u00a0 \u00a0 \u00a0 \u00a0 averageUtilization: 30\n``` [  databases/cloud-pubsub/deployment/pubsub-hpa.yaml ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/databases/cloud-pubsub/deployment/pubsub-hpa.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/databases/cloud-pubsub/deployment/pubsub-hpa.yaml) \n```\napiVersion: autoscaling/v2beta2kind: HorizontalPodAutoscalermetadata:\u00a0 name: pubsubspec:\u00a0 minReplicas: 1\u00a0 maxReplicas: 5\u00a0 metrics:\u00a0 - external:\u00a0 \u00a0 \u00a0 metric:\u00a0 \u00a0 \u00a0 \u00a0name: pubsub.googleapis.com|subscription|num_undelivered_messages\u00a0 \u00a0 \u00a0 \u00a0selector:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0matchLabels:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0resource.labels.subscription_id: echo-read\u00a0 \u00a0 \u00a0 target:\u00a0 \u00a0 \u00a0 \u00a0 type: AverageValue\u00a0 \u00a0 \u00a0 \u00a0 averageValue: 2\u00a0 \u00a0 type: External\u00a0 scaleTargetRef:\u00a0 \u00a0 apiVersion: apps/v1\u00a0 \u00a0 kind: Deployment\u00a0 \u00a0 name: pubsub\n``` [  observability/custom-metrics-autoscaling/direct-to-sd/custom-metrics-sd-hpa.yaml ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/observability/custom-metrics-autoscaling/direct-to-sd/custom-metrics-sd-hpa.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/observability/custom-metrics-autoscaling/direct-to-sd/custom-metrics-sd-hpa.yaml) \n```\napiVersion: autoscaling/v2beta2kind: HorizontalPodAutoscalermetadata:\u00a0 name: custom-metric-sd\u00a0 namespace: defaultspec:\u00a0 scaleTargetRef:\u00a0 \u00a0 apiVersion: apps/v1\u00a0 \u00a0 kind: Deployment\u00a0 \u00a0 name: custom-metric-sd\u00a0 minReplicas: 1\u00a0 maxReplicas: 5\u00a0 metrics:\u00a0 - type: Pods\u00a0 \u00a0 pods:\u00a0 \u00a0 \u00a0 metric:\u00a0 \u00a0 \u00a0 \u00a0 name: custom-metric\u00a0 \u00a0 \u00a0 target:\u00a0 \u00a0 \u00a0 \u00a0 type: AverageValue\u00a0 \u00a0 \u00a0 \u00a0 averageValue: 20\n``` [  observability/custom-metrics-autoscaling/prometheus-to-sd/custom-metrics-prometheus-sd-hpa.yaml ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/observability/custom-metrics-autoscaling/prometheus-to-sd/custom-metrics-prometheus-sd-hpa.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/HEAD/observability/custom-metrics-autoscaling/prometheus-to-sd/custom-metrics-prometheus-sd-hpa.yaml) \n```\napiVersion: autoscaling/v2beta2kind: HorizontalPodAutoscalermetadata:\u00a0 name: custom-prometheus-hpa\u00a0 namespace: defaultspec:\u00a0 scaleTargetRef:\u00a0 \u00a0 apiVersion: apps/v1\u00a0 \u00a0 kind: Deployment\u00a0 \u00a0 name: custom-metric-prometheus-sd\u00a0 minReplicas: 1\u00a0 maxReplicas: 5\u00a0 metrics:\u00a0 - type: Pods\u00a0 \u00a0 pods:\u00a0 \u00a0 \u00a0 metric:\u00a0 \u00a0 \u00a0 \u00a0 name: custom_prometheus\u00a0 \u00a0 \u00a0 target:\u00a0 \u00a0 \u00a0 \u00a0 type: AverageValue\u00a0 \u00a0 \u00a0 \u00a0 averageValue: 20\n```\n\u5c07 `HorizontalPodAutoscaler` \u90e8\u7f72\u5230\u60a8\u7684\u96c6\u7fa3\uff1a\n```\nkubectl apply -f manifests/helloweb-hpa.yaml\n```\n```\nkubectl apply -f deployment/pubsub-hpa.yaml\n```\n```\nkubectl apply -f custom-metrics-sd-hpa.yaml\n```\n```\nkubectl apply -f custom-metrics-prometheus-sd-hpa.yaml\n```## \u751f\u6210\u8ca0\u8f09\u5c0d\u65bc\u67d0\u4e9b\u6307\u6a19\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u751f\u6210\u8ca0\u8f09\u4ee5\u76e3\u63a7\u81ea\u52d5\u64f4\u7e2e\uff1a\n\u6a21\u64ec\u767c\u9001\u5230 `helloweb` \u670d\u52d9\u5668\u7684 10,000 \u500b\u8acb\u6c42\uff1a\n```\n\u00a0kubectl exec -it deployments/helloweb -- /bin/sh -c \\\u00a0 \u00a0 \u00a0\"for i in $(seq -s' ' 1 10000); do wget -q -O- localhost:8080; done\"\n```\n\u5c07 200 \u689d\u6d88\u606f\u767c\u4f48\u5230 Pub/Sub \u4e3b\u984c\uff1a\n```\nfor i in {1..200}; do gcloud pubsub topics publish echo --message=\"Autoscaling #${i}\"; done\n```\n\u4e0d\u9069\u7528\uff1a\u6b64\u793a\u4f8b\u4e2d\u4f7f\u7528\u7684\u4ee3\u78bc\u6703\u5c0e\u51fa\u81ea\u5b9a\u7fa9\u6307\u6a19\u7684\u5e38\u91cf\u503c `40` \u3002HorizontalPodAutoscaler \u7684\u76ee\u6a19\u503c\u8a2d\u7f6e\u7232 `20` \uff0c\u56e0\u6b64\u5b83\u6703\u5617\u8a66\u81ea\u52d5\u7e31\u5411\u64f4\u5bb9 Deployment\u3002\n\u4e0d\u9069\u7528\uff1a\u6b64\u793a\u4f8b\u4e2d\u4f7f\u7528\u7684\u4ee3\u78bc\u6703\u5c0e\u51fa\u81ea\u5b9a\u7fa9\u6307\u6a19\u7684\u5e38\u91cf\u503c `40` \u3002HorizontalPodAutoscaler \u7684\u76ee\u6a19\u503c\u8a2d\u7f6e\u7232 `20` \uff0c\u56e0\u6b64\u5b83\u6703\u5617\u8a66\u81ea\u52d5\u7e31\u5411\u64f4\u5bb9 Deployment\u3002\n **\u6ce8\u610f** \uff1a\u60a8\u53ef\u80fd\u9700\u8981\u7b49\u5f85\u5e7e\u5206\u9418\uff0c\u4ee5\u4f7f HorizontalPodAutoscaler \u5c0d\u6307\u6a19\u66f4\u6539\u505a\u51fa\u97ff\u61c9\u3002\n## \u89c0\u5bdf HorizontalPodAutoscaler \u7e31\u5411\u64f4\u5bb9\u60a8\u53ef\u4ee5\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u6aa2\u67e5 Deployment \u7684\u7576\u524d\u526f\u672c\u6578\uff1a\n```\nkubectl get deployments\n```\n\u6307\u6a19\u50b3\u64ad\u4e00\u6bb5\u6642\u9593\u5f8c\uff0cDeployment \u6703\u5275\u5efa 5 \u500b Pod \u4f86\u8655\u7406\u7a4d\u58d3\u8f38\u5165\u3002\n\u60a8\u9084\u53ef\u4ee5\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4f86\u6aa2\u67e5 HorizontalPodAutoscaler \u7684\u72c0\u614b\u548c\u8fd1\u671f\u6d3b\u52d5\uff1a\n```\nkubectl describe hpa\n```## \u6e05\u9664\u6578\u64da\u7232\u907f\u514d\u56e0\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528\u7684\u8cc7\u6e90\u5c0e\u81f4\u60a8\u7684 Google Cloud \u8cec\u865f\u7522\u751f\u8cbb\u7528\uff0c\u8acb\u522a\u9664\u5305\u542b\u9019\u4e9b\u8cc7\u6e90\u7684\u9805\u76ee\uff0c\u6216\u8005\u4fdd\u7559\u9805\u76ee\u4f46\u522a\u9664\u5404\u500b\u8cc7\u6e90\u3002\n\u522a\u9664 GKE \u96c6\u7fa3\uff1a\n```\n\u00a0gcloud container clusters delete metrics-autoscaling\n```- \u6e05\u7406 Pub/Sub \u8a02\u95b1\u548c\u4e3b\u984c\uff1a```\ngcloud pubsub subscriptions delete echo-readgcloud pubsub topics delete echo\n```\n- \u522a\u9664 GKE \u96c6\u7fa3\uff1a```\ngcloud container clusters delete metrics-autoscaling\n```\n\u522a\u9664 GKE \u96c6\u7fa3\uff1a\n```\n\u00a0gcloud container clusters delete metrics-autoscaling\n```\n\u522a\u9664 GKE \u96c6\u7fa3\uff1a\n```\n\u00a0gcloud container clusters delete metrics-autoscaling\n```## \u5f8c\u7e8c\u6b65\u9a5f\n- \u8a73\u7d30\u77ad\u89e3 [\u7528\u65bc\u64f4\u7e2e\u5de5\u4f5c\u8ca0\u8f09\u7684\u81ea\u5b9a\u7fa9\u6307\u6a19\u548c\u5916\u90e8\u6307\u6a19](https://cloud.google.com/kubernetes-engine/docs/concepts/custom-and-external-metrics?hl=zh-cn) \n- \u700f\u89bd\u5176\u4ed6 [Kubernetes Engine \u6559\u7a0b](https://cloud.google.com/kubernetes-engine/docs/tutorials?hl=zh-cn) \u3002", "guide": "Google Kubernetes Engine (GKE)"}