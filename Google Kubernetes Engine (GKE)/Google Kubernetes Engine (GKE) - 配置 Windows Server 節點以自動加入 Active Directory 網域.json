{"title": "Google Kubernetes Engine (GKE) - \u914d\u7f6e Windows Server \u7bc0\u9ede\u4ee5\u81ea\u52d5\u52a0\u5165 Active Directory \u7db2\u57df", "url": "https://cloud.google.com/kubernetes-engine/docs/how-to/auto-join-windows-nodepools?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - \u914d\u7f6e Windows Server \u7bc0\u9ede\u4ee5\u81ea\u52d5\u52a0\u5165 Active Directory \u7db2\u57df\n\u672c\u9801\u9762\u4ecb\u7d39\u5982\u4f55\u5728 Google Kubernetes Engine (GKE) \u96c6\u7fa3\u4e2d\u914d\u7f6e [Windows Server \u7bc0\u9ede](https://cloud.google.com/kubernetes-engine/docs/how-to/creating-a-cluster-windows?hl=zh-cn) \uff0c\u4ee5\u81ea\u52d5\u52a0\u5165 Active Directory (AD) \u7db2\u57df\u3002\n\u5982\u679c\u60a8\u60f3\u5c07 Windows Server \u7bc0\u9ede\u52a0\u5165 [Managed Microsoft AD](https://cloud.google.com/managed-microsoft-ad/docs/overview?hl=zh-cn) \u7db2\u57df\uff0c\u4e26\u4e14\u4e0d\u9700\u8981\u5305\u542b\u96c6\u7fa3\u8a08\u7b97\u6a5f\u5c0d\u8c61\u7684\u5b89\u5168\u7fa3\u7d44\uff0c\u5247\u53ef\u4ee5\u4f7f\u7528\u81ea\u52d5\u7db2\u57df\u52a0\u5165\u529f\u80fd\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u81ea\u52d5\u5c07 GKE Windows Server \u7bc0\u9ede\u52a0\u5165 Managed Microsoft AD \u7db2\u57df](https://cloud.google.com/managed-microsoft-ad/docs/automated-domain-join-gke?hl=zh-cn) \u3002\n", "content": "## \u6e96\u5099\u5de5\u4f5c\n\u5728\u958b\u59cb\u4e4b\u524d\uff0c\u8acb\u78ba\u4fdd\u60a8\u5df2\u57f7\u884c\u4ee5\u4e0b\u4efb\u52d9\uff1a\n- \u5553\u7528 Google Kubernetes Engine API\u3002\n- [  \u5553\u7528 Google Kubernetes Engine API ](https://console.cloud.google.com/flows/enableapi?apiid=container.googleapis.com&hl=zh-cn) \n- \u5982\u679c\u60a8\u8981\u4f7f\u7528 Google Cloud CLI \u57f7\u884c\u6b64\u4efb\u52d9\uff0c\u8acb [\u5b89\u88dd](https://cloud.google.com/sdk/docs/install?hl=zh-cn) \u4e26 [\u521d\u59cb\u5316](https://cloud.google.com/sdk/docs/initializing?hl=zh-cn) gcloud CLI\u3002 \u5982\u679c\u60a8\u4e4b\u524d\u5b89\u88dd\u4e86 gcloud CLI\uff0c\u8acb\u904b\u884c`gcloud components update`\u4ee5\u7372\u53d6\u6700\u65b0\u7248\u672c\u3002 **\u6ce8\u610f** \uff1a\u5c0d\u65bc\u73fe\u6709 gcloud CLI \u5b89\u88dd\uff0c\u8acb\u52d9\u5fc5\u8a2d\u7f6e`compute/region`\u548c`compute/zone` [\u5c6c\u6027](https://cloud.google.com/sdk/docs/properties?hl=zh-cn#setting_properties) \u3002\u901a\u904e\u8a2d\u7f6e\u9ed8\u8a8d\u4f4d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u907f\u514d gcloud CLI \u4e2d\u51fa\u73fe\u4ee5\u4e0b\u932f\u8aa4\uff1a`One of [--zone, --region] must be supplied: Please specify location`\u3002\n- \u78ba\u4fdd\u60a8\u5177\u6709\u5275\u5efa\u96c6\u7fa3\u7684\u6b63\u78ba IAM \u6b0a\u9650\u3002\u60a8\u81f3\u5c11\u61c9\u662f [Kubernetes Engine Cluster Admin](https://cloud.google.com/iam/docs/understanding-roles?hl=zh-cn#kubernetes-engine-roles) \u3002## \u7232 Windows Server \u7bc0\u9ede\u6c60\u914d\u7f6e\u81ea\u52d5\u806f\u63a5\n- \u6309\u7167 [\u7232\u865b\u64ec\u6a5f\u914d\u7f6e Active Directory \u4ee5\u81ea\u52d5\u52a0\u5165\u7db2\u57df](https://cloud.google.com/solutions/configuring-active-directory-for-vms-to-automatically-join-the-domain?hl=zh-cn) \u6559\u7a0b\u4e2d\u7684\u8aaa\u660e\uff0c\u5c07 AD \u548c Google Cloud \u9805\u76ee\u914d\u7f6e\u7232\u81ea\u52d5\u52a0\u5165\u3002\n- \u5275\u5efa GKE \u96c6\u7fa3\uff1a```\ngcloud container clusters create CLUSTER_NAME \\\u00a0 \u00a0 --enable-ip-alias \\\u00a0 \u00a0 --num-nodes=NUMBER_OF_NODES \\\u00a0 \u00a0 --no-enable-shielded-nodes \\\u00a0 \u00a0 --cluster-version=VERSION\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u65b0\u96c6\u7fa3\u7684\u540d\u7a31\u3002\n- ``\uff1a\u8981\u5275\u5efa\u7684 Linux \u7bc0\u9ede\u6578\u91cf\u3002\u60a8\u61c9\u8a72\u63d0\u4f9b\u8db3\u5920\u7684\u8a08\u7b97\u8cc7\u6e90\u4ee5\u7528\u65bc\u904b\u884c\u96c6\u7fa3\u63d2\u4ef6\u3002\u9019\u662f\u4e00\u500b\u53ef\u9078\u5b57\u6bb5\uff0c\u5982\u679c\u7701\u7565\uff0c\u5247\u4f7f\u7528\u9ed8\u8a8d\u503c 3\u3002\n- ``\uff1aGKE \u96c6\u7fa3\u7248\u672c\uff0c\u5fc5\u9808\u7232 1.17.14-gke.1200 \u6216\u66f4\u9ad8\u7248\u672c\uff0c\u6216\u8005 1.18.9-gke.100 \u6216\u66f4\u9ad8\u7248\u672c\u3002\u60a8\u9084\u53ef\u4ee5\u4f7f\u7528 [--release-channel](https://cloud.google.com/sdk/gcloud/reference/container/clusters/create?hl=zh-cn#--release-channel) \u6a19\u8a8c\u5728\u767c\u4f48\u7248\u672c\u4e2d\u8a3b\u518a\u96c6\u7fa3\u3002\n- `--enable-ip-alias`\u8868\u793a\u5553\u7528 [\u5225\u540d IP](https://cloud.google.com/vpc/docs/alias-ip?hl=zh-cn) \u3002\u5225\u540d IP \u662f Windows Server \u7bc0\u9ede\u7684\u5fc5\u9700\u8a2d\u7f6e\u3002\n- `--no-enable-shielded-nodes`\u8868\u793a\u505c\u7528\u5b89\u5168\u5f37\u5316\u578b GKE \u7bc0\u9ede\u3002\n- \u8a2d\u7f6e\u4ee5\u4e0b\u8b8a\u91cf\uff1a```\nexport DOMAIN_PROJECT_ID=PROJECT_ID\nexport SERVERLESS_REGION=REGION\nexport REGISTER_URL=https://$SERVERLESS_REGION-$DOMAIN_PROJECT_ID.cloudfunctions.net/register-computer\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1a\u60a8\u7684\u7db2\u57df\u9805\u76ee\u7684 [\u9805\u76ee ID](https://cloud.google.com/resource-manager/docs/creating-managing-projects?hl=zh-cn) \u3002\n- ``\uff1a\u8981\u5728\u5176\u4e2d [\u90e8\u7f72 Cloud Functions \u51fd\u6578](https://cloud.google.com/solutions/configuring-active-directory-for-vms-to-automatically-join-the-domain?hl=zh-cn) \u7684\u5340\u57df\u3002\u9078\u64c7\u652f\u6301 [Cloud Functions](https://cloud.google.com/functions/docs/locations?hl=zh-cn) \u548c [\u7121\u670d\u52d9\u5668 VPC \u8a2a\u554f\u901a\u9053](https://cloud.google.com/vpc/docs/configure-serverless-vpc-access?hl=zh-cn#supported_regions) \u7684\u5340\u57df\u3002\u8a72\u5730\u5340\u4e0d\u4e00\u5b9a\u5f97\u662f\u60a8\u8a08\u5283\u5728\u5176\u4e2d\u90e8\u7f72\u865b\u64ec\u6a5f\u5be6\u4f8b\u7684\u5730\u5340\u3002\n- \u901a\u904e\u50b3\u905e\u5c07\u7bc0\u9ede\u7684\u9023\u63a5\u5230 AD \u7db2\u57df\u7684\u5c08\u7528 scriptlet \u5275\u5efa\u4e26\u5553\u52d5 Windows Server \u7bc0\u9ede\u6c60\uff1a```\n\u00a0gcloud container node-pools create NODE_POOL_NAME \\\u00a0 \u00a0 --cluster=CLUSTER_NAME \\\u00a0 \u00a0 --image-type=IMAGE_NAME \\\u00a0 \u00a0 --no-enable-autoupgrade \\\u00a0 \u00a0 --machine-type=MACHINE_TYPE_NAME \\\u00a0 \u00a0 \"--metadata=sysprep-specialize-script-ps1=iex((New-Object System.Net.WebClient).DownloadString('$REGISTER_URL'))\"\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- ``\uff1aWindows Server \u7bc0\u9ede\u6c60\u7684\u540d\u7a31\u3002\n- ``\uff1a\u60a8\u5275\u5efa\u7684\u96c6\u7fa3\u7684\u540d\u7a31\u3002\n- ``\uff1a\u8981\u4f7f\u7528\u7684\u7bc0\u9ede\u6620\u50cf\uff0c\u4f8b\u5982`WINDOWS_LTSC_CONTAINERD`\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u9078\u64c7 Windows Server \u7bc0\u9ede\u6620\u50cf](https://cloud.google.com/kubernetes-engine/docs/how-to/creating-a-cluster-windows?hl=zh-cn#choose_your_windows_server_node_image) \u3002\n- ``\uff1a\u6a5f\u5668\u985e\u578b\u3002`n1-standard-2`\u662f\u5efa\u8b70\u6a5f\u5668\u985e\u578b\u7684\u6700\u4f4e\u8981\u6c42\uff0c\u56e0\u7232 Windows Server \u7bc0\u9ede\u9700\u8981\u66f4\u591a\u8cc7\u6e90\u3002\u4e0d\u652f\u6301`f1-micro`\u548c`g1-small`\u6a5f\u5668\u985e\u578b\u3002\u6bcf\u7a2e\u6a5f\u5668\u985e\u578b\u7684\u8a08\u8cbb\u65b9\u5f0f\u90fd\u5404\u4e0d\u76f8\u540c\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u6a5f\u5668\u985e\u578b\u50f9\u683c\u8868](https://cloud.google.com/compute/pricing?hl=zh-cn#standard_machine_types) \u3002\u60a8\u7684 Windows Server \u7bc0\u9ede\u73fe\u5df2\u52a0\u5165 Active Directory \u7db2\u57df\u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u5982\u8981\u5c07\u7fa3\u7d44\u7ba1\u7406\u7684\u670d\u52d9\u8cec\u865f (gMSA) \u8207 Windows Server \u7bc0\u9ede\u6c60\u4e00\u8d77\u4f7f\u7528\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528 gMSA](https://cloud.google.com/kubernetes-engine/docs/how-to/creating-a-cluster-windows?hl=zh-cn#using_gmsa) \u3002\n- \u77ad\u89e3 [Managed Service for Microsoft Active Directory](https://cloud.google.com/managed-microsoft-ad/docs/overview?hl=zh-cn) \u3002", "guide": "Google Kubernetes Engine (GKE)"}