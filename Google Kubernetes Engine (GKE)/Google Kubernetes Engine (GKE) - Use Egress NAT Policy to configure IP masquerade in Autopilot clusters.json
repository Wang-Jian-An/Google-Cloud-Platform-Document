{"title": "Google Kubernetes Engine (GKE) - Use Egress NAT Policy to configure IP masquerade in Autopilot clusters", "url": "https://cloud.google.com/kubernetes-engine/docs/how-to/egress-nat-policy-ip-masq-autopilot", "abstract": "# Google Kubernetes Engine (GKE) - Use Egress NAT Policy to configure IP masquerade in Autopilot clusters\nThis page explains how to configure clusters created in the Google Kubernetes Engine (GKE) Autopilot mode to perform [IP masquerade](/kubernetes-engine/docs/concepts/ip-masquerade-agent) with the Egress NAT Policy.\nFor more information about IP masquerading in GKE Standard mode, see [Configure an IP masquerade agent](/kubernetes-engine/docs/how-to/ip-masquerade-agent) .\n", "content": "## Overview\nThe GKE lets you configure the IP masquerade behavior for Autopilot clusters.\nGKE supports two automatically generated Egress NAT policies:\n- Managed by GKE that are fixed and are not editable.\n- Default policies that are editable.\nThis page shows you how to edit and deploy an Egress NAT policy by either editing the default policy or by creating an Egress NAT policy. This page also shows you how to delete a created Egress NAT policy.\nFor more information about Egress NAT policy behavior, see the [trafficmasquerade behavior for Autopilot clusters](/kubernetes-engine/docs/concepts/ip-masquerade-agent#egress-nat-policy) .\n## Before you begin\nBefore you start, make sure you have performed the following tasks:\n- Enable    the Google Kubernetes Engine API.\n- [    Enable Google Kubernetes Engine API   ](https://console.cloud.google.com/flows/enableapi?apiid=container.googleapis.com) \n- If you want to use the Google Cloud CLI for this task, [install](/sdk/docs/install) and then [initialize](/sdk/docs/initializing) the  gcloud CLI. If you previously installed the gcloud CLI, get the latest  version by running`gcloud components update`. **Note:** For existing gcloud CLI  installations, make sure to set the`compute/region`and`compute/zone` [properties](/sdk/docs/properties#setting_properties) . By setting default locations,  you can avoid errors in gcloud CLI like the following:`One of [--zone, --region] must be supplied: Please specify location`.\n- Ensure that you have an Autopilot cluster running version 1.23.4-gke.1600 or later, or 1.22.7-gke.1500 or later. Your cluster must have [GKE Dataplane V2 enabled](/kubernetes-engine/docs/how-to/dataplane-v2#create-cluster) .\n- Ensure that your cluster has a workload running. For more information, see [how to request resources](/kubernetes-engine/docs/concepts/autopilot-resource-requests#how-to-request) .## Check Egress NAT policy status\nYou can check if your cluster is running the Egress NAT policy custom resource definition (CRD) by using the Google Cloud CLI tool:\n- Get the credentials for your cluster:```\ngcloud container clusters get-credentials CLUSTER-NAME\n```Replace `` with the name of the cluster.\n- Check if the Egress NAT policy is running:```\nkubectl get crds egressnatpolicies.networking.gke.io\n```If the Egress NAT policy is running, then the output is similar to the following:```\n NAME         CREATED AT\n egressnatpolicies.networking.gke.io 2022-03-16T21:05:43Z\n```\n- Get the list of the created Egress NAT policies:```\nkubectl get egressnatpolicies\n```The output is similar to the following:```\n NAME    AGE\n default   44h\n gke-bbfa6c0e-1 44h\n```## Edit the existing default policy\nGKE supports two automatically generated NAT policies, [defaultpolicy](/kubernetes-engine/docs/concepts/ip-masquerade-agent#default-policy) and [managed by GKE policy](/kubernetes-engine/docs/concepts/ip-masquerade-agent#managed-by-gke-policy) . The default policy is editable and it configures the [default non-masquerade destinations](/kubernetes-engine/docs/concepts/ip-masquerade-agent#default-non-masq-dests) .\nTo edit the existing default policy, perform the following steps:\n- Get the credentials for your cluster:```\ngcloud container clusters get-credentials CLUSTER_NAME\n```Replace `` with the name of your cluster.\n- Edit the default Egress NAT policy:```\nkubectl edit egressnatpolicies default\n```\n- Add or remove destinations with the NoSNAT action as a `cidr` attribute in [CIDR format](https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing) .:```\n\u00a0 apiVersion: networking.gke.io/v1\u00a0 kind: EgressNATPolicy\u00a0 metadata:\u00a0 \u00a0 name: default\u00a0 spec:\u00a0 \u00a0 action: NoSNAT\u00a0 \u00a0 destinations:\u00a0 \u00a0 - cidr: \u00a010.0.0.0/8\u00a0 \u00a0 - cidr: \u00a0172.16.0.0/12\u00a0 \u00a0 - cidr: \u00a0192.168.0.0/16\u00a0 \u00a0 - cidr: \u00a0240.0.0.0/4\u00a0 \u00a0 - cidr: \u00a0192.0.2.0/24\u00a0 \u00a0 - cidr: \u00a0198.51.100.0/24\u00a0 \u00a0 - cidr: \u00a0203.0.113.0/24\u00a0 \u00a0 - cidr: \u00a0100.64.0.0/10\u00a0 \u00a0 - cidr: \u00a0198.18.0.0/15\u00a0 \u00a0 - cidr: \u00a0192.0.0.0/24\u00a0 \u00a0 - cidr: \u00a0192.88.99.0/24\n```When packets are sent to these destinations, your cluster does not masquerade IP address sources and preserves source Pod IP addresses.\n- Verify the edited default policy is deployed by checking the Kubernetes events:```\nkubectl get events\n```The output is similar to the following:```\nLAST SEEN TYPE  REASON   OBJECT     MESSAGE\n13s   Normal EnsuringPolicy egressnatpolicy/default Ensuring IP masquerade config for policy \"default\"\n```Your changes might take up to three minutes to apply.## Deploy a new Egress NAT policy\nTo add new destinations with the NoSNAT action, you can use one of the following options:\n- You can [edit the existing default policy](#edit-default-egress-nat-policy) .\n- You can create a new Egress NAT policy.\nTo create a new Egress NAT policy that is not part of the default policy, perform the following steps:\n- Save the following manifest as `egress_nat_policy.yaml` :```\nkind: EgressNATPolicyapiVersion: networking.gke.io/v1metadata:\u00a0 name: POLICY_NAMEspec:\u00a0 action: NoSNAT\u00a0 destinations:\u00a0 - cidr: CIDR_1\u00a0 - cidr: CIDR_2\n```Replace the following:- ``: the name of your new policy.\n- ``and``: the IP address ranges in [CIDR format](https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing) . When packets are sent to these destinations, your cluster does not masquerade IP address sources and preserves source Pod IP addresses. If you need more than two CIDRs, add more entries to the`destinations`list following the same format.\n- Deploy the new policy:```\nkubectl create -f egress_nat_policy.yaml\n```\n- Verify your policy is deployed by checking the Kubernetes events:```\nkubectl get events\n```The output is similar to the following:```\nLAST SEEN TYPE  REASON   OBJECT        MESSAGE\n13s   Normal EnsuringPolicy egressnatpolicy/mypolicy   Ensuring IP masquerade config for policy \"mypolicy\"\n```## Delete an Egress NAT policy\nTo completely delete an Egress NAT policy, run the following command:\n```\nkubectl delete egressnatpolicies POLICY_NAME\n```\nReplace `` with the name the policy you want to delete.\n**Note:** We recommend that you do not delete the default Egress NAT policy because it contains the default ranges of CIDR that might be required for the cluster to preserve its operation. For more information about default the Egress NAT policy, see [Egress NAT automatically generated policies](https://cloud.google.com/kubernetes-engine/docs/concepts/ip-masquerade-agent#automatically_generated_policies)\n## What's next\n- [Learn how to create a VPC-native cluster](/kubernetes-engine/docs/how-to/alias-ips) .\n- [Read the GKE network overview](/kubernetes-engine/docs/concepts/network-overview) .\n- [Learn about configuring authorized networks](/kubernetes-engine/docs/how-to/authorized-networks) .", "guide": "Google Kubernetes Engine (GKE)"}