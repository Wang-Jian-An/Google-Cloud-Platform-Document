{"title": "Google Kubernetes Engine (GKE) - \u4f7f\u7528 Kueue \u90e8\u7f72\u6279\u8655\u7406\u7cfb\u7d71", "url": "https://cloud.google.com/kubernetes-engine/docs/tutorials/kueue-intro?hl=zh-cn", "abstract": "# Google Kubernetes Engine (GKE) - \u4f7f\u7528 Kueue \u90e8\u7f72\u6279\u8655\u7406\u7cfb\u7d71\n\u672c\u6559\u7a0b\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528\n [Kueue](https://kueue.sigs.k8s.io) \n\u90e8\u7f72\u6279\u8655\u7406\u7cfb\u7d71\u4ee5\u57f7\u884c\n [Job](https://kubernetes.io/docs/concepts/workloads/controllers/job/) \n\u5728 Google Kubernetes Engine (GKE) \u4e0a\u7684\u6392\u968a\u64cd\u4f5c\u3002\u5b8c\u6210\u672c\u6559\u7a0b\uff0c\u77ad\u89e3\u5982\u4f55\u8a2d\u7f6e GKE \u548c Kueue\uff0c\u5728\u5148\u9032\u5148\u51fa (FIFO) \u6a21\u578b\u904b\u884c Job\u3002\n", "content": "## \u80cc\u666fJob \u662f\u904b\u884c\u5230\u5b8c\u6210\u7684\u61c9\u7528\uff0c\u4f8b\u5982\u6a5f\u5668\u5b78\u7fd2\u3001\u6e32\u67d3\u3001\u6a21\u64ec\u3001\u5206\u6790\u3001CI/CD \u548c\u985e\u4f3c\u5de5\u4f5c\u8ca0\u8f09\u3002\nKueue \u662f\u4e00\u500b Cloud Native Job \u8abf\u5ea6\u5668\uff0c\u4f7f\u7528\u9ed8\u8a8d\u7684 Kubernetes \u8abf\u5ea6\u5668\u3001Job \u63a7\u5236\u5668\u548c\u96c6\u7fa3\u81ea\u52d5\u64f4\u7e2e\u5668\u4f86\u63d0\u4f9b\u7aef\u5230\u7aef\u6279\u8655\u7406\u7cfb\u7d71\u3002Kueue \u6703\u6839\u64da\u914d\u984d\u548c\u5c64\u6b21\u7d50\u69cb\uff0c\u5728\u5718\u968a\u4e4b\u9593\u5171\u4eab\u8cc7\u6e90\uff0c\u5f9e\u800c\u5be6\u73fe Job \u6392\u968a\uff0c\u78ba\u5b9a Job \u61c9\u7b49\u5f85\u7684\u6642\u9593\u548c\u61c9\u958b\u59cb\u7684\u6642\u9593\u3002\nKueue \u5177\u6709\u4ee5\u4e0b\u7279\u5fb5\uff1a- \u5b83\u91dd\u5c0d\u96f2\u67b6\u69cb\u9032\u884c\u4e86\u512a\u5316\uff0c\u5176\u4e2d\u8cc7\u6e90\u662f\u7570\u69cb\u3001\u53ef\u4e92\u63db\u4e14\u53ef\u64f4\u7e2e\u3002\n- \u5b83\u63d0\u4f9b\u4e86\u4e00\u7d44 API\uff0c\u7528\u65bc\u7ba1\u7406\u5f48\u6027\u914d\u984d\u548c\u7ba1\u7406 Job \u968a\u5217\u3002\n- \u5b83\u4e0d\u6703\u91cd\u65b0\u5be6\u73fe\u81ea\u52d5\u64f4\u7e2e\u3001Pod \u8abf\u5ea6\u6216 Job \u751f\u547d\u9031\u671f\u7ba1\u7406\u7b49\u73fe\u6709\u529f\u80fd\u3002\n- Kueue \u5167\u7f6e\u4e86\u5c0d Kubernetes`batch/v1.Job`API \u7684\u652f\u6301\u3002\n- \u5b83\u53ef\u4ee5\u8207\u5176\u4ed6\u4f5c\u696d API \u96c6\u6210\u3002\nKueue \u6703\u5c07\u4efb\u4f55 API \u5b9a\u7fa9\u7684\u4f5c\u696d\u7528\u4f5c\u5de5\u4f5c\u8ca0\u8f09\uff0c\u4ee5\u907f\u514d\u8207\u7279\u5b9a Kubernetes Job API \u6df7\u6dc6\u3002## \u76ee\u6a19\u672c\u6559\u7a0b\u9069\u5408\u9700\u8981\u5728 Kubernetes \u4e0a\u5be6\u73fe\u6279\u8655\u7406\u7cfb\u7d71\u7684\u96c6\u7fa3\u904b\u7dad\u4eba\u54e1\u548c\u5176\u4ed6\u7528\u6236\u3002\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u7232\u5169\u500b\u79df\u6236\u5718\u968a\u8a2d\u7f6e\u5171\u4eab\u96c6\u7fa3\u3002\u6bcf\u500b\u5718\u968a\u90fd\u6709\u81ea\u5df1\u7684\u547d\u540d\u7a7a\u9593\uff0c\u7528\u65bc\u5275\u5efa Job \u4e26\u5171\u4eab\u7531\u76f8\u61c9\u914d\u984d\u63a7\u5236\u7684\u5168\u5c40\u8cc7\u6e90\u3002\n\u672c\u6559\u7a0b\u4ecb\u7d39\u4ee5\u4e0b\u6b65\u9a5f\uff1a- \u5275\u5efa GKE \u96c6\u7fa3\n- \u5275\u5efa [ResourceFlavor](https://kueue.sigs.k8s.io/docs/concepts/resource_flavor/) \n- \u5275\u5efa [ClusterQueue](https://kueue.sigs.k8s.io/docs/concepts/cluster_queue/) \n- \u5275\u5efa [LocalQueue](https://kueue.sigs.k8s.io/docs/concepts/local_queue/) \n- \u5275\u5efa Job \u4e26\u89c0\u5bdf\u5141\u8a31\u7684\u5de5\u4f5c\u8ca0\u8f09\n## \u8cbb\u7528\n\u672c\u6559\u7a0b\u4f7f\u7528 Google Cloud \u7684\u4ee5\u4e0b\u6536\u8cbb\u7d44\u4ef6\uff1a\n- [GKE](https://cloud.google.com/kubernetes-engine/pricing?hl=zh-cn) \n\u60a8\u53ef\u4f7f\u7528 [\u50f9\u683c\u8a08\u7b97\u5668](https://cloud.google.com/products/calculator?hl=zh-cn) \u6839\u64da\u60a8\u7684\u9810\u8a08\u4f7f\u7528\u60c5\u6cc1\u4f86\u4f30\u7b97\u8cbb\u7528\u3002\n\u5b8c\u6210\u672c\u6559\u7a0b\u5f8c\uff0c\u8acb\u522a\u9664\u60a8\u5275\u5efa\u7684\u8cc7\u6e90\uff0c\u4ee5\u907f\u514d\u7e7c\u7e8c\u8a08\u8cbb\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u6e05\u7406](#clean-up) \u3002## \u6e96\u5099\u5de5\u4f5c\n### \u8a2d\u7f6e\u9805\u76ee\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n### \u8a2d\u7f6e Google Cloud CLI \u7684\u9ed8\u8a8d\u503c\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u5553\u52d5 Cloud Shell \u5be6\u4f8b\uff1a  [\u6253\u958b Cloud Shell](https://console.cloud.google.com/?cloudshell=true&hl=zh-cn) \n- \u4e0b\u8f09\u6b64\u793a\u4f8b\u61c9\u7528\u7684\u6e90\u4ee3\u78bc\uff1a```\ngit clone https://github.com/GoogleCloudPlatform/kubernetes-engine-samplescd kubernetes-engine-samples/batch/kueue-intro\n```\n- \u8a2d\u7f6e\u9ed8\u8a8d\u74b0\u5883\u8b8a\u91cf\uff1a```\ngcloud config set project PROJECT_IDgcloud config set compute/region COMPUTE_REGION\n```\u66ff\u63db\u4ee5\u4e0b\u503c\uff1a- \uff1a\u60a8\u7684 Google Cloud [\u9805\u76ee ID](https://cloud.google.com/resource-manager/docs/creating-managing-projects?hl=zh-cn#identifying_projects) \u3002\n- \uff1a [Compute Engine \u5340\u57df](https://cloud.google.com/compute/docs/regions-zones?hl=zh-cn#available) \u3002## \u5275\u5efa GKE \u96c6\u7fa3\n- \u5275\u5efa\u540d\u7232 `kueue-autopilot` \u7684 GKE Autopilot \u96c6\u7fa3\uff1a```\ngcloud container clusters create-auto kueue-autopilot \\\u00a0 --release-channel \"rapid\" --region COMPUTE_REGION\n```Autopilot \u96c6\u7fa3\u662f\u5168\u4ee3\u7ba1\u5f0f\uff0c\u4e26\u5177\u6709\u5167\u7f6e\u81ea\u52d5\u64f4\u7e2e\u529f\u80fd\u3002\u8a73\u7d30\u77ad\u89e3 [GKE Autopilot](https://cloud.google.com/kubernetes-engine/docs/concepts/autopilot-overview?hl=zh-cn) \u3002Kueue \u9084\u652f\u6301\u4f7f\u7528\u7bc0\u9ede\u81ea\u52d5\u9810\u914d\u529f\u80fd\u548c\u6a19\u6e96\u81ea\u52d5\u64f4\u7e2e\u7bc0\u9ede\u6c60\u7684\u6a19\u6e96 GKE\u3002 **\u6ce8\u610f** \uff1aAutopilot \u96c6\u7fa3\u5275\u5efa\u904e\u7a0b\u6700\u591a\u53ef\u80fd\u9700\u8981\u4e94\u5206\u9418\u624d\u80fd\u5b8c\u6210\u3002\u5275\u5efa\u96c6\u7fa3\u540e\uff0c\u7d50\u679c\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\n NAME: kueue-autopilot\n LOCATION: us-central1\n MASTER_VERSION: 1.26.2-gke.1000\n MASTER_IP: 35.193.173.228\n MACHINE_TYPE: e2-medium\n NODE_VERSION: 1.26.2-gke.1000\n NUM_NODES: 3\n STATUS: RUNNING\n```\u5176\u4e2d\uff0c `kueue-autopilot` \u7684 `STATUS` \u662f `RUNNING` \u3002\n- \u7372\u53d6\u7528\u65bc\u96c6\u7fa3\u7684\u8eab\u4efd\u9a57\u8b49\u6191\u64da```\ngcloud container clusters get-credentials kueue-autopilot\n```\n- \u5728\u96c6\u7fa3\u4e0a\u5b89\u88dd Kueue\uff1a```\nVERSION=VERSIONkubectl apply --server-side -f \\\u00a0 https://github.com/kubernetes-sigs/kueue/releases/download/$VERSION/manifests.yaml\n```\u5c07 \u66ff\u63db\u7232\u6700\u65b0\u7248\u672c\u7684 Kueue\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3 Kueue \u7248\u672c\uff0c\u8acb\u53c3\u95b1 [Kueue \u7248\u672c](https://github.com/kubernetes-sigs/kueue/releases) \u3002\n- \u7b49\u5f85 Kueue Pod \u6e96\u5099\u5c31\u7dd2\uff1a```\nwatch kubectl -n kueue-system get pods\n```\u5728\u7e7c\u7e8c\u4e0b\u4e00\u6b65\u4e4b\u524d\uff0c\u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nNAME          READY STATUS RESTARTS AGE\nkueue-controller-manager-66d8bb946b-wr2l2 2/2  Running 0   3m36s\n``` **\u6ce8\u610f** \uff1a\u6b64\u6b65\u9a5f\u53ef\u80fd\u9700\u8981\u9577\u9054\u4e09\u5206\u9418\u3002\n- \u5275\u5efa\u5169\u500b\u540d\u7232 `team-a` \u548c `team-b` \u7684\u65b0\u547d\u540d\u7a7a\u9593\uff1a```\nkubectl create namespace team-akubectl create namespace team-b\n```\n## \u5275\u5efa ResourceFlavorResourceFlavor \u662f\u4e00\u7a2e\u5c0d\u8c61\uff0c\u7528\u65bc\u8868\u793a\u96c6\u7fa3\u5167\u7bc0\u9ede\u7684\u8b8a\u9ad4\uff0c\u5373\u5c07\u5b83\u5011\u8207\u7bc0\u9ede\u6a19\u7c64\u548c\u6c61\u9ede\u76f8\u95dc\u806f\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 ResourceFlavor \u8868\u793a\u5177\u6709\u4e0d\u540c\u9810\u914d\u4fdd\u8b49\uff08\u4f8b\u5982 Spot \u8207\u6309\u9700\uff09\u3001\u67b6\u69cb\uff08\u4f8b\u5982 x86 \u8207 ARM CPU\uff09\u3001\u54c1\u724c\u548c\u578b\u865f\uff08\u4f8b\u5982 Nvidia A100 \u8207 T4 GPU\uff09\u7684\u865b\u64ec\u6a5f\u3002\n\u5728\u672c\u6559\u7a0b\u4e2d\uff0c `kueue-autopilot` \u96c6\u7fa3\u5177\u6709\u540c\u69cb\u8cc7\u6e90\u3002\u56e0\u6b64\uff0c\u8acb\u7232 CPU\u3001\u5167\u5b58\u3001\u81e8\u6642\u5b58\u5132\u548c GPU \u5275\u5efa\u4e00\u500b ResourceFlavor\uff0c\u800c\u4e0d\u4f7f\u7528\u6a19\u7c64\u6216\u6c61\u9ede\u3002\n [  batch/kueue-intro/flavors.yaml ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/main/batch/kueue-intro/flavors.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/main/batch/kueue-intro/flavors.yaml) \n```\napiVersion: kueue.x-k8s.io/v1beta1kind: ResourceFlavormetadata:\u00a0 name: default-flavor # This ResourceFlavor will be used for all the resources\n```\n\u90e8\u7f72 ResourceFlavor\uff1a\n```\nkubectl apply -f flavors.yaml\n```## \u5275\u5efa ClusterQueueClusterQueue \u662f\u96c6\u7fa3\u7d1a\u5c0d\u8c61\uff0c\u7528\u65bc\u7ba1\u7406 CPU\u3001\u5167\u5b58\u3001GPU \u7b49\u8cc7\u6e90\u6c60\u3002\u5b83\u8ca0\u8cac\u7ba1\u7406 ResourceFlavor\uff0c\u4e26\u9650\u5236\u5176\u7528\u91cf\u4e26\u6c7a\u5b9a\u5de5\u4f5c\u8ca0\u8f09\u7684\u5141\u8a31\u9806\u5e8f\u3002\n [  batch/kueue-intro/cluster-queue.yaml ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/main/batch/kueue-intro/cluster-queue.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/main/batch/kueue-intro/cluster-queue.yaml) \n```\napiVersion: kueue.x-k8s.io/v1beta1kind: ClusterQueuemetadata:\u00a0 name: cluster-queuespec:\u00a0 namespaceSelector: {} # Available to all namespaces\u00a0 queueingStrategy: BestEffortFIFO # Default queueing strategy\u00a0 resourceGroups:\u00a0 - coveredResources: [\"cpu\", \"memory\", \"nvidia.com/gpu\", \"ephemeral-storage\"]\u00a0 \u00a0 flavors:\u00a0 \u00a0 - name: \"default-flavor\"\u00a0 \u00a0 \u00a0 resources:\u00a0 \u00a0 \u00a0 - name: \"cpu\"\u00a0 \u00a0 \u00a0 \u00a0 nominalQuota: 10\u00a0 \u00a0 \u00a0 - name: \"memory\"\u00a0 \u00a0 \u00a0 \u00a0 nominalQuota: 10Gi\u00a0 \u00a0 \u00a0 - name: \"nvidia.com/gpu\"\u00a0 \u00a0 \u00a0 \u00a0 nominalQuota: 10\u00a0 \u00a0 \u00a0 - name: \"ephemeral-storage\"\u00a0 \u00a0 \u00a0 \u00a0 nominalQuota: 10Gi\n```\n\u90e8\u7f72 ClusterQueue\uff1a\n```\nkubectl apply -f cluster-queue.yaml\n```\n\u4f7f\u7528\u9806\u5e8f\u7531 `.spec.queueingStrategy` \u78ba\u5b9a\uff0c\u5176\u4e2d\u6709\u5169\u7a2e\u914d\u7f6e\uff1a- BestEffortFIFO- \u9ed8\u8a8d\u6392\u968a\u7b56\u7565\u914d\u7f6e\u3002\n- \u5de5\u4f5c\u8ca0\u8f09\u51c6\u5165\u9075\u5faa\u5148\u9032\u5148\u51fa (FIFO) \u898f\u5247\uff0c\u4f46\u5982\u679c\u914d\u984d\u4e0d\u8db3\u4ee5\u5141\u8a31\u968a\u5217\u982d\u90e8\u7684\u5de5\u4f5c\u8ca0\u8f09\uff0c\u5247\u5c07\u5617\u8a66\u968a\u5217\u4e2d\u7684\u4e0b\u4e00\u9805\u5de5\u4f5c\u8ca0\u8f09\u3002\n- StrictFIFO- \u4fdd\u8b49 FIFO \u8a9e\u7fa9\u3002\n- \u968a\u5217\u982d\u90e8\u7684\u5de5\u4f5c\u8ca0\u8f09\u53ef\u4ee5\u963b\u6b62\u5c07\u66f4\u591a\u5de5\u4f5c\u8ca0\u8f09\u52a0\u5165\u968a\u5217\uff0c\u76f4\u5230\u8a72\u5de5\u4f5c\u8ca0\u8f09\u7372\u5f97\u51c6\u5165\u8a31\u53ef\u3002\n\u5728 `cluster-queue.yaml` \u4e2d\uff0c\u60a8\u53ef\u4ee5\u5275\u5efa\u4e00\u500b\u540d\u7232 `cluster-queue` \u7684\u65b0 ClusterQueue\u3002\u6b64 ClusterQueue \u4f7f\u7528 `flavors.yaml` \u4e2d\u5275\u5efa\u7684\u8b8a\u7a2e\u7ba1\u7406\u56db\u500b\u8cc7\u6e90\uff1a `cpu` \u3001 `memory` \u3001 `nvidia.com/gpu` \u548c `ephemeral-storage` \u3002\u914d\u984d\u7531\u5de5\u4f5c\u8ca0\u8f09 Pod \u898f\u7bc4\u4e2d\u7684\u8acb\u6c42\u4f7f\u7528\u3002\n\u6bcf\u500b\u8b8a\u7a2e\u90fd\u5305\u542b\u8868\u793a\u7232 `.spec.resourceGroups[].flavors[].resources[].nominalQuota` \u7684\u4f7f\u7528\u9650\u5236\u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u7576\u4e14\u50c5\u7576\u6eff\u8db3\u4ee5\u4e0b\u689d\u4ef6\u6642\uff0cClusterQueue \u624d\u5141\u8a31\u5de5\u4f5c\u8ca0\u8f09\uff1a- CPU \u8acb\u6c42\u7684\u7e3d\u548c\u5c0f\u65bc\u6216\u7b49\u65bc 10\n- \u5167\u5b58\u8acb\u6c42\u7684\u7e3d\u548c\u5c0f\u65bc\u6216\u7b49\u65bc 10Gi\n- GPU \u8acb\u6c42\u7684\u7e3d\u548c\u5c0f\u65bc\u6216\u7b49\u65bc 10\n- \u4f7f\u7528\u7684\u5b58\u5132\u7a7a\u9593\u7e3d\u548c\u5c0f\u65bc\u6216\u7b49\u65bc 10Gi\n## \u5275\u5efa LocalQueueLocalQueue \u662f\u4e00\u500b\u547d\u540d\u7a7a\u9593\u5c0d\u8c61\uff0c\u63a5\u53d7\u4f86\u81ea\u547d\u540d\u7a7a\u9593\u4e2d\u7528\u6236\u7684\u5de5\u4f5c\u8ca0\u8f09\u3002\u4e0d\u540c\u547d\u540d\u7a7a\u9593\u7684 LocalQueue \u53ef\u4ee5\u6307\u5411\u540c\u4e00\u500b ClusterQueue\uff0c\u5b83\u5011\u53ef\u4ee5\u5728\u5176\u4e2d\u5171\u4eab\u8cc7\u6e90\u7684\u914d\u984d\u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u547d\u540d\u7a7a\u9593 `team-a` \u548c `team-b` \u4e2d\u7684 LocalQueue \u6307\u5411 `.spec.clusterQueue` \u4e0b\u7684\u540c\u4e00 ClusterQueue `cluster-queue` \u3002\n [  batch/kueue-intro/local-queue.yaml ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/main/batch/kueue-intro/local-queue.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/main/batch/kueue-intro/local-queue.yaml) \n```\napiVersion: kueue.x-k8s.io/v1beta1kind: LocalQueuemetadata:\u00a0 namespace: team-a # LocalQueue under team-a namespace\u00a0 name: lq-team-aspec:\u00a0 clusterQueue: cluster-queue # Point to the ClusterQueue---apiVersion: kueue.x-k8s.io/v1beta1kind: LocalQueuemetadata:\u00a0 namespace: team-b # LocalQueue under team-b namespace\u00a0 name: lq-team-bspec:\u00a0 clusterQueue: cluster-queue # Point to the ClusterQueue\n```\n\u6bcf\u500b\u5718\u968a\u90fd\u5728\u5176\u547d\u540d\u7a7a\u9593\u4e2d\u5c07\u5176\u5de5\u4f5c\u8ca0\u8f09\u767c\u9001\u5230 LocalQueue\u3002\u7136\u5f8c\uff0cClusterQueue \u6703\u5206\u914d\u9019\u4e9b\u8cc7\u6e90\u3002\n\u90e8\u7f72 LocalQueue\uff1a\n```\nkubectl apply -f local-queue.yaml\n```## \u5275\u5efa Job \u4e26\u89c0\u5bdf\u5141\u8a31\u7684\u5de5\u4f5c\u8ca0\u8f09 [  batch/kueue-intro/job-team-a.yaml ](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/main/batch/kueue-intro/job-team-a.yaml) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/main/batch/kueue-intro/job-team-a.yaml) \n```\napiVersion: batch/v1kind: Jobmetadata:\u00a0 namespace: team-a # Job under team-a namespace\u00a0 generateName: sample-job-team-a-\u00a0 annotations:\u00a0 \u00a0 kueue.x-k8s.io/queue-name: lq-team-a # Point to the LocalQueuespec:\u00a0 ttlSecondsAfterFinished: 60 # Job will be deleted after 60 seconds\u00a0 parallelism: 3 # This Job will have 3 replicas running at the same time\u00a0 completions: 3 # This Job requires 3 completions\u00a0 suspend: true # Set to true to allow Kueue to control the Job when it starts\u00a0 template:\u00a0 \u00a0 spec:\u00a0 \u00a0 \u00a0 nodeSelector:\u00a0 \u00a0 \u00a0 \u00a0 cloud.google.com/gke-accelerator: \"nvidia-tesla-t4\" # Specify the GPU hardware\u00a0 \u00a0 \u00a0 containers:\u00a0 \u00a0 \u00a0 - name: dummy-job\u00a0 \u00a0 \u00a0 \u00a0 image: gcr.io/k8s-staging-perf-tests/sleep:latest\u00a0 \u00a0 \u00a0 \u00a0 args: [\"10s\"] # Sleep for 10 seconds\u00a0 \u00a0 \u00a0 \u00a0 resources:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 requests:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 cpu: \"500m\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 memory: \"512Mi\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ephemeral-storage: \"512Mi\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 nvidia.com/gpu: \"1\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 limits:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 cpu: \"500m\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 memory: \"512Mi\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ephemeral-storage: \"512Mi\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 nvidia.com/gpu: \"1\"\u00a0 \u00a0 \u00a0 restartPolicy: Never\n```\n\u5728\u547d\u540d\u7a7a\u9593 `team-a` \u4e0b\u5275\u5efa Job\u3002\u6b64 Job \u6307\u5411 LocalQueue `lq-team-a` \u3002\u7232\u4e86\u8acb\u6c42 GPU \u8cc7\u6e90\uff0c `nodeSelector` \u6703\u8a2d\u7f6e\u7232 `nvidia-tesla-t4` \u3002\nJob \u7531\u4e09\u500b Pod \u4e26\u884c\u4f11\u7720 10 \u79d2\u7d44\u6210\u3002\u6839\u64da `ttlSecondsAfterFinished` \uff0cJob \u6703\u5728 60 \u79d2\u5f8c\u6e05\u7406\u3002\n\u6b64 Job \u9700\u8981 1500 milliCPU\u30011536 Mi \u5167\u5b58\u30011536 Mi \u81e8\u6642\u5b58\u5132\u7a7a\u9593\u548c\u4e09\u500b GPU\uff0c\u56e0\u7232\u6709\u4e09\u500b Pod\u3002\nJob \u9084\u5728\u6587\u4ef6 [job-team-b.yaml](https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/blob/main/batch/kueue-intro/job-team-b.yaml) \uff08\u5176\u547d\u540d\u7a7a\u9593\u5c6c\u65bc `team-b` \uff09\u4e0b\u5275\u5efa\uff0c\u5176\u4e2d\u8acb\u6c42\u8868\u793a\u5177\u6709\u4e0d\u540c\u9700\u6c42\u7684\u4e0d\u540c\u5718\u968a\u3002\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5728 Autopilot \u4e2d\u90e8\u7f72 GPU \u5de5\u4f5c\u8ca0\u8f09](https://cloud.google.com/kubernetes-engine/docs/how-to/autopilot-gpus?hl=zh-cn) \u3002- \u5728\u65b0\u7d42\u7aef\u4e2d\uff0c\u89c0\u5bdf\u6bcf\u5169\u79d2\u9418\u5237\u65b0\u4e00\u6b21\u7684 ClusterQueue \u7684\u72c0\u614b\uff1a```\nwatch -n 2 kubectl get clusterqueue cluster-queue -o wide\n```\n- \u5728\u65b0\u7d42\u7aef\u4e2d\uff0c\u89c0\u5bdf\u7bc0\u9ede\u7684\u72c0\u614b\uff1a```\nwatch -n 2 kubectl get nodes -o wide\n```\n- \u5728\u65b0\u7d42\u7aef\u4e2d\uff0c\u6bcf 10 \u79d2\u5f9e\u547d\u540d\u7a7a\u9593 `team-a` \u548c `team-b` \u5275\u5efa\u5230 LocalQueue \u7684 Job\uff1a```\n./create_jobs.sh job-team-a.yaml job-team-b.yaml 10\n```\n- \u89c0\u5bdf\u6b63\u5728\u6392\u968a\u7684 Job\u3001\u5728 ClusterQueue \u4e2d\u5141\u8a31\u7684 Job\uff0c\u4ee5\u53ca\u4f7f\u7528 GKE Autopilot \u5553\u52d5\u7684\u7bc0\u9ede\u3002 **\u6ce8\u610f** \uff1a\u5728\u7bc0\u9ede\u7e31\u5411\u64f4\u5bb9\u6642\uff0c\u51fa\u73fe Pod \u7684\u8b66\u544a\uff08\u767c\u51fa\u6d88\u606f `Unschedulable` \uff09\u662f\u6b63\u5e38\u7684\u3002\n- \u5f9e\u547d\u540d\u7a7a\u9593 `team-a` \u7372\u53d6 Job\uff1a```\nkubectl -n team-a get jobs\n```\u7d50\u679c\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff1a```\nNAME      COMPLETIONS DURATION AGE\nsample-job-team-b-t6jnr 3/3   21s  3m27s\nsample-job-team-a-tm7kc 0/3      2m27s\nsample-job-team-a-vjtnw 3/3   30s  3m50s\nsample-job-team-b-vn6rp 0/3      40s\nsample-job-team-a-z86h2 0/3      2m15s\nsample-job-team-b-zfwj8 0/3      28s\nsample-job-team-a-zjkbj 0/3      4s\nsample-job-team-a-zzvjg 3/3   83s  4m50s\n```\n- \u8907\u88fd\u4e0a\u4e00\u6b65\u4e2d\u7684 Job \u540d\u7a31\uff0c\u4e26\u901a\u904e Workloads API \u89c0\u5bdf Job \u7684\u51c6\u5165\u72c0\u614b\u548c\u4e8b\u4ef6\uff1a```\nkubectl -n team-a describe workload JOB_NAME\n```\n- \u7576\u5f85\u8655\u7406 Job \u958b\u59cb\u5f9e ClusterQueue \u589e\u52a0\u6642\uff0c\u8acb\u5728\u6b63\u5728\u904b\u884c\u7684\u8173\u672c\u4e0a\u6309 `CTRL + C` \u7d50\u675f\u8173\u672c\u3002\n- \u5b8c\u6210\u6240\u6709 Job \u5f8c\uff0c\u8acb\u6ce8\u610f\u7bc0\u9ede\u662f\u5426\u7e2e\u6e1b\u3002 **\u6ce8\u610f** \uff1a\u7e31\u5411\u7e2e\u5bb9\u6d41\u7a0b\u6700\u591a\u53ef\u80fd\u9700\u8981\u5169\u5206\u9418\u3002\n## \u6e05\u7406\u7232\u907f\u514d\u56e0\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528\u7684\u8cc7\u6e90\u5c0e\u81f4\u60a8\u7684 Google Cloud \u8cec\u865f\u7522\u751f\u8cbb\u7528\uff0c\u8acb\u522a\u9664\u5305\u542b\u9019\u4e9b\u8cc7\u6e90\u7684\u9805\u76ee\uff0c\u6216\u8005\u4fdd\u7559\u9805\u76ee\u4f46\u522a\u9664\u5404\u500b\u8cc7\u6e90\u3002\n### \u522a\u9664\u9805\u76ee- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- **\u8b66\u544a** \uff1a\u522a\u9664\u9805\u76ee\u6703\u7522\u751f\u4ee5\u4e0b\u5f71\u97ff- **\u9805\u76ee\u4e2d\u7684\u6240\u6709\u5167\u5bb9\u90fd\u6703\u88ab\u522a\u9664\u3002** \u5982\u679c\u60a8\u5c07\u73fe\u6709\u9805\u76ee\u7528\u65bc\u672c\u6587\u6a94\u4e2d\u7684\u4efb\u52d9\uff0c\u5247\u522a\u9664\u8a72\u9805\u76ee\u5f8c\uff0c\u9084\u5c07\u522a\u9664\u60a8\u5df2\u5728\u8a72\u9805\u76ee\u4e2d\u5b8c\u6210\u7684\u4efb\u4f55\u5176\u4ed6\u5de5\u4f5c\u3002\n- **\u81ea\u5b9a\u7fa9\u9805\u76ee ID \u4e1f\u5931\u3002** \u5275\u5efa\u6b64\u9805\u76ee\u6642\uff0c\u60a8\u53ef\u80fd\u5275\u5efa\u4e86\u8981\u5728\u5c07\u4f86\u4f7f\u7528\u7684\u81ea\u5b9a\u7fa9\u9805\u76ee ID\u3002\u8981\u4fdd\u7559\u4f7f\u7528\u8a72\u9805\u76ee ID \u7684\u7db2\u5740\uff08\u4f8b\u5982`appspot.com`\u7db2\u5740\uff09\uff0c\u8acb\u522a\u9664\u9805\u76ee\u5167\u7684\u6240\u9078\u8cc7\u6e90\uff0c\u800c\u4e0d\u662f\u522a\u9664\u6574\u500b\u9805\u76ee\u3002\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u9032\u5165 **\u7ba1\u7406\u8cc7\u6e90** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u7ba1\u7406\u8cc7\u6e90\u201d](https://console.cloud.google.com/iam-admin/projects?hl=zh-cn) \n- \u5728\u9805\u76ee\u5217\u8868\u4e2d\uff0c\u9078\u64c7\u8981\u522a\u9664\u7684\u9805\u76ee\uff0c\u7136\u5f8c\u9ede\u64ca **\u522a\u9664** \u3002\n- \u5728\u5c0d\u8a71\u6846\u4e2d\u8f38\u5165\u9805\u76ee ID\uff0c\u7136\u5f8c\u9ede\u64ca **\u95dc\u9589** \u4ee5\u522a\u9664\u9805\u76ee\u3002\n### \u9010\u500b\u522a\u9664\u8cc7\u6e90\n- \u522a\u9664 Kueue \u914d\u984d\u7cfb\u7d71\uff1a```\nkubectl delete -n team-a localqueue lq-team-akubectl delete -n team-b localqueue lq-team-bkubectl delete clusterqueue cluster-queuekubectl delete resourceflavor default-flavor\n```\n- \u522a\u9664 Kueue \u6e05\u55ae\uff1a```\nVERSION=VERSIONkubectl delete -f \\\u00a0 https://github.com/kubernetes-sigs/kueue/releases/download/$VERSION/manifests.yaml\n```\n- \u522a\u9664\u96c6\u7fa3\uff1a```\ngcloud container clusters delete kueue-autopilot --region=COMPUTE_REGION\n```\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u67e5\u770b [GKE \u6587\u6a94](https://cloud.google.com/kubernetes-engine/docs/concepts/kubernetes-engine-overview?hl=zh-cn) \u3002\n- \u8a73\u7d30\u77ad\u89e3 [\u4f5c\u696d](https://kubernetes.io/docs/concepts/workloads/controllers/job/) \u3002\n- [\u8a73\u7d30\u77ad\u89e3 Kueue](https://kueue.sigs.k8s.io/) \n- \u77ad\u89e3\u5982\u4f55 [\u8a2d\u7f6e Kueue \u4ee5\u5728\u547d\u540d\u7a7a\u9593\u4e4b\u9593\u5171\u4eab\u914d\u984d](https://cloud.google.com/kubernetes-engine/docs/tutorials/kueue-cohort?hl=zh-cn)", "guide": "Google Kubernetes Engine (GKE)"}