{"title": "Vertex AI - \u5c07 Vertex AI TensorBoard \u8207 Vertex AI Pipelines \u642d\u914d\u4f7f\u7528", "url": "https://cloud.google.com/vertex-ai/docs/experiments/tensorboard-with-pipelines?hl=zh-cn", "abstract": "# Vertex AI - \u5c07 Vertex AI TensorBoard \u8207 Vertex AI Pipelines \u642d\u914d\u4f7f\u7528\n\u5982\u9700\u67e5\u770b TensorBoard \u8207\u6d41\u6c34\u7dda\u96c6\u6210\u7684\u793a\u4f8b\uff0c\u8acb\u5728\u4ee5\u4e0b\u4efb\u4e00\u74b0\u5883\u4e2d\u904b\u884c\u201cVertex AI TensorBoard \u8207 Vertex AI Pipelines \u7684\u96c6\u6210\u201dJupyter \u7b46\u8a18\u672c\uff1a [\u5728 Colab \u4e2d\u904b\u884c](https://colab.research.google.com/github/GoogleCloudPlatform/vertex-ai-samples/blob/main/notebooks/official/tensorboard/tensorboard_vertex_ai_pipelines_integration.ipynb?hl=zh-cn) | [\u5728 Vertex AI Workbench \u7528\u6236\u7ba1\u7406\u7684\u7b46\u8a18\u672c\u4e2d\u6253\u958b](https://console.cloud.google.com/vertex-ai/workbench/deploy-notebook?download_url=https%3A%2F%2Fraw.githubusercontent.com%2FGoogleCloudPlatform%2Fvertex-ai-samples%2Fmain%2Fnotebooks%2Fofficial%2Ftensorboard%2Ftensorboard_vertex_ai_pipelines_integration.ipynb&hl=zh-cn) | [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/vertex-ai-samples/blob/main/notebooks/official/tensorboard/tensorboard_vertex_ai_pipelines_integration.ipynb)\n\u60a8\u7684\u8a13\u7df4\u4ee3\u78bc\u53ef\u4ee5\u6253\u5305\u5230\u81ea\u5b9a\u7fa9\u8a13\u7df4\u7d44\u4ef6\u4e2d\uff0c\u4e26\u5728\u6d41\u6c34\u7dda\u4f5c\u696d\u4e2d\u904b\u884c\u3002TensorBoard \u65e5\u8a8c\u6703\u81ea\u52d5\u6d41\u5f0f\u50b3\u8f38\u5230 Vertex AI TensorBoard \u5be6\u9a57\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u6b64\u96c6\u6210\u4f86\u8fd1\u4e4e\u5be6\u6642\u5730\u76e3\u63a7\u8a13\u7df4\uff0c\u56e0\u7232 Vertex AI TensorBoard \u6703\u5728\u5beb\u5165 Cloud Storage \u6642\u6d41\u5f0f\u50b3\u8f38 Vertex AI TensorBoard \u65e5\u8a8c\u3002\n\u5982\u9700\u77ad\u89e3\u521d\u59cb\u8a2d\u7f6e\uff0c\u8acb\u53c3\u95b1 [\u7232 Vertex AI TensorBoard \u8a2d\u7f6e](https://cloud.google.com/vertex-ai/docs/experiments/tensorboard-setup?hl=zh-cn) \u3002\n#", "content": "## \u5c0d\u8a13\u7df4\u8173\u672c\u7684\u66f4\u6539\n\u60a8\u7684\u8a13\u7df4\u8173\u672c\u5fc5\u9808\u914d\u7f6e\u7232\u5c07 TensorBoard \u65e5\u8a8c\u5beb\u5165 Cloud Storage \u5b58\u5132\u6876\uff0c\u5373 Vertex AI \u8a13\u7df4\u670d\u52d9\u901a\u904e\u9810\u5b9a\u7fa9\u7684\u74b0\u5883\u8b8a\u91cf ` **AIP_TENSORBOARD_LOG_DIR** ` \u81ea\u52d5\u63d0\u4f9b\u7684\u4f4d\u7f6e\u3002\n\u9019\u901a\u5e38\u53ef\u4ee5\u901a\u904e\u5c07 `os.environ['AIP_TENSORBOARD_LOG_DIR']` \u4f5c\u7232\u65e5\u8a8c\u76ee\u9304\u63d0\u4f9b\u7d66\u958b\u6e90 TensorBoard \u65e5\u8a8c\u5beb\u5165 API \u4f86\u5be6\u73fe\u3002 `AIP_TENSORBOARD_LOG_DIR` \u7684\u4f4d\u7f6e\u901a\u5e38\u4f7f\u7528 `staging_bucket` \u8b8a\u91cf\u8a2d\u7f6e\u3002\n\u5982\u9700\u5728 TensorFlow 2.x \u4e2d\u914d\u7f6e\u8a13\u7df4\u8173\u672c\uff0c\u8acb\u5275\u5efa TensorBoard \u56de\u8abf\u4e26\u5c07 `log_dir` \u8b8a\u91cf\u8a2d\u7f6e\u7232 `os.environ['AIP_TENSORBOARD_LOG_DIR']` \u3002\u7136\u5f8c\uff0cTensorBoard \u56de\u8abf\u6703\u6dfb\u52a0\u5230 TensorFlow `model.fit` \u56de\u8abf\u5217\u8868\u4e2d\u3002\n```\n\u00a0 tensorboard_callback = tf.keras.callbacks.TensorBoard(\u00a0 \u00a0 \u00a0 \u00a0log_dir=os.environ['AIP_TENSORBOARD_LOG_DIR'],\u00a0 \u00a0 \u00a0 \u00a0histogram_freq=1\u00a0 )\u00a0 model.fit(\u00a0 \u00a0 \u00a0 \u00a0x=x_train,\u00a0 \u00a0 \u00a0 \u00a0y=y_train,\u00a0 \u00a0 \u00a0 \u00a0epochs=epochs,\u00a0 \u00a0 \u00a0 \u00a0validation_data=(x_test, y_test),\u00a0 \u00a0 \u00a0 \u00a0callbacks=[tensorboard_callback],\u00a0 )\u00a0 \n```\n\u8a73\u7d30\u77ad\u89e3 [Vertex AI](https://cloud.google.com/vertex-ai/docs/training/code-requirements?hl=zh-cn#environment-variables) \u5982\u4f55\u5728\u81ea\u5b9a\u7fa9\u8a13\u7df4\u74b0\u5883\u4e2d\u8a2d\u7f6e\u74b0\u5883\u8b8a\u91cf\u3002\n### \u69cb\u5efa\u4e26\u904b\u884c\u6d41\u6c34\u7dda\n\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u77ad\u5982\u4f55\u4f7f\u7528 Kubeflow Pipelines DSL \u8edf\u4ef6\u5305\u69cb\u5efa\u548c\u904b\u884c\u6d41\u6c34\u7dda\u3002\u5982\u9700\u67e5\u770b\u66f4\u591a\u793a\u4f8b\u548c\u5176\u4ed6\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 [Vertex AI Pipelines \u6587\u6a94](https://cloud.google.com/vertex-ai/docs/pipelines?hl=zh-cn) \u3002\n\u5c07\u8a13\u7df4\u4ee3\u78bc\u6253\u5305\u5230\u81ea\u5b9a\u7fa9\u7d44\u4ef6\u4e2d\uff0c\u78ba\u4fdd\u4ee3\u78bc\u5df2\u914d\u7f6e\u7232\u5c07 TensorBoard \u65e5\u8a8c\u5beb\u5165 Cloud Storage \u5b58\u5132\u6876\u3002\u5982\u9700\u67e5\u770b\u66f4\u591a\u793a\u4f8b\uff0c\u8acb\u53c3\u95b1 [\u69cb\u5efa\u81ea\u5df1\u7684\u6d41\u6c34\u7dda\u7d44\u4ef6](https://cloud.google.com/vertex-ai/docs/pipelines/build-own-components?hl=zh-cn) \u3002\n```\nfrom kfp.v2.dsl import component@component(\u00a0 \u00a0 base_image=\"tensorflow/tensorflow:latest\",\u00a0 \u00a0 packages_to_install=[\"tensorflow_datasets\"],)def train_tensorflow_model_with_tensorboard():\u00a0 \u00a0 import datetime, os\u00a0 \u00a0 import tensorflow as tf\u00a0 \u00a0 (x_train, y_train), (x_test, y_test) = tf.keras.datasets.mnist.load_data()\u00a0 \u00a0 x_train, x_test = x_train / 255.0, x_test / 255.0\u00a0 \u00a0 def create_model():\u00a0 \u00a0 \u00a0 \u00a0 return tf.keras.models.Sequential(\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 [\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 tf.keras.layers.Flatten(input_shape=(28, 28)),\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 tf.keras.layers.Dense(512, activation=\"relu\"),\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 ]\u00a0 \u00a0 \u00a0 \u00a0 )\u00a0 \u00a0 model = create_model()\u00a0 \u00a0 model.compile(\u00a0 \u00a0 \u00a0 \u00a0 optimizer=\"adam\",\u00a0 \u00a0 \u00a0 \u00a0 loss=\"sparse_categorical_crossentropy\",\u00a0 \u00a0 \u00a0 \u00a0 metrics=[\"accuracy\"]\u00a0 \u00a0 )\u00a0 \u00a0 tensorboard_callback = tf.keras.callbacks.TensorBoard(\u00a0 \u00a0 \u00a0 \u00a0 log_dir=os.environ['AIP_TENSORBOARD_LOG_DIR'],\u00a0 \u00a0 \u00a0 \u00a0 histogram_freq=1\u00a0 \u00a0 )\u00a0 \u00a0 model.fit(\u00a0 \u00a0 \u00a0 \u00a0 x=x_train,\u00a0 \u00a0 \u00a0 \u00a0 y=y_train,\u00a0 \u00a0 \u00a0 \u00a0 epochs=5,\u00a0 \u00a0 \u00a0 \u00a0 validation_data=(x_test, y_test),\u00a0 \u00a0 \u00a0 \u00a0 callbacks=[tensorboard_callback],\u00a0 \u00a0 )\n```\n\u901a\u904e\u5728 `create_custom_training_job_op_from_component` \u4e2d\u6307\u5b9a\u7d44\u4ef6\u898f\u7bc4\uff0c\u5f9e\u60a8\u5275\u5efa\u7684\u7d44\u4ef6\u5275\u5efa\u81ea\u5b9a\u7fa9\u8a13\u7df4\u4f5c\u696d\u3002\u5c07 `tensorboard_resource_name` \u8a2d\u7f6e\u7232 TensorBoard \u5be6\u4f8b\uff0c\u4e26\u5c07 `staging_bucket` \u8a2d\u7f6e\u7232\u5728 API \u8abf\u7528\u671f\u9593\u66ab\u5b58\u5de5\u4ef6\u7684\u4f4d\u7f6e\uff08\u5305\u62ec TensorBoard \u65e5\u8a8c\uff09\u3002\n\u7136\u5f8c\uff0c\u69cb\u5efa\u6d41\u6c34\u7dda\u4ee5\u5305\u542b\u6b64\u4f5c\u696d\uff0c\u4e26\u5c07\u6d41\u6c34\u7dda\u7de8\u8b6f\u7232 JSON \u6587\u4ef6\u3002\n\u5982\u9700\u67e5\u770b\u66f4\u591a\u793a\u4f8b\u548c\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 [\u81ea\u5b9a\u7fa9\u4f5c\u696d\u7d44\u4ef6](https://cloud.google.com/vertex-ai/docs/pipelines/customjob-component?hl=zh-cn) \u548c [\u69cb\u5efa\u6d41\u6c34\u7dda](https://cloud.google.com/vertex-ai/docs/pipelines/build-pipeline?hl=zh-cn) \u3002\n```\nfrom kfp.v2 import compilerfrom google_cloud_pipeline_components.v1.custom_job.utils import \\\u00a0 \u00a0 create_custom_training_job_op_from_componentfrom kfp.v2 import dsldef create_tensorboard_pipeline_sample(\u00a0 \u00a0 project, location, staging_bucket, display_name, service_account, experiment, tensorboard_resource_name):\u00a0 \u00a0 @dsl.pipeline(\u00a0 \u00a0 \u00a0 \u00a0 pipeline_root=f\"{staging_bucket}/pipeline_root\",\u00a0 \u00a0 \u00a0 \u00a0 name=display_name,\u00a0 \u00a0 )\u00a0 \u00a0 def pipeline():\u00a0 \u00a0 \u00a0 \u00a0 custom_job_op = create_custom_training_job_op_from_component(\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 component_spec=train_tensorflow_model_with_tensorboard,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 tensorboard=tensorboard_resource_name,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 base_output_directory=staging_bucket,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 service_account=service_account,\u00a0 \u00a0 \u00a0 \u00a0 )\u00a0 \u00a0 \u00a0 \u00a0 custom_job_op(project=project, location=location)\u00a0 \u00a0 compiler.Compiler().compile(\u00a0 \u00a0 \u00a0 \u00a0 pipeline_func=pipeline, package_path=f\"{display_name}.json\"\u00a0 \u00a0 )\n```\n\u4f7f\u7528 Python \u7248 Vertex AI SDK \u63d0\u4ea4\u6d41\u6c34\u7dda\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u904b\u884c\u6d41\u6c34\u7dda](https://cloud.google.com/vertex-ai/docs/pipelines/run-pipeline?hl=zh-cn#vertex-ai-sdk-for-python) \u3002### Python [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/googleapis/python-aiplatform/blob/HEAD/samples/model-builder/experiment_tracking/log_pipeline_job_to_experiment_sample.py) \n```\ndef log_pipeline_job_to_experiment_sample(\u00a0 \u00a0 experiment_name: str,\u00a0 \u00a0 pipeline_job_display_name: str,\u00a0 \u00a0 template_path: str,\u00a0 \u00a0 pipeline_root: str,\u00a0 \u00a0 project: str,\u00a0 \u00a0 location: str,\u00a0 \u00a0 parameter_values: Optional[Dict[str, Any]] = None,):\u00a0 \u00a0 aiplatform.init(project=project, location=location)\u00a0 \u00a0 pipeline_job = aiplatform.PipelineJob(\u00a0 \u00a0 \u00a0 \u00a0 display_name=pipeline_job_display_name,\u00a0 \u00a0 \u00a0 \u00a0 template_path=template_path,\u00a0 \u00a0 \u00a0 \u00a0 pipeline_root=pipeline_root,\u00a0 \u00a0 \u00a0 \u00a0 parameter_values=parameter_values,\u00a0 \u00a0 )\u00a0 \u00a0 pipeline_job.submit(experiment=experiment_name)\n```\n- `experiment_name`\uff1a\u63d0\u4f9b\u5be6\u9a57\u7684\u540d\u7a31\u3002\n- `pipeline_job_display_name`\uff1a\u6d41\u6c34\u7dda\u4f5c\u696d\u7684\u986f\u793a\u540d\u3002\n- `template_path`\uff1a\u5df2\u7de8\u8b6f\u7684\u6d41\u6c34\u7dda\u6a21\u677f\u7684\u8def\u5f91\u3002\n- `pipeline_root`\uff1a\u6307\u5b9a\u6d41\u6c34\u7dda\u670d\u52d9\u8cec\u865f\u53ef\u4ee5\u8a2a\u554f\u7684 Cloud Storage URI\u3002\u6d41\u6c34\u7dda\u904b\u884c\u7684\u5de5\u4ef6\u5b58\u5132\u5728\u6d41\u6c34\u7dda\u6839\u76ee\u9304\u4e2d\u3002\n- `parameter_values`\uff1a\u8981\u50b3\u905e\u7d66\u6b64\u904b\u884c\u7684\u6d41\u6c34\u7dda\u53c3\u6578\u3002\u4f8b\u5982\uff0c\u5275\u5efa\u4e00\u500b`dict()`\uff0c\u4ee5\u53c3\u6578\u540d\u7a31\u7232\u5b57\u5178\u9375\uff0c\u4ee5\u53c3\u6578\u503c\u7232\u5b57\u5178\u503c\u3002\n- `project`\uff1a\u60a8\u7684 [\u9805\u76ee ID](https://cloud.google.com/resource-manager/docs/creating-managing-projects?hl=zh-cn#identifiers) \u3002 \u8981\u5728\u5176\u4e2d\u904b\u884c\u6d41\u6c34\u7dda\u7684 Google Cloud \u9805\u76ee\u3002\u60a8\u53ef\u4ee5\u5728 Google Cloud \u63a7\u5236\u6aaf\u7684 [\u6b61\u8fce](https://console.cloud.google.com/welcome?hl=zh-cn) \u9801\u9762\u4e2d\u627e\u5230\u60a8\u7684 ID\u3002\n- `location`\uff1a\u9700\u8981\u5728\u5176\u4e2d\u904b\u884c\u6d41\u6c34\u7dda\u7684\u5340\u57df\u3002\u8a72\u5340\u57df\u61c9\u8207\u60a8\u4f7f\u7528\u7684 TensorBoard \u5be6\u4f8b\u76f8\u540c\u3002## \u5f8c\u7e8c\u6b65\u9a5f\n- \u67e5\u770b\u7d50\u679c\uff1a [\u67e5\u770b Vertex AI Pipelines \u7684 TensorBoard](https://cloud.google.com/vertex-ai/docs/experiments/tensorboard-view?hl=zh-cn#vertex-ai-pipelines) \u3002\n- \u77ad\u89e3\u5982\u4f55\u4f7f\u7528 [Vertex AI TensorBoard Profiler](https://cloud.google.com/vertex-ai/docs/training/tensorboard-profiler?hl=zh-cn) \u512a\u5316\u81ea\u5b9a\u7fa9\u8a13\u7df4\u4f5c\u696d\u7684\u6027\u80fd\u3002", "guide": "Vertex AI"}