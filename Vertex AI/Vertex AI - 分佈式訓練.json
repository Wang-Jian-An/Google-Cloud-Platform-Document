{"title": "Vertex AI - \u5206\u4f48\u5f0f\u8a13\u7df4", "url": "https://cloud.google.com/vertex-ai/docs/training/distributed-training?hl=zh-cn", "abstract": "# Vertex AI - \u5206\u4f48\u5f0f\u8a13\u7df4\n\u672c\u9801\u9762\u4ecb\u7d39\u5982\u4f55\u5728 Vertex AI \u4e0a\u904b\u884c\u5206\u4f48\u5f0f\u8a13\u7df4\u4f5c\u696d\u3002\n", "content": "## \u4ee3\u78bc\u8981\u6c42\n\u4f7f\u7528\u652f\u6301\u5206\u4f48\u5f0f\u8a13\u7df4\u7684\u6a5f\u5668\u5b78\u7fd2\u6846\u67b6\u3002\u5728\u8a13\u7df4\u4ee3\u78bc\u4e2d\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 [CLUSTER_SPEC \u6216 TF_CONFIG \u74b0\u5883\u8b8a\u91cf](#cluster-variables) \u4f86\u5f15\u7528\u8a13\u7df4\u96c6\u7fa3\u7684\u7279\u5b9a\u90e8\u5206\u3002\n## \u8a13\u7df4\u96c6\u7fa3\u7684\u7d50\u69cb\n\u5982\u679c\u60a8\u4f7f\u7528 Vertex AI \u904b\u884c\u5206\u4f48\u5f0f\u8a13\u7df4\u4f5c\u696d\uff0c\u5247\u9700\u8981\u5728\u8a13\u7df4\u96c6\u7fa3 \u4e2d\u6307\u5b9a\u591a\u500b\u6a5f\u5668\uff08\u7bc0\u9ede\uff09\u3002\u8a13\u7df4\u670d\u52d9\u7232\u60a8\u6307\u5b9a\u7684\u6a5f\u5668\u985e\u578b\u5206\u914d\u8cc7\u6e90\u3002\u7d66\u5b9a\u7bc0\u9ede\u4e0a\u6b63\u5728\u904b\u884c\u7684\u4f5c\u696d\u7a31\u7232\u526f\u672c \u3002\u4e00\u7d44\u5177\u6709\u76f8\u540c\u914d\u7f6e\u7684\u526f\u672c\u7a31\u7232 \u3002\n\u8a13\u7df4\u96c6\u7fa3\u4e2d\u7684\u6bcf\u500b\u526f\u672c\u5728\u5206\u4f48\u5f0f\u8a13\u7df4\u4e2d\u88ab\u5206\u914d\u55ae\u500b\u89d2\u8272\u6216\u4efb\u52d9\u3002\u4f8b\u5982\uff1a\n- **\u4e3b\u8981\u526f\u672c** \uff1a\u60a8\u53ea\u80fd\u5c07\u4e00\u500b\u526f\u672c\u6307\u5b9a\u7232\u4e3b\u8981\u526f\u672c \u3002\u9019\u9805\u4efb\u52d9\u53ef\u7ba1\u7406\u5176\u4ed6\u4efb\u52d9\uff0c\u4e26\u5831\u544a\u4f5c\u696d\u7684\u6574\u9ad4\u72c0\u614b\u3002\n- **\u5de5\u4f5c\u5668** \uff1a\u53ef\u4ee5\u5c07\u4e00\u500b\u6216\u591a\u500b\u526f\u672c\u6307\u5b9a\u7232\u5de5\u4f5c\u5668 \u3002\u9019\u4e9b\u526f\u672c\u57f7\u884c\u60a8\u5728\u4f5c\u696d\u914d\u7f6e\u4e2d\u6307\u5b9a\u7684\u90e8\u5206\u5de5\u4f5c\u3002\n- **\u53c3\u6578\u670d\u52d9\u5668** \uff1a\u5982\u679c\u60a8\u7684\u6a5f\u5668\u5b78\u7fd2\u6846\u67b6\u652f\u6301\uff0c\u60a8\u53ef\u4ee5\u5c07\u4e00\u500b\u6216\u591a\u500b\u526f\u672c\u6307\u5b9a\u7232\u53c3\u6578\u670d\u52d9\u5668 \u3002\u9019\u4e9b\u526f\u672c\u6703\u5b58\u5132\u6a21\u578b\u53c3\u6578\uff0c\u4e26\u5354\u8abf\u5de5\u4f5c\u5668\u4e4b\u9593\u7684\u5171\u4eab\u6a21\u578b\u72c0\u614b\u3002\n- **\u8a55\u4f30\u7a0b\u5e8f** \uff1a\u5982\u679c\u60a8\u7684\u6a5f\u5668\u5b78\u7fd2\u6846\u67b6\u652f\u6301\uff0c\u7cfb\u7d71\u53ef\u80fd\u6703\u5c07\u4e00\u500b\u6216\u591a\u500b\u526f\u672c\u6307\u5b9a\u7232\u8a55\u4f30\u5668 \u3002\u9019\u4e9b\u526f\u672c\u53ef\u7528\u65bc\u8a55\u4f30\u60a8\u7684\u6a21\u578b\u3002\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f TensorFlow\uff0c\u8acb\u6ce8\u610f TensorFlow \u901a\u5e38\u8981\u6c42\u60a8\u53ea\u80fd\u4f7f\u7528\u4e00\u500b\u8a55\u4f30\u5668\u3002## \u914d\u7f6e\u5206\u4f48\u5f0f\u8a13\u7df4\u4f5c\u696d\n\u60a8\u53ef\u4ee5\u901a\u904e\u5b9a\u7fa9\u591a\u500b\u5de5\u4f5c\u5668\u6c60\uff0c\u5c07\u4efb\u4f55\u81ea\u5b9a\u7fa9\u8a13\u7df4\u4f5c\u696d\u914d\u7f6e\u7232\u5206\u4f48\u5f0f\u8a13\u7df4\u4f5c\u696d\u3002\u60a8\u9084\u53ef\u4ee5\u5728\u8a13\u7df4\u6d41\u6c34\u7dda\u6216\u8d85\u53c3\u6578\u8abf\u7bc0\u4f5c\u696d\u4e2d\u904b\u884c\u5206\u4f48\u5f0f\u8a13\u7df4\u3002\n[](None)\n\u5982\u9700\u914d\u7f6e\u5206\u4f48\u5f0f\u8a13\u7df4\u4f5c\u696d\uff0c\u8acb\u5b9a\u7fa9\u60a8\u7684\u5de5\u4f5c\u5668\u6c60 ( [workerPoolSpecs[]](https://cloud.google.com/vertex-ai/docs/reference/rest/v1/CustomJobSpec?hl=zh-cn#FIELDS.worker_pool_specs) ) \u5217\u8868\uff0c\u4f75\u7232\u6bcf\u7a2e\u985e\u578b\u8a2d\u8a08\u4e00\u7a2e `WorkerPoolSpec` \uff1a\n| workerPoolSpecs[] \u4e2d\u7684\u4f4d\u7f6e | \u5728\u96c6\u7fa3\u4e2d\u57f7\u884c\u4efb\u52d9    |\n|:-----------------------------|:-------------------------------|\n| \u7b2c\u4e00 (workerPoolSpecs[0]) | \u4e3b\u8981\u3001\u9996\u8981\u3001\u8abf\u5ea6\u7a0b\u5e8f\u6216\u201c\u4e3b\u5be6\u4f8b\u201d |\n| \u7b2c\u4e8c (workerPoolSpecs[1]) | \u8f14\u52a9\u3001\u526f\u672c\u3001\u5de5\u4f5c\u5668    |\n| \u7b2c\u4e09 (workerPoolSpecs[2]) | \u53c3\u6578\u670d\u52d9\u5668\u3001Reduction Server |\n| \u7b2c\u56db (workerPoolSpecs[3]) | \u8a55\u4f30\u7a0b\u5e8f      |\n\u60a8\u5fc5\u9808\u6307\u5b9a\u4e3b\u8981\u526f\u672c\uff0c\u8a72\u526f\u672c\u5354\u8abf\u4e86\u6240\u6709\u5176\u4ed6\u526f\u672c\u5b8c\u6210\u7684\u5de5\u4f5c\u3002\u50c5\u5c0d\u7b2c\u4e00\u500b\u526f\u672c\u4f7f\u7528\u7b2c\u4e00\u500b\u5de5\u4f5c\u5668\u6c60\u898f\u7bc4\uff0c\u4e26\u5c07\u5176 [replicaCount](https://cloud.google.com/vertex-ai/docs/reference/rest/v1/CustomJobSpec?hl=zh-cn#WorkerPoolSpec.FIELDS.replica_count) \u8a2d\u7f6e\u7232 `1` \uff1a\n```\n{\n \"workerPoolSpecs\": [  // `WorkerPoolSpec` for worker pool 0, primary replica, required\n  {\n  \"machineSpec\": {...},\n  \"replicaCount\": 1,\n  \"diskSpec\": {...},\n  ...\n  },\n  // `WorkerPoolSpec` for worker pool 1, optional\n  {},\n  // `WorkerPoolSpec` for worker pool 2, optional\n  {},\n  // `WorkerPoolSpec` for worker pool 3, optional\n  {}\n ]\n ...\n}\n```\n### \u6307\u5b9a\u5176\u4ed6\u5de5\u4f5c\u5668\u6c60\n\u6839\u64da\u60a8\u7684\u6a5f\u5668\u5b78\u7fd2\u6846\u67b6\uff0c\u60a8\u53ef\u4ee5\u6307\u5b9a\u5176\u4ed6\u5de5\u4f5c\u5668\u6c60\u4ee5\u7528\u65bc\u5176\u4ed6\u76ee\u7684\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f TensorFlow\uff0c\u5247\u53ef\u4ee5\u6307\u5b9a\u5de5\u4f5c\u5668\u6c60\u4f86\u914d\u7f6e\u5de5\u4f5c\u5668\u526f\u672c\u3001\u53c3\u6578\u670d\u52d9\u5668\u526f\u672c\u548c\u8a55\u4f30\u7a0b\u5e8f\u526f\u672c\u3002\n\u60a8\u5728 `workerPoolSpecs[]` \u5217\u8868\u4e2d\u6307\u5b9a\u7684\u5de5\u4f5c\u5668\u6c60\u7684\u9806\u5e8f\u6c7a\u5b9a\u4e86 [\u5de5\u4f5c\u5668\u6c60\u7684\u985e\u578b](#worker-pool-types) \u3002\u8a2d\u7f6e\u60a8\u4e0d\u60f3\u4f7f\u7528\u7684\u5de5\u4f5c\u5668\u6c60\u7684\u7a7a\u503c\uff0c\u4ee5\u4fbf\u5728 `workerPoolSpecs[]` \u5217\u8868\u4e2d\u8df3\u904e\u9019\u4e9b\u503c\uff0c\u4ee5\u6307\u5b9a\u8981\u4f7f\u7528\u7684\u5de5\u4f5c\u5668\u6c60\u3002\u4f8b\u5982\uff1a\n\u5982\u8981\u6307\u5b9a\u50c5\u5177\u6709\u4e3b\u526f\u672c\u548c\u53c3\u6578\u670d\u52d9\u5668\u5de5\u4f5c\u5668\u6c60\u7684\u4f5c\u696d\uff0c\u5247\u5fc5\u9808\u7232\u5de5\u4f5c\u5668\u6c60 1 \u8a2d\u7f6e\u7a7a\u503c\uff1a\n```\n{\n \"workerPoolSpecs\": [  // `WorkerPoolSpec` for worker pool 0, required\n  {\n  \"machineSpec\": {...},\n  \"replicaCount\": 1,\n  \"diskSpec\": {...},\n  ...\n  },\n  // `WorkerPoolSpec` for worker pool 1, optional\n  {},\n  // `WorkerPoolSpec` for worker pool 2, optional\n  {\n  \"machineSpec\": {...},\n  \"replicaCount\": 1,\n  \"diskSpec\": {...},\n  ...\n  },\n  // `WorkerPoolSpec` for worker pool 3, optional\n  {}\n ]\n ...\n}\n```\n### \u4f7f\u7528 Reduction Server \u7e2e\u77ed\u8a13\u7df4\u6642\u9593\n\u7576\u60a8\u4f7f\u7528\u591a\u500b\u7bc0\u9ede\u8a13\u7df4\u5927\u578b ML \u6a21\u578b\u6642\uff0c\u7bc0\u9ede\u4e4b\u9593\u7684\u901a\u4fe1\u68af\u5ea6\u53ef\u80fd\u6703\u5c0e\u81f4\u986f\u8457\u7684\u5ef6\u9072\u3002 \u662f\u4e00\u7a2e\u5168\u7e2e\u6e1b\u7b97\u6cd5\uff0c\u53ef\u4ee5\u63d0\u9ad8\u5206\u4f48\u5f0f\u8a13\u7df4\u7684\u541e\u5410\u91cf\u4e26\u6e1b\u5c11\u5ef6\u9072\u3002Vertex AI \u4f7f Reduction Server \u5728 Docker \u5bb9\u5668\u6620\u50cf\u4e2d\u53ef\u7528\uff0c\u60a8\u53ef\u4ee5\u5728\u5206\u4f48\u5f0f\u8a13\u7df4\u671f\u9593\u5c07\u5176\u7528\u65bc\u60a8\u7684\u4e00\u500b\u5de5\u4f5c\u6c60\u3002\n\u5982\u9700\u77ad\u89e3 Reduulation Server \u7684\u5de5\u4f5c\u539f\u7406\uff0c\u8acb\u53c3\u95b1 [\u5728 Vertex AI \u4e0a\u4f7f\u7528 Reduulation Server \u52a0\u5feb\u5206\u4f48\u5f0f GPU \u8a13\u7df4](https://cloud.google.com/blog/products/ai-machine-learning/faster-distributed-training-with-google-clouds-reduction-server?hl=zh-cn) \u3002\n\u5982\u679c\u60a8\u6eff\u8db3\u4ee5\u4e0b\u8981\u6c42\uff0c\u5247\u53ef\u4ee5\u4f7f\u7528 Reduction Server\uff1a\n- \u60a8\u6b63\u5728\u4f7f\u7528 GPU \u5de5\u4f5c\u5668\u57f7\u884c\u5206\u4f48\u5f0f\u8a13\u7df4\u3002\n- \u60a8\u7684\u8a13\u7df4\u4ee3\u78bc\u4f7f\u7528 TensorFlow \u6216 PyTorch\uff0c\u4e26\u914d\u7f6e\u7232\u4f7f\u7528 [NCCL](https://developer.nvidia.com/nccl) \u5168\u7e2e\u6e1b\u901a\u904e GPU \u9032\u884c\u591a\u4e3b\u6a5f\u6578\u64da\u4e26\u884c\u8a13\u7df4\u3002\uff08\u60a8\u53ef\u80fd\u9084\u53ef\u4ee5\u4f7f\u7528\u5176\u4ed6\u63a1\u7528 NCCL \u7684\u6a5f\u5668\u5b78\u7fd2\u6846\u67b6\u3002\uff09\n- \u5728\u4e3b\u7bc0\u9ede ( `workerPoolSpecs[0]` ) \u548c\u5de5\u4f5c\u5668 ( `workerPoolSpecs[1]` ) \u4e0a\u904b\u884c\u7684\u5bb9\u5668\u652f\u6301 Reduction Server\u3002\u5177\u9ad4\u800c\u8a00\uff0c\u6bcf\u500b\u5bb9\u5668\u662f\u4ee5\u4e0b\u9805\u4e4b\u4e00\uff1a- [\u9810\u69cb\u5efa\u7684 TensorFlow \u8a13\u7df4\u5bb9\u5668](https://cloud.google.com/vertex-ai/docs/training/pre-built-containers?hl=zh-cn#tensorflow) 2.3 \u7248\u6216\u66f4\u9ad8\u7248\u672c\u3002\n- [\u9810\u69cb\u5efa\u7684 Pytorch \u8a13\u7df4\u5bb9\u5668](https://cloud.google.com/vertex-ai/docs/training/pre-built-containers?hl=zh-cn#pytorch) 1.4 \u7248\u6216\u66f4\u9ad8\u7248\u672c\u3002\n- \u5b89\u88dd\u4e86 NCCL 2.7 \u6216\u66f4\u9ad8\u7248\u672c\u4ee5\u53ca `google-reduction-server` \u8edf\u4ef6\u5305\u7684 [\u81ea\u5b9a\u7fa9\u5bb9\u5668](https://cloud.google.com/vertex-ai/docs/training/containers-overview?hl=zh-cn) \u3002\u60a8\u53ef\u4ee5\u901a\u904e\u5c07\u4ee5\u4e0b\u884c\u6dfb\u52a0\u5230 Dockerfile \u4e2d\uff0c\u5728\u81ea\u5b9a\u7fa9\u5bb9\u5668\u6620\u50cf\u4e0a\u5b89\u88dd\u6b64\u8edf\u4ef6\u5305\uff1a```\nRUN echo \"deb https://packages.cloud.google.com/apt google-fast-socket main\" | tee /etc/apt/sources.list.d/google-fast-socket.list && \\\n curl -s -L https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add - && \\\n apt update && apt install -y google-reduction-server\n```\n\u5982\u9700\u4f7f\u7528 Reduction Server\uff0c\u8acb\u5728\u5275\u5efa\u81ea\u5b9a\u7fa9\u8a13\u7df4\u8cc7\u6e90\u6642\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u5728\u7b2c\u4e09\u500b\u5de5\u4f5c\u5668\u6c60 ( `workerPoolSpecs[2]` ) \u7684 [containerSpec.imageUri \u5b57\u6bb5](https://cloud.google.com/vertex-ai/docs/reference/rest/v1/CustomJobSpec?hl=zh-cn#ContainerSpec) \u4e2d\u6307\u5b9a\u4ee5\u4e0b URI \u4e4b\u4e00\uff1a- `us-docker.pkg.dev/vertex-ai-restricted/training/reductionserver:latest`\n- `europe-docker.pkg.dev/vertex-ai-restricted/training/reductionserver:latest`\n- `asia-docker.pkg.dev/vertex-ai-restricted/training/reductionserver:latest`\n\u9078\u64c7\u6700\u9760\u8fd1\u60a8\u57f7\u884c\u81ea\u5b9a\u7fa9\u8a13\u7df4\u7684\u4f4d\u7f6e\u7684\u591a\u5340\u57df\u53ef\u7e2e\u77ed\u5ef6\u9072\u6642\u9593\u3002\n- \u7232\u7b2c\u4e09\u500b\u5de5\u4f5c\u5668\u6c60\u9078\u64c7 [\u6a5f\u5668\u985e\u578b\u548c\u7bc0\u9ede\u6578](https://cloud.google.com/vertex-ai/docs/training/configure-compute?hl=zh-cn) \u6642\uff0c\u8acb\u78ba\u4fdd\u7b2c\u4e09\u500b\u5de5\u4f5c\u5668\u6c60\u7684\u7e3d\u7db2\u7d61\u5e36\u5bec\u8207\u7b2c\u4e00\u500b\u548c\u7b2c\u4e8c\u500b\u5de5\u4f5c\u5668\u6c60\u7684\u7e3d\u7db2\u7d61\u5e36\u5bec\u5339\u914d\uff0c\u6216\u8d85\u51fa\u5176\u7e3d\u7db2\u7d61\u5e36\u5bec\u3002\u5982\u9700\u77ad\u89e3\u7b2c\u4e8c\u500b\u5de5\u4f5c\u5668\u6c60\u4e2d\u6bcf\u500b\u7bc0\u9ede\u7684\u6700\u5927\u53ef\u7528\u5e36\u5bec\uff0c\u8acb\u53c3\u95b1 [\u7db2\u7d61\u5e36\u5bec\u548c GPU](https://cloud.google.com/compute/docs/gpus/gpu-network-bandwidth?hl=zh-cn) \u3002\u5c0d Reduction Server \u7bc0\u9ede\u4e0d\u4f7f\u7528 GPU\u3002\u5982\u9700\u77ad\u89e3\u7b2c\u4e09\u500b\u5de5\u4f5c\u5668\u6c60\u4e2d\u6bcf\u500b\u7bc0\u9ede\u7684\u6700\u5927\u53ef\u7528\u5e36\u5bec\uff0c\u8acb\u53c3\u95b1 [\u901a\u7528\u6a5f\u5668\u7cfb\u5217](https://cloud.google.com/compute/docs/general-purpose-machines?hl=zh-cn) \u4e2d\u7684\u201c\u6700\u5927\u51fa\u7ad9\u5e36\u5bec (Gbps)\u201d\u5217\u3002\u4f8b\u5982\uff0c\u5982\u679c\u5c07\u7b2c\u4e00\u500b\u548c\u7b2c\u4e8c\u500b\u5de5\u4f5c\u5668\u6c60\u914d\u7f6e\u7232\u4f7f\u7528 5 \u500b `n1-highmem-96` \u7bc0\u9ede\uff0c\u6bcf\u500b\u7bc0\u9ede\u5177\u6709 8 \u500b `NVIDIA_TESLA_V100` GPU\uff0c\u5247\u6bcf\u500b\u7bc0\u9ede\u7684\u6700\u5927\u53ef\u7528\u5e36\u5bec\u7232 100\u00a0Gbps\uff0c\u7e3d\u5e36\u5bec\u7232 500\u00a0Gbps\u3002\u7232\u4e86\u8207\u7b2c\u4e09\u500b\u5de5\u4f5c\u5668\u6c60\u4e2d\u7684\u5e36\u5bec\u5339\u914d\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 16 \u500b `n1-highcpu-16` \u7bc0\u9ede\uff0c\u6bcf\u500b\u7bc0\u9ede\u7684\u6700\u5927\u5e36\u5bec\u7232 32\u00a0Gbps\uff0c\u7e3d\u5e36\u5bec\u7232 512\u00a0Gbps\u3002\u6211\u5011\u5efa\u8b70\u60a8\u5c0d Reduction Serve \u7bc0\u9ede\u4f7f\u7528 `n1-highcpu-16` \u6a5f\u5668\u985e\u578b\uff0c\u56e0\u7232\u6b64\u6a5f\u5668\u985e\u578b\u53ef\u7232\u5176\u8cc7\u6e90\u63d0\u4f9b\u76f8\u5c0d\u9ad8\u7684\u5e36\u5bec\u3002\n\u4ee5\u4e0b\u547d\u4ee4\u8209\u4f8b\u8aaa\u660e\u4e86\u5982\u4f55\u5275\u5efa\u4f7f\u7528 Reduction Server \u7684 `CustomJob` \u8cc7\u6e90\uff1a\n```\ngcloud ai custom-jobs create \\\u00a0 --region=LOCATION \\\u00a0 --display-name=JOB_NAME \\\u00a0 --worker-pool-spec=machine-type=n1-highmem-96,replica-count=1,accelerator-type=NVIDIA_TESLA_V100,accelerator-count=8,container-image-uri=CUSTOM_CONTAINER_IMAGE_URI \\\u00a0 --worker-pool-spec=machine-type=n1-highmem-96,replica-count=4,accelerator-type=NVIDIA_TESLA_V100,accelerator-count=8,container-image-uri=CUSTOM_CONTAINER_IMAGE_URI \\\u00a0 --worker-pool-spec=machine-type=n1-highcpu-16,replica-count=16,container-image-uri=us-docker.pkg.dev/vertex-ai-restricted/training/reductionserver:latest\n```\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5275\u5efa CustomJob \u6307\u5357](https://cloud.google.com/vertex-ai/docs/training/create-custom-job?hl=zh-cn) \u3002\n\u5982\u9700\u67e5\u770b\u5982\u4f55\u4f7f\u7528 Reduction Server \u5728 PyTorch \u4e2d\u57f7\u884c\u5206\u4f48\u5f0f\u8a13\u7df4\u7684\u793a\u4f8b\uff0c\u8acb\u5728\u4ee5\u4e0b\u67d0\u500b\u74b0\u5883\u4e2d\u904b\u884c\u201c\u4f7f\u7528 Vertex AI Reduction Server \u57f7\u884c PyTorch \u5206\u4f48\u5f0f\u8a13\u7df4\u201dJupyter \u7b46\u8a18\u672c\uff1a [\u5728 Colab \u4e2d\u904b\u884c](https://colab.research.google.com/github/GoogleCloudPlatform/vertex-ai-samples/blob/main/notebooks/official/reduction_server/pytorch_distributed_training_reduction_server.ipynb?hl=zh-cn) | [\u5728 Vertex AI Workbench \u7528\u6236\u7ba1\u7406\u7684\u7b46\u8a18\u672c\u4e2d\u6253\u958b](https://console.cloud.google.com/vertex-ai/workbench/deploy-notebook?download_url=https%3A%2F%2Fraw.githubusercontent.com%2FGoogleCloudPlatform%2Fvertex-ai-samples%2Fmain%2Fnotebooks%2Fofficial%2Freduction_server%2Fpytorch_distributed_training_reduction_server.ipynb&hl=zh-cn) | [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/vertex-ai-samples/blob/main/notebooks/official/reduction_server/pytorch_distributed_training_reduction_server.ipynb)\n\u5982\u9700\u67e5\u770b\u6709\u95dc\u5982\u4f55\u4f7f\u7528 Dask \u5728 XGBoost \u4e2d\u57f7\u884c\u4e26\u884c\u8a13\u7df4\u7684\u793a\u4f8b\uff0c\u8acb\u5728\u4ee5\u4e0b\u4efb\u4e00\u74b0\u5883\u4e2d\u904b\u884c\u201c\u4f7f\u7528 Dask \u9032\u884c\u5206\u4f48\u5f0f XGBoost \u8a13\u7df4\u201dJupyter \u7b46\u8a18\u672c\uff1a [\u5728 Colab \u4e2d\u904b\u884c](https://colab.research.google.com/github/GoogleCloudPlatform/vertex-ai-samples/blob/main/notebooks/official/training/xgboost_data_parallel_training_on_cpu_using_dask.ipynb?hl=zh-cn) | [\u5728 Vertex AI Workbench \u7528\u6236\u7ba1\u7406\u7684\u7b46\u8a18\u672c\u4e2d\u6253\u958b](https://console.cloud.google.com/vertex-ai/workbench/deploy-notebook?download_url=https%3A%2F%2Fraw.githubusercontent.com%2FGoogleCloudPlatform%2Fvertex-ai-samples%2Fmain%2Fnotebooks%2Fofficial%2Ftraining%2Fxgboost_data_parallel_training_on_cpu_using_dask.ipynb&hl=zh-cn) | [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/vertex-ai-samples/blob/main/notebooks/official/training/xgboost_data_parallel_training_on_cpu_using_dask.ipynb)\n### \u4f7f\u7528\u7e2e\u6e1b\u670d\u52d9\u5668\u9032\u884c\u8a13\u7df4\u7684\u6700\u4f73\u505a\u6cd5\n\u5728\u7e2e\u6e1b\u670d\u52d9\u5668\u8a13\u7df4\u4e2d\uff0c\u6bcf\u500b\u5de5\u4f5c\u5668\u90fd\u9700\u8981\u9023\u63a5\u5230\u6240\u6709\u7e2e\u6e1b\u5668\u4e3b\u6a5f\u3002\u7232\u4e86\u6700\u5927\u9650\u5ea6\u5730\u6e1b\u5c11\u5de5\u4f5c\u5668\u4e3b\u6a5f\u4e0a\u7684\u9023\u63a5\u6578\uff0c\u8acb\u5c0d\u7e2e\u6e1b\u5668\u4e3b\u6a5f\u4f7f\u7528\u5177\u6709\u6700\u9ad8\u7db2\u7d61\u5e36\u5bec\u7684\u6a5f\u5668\u985e\u578b\u3002\n\u6700\u597d\u9078\u64c7\u9019\u6a23\u7684\u7e2e\u6e1b\u5668\u4e3b\u6a5f\uff1a\u81f3\u5c11\u5177\u6709 16 \u500b vCPU \u4e14\u63d0\u4f9b [32\u00a0Gbps \u51fa\u7ad9\u6d41\u91cf\u5e36\u5bec](https://cloud.google.com/compute/docs/networking/configure-vm-with-high-bandwidth-configuration?hl=zh-cn#bandwidth-tiers) \u7684\u901a\u7528 N1/N2 \u865b\u64ec\u6a5f\uff0c\u4f8b\u5982 `n1-highcpu-16` \u548c `n2-highcpu-16` \u3002N1/N2 \u865b\u64ec\u6a5f\u7684\u7b2c 1 \u5c64\u865b\u64ec\u6a5f\u5e36\u5bec\u5c07\u51fa\u7ad9\u6d41\u91cf\u5e36\u5bec\u4e0a\u9650\u589e\u52a0\u5230 50\u00a0Gbps \u5230 100\u00a0Gbps \u4e4b\u9593\uff0c\u56e0\u6b64\u975e\u5e38\u9069\u5408\u7e2e\u6e1b\u5668\u865b\u64ec\u6a5f\u7bc0\u9ede\u3002\n\u5de5\u4f5c\u5668\u548c\u7e2e\u6e1b\u5668\u7684\u7e3d\u51fa\u7ad9\u5e36\u5bec\u61c9\u76f8\u540c\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u4f7f\u7528 8 \u500b `a2-megagpu-16g` \u865b\u64ec\u6a5f\u4f5c\u7232\u5de5\u4f5c\u5668\uff0c\u5247\u61c9\u81f3\u5c11\u4f7f\u7528 25 \u500b `n1-highcpu-16` \u865b\u64ec\u6a5f\u4f5c\u7232\u7e2e\u6e1b\u5668\u3002\n```\n`(8 worker VMs * 100&nbsp;Gbps) / 32&nbsp;Gbps egress = 25 reducer VMs`.\n```\n\u5982\u679c\u805a\u5408\u7684\u6d88\u606f\u8db3\u5920\u5927\uff0c\u7e2e\u6e1b\u670d\u52d9\u5668\u6548\u679c\u6700\u4f73\u3002\u5927\u591a\u6578\u6a5f\u5668\u5b78\u7fd2\u6846\u67b6\u5df2\u7d93\u4f7f\u7528\u4e0d\u540c\u8853\u8a9e\u63d0\u4f9b\u6280\u8853\uff0c\u4ee5\u5728\u57f7\u884c\u5168\u7e2e\u6e1b\u4e4b\u524d\u5c0d\u5c0f\u68af\u5ea6\u5f35\u91cf\u9032\u884c\u6279\u8655\u7406\u3002\nHorovod \u652f\u6301 [Tensor Fusion](https://horovod.readthedocs.io/en/stable/tensor-fusion_include.html) \u6279\u91cf\u8655\u7406\u5c0f\u5f35\u91cf\u4ee5\u5be6\u73fe\u5168\u7e2e\u6e1b\u3002\u5f35\u91cf\u6703\u586b\u5145\u5230\u878d\u5408\u7de9\u885d\u5340\u4e2d\uff0c\u76f4\u5230\u7de9\u885d\u5340\u5b8c\u5168\u586b\u6eff\uff0c\u6b64\u6642\u7de9\u885d\u5340\u4e0a\u7684\u5168\u7e2e\u6e1b\u64cd\u4f5c\u5c07\u6703\u57f7\u884c\u3002\u60a8\u53ef\u4ee5\u901a\u904e\u8a2d\u7f6e `HOROVOD_FUSION_THRESHOLD` \u74b0\u5883\u8b8a\u91cf\u4f86\u8abf\u6574\u878d\u5408\u7de9\u885d\u5340\u7684\u5927\u5c0f\u3002\n`HOROVOD_FUSION_THRESHOLD` \u74b0\u5883\u8b8a\u91cf\u7684\u5efa\u8b70\u503c\u81f3\u5c11\u7232 128\u00a0MB\u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u8acb\u5c07 `HOROVOD_FUSION_THRESHOLD` \u74b0\u5883\u8b8a\u91cf\u8a2d\u7f6e\u7232 134217728 (128 * 1024 * 1024)\u3002\nPyTorch [DistributedDataParallel](https://pytorch.org/docs/stable/notes/ddp.html) \u652f\u6301\u5c07\u6279\u91cf\u6d88\u606f\u4f5c\u7232\u201c\u68af\u5ea6\u5206\u6876\u201d\u3002\u8a2d\u7f6e `DistributedDataParallel` \u69cb\u9020\u51fd\u6578\u4e2d\u7684 `bucket_cap_mb` \u53c3\u6578\u4ee5\u63a7\u5236\u6279\u91cf\u5b58\u5132\u6876\u7684\u5927\u5c0f\u3002\u9ed8\u8a8d\u5927\u5c0f\u7232 25\u00a0MB\u3002\n\u6700\u4f73\u505a\u6cd5\uff1abucket_cap_mb \u7684\u63a8\u85a6\u503c\u7232 64 (64\u00a0MB)\u3002\n## \u96c6\u7fa3\u7684\u74b0\u5883\u8b8a\u91cf\nVertex AI \u6703\u5728\u6bcf\u500b\u526f\u672c\u4e0a\u586b\u5145\u74b0\u5883\u8b8a\u91cf `CLUSTER_SPEC` \uff0c\u4ee5\u63cf\u8ff0\u6574\u500b\u96c6\u7fa3\u7684\u8a2d\u7f6e\u65b9\u5f0f\u3002\u8207 [TensorFlow \u7684 TF_CONFIG](#tf-config) \u985e\u4f3c\uff0c `CLUSTER_SPEC` \u63cf\u8ff0\u96c6\u7fa3\u4e2d\u7684\u6bcf\u500b\u526f\u672c\uff0c\u5305\u62ec\u5176\u7d22\u5f15\u548c\u89d2\u8272\uff08\u4e3b\u526f\u672c\u3001\u5de5\u4f5c\u5668\u3001\u53c3\u6578\u670d\u52d9\u5668\u6216\u8a55\u4f30\u5668\uff09\u3002\n\u7576\u60a8\u4f7f\u7528 TensorFlow \u904b\u884c\u5206\u4f48\u5f0f\u8a13\u7df4\u6642\uff0c\u7cfb\u7d71\u6703\u89e3\u6790 `TF_CONFIG` \u4ee5\u69cb\u5efa [tf.train.ClusterSpec](https://www.tensorflow.org/api_docs/python/tf/train/ClusterSpec?hl=zh-cn) \u3002\u540c\u6a23\uff0c\u7576\u60a8\u4f7f\u7528\u5176\u4ed6\u6a5f\u5668\u5b78\u7fd2\u6846\u67b6\u904b\u884c\u5206\u4f48\u5f0f\u8a13\u7df4\u6642\uff0c\u5fc5\u9808\u89e3\u6790 `CLUSTER_SPEC` \u4ee5\u586b\u5145\u6846\u67b6\u6240\u9700\u7684\u4efb\u4f55\u74b0\u5883\u8b8a\u91cf\u6216\u8a2d\u7f6e\u3002\n### CLUSTER_SPEC \u7684\u683c\u5f0f\n`CLUSTER_SPEC` \u74b0\u5883\u8b8a\u91cf\u662f\u4e00\u500b JSON \u5b57\u7b26\u4e32\uff0c\u683c\u5f0f\u5982\u4e0b\uff1a\n| \u9375   | \u8aaa\u660e                                             | Unnamed: 2                                           |\n|:--------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| \"cluster\"  | \u81ea\u5b9a\u7fa9\u5bb9\u5668\u7684\u96c6\u7fa3\u8aaa\u660e\u3002\u8207 TF_CONFIG \u4e00\u6a23\uff0c\u6b64\u5c0d\u8c61\u4e5f\u6703\u63a1\u7528 TensorFlow \u96c6\u7fa3\u898f\u7bc4\u4e2d\u7684\u683c\u5f0f\uff0c\u4e14\u53ef\u4ee5\u50b3\u905e\u7d66 tf.train.ClusterSpec \u7684\u69cb\u9020\u51fd\u6578\u3002 \u96c6\u7fa3\u8aaa\u660e\u5305\u542b\u60a8\u6307\u5b9a\u7684\u6bcf\u500b\u5de5\u4f5c\u5668\u6c60\u7684\u526f\u672c\u540d\u7a31\u5217\u8868\u3002 | \u81ea\u5b9a\u7fa9\u5bb9\u5668\u7684\u96c6\u7fa3\u8aaa\u660e\u3002\u8207 TF_CONFIG \u4e00\u6a23\uff0c\u6b64\u5c0d\u8c61\u4e5f\u6703\u63a1\u7528 TensorFlow \u96c6\u7fa3\u898f\u7bc4\u4e2d\u7684\u683c\u5f0f\uff0c\u4e14\u53ef\u4ee5\u50b3\u905e\u7d66 tf.train.ClusterSpec \u7684\u69cb\u9020\u51fd\u6578\u3002 \u96c6\u7fa3\u8aaa\u660e\u5305\u542b\u60a8\u6307\u5b9a\u7684\u6bcf\u500b\u5de5\u4f5c\u5668\u6c60\u7684\u526f\u672c\u540d\u7a31\u5217\u8868\u3002 |\n| nan   | \"workerpool0\"                                          | \u6240\u6709\u5206\u4f48\u5f0f\u8a13\u7df4\u4f5c\u696d\u5728\u7b2c\u4e00\u500b\u5de5\u4f5c\u5668\u6c60\u4e2d\u90fd\u6709\u4e00\u500b\u4e3b\u8981\u526f\u672c\u3002                                |\n| nan   | \"workerpool1\"                                          | \u5982\u679c\u60a8\u5728\u5275\u5efa\u4f5c\u696d\u6642\u6307\u5b9a\u4e86\u9019\u4e9b\u5de5\u4f5c\u5668\u526f\u672c\uff0c\u5247\u6b64\u5de5\u4f5c\u5668\u6c60\u5305\u542b\u5de5\u4f5c\u5668\u526f\u672c\u3002                             |\n| nan   | \"workerpool2\"                                          | \u5982\u679c\u60a8\u5728\u5275\u5efa\u4f5c\u696d\u6642\u6307\u5b9a\u4e86\u9019\u4e9b\u53c3\u6578\uff0c\u5247\u6b64\u5de5\u4f5c\u5668\u6c60\u5305\u542b\u53c3\u6578\u670d\u52d9\u5668\u3002                              |\n| nan   | \"workerpool3\"                                          | \u5982\u679c\u60a8\u5728\u5275\u5efa\u4f5c\u696d\u6642\u6307\u5b9a\u4e86\u8a55\u4f30\u5668\uff0c\u5247\u6b64\u5de5\u4f5c\u5668\u6c60\u5305\u542b\u8a55\u4f30\u7a0b\u5e8f\u3002                               |\n| \"environment\" | \u5b57\u7b26\u4e32 cloud\u3002                                          | \u5b57\u7b26\u4e32 cloud\u3002                                          |\n| \"task\"  | \u63cf\u8ff0\u904b\u884c\u4ee3\u78bc\u7684\u7279\u5b9a\u7bc0\u9ede\u7684\u4efb\u52d9\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u6b64\u4fe1\u606f\u7232\u5206\u4f48\u5f0f\u4f5c\u696d\u4e2d\u7684\u7279\u5b9a\u5de5\u4f5c\u5668\u7de8\u5beb\u4ee3\u78bc\u3002\u6b64\u689d\u76ee\u662f\u4e00\u500b\u542b\u6709\u4ee5\u4e0b\u9375\u7684\u5b57\u5178\uff1a                  | \u63cf\u8ff0\u904b\u884c\u4ee3\u78bc\u7684\u7279\u5b9a\u7bc0\u9ede\u7684\u4efb\u52d9\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u6b64\u4fe1\u606f\u7232\u5206\u4f48\u5f0f\u4f5c\u696d\u4e2d\u7684\u7279\u5b9a\u5de5\u4f5c\u5668\u7de8\u5beb\u4ee3\u78bc\u3002\u6b64\u689d\u76ee\u662f\u4e00\u500b\u542b\u6709\u4ee5\u4e0b\u9375\u7684\u5b57\u5178\uff1a                  |\n| nan   | \"type\"                                            | \u6b64\u4efb\u52d9\u904b\u884c\u7684\u5de5\u4f5c\u5668\u6c60\u7684\u985e\u578b\u3002\u4f8b\u5982\uff0c\"workerpool0\" \u8868\u793a\u4e3b\u526f\u672c\u3002                               |\n| nan   | \"index\"                                            | \u4efb\u52d9\u7684\u7d22\u5f15\uff08\u5f9e\u96f6\u958b\u59cb\uff09\u3002\u4f8b\u5982\uff0c\u5982\u679c\u8a13\u7df4\u4f5c\u696d\u5305\u542b\u5169\u500b\u5de5\u4f5c\u5668\uff0c\u5247\u5176\u4e2d\u4e00\u500b\u503c\u8a2d\u7232 0\uff0c\u53e6\u4e00\u500b\u8a2d\u7232 1\u3002                       |\n| nan   | \"trial\"                                            | \u7576\u524d\u904b\u884c\u7684\u8d85\u53c3\u6578\u8abf\u7bc0\u8a66\u9a57\u7684\u6a19\u8b58\u7b26\u3002\u7232\u4f5c\u696d\u914d\u7f6e\u8d85\u53c3\u6578\u8abf\u7bc0\u6642\uff0c\u53ef\u4ee5\u8a2d\u7f6e\u591a\u500b\u8981\u8a13\u7df4\u7684\u8a66\u9a57\u3002\u6b64\u503c\u7232\u60a8\u63d0\u4f9b\u4e86\u4e00\u7a2e\u5340\u5206\u4ee3\u78bc\u4e2d\u6b63\u5728\u904b\u884c\u7684\u8a66\u9a57\u7684\u65b9\u6cd5\u3002\u6a19\u8b58\u7b26\u662f\u4e00\u500b\u5305\u542b\u8a66\u9a57\u7de8\u865f\u7684\u5b57\u7b26\u4e32\u503c\uff0c\u5f9e 1 \u958b\u59cb\u3002 |\n| job   | \u60a8\u5275\u5efa\u7576\u524d\u8a13\u7df4\u4f5c\u696d\u6642\u63d0\u4f9b\u7684 CustomJobSpec\uff0c\u8868\u793a\u7232\u5b57\u5178\u3002                                | \u60a8\u5275\u5efa\u7576\u524d\u8a13\u7df4\u4f5c\u696d\u6642\u63d0\u4f9b\u7684 CustomJobSpec\uff0c\u8868\u793a\u7232\u5b57\u5178\u3002                                |\n\u4e0b\u9762\u662f\u4e00\u500b\u793a\u4f8b\u503c\uff1a\n```\n{\n \"cluster\":{\n  \"workerpool0\":[   \"cmle-training-workerpool0-ab-0:2222\"\n  ],\n  \"workerpool1\":[   \"cmle-training-workerpool1-ab-0:2222\",\n   \"cmle-training-workerpool1-ab-1:2222\"\n  ],\n  \"workerpool2\":[   \"cmle-training-workerpool2-ab-0:2222\",\n   \"cmle-training-workerpool2-ab-1:2222\"\n  ],\n  \"workerpool3\":[   \"cmle-training-workerpool3-ab-0:2222\",\n   \"cmle-training-workerpool3-ab-1:2222\",\n   \"cmle-training-workerpool3-ab-2:2222\"\n  ]\n },\n \"environment\":\"cloud\",\n \"task\":{\n  \"type\":\"workerpool0\",\n  \"index\":0,\n  \"trial\":\"TRIAL_ID\"\n },\n \"job\": {\n  ...\n }\n}\n```\n### TF_CONFIG \u7684\u683c\u5f0f\n\u9664\u4e86 `CLUSTER_SPEC` \u4e4b\u5916\uff0cVertex AI \u5728\u6240\u6709\u5206\u4f48\u5f0f\u8a13\u7df4\u4f5c\u696d\u7684\u6bcf\u500b\u526f\u672c\u4e0a\u8a2d\u7f6e [TF_CONFIG](https://www.tensorflow.org/guide/distributed_training?hl=zh-cn#setting_up_tf_config_environment_variable) \u74b0\u5883\u8b8a\u91cf\u3002Vertex AI \u4e0d\u6703 \u7232\u55ae\u526f\u672c\u8a13\u7df4\u4f5c\u696d\u8a2d\u7f6e `TF_CONFIG` \u3002\n`CLUSTER_SPEC` \u548c `TF_CONFIG` \u5177\u6709\u76f8\u540c\u7684\u503c\uff0c\u4f46\u5b83\u5011\u7684\u683c\u5f0f\u4e0d\u540c\u3002\u9019\u5169\u500b\u74b0\u5883\u8b8a\u91cf\u90fd\u5305\u542b TensorFlow \u6240\u9700\u7684\u5176\u4ed6\u5b57\u6bb5\u3002\n\u4f7f\u7528\u81ea\u5b9a\u7fa9\u5bb9\u5668\u6642\uff0c\u4f7f\u7528 TensorFlow \u7684\u5206\u4f48\u5f0f\u8a13\u7df4\u8207\u4f7f\u7528\u9810\u69cb\u5efa\u5bb9\u5668\u76f8\u540c\u3002\n`TF_CONFIG` \u74b0\u5883\u8b8a\u91cf\u662f\u4e00\u500b JSON \u5b57\u7b26\u4e32\uff0c\u683c\u5f0f\u5982\u4e0b\uff1a\n| TF_CONFIG \u5b57\u6bb5 | TF_CONFIG \u5b57\u6bb5.1                                                                                                                                                                                                                    |\n|:-----------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| cluster   | TensorFlow \u96c6\u7fa3\u63cf\u8ff0\u3002\u5c07\u4e00\u500b\u6216\u591a\u500b\u4efb\u52d9\u540d\u7a31\uff08chief\u3001worker\u3001ps \u6216 master\uff09\u6620\u5c04\u5230\u904b\u884c\u9019\u4e9b\u4efb\u52d9\u7684\u7db2\u7d61\u5730\u5740\u5217\u8868\u7684\u5b57\u5178\u3002\u5c0d\u65bc\u7d66\u5b9a\u7684\u8a13\u7df4\u4f5c\u696d\uff0c\u6b64\u5b57\u5178\u5728\u6bcf\u500b\u865b\u64ec\u6a5f\u4e0a\u90fd\u662f\u76f8\u540c\u7684\u3002 \u9019\u662f tf.train.ClusterSpec \u69cb\u9020\u51fd\u6578\u7684\u6709\u6548\u7b2c\u4e00\u500b\u53c3\u6578\u3002\u8acb\u6ce8\u610f\uff0c\u6b64\u5b57\u5178\u4e0d\u6703\u5305\u542b evaluator \u4f5c\u7232\u9375\uff0c\u56e0\u7232\u5373\u4f7f\u60a8\u5c07\u8a55\u4f30\u7a0b\u5e8f\u7528\u65bc\u4f5c\u696d\uff0c\u8a55\u4f30\u7a0b\u5e8f\u4e5f\u4e0d\u6703\u88ab\u8996\u7232\u8a13\u7df4\u96c6\u7fa3\u7684\u4e00\u90e8\u5206\u3002                                                                                                                                       |\n| task    | \u8a2d\u7f6e\u6b64\u74b0\u5883\u8b8a\u91cf\u7684\u865b\u64ec\u6a5f\u7684\u4efb\u52d9\u8aaa\u660e\u3002 \u5c0d\u65bc\u7d66\u5b9a\u7684\u8a13\u7df4\u4f5c\u696d\uff0c\u6b64\u5b57\u5178\u5728\u6bcf\u500b\u865b\u64ec\u6a5f\u4e0a\u90fd\u662f\u4e0d\u540c\u7684\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u6b64\u4fe1\u606f\u81ea\u5b9a\u7fa9\u5206\u4f48\u5f0f\u8a13\u7df4\u4f5c\u696d\u4e2d\u6bcf\u500b\u865b\u64ec\u6a5f\u4e0a\u904b\u884c\u7684\u4ee3\u78bc\u3002\u60a8\u9084\u53ef\u4ee5\u4f7f\u7528\u5b83\u4f86\u66f4\u6539\u8a13\u7df4\u4ee3\u78bc\u7684\u884c\u7232\uff0c\u4f7f\u5176\u9069\u61c9\u8d85\u53c3\u6578\u8abf\u7bc0\u4f5c\u696d\u7684\u4e0d\u540c\u8a66\u9a57\u3002 \u6b64\u5b57\u5178\u5305\u542b\u4ee5\u4e0b\u9375\u503c\u5c0d\uff1a task \u5b57\u6bb5 type \u6b64\u865b\u64ec\u6a5f\u6b63\u5728\u57f7\u884c\u7684\u4efb\u52d9\u985e\u578b\u3002\u6b64\u503c\u5728\u5de5\u4f5c\u5668\u4e2d\u8a2d\u7f6e\u7232 worker\uff0c\u5728\u53c3\u6578\u670d\u52d9\u5668\u4e0a\u8a2d\u7f6e\u7232 ps\uff0c\u800c\u5728\u8a55\u4f30\u7a0b\u5e8f\u4e0a\u8a2d\u7f6e\u7232 evaluator\u3002\u5728\u4f5c\u696d\u7684\u4e3b\u5de5\u4f5c\u5668\u4e2d\uff0c\u503c\u8a2d\u7f6e\u7232 chief \u6216 master\uff1b\u53ef\u5728\u672c\u6587\u6a94\u7684 chief \u5c0d\u6bd4 master \u90e8\u5206\u8a73\u7d30\u77ad\u89e3\u5169\u8005\u4e4b\u9593\u7684\u5340\u5225\u3002 index \u4efb\u52d9\u7684\u7d22\u5f15\uff08\u5f9e\u96f6\u958b\u59cb\uff09\u3002\u4f8b\u5982\uff0c\u5982\u679c\u8a13\u7df4\u4f5c\u696d\u5305\u542b\u5169\u500b\u5de5\u4f5c\u5668\uff0c\u5247\u5176\u4e2d\u4e00\u500b\u503c\u8a2d\u7232 0\uff0c\u53e6\u4e00\u500b\u8a2d\u7232 1\u3002 trial \u7576\u524d\u5728\u6b64\u865b\u64ec\u6a5f\u4e0a\u904b\u884c\u7684\u8d85\u53c3\u6578\u8abf\u7bc0\u8a66\u9a57\u7684 ID\u3002\u50c5\u5728\u7576\u524d\u8a13\u7df4\u4f5c\u696d\u662f\u8d85\u53c3\u6578\u8abf\u7bc0\u4f5c\u696d\u6642\u624d\u8a2d\u7f6e\u6b64\u5b57\u6bb5\u3002 \u5c0d\u65bc\u8d85\u53c3\u6578\u8abf\u7bc0\u4f5c\u696d\uff0cVertex AI \u6703\u5728\u8a31\u591a\u8a66\u9a57\u4e2d\u53cd\u8986\u904b\u884c\u60a8\u7684\u8a13\u7df4\u4ee3\u78bc\uff0c\u6bcf\u6b21\u4f7f\u7528\u4e0d\u540c\u7684\u8d85\u53c3\u6578\u3002\u6b64\u5b57\u6bb5\u5305\u542b\u7576\u524d\u7684\u8a66\u9a57\u7de8\u865f\uff0c\u5f9e\u7b2c\u4e00\u6b21\u8a66\u9a57\u7684 1 \u958b\u59cb\u3002 cloud Vertex AI \u5167\u90e8\u4f7f\u7528\u7684 ID\u3002\u60a8\u53ef\u4ee5\u5ffd\u7565\u8a72\u5b57\u6bb5\u3002 |\n| task \u5b57\u6bb5  | task \u5b57\u6bb5                                                                                                                                                                                                                      |\n| type    | \u6b64\u865b\u64ec\u6a5f\u6b63\u5728\u57f7\u884c\u7684\u4efb\u52d9\u985e\u578b\u3002\u6b64\u503c\u5728\u5de5\u4f5c\u5668\u4e2d\u8a2d\u7f6e\u7232 worker\uff0c\u5728\u53c3\u6578\u670d\u52d9\u5668\u4e0a\u8a2d\u7f6e\u7232 ps\uff0c\u800c\u5728\u8a55\u4f30\u7a0b\u5e8f\u4e0a\u8a2d\u7f6e\u7232 evaluator\u3002\u5728\u4f5c\u696d\u7684\u4e3b\u5de5\u4f5c\u5668\u4e2d\uff0c\u503c\u8a2d\u7f6e\u7232 chief \u6216 master\uff1b\u53ef\u5728\u672c\u6587\u6a94\u7684 chief \u5c0d\u6bd4 master \u90e8\u5206\u8a73\u7d30\u77ad\u89e3\u5169\u8005\u4e4b\u9593\u7684\u5340\u5225\u3002                                                                                                                                                                  |\n| index   | \u4efb\u52d9\u7684\u7d22\u5f15\uff08\u5f9e\u96f6\u958b\u59cb\uff09\u3002\u4f8b\u5982\uff0c\u5982\u679c\u8a13\u7df4\u4f5c\u696d\u5305\u542b\u5169\u500b\u5de5\u4f5c\u5668\uff0c\u5247\u5176\u4e2d\u4e00\u500b\u503c\u8a2d\u7232 0\uff0c\u53e6\u4e00\u500b\u8a2d\u7232 1\u3002                                                                                                                                                                                                 |\n| trial   | \u7576\u524d\u5728\u6b64\u865b\u64ec\u6a5f\u4e0a\u904b\u884c\u7684\u8d85\u53c3\u6578\u8abf\u7bc0\u8a66\u9a57\u7684 ID\u3002\u50c5\u5728\u7576\u524d\u8a13\u7df4\u4f5c\u696d\u662f\u8d85\u53c3\u6578\u8abf\u7bc0\u4f5c\u696d\u6642\u624d\u8a2d\u7f6e\u6b64\u5b57\u6bb5\u3002 \u5c0d\u65bc\u8d85\u53c3\u6578\u8abf\u7bc0\u4f5c\u696d\uff0cVertex AI \u6703\u5728\u8a31\u591a\u8a66\u9a57\u4e2d\u53cd\u8986\u904b\u884c\u60a8\u7684\u8a13\u7df4\u4ee3\u78bc\uff0c\u6bcf\u6b21\u4f7f\u7528\u4e0d\u540c\u7684\u8d85\u53c3\u6578\u3002\u6b64\u5b57\u6bb5\u5305\u542b\u7576\u524d\u7684\u8a66\u9a57\u7de8\u865f\uff0c\u5f9e\u7b2c\u4e00\u6b21\u8a66\u9a57\u7684 1 \u958b\u59cb\u3002                                                                                                                                                               |\n| cloud   | Vertex AI \u5167\u90e8\u4f7f\u7528\u7684 ID\u3002\u60a8\u53ef\u4ee5\u5ffd\u7565\u8a72\u5b57\u6bb5\u3002                                                                                                                                                                                                              |\n| job    | \u60a8\u5275\u5efa\u7576\u524d\u8a13\u7df4\u4f5c\u696d\u6642\u63d0\u4f9b\u7684 CustomJobSpec\uff0c\u8868\u793a\u7232\u5b57\u5178\u3002                                                                                                                                                                                                           |\n| environment  | \u5b57\u7b26\u4e32 cloud\u3002                                                                                                                                                                                                                     |\n\u4ee5\u4e0b\u793a\u4f8b\u4ee3\u78bc\u5c07 `TF_CONFIG` \u74b0\u5883\u8b8a\u91cf\u6253\u5370\u5230\u60a8\u7684\u8a13\u7df4\u65e5\u8a8c\uff1a\n```\nimport jsonimport ostf_config_str = os.environ.get('TF_CONFIG')tf_config_dict \u00a0= json.loads(tf_config_str)# Convert back to string just for pretty printingprint(json.dumps(tf_config_dict, indent=2))\n```\n\u5728\u904b\u884c\u6642\u7248\u672c 2.1 \u6216\u66f4\u9ad8\u7248\u672c\u4e2d\u904b\u884c\u7684\u8d85\u53c3\u6578\u8abf\u7bc0\u4f5c\u696d\u4f7f\u7528\u4e00\u500b\u4e3b\u5de5\u4f5c\u5668\u3001\u5169\u500b\u5de5\u4f5c\u5668\u548c\u4e00\u500b\u53c3\u6578\u670d\u52d9\u5668\uff0c\u6b64\u4ee3\u78bc\u5728\u8a72\u4f5c\u696d\u4e2d\u5728\u7b2c\u4e00\u6b21\u8d85\u53c3\u6578\u8abf\u7bc0\u8a66\u9a57\u671f\u9593\u7232\u5176\u4e2d\u4e00\u500b\u5de5\u4f5c\u5668\u751f\u6210\u4ee5\u4e0b\u65e5\u8a8c\u3002\u793a\u4f8b\u8f38\u51fa\u7232\u4e86\u7c21\u6f54\u6703\u96b1\u85cf `job` \u5b57\u6bb5\uff0c\u4e26\u7528\u4e00\u822c\u503c\u66ff\u63db\u67d0\u4e9b ID\u3002\n```\n{\n \"cluster\": {\n \"chief\": [  \"training-workerpool0-[ID_STRING_1]-0:2222\"\n ],\n \"ps\": [  \"training-workerpool2-[ID_STRING_1]-0:2222\"\n ],\n \"worker\": [  \"training-workerpool1-[ID_STRING_1]-0:2222\",\n  \"training-workerpool1-[ID_STRING_1]-1:2222\"\n ]\n },\n \"environment\": \"cloud\",\n \"job\": {\n ...\n },\n \"task\": {\n \"cloud\": \"[ID_STRING_2]\",\n \"index\": 0,\n \"trial\": \"1\",\n \"type\": \"worker\"\n }\n}\n```\n## \u4f55\u6642\u4f7f\u7528 TF_CONFIG\n\u50c5\u7232\u5206\u4f48\u5f0f\u8a13\u7df4\u4f5c\u696d\u8a2d\u7f6e `TF_CONFIG` \u3002\n\u60a8\u53ef\u80fd\u4e0d\u9700\u8981\u76f4\u63a5\u5728\u8a13\u7df4\u4ee3\u78bc\u4e2d\u8207 `TF_CONFIG` \u74b0\u5883\u8b8a\u91cf\u4e92\u52d5\u3002\u50c5\u5728 TensorFlow \u7684\u5206\u4f48\u7b56\u7565\u548c Vertex AI \u7684\u6a19\u6e96\u8d85\u53c3\u6578\u8abf\u7bc0\u5de5\u4f5c\u6d41\uff08\u4e0b\u7bc0\u6703\u5c0d\u4e8c\u8005\u9032\u884c\u4ecb\u7d39\uff09\u90fd\u4e0d\u9069\u7528\u65bc\u60a8\u7684\u5de5\u4f5c\u7684\u60c5\u6cc1\u4e0b\uff0c\u624d\u80fd\u8a2a\u554f `TF_CONFIG` \u74b0\u5883\u8b8a\u91cf\u3002\n### \u5206\u4f48\u5f0f\u8a13\u7df4\nVertex AI \u8a2d\u7f6e `TF_CONFIG` \u74b0\u5883\u8b8a\u91cf\u4f86\u64f4\u5c55 [TensorFlow \u9032\u884c\u5206\u4f48\u5f0f\u8a13\u7df4\u6240\u9700\u7684\u898f\u7bc4](https://www.tensorflow.org/guide/distributed_training?hl=zh-cn#setting_up_tf_config_environment_variable) \u3002\n\u5982\u8981\u4f7f\u7528 TensorFlow \u57f7\u884c\u5206\u4f48\u5f0f\u8a13\u7df4\uff0c\u8acb\u4f7f\u7528 [tf.distribute.Strategy API](https://www.tensorflow.org/guide/distributed_training?hl=zh-cn) \u3002\u6211\u5011\u5c24\u5176\u5efa\u8b70\u60a8\u5c07 Keras API \u8207 [MultiWorkerMirroredStrategy](https://www.tensorflow.org/guide/distributed_training?hl=zh-cn#multiworkermirroredstrategy) \u7d50\u5408\u4f7f\u7528\uff0c\u6216\u8005\uff0c\u5982\u679c\u60a8 [\u7232\u4f5c\u696d\u6307\u5b9a\u53c3\u6578\u670d\u52d9\u5668](https://cloud.google.com/vertex-ai/docs/training/configure-compute?hl=zh-cn) \uff0c\u90a3\u9ebc\u5c07 Keras API \u8207 [ParameterServerStrategy](https://www.tensorflow.org/guide/distributed_training?hl=zh-cn#parameterserverstrategy) \u7d50\u5408\u4f7f\u7528\u3002\u4e0d\u904e\u8acb\u6ce8\u610f\uff0cTensorFlow \u76ee\u524d\u50c5\u7232\u9019\u4e9b\u7b56\u7565\u63d0\u4f9b\u5be6\u9a57\u6027\u652f\u6301\u3002\n\u9019\u4e9b\u5206\u4f48\u7b56\u7565\u4f7f\u7528 `TF_CONFIG` \u74b0\u5883\u8b8a\u91cf\u7232\u8a13\u7df4\u4f5c\u696d\u4e2d\u7684\u6bcf\u500b\u865b\u64ec\u6a5f\u5206\u914d\u89d2\u8272\uff0c\u4e26\u4fc3\u9032\u865b\u64ec\u6a5f\u4e4b\u9593\u7684\u901a\u4fe1\u3002\u60a8\u7121\u9700\u76f4\u63a5\u5728\u8a13\u7df4\u4ee3\u78bc\u4e2d\u8a2a\u554f `TF_CONFIG` \u74b0\u5883\u8b8a\u91cf\uff0c\u56e0\u7232 TensorFlow \u6703\u7232\u60a8\u8655\u7406\u3002\n\u5982\u679c\u8981\u81ea\u5b9a\u7fa9\u904b\u884c\u8a13\u7df4\u4f5c\u696d\u7684\u4e0d\u540c\u865b\u64ec\u6a5f\u7684\u884c\u7232\u65b9\u5f0f\uff0c\u50c5\u9700\u76f4\u63a5\u89e3\u6790 `TF_CONFIG` \u74b0\u5883\u8b8a\u91cf\u3002\n### \u8d85\u53c3\u6578\u8abf\u7bc0\n\u7576\u60a8\u904b\u884c [\u8d85\u53c3\u6578\u8abf\u7bc0\u4f5c\u696d](https://cloud.google.com/vertex-ai/docs/training/hyperparameter-tuning-overview?hl=zh-cn) \u6642\uff0cVertex AI \u6703\u7232\u6bcf\u6b21\u8a66\u9a57\u7684\u8a13\u7df4\u4ee3\u78bc\u63d0\u4f9b\u4e0d\u540c\u7684\u53c3\u6578\u3002\u60a8\u7684\u8a13\u7df4\u4ee3\u78bc\u4e0d\u5fc5\u77e5\u9053\u7576\u524d\u6b63\u5728\u904b\u884c\u7684\u8a66\u9a57\u3002\u6b64\u5916\uff0c\u60a8\u53ef\u4ee5\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u76e3\u63a7\u8d85\u53c3\u6578\u8abf\u7bc0\u4f5c\u696d\u7684\u9032\u5ea6\u3002\n\u5982\u679c\u9700\u8981\uff0c\u60a8\u7684\u4ee3\u78bc\u53ef\u4ee5\u5f9e [TF_CONFIG \u74b0\u5883\u8b8a\u91cf\u7684 task \u5b57\u6bb5\u7684 trial \u5b57\u6bb5\u4e2d\u8b80\u53d6\u7576\u524d\u7684\u8a66\u9a57\u7de8\u865f](#tf-config) \u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u5275\u5efa [\u8a13\u7df4\u6d41\u6c34\u7dda](https://cloud.google.com/vertex-ai/docs/training/create-training-pipeline?hl=zh-cn) \u3002", "guide": "Vertex AI"}