{"title": "Vertex AI - Use a user-managed notebooks instance within a service perimeter", "url": "https://cloud.google.com/vertex-ai/docs/workbench/user-managed/service-perimeter", "abstract": "# Vertex AI - Use a user-managed notebooks instance within a service perimeter\n# Use a user-managed notebooks instance within a service perimeter\nVertex AI Workbench user-managed notebooks is [deprecated](/vertex-ai/docs/deprecations) . On January 30, 2025, support for  user-managed notebooks will end and the ability to create user-managed notebooks instances  will be removed. Existing instances will continue to function  but patches, updates, and upgrades won't be available. To continue using  Vertex AI Workbench, we recommend that you [migrate your user-managed notebooks instances to Vertex AI Workbench instances](/vertex-ai/docs/workbench/user-managed/migrate-to-instances) .\nThis page describes how to use VPC Service Controls to set up a user-managed notebooks instance within a service perimeter.\n", "content": "## Before you begin\n- Read the [Overview ofVPC Service Controls](/vpc-service-controls/docs/overview) .\n- [Create a user-managed notebooksinstance](/vertex-ai/docs/workbench/user-managed/create-new) . This instance is not within a service perimeter yet.\n- [Create a service perimeter usingVPC Service Controls](/vpc-service-controls/docs/create-service-perimeters) . This service perimeter protects the Google-managed resources of services that you specify. While creating your service perimeter, do the following:- When it's time to add projects to your service perimeter, add the project that contains your user-managed notebooks instance.\n- When it's time to add services to your service perimeter, add the **Notebooks API** .\nIf you have created your service perimeter without adding the projects and services you need, see [Managing serviceperimeters](/vpc-service-controls/docs/manage-service-perimeters) to learn how to update your service perimeter.## Configure your DNS entries using Cloud DNS\nVertex AI Workbench user-managed notebooks instances use several domains that a Virtual Private Cloud network doesn't handle by default. To ensure that your VPC network correctly handles requests sent to those domains, use Cloud DNS to add DNS records. For more information about VPC routes, see [Routes overview](/vpc/docs/routes) .\nTo create a [managed zone](/dns/zones) for a domain, add a DNS entry that will route the request, and execute the transaction, complete the following steps. Repeat these steps for each of [several domains](#domains) that you need to handle requests for, starting with `*.notebooks.googleapis.com` .\nIn [Cloud Shell](https://console.cloud.google.com?cloudshell=true) or any environment where the [Google Cloud CLI](/sdk/docs) is installed, enter the following [Google Cloud CLI](/sdk/gcloud) commands.\n- To create a private managed zone  for one of the domains that your  VPC network needs to handle:```\n gcloud dns managed-zones create ZONE_NAME \\\n  --visibility=private \\\n  --networks=https://www.googleapis.com/compute/v1/projects/PROJECT_ID/global/networks/NETWORK_NAME \\\n  --dns-name=DNS_NAME \\\n  --description=\"Description of your managed zone\"\n \n```Replace the following:- ``: a name for the zone to create.   You must use a separate zone for each domain. This zone name is used in   each of the following steps.\n- ``: the ID of the project that hosts your   VPC network\n- ``: the name of the VPC   network that you created earlier\n- ``: the part of the domain name that comes   after the`*.`, with a period on the end.   For example,`*.notebooks.googleapis.com`has a``of`notebooks.googleapis.com.`\n- Start a transaction.```\n gcloud dns record-sets transaction start --zone=ZONE_NAME\n \n```\n- Add the following DNS A record. This reroutes traffic to  Google's restricted IP addresses.```\n gcloud dns record-sets transaction add \\\n  --name=DNS_NAME. \\\n  --type=A 199.36.153.4 199.36.153.5 199.36.153.6 199.36.153.7 \\\n  --zone=ZONE_NAME \\\n  --ttl=300\n \n```\n- Add the following DNS CNAME record to point to the A record  that you just added. This redirects all traffic matching the  domain to the IP addresses listed in the previous step.```\n gcloud dns record-sets transaction add \\\n  --name=\\*.DNS_NAME. \\\n  --type=CNAME DNS_NAME. \\\n  --zone=ZONE_NAME \\\n  --ttl=300\n \n```\n- Execute the transaction.```\n gcloud dns record-sets transaction execute --zone=ZONE_NAME\n \n```\n- Repeat these steps for each of the following domains. For each  repetition, change and to the appropriate values for that  domain. Keep and the same each time. You already  completed these steps for `*.notebooks.googleapis.com` .- `*.notebooks.googleapis.com`\n- `*.notebooks.cloud.google.com`\n- `*.notebooks.googleusercontent.com`\n- `*.googleapis.com`to run code that interacts with other Google APIs   and services\n## Configure the service perimeter\nAfter [configuring the DNS records](#configure-dns) , either [create a serviceperimeter](/vpc-service-controls/docs/create-service-perimeters) or [update an existingperimeter](/vpc-service-controls/docs/manage-service-perimeters) to add your project to the service perimeter.\nIn the VPC network, add a route for the `199.36.153.4/30` range with a next hop of `Default internet gateway` .\n**Note:** The `199.36.153.4/30` range is for `restricted.googleapis.com` to  access APIs that are only VPC Service Controls compatible.  If you aren't using VPC Service Controls, you can use the `199.36.153.8/30` range for `private.googleapis.com` . For more  information about Private Google Access, see [Configure  Private Google Access](/vpc/docs/configure-private-google-access) .\n## Use Artifact Registry within your service perimeter\nIf you want to use Artifact Registry in your service perimeter, see [Configure restricted access for GKEprivate clusters](/artifact-registry/docs/gke-private-clusters) .\n## Use Shared VPC\nIf you are using [Shared VPC](/vpc/docs/shared-vpc) , you must add the host and the service projects to the service perimeter. In the host project, you must also grant the [Compute Network User role](/iam/docs/understanding-roles#compute-engine-roles) ( `roles/compute.networkUser` ) to the [Notebooks ServiceAgent](/iam/docs/service-agents#cloud-ai-platform-notebooks-service-account) from the service project. For more information, see [Managingservice perimeters](/vpc-service-controls/docs/manage-service-perimeters) .\n## Access your user-managed notebooks instance\nFollow the [steps for opening anotebook](/vertex-ai/docs/workbench/user-managed/create-new#open_the_notebook_2) .\n## Limitations\n### Identity type for ingress and egress policies\nWhen you specify an ingress or egress policy for a service perimeter, you can't use `ANY_SERVICE_ACCOUNT` or `ANY_USER_ACCOUNT` as an identity type for all [Vertex AI Workbench](/vertex-ai/docs/workbench) operations.\nInstead, use `ANY_IDENTITY` as the identity type.\n### Accessing the user-managed notebooks proxy from a workstation without internet\nTo access user-managed notebooks instances from a workstation with limited internet access, verify with your IT administrator that you can access the following domains:\n- `*.accounts.google.com`\n- `*.accounts.youtube.com`\n- `*.googleusercontent.com`\n- `*.kernels.googleusercontent.com`\n- `*.gstatic.com`\n- `*.notebooks.cloud.google.com`\n- `*.notebooks.googleapis.com`\nYou must have access to these domains for authentication to Google Cloud. See the previous section, [Configure your DNS entries using Cloud DNS](#configure-dns) , for further configuration information.\n## What's next\n- [Install dependencies](/vertex-ai/docs/workbench/user-managed/dependencies) on your new user-managed notebooks instance.", "guide": "Vertex AI"}