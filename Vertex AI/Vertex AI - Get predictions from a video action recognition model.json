{"title": "Vertex AI - Get predictions from a video action recognition model", "url": "https://cloud.google.com/vertex-ai/docs/video-data/action-recognition/get-predictions", "abstract": "# Vertex AI - Get predictions from a video action recognition model\nThis page shows you how to get from your video action recognition models using the Google Cloud console or the Vertex AI API. Batch predictions are asynchronous requests. You request batch predictions directly from the model resource without needing to deploy the model to an endpoint.\nAutoML video models do not support online predictions.\n", "content": "## Get batch predictions\nTo make a batch prediction request, you specify an [input source](#input_data) and an [output format](#output_format) where Vertex AI stores predictions results.\n**Note:** To minimize processing time when you use the Google Cloud console to create batch predictions, we recommend that you select input and output locations that are in the same region as your model. If you use the API to create batch predictions, send requests to a service endpoint (such as `https://us-central1-aiplatform.googleapis.com` ) that is in the same region or geographically close to your input and output locations.\n### Input data requirements\nThe input for batch requests specifies the items to send to your model for prediction. Batch predictions for the AutoML video model type use a JSON Lines file to specify a list of videos to make predictions for, and then store the JSON Lines file in a Cloud Storage bucket. You can specify `Infinity` for the `timeSegmentEnd` field to specify the end of the video. The following sample shows a single line in an input JSON Lines file.\n```\n{'content': 'gs://sourcebucket/datasets/videos/source_video.mp4', 'mimeType': 'video/mp4', 'timeSegmentStart': '0.0s', 'timeSegmentEnd': '2.366667s'}\n```\n### Request a batch prediction\nFor batch prediction requests, you can use the Google Cloud console or the Vertex AI API. Depending on the number of input items that you've submitted, a batch prediction task can take some time to complete.\nUse the Google Cloud console to request a batch prediction.- In the Google Cloud console, in the Vertex AI section, go to the **Batch predictions** page. [Go to the Batch predictions page](https://console.cloud.google.com/vertex-ai/batch-predictions) \n- Click **Create** to open the **New batch prediction** window and complete the following steps:- Enter a name for the batch prediction.\n- For **Model name** , select the name of the model to use for this batch prediction.\n- For **Source path** , specify the Cloud Storage location where your JSON Lines input file is located.\n- For the **Destination path** , specify a Cloud Storage location where the batch prediction results are stored. The **Output** format is determined by your model's objective. AutoML models for image objectives output JSON Lines files.\nUse the Vertex AI API to send batch prediction requests.\nBefore using any of the request data, make the following replacements:- : Region where Model is stored and batch prediction job is executed. For example,`us-central1`.\n- : Your [project ID](/resource-manager/docs/creating-managing-projects#identifiers) \n- : Display name for the batch job\n- : The ID for the model to use for making predictions\n- (optional): Model returns only predictions that  have confidence scores with at least this value\n- : Cloud Storage URI where your input JSON Lines file is  located.\n- : Your Cloud Storage bucket\n- : Your project's automatically generated [project number](/resource-manager/docs/creating-managing-projects#identifiers) \nHTTP method and URL:\n```\nPOST https://LOCATION_ID-aiplatform.googleapis.com/v1/projects/PROJECT_ID/locations/LOCATION_ID/batchPredictionJobs\n```\nRequest JSON body:\n```\n{\n \"displayName\": \"BATCH_JOB_NAME\",\n \"model\": \"projects/PROJECT_ID/locations/LOCATION_ID/models/MODEL_ID\",\n \"modelParameters\": {\n  \"confidenceThreshold\": THRESHOLD_VALUE,\n },\n \"inputConfig\": {\n  \"instancesFormat\": \"jsonl\",\n  \"gcsSource\": {\n   \"uris\": [\"URI\"],\n  },\n },\n \"outputConfig\": {\n  \"predictionsFormat\": \"jsonl\",\n  \"gcsDestination\": {\n   \"outputUriPrefix\": \"OUTPUT_BUCKET\",\n  },\n },\n}\n```\nTo send your request, choose one of these options:\n **Note:** The following command assumes that you have logged in to  the`gcloud`CLI with your user account by running [gcloud init](/sdk/gcloud/reference/init) or [gcloud auth login](/sdk/gcloud/reference/auth/login) ,  or by using [Cloud Shell](/shell/docs) ,  which automatically logs you into the`gcloud`CLI.  You can check the currently active account by running [gcloud auth list](/sdk/gcloud/reference/auth/list) .\nSave the request body in a file named `request.json` ,  and execute the following command:\n```\ncurl -X POST \\ -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\ -H \"Content-Type: application/json; charset=utf-8\" \\ -d @request.json \\ \"https://LOCATION_ID-aiplatform.googleapis.com/v1/projects/PROJECT_ID/locations/LOCATION_ID/batchPredictionJobs\"\n``` **Note:** The following command assumes that you have logged in to  the`gcloud`CLI with your user account by running [gcloud init](/sdk/gcloud/reference/init) or [gcloud auth login](/sdk/gcloud/reference/auth/login) ,  or by using [Cloud Shell](/shell/docs) ,  which automatically logs you into the`gcloud`CLI.  You can check the currently active account by running [gcloud auth list](/sdk/gcloud/reference/auth/list) .\nSave the request body in a file named `request.json` ,  and execute the following command:\n```\n$cred = gcloud auth print-access-token$headers = @{ \"Authorization\" = \"Bearer $cred\" }Invoke-WebRequest ` -Method POST ` -Headers $headers ` -ContentType: \"application/json; charset=utf-8\" ` -InFile request.json ` -Uri \"https://LOCATION_ID-aiplatform.googleapis.com/v1/projects/PROJECT_ID/locations/LOCATION_ID/batchPredictionJobs\" | Select-Object -Expand Content\n```\nYou should receive a JSON response similar to the following:\n```\n{\n \"name\": \"projects/PROJECT_NUMBER/locations/us-central1/batchPredictionJobs/BATCH_JOB_ID\",\n \"displayName\": \"BATCH_JOB_NAME\",\n \"model\": \"projects/PROJECT_NUMBER/locations/us-central1/models/MODEL_ID\",\n \"inputConfig\": {\n \"instancesFormat\": \"jsonl\",\n \"gcsSource\": {\n  \"uris\": [  \"CONTENT\"\n  ]\n }\n },\n \"outputConfig\": {\n \"predictionsFormat\": \"jsonl\",\n \"gcsDestination\": {\n  \"outputUriPrefix\": \"BUCKET\"\n }\n },\n \"state\": \"JOB_STATE_PENDING\",\n \"createTime\": \"2020-05-30T02:58:44.341643Z\",\n \"updateTime\": \"2020-05-30T02:58:44.341643Z\",\n \"modelDisplayName\": \"MODEL_NAME\",\n \"modelObjective\": \"MODEL_OBJECTIVE\"\n}\n```\nYou can poll for the status of the batch job using the until the job `state` is `JOB_STATE_SUCCEEDED` .\nBefore trying this sample, follow the Java setup instructions in the [Vertex AI quickstart using   client libraries](/vertex-ai/docs/start/client-libraries) .       For more information, see the [Vertex AI Java API reference documentation](/java/docs/reference/google-cloud-aiplatform/latest/com.google.cloud.aiplatform.v1) .\nTo authenticate to Vertex AI, set up Application Default Credentials.  For more information, see [Set up authentication for a local development environment](/docs/authentication/provide-credentials-adc#local-dev) .\n [View on GitHub](https://github.com/GoogleCloudPlatform/java-docs-samples/blob/HEAD/aiplatform/src/main/java/aiplatform/CreateBatchPredictionJobVideoActionRecognitionSample.java) \n```\nimport com.google.cloud.aiplatform.util.ValueConverter;import com.google.cloud.aiplatform.v1.BatchPredictionJob;import com.google.cloud.aiplatform.v1.GcsDestination;import com.google.cloud.aiplatform.v1.GcsSource;import com.google.cloud.aiplatform.v1.JobServiceClient;import com.google.cloud.aiplatform.v1.JobServiceSettings;import com.google.cloud.aiplatform.v1.LocationName;import com.google.cloud.aiplatform.v1.ModelName;import com.google.protobuf.Value;import java.io.IOException;public class CreateBatchPredictionJobVideoActionRecognitionSample {\u00a0 public static void main(String[] args) throws IOException {\u00a0 \u00a0 // TODO(developer): Replace these variables before running the sample.\u00a0 \u00a0 String project = \"PROJECT\";\u00a0 \u00a0 String displayName = \"DISPLAY_NAME\";\u00a0 \u00a0 String model = \"MODEL\";\u00a0 \u00a0 String gcsSourceUri = \"GCS_SOURCE_URI\";\u00a0 \u00a0 String gcsDestinationOutputUriPrefix = \"GCS_DESTINATION_OUTPUT_URI_PREFIX\";\u00a0 \u00a0 createBatchPredictionJobVideoActionRecognitionSample(\u00a0 \u00a0 \u00a0 \u00a0 project, displayName, model, gcsSourceUri, gcsDestinationOutputUriPrefix);\u00a0 }\u00a0 static void createBatchPredictionJobVideoActionRecognitionSample(\u00a0 \u00a0 \u00a0 String project,\u00a0 \u00a0 \u00a0 String displayName,\u00a0 \u00a0 \u00a0 String model,\u00a0 \u00a0 \u00a0 String gcsSourceUri,\u00a0 \u00a0 \u00a0 String gcsDestinationOutputUriPrefix)\u00a0 \u00a0 \u00a0 throws IOException {\u00a0 \u00a0 JobServiceSettings settings =\u00a0 \u00a0 \u00a0 \u00a0 JobServiceSettings.newBuilder()\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .setEndpoint(\"us-central1-aiplatform.googleapis.com:443\")\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .build();\u00a0 \u00a0 String location = \"us-central1\";\u00a0 \u00a0 // Initialize client that will be used to send requests. This client only needs to be created\u00a0 \u00a0 // once, and can be reused for multiple requests. After completing all of your requests, call\u00a0 \u00a0 // the \"close\" method on the client to safely clean up any remaining background resources.\u00a0 \u00a0 try (JobServiceClient client = JobServiceClient.create(settings)) {\u00a0 \u00a0 \u00a0 Value modelParameters = ValueConverter.EMPTY_VALUE;\u00a0 \u00a0 \u00a0 GcsSource gcsSource = GcsSource.newBuilder().addUris(gcsSourceUri).build();\u00a0 \u00a0 \u00a0 BatchPredictionJob.InputConfig inputConfig =\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 BatchPredictionJob.InputConfig.newBuilder()\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .setInstancesFormat(\"jsonl\")\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .setGcsSource(gcsSource)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .build();\u00a0 \u00a0 \u00a0 GcsDestination gcsDestination =\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 GcsDestination.newBuilder().setOutputUriPrefix(gcsDestinationOutputUriPrefix).build();\u00a0 \u00a0 \u00a0 BatchPredictionJob.OutputConfig outputConfig =\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 BatchPredictionJob.OutputConfig.newBuilder()\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .setPredictionsFormat(\"jsonl\")\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .setGcsDestination(gcsDestination)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .build();\u00a0 \u00a0 \u00a0 String modelName = ModelName.of(project, location, model).toString();\u00a0 \u00a0 \u00a0 BatchPredictionJob batchPredictionJob =\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 BatchPredictionJob.newBuilder()\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .setDisplayName(displayName)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .setModel(modelName)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .setModelParameters(modelParameters)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .setInputConfig(inputConfig)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .setOutputConfig(outputConfig)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .build();\u00a0 \u00a0 \u00a0 LocationName parent = LocationName.of(project, location);\u00a0 \u00a0 \u00a0 BatchPredictionJob response = client.createBatchPredictionJob(parent, batchPredictionJob);\u00a0 \u00a0 \u00a0 System.out.format(\"response: %s\\n\", response);\u00a0 \u00a0 \u00a0 System.out.format(\"\\tName: %s\\n\", response.getName());\u00a0 \u00a0 }\u00a0 }}\n```To learn how to install or update the Python, see [Install the Vertex AI SDK for Python](/vertex-ai/docs/start/use-vertex-ai-python-sdk) .    For more information, see the [   Python API reference documentation](/python/docs/reference/aiplatform/latest) .\n [View on GitHub](https://github.com/googleapis/python-aiplatform/blob/HEAD/samples/model-builder/create_batch_prediction_job_sample.py) \n```\ndef create_batch_prediction_job_sample(\u00a0 \u00a0 project: str,\u00a0 \u00a0 location: str,\u00a0 \u00a0 model_resource_name: str,\u00a0 \u00a0 job_display_name: str,\u00a0 \u00a0 gcs_source: Union[str, Sequence[str]],\u00a0 \u00a0 gcs_destination: str,\u00a0 \u00a0 sync: bool = True,):\u00a0 \u00a0 aiplatform.init(project=project, location=location)\u00a0 \u00a0 my_model = aiplatform.Model(model_resource_name)\u00a0 \u00a0 batch_prediction_job = my_model.batch_predict(\u00a0 \u00a0 \u00a0 \u00a0 job_display_name=job_display_name,\u00a0 \u00a0 \u00a0 \u00a0 gcs_source=gcs_source,\u00a0 \u00a0 \u00a0 \u00a0 gcs_destination_prefix=gcs_destination,\u00a0 \u00a0 \u00a0 \u00a0 sync=sync,\u00a0 \u00a0 )\u00a0 \u00a0 batch_prediction_job.wait()\u00a0 \u00a0 print(batch_prediction_job.display_name)\u00a0 \u00a0 print(batch_prediction_job.resource_name)\u00a0 \u00a0 print(batch_prediction_job.state)\u00a0 \u00a0 return batch_prediction_job\n```\n### Retrieve batch prediction results\nVertex AI sends batch prediction output to your specified destination.\nWhen a batch prediction task is complete, the output of the prediction is stored in the Cloud Storage bucket that you specified in your request.### Example batch prediction results\nThe following an example batch prediction results from a video action recognition model.\n```\n{\n \"instance\": {\n \"content\": \"gs://bucket/video.mp4\",\n \"mimeType\": \"video/mp4\",\n \"timeSegmentStart\": \"1s\",\n \"timeSegmentEnd\": \"5s\"\n }\n \"prediction\": [{\n \"id\": \"1\",\n \"displayName\": \"swing\",\n \"timeSegmentStart\": \"1.2s\",\n \"timeSegmentEnd\": \"1.2s\",\n \"confidence\": 0.7\n }, {\n \"id\": \"2\",\n \"displayName\": \"jump\",\n \"timeSegmentStart\": \"3.4s\",\n \"timeSegmentEnd\": \"3.4s\",\n \"confidence\": 0.5\n }]\n}\n```", "guide": "Vertex AI"}