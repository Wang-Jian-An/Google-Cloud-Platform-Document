{"title": "Vertex AI - \u89f8\u767c\u4f7f\u7528 Cloud Pub/Sub \u7684\u6d41\u6c34\u7dda\u904b\u884c", "url": "https://cloud.google.com/vertex-ai/docs/pipelines/trigger-pubsub?hl=zh-cn", "abstract": "# Vertex AI - \u89f8\u767c\u4f7f\u7528 Cloud Pub/Sub \u7684\u6d41\u6c34\u7dda\u904b\u884c\n\u4ee5\u4e0b\u4ee3\u78bc\u793a\u4f8b\u5c55\u793a\u5982\u4f55\u4f7f\u7528 [\u4e8b\u4ef6\u9a45\u52d5\u578b Cloud Functions \u51fd\u6578](https://cloud.google.com/functions/docs/writing?hl=zh-cn#event-driven_functions) \u4ee5\u53ca [Cloud Pub/Sub \u89f8\u767c\u5668](https://cloud.google.com/functions/docs/calling/pubsub?hl=zh-cn) \u4f86\u7de8\u5beb\u3001\u90e8\u7f72\u548c\u89f8\u767c\u6d41\u6c34\u7dda\u3002\n#", "content": "## \u69cb\u5efa\u548c\u7de8\u8b6f\u7c21\u55ae\u7684\u6d41\u6c34\u7dda\n\u4f7f\u7528 Kubeflow Pipelines SDK \u69cb\u5efa\u8a08\u5283\u6d41\u6c34\u7dda\u4e26\u5c07\u5176\u7de8\u8b6f\u7232 YAML \u6587\u4ef6\u3002\n\u793a\u4f8b `hello-world-scheduled-pipeline` \uff1a\n```\nfrom kfp import compilerfrom kfp import dsl# A simple component that prints and returns a greeting string@dsl.componentdef hello_world(message: str) -> str:\u00a0 \u00a0 greeting_str = f'Hello, {message}'\u00a0 \u00a0 print(greeting_str)\u00a0 \u00a0 return greeting_str# A simple pipeline that contains a single hello_world task@dsl.pipeline(\u00a0 \u00a0 name='hello-world-scheduled-pipeline')def hello_world_scheduled_pipeline(greet_name: str):\u00a0 \u00a0 hello_world_task = hello_world(greet_name)# Compile the pipeline and generate a YAML filecompiler.Compiler().compile(pipeline_func=hello_world_scheduled_pipeline,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 package_path='hello_world_scheduled_pipeline.yaml')\n```\n### \u5c07\u5df2\u7de8\u8b6f\u7684\u6d41\u6c34\u7dda YAML \u4e0a\u50b3\u5230 Cloud Storage \u5b58\u5132\u6876\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u6253\u958b Cloud Storage \u700f\u89bd\u5668\u3002 [Cloud Storage \u700f\u89bd\u5668](https://console.cloud.google.com/storage/browser/?hl=zh-cn) \n- \u9ede\u64ca\u60a8\u5728 [\u914d\u7f6e\u9805\u76ee](https://cloud.google.com/vertex-ai/docs/pipelines/configure-project?hl=zh-cn) \u6642\u5275\u5efa\u7684 Cloud Storage \u5b58\u5132\u5206\u5340\u3002\n- \u4f7f\u7528\u73fe\u6709\u6587\u4ef6\u593e\u6216\u65b0\u6587\u4ef6\u593e\uff0c\u5c07\u5df2\u7de8\u8b6f\u7684\u6d41\u6c34\u7dda YAML\uff08\u5728\u6b64\u793a\u4f8b\u4e2d\u7232 `hello_world_scheduled_pipeline.yaml` \uff09\u4e0a\u50b3\u5230\u6240\u9078\u6587\u4ef6\u593e\u3002\n- \u9ede\u64ca\u4e0a\u50b3\u7684 YAML \u6587\u4ef6\u4ee5\u8a2a\u554f\u8a73\u7d30\u4fe1\u606f\u3002\u8907\u88fd **gsutil URI** \u4ee5\u5099\u5f8c\u7528\u3002\n### \u4f7f\u7528 Pub/Sub \u89f8\u767c\u5668\u5275\u5efa Cloud Functions \u51fd\u6578\n- \u8a2a\u554f\u63a7\u5236\u6aaf\u4e2d\u7684 Cloud Functions \u9801\u9762\u3002 [\u8f49\u5230 Cloud Functions \u9801\u9762](https://console.cloud.google.com/functions?hl=zh-cn) \n- \u9ede\u64ca **\u5275\u5efa\u51fd\u6578** \u6309\u9215\u3002\n- \u5728 **\u57fa\u790e\u77e5\u8b58** \u90e8\u5206\u4e2d\uff0c\u7232\u60a8\u7684\u51fd\u6578\u547d\u540d\uff08\u4f8b\u5982 `my-scheduled-pipeline-function` \uff09\u3002\n- \u5728 **\u89f8\u767c\u5668** \u90e8\u5206\u4e2d\uff0c\u9078\u64c7 **Cloud Pub/Sub** \u4f5c\u7232\u89f8\u767c\u5668\u985e\u578b\u3002\n- \u5728 **\u9078\u64c7 Cloud Pub/Sub \u4e3b\u984c** \u4e0b\u62c9\u5217\u8868\u4e2d\uff0c\u9ede\u64ca **\u5275\u5efa\u4e3b\u984c** \u3002\n- \u5728 **\u5275\u5efa\u4e3b\u984c** \u6846\u4e2d\uff0c\u7232\u60a8\u7684\u65b0\u4e3b\u984c\u547d\u540d\uff08\u4f8b\u5982 `my-scheduled-pipeline-topic` \uff09\uff0c\u7136\u5f8c\u9078\u64c7 **\u5275\u5efa\u4e3b\u984c** \u3002\n- \u5c07\u6240\u6709\u5176\u4ed6\u5b57\u6bb5\u4fdd\u7559\u7232\u9ed8\u8a8d\u503c\uff0c\u7136\u5f8c\u9ede\u64ca **\u4fdd\u5b58** \u4ee5\u4fdd\u5b58\u201c\u89f8\u767c\u5668\u201d\u90e8\u5206\u914d\u7f6e\u3002\n- \u5c07\u5176\u4ed6\u6240\u6709\u5b57\u6bb5\u4fdd\u7559\u7232\u9ed8\u8a8d\u503c\uff0c\u7136\u5f8c\u9ede\u64ca **\u4e0b\u4e00\u6b65** \u4ee5\u7e7c\u7e8c\u8f49\u5230\u201c\u4ee3\u78bc\u201d\u90e8\u5206\u3002\n- \u5728 **\u904b\u884c\u6642** \u4e0b\uff0c\u9078\u64c7 **Python 3.7** \u3002\n- \u5728 **\u5165\u53e3\u9ede** \u4e2d\uff0c\u8f38\u5165\u201c\u8a02\u95b1\u201d\uff08\u793a\u4f8b\u4ee3\u78bc\u5165\u53e3\u9ede\u51fd\u6578\u540d\u7a31\uff09\u3002\n- \u5728 **\u6e90\u4ee3\u78bc** \u4e0b\uff0c\u9078\u64c7 **\u5167\u5d4c\u7de8\u8f2f\u5668** \uff08\u5982\u679c\u5c1a\u672a\u9078\u64c7\uff09\u3002\n- \u5728 `main.py` \u6587\u4ef6\u4e2d\uff0c\u6dfb\u52a0\u4ee5\u4e0b\u4ee3\u78bc\uff1a```\n\u00a0 import base64\u00a0 import json\u00a0 from google.cloud import aiplatform\u00a0 PROJECT_ID = 'your-project-id' \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 # <---CHANGE THIS\u00a0 REGION = 'your-region' \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 # <---CHANGE THIS\u00a0 PIPELINE_ROOT = 'your-cloud-storage-pipeline-root' # <---CHANGE THIS\u00a0 def subscribe(event, context):\u00a0 \u00a0 \"\"\"Triggered from a message on a Cloud Pub/Sub topic.\u00a0 \u00a0 Args:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 event (dict): Event payload.\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 context (google.cloud.functions.Context): Metadata for the event.\u00a0 \u00a0 \"\"\"\u00a0 \u00a0 # decode the event payload string\u00a0 \u00a0 payload_message = base64.b64decode(event['data']).decode('utf-8')\u00a0 \u00a0 # parse payload string into JSON object\u00a0 \u00a0 payload_json = json.loads(payload_message)\u00a0 \u00a0 # trigger pipeline run with payload\u00a0 \u00a0 trigger_pipeline_run(payload_json)\u00a0 def trigger_pipeline_run(payload_json):\u00a0 \u00a0 \"\"\"Triggers a pipeline run\u00a0 \u00a0 Args:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 payload_json: expected in the following format:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"pipeline_spec_uri\": \"<path-to-your-compiled-pipeline>\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"parameter_values\": {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"greet_name\": \"<any-greet-string>\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \"\"\"\u00a0 \u00a0 pipeline_spec_uri = payload_json['pipeline_spec_uri']\u00a0 \u00a0 parameter_values = payload_json['parameter_values']\u00a0 \u00a0 # Create a PipelineJob using the compiled pipeline from pipeline_spec_uri\u00a0 \u00a0 aiplatform.init(\u00a0 \u00a0 \u00a0 \u00a0 project=PROJECT_ID,\u00a0 \u00a0 \u00a0 \u00a0 location=REGION,\u00a0 \u00a0 )\u00a0 \u00a0 job = aiplatform.PipelineJob(\u00a0 \u00a0 \u00a0 \u00a0 display_name='hello-world-pipeline-cloud-function-invocation',\u00a0 \u00a0 \u00a0 \u00a0 template_path=pipeline_spec_uri,\u00a0 \u00a0 \u00a0 \u00a0 pipeline_root=PIPELINE_ROOT,\u00a0 \u00a0 \u00a0 \u00a0 enable_caching=False,\u00a0 \u00a0 \u00a0 \u00a0 parameter_values=parameter_values\u00a0 \u00a0 )\u00a0 \u00a0 # Submit the PipelineJob\u00a0 \u00a0 job.submit()\n```\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- \uff1a\u5728\u5176\u4e2d\u904b\u884c\u6b64\u6d41\u6c34\u7dda\u7684 Google Cloud \u9805\u76ee\u3002\n- \uff1a\u6b64\u6d41\u6c34\u7dda\u904b\u884c\u6240\u5728\u7684\u5340\u57df\u3002\n- \uff1a\u6307\u5b9a\u6d41\u6c34\u7dda\u670d\u52d9\u8cec\u865f\u53ef\u4ee5\u8a2a\u554f\u7684 Cloud Storage URI\u3002\u6d41\u6c34\u7dda\u904b\u884c\u7684\u5de5\u4ef6\u5b58\u5132\u5728\u6d41\u6c34\u7dda\u6839\u76ee\u9304\u4e2d\u3002\n- \u5728 `requirements.txt` \u6587\u4ef6\u4e2d\uff0c\u5c07\u5167\u5bb9\u66ff\u63db\u7232\u4ee5\u4e0b\u8edf\u4ef6\u5305\u8981\u6c42\uff1a```\ngoogle-api-python-client>=1.7.8,<2google-cloud-aiplatform\n```\n- \u9ede\u64ca **\u90e8\u7f72** \u4ee5\u90e8\u7f72\u8a72\u51fd\u6578\u3002", "guide": "Vertex AI"}