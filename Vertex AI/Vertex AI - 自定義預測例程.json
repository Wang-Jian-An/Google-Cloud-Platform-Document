{"title": "Vertex AI - \u81ea\u5b9a\u7fa9\u9810\u6e2c\u4f8b\u7a0b", "url": "https://cloud.google.com/vertex-ai/docs/predictions/custom-prediction-routines?hl=zh-cn", "abstract": "# Vertex AI - \u81ea\u5b9a\u7fa9\u9810\u6e2c\u4f8b\u7a0b\n\u901a\u904e\u81ea\u5b9a\u7fa9\u9810\u6e2c\u4f8b\u7a0b (CPR)\uff0c\u60a8\u53ef\u4ee5\u8f15\u9b06\u69cb\u5efa\u5177\u6709\u9810\u8655\u7406/\u5f8c\u8655\u7406\u4ee3\u78bc\u7684 [\u81ea\u5b9a\u7fa9\u5bb9\u5668](https://cloud.google.com/vertex-ai/docs/predictions/use-custom-container?hl=zh-cn) \uff0c\u800c\u7121\u9700\u8655\u7406 HTTP \u670d\u52d9\u5668\u8a2d\u7f6e\u6216\u5f9e\u982d\u958b\u59cb\u69cb\u5efa\u5bb9\u5668\u7684\u8a73\u7d30\u4fe1\u606f\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u9810\u8655\u7406\u4f86\u5c0d\u8f38\u5165\u9032\u884c\u6b78\u4e00\u5316/\u8f49\u63db\uff0c\u6216\u8005\u8abf\u7528\u5916\u90e8\u670d\u52d9\u4ee5\u7372\u53d6\u5176\u4ed6\u6578\u64da\uff0c\u4e26\u4f7f\u7528\u5f8c\u8655\u7406\u8a2d\u7f6e\u6a21\u578b\u9810\u6e2c\u7684\u683c\u5f0f\u6216\u904b\u884c\u696d\u52d9\u908f\u8f2f\u3002\n\u4e0b\u5716\u5c55\u793a\u4e86\u4f7f\u7528\u548c\u4e0d\u4f7f\u7528\u81ea\u5b9a\u7fa9\u9810\u6e2c\u4f8b\u7a0b\u7684\u7528\u6236\u5de5\u4f5c\u6d41\u3002\n\u4e3b\u8981\u5340\u5225\u5982\u4e0b\uff1a\n- \u60a8\u7121\u9700\u7de8\u5beb\u6a21\u578b\u670d\u52d9\u5668\u6216 Dockerfile\u3002\u7cfb\u7d71\u6703\u7232\u60a8\u63d0\u4f9b\u6a21\u578b\u670d\u52d9\u5668\uff0c\u5373\u8a17\u7ba1\u6a21\u578b\u7684 HTTP \u670d\u52d9\u5668\u3002\n- \u60a8\u53ef\u4ee5\u5728\u672c\u5730\u90e8\u7f72\u548c\u8abf\u8a66\u6a21\u578b\uff0c\u5f9e\u800c\u52a0\u5feb\u958b\u767c\u671f\u9593\u7684\u8fed\u4ee3\u9031\u671f\u3002", "content": "## \u69cb\u5efa\u548c\u90e8\u7f72\u81ea\u5b9a\u7fa9\u5bb9\u5668\n\u672c\u90e8\u5206\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528 CPR \u69cb\u5efa\u5177\u6709\u9810\u8655\u7406/\u5f8c\u8655\u7406\u908f\u8f2f\u7684\u81ea\u5b9a\u7fa9\u5bb9\u5668\uff0c\u4e26\u5c07\u5176\u90e8\u7f72\u5230\u672c\u5730\u548c\u5728\u7dda\u7aef\u9ede\u3002\n### \u521d\u59cb\u8a2d\u7f6e\n\u60a8\u5fc5\u9808\u5728\u74b0\u5883\u4e2d\u5b89\u88dd [Vertex AI SDK](https://github.com/googleapis/python-aiplatform) \u548c [Docker](https://www.docker.com/) \u3002\n### \u7de8\u5beb\u81ea\u5b9a\u7fa9 Predictor\n\u5be6\u73fe [Predictor](https://github.com/googleapis/python-aiplatform/blob/main/google/cloud/aiplatform/prediction/predictor.py) \u63a5\u53e3\u3002\n```\nclass Predictor(ABC):\u00a0 \u00a0 \"\"\"Interface of the Predictor class for Custom Prediction Routines.\u00a0 \u00a0 The Predictor is responsible for the ML logic for processing a prediction request.\u00a0 \u00a0 Specifically, the Predictor must define:\u00a0 \u00a0 (1) How to load all model artifacts used during prediction into memory.\u00a0 \u00a0 (2) The logic that should be executed at predict time.\u00a0 \u00a0 When using the default PredictionHandler, the Predictor will be invoked as follows:\u00a0 \u00a0 \u00a0 predictor.postprocess(predictor.predict(predictor.preprocess(prediction_input)))\u00a0 \u00a0 \"\"\"\u00a0 \u00a0 @abstractmethod\u00a0 \u00a0 def load(self, artifacts_uri: str) -> None:\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"Loads the model artifact.\u00a0 \u00a0 \u00a0 \u00a0 Args:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 artifacts_uri (str):\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Required. The value of the environment variable AIP_STORAGE_URI.\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"\u00a0 \u00a0 \u00a0 \u00a0 pass\u00a0 \u00a0 def preprocess(self, prediction_input: Any) -> Any:\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"Preprocesses the prediction input before doing the prediction.\u00a0 \u00a0 \u00a0 \u00a0 Args:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 prediction_input (Any):\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Required. The prediction input that needs to be preprocessed.\u00a0 \u00a0 \u00a0 \u00a0 Returns:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 The preprocessed prediction input.\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"\u00a0 \u00a0 \u00a0 \u00a0 return prediction_input\u00a0 \u00a0 @abstractmethod\u00a0 \u00a0 def predict(self, instances: Any) -> Any:\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"Performs prediction.\u00a0 \u00a0 \u00a0 \u00a0 Args:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 instances (Any):\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Required. The instance(s) used for performing prediction.\u00a0 \u00a0 \u00a0 \u00a0 Returns:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Prediction results.\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"\u00a0 \u00a0 \u00a0 \u00a0 pass\u00a0 \u00a0 def postprocess(self, prediction_results: Any) -> Any:\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"Postprocesses the prediction results.\u00a0 \u00a0 \u00a0 \u00a0 Args:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 prediction_results (Any):\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 Required. The prediction results.\u00a0 \u00a0 \u00a0 \u00a0 Returns:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 The postprocessed prediction results.\u00a0 \u00a0 \u00a0 \u00a0 \"\"\"\u00a0 \u00a0 \u00a0 \u00a0 return prediction_results\n```\n\u4f8b\u5982\uff0c\u8acb\u53c3\u95b1 [Sklearn \u7684 Predictor \u5be6\u73fe](https://github.com/googleapis/python-aiplatform/blob/main/google/cloud/aiplatform/prediction/sklearn/predictor.py) \u3002\n### \u7de8\u5beb\u81ea\u5b9a\u7fa9 Handler\uff08\u53ef\u9078\uff09\n\u81ea\u5b9a\u7fa9\u8655\u7406\u7a0b\u5e8f\u53ef\u4ee5\u8a2a\u554f\u539f\u59cb\u8acb\u6c42\u5c0d\u8c61\uff0c\u56e0\u6b64\uff0c\u5728\u60a8\u9700\u8981\u81ea\u5b9a\u7fa9\u7db2\u7d61\u670d\u52d9\u5668\u76f8\u95dc\u908f\u8f2f\uff08\u4f8b\u5982\u652f\u6301\u5176\u4ed6\u8acb\u6c42/\u97ff\u61c9\u6a19\u982d\u6216\u53cd\u5e8f\u5217\u5316\u975e JSON \u683c\u5f0f\u7684\u9810\u6e2c\u8acb\u6c42\uff09\u7684\u6975\u5c11\u6578\u60c5\u6cc1\u4e0b\uff0c\u81ea\u5b9a\u7fa9\u8655\u7406\u7a0b\u5e8f\u975e\u5e38\u6709\u7528\u3002\n\u9019\u662f\u4e00\u500b\u540c\u6642\u5be6\u73fe Predictor \u548c\u8655\u7406\u7a0b\u5e8f\u7684 [\u793a\u4f8b\u7b46\u8a18\u672c](https://github.com/GoogleCloudPlatform/vertex-ai-samples/blob/main/notebooks/community/prediction/custom_prediction_routines/SDK_Custom_Predict_and_Handler_SDK_Integration.ipynb) \u3002\n\u96d6\u7136\u4e26\u975e\u5fc5\u9700\uff0c\u4f46\u7232\u4e86\u66f4\u597d\u5730\u6574\u7406\u548c\u91cd\u8907\u4f7f\u7528\u4ee3\u78bc\uff0c\u6211\u5011\u5efa\u8b70\u60a8\u5728\u8655\u7406\u7a0b\u5e8f\u4e2d\u5be6\u73fe\u7db2\u7d61\u670d\u52d9\u5668\u908f\u8f2f\uff0c\u4e26\u5728 Predictor \u4e2d\u5be6\u73fe\u6a5f\u5668\u5b78\u7fd2\u908f\u8f2f\uff08\u5982\u9ed8\u8a8d\u8655\u7406\u7a0b\u5e8f\u4e2d\u6240\u793a\uff09\u3002\n### \u69cb\u5efa\u81ea\u5b9a\u7fa9\u5bb9\u5668\n\u5c07\u81ea\u5b9a\u7fa9\u4ee3\u78bc\u548c\u984d\u5916\u7684 `requirements.txt` \u6587\u4ef6\uff08\u5982\u679c\u9700\u8981\u5b89\u88dd\u6620\u50cf\u4e2d\u7684\u4efb\u4f55\u8edf\u4ef6\u5305\uff09\u653e\u5728\u76ee\u9304\u4e2d\u3002\n\u4f7f\u7528 Vertex SDK \u69cb\u5efa\u81ea\u5b9a\u7fa9\u5bb9\u5668\uff0c\u5982\u4e0b\u6240\u793a\uff1a\n```\nfrom google.cloud.aiplatform.prediction import LocalModel# {import your predictor and handler}local_model = LocalModel.build_cpr_model(\u00a0 \u00a0 {PATH_TO_THE_SOURCE_DIR},\u00a0 \u00a0 f\"{REGION}-docker.pkg.dev/{PROJECT_ID}/{REPOSITORY}/{IMAGE}\",\u00a0 \u00a0 predictor={PREDICTOR_CLASS},\u00a0 \u00a0 handler={HANDLER_CLASS},\u00a0 \u00a0 requirements_path={PATH_TO_REQUIREMENTS_TXT},)\n```\n\u60a8\u53ef\u4ee5\u6aa2\u67e5\u5bb9\u5668\u7684\u898f\u7bc4\u4ee5\u7372\u53d6\u6709\u7528\u7684\u4fe1\u606f\uff0c\u4f8b\u5982\u6620\u50cf URI \u548c\u74b0\u5883\u8b8a\u91cf\u3002\n```\nlocal_model.get_serving_container_spec()\n```\n### \u5728\u672c\u5730\u904b\u884c\u5bb9\u5668\uff08\u53ef\u9078\uff09\n\u50c5\u7576\u60a8\u8981\u5728\u672c\u5730\u904b\u884c\u548c\u6e2c\u8a66\u5bb9\u5668\u6642\uff0c\u624d\u9700\u8981\u57f7\u884c\u6b64\u6b65\u9a5f\uff0c\u9019\u6709\u52a9\u65bc\u52a0\u5feb\u8fed\u4ee3\u901f\u5ea6\u3002\u5728\u4ee5\u4e0b\u793a\u4f8b\u4e2d\uff0c\u6211\u5011\u90e8\u7f72\u5230\u672c\u5730\u7aef\u9ede\u4f75\u767c\u9001\u9810\u6e2c\u8acb\u6c42\uff08 [\u8acb\u6c42\u6b63\u6587](https://cloud.google.com/vertex-ai/docs/reference/rest/v1/projects.locations.endpoints/predict?hl=zh-cn#request-body) \u7684\u683c\u5f0f\uff09\u3002\n```\nwith local_model.deploy_to_local_endpoint(\u00a0 \u00a0 artifact_uri={GCS_PATH_TO_MODEL_ARTIFACTS},\u00a0 \u00a0 credential_path={PATH_TO_CREDENTIALS},) as local_endpoint:\u00a0 \u00a0 health_check_response = local_endpoint.run_health_check()\u00a0 \u00a0 predict_response = local_endpoint.predict(\u00a0 \u00a0 \u00a0 \u00a0 request_file={PATH_TO_INPUT_FILE},\u00a0 \u00a0 \u00a0 \u00a0 headers={ANY_NEEDED_HEADERS},\u00a0 \u00a0 )\n```\n\u8f38\u51fa\u5065\u5eb7\u6aa2\u67e5\u548c\u9810\u6e2c\u97ff\u61c9\u3002\n```\nprint(health_check_response, health_check_response.content)print(predict_response, predict_response.content)\n```\n\u8f38\u51fa\u6240\u6709\u5bb9\u5668\u65e5\u8a8c\u3002\n```\nlocal_endpoint.print_container_logs(show_all=True)\n```\n### \u4e0a\u50b3\u5230 Vertex AI Model Registry\n\u60a8\u7684\u6a21\u578b\u9700\u8981\u8a2a\u554f\u6a21\u578b\u5de5\u4ef6\uff08\u8a13\u7df4\u4e2d\u7684\u6587\u4ef6\uff09\uff0c\u56e0\u6b64\u8acb\u78ba\u4fdd\u5c07\u5b83\u5011\u4e0a\u50b3\u5230 Google Cloud Storage\u3002\n\u5c07\u6620\u50cf\u63a8\u9001\u5230 [Artifact Registry](https://cloud.google.com/artifact-registry/docs?hl=zh-cn) \u3002\n```\nlocal_model.push_image()\n```\n\u7136\u5f8c\uff0c\u4e0a\u50b3\u5230\u6a21\u578b\u8a3b\u518a\u8868\u3002\n```\nfrom google.cloud import aiplatformmodel = aiplatform.Model.upload(\u00a0 \u00a0 local_model=local_model,\u00a0 \u00a0 display_name={MODEL_DISPLAY_NAME},\u00a0 \u00a0 artifact_uri={GCS_PATH_TO_MODEL_ARTIFACTS},)\n```\n\u5c07\u6a21\u578b\u4e0a\u50b3\u5230 Vertex AI Model Registry \u5f8c\uff0c\u8a72\u6a21\u578b\u53ef\u80fd\u6703\u7528\u65bc [\u9032\u884c\u6279\u91cf\u9810\u6e2c](https://cloud.google.com/vertex-ai/docs/predictions/batch-predictions?hl=zh-cn) \uff0c\u6216\u90e8\u7f72\u5230 Vertex AI \u7aef\u9ede\u4ee5\u7372\u53d6\u5728\u7dda\u9810\u6e2c\u7d50\u679c\u3002\n### \u90e8\u7f72\u5230 Vertex AI \u7aef\u9ede\n```\nendpoint = model.deploy(machine_type=\"n1-standard-4\")\n```\n\u90e8\u7f72\u5f8c\uff0c\u60a8\u53ef\u4ee5 [\u7372\u53d6\u5728\u7dda\u9810\u6e2c\u7d50\u679c](https://cloud.google.com/vertex-ai/docs/predictions/get-predictions?hl=zh-cn#get_online_predictions) \u3002\n## \u7b46\u8a18\u672c\u793a\u4f8b\n\u9019\u4e9b\u793a\u4f8b\u5c55\u793a\u4e86\u5728 Vertex AI Prediction \u4e0a\u4f7f\u7528\u81ea\u5b9a\u7fa9\u9810\u8655\u7406/\u5f8c\u8655\u7406\u90e8\u7f72\u6a21\u578b\u7684\u4e0d\u540c\u65b9\u5f0f\u3002\n- [\u85c9\u52a9 Sklearn \u5be6\u73fe\u81ea\u5b9a\u7fa9\u9810\u8655\u7406/\u5f8c\u8655\u7406\u7684\u81ea\u5b9a\u7fa9 Predictor\uff0c\u4f7f\u7528 Vertex SDK \u69cb\u5efa\u60a8\u81ea\u5df1\u7684\u5bb9\u5668\u3002](https://github.com/GoogleCloudPlatform/vertex-ai-samples/blob/main/notebooks/community/prediction/custom_prediction_routines/SDK_Custom_Preprocess.ipynb) - \u50c5\u5728 Predictor \u4e2d\u5be6\u73fe\u52a0\u8f09\u5e8f\u5217\u5316\u9810\u8655\u7406\u5668\u3001\u9810\u8655\u7406\u548c\u5f8c\u8655\u7406\u65b9\u6cd5\u3002\u5f9e Vertex AI \u5206\u4f48\u5f0f SklearnPredictor \u7e7c\u627f\u9ed8\u8a8d\u6a21\u578b\u52a0\u8f09\u548c\u9810\u6e2c\u884c\u7232\u3002\n- [\u81ea\u5b9a\u7fa9 Predictor\uff0c\u4f7f\u7528 Vertex SDK \u69cb\u5efa\u60a8\u81ea\u5df1\u7684\u5bb9\u5668\u3002](https://github.com/GoogleCloudPlatform/vertex-ai-samples/blob/main/notebooks/community/prediction/custom_prediction_routines/SDK_Custom_Predict_SDK_Integration.ipynb) - \u6574\u500b Predictor \u7684\u81ea\u5b9a\u7fa9\u5be6\u73fe\u3002\n- [\u81ea\u5b9a\u7fa9 Predictor \u548c\u8655\u7406\u7a0b\u5e8f\uff0c\u4f7f\u7528 Vertex SDK \u69cb\u5efa\u60a8\u81ea\u5df1\u7684\u5bb9\u5668\u3002](https://github.com/GoogleCloudPlatform/vertex-ai-samples/blob/main/notebooks/community/prediction/custom_prediction_routines/SDK_Custom_Predict_and_Handler_SDK_Integration.ipynb) - Predictor \u548c\u8655\u7406\u7a0b\u5e8f\u7684\u81ea\u5b9a\u7fa9\u5be6\u73fe\u3002\n- \u81ea\u5b9a\u7fa9\u8655\u7406\u7a0b\u5e8f\u5141\u8a31\u6a21\u578b\u670d\u52d9\u5668\u8655\u7406 csv \u8f38\u5165\u3002\n- [\u81ea\u5b9a\u7fa9 Predictor\uff0c\u4f7f\u7528 Vertex SDK for PyTorch \u69cb\u5efa\u60a8\u81ea\u5df1\u7684\u5bb9\u5668\u3002](https://github.com/GoogleCloudPlatform/vertex-ai-samples/blob/main/notebooks/community/prediction/custom_prediction_routines/SDK_Pytorch_Custom_Predict.ipynb) - Predictor \u7684\u81ea\u5b9a\u7fa9\u5be6\u73fe\u3002\n- [\u73fe\u6709\u6620\u50cf\uff0c\u5728\u672c\u5730\u6e2c\u8a66\u9810\u6e2c\u4e26\u4f7f\u7528 Vertex SDK \u90e8\u7f72\u6a21\u578b\u3002](https://github.com/GoogleCloudPlatform/vertex-ai-samples/blob/main/notebooks/community/prediction/custom_prediction_routines/SDK_Triton_PyTorch_Local_Prediction.ipynb) - \u5c07 NVIDIA Triton \u63a8\u7406\u670d\u52d9\u5668\u7528\u65bc PyTorch \u6a21\u578b\u3002", "guide": "Vertex AI"}