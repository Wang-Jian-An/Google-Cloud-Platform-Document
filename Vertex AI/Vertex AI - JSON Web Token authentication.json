{"title": "Vertex AI - JSON Web Token authentication", "url": "https://cloud.google.com/vertex-ai/docs/vector-search/jwt-auth?topic_type=authentication?hl=zh-cn", "abstract": "# Vertex AI - JSON Web Token authentication\nVector Search supports authenticated index endpoints using [self-signed JSON Web Tokens (JWTs)](/docs/authentication/token-types#self-signed) . To control access to the index endpoint, it's configured to accept only signed JWTs issued by specifically authorized Google service accounts. This means only clients using those designated accounts can interact with the endpoint.\nThis page outlines the required steps for setting up an index endpoint with JSON Web Token (JWT) authentication and running queries against it.\n", "content": "## Limitations\n- JWT authentication is supported only for private endpoints with [VPC peering](/vertex-ai/docs/vector-search/setup/vpc) or [Private Service Connect (PSC)](/vertex-ai/docs/vector-search/setup/private-service-connect) .\n- JWT authentication is supported only for data plane RPC APIs (such as MatchService) that are invoked by using gRPC. The RPC examples in this page use the open source [grpc_cli](https://github.com/grpc/grpc/blob/master/doc/command_line_tool.md) tool to send gRPC requests to the deployed index server.\n- Admin APIs for creation, deployment, and management of indexes are secured by using [predefined IAM roles](/iam/docs/understanding-roles) .## Creating and using a JWT to query an index\nFollow these steps to create an index endpoint and query it with a self-signed JWT.\n### Create an index\nCreate a Vector Search index by following the instructions in [Create an index](/vertex-ai/docs/vector-search/create-manage-index) .\n### Create a private endpoint\nCreate a private endpoint by following the instructions in one of the following documentation pages:\n- [Set up a VPC Network Peering connection](/vertex-ai/docs/vector-search/setup/vpc) \n- [Vector Search Private Service Connect](/vertex-ai/docs/vector-search/setup/private-service-connect) \n### Create a service account\nCreate a service account and grant it the [Service Account Token Creator](/iam/docs/understanding-roles#iam.serviceAccountTokenCreator) IAM role.\n- Enable the IAM Service Account Credentials API and create a service account:```\ngcloud services enable iamcredentials.googleapis.com --project=\"PROJECT_ID\"gcloud iam service-accounts create SERVICE_ACCOUNT_ID --project=\"PROJECT_ID\"\n```Replace the following values:- : The project to create your service account in.\n- : The ID for the service account.\nLearn more about [creating a service account](/iam/docs/service-accounts-create) .\n- Use one of the following commands to grant the `iam.serviceAccountTokenCreator` IAM role to your service account:- The following command gives you permission to create JWTs by using the service account from a Compute Engine VM that has the service account attached to it:```\ngcloud iam service-accounts add-iam-policy-binding \\\u00a0 \u00a0\"SERVICE_ACCOUNT_ID@PROJECT_ID.iam.gserviceaccount.com\" \\\u00a0 \u00a0--role \"roles/iam.serviceAccountTokenCreator\" \\\u00a0 \u00a0--member \"serviceAccount:SERVICE_ACCOUNT_ID@PROJECT_ID.iam.gserviceaccount.com\" \\\u00a0 \u00a0--project \"PROJECT_ID\"\n```Replace the following values:- : The ID for the service account.\n- : The project to create your service account in.\n- The following command grants permission to create JWTs by using the service account from your own Google Account (on your workstation):```\ngcloud iam service-accounts add-iam-policy-binding \\\u00a0 \u00a0\"SERVICE_ACCOUNT_ID@PROJECT_ID.iam.gserviceaccount.com\" \\\u00a0 \u00a0--role \"roles/iam.serviceAccountTokenCreator\" \\\u00a0 \u00a0--member \"user:EMAIL_ADDRESS\" \\\u00a0 \u00a0--project PROJECT_ID\n```Replace the following values:- : The ID for the service account.\n- : The project to create your service account in.\n- : Your email address.\n### Deploy the index to the endpoint with JWT auth config\n- Deploy the index to the private endpoint as shown in the following example:```\ngcloud ai index-endpoints deploy-index INDEX_ENDPOINT_ID \\\u00a0 \u00a0--index=INDEX_ID \\\u00a0 \u00a0--deployed-index-id=DEPLOYED_INDEX_ID \\\u00a0 \u00a0--display-name=DEPLOYED_INDEX_NAME \\\u00a0 \u00a0--audiences=AUDIENCES \\\u00a0 \u00a0--allowed-issuers=\"SERVICE_ACCOUNT_ID@PROJECT_ID.iam.gserviceaccount.com\" \\\u00a0 \u00a0--project=PROJECT_ID \\\u00a0 \u00a0--region=LOCATION\n```Replace the following values:- : The ID of the index endpoint.\n- : The ID of the index.\n- : A user specified string to uniquely identify the deployed index. It must start with a letter and contain only letters, numbers or underscores. See [DeployedIndex.id](https://cloud.google.com/vertex-ai/docs/reference/rpc/google.cloud.aiplatform.v1#google.cloud.aiplatform.v1.DeployedIndex) for format guidelines.\n- : Display name of the deployed index.\n- : A descriptive string that identifies the expected audience for your service, workload or app, for example,`\"123456-my-app\"`.\n- : The ID for the service account.\n- : Your Google Cloud [project ID](/resource-manager/docs/creating-managing-projects#identifiers) .\n- : The region where you are using Vertex AI.\n### Query the index with a self-signed JWT\nAt a high level, the required steps are as follows:\n- Create a JWT payload.\n- Sign the token by using the service account created earlier.\n- Query the index by using a gRPC call, passing the token in the authorization header.Vector Search authentication accepts JWTs that are signed with a pre-authorized service account, for a predefined audience. The service account and audience must be specified by the caller when an index is deployed to a private endpoint. Once an index is deployed with these settings, all gRPC API requests to that endpoint are required to include an authorization header containing a JWT that's signed by the issuer (a service account) and targeted at the provided audience. The signed JWT is passed as a bearer token in the `authorization` header of the gRPC request. In addition to being signed by the service account, the JWT must include the following claims:\n- The `iss` (allowed issuer) claim should be the service account email address, for example:```\n\"iss\": \"SERVICE_ACCOUNT_ID@PROJECT_ID.iam.gserviceaccount.com\"\n```\n- The `aud` (audience) and `sub` (subject) claims should both be set to the same value. This is a descriptive string that identifies the expected audience for your service, workload or app, for example:```\n\"aud\": \"123456-my-app\",\"sub\": \"123456-my-app\"\n```This value must match the `--audiences` argument that was passed at index deployment time.\n- The `iat` (issued at) claim should be set to the time the token is issued. The `exp` (expiration time) claim should be set to a short time later (about an hour). These values are expressed in Unix epoch time, for example:```\n\"iat\": 1698966927, // unix time since epoch eg via date +%s\"exp\": 1698967527 // iat + a few mins (eg 600 seconds)\n```\nThe following example shows these claims in a single JWT payload:\n```\n{\u00a0 \u00a0\"iss\": \"SERVICE_ACCOUNT_ID@PROJECT_ID.iam.gserviceaccount.com\",\u00a0 \u00a0\"aud\": \"123456-my-app\",\u00a0 \u00a0\"sub\": \"123456-my-app\",\u00a0 \u00a0\"iat\": 1698956084,\u00a0 \u00a0\"exp\": 1698960084}\n```\nThe JWT payload is signed by using the service account specified in the `iss` claim. It is base64-encoded for transmission as a bearer token using the gRPC metadata, as shown in the following example, where `signedJwt` is an environment variable containing a signed JWT:\n```\n./grpc_cli call ... --metadata \"authorization: Bearer $signedJwt\"\n```- Make sure that you (the caller) can use the `roles/iam.serviceAccountTokenCreator` role on the service account.\n- Create a JSON file named `jwt_in.json` that contains the raw JWT:```\nSA=\"serviceAccount:SERVICE_ACCOUNT_ID@PROJECT_ID.iam.gserviceaccount.com\"cat << EOF > jwt_in.json{\u00a0 \"aud\": \"AUDIENCES\",\u00a0 \"sub\": \"AUDIENCES\",\u00a0 \"iss\": \"${SA}\",\u00a0 \"iat\": $(date +%s),\u00a0 \"exp\": $(expr $(date +%s) + 600)}EOF\n```Replace the following values:- : The ID for the service account.\n- : Your Google Cloud [project ID](/resource-manager/docs/creating-managing-projects#identifiers) .\n- : A descriptive string that identifies the expected audience for your service, workload or app, for example,`\"123456-my-app\"`.\n- Using the [jq tool](https://jqlang.github.io/jq/) , create the `curl` request payload by encoding the JWT into a string:```\ncat jwt_in.json | jq -Rsa >request.json\n```\n- Sign the token by passing the request payload to the [signJwt](/iam/docs/reference/credentials/rest/v1/projects.serviceAccounts/signJwt) REST API method.```\nSA=\"serviceAccount:SERVICE_ACCOUNT_ID@PROJECT_ID.iam.gserviceaccount.com\"curl -X POST \\\u00a0 \u00a0-H \"Authorization: Bearer $(gcloud auth print-access-token)\" \\\u00a0 \u00a0-H \"Content-Type: application/json; charset=utf-8\" \\\u00a0 \u00a0-d @request.json \\\u00a0 \u00a0\"https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/$SA:signJwt\"\n```Replace the following values:- : The ID for the service account.\n- : Your Google Cloud [project ID](/resource-manager/docs/creating-managing-projects#identifiers) .\nStore the returned `signedJwt` value into an environment variable called `signedJwt` .Alternatively, you can sign the JWT by passing the `jwt_in.json` file directly to the gcloud CLI [sign-jwt](/sdk/gcloud/reference/iam/service-accounts/sign-jwt) method.\n```\ngcloud iam service-accounts sign-jwt jwt_in.json jwt_out \\\u00a0 \u00a0--iam-account=SERVICE_ACCOUNT_ID@PROJECT_ID.iam.gserviceaccount.com\n```\nReplace the following values:\n- : The ID for the service account.\n- : Your Google Cloud [project ID](/resource-manager/docs/creating-managing-projects#identifiers) .\nThe signed JWT is returned in the `jwt_out` output file. Store it into an environment variable called `signedJwt` .\nFrom a Compute Engine VM in the same VPC network, call the `MatchService` `gRPC` endpoint, passing the `signedJwt` token in the `authorization` header, as shown in the following example:\n```\n./grpc_cli call ${DEPLOYED_INDEX_SERVER_IP}:10000 google.cloud.aiplatform.container.v1.MatchService.Match \\\u00a0 \u00a0'{deployed_index_id: \"${DEPLOYED_INDEX_ID}\", float_val: [-0.1,..]}' \\\u00a0 \u00a0--metadata \"authorization: Bearer $signedJwt\"\n```\nTo run this command, you'll need the following environment variables to be set:\n- is the IP address for your deployed index server. To learn how to retrieve this value, see [Query indexes to get nearest neighbors](/vertex-ai/docs/vector-search/query-index-vpc) .\n- : A user specified string to uniquely identify the deployed index. It must start with a letter and contain only letters, numbers or underscores. See [DeployedIndex.id](https://cloud.google.com/vertex-ai/docs/reference/rpc/google.cloud.aiplatform.v1#google.cloud.aiplatform.v1.DeployedIndex) for format guidelines.\n`signedJwt` is the environment variable containing your signed JWT.\n## Troubleshooting\nThe following table lists some common `gRPC` error messages.\n| gRPC Error Message         | Reason                |\n|:----------------------------------------------------|:--------------------------------------------------------------------|\n| Authorization header not found for index 'INDEX_ID' | The gRPC metadata doesn't contain an authorization header   |\n| JWT is invalid format        | The token is malformed and can't be parsed correctly    |\n| JWT authentication failed       | The token is expired or isn't signed by the correct service account |\n| JWT issuer should be in the allowed issuers list | The token iss isn't in auth_config allowed issuers     |\n| Permission check fail for index 'INDEX_ID'   | The token aud or sub claim isn't in auth_config audiences   |\n## What's next\n- To learn more about JWT and token claim structure, see [RFC 7519](https://datatracker.ietf.org/doc/html/rfc7519) .\n- Learn more about how to [Create a self-signed JSON Web Token (JWT)](/iam/docs/create-short-lived-credentials-direct#sa-credentials-jwt) \n- Learn how to [Update and rebuild your index](/vertex-ai/docs/vector-search/update-rebuild-index) \n- Learn how to [Monitor an index](/vertex-ai/docs/vector-search/monitor)", "guide": "Vertex AI"}