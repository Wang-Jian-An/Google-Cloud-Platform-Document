{"title": "Vertex AI - \u69cb\u5efa\u60a8\u81ea\u5df1\u7684\u6d41\u6c34\u7dda\u7d44\u4ef6", "url": "https://cloud.google.com/vertex-ai/docs/pipelines/build-own-components?hl=zh-cn", "abstract": "# Vertex AI - \u69cb\u5efa\u60a8\u81ea\u5df1\u7684\u6d41\u6c34\u7dda\u7d44\u4ef6\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u5728\u4ee5\u4e0b\u4efb\u4e00\u74b0\u5883\u4e2d\u904b\u884c\u201c\u4f7f\u7528\u9810\u69cb\u5efa\u7684\u6d41\u6c34\u7dda\u7d44\u4ef6\u548c\u81ea\u5b9a\u7fa9\u7d44\u4ef6\u69cb\u5efa\u81ea\u5b9a\u7fa9\u8a13\u7df4\u5de5\u4f5c\u6d41\u201dJupyter \u7b46\u8a18\u672c\uff1a [\u5728 Colab \u4e2d\u904b\u884c](https://colab.research.google.com/github/GoogleCloudPlatform/vertex-ai-samples/blob/main/notebooks/official/pipelines/google_cloud_pipeline_components_model_train_upload_deploy.ipynb?hl=zh-cn) | [\u5728 Vertex AI Workbench \u7528\u6236\u7ba1\u7406\u7684\u7b46\u8a18\u672c\u4e2d\u6253\u958b](https://console.cloud.google.com/vertex-ai/workbench/deploy-notebook?download_url=https%3A%2F%2Fraw.githubusercontent.com%2FGoogleCloudPlatform%2Fvertex-ai-samples%2Fmain%2Fnotebooks%2Fofficial%2Fpipelines%2Fgoogle_cloud_pipeline_components_model_train_upload_deploy.ipynb&hl=zh-cn) | [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/vertex-ai-samples/blob/main/notebooks/official/pipelines/google_cloud_pipeline_components_model_train_upload_deploy.ipynb)\n", "content": "## \u7de8\u5beb\u7d44\u4ef6\u4ee5\u986f\u793a Google Cloud Console \u93c8\u63a5\n\u901a\u5e38\uff0c\u5728\u904b\u884c\u7d44\u4ef6\u6642\uff0c\u60a8\u4e0d\u50c5\u6703\u770b\u5230\u6307\u5411\u6b63\u5728\u5553\u52d5\u7684\u7d44\u4ef6\u4f5c\u696d\u7684\u93c8\u63a5\uff0c\u800c\u4e14\u9084\u6703\u770b\u5230\u5e95\u5c64\u96f2\u8cc7\u6e90\uff08\u5982 Vertex \u6279\u91cf\u9810\u6e2c\u4f5c\u696d\u6216 Dataflow \u4f5c\u696d\uff09\u7684\u93c8\u63a5\u3002\n[gcp_resource proto](https://github.com/kubeflow/pipelines/tree/master/components/google-cloud/google_cloud_pipeline_components/proto) \u662f\u4e00\u500b\u7279\u6b8a\u53c3\u6578\uff0c\u60a8\u53ef\u4ee5\u5728\u7d44\u4ef6\u4e2d\u4f7f\u7528\u8a72\u53c3\u6578\uff0c\u4ee5\u4fbf Google Cloud Console \u5728 Vertex AI Pipelines \u63a7\u5236\u6aaf\u4e2d\u63d0\u4f9b\u8cc7\u6e90\u65e5\u8a8c\u548c\u72c0\u614b\u7684\u81ea\u5b9a\u7fa9\u8996\u5716\u3002\n### \u8f38\u51fa gcp_resource \u53c3\u6578\n\u9996\u5148\uff0c\u60a8\u9700\u8981\u5728\u7d44\u4ef6\u4e2d\u5b9a\u7fa9 `gcp_resource` \u53c3\u6578\uff0c\u5982\u4e0b\u9762\u7684 `component.py` \u6587\u4ef6\u793a\u4f8b\u6240\u793a\uff1a\n\u5982\u9700\u77ad\u89e3\u5982\u4f55\u5b89\u88dd\u6216\u66f4\u65b0 Python\uff0c\u8acb\u53c3\u95b1 [\u5b89\u88dd Python \u7248 Vertex AI SDK](https://cloud.google.com/vertex-ai/docs/start/use-vertex-ai-python-sdk?hl=zh-cn) \u3002  \u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [   Python API \u53c3\u8003\u6587\u6a94](https://cloud.google.com/python/docs/reference/aiplatform/latest?hl=zh-cn) \u3002\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/kubeflow/pipelines/blob/HEAD/components/google-cloud/google_cloud_pipeline_components/v1/dataflow/python_job/component.py) \n```\n# Copyright 2023 The Kubeflow Authors. All Rights Reserved.\n## Licensed under the Apache License, Version 2.0 (the \"License\");# you may not use this file except in compliance with the License.# You may obtain a copy of the License at\n## \u00a0 \u00a0 http://www.apache.org/licenses/LICENSE-2.0\n## Unless required by applicable law or agreed to in writing, software# distributed under the License is distributed on an \"AS IS\" BASIS,# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.# See the License for the specific language governing permissions and# limitations under the License.from typing import Listfrom google_cloud_pipeline_components import _imagefrom google_cloud_pipeline_components import _placeholdersfrom kfp.dsl import container_componentfrom kfp.dsl import ContainerSpecfrom kfp.dsl import OutputPath@container_componentdef dataflow_python(\u00a0 \u00a0 python_module_path: str,\u00a0 \u00a0 temp_location: str,\u00a0 \u00a0 gcp_resources: OutputPath(str),\u00a0 \u00a0 location: str = 'us-central1',\u00a0 \u00a0 requirements_file_path: str = '',\u00a0 \u00a0 args: List[str] = [],\u00a0 \u00a0 project: str = _placeholders.PROJECT_ID_PLACEHOLDER,):\u00a0 # fmt: off\u00a0 \"\"\"Launch a self-executing Beam Python file on Google Cloud using the\u00a0 Dataflow Runner.\u00a0 Args:\u00a0 \u00a0 \u00a0 location: Location of the Dataflow job. If not set, defaults to `'us-central1'`.\u00a0 \u00a0 \u00a0 python_module_path: The GCS path to the Python file to run.\u00a0 \u00a0 \u00a0 temp_location: A GCS path for Dataflow to stage temporary job files created during the execution of the pipeline.\u00a0 \u00a0 \u00a0 requirements_file_path: The GCS path to the pip requirements file.\u00a0 \u00a0 \u00a0 args: The list of args to pass to the Python file. Can include additional parameters for the Dataflow Runner.\u00a0 \u00a0 \u00a0 project: Project to create the Dataflow job. Defaults to the project in which the PipelineJob is run.\u00a0 Returns:\u00a0 \u00a0 \u00a0 gcp_resources: Serialized gcp_resources proto tracking the Dataflow job. For more details, see https://github.com/kubeflow/pipelines/blob/master/components/google-cloud/google_cloud_pipeline_components/proto/README.md.\u00a0 \"\"\"\u00a0 # fmt: on\u00a0 return ContainerSpec(\u00a0 \u00a0 \u00a0 image=_image.GCPC_IMAGE_TAG,\u00a0 \u00a0 \u00a0 command=[\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 'python3',\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 '-u',\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 '-m',\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 'google_cloud_pipeline_components.container.v1.dataflow.dataflow_launcher',\u00a0 \u00a0 \u00a0 ],\u00a0 \u00a0 \u00a0 args=[\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 '--project',\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 project,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 '--location',\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 location,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 '--python_module_path',\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 python_module_path,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 '--temp_location',\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 temp_location,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 '--requirements_file_path',\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 requirements_file_path,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 '--args',\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 args,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 '--gcp_resources',\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 gcp_resources,\u00a0 \u00a0 \u00a0 ],\u00a0 )\n```\n\u63a5\u4e0b\u4f86\uff0c\u5728\u5bb9\u5668\u4e2d\u5b89\u88dd Google Cloud \u6d41\u6c34\u7dda\u7d44\u4ef6\u8edf\u4ef6\u5305\uff1a\n```\npip install --upgrade google-cloud-pipeline-components\n```\n\u63a5\u4e0b\u4f86\uff0c\u5728 Python \u4ee3\u78bc\u4e2d\uff0c\u5c07\u8cc7\u6e90\u5b9a\u7fa9\u7232 `gcp_resource` \u53c3\u6578\uff1a\n\u5982\u9700\u77ad\u89e3\u5982\u4f55\u5b89\u88dd\u6216\u66f4\u65b0 Python\uff0c\u8acb\u53c3\u95b1 [\u5b89\u88dd Python \u7248 Vertex AI SDK](https://cloud.google.com/vertex-ai/docs/start/use-vertex-ai-python-sdk?hl=zh-cn) \u3002  \u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [   Python API \u53c3\u8003\u6587\u6a94](https://cloud.google.com/python/docs/reference/aiplatform/latest?hl=zh-cn) \u3002\n```\nfrom google_cloud_pipeline_components.proto.gcp_resources_pb2 import GcpResourcesfrom google.protobuf.json_format import MessageToJsondataflow_resources = GcpResources()dr = dataflow_resources.resources.add()dr.resource_type='DataflowJob'dr.resource_uri='https://dataflow.googleapis.com/v1b3/projects/[your-project]/locations/us-east1/jobs/[dataflow-job-id]'with open(gcp_resources, 'w') as f:\u00a0 \u00a0 f.write(MessageToJson(dataflow_resources))\n```\n\u6216\u8005\uff0c\u60a8\u53ef\u4ee5\u8fd4\u56de `gcp_resources` \u8f38\u51fa\u53c3\u6578\uff0c\u5c31\u50cf\u8fd4\u56de\u4efb\u4f55\u5b57\u7b26\u4e32\u8f38\u51fa\u53c3\u6578\u4e00\u6a23\uff1a\n```\n@dsl.component(\u00a0 \u00a0 base_image='python:3.9',\u00a0 \u00a0 packages_to_install=['google-cloud-pipeline-components==2.8.0'],)def launch_dataflow_component(project: str, location:str) -> NamedTuple(\"Outputs\", \u00a0[(\"gcp_resources\", str)]):\u00a0 # Launch the dataflow job\u00a0 dataflow_job_id = [dataflow-id]\u00a0 dataflow_resources = GcpResources()\u00a0 dr = dataflow_resources.resources.add()\u00a0 dr.resource_type='DataflowJob'\u00a0 dr.resource_uri=f'https://dataflow.googleapis.com/v1b3/projects/{project}/locations/{location}/jobs/{dataflow_job_id}'\u00a0 gcp_resources=MessageToJson(dataflow_resources)\u00a0 return gcp_resources\n```\n\u60a8\u53ef\u4ee5\u5c07 `resource_type` \u8a2d\u7f6e\u7232\u4efb\u610f\u5b57\u7b26\u4e32\uff0c\u4f46\u53ea\u6709\u4ee5\u4e0b\u985e\u578b\u5728 Google Cloud Console \u4e2d\u5177\u6709\u93c8\u63a5\uff1a\n- BatchPredictionJob\n- BigQueryJob\n- CustomJob\n- DataflowJob\n- HyperparameterTuningJob## \u7de8\u5beb\u7d44\u4ef6\u4ee5\u53d6\u6d88\u5e95\u5c64\u8cc7\u6e90\n\u53d6\u6d88\u6d41\u6c34\u7dda\u4f5c\u696d\u5f8c\uff0cGoogle Cloud \u5e95\u5c64\u8cc7\u6e90\u9ed8\u8a8d\u6703\u7e7c\u7e8c\u904b\u884c\u3002\u5b83\u5011\u4e0d\u6703\u81ea\u52d5\u53d6\u6d88\u3002\u8981\u66f4\u6539\u6b64\u884c\u7232\uff0c\u60a8\u61c9\u8a72\u5c07 [SIGTERM](https://docs.python.org/3/library/signal.html#signal.SIGTERM) \u8655\u7406\u7a0b\u5e8f\u9644\u52a0\u5230\u6d41\u6c34\u7dda\u4f5c\u696d\u3002\u5efa\u8b70\u5728\u9577\u6642\u9593\u904b\u884c\u4f5c\u696d\u7684\u8f2a\u8a62\u5faa\u74b0\u4e4b\u524d\u57f7\u884c\u6b64\u64cd\u4f5c\u3002\n\u591a\u500b Google Cloud \u6d41\u6c34\u7dda\u7d44\u4ef6\u5df2\u5be6\u73fe\u53d6\u6d88\u64cd\u4f5c\uff0c\u5305\u62ec\uff1a\n- \u6279\u91cf\u9810\u6e2c\u4f5c\u696d\n- BigQuery ML \u4f5c\u696d\n- \u81ea\u5b9a\u7fa9\u4f5c\u696d\n- Dataproc Serverless \u6279\u91cf\u4f5c\u696d\n- \u8d85\u53c3\u6578\u8abf\u7bc0\u4f5c\u696d\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff08\u5305\u62ec\u8aaa\u660e\u5982\u4f55\u9644\u52a0 SIGTERM \u8655\u7406\u7a0b\u5e8f\u7684\u4ee3\u78bc\u793a\u4f8b\uff09\uff0c\u8acb\u53c3\u95b1\u4ee5\u4e0b GitHub \u93c8\u63a5\uff1a\n- [https://github.com/kubeflow/pipelines/blob/google-cloud-pipeline-components-2.8.0/components/google-cloud/google_cloud_pipeline_components/container/utils/execution_context.py](https://github.com/kubeflow/pipelines/blob/google-cloud-pipeline-components-2.8.0/components/google-cloud/google_cloud_pipeline_components/container/utils/execution_context.py) \n- [https://github.com/kubeflow/pipelines/blob/google-cloud-pipeline-components-2.8.0/components/google-cloud/google_cloud_pipeline_components/container/v1/gcp_launcher/job_remote_runner.py#L124](https://github.com/kubeflow/pipelines/blob/google-cloud-pipeline-components-2.8.0/components/google-cloud/google_cloud_pipeline_components/container/v1/gcp_launcher/job_remote_runner.py#L124) \n\u5be6\u73fe SIGTERM \u8655\u7406\u7a0b\u5e8f\u6642\uff0c\u8acb\u8003\u616e\u4ee5\u4e0b\u4e8b\u9805\uff1a\n- \u53d6\u6d88\u50b3\u64ad\u50c5\u5728\u7d44\u4ef6\u904b\u884c\u5e7e\u5206\u9418\u5f8c\u624d\u751f\u6548\u3002\u9019\u901a\u5e38\u662f\u56e0\u7232\u9700\u8981\u5728\u8abf\u7528 Python \u4fe1\u865f\u8655\u7406\u7a0b\u5e8f\u4e4b\u524d [\u8655\u7406](https://docs.python.org/3/library/signal.html#execution-of-python-signal-handlers) \u5f8c\u81fa\u5553\u52d5\u4efb\u52d9\u3002\n- \u67d0\u4e9b Google Cloud \u8cc7\u6e90\u53ef\u80fd\u672a\u5be6\u73fe\u53d6\u6d88\u64cd\u4f5c\u3002\u4f8b\u5982\uff0c\u5275\u5efa\u6216\u522a\u9664 Vertex AI \u7aef\u9ede\u6216\u6a21\u578b\u53ef\u80fd\u6703\u5275\u5efa\u4e00\u500b\u9577\u6642\u9593\u904b\u884c\u7684\u64cd\u4f5c\uff0c\u4ee5\u901a\u904e\u5176 REST API \u63a5\u53d7\u53d6\u6d88\u8acb\u6c42\uff0c\u4f46\u4e0d\u6703\u5be6\u73fe\u53d6\u6d88\u64cd\u4f5c\u672c\u8eab\u3002", "guide": "Vertex AI"}