{"title": "Dataflow - \u4f7f\u7528 NVIDIA MPS \u63d0\u9ad8\u5171\u4eab GPU \u7684\u6027\u80fd", "url": "https://cloud.google.com/dataflow/docs/gpu/use-nvidia-mps?hl=zh-cn", "abstract": "# Dataflow - \u4f7f\u7528 NVIDIA MPS \u63d0\u9ad8\u5171\u4eab GPU \u7684\u6027\u80fd\n\u5982\u679c\u60a8\u5728\u5171\u4eab Dataflow GPU \u4e0a\u904b\u884c\u591a\u500b SDK \u9032\u7a0b\uff0c\u5247\u53ef\u4ee5\u901a\u904e\u5553\u7528 NVIDIA \u591a\u9032\u7a0b\u670d\u52d9 (MPS) \u4f86\u63d0\u9ad8 GPU \u6548\u7387\u548c\u5229\u7528\u7387\u3002MPS \u901a\u904e\u5553\u7528\u9032\u7a0b\u4ee5\u5171\u4eab CUDA \u4e0a\u4e0b\u6587\u548c\u8abf\u5ea6\u8cc7\u6e90\uff0c\u652f\u6301\u5728 GPU \u4e0a\u9032\u884c\u4f75\u767c\u8655\u7406\u3002MPS \u53ef\u4ee5\u964d\u4f4e\u4e0a\u4e0b\u6587\u5207\u63db\u8cbb\u7528\u3001\u63d0\u9ad8\u4e26\u884c\u6027\u4e26\u964d\u4f4e\u5b58\u5132\u8981\u6c42\u3002\n\u76ee\u6a19\u5de5\u4f5c\u6d41\u662f\u5728\u5177\u6709\u591a\u500b vCPU \u7684\u5de5\u4f5c\u5668\u4e0a\u904b\u884c\u7684 Python \u6d41\u6c34\u7dda\u3002\nMPS \u662f\u4e00\u7a2e NVIDIA \u6280\u8853\uff0c\u7528\u65bc\u5be6\u73fe CUDA API\uff0c\u9019\u662f\u4e00\u500b\u652f\u6301\u901a\u7528 GPU \u8a08\u7b97\u7684 NVIDIA \u5e73\u81fa\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [NVIDIA \u591a\u9032\u7a0b\u670d\u52d9\u7528\u6236\u6307\u5357](https://docs.nvidia.com/deploy/mps/index.html) \u3002\n", "content": "## \u512a\u52e2\n- \u53ef\u63d0\u9ad8 GPU \u6d41\u6c34\u7dda\u7684\u4e26\u884c\u8655\u7406\u548c\u7e3d\u9ad4\u541e\u5410\u91cf\uff0c\u5c24\u5176\u662f\u5c0d\u65bc GPU \u8cc7\u6e90\u4f7f\u7528\u91cf\u8f03\u4f4e\u7684\u5de5\u4f5c\u8ca0\u8f09\u3002\n- \u53ef\u63d0\u9ad8 GPU \u5229\u7528\u7387\uff0c\u9019\u53ef\u80fd\u6703\u964d\u4f4e\u60a8\u7684\u8cbb\u7528\u3002## \u652f\u6301\u548c\u9650\u5236\n- \u53ea\u6709\u4f7f\u7528\u55ae\u500b GPU \u7684 Dataflow \u5de5\u4f5c\u5668\u624d\u652f\u6301 MPS\u3002\n- \u6d41\u6c34\u7dda\u7121\u6cd5\u4f7f\u7528\u9650\u5236\u4e26\u884c\u6027\u7684\u6d41\u6c34\u7dda\u9078\u9805\u3002\n- \u907f\u514d\u8d85\u51fa\u53ef\u7528\u7684 GPU \u5167\u5b58\uff0c\u5c24\u5176\u662f\u5728\u6d89\u53ca\u52a0\u8f09\u5927\u578b\u6a5f\u5668\u5b78\u7fd2\u6a21\u578b\u7684\u61c9\u7528\u5834\u666f\u4e2d\u3002\u5e73\u8861 vCPU \u548c SDK \u9032\u7a0b\u7684\u6578\u91cf\u8207\u9019\u4e9b\u9032\u7a0b\u6240\u9700\u7684\u53ef\u7528 GPU \u5167\u5b58\u3002\n- MPS \u4e0d\u6703\u5f71\u97ff\u975e GPU \u64cd\u4f5c\u7684\u4f75\u767c\u6027\u3002\n- Dataflow Prime \u4e0d\u652f\u6301 MPS\u3002## \u5553\u7528 MPS\n[\u4f7f\u7528 GPU \u904b\u884c\u6d41\u6c34\u7dda](https://cloud.google.com/dataflow/docs/gpu/use-gpus?hl=zh-cn) \u6642\uff0c\u901a\u904e\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\u5553\u7528 MPS\uff1a\n- \u5728\u6d41\u6c34\u7dda\u9078\u9805`--dataflow_service_options`\u4e2d\uff0c\u5c07`use_nvidia_mps`\u9644\u52a0\u5230`worker_accelerator`\u53c3\u6578\u3002\n- \u5c07`count`\u8a2d\u7f6e\u7232 1\u3002\n- \u8acb\u52ff\u4f7f\u7528\u6d41\u6c34\u7dda\u9078\u9805`--experiments=no_use_multiple_sdk_containers`\u3002\n\u6d41\u6c34\u7dda\u9078\u9805 `--dataflow_service_options` \u5982\u4e0b\u6240\u793a\uff1a\n```\n--dataflow_service_options=\"worker_accelerator=type:GPU_TYPE;count:1;install-nvidia-driver;use_nvidia_mps\"\n```\n\u5982\u679c\u60a8\u4f7f\u7528 TensorFlow \u4e26\u5553\u7528 MPS\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\n- \u5728 GPU \u4e0a [\u5553\u7528\u52d5\u614b\u5167\u5b58\u5206\u914d](https://www.tensorflow.org/guide/gpu?hl=zh-cn#limiting_gpu_memory_growth) \u3002\u4f7f\u7528\u4ee5\u4e0b\u4efb\u4e00 TensorFlow \u9078\u9805\uff1a- \u901a\u904e\u8abf\u7528`tf.config.experimental.set_memory_growth(gpu, True)`\u958b\u5553\u5167\u5b58\u589e\u9577\u3002\n- \u5c07\u74b0\u5883\u8b8a\u91cf`TF_FORCE_GPU_ALLOW_GROWTH`\u8a2d\u7f6e\u7232 true\u3002\n- \u4f7f\u7528\u5177\u6709\u9069\u7576\u5167\u5b58\u9650\u5236\u7684\u908f\u8f2f\u8a2d\u5099\u3002\n- \u7232\u7372\u5f97\u6700\u4f73\u6027\u80fd\uff0c\u8acb\u5118\u53ef\u80fd\u4f7f\u7528 [\u8edf\u8a2d\u5099\u914d\u7f6e](https://www.tensorflow.org/api_docs/python/tf/config/set_soft_device_placement?hl=zh-cn) \u6216 [\u624b\u52d5\u914d\u7f6e](https://www.tensorflow.org/guide/gpu?hl=zh-cn#manual_device_placement) \u4f86\u5f37\u5236\u4f7f\u7528 GPU\u3002## \u5f8c\u7e8c\u6b65\u9a5f\n- \u5982\u9700\u67e5\u770b\u66f4\u591a\u6700\u4f73\u5be6\u8e10\uff0c\u8acb\u53c3\u95b1 [GPU \u548c\u5de5\u4f5c\u5668\u4e26\u884c\u6027](https://cloud.google.com/dataflow/docs/gpu/develop-with-gpus?hl=zh-cn#parallelism) \u3002", "guide": "Dataflow"}