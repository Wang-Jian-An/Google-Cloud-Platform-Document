{"title": "Dataflow - Build multi-architecture container images for Dataflow", "url": "https://cloud.google.com/dataflow/docs/guides/multi-architecture-container", "abstract": "# Dataflow - Build multi-architecture container images for Dataflow\nIf you use a custom container in Dataflow, the container must match the architecture of the worker VMs. This document describes how to create multi-architecture containers that are compatible with both x86 and Arm VMs.\nYou can use the Docker CLI or [Cloud Build](/build/docs/overview) to build the container image.\n", "content": "## Use Docker to build the image\n- Create a Dockerfile. Use the `FROM` instruction to specify a multi-architecture base image.```\nFROM apache/beam_python3.10_sdk:2.50.0# Make your customizations here, for example:ENV FOO=/barCOPY path/to/myfile ./\n```\n- Install the [Buildx](https://docs.docker.com/build/architecture/) tool. To check whether the tool is installed, run the following command:```\ndocker buildx version\n```\n- Run the following command to create a builder instance that uses the `docker-container` driver. This driver is required to build multi-architecture images.```\ndocker buildx create --driver=docker-container --use\n```The `--use` flag sets the new builder instance as the current builder.\n- Run the following command to configure Docker to authenticate requests to Artifact Registry.```\ngcloud auth configure-docker REGION-docker.pkg.dev\n```Replace with the region of the Artifact Registry repository.\n- Run the following command to build and push the container image to Artifact Registry:```\ndocker buildx build \\\u00a0 --platform=linux/amd64,linux/arm64 \\\u00a0 -t REGISTRY/IMAGE:TAG \u00a0\\\u00a0 --push .\n```Replace the following:- : the Docker repository\n- : the image name\n- : the image tag\n## Use Cloud Build to build the image\n- Create a Dockerfile. Use the `FROM` instruction to specify a multi-architecture base image.```\nFROM apache/beam_python3.10_sdk:2.50.0# Make your customizations here, for example:ENV FOO=/barCOPY path/to/myfile ./\n```\n- In the same directory that contains the Dockerfile, create a file named `docker_buildx.yaml` . Paste in the following text:```\nsteps:- name: 'docker'\u00a0 args: ['buildx', 'create', '--driver', 'docker-container', '--name', 'container', '--use']- name: 'docker'\u00a0 args: ['buildx', 'build', '--platform', 'linux/amd64,linux/arm64', '-t', 'REGISTRY/IMAGE:TAG', '--push', '.']\n```Replace the following:- : the Docker repository\n- : the image name\n- : the image tag\n- To build and push the image, run the [gcloud builds submit command](/sdk/gcloud/reference/builds/submit) :```\ngcloud builds submit --region=REGION --config docker_buildx.yaml\n```Replace with the region of the Cloud Build service to use.\nFor more information, see [Build and push a Docker image with Cloud Build](/build/docs/build-push-docker-image) .\n## Verify the container image\n- Open the **Repositories** page in the Google Cloud console. [Open the Repositories page](https://console.cloud.google.com/artifacts) \n- Click the repository with the container image.\n- Click the image to see its versions.\n- Click a version.\n- Click **Manifest** .\n- In the manifest file, the `platform` section should have entries for `arm64` and `amd64` . For example:```\n\u00a0 {\u00a0 \u00a0 \"schemaVersion\": 2,\u00a0 \u00a0 \"mediaType\": \"application/vnd.docker.distribution.manifest.list.v2+json\",\u00a0 \u00a0 \"manifests\": [\u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"mediaType\": \"application/vnd.docker.distribution.manifest.v2+json\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"digest\": \"sha256:441d5438885049e2b388523a8cb5b77ea829c3c3f53326fb221fe185abd67f07\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"size\": 3074,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"platform\": {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"architecture\": \"amd64\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"os\": \"linux\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"mediaType\": \"application/vnd.docker.distribution.manifest.v2+json\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"digest\": \"sha256:d3b98b0f8f3f555f5453c79b240bd2b862d4f52d853fe81bae55f01a663de29c\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"size\": 3073,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"platform\": {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"architecture\": \"arm64\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"os\": \"linux\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 ]\u00a0 }\n```## What's next\n- [Use Arm VMs on Dataflow](/dataflow/docs/guides/use-arm-vms) \n- [Run a Dataflow job in a custom container](/dataflow/docs/guides/run-custom-container)", "guide": "Dataflow"}