{"title": "Dataflow - \u5f9e Dataflow \u5beb\u5165 Cloud Storage", "url": "https://cloud.google.com/dataflow/docs/guides/write-to-cloud-storage?hl=zh-cn", "abstract": "# Dataflow - \u5f9e Dataflow \u5beb\u5165 Cloud Storage\n\u672c\u6587\u6a94\u4ecb\u7d39\u77ad\u5982\u4f55\u4f7f\u7528 Apache Beam `TextIO` [I/O \u9023\u63a5\u5668](https://beam.apache.org/documentation/io/connectors/) \u5c07\u6587\u672c\u6578\u64da\u5f9e Dataflow \u5beb\u5165 Cloud Storage\u3002\n**\u6ce8\u610f** \uff1a\u6839\u64da\u60a8\u7684\u5834\u666f\uff0c\u8acb\u8003\u616e\u4f7f\u7528 [Google \u63d0\u4f9b\u7684 Dataflow \u6a21\u677f](https://cloud.google.com/dataflow/docs/guides/templates/provided-templates?hl=zh-cn) \u4e4b\u4e00\u3002 \u5176\u4e2d\u4e00\u4e9b\u6a21\u677f\u6703\u8f38\u51fa\u5230 Cloud Storage\u3002\n", "content": "## \u6dfb\u52a0 Google Cloud \u5eab\u4f9d\u8cf4\u9805\n\u5982\u9700\u5c07 `TextIO` \u9023\u63a5\u5668\u8207 Cloud Storage \u642d\u914d\u4f7f\u7528\uff0c\u8acb\u6dfb\u52a0\u4ee5\u4e0b\u4f9d\u8cf4\u9805\u3002\u6b64\u5eab\u7232 `\"gs://\"` \u6587\u4ef6\u540d\u63d0\u4f9b\u67b6\u69cb\u8655\u7406\u7a0b\u5e8f\u3002\n```\n<dependency>\u00a0 <groupId>org.apache.beam</groupId>\u00a0 <artifactId>beam-sdks-java-io-google-cloud-platform</artifactId>\u00a0 <version>${beam.version}</version></dependency>\n```\n```\napache-beam[gcp]==VERSION\n```\n```\nimport _ \"github.com/apache/beam/sdks/v2/go/pkg/beam/io/filesystem/gcs\"\n```\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5b89\u88dd Apache Beam SDK](https://cloud.google.com/dataflow/docs/guides/installing-beam-sdk?hl=zh-cn) \u3002\n## \u4e26\u884c\u6578\u91cf\n\u4e26\u884c\u6027\u4e3b\u8981\u7531\u5206\u7247\u6578\u6c7a\u5b9a\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u904b\u884c\u7a0b\u5e8f\u6703\u81ea\u52d5\u8a2d\u7f6e\u6b64\u503c\u3002\u5c0d\u65bc\u5927\u591a\u6578\u6d41\u6c34\u7dda\uff0c\u5efa\u8b70\u4f7f\u7528\u9ed8\u8a8d\u884c\u7232\u3002\u5728\u672c\u6587\u6a94\u4e2d\uff0c\u8acb\u53c3\u95b1 [\u6700\u4f73\u5be6\u8e10](#best-practices) \u3002\n## \u6027\u80fd\n\u4e0b\u8868\u5c55\u793a\u4e86\u5c07\u6578\u64da\u5beb\u5165 Cloud Storage \u7684\u6027\u80fd\u6307\u6a19\u3002\u5de5\u4f5c\u8ca0\u8f09\u4f7f\u7528 Java \u7248 Apache Beam SDK 2.49.0 \u5728\u4e00\u500b `e2-standard2` \u5de5\u4f5c\u5668\u4e0a\u904b\u884c\u3002\u5b83\u5011\u672a\u4f7f\u7528 Runner v2\u3002\n| 1 \u5104\u689d\u8a18\u9304 | 1 KB | 1 \u5217 | \u541e\u5410\u91cf\uff08\u5b57\u7bc0\uff09 | \u541e\u5410\u91cf\uff08\u5143\u7d20\uff09  |\n|:---------------------------|:-----------------|:--------------------|\n| Write      | 130 MBps   | \u6bcf\u79d2 130,000 \u500b\u5143\u7d20 |\n\u9019\u4e9b\u6307\u6a19\u57fa\u65bc\u7c21\u55ae\u7684\u6279\u8655\u7406\u6d41\u6c34\u7dda\u3002\u5b83\u5011\u65e8\u5728\u6bd4\u8f03 I/O \u9023\u63a5\u5668\u4e4b\u9593\u7684\u6027\u80fd\uff0c\u4e0d\u4e00\u5b9a\u4ee3\u8868\u5be6\u969b\u6d41\u6c34\u7dda\u3002Dataflow \u6d41\u6c34\u7dda\u6027\u80fd\u5f88\u8907\u96dc\uff0c\u5b83\u53d7\u5230\u591a\u500b\u56e0\u7d20\u7684\u5f71\u97ff\uff0c\u5305\u62ec\u865b\u64ec\u6a5f\u985e\u578b\u3001\u6b63\u5728\u8655\u7406\u7684\u6578\u64da\u91cf\u3001\u5916\u90e8\u4f86\u6e90\u548c\u63a5\u6536\u5668\u7684\u6027\u80fd\u4ee5\u53ca\u7528\u6236\u4ee3\u78bc\u3002\u6307\u6a19\u57fa\u65bc\u904b\u884c Java SDK\uff0c\u4e0d\u4ee3\u8868\u5176\u4ed6\u8a9e\u8a00 SDK \u7684\u6027\u80fd\u7279\u5fb5\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [Beam IO \u6027\u80fd](https://beam.apache.org/performance/) \u3002\n## \u6700\u4f73\u5be6\u8e10\n- \u4e00\u822c\u4f86\u8aaa\uff0c\u8acb\u907f\u514d\u8a2d\u7f6e\u7279\u5b9a\u6578\u91cf\u7684\u5206\u7247\u3002\u9019\u6a23\uff0c\u904b\u884c\u7a0b\u5e8f\u5c31\u53ef\u4ee5\u7232\u64f4\u7e2e\u9078\u64c7\u9069\u7576\u7684\u503c\u3002\u5982\u679c\u8abf\u7bc0\u5206\u7247\u6578\u91cf\uff0c\u5efa\u8b70\u6bcf\u500b\u5206\u7247\u5beb\u5165 100 MB \u5230 1 GB \u7684\u6578\u64da\u3002\u4f46\u662f\uff0c\u6700\u4f73\u503c\u53ef\u80fd\u53d6\u6c7a\u65bc\u5de5\u4f5c\u8ca0\u8f09\u3002\n- Cloud Storage \u53ef\u4ee5\u64f4\u5bb9\u5230\u6bcf\u79d2\u8655\u7406\u5927\u91cf\u8acb\u6c42\u3002\u4f46\u662f\uff0c\u5982\u679c\u6d41\u6c34\u7dda\u5beb\u5165\u91cf\u6025\u5287\u589e\u52a0\uff0c\u8acb\u8003\u616e\u5beb\u5165\u591a\u500b\u5b58\u5132\u6876\uff0c\u4ee5\u907f\u514d\u4efb\u4f55\u55ae\u500b Cloud Storage \u5b58\u5132\u6876\u66ab\u6642\u767c\u751f\u904e\u8f09\u3002\n- \u4e00\u822c\u800c\u8a00\uff0c\u7576\u6bcf\u6b21\u5beb\u5165\u91cf\u90fd\u5f88\u5927\uff081 KB \u6216\u66f4\u5927\uff09\u6642\uff0c\u5c07\u6578\u64da\u5beb\u5165 Cloud Storage \u6703\u66f4\u52a0\u9ad8\u6548\u3002\u5c07\u5c0f\u578b\u8a18\u9304\u5beb\u5165\u5927\u91cf\u6587\u4ef6\u53ef\u80fd\u6703\u5c0e\u81f4\u6bcf\u500b\u5b57\u7bc0\u7684\u6027\u80fd\u8b8a\u5dee\u3002\n- \u751f\u6210\u6587\u4ef6\u540d\u6642\uff0c\u8acb\u8003\u616e\u4f7f\u7528\u975e\u9806\u5e8f\u6587\u4ef6\u540d\u4ee5\u5206\u914d\u8ca0\u8f09\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528\u547d\u540d\u6163\u4f8b\u5c07\u8ca0\u8f09\u5747\u52fb\u5206\u914d\u5230\u591a\u500b\u9375\u7bc4\u570d\u4e2d](https://cloud.google.com/storage/docs/request-rate?hl=zh-cn#naming-convention) \u3002\n- \u547d\u540d\u6587\u4ef6\u6642\uff0c\u8acb\u52ff\u4f7f\u7528\u201c@\u201d\u7b26\u865f\uff0c\u5f8c\u8ddf\u6578\u5b57\u6216\u661f\u865f\u201c*\u201d\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u201c@*\u201d\u548c\u201c@N\u201d\u662f\u9810\u7559\u7684\u5206\u7247\u898f\u7bc4](https://cloud.google.com/dataflow/docs/guides/common-errors?hl=zh-cn#reserved-sharding-spec) \u3002## \u793a\u4f8b\uff1a\u5c07\u6587\u672c\u6587\u4ef6\u5beb\u5165 Cloud Storage\n\u4ee5\u4e0b\u793a\u4f8b\u6703\u5275\u5efa\u4e00\u500b\u6279\u8655\u7406\u6d41\u6c34\u7dda\uff0c\u8a72\u6d41\u6c34\u7dda\u4f7f\u7528 GZIP \u58d3\u7e2e\u4f86\u5beb\u5165\u6587\u672c\u6587\u4ef6\uff1a\n\u5982\u9700\u5411 Dataflow \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u8a2d\u7f6e\u61c9\u7528\u9ed8\u8a8d\u6191\u64da\u3002  \u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7232\u672c\u5730\u958b\u767c\u74b0\u5883\u8a2d\u7f6e\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/docs/authentication/provide-credentials-adc?hl=zh-cn#local-dev) \u3002\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/java-docs-samples/blob/HEAD/dataflow/snippets/src/main/java/com/example/dataflow/BatchWriteStorage.java) \n```\nimport java.util.Arrays;import java.util.List;import org.apache.beam.sdk.Pipeline;import org.apache.beam.sdk.io.Compression;import org.apache.beam.sdk.io.TextIO;import org.apache.beam.sdk.options.Description;import org.apache.beam.sdk.options.PipelineOptions;import org.apache.beam.sdk.options.PipelineOptionsFactory;import org.apache.beam.sdk.transforms.Create;public class BatchWriteStorage {\u00a0 public interface Options extends PipelineOptions {\u00a0 \u00a0 @Description(\"The Cloud Storage bucket to write to\")\u00a0 \u00a0 String getBucketName();\u00a0 \u00a0 void setBucketName(String value);\u00a0 }\u00a0 // Write text data to Cloud Storage\u00a0 public static void main(String[] args) {\u00a0 \u00a0 final List<String> wordsList = Arrays.asList(\"1\", \"2\", \"3\", \"4\");\u00a0 \u00a0 var options = PipelineOptionsFactory.fromArgs(args).withValidation().as(Options.class);\u00a0 \u00a0 var pipeline = Pipeline.create(options);\u00a0 \u00a0 pipeline\u00a0 \u00a0 \u00a0 \u00a0 .apply(Create\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .of(wordsList))\u00a0 \u00a0 \u00a0 \u00a0 .apply(TextIO\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .write()\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .to(options.getBucketName())\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .withSuffix(\".txt\")\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 .withCompression(Compression.GZIP)\u00a0 \u00a0 \u00a0 \u00a0 );\u00a0 \u00a0 pipeline.run().waitUntilFinish();\u00a0 }}\n```\n\u5982\u679c\u8f38\u5165 `PCollection` \u662f\u7121\u754c\u9650\u7684\uff0c\u60a8\u5fc5\u9808\u5728\u96c6\u5408\u4e0a\u5b9a\u7fa9\u7a97\u53e3\u6216\u89f8\u767c\u5668\uff0c\u7136\u5f8c\u901a\u904e\u8abf\u7528 [TextIO.Write.withWindowedWrites](https://beam.apache.org/releases/javadoc/current/org/apache/beam/sdk/io/TextIO.Write.html#withWindowedWrites--) \u6307\u5b9a\u7a97\u53e3\u5316\u5beb\u5165\u3002\n\u5982\u9700\u5411 Dataflow \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u8a2d\u7f6e\u61c9\u7528\u9ed8\u8a8d\u6191\u64da\u3002  \u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7232\u672c\u5730\u958b\u767c\u74b0\u5883\u8a2d\u7f6e\u8eab\u4efd\u9a57\u8b49](https://cloud.google.com/docs/authentication/provide-credentials-adc?hl=zh-cn#local-dev) \u3002\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/python-docs-samples/blob/HEAD/dataflow/snippets/batch_write_storage.py) \n```\nimport argparsefrom typing import Listimport apache_beam as beamfrom apache_beam.io.textio import WriteToTextfrom apache_beam.options.pipeline_options import PipelineOptionsfrom typing_extensions import Selfdef write_to_cloud_storage(argv : List[str] = None) -> None:\u00a0 \u00a0 # Parse the pipeline options passed into the application.\u00a0 \u00a0 class MyOptions(PipelineOptions):\u00a0 \u00a0 \u00a0 \u00a0 @classmethod\u00a0 \u00a0 \u00a0 \u00a0 # Define a custom pipeline option that specfies the Cloud Storage bucket.\u00a0 \u00a0 \u00a0 \u00a0 def _add_argparse_args(cls: Self, parser: argparse.ArgumentParser) -> None:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 parser.add_argument(\"--output\", required=True)\u00a0 \u00a0 wordsList = [\"1\", \"2\", \"3\", \"4\"]\u00a0 \u00a0 options = MyOptions()\u00a0 \u00a0 with beam.Pipeline(options=options) as pipeline:\u00a0 \u00a0 \u00a0 \u00a0 (\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 pipeline\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 | \"Create elements\" >> beam.Create(wordsList)\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 | \"Write Files\" >> WriteToText(options.output, file_name_suffix=\".txt\")\u00a0 \u00a0 \u00a0 \u00a0 )\n```\n\u5c0d\u65bc\u8f38\u51fa\u8def\u5f91\uff0c\u8acb\u6307\u5b9a\u5305\u542b\u5b58\u5132\u6876\u540d\u7a31\u548c\u6587\u4ef6\u540d\u524d\u7db4\u7684 Cloud Storage \u8def\u5f91\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u6307\u5b9a `gs://my_bucket/output/file` \uff0c\u5247 `TextIO` \u9023\u63a5\u5668\u5c07\u5beb\u5165\u540d\u7232 `my_bucket` \u7684 Cloud Storage \u5b58\u5132\u6876\uff0c\u4e26\u4e14\u8f38\u51fa\u6587\u4ef6\u7684\u524d\u7db4\u7232 `output/file*` \u3002\n\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c `TextIO` \u9023\u63a5\u5668\u4f7f\u7528\u50cf `<file-prefix>-00000-of-00001` \u9019\u6a23\u7684\u547d\u540d\u6163\u4f8b\u5c0d\u8f38\u51fa\u6587\u4ef6\u9032\u884c\u5206\u7247\u3002\uff08\u53ef\u9078\uff09\u60a8\u53ef\u4ee5\u6307\u5b9a\u6587\u4ef6\u540d\u5f8c\u7db4\u548c\u58d3\u7e2e\u65b9\u6848\uff0c\u5982\u793a\u4f8b\u4e2d\u6240\u793a\u3002\n\u7232\u78ba\u4fdd\u51aa\u7b49\u6027\u5beb\u5165\uff0cDataflow \u5c07\u6578\u64da\u5beb\u5165\u81e8\u6642\u6587\u4ef6\uff0c\u7136\u5f8c\u5c07\u5b8c\u6210\u7684\u81e8\u6642\u6587\u4ef6\u8907\u88fd\u5230\u6700\u7d42\u6587\u4ef6\u4e2d\u3002\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u95b1\u8b80 [TextIO](https://beam.apache.org/releases/javadoc/current/org/apache/beam/sdk/io/TextIO.html) API \u6587\u6a94\u3002\n- \u53c3\u95b1 [Google \u63d0\u4f9b\u7684\u6a21\u677f](https://cloud.google.com/dataflow/docs/guides/templates/provided-templates?hl=zh-cn) \u5217\u8868\u3002", "guide": "Dataflow"}