{"title": "Dataflow - \u7232 Dataflow \u69cb\u5efa\u81ea\u5b9a\u7fa9\u5bb9\u5668\u6620\u50cf", "url": "https://cloud.google.com/dataflow/docs/guides/build-container-image?hl=zh-cn", "abstract": "# Dataflow - \u7232 Dataflow \u69cb\u5efa\u81ea\u5b9a\u7fa9\u5bb9\u5668\u6620\u50cf\n", "content": "## \u4f7f\u7528\u8981\u6c42\nDataflow \u7684\u81ea\u5b9a\u7fa9\u5bb9\u5668\u6620\u50cf\u5fc5\u9808\u6eff\u8db3\u4ee5\u4e0b\u8981\u6c42\uff1a\n- \u5df2\u5b89\u88dd Apache Beam SDK \u548c\u5fc5\u8981\u7684\u4f9d\u8cf4\u9805\u3002 \u6211\u5011\u5efa\u8b70\u5f9e\u9ed8\u8a8d\u7684 Apache Beam SDK \u6620\u50cf\u958b\u59cb\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1\u672c\u6587\u6a94\u4e2d\u7684 [\u9078\u64c7\u57fa\u790e\u6620\u50cf](#base-images) \u3002\n- `/opt/apache/beam/boot`\u8173\u672c\u5fc5\u9808\u5728\u5bb9\u5668\u5553\u52d5\u671f\u9593\u4f5c\u7232\u6700\u5f8c\u4e00\u6b65\u904b\u884c\u3002\u6b64\u8173\u672c\u6703\u521d\u59cb\u5316\u5de5\u4f5c\u5668\u74b0\u5883\u4e26\u5553\u52d5 SDK \u5de5\u4f5c\u5668\u9032\u7a0b\u3002\u6b64\u8173\u672c\u662f Apache Beam SDK \u6620\u50cf\u4e2d\u7684\u9ed8\u8a8d`ENTRYPOINT`\u3002\u4f46\u662f\uff0c\u5982\u679c\u60a8\u4f7f\u7528\u5176\u4ed6\u57fa\u790e\u6620\u50cf\uff0c\u6216\u8005\u66ff\u63db\u4e86\u9ed8\u8a8d`ENTRYPOINT`\uff0c\u5247\u5fc5\u9808\u986f\u5f0f\u904b\u884c\u6b64\u8173\u672c\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1\u672c\u6587\u6a94\u4e2d\u7684 [\u4fee\u6539\u5bb9\u5668\u5165\u53e3\u9ede](#custom-entrypoint) \u3002\n- \u60a8\u7684\u5bb9\u5668\u6620\u50cf\u5fc5\u9808\u652f\u6301 Dataflow \u4f5c\u696d\u7684\u5de5\u4f5c\u5668\u865b\u64ec\u6a5f\u67b6\u69cb\u3002\u5982\u679c\u60a8\u6253\u7b97\u4f7f\u7528 ARM \u865b\u64ec\u6a5f\u4e0a\u7684\u81ea\u5b9a\u7fa9\u5bb9\u5668\uff0c\u6211\u5011\u5efa\u8b70\u60a8\u69cb\u5efa\u591a\u67b6\u69cb\u6620\u50cf\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u69cb\u5efa\u591a\u67b6\u69cb\u5bb9\u5668\u6620\u50cf](https://cloud.google.com/dataflow/docs/guides/multi-architecture-container?hl=zh-cn) \u3002## \u6e96\u5099\u5de5\u4f5c\n- \u9a57\u8b49\u5b89\u88dd\u7684 Apache Beam SDK \u7248\u672c\u662f\u5426\u652f\u6301 [Runner v2](https://cloud.google.com/dataflow/docs/runner-v2?hl=zh-cn) \u548c\u60a8\u7684\u8a9e\u8a00\u7248\u672c\u3002 \u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5b89\u88dd Apache Beam SDK](https://cloud.google.com/dataflow/docs/guides/installing-beam-sdk?hl=zh-cn) \u3002\n- \u5982\u9700\u5728\u672c\u5730\u6e2c\u8a66\u5bb9\u5668\u6620\u50cf\uff0c\u60a8\u5fc5\u9808\u5b89\u88dd Docker\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7372\u53d6 Docker](https://docs.docker.com/get-docker/) \u3002\n- \u5275\u5efa [Artifact Registry](https://cloud.google.com/artifact-registry/docs/repositories?hl=zh-cn) \u4ee3\u78bc\u5eab\u6307\u5b9a Docker \u6620\u50cf\u683c\u5f0f\u3002\u60a8\u5fc5\u9808\u81f3\u5c11\u5177\u6709\u4ee3\u78bc\u5eab\u7684 [Artifact Registry Writer \u8a2a\u554f\u6b0a\u9650](https://cloud.google.com/artifact-registry/docs/access-control?hl=zh-cn#permissions) \u3002\u5982\u9700\u5275\u5efa\u65b0\u7684\u4ee3\u78bc\u5eab\uff0c\u8acb\u904b\u884c [gcloud artifacts repositories create \u547d\u4ee4](https://cloud.google.com/sdk/gcloud/reference/artifacts/repositories/create?hl=zh-cn) \uff1a```\ngcloud artifacts repositories create REPOSITORY \\\u00a0 --repository-format=docker \\\u00a0 --location=REGION \\\u00a0 --async\n```\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- \uff1a\u4ee3\u78bc\u5eab\u7684\u540d\u7a31\u3002\u4ee3\u78bc\u5eab\u540d\u7a31\u5c0d\u65bc\u9805\u76ee\u4e2d\u7684\u6bcf\u500b\u4f4d\u7f6e\u90fd\u5fc5\u9808\u662f\u552f\u4e00\u7684\u3002\n- \uff1a\u8981\u5728\u5176\u4e2d\u90e8\u7f72 Dataflow \u4f5c\u696d\u7684\u5340\u57df\u3002\u9078\u64c7\u9760\u8fd1\u60a8\u904b\u884c\u547d\u4ee4\u7684\u4f4d\u7f6e\u7684 Dataflow \u5340\u57df\u3002\u8a72\u503c\u5fc5\u9808\u662f\u6709\u6548\u7684\u5340\u57df\u540d\u7a31\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5340\u57df\u548c\u4f4d\u7f6e\uff0c\u8acb\u53c3\u95b1 [Dataflow \u4f4d\u7f6e](https://cloud.google.com/dataflow/docs/resources/locations?hl=zh-cn) \u3002\n\u672c\u793a\u4f8b\u4f7f\u7528 `--async` \u6a19\u8a8c\u3002\u8a72\u547d\u4ee4\u6703\u7acb\u5373\u8fd4\u56de\uff0c\u800c\u4e0d\u7b49\u5f85\u64cd\u4f5c\u5b8c\u6210\u3002\n- \u5982\u9700\u914d\u7f6e Docker \u4ee5\u5c0d Artifact Registry \u7684\u8acb\u6c42\u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u904b\u884c [gcloud auth configure-docker \u547d\u4ee4](https://cloud.google.com/sdk/gcloud/reference/auth/configure-docker?hl=zh-cn) \uff1a```\ngcloud auth configure-docker REGION-docker.pkg.dev\n```\u8a72\u547d\u4ee4\u5c07\u66f4\u65b0\u60a8\u7684 Docker \u914d\u7f6e\u3002\u73fe\u5728\uff0c\u60a8\u53ef\u4ee5\u5728 Google Cloud \u9805\u76ee\u4e2d\u8207 Artifact Registry \u9023\u63a5\u4ee5\u63a8\u9001\u6620\u50cf\u3002## \u9078\u64c7\u57fa\u790e\u6620\u50cf\n\u6211\u5011\u5efa\u8b70\u5f9e\u4f7f\u7528 Apache Beam SDK \u6620\u50cf\u4f5c\u7232\u57fa\u790e\u5bb9\u5668\u6620\u50cf\u958b\u59cb\u3002\u9019\u4e9b\u6620\u50cf\u4f5c\u7232 Apache Beam \u7248\u672c\u7684\u4e00\u90e8\u5206\u767c\u5e03\u5230 [Docker Hub](https://hub.docker.com/search?q=apache%2Fbeam&type=image) \u3002\n### \u4f7f\u7528 Apache Beam \u57fa\u790e\u6620\u50cf\n\u5982\u9700\u4f7f\u7528 Apache Beam SDK \u6620\u50cf\u4f5c\u7232\u57fa\u790e\u6620\u50cf\uff0c\u8acb\u5728 `FROM` \u6307\u4ee4\u4e2d\u6307\u5b9a\u5bb9\u5668\u6620\u50cf\uff0c\u7136\u5f8c\u6dfb\u52a0\u60a8\u81ea\u5df1\u7684\u81ea\u5b9a\u7fa9\u9805\u3002\n\u6b64\u793a\u4f8b\u5c07 Java 8 \u8207 Apache Beam SDK 2.54.0 \u7248\u642d\u914d\u4f7f\u7528\u3002\n```\nFROM apache/beam_java8_sdk:2.54.0\n# Make your customizations here, for example:\nENV FOO=/bar\nCOPY path/to/myfile ./\n```\n\u81ea\u5b9a\u7fa9\u5bb9\u5668\u7684\u904b\u884c\u6642\u7248\u672c\u5fc5\u9808\u8207\u60a8\u7528\u65bc\u5553\u52d5\u6d41\u6c34\u7dda\u7684\u904b\u884c\u6642\u4e00\u81f4\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u8981\u5f9e\u672c\u5730 Java 11 \u74b0\u5883\u5553\u52d5\u6d41\u6c34\u7dda\uff0c `FROM` \u884c\u5fc5\u9808\u6307\u5b9a Java 11 \u74b0\u5883\uff1a `apache/beam_java11_sdk:...` \u3002\n\u6b64\u793a\u4f8b\u5c07 Python 3.10 \u8207 Apache Beam SDK 2.54.0 \u7248\u642d\u914d\u4f7f\u7528\u3002\n```\nFROM apache/beam_python3.10_sdk:2.54.0\n# Make your customizations here, for example:\nENV FOO=/bar\nCOPY path/to/myfile ./\n```\n\u81ea\u5b9a\u7fa9\u5bb9\u5668\u7684\u904b\u884c\u6642\u7248\u672c\u5fc5\u9808\u8207\u60a8\u7528\u65bc\u5553\u52d5\u6d41\u6c34\u7dda\u7684\u904b\u884c\u6642\u4e00\u81f4\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u8981\u5f9e\u672c\u5730 Python 3.10 \u74b0\u5883\u5553\u52d5\u6d41\u6c34\u7dda\uff0c `FROM` \u884c\u5fc5\u9808\u6307\u5b9a Python 3.10 \u74b0\u5883\uff1a `apache/beam_python3.10_sdk:...` \u3002\n\u6b64\u793a\u4f8b\u5c07 Go \u8207 Apache Beam SDK 2.54.0 \u7248\u642d\u914d\u4f7f\u7528\u3002\n```\nFROM apache/beam_go_sdk:2.54.0\n# Make your customizations here, for example:\nENV FOO=/bar\nCOPY path/to/myfile ./\n```\n### \u4f7f\u7528\u81ea\u5b9a\u7fa9\u57fa\u790e\u6620\u50cf\n\u5982\u679c\u8981\u4f7f\u7528\u5176\u4ed6\u57fa\u790e\u6620\u50cf\uff0c\u6216\u8005\u9700\u8981\u4fee\u6539\u9ed8\u8a8d Apache Beam \u6620\u50cf\u7684\u67d0\u4e9b\u65b9\u9762\uff08\u4f8b\u5982\u64cd\u4f5c\u7cfb\u7d71\u7248\u672c\u6216\u88dc\u4e01\uff09\uff0c\u8acb\u4f7f\u7528 [\u591a\u968e\u6bb5\u69cb\u5efa](https://docs.docker.com/develop/develop-images/multistage-build/) \u6d41\u7a0b\u3002\u5f9e\u9ed8\u8a8d\u7684 Apache Beam \u57fa\u790e\u6620\u50cf\u4e2d\u8907\u88fd\u5fc5\u8981\u7684\u5de5\u4ef6\u3002\n\u8a2d\u7f6e `ENTRYPOINT` \u4ee5\u904b\u884c `/opt/apache/beam/boot` \u8173\u672c\uff0c\u8a72\u8173\u672c\u5c07\u521d\u59cb\u5316\u5de5\u4f5c\u5668\u74b0\u5883\u4e26\u5553\u52d5 SDK \u5de5\u4f5c\u5668\u9032\u7a0b\u3002\u5982\u679c\u672a\u8a2d\u7f6e\u6b64\u5165\u53e3\u9ede\uff0cDataflow \u5de5\u4f5c\u5668\u5c07\u7121\u6cd5\u6b63\u78ba\u5553\u52d5\u3002\n\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u4e86\u5f9e Apache Beam SDK \u8907\u88fd\u6587\u4ef6\u7684 Dockerfile\uff1a\n```\nFROM openjdk:8\n# Copy files from official SDK image, including script/dependencies.\nCOPY --from=apache/beam_java8_sdk:2.54.0 /opt/apache/beam /opt/apache/beam\n# Set the entrypoint to Apache Beam SDK launcher.\nENTRYPOINT [\"/opt/apache/beam/boot\"]\n```\n```\nFROM python:3.10-slim\n# Install SDK.\nRUN pip install --no-cache-dir apache-beam[gcp]==2.54.0\n# Verify that the image does not have conflicting dependencies.\nRUN pip check\n# Copy files from official SDK image, including script/dependencies.\nCOPY --from=apache/beam_python3.10_sdk:2.54.0 /opt/apache/beam /opt/apache/beam\n# Set the entrypoint to Apache Beam SDK launcher.\nENTRYPOINT [\"/opt/apache/beam/boot\"]\n```\n\u6b64\u793a\u4f8b\u5047\u5b9a\u73fe\u6709\u57fa\u790e\u6620\u50cf\u4e0a\u5b89\u88dd\u4e86\u5fc5\u8981\u7684\u4f9d\u8cf4\u9805\uff08\u5728\u672c\u4f8b\u4e2d\u7232 Python 3.10 \u548c `pip` \uff09\u3002\u5728\u6620\u50cf\u4e2d\u5b89\u88dd Apache Beam SDK \u53ef\u78ba\u4fdd\u6620\u50cf\u5177\u6709\u5fc5\u8981\u7684 SDK \u4f9d\u8cf4\u9805\uff0c\u4e26\u7e2e\u77ed\u5de5\u4f5c\u5668\u5553\u52d5\u6642\u9593\u3002\n **\u91cd\u8981\u63d0\u793a** \uff1a `RUN` \u548c `COPY` \u6307\u4ee4\u4e2d\u6307\u5b9a\u7684 SDK \u7248\u672c\u5fc5\u9808\u8207\u7528\u65bc\u5553\u52d5\u6d41\u6c34\u7dda\u7684\u7248\u672c\u4e00\u81f4\u3002\n```\nFROM golang:latest\n# Copy files from official SDK image, including script/dependencies.\nCOPY --from=apache/beam_go_sdk:2.54.0 /opt/apache/beam /opt/apache/beam\n# Set the entrypoint to Apache Beam SDK launcher.\nENTRYPOINT [\"/opt/apache/beam/boot\"]\n```\n## \u4fee\u6539\u5bb9\u5668\u5165\u53e3\u9ede\n\u5982\u679c\u5bb9\u5668\u5728\u5bb9\u5668\u5553\u52d5\u671f\u9593\u904b\u884c\u81ea\u5b9a\u7fa9\u8173\u672c\uff0c\u5247\u8a72\u8173\u672c\u5fc5\u9808\u4ee5 `/opt/apache/beam/boot` \u7d50\u675f\u3002Dataflow \u5728\u5bb9\u5668\u5553\u52d5\u671f\u9593\u50b3\u905e\u7684\u53c3\u6578\u5fc5\u9808\u50b3\u905e\u7d66\u9ed8\u8a8d\u5553\u52d5\u8173\u672c\u3002\u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u4e86\u8abf\u7528\u9ed8\u8a8d\u5553\u52d5\u8173\u672c\u7684\u81ea\u5b9a\u7fa9\u5553\u52d5\u8173\u672c\uff1a\n```\n#!/bin/bashecho \"This is my custom script\"# ...# Pass command arguments to the default boot script./opt/apache/beam/boot \"$@\"\n```\n\u5728 Dockerfile \u4e2d\uff0c\u8a2d\u7f6e `ENTRYPOINT` \u4ee5\u8abf\u7528\u8173\u672c\uff1a\n```\nFROM apache/beam_java8_sdk:2.54.0\nCOPY script.sh path/to/my/script.sh\nENTRYPOINT [ \"path/to/my/script.sh\" ]\n```\n```\nFROM apache/beam_python3.10_sdk:2.54.0\nCOPY script.sh path/to/my/script.sh\nENTRYPOINT [ \"path/to/my/script.sh\" ]\n```\n```\nFROM apache/beam_go_sdk:2.54.0\nCOPY script.sh path/to/my/script.sh\nENTRYPOINT [ \"path/to/my/script.sh\" ]\n```\n## \u69cb\u5efa\u4e26\u63a8\u9001\u6620\u50cf\n\u60a8\u53ef\u4ee5\u4f7f\u7528 Cloud Build \u6216 Docker \u69cb\u5efa\u5bb9\u5668\u6620\u50cf\u4e26\u5c07\u5176\u63a8\u9001\u5230 Artifact Registry \u4ee3\u78bc\u5eab\u3002\n\u5982\u9700\u69cb\u5efa\u6587\u4ef6\u4e26\u5c07\u5176\u63a8\u9001\u5230 Artifact Registry \u4ee3\u78bc\u5eab\uff0c\u8acb\u904b\u884c [gcloud builds submit \u547d\u4ee4](https://cloud.google.com/sdk/gcloud/reference/builds/submit?hl=zh-cn) \uff1a\n```\n\u00a0 gcloud builds submit --tag REGION-docker.pkg.dev/PROJECT_ID/REPOSITORY/dataflow/FILE_NAME:TAG .\n```\n```\ndocker build . --tag REGION-docker.pkg.dev/PROJECT_ID/REPOSITORY/dataflow/FILE_NAME:TAGdocker push REGION-docker.pkg.dev/PROJECT_ID/REPOSITORY/dataflow/FILE_NAME:TAG\n```\n\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a\n- ``\uff1a\u8981\u5728\u5176\u4e2d\u90e8\u7f72 Dataflow \u4f5c\u696d\u7684 [\u5340\u57df](https://cloud.google.com/dataflow/docs/resources/locations?hl=zh-cn) \u3002`REGION`\u8b8a\u91cf\u7684\u503c\u5fc5\u9808\u662f\u6709\u6548\u7684\u5340\u57df\u540d\u7a31\u3002\n- ``\uff1a\u9805\u76ee\u540d\u7a31\u6216\u7528\u6236\u540d\u3002\n- ``\uff1a\u6620\u50cf\u4ee3\u78bc\u5eab\u540d\u7a31\u3002\n- ``\uff1a\u60a8\u7684 Dockerfile \u7684\u540d\u7a31\u3002\n- ``\uff1a\u6620\u50cf\u6a19\u8a18\u3002 \u59cb\u7d42\u6307\u5b9a\u6709\u7248\u672c\u63a7\u5236\u7684\u5bb9\u5668 SHA \u6216\u6a19\u8a18\u3002\u8acb\u52ff\u4f7f\u7528`:latest`\u6a19\u8a18\u6216\u53ef\u8b8a\u6a19\u8a18\u3002## \u9810\u5b89\u88dd Python \u4f9d\u8cf4\u9805\n\u672c\u90e8\u5206\u9069\u7528\u65bc Python \u6d41\u6c34\u7dda\u3002\n\u5553\u52d5 Python Dataflow \u4f5c\u696d\u6642\uff0c\u60a8\u53ef\u4ee5\u5728\u904b\u884c\u6642\u4f7f\u7528 `--requirements_file` \u6216 `--extra_packages` \u9078\u9805\u6307\u5b9a\u5176\u4ed6\u4f9d\u8cf4\u9805\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7ba1\u7406 Python \u6d41\u6c34\u7dda\u4f9d\u8cf4\u9805](https://beam.apache.org/documentation/sdks/python-pipeline-dependencies/) \u3002\u6bcf\u500b Dataflow \u5de5\u4f5c\u5668\u5bb9\u5668\u4e2d\u6703\u5b89\u88dd\u984d\u5916\u7684\u4f9d\u8cf4\u9805\u3002\u7576\u4f5c\u696d\u9996\u6b21\u5553\u52d5\u4ee5\u53ca\u5728\u81ea\u52d5\u64f4\u7e2e\u671f\u9593\uff0c\u4f9d\u8cf4\u9805\u5b89\u88dd\u901a\u5e38\u6703\u5c0e\u81f4 CPU \u4f7f\u7528\u7387\u9ad8\uff0c\u4e26\u4e14\u6240\u6709\u65b0\u5553\u52d5\u7684 Dataflow \u5de5\u4f5c\u5668\u7684\u9810\u71b1\u671f\u8f03\u9577\u3002\n\u7232\u907f\u514d\u91cd\u8907\u7684\u4f9d\u8cf4\u9805\u5b89\u88dd\uff0c\u60a8\u53ef\u4ee5\u9810\u69cb\u5efa\u81ea\u5b9a\u7fa9 Python SDK \u5bb9\u5668\u6620\u50cf\uff0c\u4e26\u9810\u5b89\u88dd\u4f9d\u8cf4\u9805\u3002\u60a8\u53ef\u4ee5\u5728\u69cb\u5efa\u6642\u4f7f\u7528 Dockerfile \u57f7\u884c\u6b64\u6b65\u9a5f\uff0c\u6216\u8005\u5728\u63d0\u4ea4\u4f5c\u696d\u6642\u57f7\u884c\u6b64\u6b65\u9a5f\u3002\n\u5de5\u4f5c\u5668\u5728\u5553\u52d5\u5bb9\u5668\u6642\u6703\u5275\u5efa\u65b0\u7684\u865b\u64ec Python \u74b0\u5883\u3002\u56e0\u6b64\uff0c\u8acb\u5c07\u4f9d\u8cf4\u9805\u5b89\u88dd\u5230\u9ed8\u8a8d\uff08\u5168\u5c40\uff09Python \u74b0\u5883\u4e2d\uff0c\u800c\u4e0d\u662f\u5275\u5efa\u865b\u64ec\u74b0\u5883\u3002\u5982\u679c\u60a8\u5728\u5bb9\u5668\u6620\u50cf\u4e2d\u6fc0\u6d3b\u865b\u64ec\u74b0\u5883\uff0c\u5247\u5728\u4f5c\u696d\u5553\u52d5\u6642\uff0c\u6b64\u74b0\u5883\u53ef\u80fd\u7121\u6cd5\u6fc0\u6d3b\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5e38\u898b\u554f\u984c](#common_issues) \u3002\n### \u4f7f\u7528 Dockerfile \u9032\u884c\u9810\u5b89\u88dd\n\u5982\u9700\u5411 Python \u81ea\u5b9a\u7fa9\u5bb9\u5668\u76f4\u63a5\u6dfb\u52a0\u984d\u5916\u7684\u4f9d\u8cf4\u9805\uff0c\u8acb\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a\n```\nFROM apache/beam_python3.10_sdk:2.54.0\nCOPY requirements.txt .\n# Pre-install Python dependencies. For reproducibile builds,\n# supply all of the dependencies and their versions in a requirements.txt file.\nRUN pip install -r requirements.txt\n# You can also install individual dependencies.\nRUN pip install lxml\n# Pre-install other dependencies.\nRUN apt-get update \\\n && apt-get dist-upgrade \\\n && apt-get install -y --no-install-recommends ffmpeg\n```\n\u4f7f\u7528 `--sdk_container_image` \u548c `--sdk_location` \u6d41\u6c34\u7dda\u9078\u9805\u63d0\u4ea4\u60a8\u7684\u4f5c\u696d\u3002 `--sdk_location` \u9078\u9805\u6703\u963b\u6b62 SDK \u5728\u4f5c\u696d\u5553\u52d5\u6642\u4e0b\u8f09\u3002\u7cfb\u7d71\u6703\u76f4\u63a5\u5f9e\u5bb9\u5668\u6620\u50cf\u6aa2\u7d22 SDK\u3002\n\u4ee5\u4e0b\u793a\u4f8b\u904b\u884c [wordcount \u793a\u4f8b\u6d41\u6c34\u7dda](https://cloud.google.com/dataflow/docs/quickstarts/create-pipeline-python?hl=zh-cn) \uff1a\n```\npython -m apache_beam.examples.wordcount \\\u00a0 --input=INPUT_FILE \\\u00a0 --output=OUTPUT_FILE \\\u00a0 --project=PROJECT_ID \\\u00a0 --region=REGION \\\u00a0 --temp_location=TEMP_LOCATION \\\u00a0 --runner=DataflowRunner \\\u00a0 --experiments=use_runner_v2 \\\u00a0 --sdk_container_image=IMAGE_URI\u00a0 --sdk_location=container\n```\n\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a\n- \uff1a\u6d41\u6c34\u7dda\u7684\u8f38\u5165\u6587\u4ef6\n- \uff1a\u8981\u5beb\u5165\u8f38\u51fa\u7684\u8def\u5f91\n- \uff1aGoogle Cloud \u9805\u76ee ID\n- \uff1a\u8981\u5728\u5176\u4e2d\u90e8\u7f72 Dataflow \u4f5c\u696d\u7684 [\u5340\u57df](https://cloud.google.com/dataflow/docs/resources/locations?hl=zh-cn) \n- \uff1a\u4f9b Dataflow \u5b58\u5132\u81e8\u6642\u4f5c\u696d\u6587\u4ef6\u7684 Cloud Storage \u8def\u5f91\n- \uff1a\u81ea\u5b9a\u7fa9\u5bb9\u5668\u6620\u50cf URI\n### \u63d0\u4ea4\u4f5c\u696d\u6642\u9810\u69cb\u5efa\u5bb9\u5668\u6620\u50cf\n\u901a\u904e\u9810\u69cb\u5efa\u5bb9\u5668\u6620\u50cf\uff0c\u60a8\u53ef\u4ee5\u5728\u4f5c\u696d\u5553\u52d5\u4e4b\u524d\u9810\u5b89\u88dd\u6d41\u6c34\u7dda\u4f9d\u8cf4\u9805\u3002\u60a8\u7121\u9700\u69cb\u5efa\u81ea\u5b9a\u7fa9\u5bb9\u5668\u6620\u50cf\u3002\n\u5982\u9700\u5728\u63d0\u4ea4\u4f5c\u696d\u6642\u9810\u69cb\u5efa\u5177\u6709\u5176\u4ed6 Python \u4f9d\u8cf4\u9805\u7684\u5bb9\u5668\uff0c\u8acb\u4f7f\u7528\u4ee5\u4e0b\u6d41\u6c34\u7dda\u9078\u9805\uff1a\n- `--prebuild_sdk_container_engine=[cloud_build | local_docker]` \u3002\u8a2d\u7f6e\u6b64\u6a19\u8a8c\u5f8c\uff0cApache Beam \u6703\u751f\u6210\u81ea\u5b9a\u7fa9\u5bb9\u5668\u4e26\u5b89\u88dd\u901a\u904e `--requirements_file` \u548c `--extra_packages` \u9078\u9805\u6307\u5b9a\u7684\u6240\u6709\u4f9d\u8cf4\u9805\u3002\u6b64\u6a19\u8a8c\u652f\u6301\u4ee5\u4e0b\u503c\uff1a- `cloud_build`\u3002\u4f7f\u7528 [Cloud Build](https://cloud.google.com/build/docs/overview?hl=zh-cn) \u69cb\u5efa\u5bb9\u5668\u3002\u60a8\u5fc5\u9808\u5728\u9805\u76ee\u4e2d\u5553\u7528 Cloud Build API\u3002\n- `local_docker`\u3002\u4f7f\u7528\u672c\u5730 Docker \u5b89\u88dd\u4f86\u69cb\u5efa\u5bb9\u5668\u3002\n- `--docker_registry_push_url=` `` \u3002\u5c07 `` \u66ff\u63db\u7232 Artifact Registry \u6587\u4ef6\u593e\u3002\n- `--sdk_location=container` \u3002\u6b64\u9078\u9805\u53ef\u9632\u6b62\u5de5\u4f5c\u5668\u5728\u4f5c\u696d\u5553\u52d5\u6642\u4e0b\u8f09 SDK\u3002\u7cfb\u7d71\u6703\u6539\u7232\u76f4\u63a5\u5f9e\u5bb9\u5668\u6620\u50cf\u6aa2\u7d22 SDK\u3002\n\u4ee5\u4e0b\u793a\u4f8b\u4f7f\u7528 Cloud Build \u9810\u69cb\u5efa\u6620\u50cf\uff1a\n```\npython -m apache_beam.examples.wordcount \\\u00a0 --input=INPUT_FILE \\\u00a0 --output=OUTPUT_FILE \\\u00a0 --project=PROJECT_ID \\\u00a0 --region=REGION \\\u00a0 --temp_location=TEMP_LOCATION \\\u00a0 --runner=DataflowRunner \\\u00a0 --disk_size_gb=DISK_SIZE_GB \\\u00a0 --experiments=use_runner_v2 \\\u00a0 --requirements_file=./requirements.txt \\\u00a0 --prebuild_sdk_container_engine=cloud_build \\\u00a0 --docker_registry_push_url=IMAGE_PATH \\\u00a0 --sdk_location=container\n```\n\u6b64\u9810\u69cb\u5efa\u529f\u80fd\u9700\u8981\u4f7f\u7528 Python \u7248 Apache Beam SDK 2.25.0 \u6216\u66f4\u9ad8\u7248\u672c\u3002\nSDK \u5bb9\u5668\u6620\u50cf\u9810\u69cb\u5efa\u5de5\u4f5c\u6d41\u4f7f\u7528\u901a\u904e `--sdk_container_image` \u6d41\u6c34\u7dda\u9078\u9805\u50b3\u905e\u7684\u6620\u50cf\u4f5c\u7232\u57fa\u790e\u6620\u50cf\u3002\u5982\u679c\u672a\u8a2d\u7f6e\u6b64\u9078\u9805\uff0c\u5247\u7cfb\u7d71\u9ed8\u8a8d\u6703\u5c07 Apache Beam \u6620\u50cf\u7528\u4f5c\u57fa\u790e\u6620\u50cf\u3002\n**\u6ce8\u610f\uff1a** \u5c0d\u65bc Apache Beam SDK 2.38.0 \u7248\u53ca\u66f4\u65e9\u7248\u672c\uff0c\u5982\u9700\u6307\u5b9a\u57fa\u790e\u6620\u50cf\uff0c\u8acb\u4f7f\u7528 `--prebuild_sdk_container_base_image` \u3002\n\u60a8\u53ef\u4ee5\u5728\u5177\u6709\u76f8\u540c\u4f9d\u8cf4\u9805\u548c SDK \u7248\u672c\u7684\u53e6\u4e00\u9805\u4f5c\u696d\u4e2d\u91cd\u8907\u4f7f\u7528\u9810\u5148\u69cb\u5efa\u7684 Python SDK \u5bb9\u5668\u6620\u50cf\u3002\u5982\u9700\u91cd\u8907\u4f7f\u7528\u8a72\u6620\u50cf\uff0c\u8acb\u4f7f\u7528 `--sdk_container_image` \u6d41\u6c34\u7dda\u9078\u9805\u5c07\u9810\u69cb\u5efa\u7684\u5bb9\u5668\u6620\u50cf\u7db2\u5740\u50b3\u905e\u7d66\u5176\u4ed6\u4f5c\u696d\u3002\u79fb\u9664\u4f9d\u8cf4\u9805\u9078\u9805 `--requirements_file` \u3001 `--extra_packages` \u548c `--setup_file` \u3002\n\u5982\u679c\u60a8\u4e0d\u6253\u7b97\u91cd\u8907\u4f7f\u7528\u8a72\u6620\u50cf\uff0c\u8acb\u5728\u4f5c\u696d\u5b8c\u6210\u5f8c\u5c07\u5176\u522a\u9664\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528 gcloud CLI \u6216\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 Artifact Registry \u9801\u9762\u522a\u9664\u6620\u50cf\u3002\n\u5982\u679c\u6620\u50cf\u5b58\u5132\u5728 Artifact Registry \u4e2d\uff0c\u8acb\u4f7f\u7528 [artifacts docker images delete](https://cloud.google.com/sdk/gcloud/reference/artifacts/docker/images/delete?hl=zh-cn) \u547d\u4ee4\uff1a\n```\n\u00a0 \u00a0gcloud artifacts docker images delete IMAGE --delete-tags\n```\n### \u5e38\u898b\u554f\u984c\n- \u5982\u679c\u60a8\u7684\u4f5c\u696d\u5177\u6709\u4f86\u81ea\u79c1\u6709 PyPi \u93e1\u50cf\u7684\u984d\u5916 Python \u4f9d\u8cf4\u9805\uff0c\u4e26\u4e14\u7121\u6cd5\u7531\u9060\u7a0b Cloud Build \u4f5c\u696d\u62c9\u53d6\uff0c\u8acb\u5617\u8a66\u4f7f\u7528\u672c\u5730 Docker \u9078\u9805\uff0c\u6216\u5617\u8a66\u4f7f\u7528 Dockerfile \u69cb\u5efa\u5bb9\u5668\u3002\n- \u5982\u679c Cloud Build \u4f5c\u696d\u5931\u6557\u4e26\u986f\u793a `docker exit code 137` \uff0c\u5247\u8aaa\u660e\u69cb\u5efa\u4f5c\u696d\u5167\u5b58\u4e0d\u8db3\uff0c\u53ef\u80fd\u662f\u7531\u65bc\u5b89\u88dd\u7684\u4f9d\u8cf4\u9805\u7684\u5927\u5c0f\u6240\u81f4\u3002\u901a\u904e\u50b3\u905e `--cloud_build_machine_type=` `` \u4f7f\u7528\u66f4\u5927\u7684 Cloud Build \u5de5\u4f5c\u5668\u6a5f\u5668\u985e\u578b\uff0c\u5176\u4e2d \u662f\u4ee5\u4e0b\u9078\u9805\u4e4b\u4e00\uff1a- `n1-highcpu-8`\n- `n1-highcpu-32`\n- `e2-highcpu-8`\n- `e2-highcpu-32`\n\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cCloud Build \u4f7f\u7528\u6a5f\u5668\u985e\u578b `e2-medium` \u3002\n- \u5728 Apache Beam 2.44.0 \u53ca\u66f4\u9ad8\u7248\u672c\u4e2d\uff0c\u5de5\u4f5c\u5668\u5728\u5553\u52d5\u81ea\u5b9a\u7fa9\u5bb9\u5668\u6642\u6703\u5275\u5efa\u865b\u64ec\u74b0\u5883\u3002\u5982\u679c\u5bb9\u5668\u5275\u5efa\u81ea\u5df1\u7684\u865b\u64ec\u74b0\u5883\u4f86\u5b89\u88dd\u4f9d\u8cf4\u9805\uff0c\u5247\u9019\u4e9b\u4f9d\u8cf4\u9805\u6703\u88ab\u6368\u68c4\u3002\u6b64\u884c\u7232\u53ef\u80fd\u6703\u5c0e\u81f4\u5982\u4e0b\u932f\u8aa4\uff1a`ModuleNotFoundError: No module named '<dependency name>'`\u7232\u907f\u514d\u6b64\u554f\u984c\uff0c\u8acb\u5c07\u4f9d\u8cf4\u9805\u5b89\u88dd\u5230\u9ed8\u8a8d\uff08\u5168\u5c40\uff09Python \u74b0\u5883\u4e2d\u3002\u5982\u9700\u89e3\u6c7a\u6b64\u554f\u984c\uff0c\u8acb\u5728\u5bb9\u5668\u6620\u50cf\u4e2d\u8a2d\u7f6e\u4ee5\u4e0b\u74b0\u5883\u8b8a\u91cf\uff0c\u4ee5\u5728 Beam 2.48.0 \u53ca\u66f4\u9ad8\u7248\u672c\u4e2d\u505c\u7528\u6b64\u884c\u7232\uff1a`ENV RUN_PYTHON_SDK_IN_DEFAULT_ENVIRONMENT=1`## \u5f8c\u7e8c\u6b65\u9a5f\n- \u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u7de8\u5beb Dockerfile\uff0c\u8acb\u53c3\u95b1 [\u7de8\u5beb Dockerfile \u7684\u6700\u4f73\u5be6\u8e10](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/) \u3002\n- \u77ad\u89e3\u5982\u4f55 [\u5728\u81ea\u5b9a\u7fa9\u5bb9\u5668\u4e2d\u904b\u884c Dataflow \u4f5c\u696d](https://cloud.google.com/dataflow/docs/guides/run-custom-container?hl=zh-cn) \u3002", "guide": "Dataflow"}