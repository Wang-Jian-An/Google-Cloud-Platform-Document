{"title": "Dataflow - \u6392\u67e5 Dataflow \u6b0a\u9650\u554f\u984c", "url": "https://cloud.google.com/dataflow/docs/guides/troubleshoot-permissions?hl=zh-cn", "abstract": "# Dataflow - \u6392\u67e5 Dataflow \u6b0a\u9650\u554f\u984c\n\u672c\u9801\u9762\u4ecb\u7d39\u5982\u4f55\u8abf\u67e5\u548c\u89e3\u6c7a [Dataflow \u6b0a\u9650](https://cloud.google.com/dataflow/docs/concepts/security-and-permissions?hl=zh-cn) \u7684\u554f\u984c\u3002\n\u8981\u6210\u529f\u904b\u884c Dataflow \u4f5c\u696d\uff0c\u60a8\u7684\u7528\u6236\u8cec\u865f\u548c Dataflow \u670d\u52d9\u8cec\u865f\u5fc5\u9808\u5177\u6709\u5c0d\u8cc7\u6e90\u7684\u5fc5\u8981\u8a2a\u554f\u6b0a\u9650\u3002\u5982\u9700\u67e5\u770b\u6240\u9700\u89d2\u8272\u7684\u5217\u8868\u4ee5\u53ca\u6388\u4e88\u9019\u4e9b\u89d2\u8272\u7684\u6b65\u9a5f\uff0c\u8acb\u53c3\u95b1 Dataflow \u5b89\u5168\u6027\u548c\u6b0a\u9650\u9801\u9762\u4e0a\u7684 [Google Cloud \u4e0a\u7684\u6d41\u6c34\u7dda\u7684\u5b89\u5168\u6027\u548c\u6b0a\u9650](https://cloud.google.com/dataflow/docs/concepts/security-and-permissions?hl=zh-cn#permissions) \u3002\n\u6b64\u5916\uff0c\u7576 Apache Beam \u6d41\u6c34\u7dda\u8a2a\u554f Google Cloud \u8cc7\u6e90\u6642\uff0c\u60a8\u7684 Dataflow \u9805\u76ee\u7684\u5de5\u4f5c\u5668\u670d\u52d9\u8cec\u865f\u9700\u8981\u9019\u4e9b\u8cc7\u6e90\u7684\u8a2a\u554f\u6b0a\u9650\u3002 \u5982\u9700\u67e5\u770b\u5de5\u4f5c\u5668\u670d\u52d9\u8cec\u865f\u53ef\u80fd\u9700\u8981\u7684\u89d2\u8272\u5217\u8868\uff0c\u8acb\u53c3\u95b1 [\u89d2\u8272\u5206\u914d\u793a\u4f8b](https://cloud.google.com/dataflow/docs/concepts/access-control?hl=zh-cn#example) \u3002\n\u5982\u679c\u7f3a\u5c11\u904b\u884c\u4f5c\u696d\u6240\u9700\u7684\u4e00\u500b\u6216\u591a\u500b\u89d2\u8272\uff0c\u4f5c\u696d\u65e5\u8a8c\u6216\u5de5\u4f5c\u5668\u65e5\u8a8c\u4e2d\u53ef\u80fd\u6703\u51fa\u73fe\u932f\u8aa4\u3002\u5982\u9700\u77ad\u89e3\u5982\u4f55\u5728\u4f5c\u696d\u5931\u6557\u6642\u67e5\u627e\u932f\u8aa4\uff0c\u8acb\u53c3\u95b1 [\u67e5\u627e\u6709\u95dc\u6d41\u6c34\u7dda\u6545\u969c\u7684\u4fe1\u606f](https://cloud.google.com/dataflow/docs/guides/troubleshooting-your-pipeline?hl=zh-cn#Workflow) \u3002\n\u5982\u9700\u89e3\u6c7a\u6b0a\u9650\u554f\u984c\uff0c\u60a8\u9700\u8981\u4e86\u89e3\u7f3a\u5c11\u54ea\u4e9b\u6b0a\u9650\u4ee5\u53ca\u54ea\u500b\u8cec\u865f\u9700\u8981\u8a72\u6b0a\u9650\u3002\u5982\u9700\u77ad\u89e3\u7f3a\u5c11\u54ea\u4e9b\u6b0a\u9650\uff0c\u8acb\u67e5\u770b\u932f\u8aa4\u6d88\u606f\u4e2d\u5217\u51fa\u7684\u6b0a\u9650\uff0c\u4e26\u627e\u5230\u5305\u542b\u8a72\u6b0a\u9650\u7684\u89d2\u8272\u3002\u60a8\u901a\u5e38\uff08\u4f46\u4e26\u4e0d\u7e3d\u662f\uff09\u9700\u8981\u5c07\u76f8\u95dc\u89d2\u8272\u5206\u914d\u7d66 [Dataflow \u5de5\u4f5c\u5668\u670d\u52d9\u8cec\u865f](https://cloud.google.com/dataflow/docs/concepts/security-and-permissions?hl=zh-cn#worker-service-account) \u3002\n\u5982\u9700\u6dfb\u52a0\u6b0a\u9650\uff0c\u60a8\u7684\u7528\u6236\u8cec\u865f\u9700\u8981\u7372\u5f97\u7ba1\u7406\u8a2a\u554f\u6b0a\u9650\u7684\u6b0a\u9650\u3002\u6709\u95dc\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u7ba1\u7406\u5c0d\u670d\u52d9\u8cec\u865f\u7684\u8a2a\u554f\u6b0a\u9650](https://cloud.google.com/iam/docs/manage-access-service-accounts?hl=zh-cn) \u548c [\u7ba1\u7406\u5c0d\u5176\u4ed6\u8cc7\u6e90\u7684\u8a2a\u554f\u6b0a\u9650](https://cloud.google.com/iam/docs/manage-access-other-resources?hl=zh-cn) \u3002\n", "content": "## \u7528\u6236\u6c92\u6709\u9805\u76ee\u7684\u5beb\u5165\u6b0a\u9650\n\u5617\u8a66\u904b\u884c Dataflow \u4f5c\u696d\u6642\uff0c\u4f5c\u696d\u5931\u6557\uff0c\u4e26\u4e14\u60a8\u6703\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\u7684\u932f\u8aa4\uff1a\n```\nPERMISSION_DENIED: (Could not create workflow; user does not have write access to project: $PROJECT_ID Causes: (...): Permission 'dataflow.jobs.create' denied on project: '$PROJECT_ID'\n```\n\u5982\u679c\u60a8\u7684\u7528\u6236\u8cec\u865f\u6c92\u6709 `roles/dataflow.developer` \u89d2\u8272\uff0c\u5c31\u6703\u51fa\u73fe\u6b64\u932f\u8aa4\u3002\n\u5982\u9700\u89e3\u6c7a\u6b64\u554f\u984c\uff0c\u8acb\u5411\u60a8\u7684\u7528\u6236\u8cec\u865f\u6388\u4e88 `roles/dataflow.developer` \u89d2\u8272\u3002\u6b64\u5916\uff0c\u8acb\u78ba\u4fdd\u60a8\u7684\u7528\u6236\u8cec\u865f\u5177\u6709 `roles/iam.serviceAccountUser` \u89d2\u8272\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 Identity and Access Management \u6587\u6a94\u4e2d\u7684 [\u6388\u4e88\u55ae\u500b\u89d2\u8272](https://cloud.google.com/iam/docs/manage-access-service-accounts?hl=zh-cn#grant-single-role) \u3002\n## \u7528\u6236\u6c92\u6709\u8db3\u5920\u7684\u9805\u76ee\u6b0a\u9650\n\u5617\u8a66\u53d6\u6d88 Dataflow \u4f5c\u696d\u6642\uff0c\u60a8\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\u7684\u932f\u8aa4\uff1a\n```\nCould not cancel workflow; user does not have sufficient permissions on project:PROJECT_ID, or the job does not exist in the project. Causes: (...): Permission 'dataflow.jobs.cancel' denied on project: 'PROJECT_ID' Please ensure you have permission to access the job\n```\n\u5617\u8a66\u6392\u7a7a\u6216\u66f4\u65b0\u4f5c\u696d\u6642\uff0c\u53ef\u80fd\u6703\u51fa\u73fe\u985e\u4f3c\u7684\u932f\u8aa4\u3002\n\u767c\u751f\u6b64\u932f\u8aa4\u662f\u7531\u4ee5\u4e0b\u67d0\u7a2e\u539f\u56e0\u9020\u6210\u7684\uff1a\n- \u60a8\u7684\u7528\u6236\u8cec\u865f\u6c92\u6709`roles/dataflow.developer`\u89d2\u8272\u3002\u5982\u9700\u89e3\u6c7a\u6b64\u554f\u984c\uff0c\u8acb\u5411\u60a8\u7684\u7528\u6236\u8cec\u865f\u6388\u4e88`roles/dataflow.developer`\u89d2\u8272\u3002\u6b64\u5916\uff0c\u8acb\u78ba\u4fdd\u60a8\u7684\u7528\u6236\u8cec\u865f\u5177\u6709`roles/iam.serviceAccountUser`\u89d2\u8272\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 Identity and Access Management \u6587\u6a94\u4e2d\u7684 [\u6388\u4e88\u55ae\u500b\u89d2\u8272](https://cloud.google.com/iam/docs/manage-access-service-accounts?hl=zh-cn#grant-single-role) \u3002\n- \u4f5c\u696d ID \u4e0d\u6b63\u78ba\u3002\u5b83\u53ef\u80fd\u5305\u542b\u62fc\u5beb\u932f\u8aa4\uff0c\u6216\u8005\u60a8\u53ef\u80fd\u4f7f\u7528\u4f5c\u696d\u540d\u7a31\u800c\u4e0d\u662f\u4f5c\u696d ID \u4f86 [\u53d6\u6d88\u4f5c\u696d](https://cloud.google.com/sdk/gcloud/reference/dataflow/jobs/cancel?hl=zh-cn) \u3002## \u5de5\u4f5c\u5668\u670d\u52d9\u8cec\u865f\u7684\u6b0a\u9650\u9a57\u8b49\u5931\u6557\n\u5617\u8a66\u904b\u884c Dataflow \u4f5c\u696d\u6642\uff0c\u60a8\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\u7684\u932f\u8aa4\uff1a\n```\nWorkflow failed. Causes: Permissions verification for controller service account failed. All permissions in IAM role roles/dataflow.worker should be granted to controller service account PROJECT_NUMBER-compute@developer.gserviceaccount.com.\n```\n\u7576\u5de5\u4f5c\u5668\u670d\u52d9\u8cec\u865f\u6c92\u6709 `roles/dataflow.worker` \u89d2\u8272\u6642\uff0c\u6703\u767c\u751f\u6b64\u932f\u8aa4\u3002\n\u5982\u9700\u89e3\u6c7a\u6b64\u554f\u984c\uff0c\u8acb\u5411\u5de5\u4f5c\u5668\u670d\u52d9\u8cec\u865f\u6388\u4e88 `roles/dataflow.worker` \u89d2\u8272\u3002 \u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 Identity and Access Management \u6587\u6a94\u4e2d\u7684 [\u6388\u4e88\u55ae\u500b\u89d2\u8272](https://cloud.google.com/iam/docs/manage-access-service-accounts?hl=zh-cn#grant-single-role) \u3002\n## \u6d41\u6c34\u7dda\u9a57\u8b49\u5931\u6557\n\u5728\u65b0\u7684 Dataflow \u4f5c\u696d\u5553\u52d5\u4e4b\u524d\uff0cDataflow \u6703\u5c0d\u6d41\u6c34\u7dda\u57f7\u884c\u9a57\u8b49\u6aa2\u67e5\u3002\u7576\u9a57\u8b49\u6aa2\u67e5\u767c\u73fe\u6d41\u6c34\u7dda\u5b58\u5728\u554f\u984c\u6642\uff0c\u7232\u4e86\u7bc0\u7701\u6642\u9593\u548c\u8a08\u7b97\u8cc7\u6e90\uff0cDataflow \u6703\u4f7f\u4f5c\u696d\u63d0\u4ea4\u63d0\u524d\u5931\u6557\u3002\u5728 [\u4f5c\u696d\u65e5\u8a8c](https://cloud.google.com/dataflow/docs/guides/logging?hl=zh-cn#MonitoringLogs) \u4e2d\uff0cDataflow \u5305\u542b\u65e5\u8a8c\u6d88\u606f\uff0c\u5176\u4e2d\u5305\u542b\u9a57\u8b49\u767c\u73fe\u7d50\u679c\u548c\u89e3\u6c7a\u554f\u984c\u7684\u8aaa\u660e\u3002\n\u7576\u6d41\u6c34\u7dda\u9a57\u8b49\u6aa2\u67e5\u767c\u73fe\u6b0a\u9650\u554f\u984c\u6642\uff0c\u60a8\u53ef\u80fd\u6703\u5728\u4f5c\u696d\u65e5\u8a8c\u4e2d\u770b\u5230\u4ee5\u4e0b\u932f\u8aa4\uff1a\n```\n[The preflight pipeline validation failed for job JOB_ID.] Missing permissions\nPERMISSION when accessing RESOURCE_PATH as Dataflow worker service account WORKER_SERVICE_ACCOUNT.\n```\n\u5982\u679c\u7f3a\u5c11\u591a\u500b\u8cc7\u6e90\u7684\u6b0a\u9650\uff0c\u5247\u4f5c\u696d\u65e5\u8a8c\u5305\u542b\u591a\u689d\u6b0a\u9650\u932f\u8aa4\u6d88\u606f\u3002\n\u5728\u5617\u8a66\u91cd\u65b0\u63d0\u4ea4 Dataflow \u4f5c\u696d\u4e4b\u524d\uff0c\u8acb\u89e3\u6c7a\u6b0a\u9650\u554f\u984c\u3002\u4ee5\u4e0b\u8cc7\u6e90\u63d0\u4f9b\u6709\u95dc\u4fee\u6539\u89d2\u8272\u548c\u6b0a\u9650\u7684\u4fe1\u606f\u3002\n- \u5982\u679c\u60a8\u9700\u8981\u67e5\u627e\u63d0\u4f9b\u7279\u5b9a\u6b0a\u9650\u7684\u89d2\u8272\uff0c\u8acb\u53c3\u95b1 [IAM \u6b0a\u9650\u53c3\u8003\u6587\u6a94](https://cloud.google.com/iam/docs/permissions-reference?hl=zh-cn) \u3002\n- \u5982\u9700\u5411\u9805\u76ee\u7684\u4e3b\u8cec\u865f\u6388\u4e88\u89d2\u8272\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528 Google Cloud \u63a7\u5236\u6aaf\u6388\u4e88 IAM \u89d2\u8272](https://cloud.google.com/iam/docs/grant-role-console?hl=zh-cn) \u3002\n- \u5982\u9700\u7232\u9805\u76ee\u6dfb\u52a0\u7f3a\u5c11\u7684\u6b0a\u9650\uff0cIAM \u7ba1\u7406\u54e1\u53ef\u4ee5\u4f7f\u7528 [gcloud projects add-iam-policy-binding \u547d\u4ee4](https://cloud.google.com/sdk/gcloud/reference/projects/add-iam-policy-binding?hl=zh-cn) \uff1a```\ngcloud projects add-iam-policy-binding PROJECT_ID \\\n --member=PRINCIPAL --role=ROLE\n```\n- \u5982\u9700\u6388\u4e88\u6216\u66f4\u6539\u7279\u5b9a\u89d2\u8272\uff0c\u8acb\u53c3\u95b1 [\u6388\u4e88\u6216\u64a4\u6d88\u89d2\u8272](https://cloud.google.com/iam/docs/granting-changing-revoking-access?hl=zh-cn#single-role) \u3002\n- \u5982\u9700\u77ad\u89e3 Dataflow \u5de5\u4f5c\u5668\u670d\u52d9\u8cec\u865f\u6240\u9700\u7684\u89d2\u8272\u548c\u6b0a\u9650\uff0c\u8acb\u53c3\u95b1 Dataflow \u5b89\u5168\u6027\u548c\u6b0a\u9650\u9801\u9762\u4e2d\u7684 [\u5de5\u4f5c\u5668\u670d\u52d9\u8cec\u865f](https://cloud.google.com/dataflow/docs/concepts/security-and-permissions?hl=zh-cn#worker-service-account) \u3002\n\u5982\u679c\u8981\u8986\u84cb\u6d41\u6c34\u7dda\u9a57\u8b49\u4e26\u5553\u52d5\u5b58\u5728\u9a57\u8b49\u932f\u8aa4\u7684\u4f5c\u696d\uff0c\u8acb\u4f7f\u7528\u4ee5\u4e0b\u6d41\u6c34\u7dda\u9078\u9805\uff1a\n```\n--experiment=enable_ppv_effect=false\n```\n## \u5237\u65b0\u6191\u64da\u6642\u51fa\u73fe\u554f\u984c\n\u5617\u8a66\u904b\u884c Dataflow \u4f5c\u696d\u6642\uff0c\u60a8\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\u7684\u932f\u8aa4\uff1a\n```\nWorkflow failed. Causes: There was a problem refreshing your credentials.\nPlease check: 1. The Dataflow API is enabled for your project.\n2. Make sure both the Dataflow service account and the controller service account have sufficient permissions.\nIf you are not specifying a controller service account, ensure the default Compute Engine service account PROJECT_NUMBER-compute@developer.gserviceaccount.com exists and has sufficient permissions.\nIf you have deleted the default Compute Engine service account, you must specify a controller service account\n```\n\u7576\u5de5\u4f5c\u5668\u670d\u52d9\u8cec\u865f\u6c92\u6709 `roles/dataflow.worker` \u89d2\u8272\u6216\u672a\u5553\u7528 Dataflow API \u6642\uff0c\u6703\u767c\u751f\u6b64\u932f\u8aa4\u3002\n\u9996\u5148\u9a57\u8b49\u5de5\u4f5c\u5668\u670d\u52d9\u8cec\u865f\u5177\u6709 `roles/dataflow.worker` \u89d2\u8272\u3002\u5982\u679c\u9700\u8981\uff0c\u8acb\u5c07 `roles/dataflow.worker` \u6388\u4e88\u5de5\u4f5c\u5668\u670d\u52d9\u8cec\u865f\u3002 \u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 Identity and Access Management \u6587\u6a94\u4e2d\u7684 [\u6388\u4e88\u55ae\u500b\u89d2\u8272](https://cloud.google.com/iam/docs/manage-access-service-accounts?hl=zh-cn#grant-single-role) \u3002\n\u5982\u9700\u5553\u7528 Dataflow API\uff0c\u8acb\u53c3\u95b1 [\u5728 Google Cloud \u9805\u76ee\u4e2d\u5553\u7528 API](https://cloud.google.com/endpoints/docs/openapi/enable-api?hl=zh-cn) \u3002\n## \u9700\u8981\u201ccompute.subnetworks.get\u201d\u6b0a\u9650\n\u5617\u8a66\u5728\u5171\u4eab VPC \u7db2\u7d61\u4e0a\u904b\u884c Dataflow \u4f5c\u696d\u6642\uff0c\u60a8\u6703\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\u7684\u932f\u8aa4\uff1a\n```\nRequired 'compute.subnetworks.get' permission for 'projects/project-id/regions/region/subnetworks/subnet-name' HTTP Code: 403\n```\n\u60a8\u53ef\u4ee5\u4f7f\u7528\u5171\u4eab VPC \u5c07\u5bbf\u4e3b\u9805\u76ee [VPC \u7db2\u7d61](https://cloud.google.com/vpc/docs/vpc?hl=zh-cn) \u4e2d\u7684\u5b50\u7db2\u5c0e\u51fa\u5230\u540c\u4e00 [\u7d44\u7e54](https://cloud.google.com/resource-manager/docs/creating-managing-organization?hl=zh-cn) \u4e2d\u7684\u5176\u4ed6\u670d\u52d9\u9805\u76ee \u3002 \u9019\u4e9b\u670d\u52d9\u9805\u76ee\u4e2d\u7684\u5be6\u4f8b\u53ef\u4ee5\u5728\u8a72\u5bbf\u4e3b\u9805\u76ee\u7684\u5171\u4eab\u5b50\u7db2\u4e2d\u9032\u884c\u7db2\u7d61\u9023\u63a5\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5171\u4eab VPC \u6982\u89bd](https://cloud.google.com/vpc/docs/shared-vpc?hl=zh-cn) \u3002\n\u5982\u9700\u89e3\u6c7a\u6b64\u554f\u984c\uff0c\u8acb\u9996\u5148\u9a57\u8b49\u670d\u52d9\u9805\u76ee\u5df2\u95dc\u806f\u5230\u5bbf\u4e3b\u9805\u76ee\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1\u201c\u9810\u914d\u5171\u4eab VPC\u201d\u9801\u9762\u4e2d\u7684 [\u95dc\u806f\u670d\u52d9\u9805\u76ee](https://cloud.google.com/vpc/docs/provisioning-shared-vpc?hl=zh-cn) \u3002\n\u63a5\u4e0b\u4f86\uff0c\u5c07\u4ee5\u4e0b\u89d2\u8272\u6388\u4e88\u5bbf\u4e3b\u9805\u76ee\u7684 Compute Engine \u670d\u52d9\u8cec\u865f\u3001\u670d\u52d9\u9805\u76ee\u7684 Dataflow \u5de5\u4f5c\u5668\u670d\u52d9\u8cec\u865f\u4ee5\u53ca\u7528\u65bc\u63d0\u4ea4\u4f5c\u696d\u7684\u670d\u52d9\u8cec\u865f\uff1a\n- `roles/dataflow.admin`\n- `roles/dataflow.serviceAgent`\n- [roles/compute.networkUser](https://cloud.google.com/compute/docs/access/iam?hl=zh-cn#compute.networkUser) \n- [roles/storage.objectViewer](https://cloud.google.com/storage/docs/access-control/iam-roles?hl=zh-cn) \n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 Identity and Access Management \u6587\u6a94\u4e2d\u7684 [\u6388\u4e88\u55ae\u500b\u89d2\u8272](https://cloud.google.com/iam/docs/manage-access-service-accounts?hl=zh-cn#grant-single-role) \u3002\n## Dataflow Runner \u7121\u6b0a\u8a2a\u554f\u5b58\u5132\u6876\n\u7576\u60a8\u5617\u8a66\u5217\u51fa Cloud Storage \u5b58\u5132\u6876\u4e2d\u7684\u5c0d\u8c61\uff0cDataflow \u4f5c\u696d\u5931\u6557\uff0c\u4e26\u4e14\u60a8\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\u7684\u932f\u8aa4\uff1a\n```\n\"dataflow-runner@project-id.iam.gserviceaccount.com\" does not have `storage.objects.list` access to the Google Cloud Storage Bucket\n```\n\u7576\u5de5\u4f5c\u5668\u670d\u52d9\u8cec\u865f\u6c92\u6709 `roles/storage.objectViewer` \u89d2\u8272\u6642\uff0c\u6703\u767c\u751f\u6b64\u932f\u8aa4\u3002\n\u5982\u9700\u89e3\u6c7a\u6b64\u554f\u984c\uff0c\u8acb\u5411\u60a8\u7684\u7528\u6236\u8cec\u865f\u6388\u4e88 `roles/storage.objectViewer` \u89d2\u8272\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 Identity and Access Management \u6587\u6a94\u4e2d\u7684 [\u6388\u4e88\u55ae\u500b\u89d2\u8272](https://cloud.google.com/iam/docs/manage-access-service-accounts?hl=zh-cn#grant-single-role) \u3002\n## \u5c0d\u8cc7\u6e90\u7684 Cloud KMS \u5bc6\u9470\u6b0a\u9650\u88ab\u62d2\u7d55\n\u7576\u60a8 [\u4f7f\u7528\u5ba2\u6236\u7ba1\u7406\u7684\u52a0\u5bc6\u5bc6\u9470](https://cloud.google.com/dataflow/docs/guides/customer-managed-encryption-keys?hl=zh-cn) \u4e26\u5617\u8a66\u5275\u5efa Dataflow \u4f5c\u696d\u6642\uff0c\u4f5c\u696d\u5931\u6557\uff0c\u4e26\u4e14\u60a8\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\u7684\u932f\u8aa4\uff1a\n```\nCloud KMS key permission 'cloudkms.cryptoKeyVersions.useToEncrypt' denied on resource\n'projects/project-id/locations/location/keyRings/keyRingName/cryptoKeys/keyname' (or it may not exist). cannot be validated.\nPlease confirm the full key path is used (starts with projects) and that there are no typos.\n```\n\u7576\u5de5\u4f5c\u5668\u670d\u52d9\u8cec\u865f\u548c Dataflow \u670d\u52d9\u8cec\u865f\u6c92\u6709 `roles/cloudkms.cryptoKeyEncrypterDecrypter` [\u89d2\u8272](https://cloud.google.com/kms/docs/reference/permissions-and-roles?hl=zh-cn#predefined_roles) \u6642\uff0c\u6703\u767c\u751f\u6b64\u932f\u8aa4\u3002\n\u8981\u89e3\u6c7a\u6b64\u554f\u984c\uff0c\u8acb\u5c07 `roles/cloudkms.cryptoKeyEncrypterDecrypter` \u89d2\u8272\u6388\u4e88\u5de5\u4f5c\u5668\u670d\u52d9\u8cec\u865f\u548c Dataflow \u670d\u52d9\u8cec\u865f\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1\u201c\u4f7f\u7528\u5ba2\u6236\u7ba1\u7406\u7684\u52a0\u5bc6\u5bc6\u9470\u201d\u9801\u9762\u4e2d\u7684 [\u6388\u4e88 Encrypter/Decrypter \u6b0a\u9650](https://cloud.google.com/dataflow/docs/guides/customer-managed-encryption-keys?hl=zh-cn#granting_encrypterdecrypter_permissions) \u3002\n## \u5c0d\u8cc7\u6e90\u7684\u6b0a\u9650\u88ab\u62d2\u7d55\n\u5617\u8a66\u5275\u5efa\u6d41\u6c34\u7dda\u6642\uff0c\u6d41\u6c34\u7dda\u5931\u6557\u4e26\u986f\u793a\u4ee5\u4e0b\u932f\u8aa4\uff1a\n```\nPermission 'datapipelines.pipelines.create' denied on resource '//datapipelines.googleapis.com/projects/PROJECT_ID/locations/REGION' (or it may not exist).\n```\n\u5982\u679c\u9805\u76ee\u7684\u5de5\u4f5c\u5668\u670d\u52d9\u8cec\u865f\u7121\u6b0a\u8a2a\u554f\u8207\u6d41\u6c34\u7dda\u95dc\u806f\u7684\u6587\u4ef6\u548c\u5176\u4ed6\u8cc7\u6e90\uff0c\u5247\u6703\u51fa\u73fe\u6b64\u932f\u8aa4\u3002\n\u5982\u9700\u89e3\u6c7a\u6b64\u554f\u984c\uff0c\u8acb\u5c07\u4ee5\u4e0b\u89d2\u8272\u5206\u914d\u7d66\u5de5\u4f5c\u5668\u670d\u52d9\u8cec\u865f\uff1a\n- `roles/dataflow.admin`\n- `roles/dataflow.worker`\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1\u201cDataflow \u5b89\u5168\u6027\u548c\u6b0a\u9650\u201d\u4e2d\u7684 [\u5de5\u4f5c\u5668\u670d\u52d9\u8cec\u865f](https://cloud.google.com/dataflow/docs/concepts/security-and-permissions?hl=zh-cn#worker-service-account) \u3002\n## \u5de5\u4f5c\u6d41\u5931\u6557\n\u7576\u60a8 [\u4f7f\u7528\u5ba2\u6236\u7ba1\u7406\u7684\u52a0\u5bc6\u5bc6\u9470](https://cloud.google.com/dataflow/docs/guides/customer-managed-encryption-keys?hl=zh-cn) \u4e26\u5617\u8a66\u5275\u5efa Dataflow \u4f5c\u696d\u6642\uff0c\u4f5c\u696d\u5931\u6557\u4e26\u986f\u793a\u4ee5\u4e0b\u932f\u8aa4\uff1a\n```\nWorkflow failed\n```\n\u51fa\u73fe\u6b64\u932f\u8aa4\u7684\u539f\u56e0\u5982\u4e0b\uff1a\n- \u5bc6\u9470\u548c Dataflow \u4f5c\u696d\u4e0d\u5728\u540c\u4e00\u5340\u57df\uff0c\u6216\u8005\u4f7f\u7528\u4e86\u591a\u5340\u57df\u5bc6\u9470\u3002\u4e0d\u652f\u6301\u5168\u7403\u5bc6\u9470\u548c\u591a\u5340\u57df\u5bc6\u9470\u3002\u60a8\u7684 CMEK \u5340\u57df\u548c Dataflow \u4f5c\u696d\u7684 [\u5340\u57df](https://cloud.google.com/dataflow/docs/resources/locations?hl=zh-cn) \u5fc5\u9808\u76f8\u540c\u3002\n- \u672a\u6b63\u78ba\u6307\u5b9a\u5bc6\u9470\u540d\u7a31\u3002\u9375\u53ef\u80fd\u4e0d\u5b58\u5728\uff0c\u6216\u8005\u540d\u7a31\u53ef\u80fd\u5b58\u5728\u62fc\u5beb\u932f\u8aa4\u3002## Cloud KMS \u5bc6\u9470\u7121\u6cd5\u4fdd\u8b77\u6b64\u4f5c\u696d\u7684\u8cc7\u6e90\n\u7576\u60a8\u904b\u884c Dataflow \u4f5c\u696d\u4e26\u5617\u8a66\u5553\u7528 [\u5ba2\u6236\u7ba1\u7406\u7684\u52a0\u5bc6\u5bc6\u9470](https://cloud.google.com/dataflow/docs/guides/customer-managed-encryption-keys?hl=zh-cn) \u6642\uff0c\u4f5c\u696d\u5931\u6557\uff0c\u4e26\u4e14\u60a8\u770b\u5230\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\u7684\u932f\u8aa4\uff1a\n```\nCloud KMS key can't protect resources for this job. Please make sure the KMS key's region matches the Dataflow region\n```\n\u51fa\u73fe\u6b64\u932f\u8aa4\u7684\u539f\u56e0\u5982\u4e0b\uff1a\n- \u5bc6\u9470\u548c Dataflow \u4f5c\u696d\u4e0d\u5728\u540c\u4e00\u5340\u57df\uff0c\u6216\u8005\u4f7f\u7528\u4e86\u591a\u5340\u57df\u5bc6\u9470\u3002\u4e0d\u652f\u6301\u5168\u7403\u5bc6\u9470\u548c\u591a\u5340\u57df\u5bc6\u9470\u3002\u60a8\u7684 CMEK \u5340\u57df\u548c Dataflow \u4f5c\u696d\u7684 [\u5340\u57df](https://cloud.google.com/dataflow/docs/resources/locations?hl=zh-cn) \u5fc5\u9808\u76f8\u540c\u3002\n- \u672a\u6b63\u78ba\u6307\u5b9a [dataflowKMSKey](https://cloud.google.com/dataflow/docs/reference/pipeline-options?hl=zh-cn#security_and_networking) \u53c3\u6578\u3002", "guide": "Dataflow"}