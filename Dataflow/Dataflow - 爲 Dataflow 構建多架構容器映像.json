{"title": "Dataflow - \u7232 Dataflow \u69cb\u5efa\u591a\u67b6\u69cb\u5bb9\u5668\u6620\u50cf", "url": "https://cloud.google.com/dataflow/docs/guides/multi-architecture-container?hl=zh-cn", "abstract": "# Dataflow - \u7232 Dataflow \u69cb\u5efa\u591a\u67b6\u69cb\u5bb9\u5668\u6620\u50cf\n\u5982\u679c\u60a8\u5728 Dataflow \u4e2d\u4f7f\u7528\u81ea\u5b9a\u7fa9\u5bb9\u5668\uff0c\u5247\u8a72\u5bb9\u5668\u5fc5\u9808\u8207\u5de5\u4f5c\u5668\u865b\u64ec\u6a5f\u7684\u67b6\u69cb\u5339\u914d\u3002\u672c\u6587\u6a94\u4ecb\u7d39\u77ad\u5982\u4f55\u5275\u5efa\u8207 x86 \u548c Arm \u865b\u64ec\u6a5f\u90fd\u517c\u5bb9\u7684\u591a\u67b6\u69cb\u5bb9\u5668\u3002\n\u60a8\u53ef\u4ee5\u4f7f\u7528 Docker CLI \u6216 [Cloud Build](https://cloud.google.com/build/docs/overview?hl=zh-cn) \u4f86\u69cb\u5efa\u5bb9\u5668\u6620\u50cf\u3002\n", "content": "## \u4f7f\u7528 Docker \u69cb\u5efa\u6620\u50cf\n- \u5275\u5efa Dockerfile\u3002\u4f7f\u7528 `FROM` \u6307\u4ee4\u6307\u5b9a\u591a\u67b6\u69cb\u57fa\u790e\u6620\u50cf\u3002```\nFROM apache/beam_python3.10_sdk:2.50.0# Make your customizations here, for example:ENV FOO=/barCOPY path/to/myfile ./\n```\n- \u5b89\u88dd [Buildx](https://docs.docker.com/build/architecture/) \u5de5\u5177\u3002\u5982\u9700\u6aa2\u67e5\u8a72\u5de5\u5177\u662f\u5426\u5df2\u5b89\u88dd\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ndocker buildx version\n```\n- \u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u5275\u5efa\u4f7f\u7528 `docker-container` \u9a45\u52d5\u7a0b\u5e8f\u7684\u69cb\u5efa\u5668\u5be6\u4f8b\u3002\u6b64\u9a45\u52d5\u7a0b\u5e8f\u662f\u69cb\u5efa\u591a\u67b6\u69cb\u6620\u50cf\u6240\u5fc5\u9700\u7684\u3002```\ndocker buildx create --driver=docker-container --use\n````--use` \u6a19\u8a8c\u7528\u65bc\u5c07\u65b0\u7684\u69cb\u5efa\u5668\u5be6\u4f8b\u8a2d\u7f6e\u7232\u7576\u524d\u69cb\u5efa\u5668\u3002\n- \u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u914d\u7f6e Docker\uff0c\u4ee5\u5c0d Artifact Registry \u7684\u8acb\u6c42\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002```\ngcloud auth configure-docker REGION-docker.pkg.dev\n```\u5c07 \u66ff\u63db\u7232 Artifact Registry \u88fd\u54c1\u5eab\u7684\u5340\u57df\u3002\n- \u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4ee5\u69cb\u5efa\u5bb9\u5668\u6620\u50cf\u4e26\u5c07\u5176\u63a8\u9001\u5230 Artifact Registry\uff1a```\ndocker buildx build \\\u00a0 --platform=linux/amd64,linux/arm64 \\\u00a0 -t REGISTRY/IMAGE:TAG \u00a0\\\u00a0 --push .\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- \uff1aDocker \u88fd\u54c1\u5eab\n- \uff1a\u6620\u50cf\u540d\u7a31\n- \uff1a\u6620\u50cf\u6a19\u8a18\n## \u4f7f\u7528 Cloud Build \u69cb\u5efa\u6620\u50cf\n- \u5275\u5efa Dockerfile\u3002\u4f7f\u7528 `FROM` \u6307\u4ee4\u6307\u5b9a\u591a\u67b6\u69cb\u57fa\u790e\u6620\u50cf\u3002```\nFROM apache/beam_python3.10_sdk:2.50.0# Make your customizations here, for example:ENV FOO=/barCOPY path/to/myfile ./\n```\n- \u5728 Dockerfile \u6240\u5728\u7684\u76ee\u9304\u4e2d\uff0c\u5275\u5efa\u4e00\u500b\u540d\u7232 `docker_buildx.yaml` \u7684\u6587\u4ef6\u3002\u7c98\u8cbc\u4ee5\u4e0b\u6587\u672c\uff1a```\nsteps:- name: 'docker'\u00a0 args: ['buildx', 'create', '--driver', 'docker-container', '--name', 'container', '--use']- name: 'docker'\u00a0 args: ['buildx', 'build', '--platform', 'linux/amd64,linux/arm64', '-t', 'REGISTRY/IMAGE:TAG', '--push', '.']\n```\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- \uff1aDocker \u88fd\u54c1\u5eab\n- \uff1a\u6620\u50cf\u540d\u7a31\n- \uff1a\u6620\u50cf\u6a19\u8a18\n- \u5982\u9700\u69cb\u5efa\u4e26\u63a8\u9001\u6620\u50cf\uff0c\u8acb\u904b\u884c [gcloud builds submit \u547d\u4ee4](https://cloud.google.com/sdk/gcloud/reference/builds/submit?hl=zh-cn) \uff1a```\ngcloud builds submit --region=REGION --config docker_buildx.yaml\n```\u5c07 \u66ff\u63db\u7232\u8981\u4f7f\u7528\u7684 Cloud Build \u670d\u52d9\u7684\u5340\u57df\u3002\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u4f7f\u7528 Cloud Build \u69cb\u5efa\u548c\u63a8\u9001 Docker \u6620\u50cf](https://cloud.google.com/build/docs/build-push-docker-image?hl=zh-cn) \u3002\n## \u9a57\u8b49\u5bb9\u5668\u6620\u50cf\n- \u6253\u958b Google Cloud \u63a7\u5236\u6aaf\u4e2d\u7684 **\u88fd\u54c1\u5eab** \u9801\u9762\u3002 [\u6253\u958b\u201c\u4ee3\u78bc\u5eab\u201d\u9801\u9762](https://console.cloud.google.com/artifacts?hl=zh-cn) \n- \u9ede\u64ca\u5305\u542b\u5bb9\u5668\u6620\u50cf\u7684\u88fd\u54c1\u5eab\u3002\n- \u9ede\u64ca\u6620\u50cf\u4ee5\u67e5\u770b\u5176\u7248\u672c\u3002\n- \u9ede\u64ca\u4e00\u500b\u7248\u672c\u3002\n- \u9ede\u64ca **\u6e05\u55ae** \u3002\n- \u5728\u6e05\u55ae\u6587\u4ef6\u4e2d\uff0c `platform` \u90e8\u5206\u61c9\u5305\u542b `arm64` \u548c `amd64` \u7684\u689d\u76ee\u3002\u4f8b\u5982\uff1a```\n\u00a0 {\u00a0 \u00a0 \"schemaVersion\": 2,\u00a0 \u00a0 \"mediaType\": \"application/vnd.docker.distribution.manifest.list.v2+json\",\u00a0 \u00a0 \"manifests\": [\u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"mediaType\": \"application/vnd.docker.distribution.manifest.v2+json\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"digest\": \"sha256:441d5438885049e2b388523a8cb5b77ea829c3c3f53326fb221fe185abd67f07\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"size\": 3074,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"platform\": {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"architecture\": \"amd64\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"os\": \"linux\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"mediaType\": \"application/vnd.docker.distribution.manifest.v2+json\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"digest\": \"sha256:d3b98b0f8f3f555f5453c79b240bd2b862d4f52d853fe81bae55f01a663de29c\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"size\": 3073,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"platform\": {\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"architecture\": \"arm64\",\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \"os\": \"linux\"\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 \u00a0 \u00a0 }\u00a0 \u00a0 ]\u00a0 }\n```## \u5f8c\u7e8c\u6b65\u9a5f\n- [\u5728 Dataflow \u4e0a\u4f7f\u7528 Arm \u865b\u64ec\u6a5f](https://cloud.google.com/dataflow/docs/guides/use-arm-vms?hl=zh-cn) \n- [\u5728\u81ea\u5b9a\u7fa9\u5bb9\u5668\u4e2d\u904b\u884c Dataflow \u4f5c\u696d](https://cloud.google.com/dataflow/docs/guides/run-custom-container?hl=zh-cn)", "guide": "Dataflow"}