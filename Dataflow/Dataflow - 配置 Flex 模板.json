{"title": "Dataflow - \u914d\u7f6e Flex \u6a21\u677f", "url": "https://cloud.google.com/dataflow/docs/guides/templates/configuring-flex-templates?hl=zh-cn", "abstract": "# Dataflow - \u914d\u7f6e Flex \u6a21\u677f\n\u672c\u9801\u9762\u8a18\u9304\u4e86\u5404\u7a2e Dataflow Flex \u6a21\u677f\u914d\u7f6e\u9078\u9805\uff0c\u5305\u62ec\uff1a\n- [\u6b0a\u9650](#permissions) \n- [Dockerfile \u74b0\u5883\u8b8a\u91cf](#env-variables) \n- [\u8edf\u4ef6\u5305\u4f9d\u8cf4\u9805](#dependencies) \n- [Docker \u6620\u50cf](#images) \n- [\u6d41\u6c34\u7dda\u9078\u9805](#specify-options) \n- [\u66ab\u5b58\u4f4d\u7f6e\u548c\u81e8\u6642\u4f4d\u7f6e](#locations) \n\u5982\u8981\u914d\u7f6e\u793a\u4f8b Flex \u6a21\u677f\uff0c\u8acb\u53c3\u95b1 [Flex \u6a21\u677f\u6559\u7a0b](https://cloud.google.com/dataflow/docs/guides/templates/using-flex-templates?hl=zh-cn) \u3002\n", "content": "## \u77ad\u89e3 Flex \u6a21\u677f\u6b0a\u9650\n\u4f7f\u7528 Flex \u6a21\u677f\u6642\uff0c\u60a8\u9700\u8981\u4e09\u7d44\u6b0a\u9650\uff1a\n- \u5275\u5efa\u8cc7\u6e90\u7684\u6b0a\u9650\n- \u69cb\u5efa Flex \u6a21\u677f\u7684\u6b0a\u9650\n- \u904b\u884c Flex \u6a21\u677f\u7684\u6b0a\u9650\n### \u5275\u5efa\u8cc7\u6e90\u7684\u6b0a\u9650\n\u5982\u9700\u958b\u767c\u548c\u904b\u884c Flex \u6a21\u677f\u6d41\u6c34\u7dda\uff0c\u60a8\u9700\u8981\u5275\u5efa\u5404\u7a2e\u8cc7\u6e90\uff08\u4f8b\u5982\u66ab\u5b58\u5b58\u5132\u6876\uff09\u3002\u5c0d\u65bc\u4e00\u6b21\u6027\u8cc7\u6e90\u5275\u5efa\u4efb\u52d9\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 [\u57fa\u672c Owner \u89d2\u8272](https://cloud.google.com/iam/docs/understanding-roles?hl=zh-cn#basic) \u3002\n### \u69cb\u5efa Flex \u6a21\u677f\u7684\u6b0a\u9650\n\u4f5c\u7232 Flex \u6a21\u677f\u7684\u958b\u767c\u8005\uff0c\u60a8\u9700\u8981\u69cb\u5efa\u6a21\u677f\uff0c\u4ee5\u5c07\u5176\u63d0\u4f9b\u7d66\u7528\u6236\u3002\u69cb\u5efa\u6d89\u53ca\u5c07\u6a21\u677f\u898f\u7bc4\u4e0a\u50b3\u5230 Cloud Storage \u5b58\u5132\u6876\uff0c\u4ee5\u53ca\u4f7f\u7528\u904b\u884c\u6d41\u6c34\u7dda\u6240\u9700\u7684\u4ee3\u78bc\u548c\u4f9d\u8cf4\u9805\u9810\u914d Docker \u6620\u50cf\u3002\u5982\u9700\u69cb\u5efa Flex \u6a21\u677f\uff0c\u60a8\u9700\u8981\u64c1\u6709 Cloud Storage \u7684\u8b80\u5beb\u6b0a\u9650\u4ee5\u53ca\u5c0d Artifact Registry \u4ee3\u78bc\u5eab\u7684 [Artifact Registry Writer \u6b0a\u9650](https://cloud.google.com/artifact-registry/docs/access-control?hl=zh-cn#permissions) \u3002\u60a8\u53ef\u4ee5\u901a\u904e\u5206\u914d\u4ee5\u4e0b\u89d2\u8272\u4f86\u6388\u4e88\u9019\u4e9b\u6b0a\u9650\uff1a\n- Storage Admin (`roles/storage.admin`)\n- Cloud Build Editor (`roles/cloudbuild.builds.editor`)\n- Artifact Registry Writer (`roles/artifactregistry.writer`)\n### \u904b\u884c Flex \u6a21\u677f\u7684\u6b0a\u9650\n\u7576\u60a8\u904b\u884c Flex \u6a21\u677f\u6642\uff0cDataflow \u6703\u7232\u60a8\u5275\u5efa\u4e00\u500b\u4f5c\u696d\u3002\u5982\u9700\u5275\u5efa\u4f5c\u696d\uff0cDataflow \u670d\u52d9\u8cec\u865f\u9700\u8981\u4ee5\u4e0b\u6b0a\u9650\uff1a\n- `dataflow.serviceAgent`\n\u9996\u6b21\u4f7f\u7528 Dataflow \u6642\uff0c\u670d\u52d9\u6703\u7232\u60a8\u5206\u914d\u6b64\u89d2\u8272\uff0c\u56e0\u6b64\u60a8\u7121\u9700\u6388\u4e88\u6b64\u6b0a\u9650\u3002\n\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cCompute Engine \u670d\u52d9\u8cec\u865f\u7528\u65bc\u5553\u52d5\u5668\u865b\u64ec\u6a5f\u548c\u5de5\u4f5c\u5668\u865b\u64ec\u6a5f\u3002\u8a72\u670d\u52d9\u8cec\u865f\u9700\u8981\u4ee5\u4e0b\u89d2\u8272\u548c\u6b0a\u9650\uff1a\n- Storage Object Admin (`roles/storage.objectAdmin`)\n- Viewer (`roles/viewer`)\n- Dataflow Worker (`roles/dataflow.worker`)\n- \u66ab\u5b58\u5b58\u5132\u6876\u7684\u8b80\u5beb\u6b0a\u9650\n- Flex \u6a21\u677f\u6620\u50cf\u7684\u8b80\u53d6\u6b0a\u9650\n\u5982\u9700\u6388\u4e88\u66ab\u5b58\u5b58\u5132\u6876\u7684\u8b80\u5beb\u6b0a\u9650\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 Storage Object Admin ( `roles/storage.objectAdmin` ) \u89d2\u8272\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [Cloud Storage \u7684 IAM \u89d2\u8272](https://cloud.google.com/storage/docs/access-control/iam-roles?hl=zh-cn) \u3002\n\u5982\u9700\u6388\u4e88 Flex \u6a21\u677f\u6620\u50cf\u7684\u8b80\u53d6\u6b0a\u9650\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 Storage Object Viewer ( `roles/storage.objectViewer` ) \u89d2\u8272\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u914d\u7f6e\u8a2a\u554f\u6b0a\u9650\u63a7\u5236](https://cloud.google.com/artifact-registry/docs/access-control?hl=zh-cn) \u3002\n## \u8a2d\u7f6e\u6240\u9700\u7684 Dockerfile \u74b0\u5883\u8b8a\u91cf\n\u5982\u679c\u8981\u7232 Flex \u6a21\u677f\u4f5c\u696d\u5275\u5efa\u81ea\u5df1\u7684 Dockerfile\uff0c\u8acb\u6307\u5b9a\u4ee5\u4e0b\u74b0\u5883\u8b8a\u91cf\uff1a\n\u5728 Dockerfile \u4e2d\u6307\u5b9a `FLEX_TEMPLATE_JAVA_MAIN_CLASS` \u548c `FLEX_TEMPLATE_JAVA_CLASSPATH` \u3002\n| ENV       | \u8aaa\u660e          | \u5fc5\u9700 |\n|:------------------------------|:-----------------------------------------|:-------|\n| FLEX_TEMPLATE_JAVA_MAIN_CLASS | \u6307\u5b9a\u5553\u52d5 Flex \u6a21\u677f\u8981\u904b\u884c\u7684 Java \u985e\u3002  | \u662f  |\n| FLEX_TEMPLATE_JAVA_CLASSPATH | \u6307\u5b9a\u985e\u6587\u4ef6\u7684\u4f4d\u7f6e\u3002      | \u662f  |\n| FLEX_TEMPLATE_JAVA_OPTIONS | \u6307\u5b9a\u5553\u52d5 Flex \u6a21\u677f\u6642\u8981\u50b3\u905e\u7684 Java \u9078\u9805\u3002 | \u5426  |\n\u5728 Dockerfile \u4e2d\u6307\u5b9a `FLEX_TEMPLATE_PYTHON_PY_FILE` \u3002\n\u5982\u9700\u7ba1\u7406\u6d41\u6c34\u7dda\u4f9d\u8cf4\u9805\uff0c\u8acb\u5728 Dockerfile \u4e2d\u8a2d\u7f6e\u8b8a\u91cf\uff0c\u5982\u4e0b\u6240\u793a\uff1a- `FLEX_TEMPLATE_PYTHON_REQUIREMENTS_FILE`\n- `FLEX_TEMPLATE_PYTHON_PY_OPTIONS`\n- `FLEX_TEMPLATE_PYTHON_SETUP_FILE`\n- `FLEX_TEMPLATE_PYTHON_EXTRA_PACKAGES`\n\u4f8b\u5982\uff0c\u6211\u5011\u5728 [Streaming in Python Flex \u6a21\u677f\u6559\u7a0b](https://github.com/GoogleCloudPlatform/python-docs-samples/blob/master/dataflow/flex-templates/streaming_beam/Dockerfile) \u4e2d\u8a2d\u7f6e\u4e86\u4ee5\u4e0b\u74b0\u5883\u8b8a\u91cf\uff1a\n```\nENV FLEX_TEMPLATE_PYTHON_REQUIREMENTS_FILE=\"${WORKDIR}/requirements.txt\"ENV FLEX_TEMPLATE_PYTHON_PY_FILE=\"${WORKDIR}/streaming_beam.py\"\n```\n| ENV         | \u8aaa\u660e                        | \u5fc5\u9700 |\n|:---------------------------------------|:--------------------------------------------------------------------------------------------------|:-------|\n| FLEX_TEMPLATE_PYTHON_PY_FILE   | \u6307\u5b9a\u5553\u52d5 Flex \u6a21\u677f\u8981\u904b\u884c\u7684 Python \u6587\u4ef6\u3002               | \u662f  |\n| FLEX_TEMPLATE_PYTHON_REQUIREMENTS_FILE | \u6307\u5b9a\u5305\u542b\u6d41\u6c34\u7dda\u4f9d\u8cf4\u9805\u7684\u9700\u6c42\u6587\u4ef6\u3002 \u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 Apache Beam \u6587\u6a94\u4e2d\u7684 PyPI \u4f9d\u8cf4\u9805\u3002   | \u5426  |\n| FLEX_TEMPLATE_PYTHON_SETUP_FILE  | \u6307\u5b9a\u6d41\u6c34\u7dda\u8edf\u4ef6\u5305\u201csetup.py\u201d\u6587\u4ef6\u7684\u8def\u5f91\u3002 \u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 Apache Beam \u6587\u6a94\u4e2d\u7684\u591a\u500b\u6587\u4ef6\u4f9d\u8cf4\u9805\u3002 | \u5426  |\n| FLEX_TEMPLATE_PYTHON_EXTRA_PACKAGES | \u6307\u5b9a\u4e0d\u516c\u958b\u63d0\u4f9b\u7684\u8edf\u4ef6\u5305\u3002\u5982\u9700\u77ad\u89e3\u5982\u4f55\u4f7f\u7528\u984d\u5916\u7684\u8edf\u4ef6\u5305\uff0c\u8acb\u53c3\u95b1\u672c\u5730\u6216\u975e PyPI \u4f9d\u8cf4\u9805\u3002    | \u5426  |\n| FLEX_TEMPLATE_PYTHON_PY_OPTIONS  | \u6307\u5b9a\u5553\u52d5 Flex \u6a21\u677f\u6642\u8981\u50b3\u905e\u7684 Python \u9078\u9805\u3002              | \u5426  |\n## \u8edf\u4ef6\u5305\u4f9d\u8cf4\u9805\n\u7576 Dataflow Python \u6d41\u6c34\u7dda\u4f7f\u7528\u5176\u4ed6\u4f9d\u8cf4\u9805\u6642\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u914d\u7f6e Flex \u6a21\u677f\u4ee5\u5728 Dataflow \u5de5\u4f5c\u5668\u865b\u64ec\u6a5f\u4e0a\u5b89\u88dd\u5176\u4ed6\u4f9d\u8cf4\u9805\u3002\n\u5982\u679c\u5728\u9650\u5236\u4e92\u806f\u7db2\u8a2a\u554f\u7684\u74b0\u5883\u4e2d\u904b\u884c\u4f7f\u7528 Flex \u6a21\u677f\u7684 Python Dataflow \u4f5c\u696d\uff0c\u5247\u60a8\u5fc5\u9808\u5728\u5275\u5efa\u6a21\u677f\u6642\u9810\u5c01\u88dd\u4f9d\u8cf4\u9805\u3002\n\u4f7f\u7528\u4ee5\u4e0b\u4efb\u4e00\u9078\u9805\u9810\u5c01\u88dd Python \u4f9d\u8cf4\u9805\u3002\n### \u4f7f\u7528\u9700\u6c42\u6587\u4ef6\u4e26\u4f7f\u7528\u6a21\u677f\u9810\u5c01\u88dd\u4f9d\u8cf4\u9805\n\u5982\u679c\u60a8\u4f7f\u7528\u81ea\u5df1\u7684 Dockerfile \u5b9a\u7fa9 Flex \u6a21\u677f\u6620\u50cf\uff0c\u8acb\u6309\u7167\u4ee5\u4e0b\u6b65\u9a5f\u64cd\u4f5c\uff1a\n- \u5275\u5efa\u4e00\u500b\u5217\u51fa\u6d41\u6c34\u7dda\u4f9d\u8cf4\u9805\u7684 `requirements.txt` \u6587\u4ef6\u3002```\nCOPY requirements.txt /template/ENV FLEX_TEMPLATE_PYTHON_REQUIREMENTS_FILE=\"/template/requirements.txt\"\n```\n- \u5728 Flex \u6a21\u677f\u6620\u50cf\u4e2d\u5b89\u88dd\u4f9d\u8cf4\u9805\u3002```\nRUN pip install --no-cache-dir -r $FLEX_TEMPLATE_PYTHON_REQUIREMENTS_FILE\n```\n- \u5c07\u4f9d\u8cf4\u9805\u4e0b\u8f09\u5230\u672c\u5730\u9700\u6c42\u7de9\u5b58\u4e2d\uff0c\u8a72\u7de9\u5b58\u6703\u5728\u6a21\u677f\u5553\u52d5\u6642\u66ab\u5b58\u5230 Dataflow \u5de5\u4f5c\u5668\u3002```\nRUN pip download --no-cache-dir --dest /tmp/dataflow-requirements-cache -r $FLEX_TEMPLATE_PYTHON_REQUIREMENTS_FILE\n```\n\u4e0b\u9762\u662f\u4e00\u500b\u7528\u65bc\u9810\u4e0b\u8f09\u4f9d\u8cf4\u9805\u7684\u4ee3\u78bc\u793a\u4f8b\u3002\n[  dataflow/flex-templates/streaming_beam/Dockerfile ](https://github.com/GoogleCloudPlatform/python-docs-samples/blob/HEAD/dataflow/flex-templates/streaming_beam/Dockerfile) [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/python-docs-samples/blob/HEAD/dataflow/flex-templates/streaming_beam/Dockerfile)\n```\n# Copyright 2020 Google LLC\n## Licensed under the Apache License, Version 2.0 (the \"License\");# you may not use this file except in compliance with the License.# You may obtain a copy of the License at\n## \u00a0 \u00a0http://www.apache.org/licenses/LICENSE-2.0\n## Unless required by applicable law or agreed to in writing, software# distributed under the License is distributed on an \"AS IS\" BASIS,# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.# See the License for the specific language governing permissions and# limitations under the License.FROM gcr.io/dataflow-templates-base/python3-template-launcher-baseENV FLEX_TEMPLATE_PYTHON_REQUIREMENTS_FILE=\"/template/requirements.txt\"ENV FLEX_TEMPLATE_PYTHON_PY_FILE=\"/template/streaming_beam.py\"COPY . /template# We could get rid of installing libffi-dev and git, or we could leave them.RUN apt-get update \\\u00a0 \u00a0 && apt-get install -y libffi-dev git \\\u00a0 \u00a0 && rm -rf /var/lib/apt/lists/* \\\u00a0 \u00a0 # Upgrade pip and install the requirements.\u00a0 \u00a0 && pip install --no-cache-dir --upgrade pip \\\u00a0 \u00a0 && pip install --no-cache-dir -r $FLEX_TEMPLATE_PYTHON_REQUIREMENTS_FILE \\\u00a0 \u00a0 # Download the requirements to speed up launching the Dataflow job.\u00a0 \u00a0 && pip download --no-cache-dir --dest /tmp/dataflow-requirements-cache -r $FLEX_TEMPLATE_PYTHON_REQUIREMENTS_FILE# Since we already downloaded all the dependencies, there's no need to rebuild everything.ENV PIP_NO_DEPS=TrueENTRYPOINT [\"/opt/google/dataflow/python_template_launcher\"]\n```\n### \u4f7f\u7528\u9810\u5b89\u88dd\u6240\u6709\u4f9d\u8cf4\u9805\u7684\u81ea\u5b9a\u7fa9\u5bb9\u5668\n\u5c0d\u65bc\u5728\u4e0d\u8a2a\u554f\u4e92\u806f\u7db2\u7684\u74b0\u5883\u4e2d\u904b\u884c\u7684\u6d41\u6c34\u7dda\uff0c\u9996\u9078\u6b64\u9078\u9805\u3002\n\u5982\u9700\u4f7f\u7528\u81ea\u5b9a\u7fa9\u5bb9\u5668\uff0c\u8acb\u6309\u4ee5\u4e0b\u6b65\u9a5f\u64cd\u4f5c\uff1a\n- \u69cb\u5efa [\u9810\u5b89\u88dd\u5fc5\u8981\u4f9d\u8cf4\u9805](https://cloud.google.com/dataflow/docs/guides/build-container-image?hl=zh-cn#preinstall_using_a_dockerfile) \u7684\u81ea\u5b9a\u7fa9\u5bb9\u5668\u3002\n- \u5728 Flex \u6a21\u677f Dockerfile \u4e2d\u9810\u5b89\u88dd\u76f8\u540c\u7684\u4f9d\u8cf4\u9805\u3002\u8acb\u52ff\u4f7f\u7528 `FLEX_TEMPLATE_PYTHON_REQUIREMENTS_FILE` \u9078\u9805\u3002\u4fee\u6539\u5f8c\u7684 `dataflow/flex-templates/streaming_beam/Dockerfile` \u53ef\u80fd\u5982\u4ee5\u4e0b\u793a\u4f8b\u6240\u793a\uff1a```\nFROM gcr.io/dataflow-templates-base/python3-template-launcher-baseENV FLEX_TEMPLATE_PYTHON_PY_FILE=\"/template/streaming_beam.py\"COPY . /templateRUN pip install --no-cache-dir -r /template/requirements.txt\n```\u6216\u8005\uff0c\u4f7f\u7528 [\u81ea\u5b9a\u7fa9\u5bb9\u5668\u6620\u50cf\u4f5c\u7232 Flex \u6a21\u677f\u7684\u57fa\u790e\u6620\u50cf](#use_custom_container_images) \u3002\n- \u5982\u679c\u60a8\u4f7f\u7528 Apache Beam SDK 2.49.0 \u7248\u6216\u66f4\u4f4e\u7248\u672c\uff0c\u8acb\u5728\u6d41\u6c34\u7dda\u5553\u52d5\u5668\u4e2d\u6dfb\u52a0 `--sdk_location=container` \u6d41\u6c34\u7dda\u9078\u9805\u3002\u6b64\u9078\u9805\u6703\u6307\u793a\u6d41\u6c34\u7dda\u5f9e\u81ea\u5b9a\u7fa9\u5bb9\u5668\u4f7f\u7528 SDK\uff0c\u800c\u4e0d\u662f\u4e0b\u8f09 SDK\u3002```\noptions = PipelineOptions(beam_args, save_main_session=True, streaming=True, sdk_location=\"container\")\n```\n- \u5728 `flex-template run` \u547d\u4ee4\u4e2d\u8a2d\u7f6e `sdk_container_image` \u53c3\u6578\u3002\u4f8b\u5982\uff1a```\ngcloud dataflow flex-template run $JOB_NAME \\\u00a0 \u00a0--region=$REGION \\\u00a0 \u00a0--template-file-gcs-location=$TEMPLATE_PATH \\\u00a0 \u00a0--parameters=sdk_container_image=$CUSTOM_CONTAINER_IMAGE \\\u00a0 \u00a0--additional-experiments=use_runner_v2\n```\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u5728 Dataflow \u4e2d\u4f7f\u7528\u81ea\u5b9a\u7fa9\u5bb9\u5668](https://cloud.google.com/dataflow/docs/guides/using-custom-containers?hl=zh-cn) \u3002\n### \u5c07\u6d41\u6c34\u7dda\u7684\u7d50\u69cb\u8a2d\u8a08\u7232\u8edf\u4ef6\u5305\n\u5982\u679c\u60a8\u5c07\u6d41\u6c34\u7dda\u7d50\u69cb\u8a2d\u8a08\u7232\u8edf\u4ef6\u5305\uff0c\u8acb\u4f7f\u7528 `FLEX_TEMPLATE_PYTHON_SETUP_FILE` \u9078\u9805\u3002\u5982\u9700\u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u5c07\u6d41\u6c34\u7dda\u7d50\u69cb\u8a2d\u8a08\u7232\u8edf\u4ef6\u5305\uff0c\u8acb\u53c3\u95b1 Apache Beam \u6587\u6a94\u4e2d\u7684 [\u591a\u500b\u6587\u4ef6\u4f9d\u8cf4\u9805](https://beam.apache.org/documentation/sdks/python-pipeline-dependencies/#multiple-file-dependencies) \u3002\n\u5982\u679c\u60a8\u4f7f\u7528\u81ea\u5df1\u7684 Dockerfile \u4f86\u5b9a\u7fa9 Flex \u6a21\u677f\u6620\u50cf\uff0c\u8acb\u5728 Dockerfile \u4e2d\u5b89\u88dd\u8edf\u4ef6\u5305\u3002\nFlex \u6a21\u677f Dockerfile \u53ef\u80fd\u5305\u542b\u4ee5\u4e0b\u5167\u5bb9\uff1a\n```\n\u00a0 COPY setup.py .\u00a0 COPY main.py .\u00a0 COPY package_name package_name\u00a0 RUN pip install -e .\u00a0 ENV FLEX_TEMPLATE_PYTHON_SETUP_FILE=\"${WORKDIR}/setup.py\"\u00a0 ENV FLEX_TEMPLATE_PYTHON_PY_FILE=\"${WORKDIR}/main.py\"\n```\n\u60a8\u53ef\u4ee5\u4f7f\u7528\u6b64\u65b9\u6cd5\u548c\u81ea\u5b9a\u7fa9\u5bb9\u5668\u6620\u50cf\u5728\u904b\u884c\u6642\u74b0\u5883\u4e2d\u9810\u5b89\u88dd\u4f9d\u8cf4\u9805\u3002\n## \u9078\u64c7\u57fa\u790e\u6620\u50cf\n\u60a8\u53ef\u4ee5\u4f7f\u7528 Google \u63d0\u4f9b\u7684 [\u57fa\u790e\u6620\u50cf](https://docs.docker.com/glossary/#base_image) \u4f86\u4f7f\u7528 Docker \u6253\u5305\u6a21\u677f\u5bb9\u5668\u6620\u50cf\u3002\u5f9e [Flex \u6a21\u677f\u57fa\u790e\u6620\u50cf](https://cloud.google.com/dataflow/docs/reference/flex-templates-base-images?hl=zh-cn) \u4e2d\u9078\u64c7\u6700\u65b0\u6a19\u8a18\u3002\u5efa\u8b70\u4f7f\u7528\u7279\u5b9a\u7684\u5716\u7247\u4ee3\u78bc\uff08\u800c\u975e `latest` \uff09\u3002\n\u8acb\u6309\u4ee5\u4e0b\u683c\u5f0f\u6307\u5b9a\u57fa\u790e\u6620\u50cf\uff1a\n```\ngcr.io/dataflow-templates-base/IMAGE_NAME:TAG\n```\n\u8acb\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a\n- ``\uff1aGoogle \u63d0\u4f9b\u7684\u57fa\u790e\u6620\u50cf\n- ``\uff1a\u57fa\u790e\u6620\u50cf\u7684\u7248\u672c\u540d\u7a31\uff0c\u8acb\u53c3\u95b1 [Flex \u6a21\u677f\u57fa\u790e\u6620\u50cf\u53c3\u8003](https://cloud.google.com/dataflow/docs/reference/flex-templates-base-images?hl=zh-cn) \n### \u4f7f\u7528\u81ea\u5b9a\u7fa9\u5bb9\u5668\u6620\u50cf\n\u5982\u679c\u60a8\u7684\u6d41\u6c34\u7dda\u4f7f\u7528\u81ea\u5b9a\u7fa9\u5bb9\u5668\u6620\u50cf\uff0c\u6211\u5011\u5efa\u8b70\u5c07\u6b64\u81ea\u5b9a\u7fa9\u6620\u50cf\u7528\u4f5c Flex \u6a21\u677f Docker \u6620\u50cf\u7684\u57fa\u790e\u6620\u50cf\u3002\u7232\u6b64\uff0c\u8acb\u5c07 Google \u63d0\u4f9b\u7684 [\u6a21\u677f\u57fa\u790e\u6620\u50cf](https://cloud.google.com/dataflow/docs/reference/flex-templates-base-images?hl=zh-cn) \u4e2d\u7684 Flex \u6a21\u677f\u5553\u52d5\u5668\u4e8c\u9032\u5236\u6587\u4ef6\u8907\u88fd\u5230\u60a8\u7684\u81ea\u5b9a\u7fa9\u6620\u50cf\u3002\u793a\u4f8b `Dockerfile` \uff1a\n```\nFROM gcr.io/dataflow-templates-base/IMAGE_NAME:TAG as template_launcherFROM USER_CUSTOM_IMAGECOPY --from=template_launcher /opt/google/dataflow/python_template_launcher /opt/google/dataflow/python_template_launcherARG WORKDIR=/dataflow/templateRUN mkdir -p ${WORKDIR}WORKDIR ${WORKDIR}COPY streaming_beam.py .ENV FLEX_TEMPLATE_PYTHON_PY_FILE=\"${WORKDIR}/streaming_beam.py\"ENTRYPOINT [\"/opt/google/dataflow/python_template_launcher\"]\n```\n\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a\n- ``\uff1aGoogle \u63d0\u4f9b\u7684\u57fa\u790e\u6620\u50cf\u3002\u4f8b\u5982\uff1a`python311-template-launcher-base`\u3002\n- ``\uff1a\u57fa\u790e\u6620\u50cf\u7684\u7248\u672c\u6a19\u8a18\uff0c\u8acb\u53c3\u95b1 [Flex \u6a21\u677f\u57fa\u790e\u6620\u50cf\u53c3\u8003\u6587\u6a94](https://cloud.google.com/dataflow/docs/reference/flex-templates-base-images?hl=zh-cn) \u7232\u4e86\u63d0\u9ad8\u7a69\u5b9a\u6027\u548c\u554f\u984c\u6392\u67e5\uff0c\u8acb\u907f\u514d\u4f7f\u7528`latest`\u3002\u8acb\u6539\u7232\u56fa\u5b9a\u5230\u7279\u5b9a\u7248\u672c\u6a19\u8a18\u3002\n- ``\uff1a\u60a8\u7684\u81ea\u5b9a\u7fa9\u5bb9\u5668\u6620\u50cf\n### \u4f7f\u7528\u79c1\u6709\u8a3b\u518a\u8868\u4e2d\u7684\u6620\u50cf\n\u60a8\u53ef\u4ee5\u69cb\u5efa\u5b58\u5132\u5728\u79c1\u6709 [Docker \u8a3b\u518a\u8868](https://docs.docker.com/registry/) \u4e2d\u7684 Flex \u6a21\u677f\u6620\u50cf\uff0c\u689d\u4ef6\u662f\u8a72\u79c1\u6709\u8a3b\u518a\u8868\u4f7f\u7528 HTTPS \u4e26\u4e14\u5177\u6709\u6709\u6548\u8b49\u66f8\u3002\n\u5982\u9700\u4f7f\u7528\u79c1\u6709\u8a3b\u518a\u8868\u4e2d\u7684\u6620\u50cf\uff0c\u8acb\u6307\u5b9a\u8a72\u6620\u50cf\u7684\u8def\u5f91\u4ee5\u53ca\u8a72\u8a3b\u518a\u8868\u7684\u7528\u6236\u540d\u548c\u5bc6\u78bc\u3002\u7528\u6236\u540d\u548c\u5bc6\u78bc\u5fc5\u9808\u5b58\u5132\u5728 [Secret Manager](https://cloud.google.com/secret-manager/docs?hl=zh-cn) \u4e2d\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u683c\u5f0f\u4e4b\u4e00\u63d0\u4f9b\u5bc6\u6587\uff1a\n- `projects/` `` `/secrets/` `` `/versions/` ``\n- `projects/` `` `/secrets/` ``\n\u5982\u679c\u60a8\u4f7f\u7528\u7b2c\u4e8c\u7a2e\u683c\u5f0f\uff0c\u56e0\u7232\u5b83\u672a\u6307\u5b9a\u7248\u672c\uff0c\u5247 Dataflow \u6703\u4f7f\u7528\u6700\u65b0\u7248\u672c\u3002\n\u5982\u679c\u8a3b\u518a\u8868\u4f7f\u7528\u81ea\u7c3d\u540d\u8b49\u66f8\uff0c\u60a8\u9084\u9700\u8981\u6307\u5b9a\u81ea\u7c3d\u540d\u8b49\u66f8\u7684 Cloud Storage \u8def\u5f91\u3002\n\u4e0b\u8868\u4ecb\u7d39\u4e86\u53ef\u7528\u65bc\u914d\u7f6e\u79c1\u6709\u8a3b\u518a\u8868\u7684 gcloud CLI \u9078\u9805\u3002\n| \u53c3\u6578        | \u8aaa\u660e                                  |\n|:------------------------------------|:-----------------------------------------------------------------------------------------------------------------------------------------|\n| image        | \u8a3b\u518a\u8868\u7684\u5730\u5740\u3002\u4f8b\u5982\uff1agcp.repository.example.com:9082/registry/example/image:latest\u3002              |\n| image-repository-username-secret-id | \u7528\u65bc\u5411\u79c1\u6709\u8a3b\u518a\u8868\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u7528\u6236\u540d\u7684 Secret Manager \u5bc6\u6587 ID\u3002\u4f8b\u5982\uff1aprojects/example-project/secrets/username-secret\u3002     |\n| image-repository-password-secret-id | \u7528\u65bc\u5411\u79c1\u6709\u8a3b\u518a\u8868\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u5bc6\u78bc\u7684 Secret Manager \u5bc6\u6587 ID\u3002\u4f8b\u5982\uff1aprojects/example-project/secrets/password-secret/versions/latest\u3002 |\n| image-repository-cert-path   | \u79c1\u6709\u8a3b\u518a\u8868\u7684\u81ea\u7c3d\u540d\u8b49\u66f8\u7684\u5b8c\u6574 Cloud Storage \u7db2\u5740\u3002\u50c5\u7576\u8a3b\u518a\u8868\u4f7f\u7528\u81ea\u7c3d\u540d\u8b49\u66f8\u6642\uff0c\u624d\u9700\u8981\u586b\u5beb\u6b64\u503c\u3002\u4f8b\u5982\uff1ags://example-bucket/self-signed.crt\u3002 |\n\u4e0b\u9762\u662f\u4e00\u500b\u793a\u4f8b Google Cloud CLI \u547d\u4ee4\uff0c\u8a72\u547d\u4ee4\u4f7f\u7528\u5177\u6709\u81ea\u7c3d\u540d\u8b49\u66f8\u7684\u79c1\u6709\u8a3b\u518a\u8868\u4e2d\u7684\u6620\u50cf\u69cb\u5efa Flex \u6a21\u677f\u3002\n```\ngcloud dataflow flex-template build gs://example-bucket/custom-pipeline-private-repo.json--sdk-language=JAVA--image=\"gcp.repository.example.com:9082/registry/example/image:latest\"--image-repository-username-secret-id=\"projects/example-project/secrets/username-secret\"--image-repository-password-secret-id=\"projects/example-project/secrets/password-secret/versions/latest\"--image-repository-cert-path=\"gs://example-bucket/self-signed.crt\"--metadata-file=metadata.json\n```\n\u5982\u9700\u69cb\u5efa\u60a8\u81ea\u5df1\u7684 Flex \u6a21\u677f\uff0c\u60a8\u9700\u8981\u66ff\u63db\u793a\u4f8b\u503c\uff0c\u4e26\u4e14\u53ef\u80fd\u9700\u8981\u6307\u5b9a\u4e0d\u540c\u7684\u9078\u9805\u6216\u984d\u5916\u6307\u5b9a\u4e00\u4e9b\u9078\u9805\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1\u4ee5\u4e0b\u8cc7\u6e90\uff1a\n- [gcloud dataflow flex-template build](https://cloud.google.com/sdk/gcloud/reference/dataflow/flex-template/build?hl=zh-cn) \n- [\u4f7f\u7528 Flex \u6a21\u677f](https://cloud.google.com/dataflow/docs/guides/templates/using-flex-templates?hl=zh-cn) ## \u6307\u5b9a\u6d41\u6c34\u7dda\u9078\u9805\n\u5982\u9700\u77ad\u89e3 Flex \u6a21\u677f\u76f4\u63a5\u652f\u6301\u7684\u6d41\u6c34\u7dda\u9078\u9805\uff0c\u8acb\u53c3\u95b1 [\u6d41\u6c34\u7dda\u9078\u9805](https://cloud.google.com/dataflow/docs/reference/pipeline-options?hl=zh-cn) \u3002\n\u60a8\u9084\u53ef\u4ee5\u9593\u63a5\u4f7f\u7528\u4efb\u4f55 Apache Beam \u6d41\u6c34\u7dda\u9078\u9805\u3002\u5982\u679c\u60a8\u7232 Flex \u6a21\u677f\u4f5c\u696d\u4f7f\u7528 [metadata.json \u6587\u4ef6](#metadata) \uff0c\u8acb\u5728\u8a72\u6587\u4ef6\u4e2d\u6dfb\u52a0\u9019\u4e9b\u6d41\u6c34\u7dda\u9078\u9805\u3002\u6b64\u5143\u6578\u64da\u6587\u4ef6\u5fc5\u9808\u9075\u5faa [TemplateMetadata](https://developers.google.com/resources/api-libraries/documentation/dataflow/v1b3/java/latest/com/google/api/services/dataflow/model/TemplateMetadata.html?hl=zh-cn) \u4e2d\u7684\u683c\u5f0f\u3002\n\u5426\u5247\uff0c\u5728\u5553\u52d5 Flex \u6a21\u677f\u4f5c\u696d\u6642\uff0c\u8acb\u4f7f\u7528\u53c3\u6578\u5b57\u6bb5\u50b3\u905e\u9019\u4e9b\u6d41\u6c34\u7dda\u9078\u9805\u3002\n\u4f7f\u7528 [parameters](https://cloud.google.com/dataflow/docs/reference/rest/v1b3/projects.locations.flexTemplates/launch?hl=zh-cn#launchflextemplateparameter) \u5b57\u6bb5\u6dfb\u52a0\u6d41\u6c34\u7dda\u9078\u9805\u3002\n\u4f7f\u7528 [parameters](https://cloud.google.com/sdk/gcloud/reference/dataflow/flex-template/run?hl=zh-cn#--parameters) \u6a19\u8a8c\u6dfb\u52a0\u6d41\u6c34\u7dda\u9078\u9805\u3002\n\u50b3\u905e `List` \u6216 `Map` \u985e\u578b\u7684\u53c3\u6578\u6642\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u5728 YAML \u6587\u4ef6\u4e2d\u5b9a\u7fa9\u53c3\u6578\u4e26\u4f7f\u7528 [flags-file](https://cloud.google.com/sdk/gcloud/reference?hl=zh-cn#--flags-file) \u3002 \u5982\u9700\u67e5\u770b\u6b64\u65b9\u6cd5\u7684\u793a\u4f8b\uff0c\u8acb\u53c3\u95b1 [\u6b64\u89e3\u6c7a\u65b9\u6848\u4e2d\u7684\u201c\u5275\u5efa\u5305\u542b\u53c3\u6578\u7684\u6587\u4ef6\u201d\u6b65\u9a5f](https://cloud.google.com/architecture/building-a-vision-analytics-solution?hl=zh-cn#running_the_dataflow_pipeline_for_a_set_of_vision_features) \u3002\n\u4f7f\u7528 Flex \u6a21\u677f\u6642\uff0c\u60a8\u53ef\u4ee5\u5728\u6d41\u6c34\u7dda\u521d\u59cb\u5316\u671f\u9593\u914d\u7f6e\u90e8\u5206\u6d41\u6c34\u7dda\u9078\u9805\uff0c\u4f46\u5176\u4ed6\u6d41\u6c34\u7dda\u9078\u9805\u7121\u6cd5\u66f4\u6539\u3002 \u5982\u679c Flex \u6a21\u677f\u6240\u9700\u7684\u547d\u4ee4\u884c\u53c3\u6578\u88ab\u8986\u84cb\uff0c\u4f5c\u696d\u53ef\u80fd\u6703\u5ffd\u7565\u3001\u66ff\u63db\u6216\u6368\u68c4\u6a21\u677f\u5553\u52d5\u5668\u50b3\u905e\u7684\u6d41\u6c34\u7dda\u9078\u9805\u3002\u6b64\u5916\uff0c\u4f5c\u696d\u672c\u8eab\u53ef\u80fd\u6703\u7121\u6cd5\u5553\u52d5\uff0c\u6216\u8005\u7cfb\u7d71\u53ef\u80fd\u6703\u5553\u52d5\u672a\u4f7f\u7528 Flex \u6a21\u677f\u7684\u4f5c\u696d\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u8b80\u53d6\u4f5c\u696d\u6587\u4ef6\u5931\u6557](https://cloud.google.com/dataflow/docs/guides/troubleshoot-templates?hl=zh-cn#read-job-file) \u3002\n\u5728\u6d41\u6c34\u7dda\u521d\u59cb\u5316\u671f\u9593\uff0c\u8acb\u52ff\u66f4\u6539\u4ee5\u4e0b [\u6d41\u6c34\u7dda\u9078\u9805](https://cloud.google.com/dataflow/docs/reference/pipeline-options?hl=zh-cn) \uff1a\n- `runner`\n- `project`\n- `jobName`\n- `templateLocation`\n- `region`\n- `runner`\n- `project`\n- `job_name`\n- `template_location`\n- `region`\n- `runner`\n- `project`\n- `job_name`\n- `template_location`\n- `region`\n### \u5c4f\u853d\u4f7f\u7528\u57fa\u65bc\u5143\u6578\u64da\u7684 SSH \u5bc6\u9470\u7684\u865b\u64ec\u6a5f\u7684\u9805\u76ee SSH \u5bc6\u9470\n\u60a8\u53ef\u4ee5\u901a\u904e\u963b\u6b62\u4f86\u81ea\u865b\u64ec\u6a5f\u7684\u9805\u76ee SSH \u5bc6\u9470\uff0c\u963b\u6b62\u865b\u64ec\u6a5f\u63a5\u53d7\u5b58\u5132\u5728\u9805\u76ee\u5143\u6578\u64da\u4e2d\u7684 SSH \u5bc6\u9470\u3002 \u5c07 `additional-experiments` \u6a19\u8a8c\u8207 `block_project_ssh_keys` \u670d\u52d9\u9078\u9805\u642d\u914d\u4f7f\u7528\uff1a\n```\n--additional-experiments=block_project_ssh_keys\n```\n\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [Dataflow \u670d\u52d9\u9078\u9805](https://cloud.google.com/dataflow/docs/reference/service-options?hl=zh-cn) \u3002\n## \u5143\u6578\u64da\n\u60a8\u53ef\u4ee5\u4f7f\u7528\u9644\u52a0\u5143\u6578\u64da\u64f4\u5c55\u6a21\u677f\uff0c\u4ee5\u4fbf\u5728\u904b\u884c\u6a21\u677f\u6642\u9a57\u8b49\u81ea\u5b9a\u7fa9\u53c3\u6578\u3002\u5982\u679c\u8981\u7232\u6a21\u677f\u5275\u5efa\u5143\u6578\u64da\uff0c\u8acb\u6309\u7167\u4ee5\u4e0b\u6b65\u9a5f\u64cd\u4f5c\uff1a\n- \u4f7f\u7528 [\u5143\u6578\u64da\u53c3\u6578](#metadataparameters) \u4e2d\u7684\u53c3\u6578\u5275\u5efa`metadata.json`\u6587\u4ef6\u3002\u5982\u9700\u67e5\u770b\u793a\u4f8b\uff0c\u8acb\u53c3\u95b1 [\u793a\u4f8b\u5143\u6578\u64da\u6587\u4ef6](#example-metadata-file) \u3002\n- \u5c07\u5143\u6578\u64da\u6587\u4ef6\u5b58\u5132\u5728 Cloud Storage \u4e2d\u6a21\u677f\u6240\u5728\u7684\u6587\u4ef6\u593e\u5167\u3002\n### \u5143\u6578\u64da\u53c3\u6578| \u53c3\u6578\u9375    | Unnamed: 1 | \u5fc5\u9700 | \u503c\u7684\u8aaa\u660e                                          |\n|:--------------------|:-------------|:-------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| name    | nan   | \u662f  | \u6a21\u677f\u7684\u540d\u7a31\u3002                                         |\n| description   | nan   | \u5426  | \u5c0d\u6a21\u677f\u9032\u884c\u8aaa\u660e\u7684\u4e00\u5c0f\u6bb5\u6587\u672c\u3002                                     |\n| streaming   | nan   | \u5426  | \u5982\u679c\u7232 true\uff0c\u5247\u6b64\u6a21\u677f\u652f\u6301\u6d41\u8655\u7406\u3002\u9ed8\u8a8d\u503c\u7232 false\u3002                                |\n| supportsAtLeastOnce | nan   | \u5426  | \u5982\u679c\u7232 true\uff0c\u5247\u6b64\u6a21\u677f\u652f\u6301\u201c\u81f3\u5c11\u4e00\u6b21\u201d\u8655\u7406\u3002\u9ed8\u8a8d\u503c\u7232 false\u3002\u5982\u679c\u6a21\u677f\u8a2d\u8a08\u7232\u652f\u6301\u201c\u81f3\u5c11\u4e00\u6b21\u201d\u6d41\u8655\u7406\u6a21\u5f0f\uff0c\u8acb\u5c07\u6b64\u53c3\u6578\u8a2d\u7f6e\u7232 true\u3002              |\n| supportsExactlyOnce | nan   | \u5426  | \u5982\u679c\u7232 true\uff0c\u5247\u6b64\u6a21\u677f\u652f\u6301\u201c\u6b63\u597d\u4e00\u6b21\u201d\u8655\u7406\u3002\u9ed8\u8a8d\u503c\u7232 true\u3002                              |\n| parameters   | nan   | \u5426  | \u6a21\u677f\u4f7f\u7528\u7684\u4e00\u7d44\u9644\u52a0\u53c3\u6578\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u4f7f\u7528\u7a7a\u6578\u7d44\u3002                                |\n| parameters   | name   | \u662f  | \u6a21\u677f\u4e2d\u4f7f\u7528\u7684\u53c3\u6578\u7684\u540d\u7a31\u3002                                      |\n| parameters   | label  | \u662f  | \u4eba\u985e\u53ef\u8b80\u7684\u5b57\u7b26\u4e32\uff0c\u7528\u65bc\u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\u6a19\u8a18\u53c3\u6578\u3002                              |\n| parameters   | helpText  | \u662f  | \u5c0d\u53c3\u6578\u9032\u884c\u8aaa\u660e\u7684\u4e00\u5c0f\u6bb5\u6587\u672c\u3002                                     |\n| parameters   | isOptional | \u5426  | \u5982\u679c\u53c3\u6578\u662f\u5fc5\u9700\u7684\uff0c\u5247\u7232 false\uff1b\u5982\u679c\u53c3\u6578\u662f\u53ef\u9078\u7684\uff0c\u5247\u7232 true\u3002\u9664\u975e\u8a2d\u7f6e\u4e86\u503c\uff0c\u5426\u5247 isOptional \u9ed8\u8a8d\u7232 false\u3002 \u5982\u679c\u60a8\u6c92\u6709\u7232\u5143\u6578\u64da\u6dfb\u52a0\u6b64\u53c3\u6578\u9375\uff0c\u5247\u5143\u6578\u64da\u6703\u6210\u7232\u5fc5\u9700\u53c3\u6578\u3002    |\n| parameters   | regexes  | \u5426  | \u4e00\u7d44\u5b57\u7b26\u4e32\u5f62\u5f0f\u7684 POSIX-egrep \u6b63\u5247\u8868\u9054\u5f0f\uff08\u7528\u65bc\u9a57\u8b49\u53c3\u6578\u7684\u503c\uff09\u3002\u4f8b\u5982\uff0c[\"^[a-zA-Z][a-zA-Z0-9]+\"] \u662f\u4e00\u500b\u6b63\u5247\u8868\u9054\u5f0f\uff0c\u7528\u65bc\u9a57\u8b49\u4ee5\u5b57\u6bcd\u958b\u982d\uff0c\u4e26\u4e14\u5305\u542b\u4e00\u500b\u6216\u591a\u500b\u5b57\u7b26\u7684\u503c\u3002\u9ed8\u8a8d\u4f7f\u7528\u7a7a\u6578\u7d44\u3002 |\n### \u793a\u4f8b\u5143\u6578\u64da\u6587\u4ef6```\n{\u00a0 \"name\": \"Streaming Beam SQL\",\u00a0 \"description\": \"An Apache Beam streaming pipeline that reads JSON encoded messages from Pub/Sub, uses Beam SQL to transform the message data, and writes the results to a BigQuery\",\u00a0 \"parameters\": [\u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \"name\": \"inputSubscription\",\u00a0 \u00a0 \u00a0 \"label\": \"Pub/Sub input subscription.\",\u00a0 \u00a0 \u00a0 \"helpText\": \"Pub/Sub subscription to read from.\",\u00a0 \u00a0 \u00a0 \"regexes\": [\u00a0 \u00a0 \u00a0 \u00a0 \"[a-zA-Z][-_.~+%a-zA-Z0-9]{2,}\"\u00a0 \u00a0 \u00a0 ]\u00a0 \u00a0 },\u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \"name\": \"outputTable\",\u00a0 \u00a0 \u00a0 \"label\": \"BigQuery output table\",\u00a0 \u00a0 \u00a0 \"helpText\": \"BigQuery table spec to write to, in the form 'project:dataset.table'.\",\u00a0 \u00a0 \u00a0 \"isOptional\": true,\u00a0 \u00a0 \u00a0 \"regexes\": [\u00a0 \u00a0 \u00a0 \u00a0 \"[^:]+:[^.]+[.].+\"\u00a0 \u00a0 \u00a0 ]\u00a0 \u00a0 }\u00a0 ]}\n``````\n{\u00a0 \"name\": \"Streaming beam Python flex template\",\u00a0 \"description\": \"Streaming beam example for python flex template.\",\u00a0 \"parameters\": [\u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \"name\": \"input_subscription\",\u00a0 \u00a0 \u00a0 \"label\": \"Input PubSub subscription.\",\u00a0 \u00a0 \u00a0 \"helpText\": \"Name of the input PubSub subscription to consume from.\",\u00a0 \u00a0 \u00a0 \"regexes\": [\u00a0 \u00a0 \u00a0 \u00a0 \"projects/[^/]+/subscriptions/[a-zA-Z][-_.~+%a-zA-Z0-9]{2,}\"\u00a0 \u00a0 \u00a0 ]\u00a0 \u00a0 },\u00a0 \u00a0 {\u00a0 \u00a0 \u00a0 \"name\": \"output_table\",\u00a0 \u00a0 \u00a0 \"label\": \"BigQuery output table name.\",\u00a0 \u00a0 \u00a0 \"helpText\": \"Name of the BigQuery output table name.\",\u00a0 \u00a0 \u00a0 \"isOptional\": true,\u00a0 \u00a0 \u00a0 \"regexes\": [\u00a0 \u00a0 \u00a0 \u00a0 \"([^:]+:)?[^.]+[.].+\"\u00a0 \u00a0 \u00a0 ]\u00a0 \u00a0 }\u00a0 ]}\n```\n\u60a8\u53ef\u4ee5\u5f9e Dataflow [\u6a21\u677f\u76ee\u9304](https://console.cloud.google.com/storage/browser/dataflow-templates/latest?hl=zh-cn) \u4e0b\u8f09 Google \u63d0\u4f9b\u7684\u6a21\u677f\u7684\u5143\u6578\u64da\u6587\u4ef6\u3002\n**\u6ce8\u610f\uff1a** \u5982\u679c\u66f4\u6539 `metadata.json` \u6587\u4ef6\u4e2d\u7684\u5553\u52d5\u53c3\u6578\uff0c\u53ef\u80fd\u6703\u5c0e\u81f4\u4f5c\u696d\u5ffd\u7565\u3001\u66ff\u63db\u6216\u6368\u68c4\u6a21\u677f\u5553\u52d5\u5668\u50b3\u905e\u7684\u6d41\u6c34\u7dda\u9078\u9805\u3002\u6b64\u5916\uff0c\u4f5c\u696d\u672c\u8eab\u53ef\u80fd\u6703\u7121\u6cd5\u5553\u52d5\uff0c\u6216\u8005\u7cfb\u7d71\u53ef\u80fd\u6703\u5553\u52d5\u672a\u4f7f\u7528 Flex \u6a21\u677f\u7684\u4f5c\u696d\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u6307\u5b9a\u6d41\u6c34\u7dda\u9078\u9805](https://cloud.google.com/dataflow/docs/guides/templates/configuring-flex-templates?hl=zh-cn#specify-options) \u548c [\u8b80\u53d6\u4f5c\u696d\u6587\u4ef6\u5931\u6557](https://cloud.google.com/dataflow/docs/guides/troubleshoot-templates?hl=zh-cn#read-job-file) \u3002\n## \u77ad\u89e3\u66ab\u5b58\u4f4d\u7f6e\u548c\u81e8\u6642\u4f4d\u7f6e\nGoogle Cloud CLI \u6703\u5728\u60a8 [\u904b\u884c Flex \u6a21\u677f](https://cloud.google.com/sdk/gcloud/reference/beta/dataflow/flex-template/run?hl=zh-cn) \u6642\u63d0\u4f9b `--staging-location` \u548c `--temp-location` \u9078\u9805\u3002\u985e\u4f3c\u5730\uff0cDataflow REST API \u7232 [FlexTemplateRuntimeEnvironment](https://cloud.google.com/dataflow/docs/reference/rest/v1b3/projects.locations.flexTemplates/launch?hl=zh-cn#flextemplateruntimeenvironment) \u63d0\u4f9b\u4e86 `stagingLocation` \u548c `tempLocation` \u5b57\u6bb5\u3002\n\u5c0d\u65bc Flex \u6a21\u677f\uff0c\u66ab\u5b58\u4f4d\u7f6e\u662f\u5728\u5553\u52d5\u6a21\u677f\u7684\u66ab\u5b58\u6b65\u9a5f\u4e2d\u5c07\u6587\u4ef6\u5beb\u5165\u7684 Cloud Storage \u7db2\u5740\u3002Dataflow \u6703\u8b80\u53d6\u9019\u4e9b\u66ab\u5b58\u6587\u4ef6\u4ee5\u5275\u5efa\u6a21\u677f\u5716\u3002\u81e8\u6642\u4f4d\u7f6e\u662f\u5728\u57f7\u884c\u6b65\u9a5f\u4e2d\u5c07\u81e8\u6642\u6587\u4ef6\u5beb\u5165\u7684 Cloud Storage \u7db2\u5740\u3002\n## \u66f4\u65b0 Flex \u6a21\u677f\u4f5c\u696d\n\u4ee5\u4e0b\u793a\u4f8b\u8acb\u6c42\u5c55\u793a\u77ad\u5982\u4f55\u4f7f\u7528 [projects.locations.flexTemplates.launch](https://cloud.google.com/dataflow/docs/reference/rest/v1b3/projects.locations.flexTemplates/launch?hl=zh-cn) \u65b9\u6cd5\u66f4\u65b0\u6a21\u677f\u6d41\u8655\u7406\u4f5c\u696d\u3002\u5982\u679c\u60a8\u60f3\u4f7f\u7528 gcloud CLI\uff0c\u8acb\u53c3\u95b1 [\u66f4\u65b0\u73fe\u6709\u6d41\u6c34\u7dda](https://cloud.google.com/dataflow/docs/guides/updating-a-pipeline?hl=zh-cn) \u3002\n\u5982\u679c\u8981\u66f4\u65b0\u7d93\u5178\u6a21\u677f\uff0c\u8acb\u6539\u7528 [projects.locations.templates.launch](https://cloud.google.com/dataflow/docs/reference/rest/v1b3/projects.locations.templates/launch?hl=zh-cn) \u3002\n- \u6309\u7167\u6b65\u9a5f\u901a\u904e Flex \u6a21\u677f\u5275\u5efa\u6d41\u8655\u7406\u4f5c\u696d\u3002\u767c\u9001\u4ee5\u4e0b HTTP POST \u8acb\u6c42\uff0c\u5176\u4e2d\u5305\u542b\u4fee\u6539\u5f8c\u7684\u503c\uff1a```\nPOST https://dataflow.googleapis.com/v1b3/projects/PROJECT_ID/locations/REGION/flexTemplates:launch{\u00a0 \u00a0 \"launchParameter\": {\u00a0 \u00a0 \u00a0 \"update\": true\u00a0 \u00a0 \u00a0 \"jobName\": \"JOB_NAME\",\u00a0 \u00a0 \u00a0 \"parameters\": {\u00a0 \u00a0 \u00a0 \u00a0 \"input_subscription\": \"projects/PROJECT_ID/subscriptions/SUBSCRIPTION_NAME\",\u00a0 \u00a0 \u00a0 \u00a0 \"output_table\": \"PROJECT_ID:DATASET.TABLE_NAME\"\u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \"containerSpecGcsPath\": \"STORAGE_PATH\"\u00a0 \u00a0 },}\n```- \u5c07``\u66ff\u63db\u7232\u60a8\u7684\u9805\u76ee ID\u3002\n- \u5c07``\u66ff\u63db\u7232\u60a8\u8981\u66f4\u65b0\u7684\u4f5c\u696d\u7684 Dataflow [\u5340\u57df](https://cloud.google.com/dataflow/docs/resources/locations?hl=zh-cn) \u3002\n- \u5c07``\u66ff\u63db\u7232\u60a8\u8981\u66f4\u65b0\u7684\u4f5c\u696d\u7684\u78ba\u5207\u540d\u7a31\u3002\n- \u5c07`parameters`\u8a2d\u7f6e\u7232\u60a8\u7684\u9375\u503c\u5c0d\u5217\u8868\u3002\u5217\u51fa\u7684\u53c3\u6578\u7279\u5b9a\u65bc\u6b64\u6a21\u677f\u793a\u4f8b\u3002\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f\u81ea\u5b9a\u7fa9\u6a21\u677f\uff0c\u8acb\u6839\u64da\u9700\u8981\u4fee\u6539\u53c3\u6578\u3002\u5982\u679c\u60a8\u4f7f\u7528\u7684\u662f\u793a\u4f8b\u6a21\u677f\uff0c\u8acb\u66ff\u63db\u4ee5\u4e0b\u8b8a\u91cf\u3002- \u5c07``\u66ff\u63db\u7232\u60a8\u7684 Pub/Sub \u8a02\u95b1\u540d\u7a31\u3002\n- \u5c07``\u66ff\u63db\u7232\u60a8\u7684 BigQuery \u6578\u64da\u96c6\u540d\u7a31\u3002\n- \u5c07``\u66ff\u63db\u7232 BigQuery \u8868\u540d\u7a31\u3002\n- \u5c07``\u66ff\u63db\u7232\u6a21\u677f\u6587\u4ef6\u7684 Cloud Storage \u4f4d\u7f6e\u3002\u8a72\u4f4d\u7f6e\u61c9\u4ee5`gs://`\u958b\u982d\u3002\n- \u4f7f\u7528 `environment` \u53c3\u6578\u66f4\u6539\u74b0\u5883\u8a2d\u7f6e\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [FlexTemplateRuntimeEnvironment](https://cloud.google.com/dataflow/docs/reference/rest/v1b3/projects.locations.flexTemplates/launch?hl=zh-cn#FlexTemplateRuntimeEnvironment) \u3002\n- \u53ef\u9078\uff1a\u5982\u9700\u4f7f\u7528 curl\uff08Linux\u3001macOS \u6216 Cloud Shell\uff09\u767c\u9001\u8acb\u6c42\uff0c\u5c07\u8acb\u6c42\u4fdd\u5b58\u5230 JSON \u6587\u4ef6\uff0c\u7136\u5f8c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ncurl -X POST -d \"@FILE_PATH\" -H \"Content-Type: application/json\" -H \"Authorization: Bearer $(gcloud auth print-access-token)\" \u00a0https://dataflow.googleapis.com/v1b3/projects/PROJECT_ID/locations/REGION/flexTemplates:launch\n```\u5c07 \u66ff\u63db\u7232\u5305\u542b\u8acb\u6c42\u6b63\u6587\u7684 JSON \u6587\u4ef6\u7684\u8def\u5f91\u3002\n- \u4f7f\u7528 [Dataflow \u76e3\u63a7\u754c\u9762](https://cloud.google.com/dataflow/docs/guides/monitoring-overview?hl=zh-cn#access-monitoring-interface) \u9a57\u8b49\u5df2\u5275\u5efa\u4e86\u5177\u6709\u76f8\u540c\u540d\u7a31\u7684\u65b0\u4f5c\u696d\u3002\u6b64\u4f5c\u696d\u7684\u72c0\u614b\u7232 **\u5df2\u66f4\u65b0** \u3002## \u9650\u5236\n\u4ee5\u4e0b\u9650\u5236\u9069\u7528\u65bc Flex \u6a21\u677f\u4f5c\u696d\uff1a\n- \u60a8\u5fc5\u9808\u4f7f\u7528 Google \u63d0\u4f9b\u7684\u57fa\u790e\u6620\u50cf\u4f86\u4f7f\u7528 Docker \u6253\u5305\u5bb9\u5668\u3002 \u5982\u9700\u67e5\u770b\u9069\u7528\u6620\u50cf\u7684\u5217\u8868\uff0c\u8acb\u53c3\u95b1 [Flex \u6a21\u677f\u57fa\u790e\u6620\u50cf](https://cloud.google.com/dataflow/docs/reference/flex-templates-base-images?hl=zh-cn) \u3002\n- \u5fc5\u9808\u5728\u8abf\u7528`run`\u5f8c\u9000\u51fa\u7528\u65bc\u69cb\u5efa\u6d41\u6c34\u7dda\u7684\u7a0b\u5e8f\uff0c\u6d41\u6c34\u7dda\u624d\u80fd\u5553\u52d5\u3002\n- \u4e0d\u652f\u6301`waitUntilFinish`(Java) \u548c`wait_until_finish`(Python)\u3002## \u5f8c\u7e8c\u6b65\u9a5f\n- \u5982\u9700\u8a73\u7d30\u77ad\u89e3\u7d93\u5178\u6a21\u677f\u548c Flex \u6a21\u677f\u53ca\u5176\u7528\u4f8b\u5834\u666f\uff0c\u8acb\u53c3\u95b1 [Dataflow \u6a21\u677f](https://cloud.google.com/dataflow/docs/concepts/dataflow-templates?hl=zh-cn) \u3002\n- \u5982\u9700\u77ad\u89e3 Flex \u6a21\u677f\u554f\u984c\u6392\u67e5\u76f8\u95dc\u7684\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 [\u6392\u67e5 Flex \u6a21\u677f\u8d85\u6642\u554f\u984c](https://cloud.google.com/dataflow/docs/guides/troubleshoot-templates?hl=zh-cn) \u3002\n- \u5982\u9700\u67e5\u770b\u66f4\u591a\u53c3\u8003\u67b6\u69cb\u3001\u5716\u8868\u548c\u6700\u4f73\u5be6\u8e10\uff0c\u8acb\u700f\u89bd [\u96f2\u67b6\u69cb\u4e2d\u5fc3](https://cloud.google.com/architecture?hl=zh-cn) \u3002", "guide": "Dataflow"}