{"title": "Dataflow - \u5c07\u81ea\u5b9a\u7fa9\u5bb9\u5668\u8207 C++ \u5eab\u642d\u914d\u4f7f\u7528", "url": "https://cloud.google.com/dataflow/docs/hpc-ep/hpc-tutorial?hl=zh-cn", "abstract": "# Dataflow - \u5c07\u81ea\u5b9a\u7fa9\u5bb9\u5668\u8207 C++ \u5eab\u642d\u914d\u4f7f\u7528\n\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u5275\u5efa\u4e00\u500b\u6d41\u6c34\u7dda\uff0c\u8a72\u6d41\u6c34\u7dda\u4f7f\u7528\u81ea\u5b9a\u7fa9\u5bb9\u5668\u548c C++ \u5eab\u4f86\u904b\u884c Dataflow HPC \u9ad8\u4e26\u884c\u5de5\u4f5c\u6d41\u3002\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u77ad\u89e3\u5982\u4f55\u4f7f\u7528 Dataflow \u548c Apache Beam \u904b\u884c\u7db2\u683c\u8a08\u7b97\u61c9\u7528\uff0c\u9019\u4e9b\u61c9\u7528\u9700\u8981\u5c07\u6578\u64da\u5206\u4f48\u5230\u5728\u8a31\u591a\u6838\u5fc3\u4e0a\u904b\u884c\u7684\u51fd\u6578\u3002\n\u672c\u6559\u7a0b\u4f9d\u6b21\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528 [\u76f4\u63a5\u904b\u884c\u7a0b\u5e8f](https://beam.apache.org/documentation/runners/direct/) \u548c\u4f7f\u7528 [Dataflow \u904b\u884c\u7a0b\u5e8f](https://beam.apache.org/documentation/runners/dataflow/) \u904b\u884c\u6d41\u6c34\u7dda\u3002 \u901a\u904e\u5728\u672c\u5730\u904b\u884c\u6d41\u6c34\u7dda\uff0c\u60a8\u53ef\u4ee5\u5728\u90e8\u7f72\u6d41\u6c34\u7dda\u4e4b\u524d\u5c0d\u5176\u9032\u884c\u6e2c\u8a66\u3002\n\u6b64\u793a\u4f8b\u4f7f\u7528 [GMP \u5eab](https://gmplib.org/) \u4e2d\u7684 [Cython](https://cython.org/) \u7d81\u5b9a\u548c\u51fd\u6578\u3002 \u7121\u8ad6\u60a8\u4f7f\u7528\u54ea\u500b\u5eab\u6216\u7d81\u5b9a\u5de5\u5177\uff0c\u60a8\u90fd\u53ef\u4ee5\u5c0d\u6d41\u6c34\u7dda\u61c9\u7528\u76f8\u540c\u7684\u539f\u5247\u3002\n\u60a8 [\u53ef\u4ee5\u5728 GitHub \u4e0a](https://github.com/GoogleCloudPlatform/dataflow-sample-applications/tree/master/beam-cpp-example) \u627e\u5230\u793a\u4f8b\u4ee3\u78bc\u3002", "content": "## \u76ee\u6a19\n- \u5275\u5efa\u4f7f\u7528\u81ea\u5b9a\u7fa9\u5bb9\u5668\u548c C++ \u5eab\u7684\u6d41\u6c34\u7dda\u3002\n- \u4f7f\u7528 Dockerfile \u69cb\u5efa Docker \u5bb9\u5668\u6620\u50cf\u3002\n- \u5c07\u4ee3\u78bc\u548c\u4f9d\u8cf4\u9805\u6253\u5305\u5230 Docker \u5bb9\u5668\u4e2d\u3002\n- \u5728\u672c\u5730\u904b\u884c\u6d41\u6c34\u7dda\u4ee5\u9032\u884c\u6e2c\u8a66\u3002\n- \u5728\u5206\u4f48\u5f0f\u74b0\u5883\u4e2d\u904b\u884c\u6d41\u6c34\u7dda\u3002\n## \u8cbb\u7528\nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5728\u672c\u6587\u6a94\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Google Cloud \u7684\u4ee5\u4e0b\u6536\u8cbb\u7d44\u4ef6\uff1a- Artifact Registry\n- Cloud Build\n- Cloud Storage\n- Compute Engine\n- Dataflow\n\u60a8\u53ef\u4f7f\u7528 [\u50f9\u683c\u8a08\u7b97\u5668](https://cloud.google.com/products/calculator?hl=zh-cn) \u6839\u64da\u60a8\u7684\u9810\u8a08\u4f7f\u7528\u60c5\u6cc1\u4f86\u4f30\u7b97\u8cbb\u7528\u3002 \nTitles in dynamic includes are not used anywhere, and we should avoid paying to translate them\u5b8c\u6210\u672c\u6587\u6a94\u4e2d\u63cf\u8ff0\u7684\u4efb\u52d9\u5f8c\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u522a\u9664\u6240\u5275\u5efa\u7684\u8cc7\u6e90\u4f86\u907f\u514d\u7e7c\u7e8c\u8a08\u8cbb\u3002\u5982\u9700\u77ad\u89e3\u8a73\u60c5\uff0c\u8acb\u53c3\u95b1 [\u6e05\u7406](#clean-up) \u3002## \u6e96\u5099\u5de5\u4f5c\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- \u7232\u65b0\u6d41\u6c34\u7dda\u5275\u5efa\u7528\u6236\u7ba1\u7406\u7684\u5de5\u4f5c\u5668\u670d\u52d9\u8cec\u865f\uff0c\u4e26\u5411\u670d\u52d9\u8cec\u865f\u6388\u4e88\u5fc5\u8981\u7684\u89d2\u8272\u3002- \u5982\u9700\u5275\u5efa\u670d\u52d9\u8cec\u865f\uff0c\u8acb\u904b\u884c [gcloud iam service-accounts create](https://cloud.google.com/sdk/gcloud/reference/iam/service-accounts/create?hl=zh-cn) \u547d\u4ee4\u3002```\ngcloud iam service-accounts create parallelpipeline \\\u00a0 \u00a0 --description=\"Highly parallel pipeline worker service account\" \\\u00a0 \u00a0 --display-name=\"Highly parallel data pipeline access\"\n```\n- \u5411\u670d\u52d9\u8cec\u865f\u6388\u4e88\u89d2\u8272\u3002\u5c0d\u4ee5\u4e0b\u6bcf\u500b IAM \u89d2\u8272\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4e00\u6b21\uff1a- `roles/dataflow.admin`\n- `roles/dataflow.worker`\n- `roles/storage.objectAdmin`\n- `roles/artifactregistry.reader`\n```\ngcloud projects add-iam-policy-binding PROJECT_ID --member=\"serviceAccount:parallelpipeline@PROJECT_ID.iam.gserviceaccount.com\" --role=SERVICE_ACCOUNT_ROLE\n```\u5c07 `` \u66ff\u63db\u7232\u6bcf\u500b\u89d2\u8272\u3002\n- \u7232\u60a8\u7684 Google \u8cec\u865f\u6388\u4e88\u4e00\u500b\u53ef\u8b93\u60a8\u7232\u670d\u52d9\u8cec\u865f\u5275\u5efa\u8a2a\u554f\u4ee4\u724c\u7684\u89d2\u8272\uff1a```\ngcloud iam service-accounts add-iam-policy-binding parallelpipeline@PROJECT_ID.iam.gserviceaccount.com --member=\"user:EMAIL_ADDRESS\" --role=roles/iam.serviceAccountTokenCreator\n```## \u4e0b\u8f09\u4ee3\u78bc\u793a\u4f8b\u4e26\u66f4\u6539\u76ee\u9304\u4e0b\u8f09\u4ee3\u78bc\u793a\u4f8b\uff0c\u7136\u5f8c\u66f4\u6539\u76ee\u9304\u3002 GitHub \u4ee3\u78bc\u5eab\u4e2d\u7684\u4ee3\u78bc\u793a\u4f8b\u63d0\u4f9b\u4e86\u904b\u884c\u6b64\u6d41\u6c34\u7dda\u6240\u9700\u7684\u6240\u6709\u4ee3\u78bc\u3002\u7576\u60a8\u6e96\u5099\u597d\u69cb\u5efa\u81ea\u5df1\u7684\u6d41\u6c34\u7dda\u6642\uff0c\u53ef\u4ee5\u4f7f\u7528\u6b64\u793a\u4f8b\u4ee3\u78bc\u4f5c\u7232\u6a21\u677f\u3002\n\u514b\u9686 [beam-cp-example \u4ee3\u78bc\u5eab](https://github.com/GoogleCloudPlatform/dataflow-sample-applications/tree/master/beam-cpp-example) \u3002- \u4f7f\u7528 `git clone` \u547d\u4ee4\u514b\u9686 GitHub \u4ee3\u78bc\u5eab\uff1a```\ngit clone https://github.com/GoogleCloudPlatform/dataflow-sample-applications.git\n```\n- \u5207\u63db\u5230\u61c9\u7528\u76ee\u9304\uff1a```\ncd dataflow-sample-applications/beam-cpp-example\n```\n### \u6d41\u6c34\u7dda\u4ee3\u78bc\u60a8\u53ef\u4ee5\u81ea\u5b9a\u7fa9\u672c\u6559\u7a0b\u4e2d\u7684\u6d41\u6c34\u7dda\u4ee3\u78bc\u3002\u6b64\u6d41\u6c34\u7dda\u5b8c\u6210\u4e86\u4ee5\u4e0b\u4efb\u52d9\uff1a- \u52d5\u614b\u751f\u6210\u8f38\u5165\u7bc4\u570d\u5167\u7684\u6240\u6709\u6574\u6578\u3002\n- \u901a\u904e C++ \u51fd\u6578\u904b\u884c\u6574\u6578\u4e26\u904e\u6ffe\u7121\u6548\u503c\u3002\n- \u5c07\u7121\u6548\u503c\u5beb\u5165\u8f14\u52a9\u901a\u9053\u3002\n- \u8a08\u7b97\u6bcf\u500b\u505c\u6b62\u6642\u9593\u7684\u51fa\u73fe\u6b21\u6578\u4e26\u5c0d\u7d50\u679c\u9032\u884c\u6b78\u4e00\u5316\u3002\n- \u8f38\u51fa\u7d50\u679c\u3001\u8a2d\u7f6e\u7d50\u679c\u683c\u5f0f\u4e26\u5c07\u5176\u5beb\u5165\u6587\u672c\u6587\u4ef6\u3002\n- \u5275\u5efa\u5305\u542b\u4e00\u500b\u5143\u7d20\u7684`PCollection`\u3002\n- \u4f7f\u7528`map`\u51fd\u6578\u8655\u7406\u55ae\u500b\u5143\u7d20\uff0c\u4e26\u5c07\u983b\u7387`PCollection`\u4f5c\u7232\u8f14\u52a9\u8f38\u5165\u50b3\u905e\u3002\n- \u8655\u7406`PCollection`\u4e26\u751f\u6210\u55ae\u500b\u8f38\u51fa\u3002\n\u8d77\u59cb\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/dataflow-sample-applications/blob/HEAD/beam-cpp-example/pipeline.py) \n```\n## Licensed to the Apache Software Foundation (ASF) under one or more# contributor license agreements. \u00a0See the NOTICE file distributed with# this work for additional information regarding copyright ownership.# The ASF licenses this file to You under the Apache License, Version 2.0# (the \"License\"); you may not use this file except in compliance with# the License. \u00a0You may obtain a copy of the License at\n## \u00a0 \u00a0http://www.apache.org/licenses/LICENSE-2.0\n## Unless required by applicable law or agreed to in writing, software# distributed under the License is distributed on an \"AS IS\" BASIS,# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.# See the License for the specific language governing permissions and# limitations under the License.#import argparseimport loggingimport osimport sysdef run(argv):\u00a0 # Import here to avoid __main__ session pickling issues.\u00a0 import io\u00a0 import itertools\u00a0 import matplotlib.pyplot as plt\u00a0 import collatz\u00a0 import apache_beam as beam\u00a0 from apache_beam.io import restriction_trackers\u00a0 from apache_beam.options.pipeline_options import PipelineOptions\u00a0 class RangeSdf(beam.DoFn, beam.RestrictionProvider):\u00a0 \u00a0 \"\"\"An SDF producing all the integers in the input range.\u00a0 \u00a0 This is preferable to beam.Create(range(...)) as it produces the integers\u00a0 \u00a0 dynamically rather than materializing them up front. \u00a0It is an SDF to do\u00a0 \u00a0 so with perfect dynamic sharding.\u00a0 \u00a0 \"\"\"\u00a0 \u00a0 def initial_restriction(self, desired_range):\u00a0 \u00a0 \u00a0 start, stop = desired_range\u00a0 \u00a0 \u00a0 return restriction_trackers.OffsetRange(start, stop)\u00a0 \u00a0 def restriction_size(self, _, restriction):\u00a0 \u00a0 \u00a0 return restriction.size()\u00a0 \u00a0 def create_tracker(self, restriction):\u00a0 \u00a0 \u00a0 return restriction_trackers.OffsetRestrictionTracker(restriction)\u00a0 \u00a0 def process(self, _, active_range=beam.DoFn.RestrictionParam()):\u00a0 \u00a0 \u00a0 for i in itertools.count(active_range.current_restriction().start):\u00a0 \u00a0 \u00a0 \u00a0 if active_range.try_claim(i):\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 yield i\u00a0 \u00a0 \u00a0 \u00a0 else:\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 break\u00a0 class GenerateIntegers(beam.PTransform):\u00a0 \u00a0 def __init__(self, start, stop):\u00a0 \u00a0 \u00a0 self._start = start\u00a0 \u00a0 \u00a0 self._stop = stop\u00a0 \u00a0 def expand(self, p):\u00a0 \u00a0 \u00a0 return (\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 p\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 | beam.Create([(self._start, self._stop + 1)])\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 | beam.ParDo(RangeSdf()))\u00a0 parser = argparse.ArgumentParser()\u00a0 parser.add_argument('--start', dest='start', type=int, default=1)\u00a0 parser.add_argument('--stop', dest='stop', type=int, default=10000)\u00a0 parser.add_argument('--output', default='./out.png')\u00a0 known_args, pipeline_args = parser.parse_known_args(argv)\u00a0 # Store this as a local to avoid capturing the full known_args.\u00a0 output_path = known_args.output\u00a0 with beam.Pipeline(options=PipelineOptions(pipeline_args)) as p:\u00a0 \u00a0 # Generate the integers from start to stop (inclusive).\u00a0 \u00a0 integers = p | GenerateIntegers(known_args.start, known_args.stop)\u00a0 \u00a0 # Run them through our C++ function, filtering bad records.\u00a0 \u00a0 # Requires apache beam 2.34 or later.\u00a0 \u00a0 stopping_times, bad_values = (\u00a0 \u00a0 \u00a0 \u00a0 integers\u00a0 \u00a0 \u00a0 \u00a0 | beam.Map(collatz.total_stopping_time).with_exception_handling(\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 use_subprocess=True))\u00a0 \u00a0 # Write the bad values to a side channel.\u00a0 \u00a0 bad_values | 'WriteBadValues' >> beam.io.WriteToText(\u00a0 \u00a0 \u00a0 \u00a0 os.path.splitext(output_path)[0] + '-bad.txt')\u00a0 \u00a0 # Count the occurrence of each stopping time and normalize.\u00a0 \u00a0 total = known_args.stop - known_args.start + 1\u00a0 \u00a0 frequencies = (\u00a0 \u00a0 \u00a0 \u00a0 stopping_times\u00a0 \u00a0 \u00a0 \u00a0 | 'Aggregate' >> (beam.Map(lambda x: (x, 1)) | beam.CombinePerKey(sum))\u00a0 \u00a0 \u00a0 \u00a0 | 'Normalize' >> beam.MapTuple(lambda x, count: (x, count / total)))\u00a0 \u00a0 if known_args.stop <= 10:\u00a0 \u00a0 \u00a0 # Print out the results for debugging.\u00a0 \u00a0 \u00a0 frequencies | beam.Map(print)\u00a0 \u00a0 else:\u00a0 \u00a0 \u00a0 # Format and write them to a text file.\u00a0 \u00a0 \u00a0 (\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 frequencies\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 | 'Format' >> beam.MapTuple(lambda count, freq: f'{count}, {freq}')\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 | beam.io.WriteToText(os.path.splitext(output_path)[0] + '.txt'))\u00a0 \u00a0 # Define some helper functions.\u00a0 \u00a0 def make_scatter_plot(xy):\u00a0 \u00a0 \u00a0 x, y = zip(*xy)\u00a0 \u00a0 \u00a0 plt.plot(x, y, '.')\u00a0 \u00a0 \u00a0 png_bytes = io.BytesIO()\u00a0 \u00a0 \u00a0 plt.savefig(png_bytes, format='png')\u00a0 \u00a0 \u00a0 png_bytes.seek(0)\u00a0 \u00a0 \u00a0 return png_bytes.read()\u00a0 \u00a0 def write_to_path(path, content):\u00a0 \u00a0 \u00a0 \"\"\"Most Beam IOs write multiple elements to some kind of a container\u00a0 \u00a0 \u00a0 file (e.g. strings to lines of a text file, avro records to an avro file,\u00a0 \u00a0 \u00a0 etc.) \u00a0This function writes each element to its own file, given by path.\u00a0 \u00a0 \u00a0 \"\"\"\u00a0 \u00a0 \u00a0 # Write to a temporary path and to a rename for fault tolerence.\u00a0 \u00a0 \u00a0 tmp_path = path + '.tmp'\u00a0 \u00a0 \u00a0 fs = beam.io.filesystems.FileSystems.get_filesystem(path)\u00a0 \u00a0 \u00a0 with fs.create(tmp_path) as fout:\u00a0 \u00a0 \u00a0 \u00a0 fout.write(content)\u00a0 \u00a0 \u00a0 fs.rename([tmp_path], [path])\u00a0 \u00a0 (\u00a0 \u00a0 \u00a0 \u00a0 p\u00a0 \u00a0 \u00a0 \u00a0 # Create a PCollection with a single element.\u00a0 \u00a0 \u00a0 \u00a0 | 'CreateSingleton' >> beam.Create([None])\u00a0 \u00a0 \u00a0 \u00a0 # Process the single element with a Map function, passing the frequency\u00a0 \u00a0 \u00a0 \u00a0 # PCollection as a side input.\u00a0 \u00a0 \u00a0 \u00a0 # This will cause the normally distributed frequency PCollection to be\u00a0 \u00a0 \u00a0 \u00a0 # colocated and processed as a single unit, producing a single output.\u00a0 \u00a0 \u00a0 \u00a0 | 'MakePlot' >> beam.Map(\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 lambda _,\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 data: make_scatter_plot(data),\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 data=beam.pvalue.AsList(frequencies))\u00a0 \u00a0 \u00a0 \u00a0 # Pair this with the desired filename.\u00a0 \u00a0 \u00a0 \u00a0 |\u00a0 \u00a0 \u00a0 \u00a0 'PairWithFilename' >> beam.Map(lambda content: (output_path, content))\u00a0 \u00a0 \u00a0 \u00a0 # And actually write it out, using MapTuple to split the tuple into args.\u00a0 \u00a0 \u00a0 \u00a0 | 'WriteToOutput' >> beam.MapTuple(write_to_path))if __name__ == '__main__':\u00a0 logging.getLogger().setLevel(logging.INFO)\u00a0 run(sys.argv)\n```## \u8a2d\u7f6e\u958b\u767c\u74b0\u5883\n- \u4f7f\u7528 Python \u7248 [Apache Beam SDK](https://cloud.google.com/dataflow/docs/guides/installing-beam-sdk?hl=zh-cn#python) \u3002\n- \u5b89\u88dd GMP \u5eab\uff1a```\napt-get install libgmp3-dev\n```\n- \u5982\u9700\u5b89\u88dd\u4f9d\u8cf4\u9805\uff0c\u8acb\u4f7f\u7528 `requirements.txt` \u6587\u4ef6\u3002```\npip install -r requirements.txt\n```\n- \u5982\u9700\u69cb\u5efa Python \u7d81\u5b9a\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u3002```\npython setup.py build_ext --inplace\n```\n\u60a8\u53ef\u4ee5\u5728\u672c\u6559\u7a0b\u4e2d\u81ea\u5b9a\u7fa9 `requirements.txt` \u6587\u4ef6\u3002\u8d77\u59cb\u6587\u4ef6\u5305\u542b\u4ee5\u4e0b\u4f9d\u8cf4\u9805\uff1a\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/dataflow-sample-applications/blob/HEAD/beam-cpp-example/requirements.txt) \n```\n## \u00a0 \u00a0Licensed to the Apache Software Foundation (ASF) under one or more# \u00a0 \u00a0contributor license agreements. \u00a0See the NOTICE file distributed with# \u00a0 \u00a0this work for additional information regarding copyright ownership.# \u00a0 \u00a0The ASF licenses this file to You under the Apache License, Version 2.0# \u00a0 \u00a0(the \"License\"); you may not use this file except in compliance with# \u00a0 \u00a0the License. \u00a0You may obtain a copy of the License at\n## \u00a0 \u00a0 \u00a0 http://www.apache.org/licenses/LICENSE-2.0\n## \u00a0 \u00a0Unless required by applicable law or agreed to in writing, software# \u00a0 \u00a0distributed under the License is distributed on an \"AS IS\" BASIS,# \u00a0 \u00a0WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.# \u00a0 \u00a0See the License for the specific language governing permissions and# \u00a0 \u00a0limitations under the License.#apache-beam[gcp]==2.46.0cython==0.29.24pyparsing==2.4.2matplotlib==3.4.3\n```## \u5728\u672c\u5730\u904b\u884c\u6d41\u6c34\u7dda\u5728\u672c\u5730\u904b\u884c\u6d41\u6c34\u7dda\u5c0d\u65bc\u6e2c\u8a66\u975e\u5e38\u6709\u7528\u3002\u901a\u904e\u5728\u672c\u5730\u904b\u884c\u6d41\u6c34\u7dda\uff0c\u60a8\u53ef\u4ee5\u5728\u5c07\u6d41\u6c34\u7dda\u90e8\u7f72\u5230\u5206\u4f48\u5f0f\u74b0\u5883\u4e4b\u524d\u78ba\u8a8d\u8a72\u6d41\u6c34\u7dda\u6309\u9810\u671f\u904b\u884c\u548c\u5de5\u4f5c\u3002\n\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5728\u672c\u5730\u904b\u884c\u6d41\u6c34\u7dda\u3002 \u6b64\u547d\u4ee4\u6703\u8f38\u51fa\u540d\u7232 `out.png` \u7684\u6620\u50cf\u3002\n```\npython pipeline.py\n```## \u5275\u5efa Google Cloud \u8cc7\u6e90\u672c\u90e8\u5206\u4ecb\u7d39\u5982\u4f55\u5275\u5efa\u4ee5\u4e0b\u8cc7\u6e90\uff1a- \u7528\u4f5c\u81e8\u6642\u5b58\u5132\u4f4d\u7f6e\u548c\u8f38\u51fa\u4f4d\u7f6e\u7684 Cloud Storage \u5b58\u5132\u6876\u3002\n- \u7528\u65bc\u6253\u5305\u6d41\u6c34\u7dda\u4ee3\u78bc\u548c\u4f9d\u8cf4\u9805\u7684 Docker \u5bb9\u5668\u3002\n### \u5275\u5efa Cloud Storage \u5b58\u5132\u6876\u9996\u5148\u4f7f\u7528 Google Cloud CLI \u5275\u5efa Cloud Storage \u5b58\u5132\u6876\u3002\u6b64\u5b58\u5132\u6876\u7531 Dataflow \u6d41\u6c34\u7dda\u7528\u4f5c\u81e8\u6642\u5b58\u5132\u4f4d\u7f6e\u3002\n\u5982\u9700\u5275\u5efa\u5b58\u5132\u6876\uff0c\u8acb\u4f7f\u7528 [gcloud storage buckets create \u547d\u4ee4](https://cloud.google.com/sdk/gcloud/reference/storage/buckets/create?hl=zh-cn) \uff1a\n```\ngcloud storage buckets create gs://BUCKET_NAME --location=LOCATION\n```\n\u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a- \uff1a\u7b26\u5408 [\u5b58\u5132\u6876\u547d\u540d\u8981\u6c42](https://cloud.google.com/storage/docs/buckets?hl=zh-cn#naming) \u7684 Cloud Storage \u5b58\u5132\u6876\u7684\u540d\u7a31\u3002Cloud Storage \u5b58\u5132\u6876\u540d\u7a31\u5fc5\u9808\u662f\u5168\u5c40\u552f\u4e00\u7684\u3002\n- \uff1a\u5b58\u5132\u6876\u7684 [\u4f4d\u7f6e](https://cloud.google.com/storage/docs/locations?hl=zh-cn#available-locations) \u3002\n### \u5275\u5efa\u548c\u69cb\u5efa\u5bb9\u5668\u6620\u50cf\u60a8\u53ef\u4ee5\u5728\u672c\u6559\u7a0b\u4e2d\u81ea\u5b9a\u7fa9 Dockerfile\u3002 \u8d77\u59cb\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a\n **\u6ce8\u610f\uff1a** \u5728\u5206\u4f48\u5f0f\u74b0\u5883\u4e2d\u904b\u884c\u6d41\u6c34\u7dda\u6642\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u66f4\u65b0 Dockerfile \u4e2d\u7684 Python \u7248\u672c\u3002\u4f7f\u7528\u81ea\u5b9a\u7fa9\u5bb9\u5668\u6620\u50cf\u6642\uff0c\u6620\u50cf\u4e2d\u7684 Python \u89e3\u91cb\u5668\u6b21\u8981\u7248\u672c\u5fc5\u9808\u8207\u6d41\u6c34\u7dda\u69cb\u5efa\u6642\u4f7f\u7528\u7684\u7248\u672c\u5339\u914d\u3002\n [\u5728 GitHub \u4e0a\u67e5\u770b](https://github.com/GoogleCloudPlatform/dataflow-sample-applications/blob/HEAD/beam-cpp-example/Dockerfile) \n```\nFROM apache/beam_python3.9_sdk:2.46.0# Install a C++ library.RUN apt-get updateRUN apt-get install -y libgmp3-dev# Install Python dependencies.COPY requirements.txt requirements.txtRUN pip install -r requirements.txt# Install the code and some python bindings.COPY pipeline.py pipeline.pyCOPY collatz.pyx collatz.pyxCOPY setup.py setup.pyRUN python setup.py install\n```\n\u6b64 Dockerfile \u5305\u542b `FROM` \u3001 `COPY` \u548c `RUN` \u547d\u4ee4\uff0c\u60a8\u53ef\u4ee5\u5728 [Dockerfile \u53c3\u8003](https://docs.docker.com/engine/reference/builder/) \u4e2d\u95b1\u8b80\u76f8\u95dc\u4fe1\u606f\u3002- \u5982\u9700\u4e0a\u50b3\u5de5\u4ef6\uff0c\u8acb\u5275\u5efa\u4e00\u500b Artifact Registry \u4ee3\u78bc\u5eab\u3002\u6bcf\u500b\u4ee3\u78bc\u5eab\u53ef\u4ee5\u5305\u542b\u4e00\u7a2e\u53d7\u652f\u6301\u683c\u5f0f\u7684\u5de5\u4ef6\u3002\u6240\u6709\u4ee3\u78bc\u5eab\u5167\u5bb9\u90fd\u5df2\u4f7f\u7528 Google \u7ba1\u7406\u7684\u52a0\u5bc6\u5bc6\u9470\u6216\u5ba2\u6236\u7ba1\u7406\u7684\u52a0\u5bc6\u5bc6\u9470\u9032\u884c\u52a0\u5bc6\u3002Artifact Registry \u9ed8\u8a8d\u4f7f\u7528 Google \u7ba1\u7406\u7684\u52a0\u5bc6\u5bc6\u9470\uff0c\u6b64\u9078\u9805\u7121\u9700\u9032\u884c\u4efb\u4f55\u914d\u7f6e\u3002\u60a8\u5fc5\u9808\u81f3\u5c11\u5177\u6709\u4ee3\u78bc\u5eab\u7684 [Artifact Registry Writer \u6b0a\u9650](https://cloud.google.com/artifact-registry/docs/access-control?hl=zh-cn#permissions) \u3002\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u5275\u5efa\u65b0\u4ee3\u78bc\u5eab\u3002\u8a72\u547d\u4ee4\u4f7f\u7528 `--async` \u6a19\u8a8c\u4e26\u7acb\u5373\u8fd4\u56de\uff0c\u7121\u9700\u7b49\u5f85\u6b63\u5728\u9032\u884c\u7684\u64cd\u4f5c\u5b8c\u6210\u3002```\ngcloud artifacts repositories create REPOSITORY \\\u00a0 \u00a0--repository-format=docker \\\u00a0 \u00a0--location=LOCATION \\\u00a0 \u00a0--async\n```\u5c07 `` \u66ff\u63db\u7232\u60a8\u7684\u4ee3\u78bc\u5eab\u7684\u540d\u7a31\u3002\u5c0d\u65bc\u9805\u76ee\u4e2d\u7684\u6bcf\u500b\u4ee3\u78bc\u5eab\u4f4d\u7f6e\uff0c\u4ee3\u78bc\u5eab\u540d\u7a31\u4e0d\u5f97\u91cd\u8907\u3002\n- \u5275\u5efa Dockerfile\u3002\u5982\u679c\u8981\u4f7f\u8edf\u4ef6\u5305\u6210\u7232 Beam \u5bb9\u5668\u7684\u4e00\u90e8\u5206\uff0c\u60a8\u5fc5\u9808\u5728 `requirements.txt` \u6587\u4ef6\u4e2d\u6307\u5b9a\u9019\u4e9b\u8edf\u4ef6\u5305\u3002\u5207\u52ff\u5728 `requirements.txt` \u6587\u4ef6\u4e2d\u6307\u5b9a `apache-beam` \u3002Apache Beam \u5bb9\u5668\u5df2\u7d93\u6709 `apache-beam` \u3002 **\u6ce8\u610f\uff1a** \u4f7f\u7528 Dockerfile \u5b89\u88dd\u7684\u4f9d\u8cf4\u9805\u50c5\u5728\u5553\u52d5\u6d41\u6c34\u7dda\u6642\u53ef\u7528\u3002\u4f5c\u696d\u4f9d\u8cf4\u9805\u5fc5\u9808\u5305\u542b\u5728\u9700\u6c42\u6587\u4ef6\u4e2d\u3002\u5982\u793a\u4f8b\u6240\u793a\uff0cApache Beam \u4e0d\u9700\u8981\u5728\u6b64\u6587\u4ef6\u4e2d\uff0c\u6211\u5011\u5efa\u8b70\u5c07\u5176\u5206\u958b\u4ee5\u52a0\u5feb\u5553\u52d5\u901f\u5ea6\u3002\n- \u8acb\u5148\u914d\u7f6e Docker \u4ee5\u5c0d Artifact Registry \u7684\u8acb\u6c42\u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u7136\u5f8c\u518d\u63a8\u9001\u6216\u62c9\u53d6\u6620\u50cf\u3002\u5982\u9700\u7232 Docker \u4ee3\u78bc\u5eab\u8a2d\u7f6e\u8eab\u4efd\u9a57\u8b49\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a```\ngcloud auth configure-docker LOCATION-docker.pkg.dev\n```\u8a72\u547d\u4ee4\u5c07\u66f4\u65b0\u60a8\u7684 Docker \u914d\u7f6e\u3002\u73fe\u5728\uff0c\u60a8\u53ef\u4ee5\u5728 Google Cloud \u9805\u76ee\u4e2d\u8207 Artifact Registry \u9023\u63a5\u4ee5\u63a8\u9001\u6620\u50cf\u3002\n- \u7d50\u5408\u4f7f\u7528 [Dockerfile](https://cloud.google.com/build/docs/build-push-docker-image?hl=zh-cn#build_using_dockerfile) \u548c Cloud Build \u4f86\u69cb\u5efa [Docker](https://docs.docker.com/) \u6620\u50cf\u3002\u66f4\u65b0\u4ee5\u4e0b\u547d\u4ee4\u4e2d\u7684\u8def\u5f91\uff0c\u4ee5\u5339\u914d\u60a8\u5275\u5efa\u7684 Dockerfile\u3002\u6b64\u547d\u4ee4\u6703\u69cb\u5efa\u6587\u4ef6\u4e26\u5c07\u5176\u63a8\u9001\u5230\u60a8\u7684 Artifact Registry \u4ee3\u78bc\u5eab\u3002```\ngcloud builds submit --tag LOCATION-docker.pkg.dev/PROJECT_ID/REPOSITORY/dataflow/cpp_beam_container:latest .\n```\n## \u5c07\u4ee3\u78bc\u548c\u4f9d\u8cf4\u9805\u6253\u5305\u5230 Docker \u5bb9\u5668\u4e2d\n- \u5982\u9700\u5728\u5206\u4f48\u5f0f\u74b0\u5883\u4e2d\u904b\u884c\u6b64\u6d41\u6c34\u7dda\uff0c\u8acb\u5c07\u4ee3\u78bc\u548c\u4f9d\u8cf4\u9805\u6253\u5305\u5230 Docker \u5bb9\u5668\u4e2d\u3002```\ndocker build . -t cpp_beam_container\n```\n- \u6253\u5305\u4ee3\u78bc\u548c\u4f9d\u8cf4\u9805\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5728\u672c\u5730\u904b\u884c\u6d41\u6c34\u7dda\u4ee5\u9032\u884c\u6e2c\u8a66\u3002```\npython pipeline.py \\\u00a0 \u00a0--runner=PortableRunner \\\u00a0 \u00a0--job_endpoint=embed \\\u00a0 \u00a0--environment_type=DOCKER \\\u00a0 \u00a0--environment_config=\"docker.io/library/cpp_beam_container\"\n```\u6b64\u547d\u4ee4\u6703\u5728 Docker \u6620\u50cf\u4e2d\u5beb\u5165\u8f38\u51fa\u3002\u5982\u9700\u67e5\u770b\u8f38\u51fa\uff0c\u8acb\u4f7f\u7528 `--output` \u904b\u884c\u6d41\u6c34\u7dda\uff0c\u4e26\u5c07\u8f38\u51fa\u5beb\u5165 Cloud Storage \u5b58\u5132\u6876\u3002\u4f8b\u5982\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u3002```\npython pipeline.py \\\u00a0 \u00a0--runner=PortableRunner \\\u00a0 \u00a0--job_endpoint=embed \\\u00a0 \u00a0--environment_type=DOCKER \\\u00a0 \u00a0--environment_config=\"docker.io/library/cpp_beam_container\" \\\u00a0 \u00a0--output=gs://BUCKET_NAME/out.png\n```\n## \u904b\u884c\u6d41\u6c34\u7dda\u73fe\u5728\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u5f15\u7528\u5305\u542b\u6d41\u6c34\u7dda\u4ee3\u78bc\u7684\u6587\u4ef6\u4e26\u50b3\u905e\u6d41\u6c34\u7dda\u6240\u9700\u7684 [\u53c3\u6578](https://cloud.google.com/dataflow/docs/guides/specifying-exec-params?hl=zh-cn#setting-other-cloud-dataflow-pipeline-options) \uff0c\u5728 Dataflow \u4e2d\u904b\u884c Apache Beam \u6d41\u6c34\u7dda\u3002\n\u5728\u60a8\u7684 shell \u6216\u7d42\u7aef\u4e2d\uff0c\u4f7f\u7528 Dataflow Runner \u904b\u884c\u6d41\u6c34\u7dda\u3002\n```\npython pipeline.py \\\u00a0 \u00a0 --runner=DataflowRunner \\\u00a0 \u00a0 --project=PROJECT_ID \\\u00a0 \u00a0 --region=REGION \\\u00a0 \u00a0 --temp_location=gs://BUCKET_NAME/tmp \\\u00a0 \u00a0 --sdk_container_image=\"LOCATION-docker.pkg.dev/PROJECT_ID/REPOSITORY/dataflow/cpp_beam_container:latest\" \\\u00a0 \u00a0 --experiment=use_runner_v2 \\\u00a0 \u00a0 --output=gs://BUCKET_NAME/out.png\n```\n\u5728\u60a8\u57f7\u884c\u904b\u884c\u6d41\u6c34\u7dda\u7684\u547d\u4ee4\u5f8c\uff0cDataflow \u5c07\u8fd4\u56de\u4f5c\u696d\u72c0\u614b\u7232 **\u5df2\u52a0\u5165\u968a\u5217** \u7684\u4f5c\u696d ID\u3002\u53ef\u80fd\u5e7e\u5206\u9418\u5f8c\u4f5c\u696d\u72c0\u614b\u7e94\u6703\u8b8a\u7232 **\u6b63\u5728\u904b\u884c** \uff0c\u60a8\u7e94\u53ef\u4ee5\u8a2a\u554f [\u4f5c\u696d\u5716](https://cloud.google.com/dataflow/docs/guides/job-graph?hl=zh-cn) \u3002## \u67e5\u770b\u7d50\u679c\u67e5\u770b\u5beb\u5165 Cloud Storage \u5b58\u5132\u6876\u7684\u6578\u64da\u3002\u4f7f\u7528 [gcloud storage ls \u547d\u4ee4](https://cloud.google.com/sdk/gcloud/reference/storage/ls?hl=zh-cn) \u5217\u51fa\u5b58\u5132\u6876\u9802\u5c64\u7684\u5167\u5bb9\uff1a\n```\ngcloud storage ls gs://BUCKET_NAME\n```\n\u5982\u679c\u6210\u529f\uff0c\u8a72\u547d\u4ee4\u5c07\u8fd4\u56de\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\u7684\u6d88\u606f\uff1a\n```\ngs://BUCKET_NAME/out.png\n```## \u6e05\u7406\u7232\u907f\u514d\u56e0\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528\u7684\u8cc7\u6e90\u5c0e\u81f4\u60a8\u7684 Google Cloud \u8cec\u865f\u7522\u751f\u8cbb\u7528\uff0c\u8acb\u522a\u9664\u5305\u542b\u9019\u4e9b\u8cc7\u6e90\u7684\u9805\u76ee\uff0c\u6216\u8005\u4fdd\u7559\u9805\u76ee\u4f46\u522a\u9664\u5404\u500b\u8cc7\u6e90\u3002\n### \u522a\u9664\u9805\u76ee\u7232\u4e86\u907f\u514d\u7522\u751f\u8cbb\u7528\uff0c\u6700\u7c21\u55ae\u7684\u65b9\u6cd5\u662f\u522a\u9664\u60a8\u7232\u672c\u6559\u7a0b\u5275\u5efa\u7684 Google Cloud \u9805\u76ee\u3002- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- **\u8b66\u544a** \uff1a\u522a\u9664\u9805\u76ee\u6703\u7522\u751f\u4ee5\u4e0b\u5f71\u97ff- **\u9805\u76ee\u4e2d\u7684\u6240\u6709\u5167\u5bb9\u90fd\u6703\u88ab\u522a\u9664\u3002** \u5982\u679c\u60a8\u5c07\u73fe\u6709\u9805\u76ee\u7528\u65bc\u672c\u6587\u6a94\u4e2d\u7684\u4efb\u52d9\uff0c\u5247\u522a\u9664\u8a72\u9805\u76ee\u5f8c\uff0c\u9084\u5c07\u522a\u9664\u60a8\u5df2\u5728\u8a72\u9805\u76ee\u4e2d\u5b8c\u6210\u7684\u4efb\u4f55\u5176\u4ed6\u5de5\u4f5c\u3002\n- **\u81ea\u5b9a\u7fa9\u9805\u76ee ID \u4e1f\u5931\u3002** \u5275\u5efa\u6b64\u9805\u76ee\u6642\uff0c\u60a8\u53ef\u80fd\u5275\u5efa\u4e86\u8981\u5728\u5c07\u4f86\u4f7f\u7528\u7684\u81ea\u5b9a\u7fa9\u9805\u76ee ID\u3002\u8981\u4fdd\u7559\u4f7f\u7528\u8a72\u9805\u76ee ID \u7684\u7db2\u5740\uff08\u4f8b\u5982`appspot.com`\u7db2\u5740\uff09\uff0c\u8acb\u522a\u9664\u9805\u76ee\u5167\u7684\u6240\u9078\u8cc7\u6e90\uff0c\u800c\u4e0d\u662f\u522a\u9664\u6574\u500b\u9805\u76ee\u3002\n\u5982\u679c\u60a8\u6253\u7b97\u63a2\u7d22\u591a\u500b\u67b6\u69cb\u3001\u6559\u7a0b\u6216\u5feb\u901f\u5165\u9580\uff0c\u5247\u91cd\u8907\u4f7f\u7528\u9805\u76ee\u53ef\u4ee5\u5e6b\u52a9\u60a8\u907f\u514d\u8d85\u51fa\u9805\u76ee\u914d\u984d\u9650\u5236\u3002\n- \u5728 Google Cloud \u63a7\u5236\u6aaf\u4e2d\uff0c\u9032\u5165 **\u7ba1\u7406\u8cc7\u6e90** \u9801\u9762\u3002 [\u8f49\u5230\u201c\u7ba1\u7406\u8cc7\u6e90\u201d](https://console.cloud.google.com/iam-admin/projects?hl=zh-cn) \n- \u5728\u9805\u76ee\u5217\u8868\u4e2d\uff0c\u9078\u64c7\u8981\u522a\u9664\u7684\u9805\u76ee\uff0c\u7136\u5f8c\u9ede\u64ca **\u522a\u9664** \u3002\n- \u5728\u5c0d\u8a71\u6846\u4e2d\u8f38\u5165\u9805\u76ee ID\uff0c\u7136\u5f8c\u9ede\u64ca **\u95dc\u9589** \u4ee5\u522a\u9664\u9805\u76ee\u3002\n### \u9010\u500b\u522a\u9664\u8cc7\u6e90\u5982\u679c\u60a8\u5e0c\u671b\u91cd\u8907\u4f7f\u7528\u8a72\u9805\u76ee\uff0c\u8acb\u522a\u9664\u7232\u672c\u6559\u7a0b\u5275\u5efa\u7684\u8cc7\u6e90\u3002\n- \u522a\u9664 Artifact Registry \u4ee3\u78bc\u5eab\u3002```\ngcloud artifacts repositories delete REPOSITORY \\\u00a0 \u00a0--location=LOCATION --async\n```\n- \u522a\u9664 Cloud Storage \u5b58\u5132\u6876\u3002\u55ae\u7368\u9019\u4e00\u500b\u5b58\u5132\u6876\u4e0d\u6703\u7522\u751f\u4efb\u4f55\u8cbb\u7528\u3002 **\u6ce8\u610f** \uff1a\u4ee5\u4e0b\u547d\u4ee4\u9084\u6703\u522a\u9664\u8a72\u5b58\u5132\u6876\u4e2d\u7684\u6240\u6709\u5c0d\u8c61\u3002\u7121\u6cd5\u6062\u5fa9\u9019\u4e9b\u5c0d\u8c61\u3002```\ngcloud storage rm gs://BUCKET_NAME --recursive\n```\n- \u64a4\u6d88\u60a8\u6388\u4e88\u7528\u6236\u7ba1\u7406\u7684\u5de5\u4f5c\u5668\u670d\u52d9\u8cec\u865f\u7684\u89d2\u8272\u3002\u5c0d\u4ee5\u4e0b\u6bcf\u500b IAM \u89d2\u8272\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4e00\u6b21\uff1a- `roles/dataflow.admin`\n- `roles/dataflow.worker`\n- `roles/storage.objectAdmin`\n- `roles/artifactregistry.reader`\n```\ngcloud projects remove-iam-policy-binding PROJECT_ID \\\u00a0 --member=serviceAccount:parallelpipeline@PROJECT_ID.iam.gserviceaccount.com \\\u00a0 --role=SERVICE_ACCOUNT_ROLE\n```\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- \u53ef\u9078\uff1a\u64a4\u6d88\u60a8\u5275\u5efa\u7684\u8eab\u4efd\u9a57\u8b49\u6191\u64da\uff0c\u4e26\u522a\u9664\u672c\u5730\u6191\u64da\u6587\u4ef6\u3002```\ngcloud auth application-default revoke\n```\n- Titles in dynamic includes are not used anywhere, and we should avoid paying to translate them\n- \u53ef\u9078\uff1a\u5f9e gcloud CLI \u64a4\u6d88\u6191\u64da\u3002```\ngcloud auth revoke\n```\n## \u5f8c\u7e8c\u6b65\u9a5f\n- \u67e5\u770b [GitHub \u4e0a\u7684\u793a\u4f8b\u61c9\u7528](https://github.com/GoogleCloudPlatform/dataflow-sample-applications/tree/master/beam-cpp-example) \u3002\n- [\u5728 Dataflow \u4e2d\u4f7f\u7528\u81ea\u5b9a\u7fa9\u5bb9\u5668](https://cloud.google.com/dataflow/docs/guides/using-custom-containers?hl=zh-cn) \u3002\n- \u8a73\u7d30\u77ad\u89e3\u5982\u4f55\u5c07 [\u5bb9\u5668\u74b0\u5883](https://beam.apache.org/documentation/runtime/environments/) \u8207 Apache Beam \u642d\u914d\u4f7f\u7528\u3002\n- \u63a2\u7d22\u6709\u95dc Google Cloud \u7684\u53c3\u8003\u67b6\u69cb\u3001\u5716\u8868\u548c\u6700\u4f73\u5be6\u8e10\u3002\u67e5\u770b\u6211\u5011\u7684 [Cloud Architecture Center](https://cloud.google.com/architecture?hl=zh-cn) \u3002", "guide": "Dataflow"}