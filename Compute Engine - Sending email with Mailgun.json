{"title": "Compute Engine - Sending email with Mailgun", "url": "https://cloud.google.com/compute/docs/instances", "abstract": "# Compute Engine - Sending email with Mailgun\nGoogle Cloud works with Mailgun to provide an email service that has a programmatic API, log retention, email personalization, analytics, and email validation.\nThe following instructions show you how to configure Mailgun as an email relay with Postfix.\n", "content": "## Before you begin\n- Sign up for and create a new Mailgun account on the [Google Cloud Marketplace](https://console.cloud.google.com/marketplace/details/mailgun/emailapi) .\n- Get your credentials. The instructions require that you know your Mailgun SMTP username, password, and hostname. Get your username and password from the Mailgun control panel, under the **Domains** section.Depending on how the domain is configured in Mailgun, the SMTP hostname is either `smtp.mailgun.org` or `smtp.eu.mailgun.org` .\n- Configure your [firewall rules](/vpc/docs/using-firewalls#creating_firewall_rules) to allow outgoing traffic on TCP port `2525` .## Configuring Mailgun as a mail relay with Postfix\nConfiguring Mailgun as a mail relay allows the [Postfix](http://www.postfix.org) mail transfer agent to forward emails destined for remote delivery.\n- Connect to your instance using SSH.```\ngcloud compute ssh [INSTANCE_NAME]\n```where `[INSTANCE_NAME]` is the name of the VM instance where you want to send email from.\n- Become a superuser and set a safe umask.```\nuser@test-instance:~$ sudo su \n``````\nroot@test-instance:~# umask 077\n```\n- Install the Postfix Mail Transport Agent.\n```\nroot@test-instance:~# apt update && apt -y install postfix libsasl2-modules\n``````\nroot@test-instance:~# yum install postfix cyrus-sasl-plain cyrus-sasl-md5 -y\n```\n- When prompted, select the `Local Only` configuration and accept the default choices for domain names.\n- Modify the Postfix configuration options. Postfix configuration options are set in the `main.cf` file. Open the file with the text editor of your choice.```\nroot@test-instance:~# vi /etc/postfix/main.cf\n```\n- If they exist, comment out the following lines.```\n# default_transport = error# relay_transport = error\n```\n- Add the Mailgun SMTP service by adding the following line to the end of the file.```\nrelayhost = [smtp.mailgun.org]:2525\n``` **Note:** You must use port `2525` because port `25` isn't allowed on Compute Engine.\n- To enforce SSL/TLS support and configure SMTP authentication for these requests, add the following lines to the end of the file. A simple access and security layer (SASL) module handles authentication in the Postfix configuration.```\nsmtp_tls_security_level = encryptsmtp_sasl_auth_enable = yessmtp_sasl_password_maps = hash:/etc/postfix/sasl_passwdsmtp_sasl_security_options = noanonymous\n```\n- Save your changes and close the file.\n- Generate the SASL password map.- Create a new password file that is ready for standard input.```\nroot@test-instance:~# cat > /etc/postfix/sasl_passwd << EOF\n```\n- At the prompt, enter the service details, replacing `YOUR_SMTP_LOGIN` and `YOUR_SMTP_PASSWORD` with your credentials. See the [Mailgunhelp](https://help.mailgun.com/hc/en-us/articles/203380100-Where-Can-I-Find-My-API-Key-and-SMTP-Credentials) for instructions on how to view or change your per-domain credentials.```\n> [smtp.mailgun.org]:2525 YOUR_SMTP_LOGIN:YOUR_SMTP_PASSWORD\n```\n- Close and save the file by typing the delimiter, `EOF` .```\n> EOF\n```\n- Use the `postmap` utility to generate a `.db` file.```\nroot@test-instance:~# postmap /etc/postfix/sasl_passwd\n``````\nroot@test-instance:~# ls -l /etc/postfix/sasl_passwd*\n-rw------- 1 root root 68 Jun 1 10:50 /etc/postfix/sasl_passwd\n-rw------- 1 root root 12288 Jun 1 10:51 /etc/postfix/sasl_passwd.db\n```\n- Next, remove the file that contains your credentials because it is no longer needed.```\nroot@test-instance:~# rm /etc/postfix/sasl_passwd\n```\n- Set the permissions on your `.db` file.```\nroot@test-instance:~# chmod 600 /etc/postfix/sasl_passwd.db\n``````\nroot@test-instance:~# ls -la /etc/postfix/sasl_passwd.db\n-rw------- 1 root root 12288 Aug 31 18:51 /etc/postfix/sasl_passwd.db\n```\n- Finally, reload your configuration to load the modified parameters.\n```\nroot@test-wheezy:~# /etc/init.d/postfix restart\n``````\n[root@test-centos ~]# postfix reload\n```\n- Test your configuration. Install the `mailx` or `mailutils` package and test your configuration.\n```\nroot@test-wheezy:~# apt -y install mailutils\n``````\n[root@test-centos ~]# yum install mailx -y\n```\nSend a test message.```\nroot@test-instance:~# echo 'Test passed.' | mail -s 'Test-Email' EMAIL@EXAMPLE.COM\n```Look in your systems logs for a status line containing `status` and the successful server response code `(250)` .\n```\nroot@test-wheezy:~# tail -n 5 /var/log/syslog\n``````\n[root@test-centos ~]# tail -n 5 /var/log/maillog\n```For detailed examples and information about other topics including tracking and routing messages, read the [Mailgun documentation](https://documentation.mailgun.com) .\nExplore reference architectures, diagrams, and best practices about Google Cloud. Take a look at our [Cloud Architecture Center](/architecture) .", "guide": "Compute Engine"}