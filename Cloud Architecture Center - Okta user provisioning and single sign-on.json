{"title": "Cloud Architecture Center - Okta user provisioning and single sign-on", "url": "https://cloud.google.com/architecture/reference-patterns/overview", "abstract": "# Cloud Architecture Center - Okta user provisioning and single sign-on\nLast reviewed 2024-01-03 UTC\nThis document shows you how to set up user provisioning and single sign-on between an [Okta organization](https://developer.okta.com/docs/concepts/okta-organizations/) and your Cloud Identity or Google Workspace account.\nThe document assumes that you already use Okta in your organization and want to use Okta for allowing users to authenticate with Google Cloud.\n **Note:** This article uses [classic organizational SSO profiles](/architecture/identity/single-sign-on#configuration) instead of SAML profiles to set up single sign-on. Organizational SSO profiles let you [choose whether to apply additional authentication challenges](https://support.google.com/a/answer/6002699#ssochallenges) to users, which is not supported for SAML profiles.", "content": "## Objectives\n- Configure Okta to automatically provision users and, optionally, groups to Cloud Identity or Google Workspace.\n- Configure single sign-on to allow users to sign in to Google Cloud by using an Okta user account.\n## CostsIf you are using the [free edition of Cloud Identity](https://support.google.com/cloudidentity/answer/7431902) , setting up federation with Okta won't use any billable components of Google Cloud.\nCheck the [Okta pricing page](https://www.okta.com/pricing/) for any fees that might apply to using Okta.## Before you begin\n- [Sign up for Cloud Identity](https://workspace.google.com/signup/gcpidentity/welcome?&_ga=2.104797888.-157260409.1512652371) if you don't have an account already.\n- If you're using the [free edition of Cloud Identity](https://support.google.com/cloudidentity/answer/7431902) and intend to provision more than 50 users, [request an increase](https://support.google.com/cloudidentity/answer/7295541) of the total number of free Cloud Identity users through your support contact.\n- If you suspect that any of the domains you plan to use for Cloud Identity could have been used by employees to register consumer accounts, consider migrating these user accounts first. For more details, see [Assessing existing user accounts](/architecture/identity/assessing-existing-user-accounts) .\n## Preparing your Cloud Identity or Google Workspace account\n### Create a user for OktaTo let Okta access your Cloud Identity or Google Workspace account, you must create a user for Okta in your Cloud Identity or Google Workspace account.\nThe Okta user is only intended for automated provisioning. Therefore, it's best to keep it separate from other user accounts by placing it in a separate organizational unit (OU). Using a separate OU also ensures that you can later [disable single sign-on](/architecture/identity/best-practices-for-federating#disable_sso_for_super-admin_users) for the Okta user.\nTo create a new OU, do the following:- Open the [Admin Console](https://admin.google.com) and log in using the super-admin user created when you signed up for Cloud Identity or Google Workspace.\n- In the menu, go to **Directory\u00a0> Organizational units** .\n- Click **Create organizational unit** and provide a name and description for the OU:- **Name** :`Automation`\n- **Description** :`Automation users`\n- Click **Create** .\nCreate a user account for Okta and place it in the `Automation` OU:- In the menu, go to **Directory\u00a0> Users** and click **Add new user** to create a user.\n- Provide an appropriate name and email address such as the following:- **First Name** :`Okta`\n- **Last Name** :`Provisioning`\n- **Primary email** : `okta-provisioning`Keep the primary domain for the email address.\n- Click **Manage user's password, organizational unit, and profile photo** and configure the following settings:- **Organizational unit** : Select the`Automation`OU that you created previously.\n- **Password** : Select **Create password** and enter a password.\n- **Ask for a password change at the next sign-in** : **Disabled** .\n- Click **Add new user** .\n- Click **Done** .\n### Assign privileges to OktaTo let Okta create, list, and suspend users and groups in your Cloud Identity or Google Workspace account, you must make the `okta-provisioning` user a super-admin:- Locate the newly created user in the list and click the user's name to open their account page.\n- Under **Admin roles and privileges** , click **Assign roles** .\n- Enable the super-admin role.\n- Click **Save** .\n **Note:** The super-admin role grants the user full access to Cloud Identity, Google Workspace, and Google Cloud resources.\n **Warning:** To protect the user against credential theft and malicious use, we recommend that you enable [2-step verification](https://support.google.com/a/answer/175197) for the user. For more details on how to protect super-admin users, see [Security best practices for administrator accounts](https://support.google.com/a/answer/9011373) .## Configuring Okta provisioningYou are now ready to connect Okta to your Cloud Identity or Google Workspace account by setting up the [Google Workspace application from the Okta catalog](https://www.okta.com/integrations/google-workspace/) .\n **Note:** This application is an Okta product and is not maintained or supported by Google.\nThe Google Workspace application can handle both user provisioning and single sign-on. Use this application even if you're using Cloud Identity and you're only planning to set up single sign-on for Google Cloud.\n### Create an applicationTo set up the Google Workspace application, do the following:- Open the Okta admin dashboard and sign in as a user withprivileges.\n- In the menu, go to **Applications\u00a0> Applications** .\n- Click **Browse app catalog** .\n- Search for`Google Workspace`and select the **Google Workspace** application.\n- Click **Add integration** .\n- On the **General settings** page, configure the following:- **Application label** :`Google Cloud`\n- **Your Google Apps company domain** : the primary domain name used by your Cloud Identity or Google Workspace account.\n- **Display the following links** :- Set **Account** to **enabled** .\n- Set other links to **enabled** if you're using Google Workspace, set other links to **disabled** otherwise.\n- **Application Visibility** : set to **enabled** if you're using Google Workspace, **disabled** otherwise\n- **Browser plugin auto-submit** : set to **disabled** \n- Click **Next** .\n- On the **Sign-on options** page, configure the following:- **Sign on methods** : select **SAML 2.0** \n- **Default Relay State** : leave empty\n- **Advanced Sign-on Settings\u00a0> RPID** : leave empty\n- Decide how you want to populate the primary email address for users in Cloud Identity or Google Workspace. A user's primary email address must use either the primary domain of your Cloud Identity or Google Workspace account or one of its secondary domains.\nTo use user's Okta username as primary email address, use the following settings:- **Application username format** : **Okta username** \n- **Update application username on** : **Create and update** .\nTo use user's Okta username as primary email address, use the following settings:- **Application username format** : **Email** \n- **Update application username on** : **Create and update** .- Click **Done** .\n### Configure user provisioningIn this section, you configure Okta to automatically provision users and groups to Google Cloud.- On the settings page for the **Google Cloud** application, open the **Provisioning** tab.\n- Click **Configure API Integration** and configure the following:- **Enable API integration** : set to to **enabled** \n- **Import Groups** : set to **disabled** unless you have existing groups in Cloud Identity or Google Workspace that you want to import to Okta\n- Click **Authenticate with Google Workspace** .\n- Sign in using the `okta-provisioning@` `` user you created earlier, where `` is the primary domain of your Cloud Identity or Google Workspace account.\n- Review the Google Terms of Service and privacy policy. If you agree to the terms, click **I understand** .\n- Confirm access to the Cloud Identity API by clicking **Allow** .\n- Click **Save** .\nOkta is connected to your Cloud Identity or Google Workspace account, but provisioning is still disabled. To enable provisioning, do the following:- On the settings page for the **Google Cloud** application, open the **Provisioning** tab.\n- Click **Edit** and configure the following:- **Create users** : set to **enabled** \n- **Update user attributes** : set to **enabled** \n- **Deactivate users** : set to **enabled** \n- **Sync password** : set to **disabled** \n **Note:** You might need to adjust these settings if you're planning to consolidate existing consumer accounts. For more details, see [Making Okta federation safe for account consolidation](/architecture/identity/assessing-consolidation-impact-on-federation#making_okta_federation_safe_for_account_consolidation) \n- Optionally, click **Go to profile editor** to customize attribute mappings.If you use custom mappings, you must map `userName` , `nameGivenName` , and `nameFamilyName` . All other attribute mappings are optional.\n- Click **Save** .\n### Configure user assignmentIn this section, you configure which Okta users to provision to Cloud Identity or Google Workspace:- On the settings page for the **Google Cloud** application, open the **Assignments** tab.\n- Click **Assign\u00a0> Assign to people** or **Assign\u00a0> Assign to groups** .\n- Select a user or group and click **Assign** .\n- On the assignment dialog that appears, keep the default settings and click **Save and go back** .\n- Click **Done** .\nRepeat the steps in this section for each user or group that you want to provision. To provision all users to Cloud Identity or Google Workspace, assign the **Everyone** group.\n### Configure group assignmentOptionally, you can let Okta provision groups to Cloud Identity or Google Workspace. Instead of selecting groups individually, it's best to configure Okta to provision groups based on a naming convention.\nFor example, to let Okta provision all groups that begin with `google-cloud` , do the following:- On the settings page for the **Google Cloud** application, open the **Push groups** tab.\n- Click **Push groups\u00a0> Find groups by role** .\n- On the **Push groups by rule** page, configure the following rule:- **Rule name** : name for the role, for example`Google Cloud`.\n- **Group name** : **starts with** `google-cloud`\n- Click **Create rule** .\n### TroubleshootingTo troubleshoot user or group provisioning, click **View logs** on the settings page for the **Google Cloud** application.\nTo let Okta retry a failed attempt to provision users, do the following:- Go to **Dashboard\u00a0> Tasks** .\n- Find the failed task and open the details.\n- On the details page, click **Retry selected** .\n## Configuring Okta for single sign-onIf you've followed the steps to configure Okta provisioning, all relevant Okta users are now automatically being provisioned to Cloud Identity or Google Workspace. To allow these users to sign in, configure single sign-on:- On the settings page for the **Google Cloud** application, open the **Sign on** tab.\n- Click **SAML 2.0\u00a0> More details** .\n- Click **Download** to download the signing certificate.\n- Note the **Sign-on URL** and **Sign-out URL** , you need these URLs in one of the following steps.\nAfter you've prepared Okta for single sign-on, you can enable single sign-on in your Cloud Identity or Google Workspace account:- Open the [Admin Console](https://admin.google.com) and log in using a super-admin user.\n- In the menu, click **Show more** and go to **Security\u00a0> Authentication\u00a0> SSO with third-party IdP** .\n- Click **Add SSO profile** . **Important:** Don't use the **Add SAML profile** button.\n- Set **Setup SSO with third party identity provider** to **enabled** .\n- Enter the following settings:- **Sign-in page URL** : enter the **Sign-on URL** that you copied from the Okta settings page.\n- **Sign-out page URL** : enter the **Sign-out URL** that you copied from the Okta settings page.\n- **Change password URL** :`https://ORGANIZATION.okta.com/enduser/settings`where``is the name of your Okta organization.\n- Under **Verification certificate** , click **Upload certificate** , and then pick the token signing certificate that you downloaded previously.\n- Click **Save** .\nUpdate the SSO settings for the `Automation` OU to [disable single sign-on](/architecture/identity/best-practices-for-federating#disable_sso_for_super-admin_users) :- Under **Manage SSO profile assignments** , click **Get started** .\n- Expand **Organizational units** and select the`Automation`OU.\n- Change the SSO profile assignment from **Organization's third-party SSO profile** to **None** .\n- Click **Override** .\n## Add the Google Cloud console and other Google services to the app dashboardTo add the Google Cloud console and, optionally, other Google services to your users' Okta app dashboard, do the following:- In the Okta admin dashboard, select **Applications\u00a0> Applications** .\n- Click **Browse app catalog** .\n- Search for`Bookmark app`and select the **Bookmark app** application.\n- Click **Add integration** .\n- On the **General settings** page, configure the following:- **Application label** :`Google Cloud console`\n- **URL** :`https://www.google.com/a/` `` `/ServiceLogin?continue=https://console.cloud.google.com/`, replacing``with the primary domain name used by your Cloud Identity or Google Workspace account.\n- Click **Done** .\n- Change the application logo to the [Google Cloud logo](/static/architecture/identity/images/logo-cloud.png) .\n- Open the **Sign on** tab.\n- Click **User authentication\u00a0> Edit** and configure the following:- **Authentication policy** : set to **Okta dashboard** \n- Click **Save** .\n- Open the **Assignment** tab and assign one or more users. Assigned users see the Google Cloud console link in their user dashboard. **Important:** The assignment settings of the **Bookmark app** only control visibility. To grant a user permission to use single sign-on and access Google Cloud, you must also assign them to the Google Workspace app.\nOptionally, repeat the steps above for any additional Google services you want to include in user dashboards. The table below contains the URLs and logos for commonly used Google services:\n| Google service | URL                     | Logo |\n|:-----------------|:--------------------------------------------------------------------------------------|-------:|\n| Google Docs  | https://docs.google.com/a/DOMAIN              | nan |\n| Google Sheets | https://www.google.com/a/DOMAIN/ServiceLogin?continue=https://sheets.google.com  | nan |\n| Google Sites  | https://www.google.com/a/DOMAIN/ServiceLogin?continue=https://slides.google.com  | nan |\n| Google Drive  | https://drive.google.com/a/DOMAIN              | nan |\n| Gmail   | https://mail.google.com/a/DOMAIN              | nan |\n| Google Groups | https://www.google.com/a/DOMAIN/ServiceLogin?continue=https://groups.google.com  | nan |\n| Google Keep  | https://www.google.com/a/DOMAIN/ServiceLogin?continue=https://keep.google.com   | nan |\n| Looker Studio | https://www.google.com/a/DOMAIN/ServiceLogin?continue=https://lookerstudio.google.com | nan |## Test single sign-onAfter you've completed the single sign-on configuration in both Okta and Cloud Identity or Google Workspace, you can access Google Cloud in two ways:- Through the list in your Okta user dashboard.\n- Directly by opening [https://console.cloud.google.com/](https://console.cloud.google.com/) .\nTo check that the second option works as intended, run the following test:- Pick an Okta user that has been provisioned to Cloud Identity or Google Workspace and that doesn't have super-admin privileges assigned. Users with super-admin privileges always have to sign in using Google credentials and are therefore not suitable for testing single sign-on.\n- Open a new browser window and go to [https://console.cloud.google.com/](https://console.cloud.google.com/) .\n- In the Google Sign-In page that appears, enter the email address of the user and click **Next** .\n- You are redirected to Okta and will see another sign-in prompt. Enter your email address of the user and follow the steps to authenticate.After successful authentication, Okta should redirect you back to Google Sign-In. Because this is the first time you've signed in using this user, you're asked to accept the Google Terms of Service and privacy policy.\n- If you agree to the terms, click **I understand** .You are redirected to the Google Cloud console, which asks you to confirm preferences and accept the Google Cloud Terms of Service.\n- If you agree to the terms, choose **Yes** and click **Agree and continue** .\n- Click the avatar icon on the top left of the page, and then click **Sign out** .You are redirected to a Okta page confirming that you have been successfully signed out.\nKeep in mind that users with super-admin privileges are exempted from single sign-on, so you can still use the Admin Console to verify or change settings.## Clean upTo avoid incurring charges to your Google Cloud account for the resources used in this   tutorial, either delete the project that contains the resources, or keep the project and   delete the individual resources.## What's next\n- Learn more about [best practices for planning accounts and organizations](/architecture/identity/best-practices-for-planning) and [best practices for federating Google Cloud with an external identity provider](/architecture/identity/best-practices-for-federating) .\n- Acquaint yourself with our [best practices for managing super-admin accounts.](/resource-manager/docs/super-admin-best-practices)", "guide": "Cloud Architecture Center"}