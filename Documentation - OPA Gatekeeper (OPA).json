{"title": "Documentation - OPA Gatekeeper (OPA)", "url": "https://cloud.google.com/distributed-cloud/hosted/docs/latest/gdch/overview", "abstract": "# Documentation - OPA Gatekeeper (OPA)\n", "content": "## All operations through the Kubernetes API\n**Log schema** : KRM API\n| ('Fields in the log entry that contain audit information', 'Audit metadata') | ('Fields in the log entry that contain audit information', 'Audit field name') | ('Fields in the log entry that contain audit information', 'Value')                                                                  |\n|:-------------------------------------------------------------------------------|:---------------------------------------------------------------------------------|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| User or service identity              | user                    | \"user\": { \"groups\": [ \"system:authenticated\" ], \"username\": \"fop-platform-admin@example.com\" }, \"annotations\": { \"authorization.k8s.io/decision\": \"allow\", \"authorization.k8s.io/reason\": \"RBAC: allowed by ClusterRoleBinding \\\"project-creator-binding\\\" of ClusterRole \\\"project-creator\\\" to Group \\\"system:authenticated\\\"\" } |\n| Target(Fields and values that call the API)         | objectRef                  | \"objectRef\": { \"apiVersion\": \"v1\", \"name\": \"app1-project\", \"resource\": \"projects\", \"namespace\": \"gpc-system\", \"apiGroup\": \"resourcemanager.gdc.goog\" }                                            |\n| Action(Fields containing the performed operation)        | verb                    | \"verb\": \"create\"                                                                               |\n| Event timestamp                | requestReceivedTimestamp               | \"requestReceivedTimestamp\": \"2022-12-09T23:51:56.997825Z\"                                                                    |\n| Source of action                | sourceIPs                  | \"sourceIPs\": [ \"10.200.0.2\" ]                                                                           |\n| Outcome                  | responseStatus                 | \"responseStatus\": { \"code\": 403, \"status\": \"Failure\", \"metadata\": {}, \"message\": \"admission webhook \\\"validation.gatekeeper.sh\\\" denied the request: [restrictprojectaccess] username                                    |\n| Other fields                 | responseStatus_message               | \"responseStatus\": { \"code\": 403, \"status\": \"Failure\", \"metadata\": {}, \"message\": \"admission webhook \\\"validation.gatekeeper.sh\\\" denied the request: [restrictprojectaccess] username                                    |\n### Example log KRM API\n```\n{\u00a0 \"sourceIPs\": [\u00a0 \u00a0 \"10.200.0.2\"\u00a0 ],\u00a0 \"_gdch_cluster\": \"root-admin\",\u00a0 \"objectRef\": {\u00a0 \u00a0 \"apiVersion\": \"v1\",\u00a0 \u00a0 \"name\": \"app1-project\",\u00a0 \u00a0 \"resource\": \"projects\",\u00a0 \u00a0 \"namespace\": \"gpc-system\",\u00a0 \u00a0 \"apiGroup\": \"resourcemanager.gdc.goog\"\u00a0 },\u00a0 \"kind\": \"Event\",\u00a0 \"level\": \"Metadata\",\u00a0 \"apiVersion\": \"audit.k8s.io/v1\",\u00a0 \"auditID\": \"3611358c-f8b0-4780-9268-950eccc5881a\",\u00a0 \"stage\": \"ResponseComplete\",\u00a0 \"requestURI\": \"/apis/resourcemanager.gdc.goog/v1/namespaces/gpc-system/projects?fieldManager=kubectl-client-side-apply&fieldValidation=Strict\",\u00a0 \"verb\": \"create\",\u00a0 \"requestReceivedTimestamp\": \"2022-12-09T23:51:56.997825Z\",\u00a0 \"responseStatus\": {\u00a0 \u00a0 \"code\": 403,\u00a0 \u00a0 \"status\": \"Failure\",\u00a0 \u00a0 \"metadata\": {},\u00a0 \u00a0 \"message\": \"admission webhook \\\"validation.gatekeeper.sh\\\" denied the request: [restrictprojectaccess] username <fop-platform-admin@example.com> with groups <[\\\"system:authenticated\\\"]> is not allowed for this resource <Project/app1-project>\",\u00a0 \u00a0 \"reason\": \"[restrictprojectaccess] username <fop-platform-admin@example.com> with groups <[\\\"system:authenticated\\\"]> is not allowed for this resource <Project/app1-project>\"\u00a0 },\u00a0 \"_gdch_fluentbit_pod\": \"anthos-audit-logs-forwarder-b9kk4\",\u00a0 \"stageTimestamp\": \"2022-12-09T23:51:57.015134Z\",\u00a0 \"userAgent\": \"kubectl/v1.25.4 (linux/amd64) kubernetes/872a965\",\u00a0 \"user\": {\u00a0 \u00a0 \"groups\": [\u00a0 \u00a0 \u00a0 \"system:authenticated\"\u00a0 \u00a0 ],\u00a0 \u00a0 \"username\": \"fop-platform-admin@example.com\"\u00a0 },\u00a0 \"annotations\": {\u00a0 \u00a0 \"authorization.k8s.io/decision\": \"allow\",\u00a0 \u00a0 \"authorization.k8s.io/reason\": \"RBAC: allowed by ClusterRoleBinding \\\"project-creator-binding\\\" of ClusterRole \\\"project-creator\\\" to Group \\\"system:authenticated\\\"\"\u00a0 },\u00a0 \"_gdch_service_name\": \"apiserver\"}\n```\n## Start an audit process\n**Log schema** : Gatekeeper\n| ('Fields in the log entry that contain audit information', 'Audit metadata') | ('Fields in the log entry that contain audit information', 'Audit field name') | ('Fields in the log entry that contain audit information', 'Value') |\n|:-------------------------------------------------------------------------------|:---------------------------------------------------------------------------------|:----------------------------------------------------------------------|\n| User or service identity              | Not applicable                 | nan                 |\n| Target(Fields and values that call the API)         | process                   | \\\"process\\\":\\\"audit\\\"             |\n| Action(Fields containing the performed operation)        | event_type                  | \\\"event_type\\\":\\\"audit_started\\\"          |\n| Event timestamp                | audit_id                   | \\\"audit_id\\\":\\\"2022-12-13T23:07:11Z\\\"         |\n| Source of action                | pod_name                   | \"pod_name\": \"gatekeeper-audit-b7 65495d8-tb4kc\"      |\n| Outcome                  | msg                    | \\\"msg\\\":\\\"auditing constraints and violations\\\"      |\n| Other fields                 | Not applicable                 | nan                 |\n## Finish an audit process\n**Log schema** : Gatekeeper\n| ('Fields in the log entry that contain audit information', 'Audit metadata') | ('Fields in the log entry that contain audit information', 'Audit field name') | ('Fields in the log entry that contain audit information', 'Value') |\n|:-------------------------------------------------------------------------------|:---------------------------------------------------------------------------------|:----------------------------------------------------------------------|\n| User or service identity              | Not applicable                 | nan                 |\n| Target(Fields and values that call the API)         | process                   | \\\"process\\\":\\\"audit\\\"             |\n| Action(Fields containing the performed operation)        | event_type                  | \\\"event_type\\\":\\\"audit_finished\\\"          |\n| Event timestamp                | audit_id                   | \\\"audit_id\\\":\\\"2022-12-13T23:05:32Z\\\"         |\n| Source of action                | pod_name                   | \"pod_name\": \"gatekeeper-audit-b765495d8-tb4k c\"      |\n| Outcome                  | msg                    | \\\"msg\\\":\\\"auditing is complete\\\"          |\n| Other fields                 | Not applicable                 | nan                 |\n## Audit violation\n**Log schema** :Gatekeeper\n| ('Fields in the log entry that contain audit information', 'Audit metadata') | ('Fields in the log entry that contain audit information', 'Audit field name') | ('Fields in the log entry that contain audit information', 'Value') |\n|:-------------------------------------------------------------------------------|:---------------------------------------------------------------------------------|:----------------------------------------------------------------------|\n| User or service identity              | details                   | \\\"details\\\":{\\\"missing_labels\\\":[\\\"gatekeeper\\\"]}      |\n| Target(Fields and values that call the API)         | process                   | \\\"process\\\":\\\"audit\\\"             |\n| Action(Fields containing the performed operation)        | event_type                  | \\\"event_type\\\":\\\"violation_audited\\\"         |\n| Event timestamp                | audit_id                   | \\\"audit_id\\\":\\\"2022-12-13T23:07:11Z\\\"         |\n| Source of action                | pod_name                   | \"pod_name\": \"gatekeeper-audit-b765495d8-tb4kc\"      |\n| Outcome                  | msg                    | \\\"msg\\\":\\\"you must provide labels: {\\\\\\\"gatekeeper\\\\\\\"}\\\"    |\n| Other fields                 | Not applicable                 | nan                 |\n## Audit constraint\n**Log schema** : Gatekeeper\n| ('Fields in the log entry that contain audit information', 'Audit metadata') | ('Fields in the log entry that contain audit information', 'Audit field name') | ('Fields in the log entry that contain audit information', 'Value') |\n|:-------------------------------------------------------------------------------|:---------------------------------------------------------------------------------|:----------------------------------------------------------------------|\n| User or service identity              | constraint_name                 | \\\"constraint_name\\\":\\\"ns-must-have-gk\\\"        |\n| Target(Fields and values that call the API)         | process                   | \\\"process\\\":\\\"audit\\\"             |\n| Action(Fields containing the performed operation)        | event_type                  | \\\"event_type\\\":\\\"constraint_audited\\\"         |\n| Event timestamp                | audit_id                   | \\\"audit_id\\\":\\\"2022-12-13T23:07:11Z\\\"         |\n| Source of action                | pod_name                   | \"pod_name\": \"gatekeeper-audit-b 765495d8-tb4kc\"      |\n| Outcome                  | msg                    | \\\"msg\\\":\\\"audit results for constraint\\\"        |\n| Other fields                 | Not applicable                 | nan                 |\n### Example log Gatekeeper\n```\n{\u00a0 \"stream\":\"stderr\",\u00a0 \"logtag\":\"F\",\u00a0 \"log\":\"{\u00a0 \u00a0 \\\"level\\\":\\\"info\\\",\u00a0 \u00a0 \\\"ts\\\":1670972934.0394588,\u00a0 \u00a0 \\\"logger\\\":\\\"controller\\\",\u00a0 \u00a0 \\\"msg\\\":\\\"audit results for constraint\\\",\u00a0 \u00a0 \\\"process\\\":\\\"audit\\\",\u00a0 \u00a0 \\\"audit_id\\\":\\\"2022-12-13T23:07:11Z\\\",\u00a0 \u00a0 \\\"event_type\\\":\\\"constraint_audited\\\",\u00a0 \u00a0 \\\"constraint_group\\\":\\\"constraints.gatekeeper.sh \\\",\u00a0 \u00a0 \\\"constraint_api_version\\\":\\\"v1\\\",\u00a0 \u00a0 \\\"constraint_kind\\\":\\\"K8sRequiredLabels\\\",\u00a0 \u00a0 \\\"constraint_name\\\":\\\"ns-must-have-gk\\\",\u00a0 \u00a0 \\\"constraint_namespace\\\":\\\"\\\",\u00a0 \u00a0 \\\"constraint_action\\\":\\\"deny\\\",\u00a0 \u00a0 \\\"constraint_status\\\":\\\"enforced\\\",\u00a0 \u00a0 \\\"constraint_violations\\\":\\\"64\\\"\u00a0 \u00a0 }\",\u00a0 \"kubernetes\":{\u00a0 \u00a0 \"pod_name\": \"gatekeeper-audit-b 765495d8-tb4kc\",\u00a0 \u00a0 \"namespace_name\":\"gatekeeper-system\",\u00a0 \u00a0 \"pod_id\":\"3c75b257-0917-4575-bb69-ab5eb6f5839d\",\u00a0 \u00a0 \"labels\":{\u00a0 \u00a0 \u00a0 \"app\": \"gatekeeper\",\u00a0 \u00a0 \u00a0 \"chart\": \"gatekeeper\",\u00a0 \u00a0 \u00a0 \"control-plane\":\"audit-controller\",\u00a0 \u00a0 \u00a0 \"gatekeeper.sh/operation\":\"audit\",\u00a0 \u00a0 \u00a0 \"gatekeeper.sh/system\": \"yes\",\u00a0 \u00a0 \u00a0 \"heritage\" : \"Helm\",\u00a0 \u00a0 \u00a0 \"pod-template-hash\": \"b765495d 8\",\u00a0 \u00a0 \u00a0 \"release\":\"gatekeeper\"\u00a0 \u00a0 \u00a0 },\u00a0 \u00a0 \"host\": \"gpc-adhoc-2801b240vm-worker-node2\",\u00a0 \u00a0 \"container_name\": \"manager\",\u00a0 \u00a0 \"docker_id\":\"33f7eb658cb7a17c50ce917dcc727628bc40ea7d160fb1a20d0d61ae4e51b473\",\u00a0 \u00a0 \"container_hash\": \"gcr.io/private-cloud-staging/gatekeeper@sha256:5d91735b2378723a74930cdff2298efeea6f6bebc8ea9dd0106bfdb067f5a07d\", \"container_image\": \"gcr.io/private-cloud-staging/gatekeeper: v3.7.0\"\u00a0 \u00a0 },\u00a0 \"_gdch_tenant_id\":\"infra-obs\"}\n```", "guide": "Documentation"}