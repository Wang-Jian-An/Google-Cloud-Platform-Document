{"title": "Apigee - Restoring in a single region", "url": "https://cloud.google.com/apigee/docs/api-platform/get-started/what-apigee", "abstract": "# Apigee - Restoring in a single region\nYou are currently viewing version 1.7 of the Apigee hybrid documentation. **This version is end of life.** You should upgrade to a newer version. For more information, see [Supported versions](/apigee/docs/hybrid/supported-platforms#supported-versions) .\nThis page describes how to restore Cassandra in a single region.\nIn a single region deployment, Apigee hybrid is deployed in a single data center or a region. If you have multiple Apigee organizations in your deployment, the restore process restores data for all the organizations. In a multi-organization setup, you cannot restore a specific organization.\n**Note** : Before you begin restoring a single region, consider whether the following prerequisite steps are applicable:- If you want to preserve an existing setup for troubleshooting and root cause analysis (RCA), you should  delete all the`org`and`env`components from the Kubernetes clusterthe Apigee controller, and then retain the cluster. The cluster will contain the existing Apigee datastore (Cassandra)  which you can use for troubleshooting. Create a new Kubernetes cluster and then restore Cassandra in the new cluster.\n- If your hybrid installation was set up with multiple organizations, get the overrides files for each organization before proceeding with  restore in a single region. You can add the restore configuration as described in [Step 3](#step3) to any **one** of the overrides files.  Do not add the restore configuration to any other overrides file.", "content": "## Restoring a region from a backup\nIn your configuration, the Cassandra backup can reside either on Cloud Storage or on a remote server. In either case, perform the following steps to restore:\n- Verify the hybrid version.```\napigeectl version\n```Ensure the version is the same version that created the backup files in storage. **Tip:** Run every`apigeectl`command with   the`--dry-run=true`flag first to check for any apigeectl errors.\n- Confirm that the Kubernetes cluster you are restoring to does not have a prior Apigee hybrid installation. If  you are restoring to the existing cluster, use the following commands to delete the existing Apigee  hybrid installation:```\napigeectl delete -f overrides.yaml\nkubectl -n apigee get apigeedatastore,apigeeredis,apigeetelemetry,org,env,arc # The output should be empty.\napigeectl delete --all -f overrides.yaml\n```\n- Open your`overrides.yaml`file and set the`restore`properties to the desired values:```\nnamespace: YOUR_RESTORE_NAMESPACE # Use the namespace as in your original cluster.cassandra:\u00a0 hostNetwork: false\u00a0 ...\u00a0 restore:\u00a0 \u00a0 enabled: true\u00a0 \u00a0 serviceAccountPath: \"SA_JSON_FILE_PATH\"\u00a0 \u00a0 dbStorageBucket: \"CLOUD_STORAGE_BUCKET_PATH\"\u00a0 \u00a0 cloudProvider: \"GCP\" \u00a0# required verbatim \"GCP\" (all caps)\u00a0 \u00a0 snapshotTimestamp: \"TIMESTAMP\"\u00a0 ...\u00a0 backup:\u00a0 \u00a0 enabled: true\u00a0 \u00a0 serviceAccountPath: \"SA_JSON_FILE_PATH\"\u00a0 \u00a0 dbStorageBucket: \"CLOUD_STORAGE_BUCKET_PATH\"\u00a0 \u00a0 cloudProvider: \"GCP\" \u00a0# required verbatim \"GCP\" (all caps)\u00a0 \u00a0 schedule: \"SCHEDULE\"\n``````\nnamespace: apigeecassandra:\u00a0 hostNetwork: false\u00a0 ...\u00a0 restore:\u00a0 \u00a0 enabled: true\u00a0 \u00a0 serviceAccountPath: \"/Users/myhome/.ssh/my_cassandra_backup.json\"\u00a0 \u00a0 dbStorageBucket: \"gs://myname-cassandra-backup\"\u00a0 \u00a0 cloudProvider: \"GCP\"\u00a0 \u00a0 snapshotTimestamp: \"20201001183903\"\u00a0 ...\u00a0 backup:\u00a0 \u00a0 enabled: true\u00a0 \u00a0 serviceAccountPath: \"/Users/myhome/.ssh/my_cassandra_backup.json\"\u00a0 \u00a0 dbStorageBucket: \"gs://myname-cassandra-backup\"\u00a0 \u00a0 cloudProvider: \"GCP\"\u00a0 \u00a0 schedule: \"0 2 * * *\"\u00a0 ...\n```\nWhere:\n| Property     | Description                                                                                                        |\n|:---------------------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| namespace     | YOUR_RESTORE_NAMESPACE Namespace for restore. Use the namespace as in your original cluster.                                                                                    |\n| cassandra:hostNetwork  | hostNetwork is required and should always be set to false.                                                                                            |\n| restore:enabled   | Restore is disabled by default. You must set this property to true.                                                                                          |\n| restore:serviceAccountPath | SA_JSON_FILE_PATH The path on your filesystem to the service account you created for the backup.                                                                                   |\n| restore:dbStorageBucket | CLOUD_STORAGE_BUCKET_PATH The Cloud Storage bucket path where your backup data is stored in the following format: gs://BUCKET_NAME. The gs:// is required.                                                                    |\n| restore:cloudProvider  | GCP The cloudProvider: \"GCP\" property is required.                                                                                              |\n| nan      | nan                                                                                                          |\n| restore:snapshotTimestamp | TIMESTAMP The timestamp of the backup snapshot to restore. To check what timestamps can be used, go to the dbStorageBucket and look at the files that are present in the bucket. Each file name contains a timestamp value. For example, backup_20210203213003_apigee-cassandra-default-0.tgz Where 20210203213003 is the snapshotTimestamp value you would use if you wanted to restore the backups created at that point in time. |\n| backup:enabled    | Backup is disabled by default. You must set this property to true.                                                                                          |\n| backup:serviceAccountPath | SA_JSON_FILE_PATH The path on your filesystem to the service account JSON file that was downloaded when you ran ./tools/create-service-account                                                                       |\n| backup:dbStorageBucket  | CLOUD_STORAGE_BUCKET_PATH The Cloud Storage bucket path in this format: gs://BUCKET_NAME. The gs:// is required.                                                                              |\n| backup:cloudProvider  | GCP The cloudProvider: \"GCP\" property is required.                                                                                              |\n| backup:schedule   | SCHEDULE The time when the backup starts, specified in standard crontab syntax. Default: 0 2 * * * Note: Avoid scheduling a backup that starts a short time after you apply the backup configuration to your cluster. When you apply the backup configuration, Kubernetes recreates the Cassandra nodes. If the backup starts before the nodes restart (possibly several minutes) the backup will fail.        |\n```\nnamespace: YOUR_RESTORE_NAMESPACE # Use the namespace as in your original cluster.cassandra:\u00a0 hostNetwork: false\u00a0 ...\u00a0 restore:\u00a0 \u00a0 enabled: true\u00a0 \u00a0 keyFile: \"PATH_TO_PRIVATE_KEY_FILE\"\u00a0 \u00a0 server: \"BACKUP_SERVER_IP\"\u00a0 \u00a0 storageDirectory: \"/home/apigee/BACKUP_DIRECTORY\"\u00a0 \u00a0 cloudProvider: \"HYBRID\" \u00a0# required verbatim \"HYBRID\" (all caps)\u00a0 \u00a0 snapshotTimestamp: \"TIMESTAMP\"\u00a0 ...\u00a0 backup:\u00a0 \u00a0 enabled: true\u00a0 \u00a0 keyFile: \"PATH_TO_PRIVATE_KEY_FILE\"\u00a0 \u00a0 server: \"BACKUP_SERVER_IP\"\u00a0 \u00a0 storageDirectory: \"/home/apigee/BACKUP_DIRECTORY\"\u00a0 \u00a0 cloudProvider: \"HYBRID\" # required verbatim \"HYBRID\" (all caps)\u00a0 \u00a0 schedule: \"SCHEDULE\"\n``````\nnamespace: apigeecassandra:\u00a0 hostNetwork: false\u00a0 ...\u00a0 restore:\u00a0 \u00a0 enabled: true\u00a0 \u00a0 keyFile: \"/Users/exampleuser/apigee-hybrid/hybrid-files/service-accounts/private.key\"\u00a0 \u00a0 server: \"34.56.78.90\"\u00a0 \u00a0 storageDirectory: \"/home/apigee/cassbackup\"\u00a0 \u00a0 cloudProvider: \"HYBRID\"\u00a0 \u00a0 snapshotTimestamp: \"20201001183903\"\u00a0 ...\u00a0 backup:\u00a0 \u00a0 enabled: true\u00a0 \u00a0 keyFile: \"/Users/exampleuser/apigee-hybrid/hybrid-files/service-accounts/private.key\"\u00a0 \u00a0 server: \"34.56.78.90\"\u00a0 \u00a0 storageDirectory: \"/home/apigee/cassbackup\"\u00a0 \u00a0 cloudProvider: \"HYBRID\"\u00a0 \u00a0 schedule: \"0 2 * * *\"\u00a0 ...\n```\nWhere:\n| Property     | Description                                                                                                        |\n|:--------------------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|\n| namespace     | YOUR_RESTORE_NAMESPACE Namespace for restore. Use the namespace as in your original cluster.                                                                                    |\n| cassandra:hostNetwork  | hostNetwork is required and should always be set to false.                                                                                            |\n| restore:enabled   | Restore is disabled by default. You must set this property to true.                                                                                          |\n| restore:keyFile   | PATH_TO_PRIVATE_KEY_FILE The path on your local file system to the SSH private key file (named ssh_key in the step where you created the SSH key pair).                                                                     |\n| restore:server   | BACKUP_SERVER_IP The IP address of your backup server.                                                                                             |\n| restore:storageDirectory | BACKUP_DIRECTORY The name of the backup directory on your backup server. This must be a directory within home/apigee (the backup directory is named cassandra_backup in the step where you created the backup directory).                                                    |\n| restore:cloudProvider  | HYBRID The cloudProvider: \"HYBRID\" property is required.                                                                                             |\n| nan      | nan                                                                                                          |\n| restore:snapshotTimestamp | TIMESTAMP The timestamp of the backup snapshot to restore. To check what timestamps can be used, go to the dbStorageBucket and look at the files that are present in the bucket. Each file name contains a timestamp value. For example, backup_20210203213003_apigee-cassandra-default-0.tgz Where 20210203213003 is the snapshotTimestamp value you would use if you wanted to restore the backups created at that point in time. |\n| backup:enabled   | Backup is disabled by default. You must set this property to true.                                                                                          |\n| backup:keyFile   | PATH_TO_PRIVATE_KEY_FILE The path on your local file system to the SSH private key file (named ssh_key in the step where you created the SSH key pair).                                                                     |\n| backup:server    | BACKUP_SERVER_IP The IP address of your backup server.                                                                                             |\n| backup:storageDirectory | BACKUP_DIRECTORY The name of the backup directory on your backup server. This must be a directory within home/apigee (the backup directory is named cassandra_backup in the step where you created the backup directory).                                                    |\n| backup:cloudProvider  | HYBRID The cloudProvider: \"HYBRID\" property is required.                                                                                             |\n| backup:schedule   | SCHEDULE The time when the backup starts, specified in standard crontab syntax. Default: 0 2 * * * Note: Avoid scheduling a backup that starts a short time after you apply the backup configuration to your cluster. When you apply the backup configuration, Kubernetes recreates the Cassandra nodes. If the backup starts before the nodes restart (possibly several minutes) the backup will fail.        |\n **Note:** Apigee restores Cassandra from a Cloud Storage backup or a remote  server backup based on the`backup`configuration in the`overrides.yaml`file.\n- Create a new hybrid runtime deployment. This will create a new Cassandra cluster and begin  restoring the backup data into the cluster:```\n${APIGEECTL_HOME}/apigeectl init -f overrides/overrides.yaml\n``````\n${APIGEECTL_HOME}/apigeectl check-ready -f overrides/overrides.yaml\n``````\n${APIGEECTL_HOME}/apigeectl apply -f overrides/overrides.yaml --restore\n``````\n${APIGEECTL_HOME}/apigeectl check-ready -f overrides/overrides.yaml\n```\n- Verify the restoration job progress and confirm that`apigeeds`and all the other pods are up:- To check`apigeeds`:```\nkubectl get apigeeds -n apigee\n```\n- To check all other pods:```\nkubectl get pods -n apigee\n```Upon successful completion of the restore and confirmation that the runtime components are healthy,  we recommend configuring a backup on the cluster:\n- Remove the`restore`configuration from the`overrides-restore.yaml`file.\n- Add the`backup`configuration to the`overrides-restore.yaml`file.\n- Apply the`backup`configuration with the following command:```\n./apigeectl apply -f ../overrides-restore.yaml\n```", "guide": "Apigee"}