{"title": "Compute Engine - Troubleshooting Ubuntu Pro Registration", "url": "https://cloud.google.com/compute/docs/instances", "abstract": "# Compute Engine - Troubleshooting Ubuntu Pro Registration\nOccasionally, Compute Engine fails to register PAYG Ubuntu Pro licenses automatically. This document describes how to resolve issues you might encounter with registering Compute Engine virtual machine (VM) instances running pay-as-you-go (PAYG) Ubuntu Pro licenses.\n", "content": "## Check registration status\nTo check if your license is registered, connect to the VM and run the following command\n```\nsudo ua status\n```\nIf the registration succeeded, you see output similar to the following and no further action is required:\n```\nSERVICE   ENTITLED STATUS DESCRIPTION\ncc-eal   yes  disabled Common Criteria EAL2 Provisioning Packages\ncis    yes  disabled Security compliance and audit tools\nesm-apps   yes  enabled Expanded Security Maintenance for Applications\nesm-infra  yes  enabled Expanded Security Maintenance for Infrastructure\nfips    yes  disabled NIST-certified core packages\nfips-updates  yes  disabled NIST-certified core packages with priority security updates\nlivepatch  yes  enabled Canonical Livepatch service\n```\nIf the registration failed and Ubuntu Pro isn't registered, you see a message similar to the following:\n```\nThis machine is not attached to an Ubuntu Pro subscription.\n```\n## Manually register license\nIf Compute Engine failed to automatically register you Ubuntu pro license, you can manually register the license by running the following command:\n```\nsudo pro auto-attach\n```\nThe output is similar to the following:\n- **Registration success** :```\nThis machine is already attached to PROJECT_ID\nTo use a different subscription first run: sudo pro detach.\n```\n- **Registration failure** :```\nInternal Server Error\n```## Troubleshoot license registration\nIf you were unable to manually register a Ubuntu Pro license, resolve the issue by doing the following:\n- Verify that the VM can reach the metadata server by running the following command to check the number of disks attached to the VM:```\ncurl \"http://metadata.google.internal/computeMetadata/v1/instance/disks/\" -H \"Metadata-Flavor: Google\"\n```The output is similar to the following, which shows the number of disks attached to the VM:```\n0/\n1/\n2/\n```If the output doesn't show the number of disks attached to the VM, see [Troubleshooting metadata server access issues](/compute/docs/troubleshooting/troubleshoot-metadata-server) .\n- Verify the Google guest agent is running by running the following command:```\nsystemctl status google-guest-agent.service\n```The output is similar to the following:```\n\u25cf google-guest-agent.service - Google Compute Engine Guest Agent\nLoaded: loaded (/lib/systemd/system/google-guest-agent.service; enabled;\nvendor preset: enabled)\nActive: active (running) since Thu 2023-04-20 16:35:11 PDT; 2h 12min ago\nMain PID: 4582 (google_guest_ag)\nTasks: 10 (limit: 9525)\n```If the guest agent is not installed or failed, [install or reinstall thethe guest environment](/compute/docs/images/install-guest-environment) .\n- Verify that a Service account is attached to the VM, by running the following command from your local workstation:```\ngcloud compute instances describe VM_NAME \\\n --zone ZONE --format=\"table(serviceAccounts.email)\"\n```Replace the following:- ``: the name of the VM\n- ``: the zone where the VM is located\nThe output is similar to the following:```\nEMAIL: ['XXXXXXXX-compute@developer.gserviceaccount.com']\n```Note the email of the service account.\n- Check if the service account is enabled by running the following query:```\ngcloud logging read --freshness=90d \"SERVICE_ACCOUNT_EMAIL protoPayload.methodName=google.iam.admin.v1.DisableServiceAccount\"\n```Replace `` with the email address associated with the VM's service account.The output is similar to the following:```\ninsertId: 1ne5thkf13sxec\nlogName: projects/testproject/logs/cloudaudit.googleapis.com%2Factivity\nprotoPayload:\n '@type': type.googleapis.com/google.cloud.audit.AuditLog\nauthenticationInfo:\nprincipalEmail: principalemail@google.com\nprincipalSubject: user:pricipalemail@google.com\nauthorizationInfo:\n granted: true\npermission: iam.serviceAccounts.disable\nresource: projects/-/serviceAccounts/XXXXXXXXXXXXXX\nresourceAttributes:\n name: projects/-/serviceAccounts/XXXXXXXXXXXXXXXX\nmethodName: google.iam.admin.v1.DisableServiceAccount\nrequest:\n'@type': type.googleapis.com/google.iam.admin.v1.DisableServiceAccountRequest\nname: projects/testproject/serviceAccounts/-compute@developer.gserviceaccount.com\nrequestMetadata:\n destinationAttributes: {}\n requestAttributes:\n auth: {}\n time: '2024-01-25T21:37:55.748811275Z'\nresourceName: projects/-/serviceAccounts/XXXXXXXXXX\nresponse:\n '@type': type.googleapis.com/google.protobuf.Empty\n serviceName: iam.googleapis.com\n status: {}\nreceiveTimestamp: '2024-01-25T21:37:56.409675900Z'\nresource:\nlabels:\n email_id: -compute@developer.gserviceaccount.com\n project_id: testproject\n unique_id: 'XXXXXXXXXXXXXXXX'\ntype: service_account\nseverity: NOTICE\ntimestamp: '2024-01-25T21:37:55.721215307Z'\n```If the service account isn't enabled, [re-enable it](/iam/docs/service-accounts-disable-enable#enabling) .\nAfter you have re-enabled the service account, try to register the license by following the instructions in the [manually register license](#manual_registration) section of this document.", "guide": "Compute Engine"}